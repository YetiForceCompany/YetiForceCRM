
function DataAccessConditions(){this.getNextStep=function(){jQuery("#next_step").on("click",function(b){var a=jQuery('[name="summary"]').val();if(""==a){b.preventDefault();var c={title:app.vtranslate("JS_ERROR"),text:app.vtranslate("DES_REQUIRED"),animation:"show"};Vtiger_Helper_Js.showPnotify(c)}else{if(jQuery('[name="base_module"]').val()=="All"){jQuery('[name="view"]').val("Step3")}else{jQuery('[name="view"]').val("Step2")}}})};this.addCondiion=function(){var a=this;jQuery("button.add_condition").on("click",function(){var c=jQuery(this).data("type"),b=jQuery('[name="base_module"]').val(),e=jQuery("#condition_all select:last").data("num"),d={};d.data={module:"DataAccess",parent:"Settings",view:"Condition",base_module:b,num:e};AppConnector.request(d).then(function(f){jQuery("#"+c).append(f);a.fieldHasChanged();a.comparatorHasChanged();a.fieldTypeHasChanged();app.changeSelectElementView(jQuery("#"+c))})})};this.submitEventRegister=function(){var a=this;jQuery('form[name="condition"]').on("submit",function(){jQuery('input[name="condition_all_json"]').val(a.toJson("condition_all"));jQuery('input[name="condition_option_json"]').val(a.toJson("condition_option"));var b=a.validateCondition("condition_all"),c=a.validateCondition("condition_option");return b&&c})};this.validateCondition=function(d){var e=true,a=[];var b=jQuery("input.dateField").data("calendar-type");jQuery("#"+d+" .conditionRow").each(function(){var q=jQuery(this);var h=jQuery(q).find(".comparator-select option:selected").data("info");var m=h.type;if(m=="email"){var i=new Vtiger_Email_Validator_Js();i.setElement(jQuery(q).find('[name="val"]'));var j=i.validate();if(j!=true){e=false;a.push(h.label+" - "+i.getError())}}else{if(m=="integer"){var p=new Vtiger_Integer_Validator_Js();n.setElement(jQuery(q).find('[name="val"]'));var j=n.validate();if(j!=true){e=false;a.push(h.label+" - "+n.getError())}}else{if(m=="double"){var n=new Vtiger_Double_Validator_Js();n.setElement(jQuery(q).find('[name="val"]'));var j=n.validate();if(j!=true){e=false;a.push(h.label+" - "+n.getError())}}else{if(m=="percentage"){var l=new Vtiger_Percentage_Validator_Js();l.setElement(jQuery(q).find('[name="val"]'));var j=l.validate();if(j!=true){e=false;a.push(h.label+" - "+l.getError())}}else{if(m=="currency"){var k=new Vtiger_Currency_Validator_Js();k.setElement(jQuery(q).find('[name="val"]'));var j=k.validate();if(j!=true){e=false;a.push(h.label+" - "+k.getError())}}else{if(m=="date"&&(!b||b=="undefined")){var o=new Vtiger_Date_Validator_Js();o.setElement(jQuery(q).find('[name="val"]'));var j=o.validate();if(j!=true){e=false;a.push(h.label+" - "+o.getError())}}else{if(m=="date"&&b!="undefined"){if(jQuery("input.dateField").val()==""){e=false;a.push(h.label+" - "+app.vtranslate("JS_PLEASE_ENTER_VALID_DATE"))}}}}}}}}});if(!e){var g="";for(var c=0;c<a.length;c++){g+=a[c]+"<br /><br />"}var f={title:app.vtranslate("JS_ERROR"),text:g,animation:"show"};Vtiger_Helper_Js.showPnotify(f)}return e};this.toJson=function(a){var d=jQuery("#"+a+" .conditionRow"),c=[],b=this;jQuery("#"+a+" .conditionRow").each(function(){var f={};f.field=jQuery(this).find("select.comparator-select").val();f.name=jQuery(this).find('select[name="comparator"]').val();var e=jQuery(this).find("select.comparator-select option:selected").data("info")["type"];if(e=="time"){if(jQuery(this).find("select.comparator-select option:selected").data("info")["time-format"]=="12"){f.val=b.convertTimeFormat(jQuery(this).find('[name="val"]').val())}else{f.val=jQuery(this).find('[name="val"]').val()}f.type=e}else{f.val=jQuery(this).find('[name="val"]').val();f.type=e}c.push(f)});return JSON.stringify(c)};this.filterTpl=function(){jQuery("#moduleFilter").on("change",function(){var b=jQuery(this).val(),a={};a.data={module:"DataAccess",parent:"Settings",view:"ListDoc",base_module:b};AppConnector.request(a).then(function(c){jQuery("#list_doc").html(c)})})};this.docNamRequire=function(){jQuery("button:submit").on("click",function(){var a=jQuery('input[name="doc_name"]');if(jQuery(a).length&&jQuery(a).val()==""){var b={title:app.vtranslate("JS_ERROR"),text:app.vtranslate("DES_NAME_REQUIRED"),animation:"show"};Vtiger_Helper_Js.showPnotify(b);return false}})};this.fieldHasChanged=function(){jQuery(".comparator-select").on("change",function(){var a=jQuery(this).parents(".conditionRow").find('[name="comparator"]'),d=jQuery(this).find("option:selected").data("info"),c=JSON.parse(jQuery("div#condition_list").text());var b=a.val();a.find("option").remove();jQuery.each(c[d.type],function(e,f){a.append(jQuery("<option>",{value:f,text:app.vtranslate(f)}))});a.val(b);a.trigger("chosen:updated")})};this.fieldTypeHasChanged=function(){var a=this;jQuery(".comparator-select").on("change",function(){var b=jQuery(this).parents(".conditionRow").find('[name="val"]'),c=jQuery(this).find("option:selected").data("info");if(c.type=="picklist"||"tree"==c.type){a.showPicklist(this)}else{if(c.type=="boolean"){a.hideValElement(this)}else{if(c.type=="date"){a.showDataInput(this)}else{if(c.type=="multipicklist"){a.showMultiPicklist(this)}else{if(c.type=="time"){a.showTime(this,c)}else{a.showInput(this)}}}}}})};this.comparatorHasChanged=function(){var a=this;jQuery('[name="comparator"]').on("change",function(){var f=jQuery(this).val(),b=["is not empty","is empty","is enabled","is disabled","is today","has changed"],e=["is","contains","does not contain","starts with","ends with","less than days ago","more than days ago","in less than","in more than","days ago","days later","before","after","is not"];if(jQuery.inArray(f,b)!==-1){a.hideValElement(this)}if("between"==f){a.showBetweenDateInput(this)}if(jQuery.inArray(f,e)!==-1){var d=jQuery(this).parents(".conditionRow").find(".comparator-select option:selected").data("info"),c=["less than days ago","more than days ago","in less than","in more than","days ago","days later"];if(d.type=="date"&&(jQuery.inArray(f,c)===-1)){a.showDataInput(this)}else{jQuery(this).closest("div").find(".comparator-select").trigger("change")}}})};this.showBetweenDateInput=function(c){var e=jQuery(c).parents(".conditionRow").find(".fieldUiHolder"),b='<div class="date"><input class="dateField bw form-control" data-calendar-type="range" name="val" data-date-format="yyyy-mm-dd" type="text" readonly="true" placeholder="Click me" value="" data-value="value"></div>';e.children().remove();e.append(b);var a=jQuery(e).find("div.date");var d={calendars:3,mode:"range",className:"rangeCalendar",onChange:function(f){a.find(".dateField").val(f.join(","))}};app.registerEventForDatePickerFields(a,false,d)};this.showPicklist=function(d){var e=jQuery(d).parents(".conditionRow").find(".fieldUiHolder");var b=e.find('[name="val"]');e.children().remove();var a=jQuery('<select name="val" data-value="value" class="select2 form-control" ></select>').appendTo(e);var c=jQuery(d).find("option:selected").data("info");jQuery.each(c.picklistvalues,function(f,g){a.append(jQuery("<option>",{value:f,text:g}))});app.showSelect2ElementView(jQuery("select.select2"))};this.showMultiPicklist=function(c){var d=jQuery(c).parents(".conditionRow").find(".fieldUiHolder");d.children().remove();var a=jQuery('<select name="val" multiple="multiple" data-value="value" class="select2 form-control" ></select>').appendTo(d);var b=jQuery(c).find("option:selected").data("info");jQuery.each(b.picklistvalues,function(e,f){a.append(jQuery("<option>",{value:e,text:f}))});app.showSelect2ElementView(jQuery("select.select2"))};this.showInput=function(a){var b=jQuery(a).parents(".conditionRow").find(".fieldUiHolder");if(b.children().prop("tagName")!="INPUT"){b.children().remove();jQuery('<input type="text" name="val" class="form-control" data-value="value" />').appendTo(b)}else{this.showValElement(b.children())}};this.showDataInput=function(c){var d=jQuery(c).parents(".conditionRow").find(".fieldUiHolder");var a=d.find('[name="val"]'),b='<div class="input-group"><input class="col-md-9 dateField form-control" name="val" data-date-format="yyyy-mm-dd"><div class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></div></div>';if(!jQuery(a).hasClass("dateField")||jQuery(a).hasClass("bw")){d.children().remove();d.append(b);app.registerEventForDatePickerFields(jQuery(d).find('input[name="val"]'),true)}};this.showTime=function(b,c){var d=jQuery(b).parents(".conditionRow").find(".fieldUiHolder"),a='<div class="input-group time"><input type="text" data-format="'+c["time-format"]+'" class="timepicker-default form-control ui-timepicker-input" name="val" autocomplete="off"><span class="input-group-addon cursorPointer"><i class="glyphicon glyphicon-time"></i></span></div>';d.children().remove();d.append(a);app.registerEventForClockPicker(jQuery(d).find('[name="val"]'))};this.hideValElement=function(a){jQuery(a).parents(".conditionRow").find(".fieldUiHolder").children().hide()};this.showValElement=function(a){jQuery(a).parents(".conditionRow").find(".fieldUiHolder").children().show()};this.test=function(){jQuery(document).on("click",function(){var b=new Vtiger_Date_Validator_Js();b.setElement(jQuery('[name="val"]'));var a=b.validate()})};this.convertTimeFormat=function(e){var c=Number(e.match(/^(\d+)/)[1]);var f=Number(e.match(/:(\d+)/)[1]);var d=e.match(/\s(.*)$/)[1];if(d=="PM"&&c<12){c=c+12}if(d=="AM"&&c==12){c=c-12}var a=c.toString();var b=f.toString();if(c<10){a="0"+a}if(f<10){b="0"+b}return a+":"+b};this.hideShowInput=function(){var a=this;jQuery('[name="comparator"]').each(function(){var f=jQuery(this).val(),b=["is not empty","is empty","is enabled","is disabled","is today"],e=["is","contains","does not contain","starts with","ends with","less than days ago","more than days ago","in less than","in more than","days ago","days later","before","after","is not"];if(jQuery.inArray(f,b)!==-1){a.hideValElement(this)}if(jQuery.inArray(f,e)!==-1){var d=jQuery(this).parents(".conditionRow").find(".comparator-select option:selected").data("info"),c=["less than days ago","more than days ago","in less than","in more than","days ago","days later"];if(d.type=="date"&&(jQuery.inArray(f,c)===-1)){a.showDataInput(this)}else{if(d.type=="date"){a.showInput(this)}}}})};this.registerEvents=function(){this.hideShowInput();this.getNextStep();this.addCondiion();this.submitEventRegister();this.filterTpl();this.docNamRequire();this.fieldHasChanged();this.comparatorHasChanged();this.fieldTypeHasChanged();app.registerEventForDatePickerFields(jQuery("input.dateFieldNormal"),true);var a={calendars:3,mode:"range",className:"rangeCalendar",onChange:function(b){jQuery("input.bw").val(b.join(","))}};app.registerEventForDatePickerFields(jQuery("input.bw"),false,a);app.registerEventForClockPicker()}}jQuery(document).ready(function(){var a=new DataAccessConditions();a.registerEvents()});