
jQuery.Class("Calendar_CalendarView_Js",{currentInstance:false,getInstanceByView:function(){var b=jQuery("#currentView").val();var d=b+"View";var c=b+"_"+d+"_Js";var a;if(typeof window[c]!="undefined"){a=new window[c]()}else{a=new Calendar_CalendarView_Js()}return a},registerSwitches:function(){var b=jQuery("#rightPanel .quickWidget");var a=b.find(".widgetContainer input.switchBtn");app.showBtnSwitch(a);b.find(".widgetContainer").each(function(){var c=jQuery(this).height();if(c>250){jQuery(this).find("div:first").slimScroll({height:"250px"})}})},registerWidget:function(){var b=this.getInstanceByView();var a=jQuery("#rightPanel .quickWidget");a.find(".switchsParent").on("switchChange.bootstrapSwitch",function(d,e){var c=jQuery(this).closest(".quickWidget");if(e){c.find(".widgetContainer input.switchBtn").bootstrapSwitch("state",true)}else{c.find(".widgetContainer input.switchBtn").bootstrapSwitch("state",false)}})},registerColorField:function(b,a){var c={};c.dropdownCss={"z-index":0};c.formatSelection=function(f,d){var e=f.id;var h=b.find('option[value="'+e+'"]');d.addClass(a+"_"+e);var g="<div>"+h.text()+"</div>";return g};app.changeSelectElementView(b,"select2",c)}},{calendarView:false,calendarCreateView:false,weekDaysArray:{Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6},renderCalendar:function(){var k=this;var l=app.getMainParams("eventLimit");if(l=="true"){l=true}else{if(l=="false"){l=false}else{l=parseInt(l)+1}}var b=app.getMainParams("weekView");var g=app.getMainParams("dayView");var a=app.getMainParams("activity_view");if(a=="Today"){a=g}else{if(a=="This Week"){a=b}else{a="month"}}var h=app.moduleCacheGet("defaultView");if(h!=null){a=h}var f=app.getMainParams("time_format");if(f==24){f="H:mm"}else{f="h:mmt"}var c=app.getMainParams("start_day");var j=k.weekDaysArray[c];var d=app.getMainParams("start_hour")+":00";var o=[];if(app.getMainParams("switchingDays")=="workDays"){o=app.getMainParams("hiddenDays",true)}var n={header:{left:"month,"+b+","+g,center:"title today",right:"prev,next"},timeFormat:f,axisFormat:f,scrollTime:d,firstDay:j,defaultView:a,editable:true,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:true,defaultTimedEventDuration:"01:00:00",eventLimit:l,selectable:true,selectHelper:true,hiddenDays:o,views:{basic:{eventLimit:false,}},select:function(p,e){k.selectDays(p,e);k.getCalendarView().fullCalendar("unselect")},eventDrop:function(p,q,e){k.updateEvent(p,q,e)},eventResize:function(p,q,e){k.updateEvent(p,q,e)},eventRender:function(p,e){e.find(".fc-content").popover({trigger:"hover",delay:500,title:p.title,container:"body",html:true,placement:"auto right",template:'<div class="popover calendarPopover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',content:'<div><span class="glyphicon glyphicon-time" aria-hidden="true"></span> <label>'+app.vtranslate("JS_START_DATE")+"</label>: "+p.start_display+'</div><div><span class="glyphicon glyphicon-time" aria-hidden="true"></span> <label>'+app.vtranslate("JS_END_DATE")+"</label>: "+p.end_display+"</div>"+(p.lok?'<div><span class="glyphicon glyphicon-globe" aria-hidden="true"></span> <label>'+app.vtranslate("JS_LOCATION")+"</label>: "+p.lok+"</div>":"")+(p.pri?'<div><span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span> <label>'+app.vtranslate("JS_PRIORITY")+"</label>: "+app.vtranslate("JS_"+p.pri)+"</div>":"")+'<div><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span> <label>'+app.vtranslate("JS_STATUS")+"</label>: "+app.vtranslate("JS_"+p.sta)+"</div>"+(p.accname?'<div><span class="calIcon modIcon_Accounts" aria-hidden="true"></span> <label>'+app.vtranslate("JS_ACCOUNTS")+"</label>: "+p.accname+"</div>":"")+(p.linkl?'<div><span class="userIcon-'+p.linkm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_RELATION")+"</label>: "+p.linkl+"</div>":"")+(p.procl?'<div><span class="userIcon-'+p.procm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_PROCESS")+"</label>: "+p.procl+"</div>":"")+(p.subprocl?'<div><span class="userIcon-'+p.subprocm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_SUB_PROCESS")+"</label>: "+p.subprocl+"</div>":"")+(p.state?'<div><span class="glyphicon glyphicon-star-empty" aria-hidden="true"></span> <label>'+app.vtranslate("JS_STATE")+"</label>: "+app.vtranslate(p.state)+"</div>":"")+'<div><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> <label>'+app.vtranslate("JS_VISIBILITY")+"</label>: "+app.vtranslate("JS_"+p.vis)+"</div>"+(p.smownerid?'<div><span class="glyphicon glyphicon-user" aria-hidden="true"></span> <label>'+app.vtranslate("JS_ASSIGNED_TO")+"</label>: "+p.smownerid+"</div>":"")});e.find(".fc-content, .fc-info").click(function(){var t=jQuery.progressIndicator({blockInfo:{enabled:true}});var s=$(this).closest(".fc-event");var r="index.php?module=Calendar&view=ActivityStateModal&record="+s.data("id");var q=function(v){t.progressIndicator({mode:"hide"})};var u={url:r,cb:q};app.showModalWindow(u)})},monthNames:[app.vtranslate("JS_JANUARY"),app.vtranslate("JS_FEBRUARY"),app.vtranslate("JS_MARCH"),app.vtranslate("JS_APRIL"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUNE"),app.vtranslate("JS_JULY"),app.vtranslate("JS_AUGUST"),app.vtranslate("JS_SEPTEMBER"),app.vtranslate("JS_OCTOBER"),app.vtranslate("JS_NOVEMBER"),app.vtranslate("JS_DECEMBER")],monthNamesShort:[app.vtranslate("JS_JAN"),app.vtranslate("JS_FEB"),app.vtranslate("JS_MAR"),app.vtranslate("JS_APR"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUN"),app.vtranslate("JS_JUL"),app.vtranslate("JS_AUG"),app.vtranslate("JS_SEP"),app.vtranslate("JS_OCT"),app.vtranslate("JS_NOV"),app.vtranslate("JS_DEC")],dayNames:[app.vtranslate("JS_SUNDAY"),app.vtranslate("JS_MONDAY"),app.vtranslate("JS_TUESDAY"),app.vtranslate("JS_WEDNESDAY"),app.vtranslate("JS_THURSDAY"),app.vtranslate("JS_FRIDAY"),app.vtranslate("JS_SATURDAY")],dayNamesShort:[app.vtranslate("JS_SUN"),app.vtranslate("JS_MON"),app.vtranslate("JS_TUE"),app.vtranslate("JS_WED"),app.vtranslate("JS_THU"),app.vtranslate("JS_FRI"),app.vtranslate("JS_SAT")],buttonText:{today:app.vtranslate("JS_TODAY"),month:app.vtranslate("JS_MONTH"),week:app.vtranslate("JS_WEEK"),day:app.vtranslate("JS_DAY")},allDayText:app.vtranslate("JS_ALL_DAY"),eventLimitText:app.vtranslate("JS_MORE")};if(app.moduleCacheGet("start")!=null){var m=moment(app.moduleCacheGet("start")).valueOf();var i=moment(app.moduleCacheGet("end")).valueOf();n.defaultDate=moment(moment(m+((i-m)/2)).format("YYYY-MM-DD"))}k.getCalendarView().fullCalendar("destroy");k.getCalendarView().fullCalendar(n);k.createAddSwitch();k.registerCalendarScroll()},registerCalendarScroll:function(){var a=$(".bodyContents");app.showScrollBar(a,{railVisible:true,alwaysVisible:true,position:"left"})},getValuesFromSelect2:function(c,d,e){if(c.hasClass("select2-hidden-accessible")){var b=(c.select2("data"));for(var a=0;a<b.length;a++){if(e){d.push(b[a].text)}else{d.push(b[a].id)}}}return d},registerButtonSelectAll:function(){var a=$(".selectAllBtn");a.click(function(d){var c=$(this).find(".selectAll");var b=$(this).find(".deselectAll");if(c.hasClass("hide")){c.removeClass("hide");b.addClass("hide");$(this).closest(".quickWidget").find("select option").prop("selected",false)}else{$(this).closest(".quickWidget").find("select option").prop("selected",true);b.removeClass("hide");c.addClass("hide")}$(this).closest(".quickWidget").find("select").trigger("change")})},loadCalendarData:function(d){var a=jQuery.progressIndicator({blockInfo:{enabled:true}});var j=this;j.getCalendarView().fullCalendar("removeEvents");var i=j.getCalendarView().fullCalendar("getView");var g=i.start.format();var b=i.end.format();var h=[];var k=app.getMainParams("userDateFormat");h=j.getValuesFromSelect2($("#calendarActivityTypeList"),h);if(h.length==0){d=true}var f=[];f=j.getValuesFromSelect2($("#calendarUserList"),f);if(f.length==0){f=[app.getMainParams("current_user_id")]}f=j.getValuesFromSelect2($("#calendarGroupList"),f);var c=[];$(".calendarFilters .filterField").each(function(m){var n=$(this);var l,o;if(n.attr("type")=="checkbox"){l=n.val();o=n.prop("checked")?1:0}else{l=n.attr("name");o=n.val()}c.push({name:l,value:o})});if(d==true||h.length>0){var e={module:"Calendar",action:"Calendar",mode:"getEvents",start:app.getDateInVtigerFormat(k,Date.parse(g)),end:app.getDateInVtigerFormat(k,Date.parse(b)),user:f,time:app.getMainParams("showType"),types:h,filters:c};AppConnector.request(e).then(function(l){j.getCalendarView().fullCalendar("addEventSource",l.result);a.progressIndicator({mode:"hide"})})}else{j.getCalendarView().fullCalendar("removeEvents");a.progressIndicator({mode:"hide"})}},updateEvent:function(b,f,a){var c=jQuery.progressIndicator({blockInfo:{enabled:true}});var e=b.start.format();var d={module:"Calendar",action:"Calendar",mode:"updateEvent",id:b.id,start:e,delta:f._data,allDay:b.allDay};AppConnector.request(d).then(function(g){c.progressIndicator({mode:"hide"});if(!g.result){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));a()}},function(g){c.progressIndicator({mode:"hide"});Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));a()})},selectDays:function(a,e){var c=this;var f=$("#start_hour").val();var d=$("#end_hour").val();if(e.hasTime()==false){e.add(-1,"days")}a=a.format();e=e.format();var b=c.getCalendarView().fullCalendar("getView");if(f==""){f="00"}if(d==""){d="00"}this.getCalendarCreateView().then(function(l){if(l.length<=0){return}if(b.name!="agendaDay"&&b.name!="agendaWeek"){if(a==e){var o=0;if(l.find('[name="activitytype"]').val()=="Call"){o=l.find('[name="defaultCallDuration"]').val()}else{o=l.find('[name="defaultOtherEventDuration"]').val()}var r=Date.parse(f);var k=r.addMinutes(o);d=k.toString("HH:mm")}a=a+"T"+f+":00";e=e+"T"+d+":00"}var g=l.find('[name="date_start"]').data("dateFormat");var j=l.find('[name="time_start"]').data("format");if(j==24){var n="HH:mm"}else{n="hh:mm tt"}var q=Date.parse(a);var t=app.getDateInVtigerFormat(g,q);var h=q.toString(n);var i=Date.parse(e);var m=app.getDateInVtigerFormat(g,i);var s=i.toString(n);l.find('[name="date_start"]').val(t);l.find('[name="due_date"]').val(m);l.find('[name="time_start"]').val(h);l.find('[name="time_end"]').val(s);var p=new Vtiger_Header_Js();p.handleQuickCreateData(l,{callbackFunction:function(u){c.addCalendarEvent(u.result)}});jQuery(".modal-body").css({"max-height":app.getScreenHeight(70)+"px","overflow-y":"auto"})})},addCalendarEvent:function(e){var f=$(".fc-toolbar input.switchBtn").bootstrapSwitch("state");var b={};var h=this.getCalendarView();var d=$.inArray(e.activitystatus.value,["PLL_POSTPONED","PLL_CANCELLED","PLL_COMPLETED"]);if(f==true&&d>=0||f!=true&&d==-1){return false}b.id=e._recordId;b.title=e.subject.display_value;var a=h.fullCalendar("moment",e.date_start.display_value+" "+e.time_start.display_value);b.start=a.toString();var g=h.fullCalendar("moment",e.due_date.display_value+" "+e.time_end.display_value);var c=e.assigned_user_id.value;b.end=g.toString();b.url="index.php?module=Calendar&view=Detail&record="+e._recordId;b.activitytype=e.activitytype.value;if("on"==e.allday.value){b.allDay=true}else{b.allDay=false}b.state=e.state.value;b.vis=e.visibility.value;b.sta=e.activitystatus.value;b.className="userCol_"+e.assigned_user_id.value+" calCol_"+e.activitytype.value;this.getCalendarView().fullCalendar("renderEvent",b)},getCalendarCreateView:function(){var b=this;var a=jQuery.Deferred();if(this.calendarCreateView!==false){a.resolve(this.calendarCreateView.clone(true,true));return a.promise()}var c=jQuery.progressIndicator({blockInfo:{enabled:true}});this.loadCalendarCreateView().then(function(d){c.progressIndicator({mode:"hide"});b.calendarCreateView=d;a.resolve(d.clone(true,true))},function(){c.progressIndicator({mode:"hide"})});return a.promise()},loadCalendarCreateView:function(){var a=jQuery.Deferred();var d=app.getModuleName();var c="index.php?module="+d+"&view=QuickCreateAjax";var b=Vtiger_Header_Js.getInstance();b.getQuickCreateForm(c,d).then(function(e){a.resolve(jQuery(e))},function(){a.reject()});return a.promise()},getCalendarView:function(){if(this.calendarView==false){this.calendarView=jQuery("#calendarview")}return this.calendarView},registerChangeView:function(){var a=this;a.getCalendarView().find("button.fc-button").click(function(){a.loadCalendarData()})},goToRecordsList:function(f){var i=this;var e=i.getValuesFromSelect2($("#calendarActivityTypeList"),[]);var b=i.getValuesFromSelect2($("#calendarUserList"),[],false);b=i.getValuesFromSelect2($("#calendarGroupList"),b,false);var g=i.getCalendarView().fullCalendar("getView");var d=g.start.format();var a=g.end.format();var c=app.getMainParams("activityStateLabels",true);var h='["activitystatus","e","'+c[app.getMainParams("showType")].join()+'"]';h+=',["date_start","bw","'+d+","+a+'"]';if(e.length){h+=',["activitytype","e","'+e+'"]'}if(b.length){h+=',["assigned_user_id","e","'+b+'"]'}$(".calendarFilters .filterField").each(function(){var j=$(this).attr("type");if(j=="checkbox"&&$(this).prop("checked")){h+=(h!=""?",[":"[")+$(this).data("search")+"]"}});window.location.href=f+"&search_params=[["+h+"]]"},registerAddButton:function(){var a=this;jQuery(".calendarViewContainer .widget_header .addButton").on("click",function(b){a.getCalendarCreateView().then(function(d){var c=new Vtiger_Header_Js();c.handleQuickCreateData(d,{callbackFunction:function(e){a.addCalendarEvent(e.result)}})})})},createAddSwitch:function(){var c=this;var d=this.getCalendarView();var b="";if(app.getMainParams("showType")=="current"&&app.moduleCacheGet("defaultShowType")!="history"){b=" checked "}var a=jQuery('<span class=""><input class="switchBtn showType" id="defaultShowType" type="checkbox" title="'+app.vtranslate("JS_CHANGE_ACTIVITY_TIME")+'" '+b+' data-size="small" data-handle-width="90" data-label-width="5" data-on-text="'+app.vtranslate("JS_TO_REALIZE")+'" data-off-text="'+app.vtranslate("JS_HISTORY")+'"></span>').prependTo(d.find(".fc-toolbar .fc-right")).on("switchChange.bootstrapSwitch",function(g,f){if(f){app.setMainParams("showType","current");app.moduleCacheSet("defaultShowType","current")}else{app.setMainParams("showType","history");app.moduleCacheSet("defaultShowType","history")}c.loadCalendarData()});app.showBtnSwitch(a.find(".switchBtn"));b="";if(app.getMainParams("switchingDays")=="workDays"&&app.moduleCacheGet("defaultSwitchingDays")!="all"){b=" checked "}if(app.getMainParams("hiddenDays",true)!==false){a=jQuery('<span class=""><input class="switchBtn switchingDays" type="checkbox" id="defaultSwitchingDays" title="'+app.vtranslate("JS_SWITCHING_DAYS")+'" '+b+' data-size="small" data-handle-width="90" data-label-width="5" data-on-text="'+app.vtranslate("JS_WORK_DAYS")+'" data-off-text="'+app.vtranslate("JS_ALL")+'"></span>').prependTo(d.find(".fc-toolbar .fc-right")).on("switchChange.bootstrapSwitch",function(g,f){if(f){app.setMainParams("switchingDays","workDays");app.moduleCacheSet("defaultSwitchingDays","workDays")}else{app.setMainParams("switchingDays","all");app.moduleCacheSet("defaultSwitchingDays","all")}c.renderCalendar();c.loadCalendarData()});app.showBtnSwitch(a.find(".switchBtn"))}},registerSelect2Event:function(){var a=this;$(".siteBarRight .select2").each(function(c){var b=$(this).attr("id");var e=app.moduleCacheGet(b);var d=$("#"+b);if(d.length>0&&e!=null){if(d.prop("tagName")=="SELECT"){d.val(e)}}});$(".siteBarRight .select2, .siteBarRight .filterField").off("change");app.showSelect2ElementView($("#calendarUserList"));app.showSelect2ElementView($("#calendarActivityTypeList"));app.showSelect2ElementView($("#calendarGroupList"));$(".siteBarRight .select2, .siteBarRight .filterField").on("change",function(){var b=$(this);var c=b.val();if(c==null){c=""}a.loadCalendarData();if(b.attr("type")=="checkbox"){c=b.is(":checked")}app.moduleCacheSet(b.attr("id"),c)})},registerCacheSettings:function(){var b=this;var c=b.getCalendarView();if(app.moduleCacheGet("defaultSwitchingDays")=="all"){app.setMainParams("switchingDays","all")}else{app.setMainParams("switchingDays","workDays")}if(app.moduleCacheGet("defaultShowType")=="history"){app.setMainParams("showType","history")}else{app.setMainParams("showType","current")}$(".siteBarRight .filterField").each(function(f){var e=$(this).attr("id");var h=app.moduleCacheGet(e);var g=$("#"+e);if(g.length>0&&h!=null){if(g.attr("type")=="checkbox"){g.prop("checked",h)}}});c.find(".fc-toolbar .fc-button").click(function(j){var i,f,g;var h=$(j.currentTarget);f=c.fullCalendar("getView");g=f.options;if(h.hasClass("fc-"+f.name+"-button")){app.moduleCacheSet("defaultView",f.name)}else{if(h.hasClass("fc-prev-button")||h.hasClass("fc-next-button")||h.hasClass("fc-today-button")){app.moduleCacheSet("start",f.start.format());app.moduleCacheSet("end",f.end.format())}}});var a=app.moduleCacheKeys();if(a.length>0){var d=$("#moduleCacheAlert");$(".bodyContents").on("Vtiger.Widget.Load.undefined",function(g,f){d.removeClass("hide")});d.find(".cacheClear").click(function(f){app.moduleCacheClear();d.addClass("hide");location.reload()})}},registerLoadCalendarData:function(){var b=this;var a=$(".siteBarRight .widgetContainer").length;$(".bodyContents").on("Vtiger.Widget.Load.undefined",function(d,c){a-=1;if(a==0){b.loadCalendarData(true)}})},registerEvents:function(){this.registerCacheSettings();this.renderCalendar();this.registerAddButton();this.registerLoadCalendarData();this.registerButtonSelectAll();this.registerChangeView()}});jQuery(document).ready(function(){var a=Calendar_CalendarView_Js.getInstanceByView();a.registerEvents();Calendar_CalendarView_Js.currentInstance=a;Calendar_CalendarView_Js.registerWidget()});