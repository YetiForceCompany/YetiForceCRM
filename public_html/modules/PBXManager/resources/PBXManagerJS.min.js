'use strict';

var Vtiger_PBXManager_Js={registerPBXCall:function a(){Vtiger_PBXManager_Js.requestPBXgetCalls();},registerPBXOutboundCall:function c(a,b){Vtiger_PBXManager_Js.makeOutboundCall(a,b);},requestPBXgetCalls:function a(){AppConnector.request('index.php?module=PBXManager&action=IncomingCallPoll&mode=searchIncomingCalls').done(function(a){if(a.success&&a.result)for(i=0;i<a.result.length;i++){var b=a.result[i];0==jQuery('#pbxcall_'+b.pbxmanagerid+'').size()?Vtiger_PBXManager_Js.showPBXIncomingCallPopup(b):Vtiger_PBXManager_Js.updatePBXIncomingCallPopup(b);}}),Vtiger_PBXManager_Js.removeCompletedCallPopup();},showPBXIncomingCallPopup:function c(a){var b={title:app.vtranslate('JS_PBX_INCOMING_CALL'),text:'<div class="row pbxcall" id="pbxcall_'+a.pbxmanagerid+'" callid='+a.pbxmanagerid+' style="color:black"><span class="col-md-12" id="caller" value="'+a.customernumber+'">'+app.vtranslate('JS_PBX_CALL_FROM')+' : '+a.customernumber+'</span><span class="d-none col-md-12" id="contactsave_'+a.pbxmanagerid+'">\n                        <span><input class="col-md-3" id="email_'+a.pbxmanagerid+'" type="text" placeholder="Enter Email-id"></input>&nbsp;&nbsp;&nbsp;<select class="input-small" id="module_'+a.pbxmanagerid+'" placeholder="Select"><option>Select</option></select><h5 class="alert-danger d-none col-md-3" id="alert_msg">'+app.vtranslate('JS_PBX_FILL_ALL_FIELDS')+'</h5>\n                        <button class="btn btn-success pull-right"  id="pbxcontactsave_'+a.pbxmanagerid+'" recordid="'+a.pbxmanagerid+'" type="submit">Save</button>\n                        </span></span><br /><span class="col-md-12" style="display:none" id="answeredby"><i class="icon-headphones"></i>&nbsp;<span id="answeredbyname"></span></span></div>',width:'28%',min_height:'75px',addclass:'vtCall',icon:'vtCall-icon',hide:!1,closer:!0,type:'info',after_open:function c(b){jQuery(b).data('info',a);}};Vtiger_Helper_Js.showPnotify(b),a.user&&a.user!=a.current_user_id&&Vtiger_PBXManager_Js.removeCallPopup(a.pbxmanagerid),Vtiger_PBXManager_Js.checkIfRelatedModuleRecordExist(a),null!=a.answeredby&&(jQuery('#answeredbyname','#pbxcall_'+a.pbxmanagerid+'').text(a.answeredby),jQuery('#answeredby','#pbxcall_'+a.pbxmanagerid+'').show()),jQuery('#pbxcontactsave_'+a.pbxmanagerid+'').bind('click',function(b){var c=jQuery(b.currentTarget).attr('recordid');return 'Select'==jQuery('#module_'+c+'').val()?(jQuery('#alert_msg').show(),!1):''==jQuery('#email_'+c+'').val()?(jQuery('#alert_msg').show(),!1):void(Vtiger_PBXManager_Js.createRecord(b,a),jQuery('#pbxcontactsave_'+a.pbxmanagerid+'').unbind('click'))});},createRecord:function h(a,b){var c=jQuery(a.currentTarget).attr('recordid'),d=jQuery('#email_'+c+'').val(),e=jQuery('#module_'+c+'').val(),f=jQuery('#caller','#pbxcall_'+c+'').attr('value'),g='index.php?module=PBXManager&action=IncomingCallPoll&mode=createRecord&number='+encodeURIComponent(f)+'&email='+encodeURIComponent(d)+'&callid='+b.sourceuuid+'&modulename='+e;AppConnector.request(g).done(function(a){a.success&&a.result&&jQuery('#contactsave_'+c+'').hide();});},checkIfRelatedModuleRecordExist:function b(a){switch(a.callername){case null:AppConnector.request('index.php?module=PBXManager&action=IncomingCallPoll&mode=checkModuleViewPermission&view=EditView').done(function(b){var c,d=JSON.parse(b),e=!1,f=d.result.modules,g=jQuery('#module_'+a.pbxmanagerid+'');for(var h in f)f.hasOwnProperty(h)&&f[h]&&(c='<option id="select_'+h+'" value="'+h+'">'+app.vtranslate(h)+'</option>',g.append(c),e=!0);d.success&&e&&jQuery('#contactsave_'+a.pbxmanagerid+'').show();});break;default:jQuery('#caller','#pbxcall_'+a.pbxmanagerid+'').html(app.vtranslate('JS_PBX_CALL_FROM')+' :&nbsp;<a href="index.php?module='+a.customertype+'&view=Detail&record='+a.customer+'">'+a.callername+'</a>');}},updatePBXIncomingCallPopup:function b(a){null!=a.answeredby&&(jQuery('#answeredbyname','#pbxcall_'+a.pbxmanagerid+'').text(a.answeredby),jQuery('#answeredby','#pbxcall_'+a.pbxmanagerid+'').show()),null!=a.customer&&''!=a.customer&&(jQuery('#caller','#pbxcall_'+a.pbxmanagerid+'').html(app.vtranslate('JS_PBX_CALL_FROM')+' :&nbsp;<a href="index.php?module='+a.customertype+'&view=Detail&record='+a.customer+'">'+a.callername+'</a>'),jQuery('#contactsave_'+a.pbxmanagerid+'').hide()),a.user&&a.user!=a.current_user_id&&Vtiger_PBXManager_Js.removeCallPopup(a.pbxmanagerid);},removeCompletedCallPopup:function e(){for(var a=null,b=jQuery('.pbxcall'),c=0;c<b.length;c++){a=b[c].getAttribute('callid');var d='index.php?module=PBXManager&action=IncomingCallPoll&mode=getCallStatus&callid='+encodeURIComponent(a)+'';AppConnector.request(d).done(function(b){b.result&&'in-progress'!=b.result&&'ringing'!=b.result&&Vtiger_PBXManager_Js.removeCallPopup(a);});}},removeCallPopup:function b(a){jQuery('#pbxcall_'+a+'').parent().parent().parent().remove();},getContentHolder:function b(a){return 'List'==a?jQuery('.listViewContentDiv'):jQuery('.detailViewContainer')},makeOutboundCall:function d(a,b){var c={number:a,record:b,module:'PBXManager',action:'OutgoingCall'};AppConnector.request(c).done(function(a){c=a.result?{text:app.vtranslate('JS_PBX_OUTGOING_SUCCESS'),type:'info'}:{text:app.vtranslate('JS_PBX_OUTGOING_FAILURE'),type:'error'},Vtiger_Helper_Js.showPnotify(c);});},registerEvents:function b(){AppConnector.request('index.php?module=PBXManager&action=IncomingCallPoll&mode=checkPermissionForPolling').done(function(a){a.result&&(Vtiger_PBXManager_Js.registerPBXCall(),setInterval('Vtiger_PBXManager_Js.registerPBXCall()',3e3));});}};jQuery(document).ready(function(){Vtiger_PBXManager_Js.registerEvents();});
