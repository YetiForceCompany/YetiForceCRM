'use strict';

jQuery.Class('Reservations_Calendar_Js',{registerUserListWidget:function c(){var a=new Reservations_Calendar_Js,b=$('.widgetContainer');b.hover(function(){$(this).css('overflow','visible');},function(){$(this).css('overflow','hidden');}),this.registerColorField(b.find('#calendarUserList'),'userCol'),this.registerColorField(b.find('#timecontrolTypes'),'listCol'),b.find('.select2').on('change',function(){$(this).closest('.siteBarContent').find('.refreshHeader').removeClass('d-none');});},registerColorField:function d(a,b){var c={};c.dropdownCss={"z-index":0},c.formatSelection=function(c,d){var e=c.id,f=a.find('option[value="'+e+'"]');d.addClass(b+'_'+e);var g='<div>'+f.text()+'</div>';return g},App.Fields.Picklist.changeSelectElementView(a,'select2',c);}},{calendarView:!1,calendarCreateView:!1,registerCalendar:function k(){var a=this,b=jQuery('#eventLimit').val();b=!('true'!=b)||'false'!=b&&parseInt(b)+1;var c=jQuery('#weekView').val(),d=jQuery('#dayView').val(),e=jQuery('#activity_view').val();e='Today'==e?d:'This Week'==e?c:'month';var f,g=jQuery('#time_format').val();24==g?(g='H:mm',f='HH:mm'):(g='h:mmt',f='hh:mm A');var h=CONFIG.firstDayOfWeekNo,i=jQuery('#start_hour').val(),j=i.split(':');i=j[0],a.getCalendarView().fullCalendar({header:{left:'month,'+c+','+d,center:'title today',right:'prev,next'},timeFormat:g,axisFormat:g,firstHour:i,firstDay:h,defaultView:e,editable:!0,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:!0,defaultTimedEventDuration:'01:00:00',eventLimit:b,allDaySlot:!1,height:app.setCalendarHeight(),views:{basic:{eventLimit:!1}},dayClick:function c(b){a.selectDay(b.format()),a.getCalendarView().fullCalendar('unselect');},eventDrop:function e(b,c,d){a.updateEvent(b,c,d);},eventResize:function e(b,c,d){a.updateEvent(b,c,d);},eventRender:function c(a,b){app.showPopoverElementView(b.find('.fc-content'),{title:a.title+'<a href="index.php?module=Reservations&view=Edit&record='+a.id+'" class="float-right"><span class="fas fa-edit"></span></a><a href="index.php?module=Reservations&view=Detail&record='+a.id+'" class="float-right mx-1"><span class="fas fa-th-list"></span></a>',container:'body',html:!0,placement:'auto',template:'<div class="popover calendarPopover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',content:'<div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_START_DATE')+'</label>: '+a.start.format('YYYY-MM-DD '+f)+'</div><div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_END_DATE')+'</label>: '+a.end.format('YYYY-MM-DD '+f)+'</div><div><span class="far fa-clock"></span> <label>'+app.vtranslate('JS_TOTAL_TIME')+'</label>: '+a.totalTime+'</div><div><span class="fas fa-question-circle"></span> <label>'+app.vtranslate('JS_TYPE')+'</label>: '+a.type+'</div>'+(a.status?'<div><span class="far fa-star"></span> <label>'+app.vtranslate('JS_STATUS')+'</label>: '+app.vtranslate(a.status)+'</div>':'')+(a.company?'<div><span class="userIcon-Accounts" aria-hidden="true"></span> <label>'+app.vtranslate('JS_COMPANY')+'</label>: '+a.company+'</div>':'')+(a.process?'<div><span class="userIcon-'+a.processType+'" aria-hidden="true"></span> <label>'+a.processLabel+'</label>: <a target="_blank" href="index.php?module='+a.processType+'&view=Detail&record='+a.processId+'">'+a.process+'</a></div>':'')+(a.smownerid?'<div><span class="fas fa-user"></span> <label>'+app.vtranslate('JS_ASSIGNED_TO')+'</label>: '+a.smownerid+'</div>':'')});},monthNames:[app.vtranslate('JS_JANUARY'),app.vtranslate('JS_FEBRUARY'),app.vtranslate('JS_MARCH'),app.vtranslate('JS_APRIL'),app.vtranslate('JS_MAY'),app.vtranslate('JS_JUNE'),app.vtranslate('JS_JULY'),app.vtranslate('JS_AUGUST'),app.vtranslate('JS_SEPTEMBER'),app.vtranslate('JS_OCTOBER'),app.vtranslate('JS_NOVEMBER'),app.vtranslate('JS_DECEMBER')],monthNamesShort:[app.vtranslate('JS_JAN'),app.vtranslate('JS_FEB'),app.vtranslate('JS_MAR'),app.vtranslate('JS_APR'),app.vtranslate('JS_MAY'),app.vtranslate('JS_JUN'),app.vtranslate('JS_JUL'),app.vtranslate('JS_AUG'),app.vtranslate('JS_SEP'),app.vtranslate('JS_OCT'),app.vtranslate('JS_NOV'),app.vtranslate('JS_DEC')],dayNames:[app.vtranslate('JS_SUNDAY'),app.vtranslate('JS_MONDAY'),app.vtranslate('JS_TUESDAY'),app.vtranslate('JS_WEDNESDAY'),app.vtranslate('JS_THURSDAY'),app.vtranslate('JS_FRIDAY'),app.vtranslate('JS_SATURDAY')],dayNamesShort:[app.vtranslate('JS_SUN'),app.vtranslate('JS_MON'),app.vtranslate('JS_TUE'),app.vtranslate('JS_WED'),app.vtranslate('JS_THU'),app.vtranslate('JS_FRI'),app.vtranslate('JS_SAT')],buttonText:{today:app.vtranslate('JS_TODAY'),month:app.vtranslate('JS_MONTH'),week:app.vtranslate('JS_WEEK'),day:app.vtranslate('JS_DAY')},allDayText:app.vtranslate('JS_ALL_DAY'),eventLimitText:app.vtranslate('JS_MORE')});},registerButtonSelectAll:function b(){var a=$('.selectAllBtn');a.on('click',function(){var a=$(this).find('.selectAll'),b=$(this).find('.deselectAll');a.hasClass('d-none')?(a.removeClass('d-none'),b.addClass('d-none'),$(this).closest('.quickWidget').find('select option').prop('selected',!1)):($(this).closest('.quickWidget').find('select option').prop('selected',!0),b.removeClass('d-none'),a.addClass('d-none')),$(this).closest('.quickWidget').find('select').trigger('change');});},loadCalendarData:function j(a){var b=jQuery.progressIndicator(),c=this;c.getCalendarView().fullCalendar('removeEvents');var d,e=c.getCalendarView().fullCalendar('getView'),f=e.start.format(),g=e.end.format();if(d=0==jQuery('#calendarUserList').length?CONFIG.userId:jQuery('#calendarUserList').val(),0<jQuery('#timecontrolTypes').length)var h=jQuery('#timecontrolTypes').val();else a=!0;if(!0==a||null!=h){var i={module:'Reservations',action:'Calendar',mode:'getEvent',start:f,end:g,user:d,types:h};AppConnector.request(i).done(function(a){c.getCalendarView().fullCalendar('addEventSource',a.result),b.hide();});}else c.getCalendarView().fullCalendar('removeEvents'),b.hide();},updateEvent:function h(a,b,c){var d=jQuery.progressIndicator(),e=a.start.format(),f=a.end.format(),g={module:'Reservations',action:'Calendar',mode:'updateEvent',id:a.id,start:e,delta:b._data};AppConnector.request(g).done(function(a){a.result||(Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_NO_EDIT_PERMISSION')),c()),d.hide();}).fail(function(){d.hide(),Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_NO_EDIT_PERMISSION')),c();});},selectDay:function c(a){var b=this;b.getCalendarCreateView().done(function(c){if(!(0>=c.length)){var d=c.find('[name="date_start"]').data('dateFormat').toUpperCase(),e=c.find('[name="time_start"]').data('format');if(24==e)var f='HH:mm';else f='hh:mm A';var g,h=Date.parse(a),i=moment(a).format(d),j=moment(a).format(f),k=Date.parse(a),l=moment(a).format(d),m=b.getCalendarView().fullCalendar('getView');if('month'==m.name){var n=parseInt((k-h)/86400000);if(1<n){var o=jQuery('#start_hour').val(),p=o.split(':');j=p[0];var q=jQuery('#end_hour').val();p=q.split(':'),g=p[0];}else{var r=new Date;j=moment(r).format(f),g=moment(r).add(15,'minutes').format(f);}}else g=moment(k).add(30,'minutes').format(f);c.find('[name="date_start"]').val(i),c.find('[name="due_date"]').val(l),c.find('[name="time_start"]').val(j),c.find('[name="time_end"]').val(g);var s=new Vtiger_Header_Js;s.handleQuickCreateData(c,{callbackFunction:function c(a){b.addCalendarEvent(a.result,d);}}),jQuery('.modal-body').css({"max-height":app.getScreenHeight(70)+'px',"overflow-y":'auto'});}});},addCalendarEvent:function f(a){if(!($('#calendarUserList').val().length&&0>$.inArray(a.assigned_user_id.value,$('#calendarUserList').val()))&&!(0>$.inArray(a.type.value,$('#timecontrolTypes').val()))){var b=this.getCalendarView(),c=b.fullCalendar('moment',a.date_start.value+' '+a.time_start.value),d=b.fullCalendar('moment',a.due_date.value+' '+a.time_end.value),e={id:a._recordId,title:a.title.display_value,smownerid:a.assigned_user_id?a.assigned_user_id.display_value:a.smownerid,status:a.reservations_status?a.reservations_status.display_value:a.status,isPrivate:a.isPrivate,start:c.toString(),end:d.toString(),url:'index.php?module=Reservations&view=Detail&record='+a._recordId,className:'ownerCBg_'+a.assigned_user_id.value+' picklistCBg_OSSTimeControl_timecontrol_type_'+a.type.value,totalTime:a.sum_time.display_value,type:a.type.display_value};this.getCalendarView().fullCalendar('renderEvent',e);}},getCalendarCreateView:function d(){var a=this,b=jQuery.Deferred();if(!1!==this.calendarCreateView)return b.resolve(this.calendarCreateView.clone(!0,!0)),b.promise();var c=jQuery.progressIndicator();return this.loadCalendarCreateView().done(function(d){c.hide(),a.calendarCreateView=d,b.resolve(d.clone(!0,!0));}).fail(function(){c.hide();}),b.promise()},registerRefreshEvent:function b(){var a=this;$('.refreshCalendar').on('click',function(){$(this).closest('.refreshHeader').addClass('d-none'),a.loadCalendarData();});},loadCalendarCreateView:function d(){var a=jQuery.Deferred(),b=app.getModuleName(),c=Vtiger_Header_Js.getInstance();return c.getQuickCreateForm('index.php?module='+b+'&view=QuickCreateAjax',b).done(function(b){a.resolve(jQuery(b));}).fail(function(b,c){a.reject(b,c);}),a.promise()},getCalendarView:function a(){return !1==this.calendarView&&(this.calendarView=jQuery('#calendarview')),this.calendarView},registerChangeView:function b(){var a=this;a.getCalendarView().find('button.fc-button:not(.dropdown-toggle)').on('click',function(){a.loadCalendarData();});},registerEvents:function a(){this.registerCalendar(),this.loadCalendarData(!0),this.registerChangeView(),this.registerButtonSelectAll(),this.registerRefreshEvent();}});
