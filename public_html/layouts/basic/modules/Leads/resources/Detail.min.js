'use strict';

Vtiger_Detail_Js('Leads_Detail_Js',{cache:{},detailCurrentInstance:!1,convertLead:function d(a,b){var c=Leads_Detail_Js.detailCurrentInstance;c.convertLeadContainer=!1,c.convertLeadForm=!1,c.convertLeadModules=!1,jQuery.isEmptyObject(Leads_Detail_Js.cache)?AppConnector.request(a).done(function(a){a&&(Leads_Detail_Js.cache=a,c.displayConvertLeadModel(a,b));},function(){}):c.displayConvertLeadModel(Leads_Detail_Js.cache,b);}},{convertLeadForm:!1,convertLeadContainer:!1,convertLeadModules:!1,init:function a(){this._super(),Leads_Detail_Js.detailCurrentInstance=this;},disableConvertLeadButton:function b(a){jQuery(a).attr('disabled','disabled');},enableConvertLeadButton:function b(a){jQuery(a).removeAttr('disabled');},removeDisableAttr:function b(a){a.find('input,textarea,select').removeAttr('disabled');},addDisableAttr:function b(a){a.find('input,textarea,select').attr('disabled','disabled');},displayConvertLeadModel:function i(a,b){var c=this,d=jQuery(a).find('#convertLeadError');if('0'!=d.length){var e=d.val(),f=jQuery(a).find('#convertLeadErrorTitle').val(),g={title:f,text:e,addclass:'convertLeadNotify',width:'35%',pnotify_after_open:function a(){c.disableConvertLeadButton(b);},pnotify_after_close:function a(){c.enableConvertLeadButton(b);}};Vtiger_Helper_Js.showPnotify(g);}else{var h=function(a){var b=Vtiger_Edit_Js.getInstance();jQuery(a).find('.fieldInfo').collapse({parent:'#leadAccordion',toggle:!1}),app.showScrollBar(jQuery(a).find('#leadAccordion'),{height:'420px'}),b.registerBasicEvents(a);var d=c.getConvertLeadModules();jQuery.each(d,function(a,b){c.checkingModuleSelection(b);}),c.registerForReferenceField(),c.registerConvertLeadEvents(),c.getConvertLeadForm().validationEngine(app.validationEngineOptions),c.registerConvertLeadSubmit();};app.showModalWindow(a,function(a){'function'==typeof h&&h(a);},{"text-align":'left'});}},checkingModuleSelection:function e(a){var b=this,c=jQuery(a).val(),d=jQuery(a).closest('.convertLeadModules').find('#'+c+'_FieldInfo');jQuery(a).is(':checked')?b.removeDisableAttr(d):b.addDisableAttr(d);},registerForReferenceField:function c(){var a=this.getConvertLeadContainer(),b=jQuery('.reference',a);0<b.length&&jQuery('#AccountsModule').attr('readonly','readonly');},registerConvertLeadEvents:function c(){var a=this.getConvertLeadContainer(),b=this;a.on('hide.bs.collapse','.js-collapse ',function(a){$(a.currentTarget).closest('.convertLeadModules').find('[data-fa-i2svg]').removeClass('fa-chevron-up').addClass('fa-chevron-down');}).on('show.bs.collapse','.js-collapse ',function(a){$(a.currentTarget).closest('.convertLeadModules').find('[data-fa-i2svg]').removeClass('fa-chevron-down').addClass('fa-chevron-up');}),a.on('click','.transferModule',function(a){var c=jQuery(a.currentTarget),d=c.val(),e=jQuery('#'+d+'_FieldInfo');c.is(':checked')&&(jQuery('#'+d+'Module').prop('checked',!0),e.collapse('show'),b.removeDisableAttr(e));}),a.on('click','.convertLeadModuleSelection',function(a){var c=jQuery(a.currentTarget),d=c.val(),e=c.closest('.convertLeadModules').find('#'+d+'_FieldInfo'),f=jQuery('#transfer'+d),g=jQuery('input[name="transferModule"]').not(f),h=jQuery(g).val(),i=jQuery('#'+h+'Module');c.is(':checked')?(e.collapse('show'),b.removeDisableAttr(e),!i.is(':checked')&&jQuery(f).prop('checked',!0)):(e.collapse('hide'),b.addDisableAttr(e),jQuery(f).prop('checked',!1),i.is(':checked')&&jQuery(g).prop('checked',!0)),a.stopImmediatePropagation();});},registerConvertLeadSubmit:function c(){var a=this,b=this.getConvertLeadForm();b.on('jqv.form.validating',function(a){var b=jQuery(a.currentTarget).data('jqv');b.InvalidFields=[];}),b.on('submit',function(c){var d=a.getConvertLeadModules(),e=[],f=b.find('#AccountsModule'),g=b.data('jqv').InvalidFields;if(0<g.length){var h=g[0],i=jQuery(h).closest('.js-collapse');return i.collapse('show'),void c.preventDefault()}jQuery.each(d,function(a,b){jQuery(b).is(':checked')&&e.push(jQuery(b).val());}),b.find('input[name="modules"]').val(JSON.stringify(e));var j=f.length;'0'!=j&&-1==jQuery.inArray('Accounts',e)&&(alert(app.vtranslate('JS_SELECT_ORGANIZATION')),c.preventDefault());});},getConvertLeadModules:function b(){var a=this.getConvertLeadContainer();return !1==this.convertLeadModules&&(this.convertLeadModules=jQuery('.convertLeadModuleSelection',a)),this.convertLeadModules},getConvertLeadForm:function a(){return !1==this.convertLeadForm&&(this.convertLeadForm=jQuery('#convertLeadForm')),this.convertLeadForm},getConvertLeadContainer:function a(){return !1==this.convertLeadContainer&&(this.convertLeadContainer=jQuery('#leadAccordion')),this.convertLeadContainer},saveFieldValues:function g(a){var b=jQuery.Deferred(),c=this.getRecordId(),d={};if('undefined'!=typeof a&&(d=a),d.record=c,d.module=app.getModuleName(),d.action='SaveAjax',AppConnector.request(d).done(function(a){b.resolve(a);}),'leadstatus'==a.field){var e=jQuery('.btn-convertLead'),f=JSON.parse(jQuery('#conversion_available_status').val());0===f.length||-1!=jQuery.inArray(a.value,f)?e.removeClass('d-none'):e.addClass('d-none');}return b.promise()},updateConvertLeadvalue:function c(){var a=Vtiger_Detail_Js.getInstance(),b=a.getContentHolder();b.on(a.fieldUpdatedEvent,'input,select',function(a,b){var c=jQuery(a.currentTarget),d=c.attr('name'),e=b['new'];if(!jQuery.isEmptyObject(Leads_Detail_Js.cache)){var f=jQuery(Leads_Detail_Js.cache),g=f.find('[name="'+d+'"]');if(c.is('select')){var h=g.val();g.find('option[value="'+h+'"]').removeAttr('selected'),g.find('option[value="'+e+'"]').attr('selected','selected'),g.trigger('chosen:updated');}else g.attr('value',e);Leads_Detail_Js.cache=f;}});},registerEvents:function a(){this._super(),this.updateConvertLeadvalue();}});
