{"version":3,"file":"Edit.min.js","sources":["Edit.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nVtiger_Edit_Js(\n\t'HelpDesk_Edit_Js',\n\t{},\n\t{\n\t\t/**\n\t\t * Register pre save event\n\t\t * @param {jQuery} form\n\t\t */\n\t\tregisterRecordPreSaveEventEvent: function (form) {\n\t\t\tthis._super(form);\n\t\t\tform.on(Vtiger_Edit_Js.recordPreSave, (e, data) => {\n\t\t\t\ttry {\n\t\t\t\t\tthis.validateToClose(form).done((response) => {\n\t\t\t\t\t\tif (response !== true) {\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} catch (error) {\n\t\t\t\t\tapp.errorLog(error);\n\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\ttext: app.vtranslate('JS_ERROR'),\n\t\t\t\t\t\ttype: 'error'\n\t\t\t\t\t});\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tvalidateToClose: function (form) {\n\t\t\tconst aDeferred = $.Deferred();\n\t\t\tlet closedStatus = app.getMainParams('closeTicketForStatus', true);\n\t\t\tlet status = form.find('[name=\"ticketstatus\"] :selected').val();\n\t\t\tlet progress = $.progressIndicator({ position: 'html', blockInfo: { enabled: true } });\n\t\t\tlet isClosedStatusSet = status in closedStatus;\n\t\t\tconst recordId = form.find('[name=\"record\"]').val();\n\t\t\tif (\n\t\t\t\t(app.getMainParams('checkIfRecordHasTimeControl') || app.getMainParams('checkIfRelatedTicketsAreClosed')) &&\n\t\t\t\tisClosedStatusSet &&\n\t\t\t\trecordId\n\t\t\t) {\n\t\t\t\tlet formData = {\n\t\t\t\t\taction: 'CheckValidateToClose',\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\trecord: recordId,\n\t\t\t\t\tstatus: form.find('[name=\"ticketstatus\"] :selected').val()\n\t\t\t\t};\n\t\t\t\tAppConnector.request({\n\t\t\t\t\tasync: false,\n\t\t\t\t\turl: 'index.php',\n\t\t\t\t\ttype: 'POST',\n\t\t\t\t\tdata: formData\n\t\t\t\t}).done((response) => {\n\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\tif (response.result.hasTimeControl.result && response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\taDeferred.resolve(true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!response.result.hasTimeControl.result) {\n\t\t\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\t\t\ttext: response.result.hasTimeControl.message,\n\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tthis.addTimeControl({\n\t\t\t\t\t\t\t\trecordId: recordId,\n\t\t\t\t\t\t\t\turl: `index.php?module=OSSTimeControl&view=Edit&sourceModule=HelpDesk&sourceRecord=${recordId}&relationOperation=true&subprocess=${recordId}&subprocess=${recordId}`\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\t\t\ttext: response.result.relatedTicketsClosed.message,\n\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\taDeferred.resolve(false);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (isClosedStatusSet && !recordId) {\n\t\t\t\tapp.showNotify({\n\t\t\t\t\ttext: app.vtranslate('JS_CANT_CLOSE_NEW_RECROD'),\n\t\t\t\t\ttype: 'info'\n\t\t\t\t});\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\taDeferred.resolve(false);\n\t\t\t} else {\n\t\t\t\taDeferred.resolve(true);\n\t\t\t}\n\n\t\t\treturn aDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Add time control when closed ticket\n\t\t * @param {array} params\n\t\t */\n\t\taddTimeControl: function (params) {\n\t\t\tlet aDeferred = jQuery.Deferred();\n\t\t\tlet referenceModuleName = 'OSSTimeControl';\n\t\t\tlet parentId = params.recordId;\n\t\t\tlet parentModule = 'HelpDesk';\n\t\t\tlet quickCreateParams = {};\n\t\t\tlet relatedParams = {};\n\t\t\tlet relatedField = 'subprocess';\n\t\t\tlet fullFormUrl = params.url;\n\t\t\trelatedParams[relatedField] = parentId;\n\t\t\tlet eliminatedKeys = new Array('view', 'module', 'mode', 'action');\n\n\t\t\tlet preQuickCreateSave = function (data) {\n\t\t\t\tlet index, queryParam, queryParamComponents;\n\t\t\t\tlet queryParameters = [];\n\n\t\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\t\tqueryParameters = queryString.split('&');\n\t\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\t\tif (queryParamComponents[0] == 'mode' && queryParamComponents[1] == 'Calendar') {\n\t\t\t\t\t\t\tdata.find('a[data-tab-name=\"Task\"]').trigger('click');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceModule\" value=\"' + parentModule + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceRecord\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />').appendTo(data);\n\n\t\t\t\tif (typeof relatedField !== 'undefined') {\n\t\t\t\t\tlet field = data.find('[name=\"' + relatedField + '\"]');\n\t\t\t\t\tif (field.length == 0) {\n\t\t\t\t\t\tjQuery('<input type=\"hidden\" name=\"' + relatedField + '\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (\n\t\t\t\t\t\tjQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1' &&\n\t\t\t\t\t\tdata.find('[name=\"' + queryParamComponents[0] + '\"]').length == 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tjQuery(\n\t\t\t\t\t\t\t'<input type=\"hidden\" name=\"' + queryParamComponents[0] + '\" value=\"' + queryParamComponents[1] + '\" />'\n\t\t\t\t\t\t).appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\tlet queryParameters = queryString.split('&');\n\t\t\t\tfor (let index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tlet queryParam = queryParameters[index];\n\t\t\t\t\tlet queryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (jQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1') {\n\t\t\t\t\t\trelatedParams[queryParamComponents[0]] = queryParamComponents[1];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tquickCreateParams['data'] = relatedParams;\n\t\t\tquickCreateParams['callbackFunction'] = function () {};\n\t\t\tquickCreateParams['callbackPostShown'] = preQuickCreateSave;\n\t\t\tquickCreateParams['noCache'] = true;\n\t\t\tApp.Components.QuickCreate.createRecord(referenceModuleName, quickCreateParams);\n\t\t\treturn aDeferred.promise();\n\t\t}\n\t}\n);\n"],"names":["Vtiger_Edit_Js","registerRecordPreSaveEventEvent","form","_super","on","recordPreSave","e","validateToClose","done","response","preventDefault","error","app","errorLog","showNotify","text","vtranslate","type","aDeferred","$","Deferred","closedStatus","getMainParams","status","find","val","progress","progressIndicator","position","blockInfo","enabled","isClosedStatusSet","recordId","formData","action","module","getModuleName","record","AppConnector","request","async","url","data","mode","result","hasTimeControl","relatedTicketsClosed","resolve","message","addTimeControl","promise","params","jQuery","parentId","quickCreateParams","relatedParams","relatedField","fullFormUrl","eliminatedKeys","Array","preQuickCreateSave","index","queryParam","queryParamComponents","queryParameters","indexOf","urlSplit","split","queryString","length","trigger","appendTo","field","inArray","App","Components","QuickCreate","createRecord"],"mappings":"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"}