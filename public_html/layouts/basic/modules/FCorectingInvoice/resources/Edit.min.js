'use strict';

/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */

Vtiger_Edit_Js('FCorectingInvoice_Edit_Js', {}, {
	/**
  * Load correcting invoice data to before block
  * @param {int} recordId
  */
	loadInvoiceData: function loadInvoiceData() {
		var recordId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;

		if (!recordId) {
			recordId = parseInt(this.getForm().find('input[name="finvoiceid"]').val());
		}
		if (recordId) {
			var form = this.getForm();
			var progressLoader = $.progressIndicator({ blockInfo: { enabled: true } });
			AppConnector.request({
				module: 'FInvoice',
				record: recordId,
				mode: 'showInventoryDetails',
				view: 'Detail'
			}).done(function (response) {
				form.find('.js-before-inventory').html(response);
				progressLoader.progressIndicator({ mode: 'hide' });
			}).fail(function () {
				progressLoader.progressIndicator({ mode: 'hide' });
			});
		}
	},

	/**
  * register reference fields events
  */
	registerReferenceFieldsEvents: function registerReferenceFieldsEvents() {
		var _this = this;

		app.event.on('EditView.SelectReference', function (e, params) {
			if (params.source_module === 'FInvoice') {
				_this.loadInvoiceData(params.record);
			}
		});
		var form = this.getForm();
		app.event.on('EditView.ClearField', function (e, params) {
			if (params.fieldName === 'finvoiceid') {
				var invoiceidInput = form.find('[name="finvoiceid"]');
				if (invoiceidInput.length) {
					form.find('.js-before-inventory').html('<div class="text-center">' + app.vtranslate('JS_FCORECTINGINVOICE_CHOOSE_INVOICE') + '</div>');
				}
			}
		});
	},

	/**
  * Action for copy from correcting invoice button - load data before positions to position in data after block
  */
	registerCopyFromInvoice: function registerCopyFromInvoice() {
		var form = this.getForm();
		var thisInstance = this;
		form.find('.js-copy-from-invoice').on('click', function (e) {
			e.preventDefault();
			e.stopPropagation();
			var finvoiceidInput = form.find('input[name="finvoiceid"]');
			if (!finvoiceidInput.length) {
				return false;
			}
			var finvoiceid = finvoiceidInput.val();
			if (!finvoiceid) {
				return Vtiger_Helper_Js.showMessage({
					type: 'error',
					text: app.vtranslate('JS_FCORECTINGINVOICE_CHOOSE_INVOICE')
				});
			}
			thisInstance.inventoryController.loadInventoryData(finvoiceid, 'FInvoice');
		});
	},

	/**
  * registerEvents override
  */
	registerEvents: function registerEvents() {
		this._super();
		this.registerCopyFromInvoice();
		this.registerReferenceFieldsEvents();
		this.loadInvoiceData();
	}
});
//# sourceMappingURL=Edit.min.js.map
