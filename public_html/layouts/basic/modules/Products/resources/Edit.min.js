'use strict';

Vtiger_Edit_Js('Products_Edit_Js',{},{baseCurrency:'',baseCurrencyName:'',multiCurrencyContainer:!1,unitPrice:!1,getUnitPrice:function a(){return !1==this.unitPrice&&(this.unitPrice=$('input.unitPrice',this.getForm())),this.unitPrice},getMoreCurrenciesContainer:function a(){return !1==this.multiCurrencyContainer&&(this.multiCurrencyContainer=$('.multiCurrencyEditUI')),this.multiCurrencyContainer},alignBelowUnitPrice:function c(a){var b=$('input[name="unit_price"]',this.getForm());return a.position({of:b,my:'left top',at:'left bottom',collision:'flip'}),this},getCurrentElem:function b(a){return $(a.currentTarget)},registerEventForTaxes:function c(){var a=this,b=this.getForm();return $('.taxes').on('change',function(c){var d=a.getCurrentElem(c),e=d.data('taxName');d.is(':checked')?$('input[name='+e+']',b).removeAttr('readonly'):$('input[name='+e+']',b).attr('readonly','readonly');}),this},registerEventForEnableBaseCurrency:function d(){var a=this.getMoreCurrenciesContainer(),b=$('.js-currency'),c=this;return $(a).on('change','.baseCurrency',function(a){var d=c.getCurrentElem(a),e=d.closest('tr');if(d.is(':checked')){var f=$('.convertedPrice',e).val();c.baseCurrencyName=e.data('currencyId'),c.baseCurrency=f,b.text(e.data('currency-symbol'));}}),this},registerEventForResetCurrency:function c(){var a=this.getMoreCurrenciesContainer(),b=this;return $(a).on('click','.currencyReset',function(a){var c=b.getCurrentElem(a).closest('tr'),d=b.getUnitPrice().data(),e=b.getDataBaseFormatUnitPrice(),f=$('.conversionRate',c).val(),g=parseFloat(e)*parseFloat(f),h=app.parseNumberToShow(g);$('.convertedPrice',c).val(h);}),this},getDataBaseFormatUnitPrice:function c(){var a=this.getUnitPrice(),b=a.getNumberFromValue();return b},calculateConversionRate:function e(){var a=this.getMoreCurrenciesContainer(),b=a.find('.baseCurrency').filter(':checked').closest('tr'),c=b.find('.conversionRate');if('1'!=c.val()){var d=c.val();a.find('.conversionRate').each(function(a,b){var e=$(b);if(!e.is(c)){var f=e.val();e.val(f/d);}}),c.val('1');}},registerEventForEnableCurrency:function c(){var a=this.getMoreCurrenciesContainer(),b=this;return $(a).on('change','.enableCurrency',function(a){var c=b.getCurrentElem(a),d=c.closest('tr');if(c.is(':checked')){c.attr('checked','checked');var e=$('.conversionRate',d).val(),f=b.getUnitPrice().data(),g=b.getDataBaseFormatUnitPrice(),h=parseFloat(g)*parseFloat(e);$('input',d).attr('disabled',!0).removeAttr('disabled'),$('button.currencyReset',d).attr('disabled',!0).removeAttr('disabled');var i=app.parseNumberToShow(h);$('input.convertedPrice',d).val(i);}else{var j=$('.baseCurrency',d);if(j.is(':checked')){var k=$('.currencyName',d).text(),l={type:'error',title:app.vtranslate('JS_ERROR'),text:app.vtranslate('JS_BASE_CURRENCY_CHANGED_TO_DISABLE_CURRENCY')+'"'+k+'"'};return Vtiger_Helper_Js.showPnotify(l),void c.prop('checked',!0)}$('input',d).attr('disabled',!0),$('input.enableCurrency',d).removeAttr('disabled'),$('button.currencyReset',d).attr('disabled','disabled');}}),this},getMoreCurrenciesUI:function g(){var a=$.Deferred(),b=app.getModuleName(),c=$('input[name="base_currency"]').val(),d=$('input[name="record"]').val(),e=$('#moreCurrenciesContainer');f=e.find('.multiCurrencyEditUI');var f;if(0==f.length){AppConnector.request({module:b,view:'MoreCurrenciesList',currency:c,record:d}).done(function(b){e.html(b),a.resolve(b);}).fail(function(b,c){a.reject(b,c);});}else a.resolve();return a.promise()},registerEventForMoreCurrencies:function c(){var a=this,b=this.getForm();$('#moreCurrencies').on('click',function(){var b=$.progressIndicator();a.getMoreCurrenciesUI().done(function(){var c;if(c=$('#moreCurrenciesContainer').find('.multiCurrencyEditUI'),0<c.length){c=c.clone(!0,!0),b.hide();var d=function(b){var c=app.validationEngineOptionsForRecord,d=b.find('#currencyContainer');c.onValidationComplete=function(b,c){return c&&a.saveCurrencies(),!1},d.validationEngine(c),app.showScrollBar(b.find('.currencyContent'),{height:'400px'}),a.baseCurrency=a.getUnitPrice().val();var e=$('.multiCurrencyEditUI');a.multiCurrencyContainer=e,a.calculateConversionRate(),a.registerEventForEnableCurrency(),a.registerEventForEnableBaseCurrency(),a.registerEventForResetCurrency(),a.triggerForBaseCurrencyCalc();},e=$('#moreCurrenciesContainer').find('.multiCurrencyEditUI'),f=c.find('.multiCurrencyContainer').html();c.find('.multiCurrencyContainer').remove();$('<form id="currencyContainer"></form>').insertAfter(c.find('.modal-header')),c.find('form').html(f),e.find('input[name^=curname]').each(function(a,b){var d=$(b).val(),e=$(b).attr('id');c.find('#'+e).val(d);});var g={data:c,css:{"text-align":'left',width:'65%'},cb:d};app.showModalWindow(g);}});});},triggerForBaseCurrencyCalc:function c(){var a=this.getMoreCurrenciesContainer(),b=a.find('.enableCurrency');$.each(b,function(a,b){if($(b).is(':checked')){var c=$(b).closest('tr');0==parseFloat(c.find('.convertedPrice').val())&&c.find('.currencyReset').trigger('click');}else $(b).closest('tr').find('.convertedPrice').val('');});},registerEventForUnitPrice:function c(){var a=this,b=this.getUnitPrice();b.on('change',function(){a.triggerForBaseCurrencyCalc();});},registerRecordPreSaveEvent:function c(a){var b=this;'undefined'==typeof a&&(a=this.getForm()),a.on(Vtiger_Edit_Js.recordPreSave,function(c){var d=$('#moreCurrenciesContainer').find('.currencyContent'),e=b.getUnitPrice();1>d.length&&0<e.length?(c.preventDefault(),b.getMoreCurrenciesUI().done(function(){b.preSaveConfigOfForm(a),InitialFormData=a.serialize(),a.submit();})):0<d.length&&b.preSaveConfigOfForm(a);});},preSaveConfigOfForm:function e(a){var b=this.getUnitPrice();if(0<b.length){var c=b.val(),d=a.find('[name="base_currency"]').val();a.find('[name="'+d+'"]').val(c),a.find('#requstedUnitPrice').attr('name',d).val(c);}},saveCurrencies:function m(){var a,b,c=this,d=$('#currencyContainer'),e=c.getForm(),f=$('#'+Window.lastModalId),g=f.find('.enableCurrency').filter(':checked');if(1>g.length)return a=app.vtranslate('JS_PLEASE_SELECT_BASE_CURRENCY_FOR_PRODUCT'),b={text:a,type:'error'},Vtiger_Helper_Js.showMessage(b),void d.removeData('submit');g.attr('checked','checked'),f.find('.enableCurrency').filter(':not(:checked)').removeAttr('checked');var h=f.find('.baseCurrency').filter(':checked');if(1>h.length)return a=app.vtranslate('JS_PLEASE_ENABLE_BASE_CURRENCY_FOR_PRODUCT'),b={text:a,type:'error'},Vtiger_Helper_Js.showMessage(b),void d.removeData('submit');h.attr('checked','checked'),f.find('.baseCurrency').filter(':not(:checked)').removeAttr('checked');var i=h.closest('tr'),j=$('.convertedPrice',i).val();c.baseCurrencyName=i.data('currencyId'),c.baseCurrency=j,c.getUnitPrice().val(c.baseCurrency),$('input[name="base_currency"]',e).val(c.baseCurrencyName);var k=f.find('.currencyContent').html(),l=$('#moreCurrenciesContainer');l.find('.currencyContent').html(k),f.find('input[name^=curname]').each(function(a,b){var c=$(b).val(),d=$(b).attr('id');l.find('.currencyContent').find('#'+d).val(c);}),app.hideModalWindow();},registerSubmitEvent:function b(){var a=this.getForm();a.on('submit',function(b){if('undefined'!=typeof a.data('submit'))return !1;$(b.currentTarget).find('[name="module"]').val();if(a.validationEngine('validate')){a.data('submit','true');var c=$.Event(Vtiger_Edit_Js.recordPreSave);a.trigger(c,{value:'edit'}),c.isDefaultPrevented()&&(a.removeData('submit'),b.preventDefault());}else a.removeData('submit'),app.formAlignmentAfterValidation(a);});},registerEventForUsageunit:function a(){this.checkUsageUnit(),$('select[name="usageunit"]').on('change',this.checkUsageUnit);},checkUsageUnit:function d(){var a=$('select[name="usageunit"]'),b=$('input[name="qty_per_unit"]'),c=a.val();'pack'===c?b.prop('disabled',!1):b.prop('disabled',!0);},registerEvents:function a(){this._super(),this.registerEventForMoreCurrencies(),this.registerEventForTaxes(),this.registerEventForUnitPrice(),this.registerRecordPreSaveEvent(),this.registerEventForUsageunit();}});
