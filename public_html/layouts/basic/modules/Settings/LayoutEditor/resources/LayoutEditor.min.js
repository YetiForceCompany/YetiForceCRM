jQuery.Class("Settings_LayoutEditor_Js",{},{updatedBlockSequence:{},reactiveFieldsList:[],inActiveFieldsList:false,updatedBlockFieldsList:[],updatedBlocksList:[],blockNamesList:[],setInactiveFieldsList:function(){var c=this;var b=jQuery("#layoutEditorContainer").find(".contents");var a=b.find(".inActiveFieldsArray");if(0<a.length){c.inActiveFieldsList=JSON.parse(a.val())}},makeBlocksListSortable:function(){var c=this;var b=jQuery("#layoutEditorContainer").find(".contents");var a=b.find(".blockSortable");b.sortable({containment:b,items:a,revert:true,tolerance:"pointer",cursor:"move",update:function(f,d){c.updateBlockSequence()}})},updateBlockSequence:function(){var a=this;var b=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d=JSON.stringify(a.updateBlocksListByOrder());var c={};c.module=app.getModuleName();c.parent=app.getParentModuleName();c.action="Block";c.mode="updateSequenceNumber";c.sequence=d;AppConnector.request(c).then(function(e){b.progressIndicator({mode:"hide"});var f={};f.text=app.vtranslate("JS_BLOCK_SEQUENCE_UPDATED");Settings_Vtiger_Index_Js.showMessage(f)},function(e){b.progressIndicator({mode:"hide"})})},updateBlocksListByOrder:function(){var b=this;var a=jQuery("#layoutEditorContainer").find(".contents");a.find(".editFieldsTable.blockSortable").each(function(e,g){var f=jQuery(g);var d=f.data("blockId");var c=f.data("sequence");var h=(e+1);if(h!=c){f.data("sequence",h)}b.updatedBlockSequence[d]=h});return b.updatedBlockSequence},registerRelatedListEvents:function(){var d=this;var f=jQuery("#relatedTabOrder");var a=f.find(".relatedTabModulesList");var e=a.find("ul.relatedModulesList");var c=app.showSelectizeElementView(a.find(".select2_container"),{plugins:["drag_drop","remove_button"],onInitialize:function(){var h=this,g=this.revertSettings.$children;if(g.first().is("optgroup")){g=g.find("option")}g.each(function(){var i=$(this).data();$.extend(h.options[this.value],i)})}});f.on("click",".inActiveRelationModule",function(i){var h=jQuery(i.currentTarget);var g=h.closest(".relatedModule");g.find(".activeRelationModule").removeClass("d-none").show();h.hide();d.changeStatusRelatedModule(g.data("relation-id"),false)});f.on("click",".activeRelationModule",function(i){var h=jQuery(i.currentTarget);var g=h.closest(".relatedModule");g.find(".inActiveRelationModule").removeClass("d-none").show();h.hide();d.changeStatusRelatedModule(g.data("relation-id"),true)});f.on("click",".removeRelation",function(i){var h=jQuery(i.currentTarget);var g=h.closest(".relatedModule");d.removeRelation(g)});var b=a.find(".relatedColumnsList");b.on("change",function(j){var i=jQuery(j.currentTarget);var h=i.closest(".relatedModule");var g=d.updateSelectedFields(i)});f.on("click",".addToFavorites",function(h){var g=jQuery(h.currentTarget);d.changeStateFavorites(g)});f.on("change",".relatedViewType",function(i){var h=$(this);var g=h.val();if(!g){h.validationEngine("showPrompt",app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"));return false}h.validationEngine("hide");d.changeRelatedViewType(h)});f.on("click",".addRelation",function(k){var j=jQuery(k.currentTarget);var g=j.closest("#relatedTabOrder");var l=g.closest(".contentsDiv");var h=f.find(".addRelationContainer").clone(true,true);var i=function(m){app.showSelect2ElementView(m.find("select"));m.find(".relLabel").val(m.find(".target option:selected").val());m.on("change",".target",function(o){var n=jQuery(o.currentTarget);m.find(".relLabel").val(n.find("option:selected").val())});m.on("click",".addButton",function(o){var n=m.find("form").serializeFormData();var p={};p.module=app.getModuleName();p.parent=app.getParentModuleName();p.action="Relation";p.mode="addRelation";$.extend(p,n);AppConnector.request(p).then(function(q){d.getRelModuleLayoutEditor(g.find('[name="layoutEditorRelModules"]').val()).then(function(r){l.html(r);d.registerEvents()})})})};app.showModalWindow(h,function(m){if(typeof i=="function"){i(m)}})})},getSelectedFields:function(b){var a=[];b.find(":selected").each(function(c){a.push({id:jQuery(this).val(),name:b[0].selectize.options[jQuery(this).val()].fieldName})});return a},makeRelatedModuleSortable:function(){var a=this;var b=jQuery(".relatedModulesList");var c=b.find(".relatedModule");b.sortable({containment:b,items:c,handle:".mainBlockTableLabel",revert:true,tolerance:"pointer",cursor:"move",update:function(f,d){a.updateSequenceRelatedModule()}})},changeRelatedViewType:function(b){var a=b.closest(".relatedModule");AppConnector.request({module:app.getModuleName(),parent:app.getParentModuleName(),action:"Relation",mode:"updateRelatedViewType",relationId:a.data("relation-id"),types:b.val()}).then(function(c){if(c.success){Settings_Vtiger_Index_Js.showMessage({text:c.result.text})}else{Settings_Vtiger_Index_Js.showMessage({type:"error",text:c.error.message})}},function(c){Settings_Vtiger_Index_Js.showMessage({text:c.message})})},changeStateFavorites:function(d){var c=this;var b=d.closest(".relatedModule");var a=d.data("state")==1?0:1;var e={};e.module=app.getModuleName();e.parent=app.getParentModuleName();e.action="Relation";e.mode="updateStateFavorites";e.relationId=b.data("relation-id");e.status=a;AppConnector.request(e).then(function(f){d.data("state",a);d.find("[data-fa-i2svg]").each(function(){if(jQuery(this).hasClass("d-none")){jQuery(this).removeClass("d-none")}else{jQuery(this).addClass("d-none")}});Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_SAVE_NOTIFY_OK")})},function(f){var g={};g.text=f;Settings_Vtiger_Index_Js.showMessage(g)})},changeStatusRelatedModule:function(b,a){var c={};c.module=app.getModuleName();c.parent=app.getParentModuleName();c.action="Relation";c.mode="changeStatusRelation";c.relationId=b;c.status=a;AppConnector.request(c).then(function(d){var e={};if(a){e.text=app.vtranslate("JS_SAVED_CHANGE_STATUS_1")}else{e.text=app.vtranslate("JS_SAVED_CHANGE_STATUS_0")}Settings_Vtiger_Index_Js.showMessage(e)},function(d){var e={};e.text=d;e.type="error";Settings_Vtiger_Index_Js.showMessage(e)})},removeRelation:function(c){var b=this;var a=app.vtranslate("JS_DELETE_RELATION_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:a}).then(function(d){var f={};f.module=app.getModuleName();f.parent=app.getParentModuleName();f.action="Relation";f.mode="removeRelation";f.relationId=c.data("relation-id");AppConnector.request(f).then(function(e){var g={};g.text=app.vtranslate("JS_REMOVE_RELATION_OK");c.remove();Settings_Vtiger_Index_Js.showMessage(g)},function(e){var g={text:a,type:"error"};Settings_Vtiger_Index_Js.showMessage(g)})},function(d,e){})},updateSequenceRelatedModule:function(){var b=this;var a=[];var d=jQuery(".relatedModulesList");var e={};var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});d.find(".relatedModule").each(function(g,h){var f=jQuery(h).data("relationId");a.push({relationId:f,index:g})});e.module=app.getModuleName();e.parent=app.getParentModuleName();e.action="Relation";e.mode="updateSequenceRelatedModule";e.modules=a;AppConnector.request(e).then(function(f){c.progressIndicator({mode:"hide"});var g={};g.text=app.vtranslate("JS_UPDATE_SEQUENCE");Settings_Vtiger_Index_Js.showMessage(g)},function(f){c.progressIndicator({mode:"hide"});var g={};g.text=f;Settings_Vtiger_Index_Js.showMessage(g)})},updateSelectedFields:function(e){var c=this;var f={};var b=jQuery(e).closest(".relatedModule");var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});if(jQuery(e).data("type")=="inventory"){f.inventory=true;var a=jQuery(e).val()}else{var a=c.getSelectedFields(jQuery(e))}f.module=app.getModuleName();f.parent=app.getParentModuleName();f.action="Relation";f.mode="updateSelectedFields";f.relationId=b.data("relation-id");f.fields=a;AppConnector.request(f).then(function(g){d.progressIndicator({mode:"hide"});var h={};h.text=app.vtranslate("JS_UPDATED_FIELD_LIST_MODULE_RELATED");Settings_Vtiger_Index_Js.showMessage(h)},function(g){d.progressIndicator({mode:"hide"});var h={};h.text=g;Settings_Vtiger_Index_Js.showMessage(h)})},makeFieldsListSortable:function(){var c=this;var b=jQuery("#layoutEditorContainer").find(".contents");var a=b.find(".editFieldsTable");a.each(function(){var d=jQuery(this).closest(".moduleBlocks");jQuery(this).find("ul[name=sortable1], ul[name=sortable2]").sortable({containment:d,revert:true,tolerance:"pointer",cursor:"move",connectWith:d.find(".connectedSortable"),update:function(i,h){var g=h.item;if(g.closest(".moduleBlocks").hasClass("inventoryBlock")){c.showSaveFieldSequenceButton(g.closest(".editFieldsTable"))}else{c.showSaveFieldSequenceButton(c.getDetailViewLayout());c.createUpdatedBlocksList(g);if(h.sender){var f=h.sender.closest(".editFieldsTable");c.reArrangeBlockFields(f)}}}})})},getDetailViewLayout:function(){return jQuery("#detailViewLayout")},getInventoryViewLayout:function(){return jQuery("#inventoryViewLayout")},showSaveFieldSequenceButton:function(b){var a=this;var c=b.find(".saveFieldSequence");if(app.isHidden(c)||app.isInvisible(c)){if(!c.hasClass("inventorySequence")){a.updatedBlocksList=[];a.updatedBlockFieldsList=[]}c.removeClass("d-none");c.removeClass("invisible");var d={};d.text=app.vtranslate("JS_SAVE_THE_CHANGES_TO_UPDATE_FIELD_SEQUENCE");Settings_Vtiger_Index_Js.showMessage(d)}},hideSaveFieldSequenceButton:function(){var a=jQuery("#detailViewLayout");var b=a.find(".saveFieldSequence");b.addClass("d-none")},createUpdatedBlocksList:function(c){var b=this;var d=c.closest(".editFieldsTable");var a=d.data("blockId");if(jQuery.inArray(a,b.updatedBlocksList)==-1){b.updatedBlocksList.push(a)}b.reArrangeBlockFields(d)},reArrangeBlockFields:function(e){var a=e.find("ul[name=sortable1]");var c=e.find("ul[name=sortable2]");if(a.children().length<c.children().length){var b=c.children(":last");a.append(b)}else{if(a.children().length>c.children().length+1){var d=a.children(":last");c.append(d)}}},createUpdatedBlockFieldsList:function(){var h=this;var b=jQuery("#layoutEditorContainer").find(".contents");for(var e in h.updatedBlocksList){var d=h.updatedBlocksList[e];var k=b.find(".block_"+d);var g=k.find("ul[name=sortable1]");var c=g.find(".editFields");var f=1;c.each(function(n,o){var m=jQuery(o);var l=m.data("fieldId");h.updatedBlockFieldsList.push({fieldid:l,sequence:f,block:d});f=f+2});var a=k.find("ul[name=sortable2]");var i=a.find(".editFields");var j=2;i.each(function(n,o){var m=jQuery(o);var l=m.data("fieldId");h.updatedBlockFieldsList.push({fieldid:l,sequence:j,block:d});j=j+2})}},registerFieldSequenceSaveClick:function(){var b=this;var a=jQuery("#detailViewLayout");a.on("click",".saveFieldSequence",function(){b.hideSaveFieldSequenceButton();b.createUpdatedBlockFieldsList();b.updateFieldSequence()})},updateFieldSequence:function(){var a=this;var b=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var c={};c.module=app.getModuleName();c.parent=app.getParentModuleName();c.action="Field";c.mode="move";c.updatedFields=a.updatedBlockFieldsList;AppConnector.request(c).then(function(d){b.progressIndicator({mode:"hide"});window.location.reload();var e={};e.text=app.vtranslate("JS_FIELD_SEQUENCE_UPDATED");Settings_Vtiger_Index_Js.showMessage(e)},function(d){b.progressIndicator({mode:"hide"})})},registerAddCustomFieldEvent:function(){var b=this;var a=jQuery("#layoutEditorContainer").find(".contents");a.find(".addCustomField").click(function(f){var c=jQuery(f.currentTarget).closest(".editFieldsTable").data("blockId");var g=a.find(".createFieldModal").clone(true,true);g.removeClass("d-none").show();var d=function(h){app.showSelect2ElementView(h.find("select"),{width:"100%"});var e=h.find(".createCustomFieldForm");e.attr("id","createFieldForm");var j={tags:[],tokenSeparators:[","]};app.showSelect2ElementView(e.find('[name="pickListValues"]'),j);b.registerFieldTypeChangeEvent(e);b.registerTableTypeChangeEvent(e);b.registerMultiReferenceFieldsChangeEvent(e);b.registerMultiReferenceFilterFieldChangeEvent(e);var i=app.getvalidationEngineOptions(true);i.onValidationComplete=function(m,l){if(l){var p=jQuery('[name="fieldType"]',m).val();var o=jQuery('[name="fieldName"]',m).val();if(p=="Picklist"||p=="MultiSelectCombo"){var r=jQuery("#picklistUi",m);var t=r.val();var z=t.length;var n=/["]/;if(o.toLowerCase()==="status"||"picklist"===o.toLowerCase()){var A=app.vtranslate("JS_RESERVED_PICKLIST_NAME");jQuery('[name="fieldName"]',m).validationEngine("showPrompt",A,"error","bottomLeft",true);return false}for(var s=0;s<t.length;s++){if(n.test(t[s])){var v=app.getSelect2ElementFromSelect(r);var A=app.vtranslate("JS_SPECIAL_CHARACTERS")+' " '+app.vtranslate("JS_NOT_ALLOWED");v.validationEngine("showPrompt",A,"error","bottomLeft",true);return false}}var q=jQuery.map(t,function(C,B){return C.toLowerCase()});var y=jQuery.unique(q);var x=y.length;var w=z-x;if(w>0){var v=app.getSelect2ElementFromSelect(r);var A=app.vtranslate("JS_DUPLICATES_VALUES_FOUND");v.validationEngine("showPrompt",A,"error","bottomLeft",true);return false}}if(p=="Tree"||p=="CategoryMultipicklist"){var k=m.find("select.TreeList");if(k.val()=="-"){var A=app.vtranslate("JS_FIELD_CAN_NOT_BE_EMPTY");m.find(".TreeList").validationEngine("showPrompt",A,"error","bottomLeft",true);return false}}var u=m.find(":submit");u.attr("disabled","disabled");b.addCustomField(c,m).then(function(D){var B=D.result;var E={};if(D.success){app.hideModalWindow();E.text=app.vtranslate("JS_CUSTOM_FIELD_ADDED");Settings_Vtiger_Index_Js.showMessage(E);b.showCustomField(B)}else{var C=D.error["message"];Vtiger_Helper_Js.showPnotify({title:D.error["code"]!=513?m.find(".fieldNameForm").text():m.find(".fieldLabelForm").text(),type:"error",text:D.error["message"]});u.removeAttr("disabled")}})}return false};e.validationEngine(i)};app.showModalWindow(g,function(e){if(typeof d=="function"){d(e)}},{width:"1000px"})})},setBlocksListArray:function(c){var b=this;b.blockNamesList=[];var a=c.find('[name="beforeBlockId"]');a.find("option").each(function(e,g){var f=jQuery(g);var d=f.data("label");b.blockNamesList.push(d)})},addCustomField:function(c,e){var d=this;var a=e.closest("#globalmodal").find(".modal-header h3");var b=jQuery.Deferred();a.progressIndicator({smallLoadingImage:true,imageContainerCss:{display:"inline","margin-left":"18%",position:"absolute"}});var f=e.serializeFormData();f.module=app.getModuleName();f.parent=app.getParentModuleName();f.action="Field";f.mode="add";f.blockid=c;f.sourceModule=jQuery("#selectedModuleName").val();AppConnector.request(f).then(function(g){a.progressIndicator({mode:"hide"});b.resolve(g)},function(g){a.progressIndicator({mode:"hide"});b.reject(g)});return b.promise()},registerTableTypeChangeEvent:function(a){a.find('[name="fieldTypeList"]').on("change",function(c){var b=jQuery(c.currentTarget);a.find('[name="fieldName"]').closest(".form-group").toggleClass("d-none")})},registerFieldTypeChangeEvent:function(f){var e=this;var b=f.find('[name="fieldLength"]');var d=[{name:"DecimalMaxLength"}];var a=[{name:"MaxLength"}];var c=[{name:"FloatingDigits"}];b.data("validator",a);f.find('[name="fieldType"]').on("change",function(n){var i=jQuery(n.currentTarget);var o=f.find('[name="fieldLength"]');var l=i.find("option:selected");f.find(".supportedType").addClass("d-none");if(l.data("lengthsupported")){f.find(".lengthsupported").removeClass("d-none");o.data("validator",a)}if(l.data("decimalsupported")){var k=f.find(".decimalsupported");k.removeClass("d-none");var g=k.find('[name="decimal"]');var j=l.data("maxfloatingdigits");if(typeof j!="undefined"){g.data("validator",c);o.data("validator",d)}if(l.data("decimalreadonly")){g.val(j).attr("readonly",true)}else{g.removeAttr("readonly").val("")}}if(l.data("predefinedvalueexists")){var h=f.find(".preDefinedValueExists");h.removeClass("d-none")}if(l.data("picklistoption")){var m=f.find(".picklistOption");m.removeClass("d-none")}if(l.val()=="Related1M"){f.find(".preDefinedModuleList").removeClass("d-none")}if(l.val()=="Tree"||l.val()=="CategoryMultipicklist"){f.find(".preDefinedTreeList").removeClass("d-none")}if(l.val()=="MultiReferenceValue"){f.find(".preMultiReferenceValue").removeClass("d-none");e.loadMultiReferenceFields(f)}})},showCustomField:function(k){var i=this;var c=jQuery("#layoutEditorContainer").find(".contents");var h=c.find(".block_"+k.blockid);var j=c.find(".newCustomFieldCopy").clone(true,true);var g=j.find("div.marginLeftZero.border1px");g.addClass("opacity editFields").attr("data-field-id",k.id).attr("data-block-id",k.blockid);g.find(".deleteCustomField, .saveFieldDetails").attr("data-field-id",k.id);g.find(".fieldLabel").html(k.label+" ["+k.name+"]");g.find("#relatedFieldValue").val(k.name).prop("id","relatedFieldValue"+k.id);g.find(".copyFieldLabel").attr("data-target","relatedFieldValue"+k.id);i.registerCopyClipboard(g);if(!k.customField){g.find(".deleteCustomField").remove()}if(jQuery.inArray(k.type,["string","phone","currency","url","integer","double"])==-1){g.find(".maskField").remove()}var e=h.find(".blockFieldsList");var f=e.find("ul[name=sortable1]");var b=f.children().length;var d=e.find("ul[name=sortable2]");var a=d.children().length;if(b>a){d.append(j.removeClass("d-none newCustomFieldCopy"))}else{f.append(j.removeClass("d-none newCustomFieldCopy"))}i.makeFieldsListSortable()},registerAddCustomBlockEvent:function(){var b=this;var a=jQuery("#layoutEditorContainer").find(".contents");a.find(".addCustomBlock").click(function(f){var d=a.find(".addBlockModal").clone(true,true);var c=function(h){h.find(".addBlockModal").removeClass("d-none").show();app.showSelect2ElementView(h.find("select"));var g=h.find(".addCustomBlockForm");b.setBlocksListArray(g);var e=g.find('[name="label"]');var i=app.validationEngineOptions;i.onValidationComplete=function(l,k){if(k){var m=l.serializeFormData();if(jQuery.inArray(m.label,b.blockNamesList)==-1){b.saveBlockDetails(l).then(function(o){var p={};if(o.success){var n=o.result;b.displayNewCustomBlock(n);b.updateNewSequenceForBlocks(n.sequenceList);b.appendNewBlockToBlocksList(n,l);b.makeFieldsListSortable();p.text=app.vtranslate("JS_CUSTOM_BLOCK_ADDED")}else{p.text=o.error["message"];p.type="error"}Settings_Vtiger_Index_Js.showMessage(p)});app.hideModalWindow();return k}else{var j=app.vtranslate("JS_BLOCK_NAME_EXISTS");e.validationEngine("showPrompt",j,"error","topLeft",true);f.preventDefault();return}}};g.validationEngine(i);g.submit(function(j){j.preventDefault()})};app.showModalWindow(d,function(e){if(typeof c=="function"){c(e)}},{width:"1000px"})})},saveBlockDetails:function(c){var b=this;var a=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var e=c.serializeFormData();e.module=app.getModuleName();e.parent=app.getParentModuleName();e.sourceModule=jQuery("#selectedModuleName").val();e.action="Block";e.mode="save";AppConnector.request(e).then(function(f){d.progressIndicator({mode:"hide"});a.resolve(f)},function(f){d.progressIndicator({mode:"hide"});a.reject(f)});return a.promise()},displayNewCustomBlock:function(a){var e=this;var d=jQuery("#layoutEditorContainer").find(".contents");var b=a.beforeBlockId;var f=d.find(".block_"+b);var c=d.find(".newCustomBlockCopy").clone(true,true);c.data("blockId",a.id).find(".blockLabel").append(jQuery("<strong>"+a.label+"</strong>"));c.find(".blockVisibility").data("blockId",a.id);if(a.isAddCustomFieldEnabled){c.find(".addCustomField").removeClass("d-none")}f.after(c.removeClass("d-none newCustomBlockCopy").addClass("editFieldsTable block_"+a.id));c.find(".blockFieldsList").sortable({connectWith:".blockFieldsList"})},updateNewSequenceForBlocks:function(a){var b=jQuery("#layoutEditorContainer").find(".contents");jQuery.each(a,function(c,d){b.find(".block_"+c).data("sequence",d)})},appendNewBlockToBlocksList:function(a,e){var d=jQuery("#layoutEditorContainer").find(".contents");var f=d.find(".addBlockModal");var b=f.find('[name="beforeBlockId"]');var c=jQuery("<option>",{value:a.id,text:a.label});b.append(c.attr("data-label",a.label))},removeBlockFromBlocksList:function(b){var c=jQuery("#layoutEditorContainer").find(".contents");var d=c.find(".addBlockModal");var a=d.find('[name="beforeBlockId"]');a.find('option[value="'+b+'"]').remove()},registerBlockVisibilityEvent:function(){var b=this;var a=jQuery("#layoutEditorContainer").find(".contents");a.on("click","li.blockVisibility",function(f){var d=jQuery(f.currentTarget);var c=d.data("visible");if(c=="0"){d.find(".fa-check").removeClass("d-none");d.data("visible","1")}else{d.find(".fa-check").addClass("d-none");d.data("visible","0")}b.updateBlockStatus(d)})},updateBlockStatus:function(c){var a=this;var e=c.data("visible");var b=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d={};d.module=app.getModuleName();d.parent=app.getParentModuleName();d.sourceModule=jQuery("#selectedModuleName").val();d.action="Block";d.mode="save";d.blockid=c.data("blockId");d.display_status=e;AppConnector.request(d).then(function(f){b.progressIndicator({mode:"hide"});var g={};if(e=="1"){g.text=app.vtranslate("JS_BLOCK_VISIBILITY_SHOW")}else{g.text=app.vtranslate("JS_BLOCK_VISIBILITY_HIDE")}Settings_Vtiger_Index_Js.showMessage(g)},function(f){b.progressIndicator({mode:"hide"})})},registerInactiveFieldsEvent:function(){var b=this;var a=jQuery("#layoutEditorContainer").find(".contents");a.on("click","li.inActiveFields",function(i){var h=jQuery(i.currentTarget);var g=h.closest(".editFieldsTable");var d=g.data("blockId");if(jQuery.isEmptyObject(b.inActiveFieldsList[d])){var j={};j.text=app.vtranslate("JS_NO_HIDDEN_FIELDS_EXISTS");j.type="error";Settings_Vtiger_Index_Js.showMessage(j)}else{var c=a.find(".inactiveFieldsModal").clone(true,true);var f=function(k){k.find(".inactiveFieldsModal").removeClass("d-none").show();b.reactiveFieldsList=[];var e=k.find(".inactiveFieldsForm");b.showHiddenFields(d,e);e.submit(function(l){b.createReactivateFieldslist(d,e);b.reActivateHiddenFields(g);app.hideModalWindow();l.preventDefault()})};app.showModalWindow(c,function(e){if(typeof f=="function"){f(e)}},{width:"1000px"})}})},showHiddenFields:function(a,c){var b=this;jQuery.each(b.inActiveFieldsList[a],function(e,f){var d=jQuery('<div class="col-md-4 marginLeftZero padding-bottom1per checkbox"><label class="">\n									<input type="checkbox" class="inActiveField" value="'+e+'" />&nbsp;'+f+"</label></div>");c.find(".inActiveList").append(d)})},createReactivateFieldslist:function(a,c){var b=this;c.find(".inActiveField").each(function(e,g){var f=jQuery(g);var d=f.val();if(f.is(":checked")){delete b.inActiveFieldsList[a][d];b.reactiveFieldsList.push(d)}})},reActivateHiddenFields:function(b){var a=this;var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d={};d.module=app.getModuleName();d.parent=app.getParentModuleName();d.action="Field";d.mode="unHide";d.blockId=b.data("blockId");d.fieldIdList=JSON.stringify(a.reactiveFieldsList);AppConnector.request(d).then(function(f){for(var e in f.result){a.showCustomField(f.result[e])}c.progressIndicator({mode:"hide"});var g={};g.text=app.vtranslate("JS_SELECTED_FIELDS_REACTIVATED");Settings_Vtiger_Index_Js.showMessage(g)},function(e){c.progressIndicator({mode:"hide"})})},registerDeleteCustomBlockEvent:function(){var c=this;var b=jQuery("#layoutEditorContainer").find(".contents");var a=b.find(".editFieldsTable");b.on("click","li.deleteCustomBlock",function(i){var h=jQuery(i.currentTarget);var g=h.closest("div.editFieldsTable");var d=g.data("blockId");var f=app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE");Vtiger_Helper_Js.showConfirmationBox({message:f}).then(function(j){c.deleteCustomBlock(d)},function(e,j){})})},deleteCustomBlock:function(a){var b=this;var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d={};d.module=app.getModuleName();d.parent=app.getParentModuleName();d.action="Block";d.mode="delete";d.blockid=a;AppConnector.request(d).then(function(e){c.progressIndicator({mode:"hide"});var f={};if(e.success){b.removeDeletedBlock(a);b.removeBlockFromBlocksList(a);f.text=app.vtranslate("JS_CUSTOM_BLOCK_DELETED")}else{f.text=e.error["message"];f.type="error"}Settings_Vtiger_Index_Js.showMessage(f)},function(e){c.progressIndicator({mode:"hide"})})},removeDeletedBlock:function(a){var b=jQuery("#layoutEditorContainer").find(".contents");var c=b.find(".block_"+a);c.fadeOut("slow").remove()},registerDeleteCustomFieldEvent:function(b){var a=this;if(typeof b=="undefined"){b=jQuery("#layoutEditorContainer").find(".contents")}b.find(".deleteCustomField").click(function(g){var f=jQuery(g.currentTarget);var c=f.data("fieldId");var d=app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE");Vtiger_Helper_Js.showConfirmationBox({message:d}).then(function(h){a.deleteCustomField(c).then(function(i){var j=f.closest("div.editFields");var e=j.data("blockId");j.parent().fadeOut("slow").remove();var l=jQuery("#block_"+e);a.reArrangeBlockFields(l);var k={};k.text=app.vtranslate("JS_CUSTOM_FIELD_DELETED");Settings_Vtiger_Index_Js.showMessage(k)},function(e,i){})},function(e,h){})})},deleteCustomField:function(b){var c=this;var a=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var e={};e.module=app.getModuleName();e.parent=app.getParentModuleName();e.action="Field";e.mode="delete";e.fieldid=b;AppConnector.request(e).then(function(f){d.progressIndicator({mode:"hide"});a.resolve(f)},function(f){d.progressIndicator({mode:"hide"});a.reject()});return a.promise()},registerFieldDetailsChange:function(a){a.find('[name="mandatory"]').on("change",function(g){var f=jQuery(g.currentTarget);if(f.attr("readonly")!=="readonly"){var d=f.closest(".fieldDetailsForm");var c=d.find('[name="quickcreate"]').filter(":checkbox").not(".optionDisabled");var b=d.find('[name="presence"]').filter(":checkbox").not(".optionDisabled");if(f.is(":checked")){c.attr("checked",true).attr("readonly","readonly");b.attr("checked",true).attr("readonly","readonly")}else{c.removeAttr("readonly");b.removeAttr("readonly")}}});a.find('[name="defaultvalue"]').on("change",function(f){var d=jQuery(f.currentTarget);var c=d.closest(".checkbox").find(".defaultValueUi");var b=c.find('[name="fieldDefaultValue"]');if(d.is(":checked")){c.removeClass("zeroOpacity");b.removeAttr("disabled");if(b.is("select")){b.trigger("chosen:updated")}}else{b.attr("disabled","disabled");c.addClass("zeroOpacity")}})},relatedModulesTabClickEvent:function(){var c=this;var b=jQuery("#layoutEditorContainer").find(".contents");var a=b.find("#relatedTabOrder");var d=b.find(".relatedListTab");d.click(function(){if(a.find(".relatedTabModulesList").length>0){}else{c.showRelatedTabModulesList(a)}})},showRelatedTabModulesList:function(a){var b=this;var c={};c.module=app.getModuleName();c.parent=app.getParentModuleName();c.sourceModule=jQuery("#selectedModuleName").val();c.view="Index";c.mode="showRelatedListLayout";AppConnector.request(c).then(function(d){a.html(d);if(jQuery(d).find(".relatedListContainer").length>0){b.makeRelatedModuleSortable();b.registerRelatedListEvents()}},function(d){})},getModuleLayoutEditor:function(b){var c=this;var a=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var e={};e.module=app.getModuleName();e.parent=app.getParentModuleName();e.view="Index";e.sourceModule=b;AppConnector.requestPjax(e).then(function(f){d.progressIndicator({mode:"hide"});a.resolve(f)},function(f){d.progressIndicator({mode:"hide"});a.reject()});return a.promise()},getRelModuleLayoutEditor:function(b){var c=this;var a=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var e={};e.module=app.getModuleName();e.parent=app.getParentModuleName();e.view="Index";e.mode="showRelatedListLayout";e.sourceModule=b;AppConnector.requestPjax(e).then(function(f){d.progressIndicator({mode:"hide"});a.resolve(f)},function(f){d.progressIndicator({mode:"hide"});a.reject()});return a.promise()},registerModulesChangeEvent:function(){var b=this;var a=jQuery("#layoutEditorContainer");var c=a.closest(".contentsDiv");app.showSelect2ElementView(a.find('[name="layoutEditorModules"]'));a.on("change",'[name="layoutEditorModules"]',function(g){var f=jQuery(g.currentTarget);var d=f.val();b.getModuleLayoutEditor(d).then(function(e){c.html(e);b.registerEvents()})})},registerRelModulesChangeEvent:function(){var b=this;var a=jQuery("#layoutEditorContainer");var c=a.closest(".contentsDiv");app.showSelect2ElementView(a.find('[name="layoutEditorRelModules"]'));a.on("change",'[name="layoutEditorRelModules"]',function(g){var f=jQuery(g.currentTarget);var d=f.val();b.getRelModuleLayoutEditor(d).then(function(e){c.html(e);b.registerEvents()})})},lockCheckbox:function(a){a.on("change",":checkbox",function(d){var c=$(d.currentTarget);if(c.attr("readonly")==="readonly"){var b=$(d.currentTarget).is(":checked");if(!b){$(d.currentTarget).prop("checked",true)}else{$(d.currentTarget).prop("checked",false)}d.preventDefault()}})},registerEditFieldDetailsClick:function(b){var a=this;if(typeof b==="undefined"){b=jQuery("#layoutEditorContainer").find(".contents")}b.find(".editFieldDetails").click(function(h){var g=jQuery(h.currentTarget);var f=g.closest("div.editFields");var d=f.data("fieldId");var i=f.closest(".editFieldsTable");var c=i.data("blockId");app.showModalWindow({url:"index.php?parent=Settings&module=LayoutEditor&view=EditField&fieldId="+f.data("fieldId"),cb:function(e){a.registerFieldDetailsChange(e);a.lockCheckbox(e);a.registerVaribleToParsers(e);app.registerEventForClockPicker(e.find(".clockPicker"))},sendByAjaxCb:function(l,j){Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_FIELD_DETAILS_SAVED")});var e=j.result;var k=f.find(".fieldLabel");if(e.presence==="1"){f.parent().fadeOut("slow").remove();if(jQuery.isEmptyObject(a.inActiveFieldsList[c])){if(a.inActiveFieldsList.length===0){a.inActiveFieldsList={}}a.inActiveFieldsList[c]={};a.inActiveFieldsList[c][d]=e.label}else{a.inActiveFieldsList[c][d]=e.label}a.reArrangeBlockFields(i)}if(e.mandatory){if(k.find(".redColor").length===0){f.find(".fieldLabel").append(jQuery('<span class="redColor">*</span>'))}}else{f.find(".fieldLabel").find(".redColor").remove()}}})})},registerVaribleToParsers:function(a){var b=this;a.find(".configButton").on("click",function(c){a.find(".defaultValueUi .input-group").each(function(g,f){var d=$(f);if(d.hasClass("d-none")){d.find("input,select").prop("disabled",false)}else{d.find("input,select").prop("disabled",true)}d.toggleClass("d-none")})});a.find(".varibleToParsers").on("click",function(f){var d=$(f.currentTarget).closest(".input-group").find('[name="fieldDefaultValue"]');var c=a.find('[name="fieldid"]').val();var g="varibleToParsersModal";app.showModalWindow({id:g,url:"index.php?parent=Settings&module=LayoutEditor&view=VaribleToParsers&fieldId="+c+"&defaultValue="+d.val(),cb:function(h){var e=h.find("select");h.find('[name="saveButton"]').on("click",function(){d.val(e.val());app.hideModalWindow(null,g)})}})})},registerBlockEvents:function(){var a=this;a.makeBlocksListSortable();a.registerAddCustomFieldEvent();a.registerBlockVisibilityEvent();a.registerInactiveFieldsEvent();a.registerDeleteCustomBlockEvent()},registerFieldEvents:function(b){var a=this;if(typeof b=="undefined"){b=jQuery("#layoutEditorContainer").find(".contents")}app.registerEventForDatePickerFields(b);app.registerEventForClockPicker(b);app.changeSelectElementView(b);a.makeFieldsListSortable();a.registerDeleteCustomFieldEvent(b);a.registerEditFieldDetailsClick(b);b.find(":checkbox").change(function(f){var d=jQuery(f.currentTarget);if(d.attr("readonly")=="readonly"){var c=jQuery(f.currentTarget).is(":checked");if(!c){jQuery(f.currentTarget).prop("checked",true)}else{jQuery(f.currentTarget).prop("checked",false)}f.preventDefault()}})},registerSwitch:function(){var a=jQuery("#layoutEditorContainer");app.showBtnSwitch(a.find(".switchBtn"));var b=a.find(".inventoryNav");a.find("#inventorySwitch").on("switchChange.bootstrapSwitch",function(e,f){var c=jQuery(e.currentTarget);var d=app.vtranslate("JS_EXTENDED_MODULE");Vtiger_Helper_Js.showConfirmationBox({message:'<span class="message-medium">'+d+"</span>",className:"test"}).then(function(h){var g=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:true}});var i={};i.module=a.find('[name="layoutEditorModules"]').val();i.status=f?0:1;app.saveAjax("setInventory",i).then(function(j){if(j.result){window.location.reload()}})},function(g,h){c.bootstrapSwitch("toggleState",true)})})},registerAddInventoryField:function(){var b=this;var a=b.getInventoryViewLayout();a.find(".addInventoryField").click(function(h){var g=jQuery(h.currentTarget);var f=jQuery("#layoutEditorContainer").find('[name="layoutEditorModules"]').val();var c=g.closest(".inventoryBlock").data("block-id");var d=jQuery.progressIndicator();app.showModalWindow(null,"index.php?module=LayoutEditor&parent=Settings&view=CreateInventoryFields&mode=step1&type="+f+"&block="+c,function(e){app.showScrollBar(e.find(".well"),{height:"300px"});b.registerStep1(e,c);d.progressIndicator({mode:"hide"})})})},registerEditInventoryField:function(){var b=this;var a=b.getInventoryViewLayout();a.find(".editInventoryField").on("click",function(j){var i=jQuery(j.currentTarget);var g=jQuery("#layoutEditorContainer").find('[name="layoutEditorModules"]').val();var c=i.closest(".inventoryBlock").data("block-id");var f=i.closest(".editFields");var h=f.data("name");var k=f.data("id");var d=jQuery.progressIndicator();app.showModalWindow(null,"index.php?module=LayoutEditor&parent=Settings&view=CreateInventoryFields&mode=step2&type="+g+"&mtype="+h+"&id="+k,function(e){app.showPopoverElementView(e.find(".js-help-info"));b.registerStep2(e,c);d.progressIndicator({mode:"hide"})})})},registerStep1:function(a,b){var c=this;a.find(".nextButton").click(function(h){var f=jQuery("#layoutEditorContainer").find('[name="layoutEditorModules"]').val();var g=a.find("select.type").val();app.hideModalWindow();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});app.showModalWindow(null,"index.php?module=LayoutEditor&parent=Settings&view=CreateInventoryFields&mode=step2&type="+f+"&mtype="+g,function(e){c.registerStep2(e,b);d.progressIndicator({mode:"hide"})})})},registerStep2:function(a,b){var f=this;var c=f.getInventoryViewLayout();var e=a.find("form");var d=jQuery("#layoutEditorContainer").find('[name="layoutEditorModules"]').val();e.validationEngine(app.validationEngineOptions);e.on("submit",function(l){var k=e.serializeFormData();var h=f.getParamsInventory();if(h){var n={};for(var g in k){if(jQuery.inArray(g,h)!=-1){var j=k[g];if(g==="modules"&&typeof j==="string"){j=[j]}n[g]=j;delete k[g]}}k.params=JSON.stringify(n)}var m=e.validationEngine("validate");if(m!=false){k.block=b;k.module=d;app.saveAjax("saveInventoryField",k).then(function(p){var i=p.result;if(i&&i.edit){app.hideModalWindow();var q=c.find('[data-id="'+i.data.id+'"]');q.find(".fieldLabel").text(i.data.translate)}else{if(i){app.hideModalWindow();var o=c.find(".newLiElement").clone(true,true);o.removeClass("d-none newLiElement").find(".editFields").attr("data-id",i.data.id).attr("data-sequence",i.data.sequence).attr("data-name",i.data.invtype).attr("data-column",i.data.columnname).find(".fieldLabel").text(i.data.translate);c.find('[data-block-id="'+i.data.block+'"] .connectedSortable').append(o)}}})}});a.find("form").submit(function(g){g.preventDefault()})},registerInventoryFieldSequenceSaveClick:function(){var c=this;var a=c.getInventoryViewLayout();var b=jQuery("#layoutEditorContainer").find('[name="layoutEditorModules"]').val();a.on("click",".saveFieldSequence",function(h){var f=jQuery(h.currentTarget);var g=f.closest(".inventoryBlock");var i={};var d=[];g.find(".editFields").each(function(){d.push(jQuery(this).data("id"))});i.module=b;i.ids=d;app.saveAjax("saveSequence",i).then(function(e){f.addClass("invisible")})})},registerDeleteInventoryField:function(){var c=this;var a=c.getInventoryViewLayout();var b=jQuery("#layoutEditorContainer").find('[name="layoutEditorModules"]').val();a.find(".deleteInventoryField").on("click",function(g){var f=jQuery(g.currentTarget);var h=f.closest("li");var d=app.vtranslate("JS_DELETE_INVENTORY_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:d}).then(function(k){var j=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:true}});var i=h.find(".editFields");var l={};l.id=i.data("id");l.module=b;l.name=i.data("name");l.column=i.data("column");app.saveAjax("delete",l).then(function(e){h.remove();Settings_Vtiger_Index_Js.showMessage({type:"success",text:app.vtranslate("JS_SAVE_CHANGES")});j.progressIndicator({mode:"hide"})})},function(e,i){})})},getParamsInventory:function(){if(typeof app.getMainParams("params")!="undefined"){return JSON.parse(app.getMainParams("params"))}},loadMultiReferenceFields:function(c){var b=this;var a=c.find('[name="MRVModule"]').val();c.find('[name="MRVField"],[name="MRVFilterField"]').select2("destroy");c.find('[name="MRVField"]').html(b.cacheMRVField.html());c.find('[name="MRVField"] optgroup').each(function(d){if($(this).data("module")!=a){$(this).remove()}});c.find('[name="MRVFilterField"]').html(b.cacheMRVFilter.html());c.find('[name="MRVFilterField"] option').each(function(d){if($(this).data("module")!=a){$(this).remove()}});app.showSelect2ElementView(c.find('[name="MRVField"],[name="MRVFilterField"]'),{width:"100%"})},cacheMRVField:false,cacheMRVFilter:false,registerMultiReferenceFieldsChangeEvent:function(b){var a=this;a.cacheMRVField=b.find('[name="MRVField"]').clone(true,true);a.cacheMRVFilter=b.find('[name="MRVFilterField"]').clone(true,true);b.find('[name="MRVModule"]').on("change",function(c){a.loadMultiReferenceFields(b)})},registerMultiReferenceFilterFieldChangeEvent:function(b){var a=this;b.find('[name="MRVFilterField"]').on("change",function(c){var d={};d.module=app.getModuleName();d.parent=app.getParentModuleName();d.action="Field";d.mode="getPicklist";d.rfield=b.find('[name="MRVFilterField"]').val();d.rmodule=b.find('[name="MRVModule"]').val();b.find('[name="MRVFilterValue"]').select2("destroy");b.find('[name="MRVFilterValue"] option').remove();AppConnector.request(d).then(function(e){$.each(e.result,function(f,g){b.find('[name="MRVFilterValue"]').append($("<option>").val(f).html(g))});app.showSelect2ElementView(b.find('[name="MRVFilterValue"]'),{width:"100%"})})})},registerCopyClipboard:function(a){new ClipboardJS(".copyFieldLabel",{text:function(b){Vtiger_Helper_Js.showPnotify({text:app.vtranslate("JS_NOTIFY_COPY_TEXT"),type:"success"});return a.find("#"+b.getAttribute("data-target")).val()}})},registerEvents:function(){var b=this;var a=$("#layoutEditorContainer");b.registerBlockEvents();b.registerFieldEvents();b.setInactiveFieldsList();b.registerAddCustomBlockEvent();b.registerFieldSequenceSaveClick();b.relatedModulesTabClickEvent();b.registerModulesChangeEvent();b.registerRelModulesChangeEvent();if(1===jQuery("#relatedTabOrder").length){b.registerRelatedListEvents();b.makeRelatedModuleSortable()}b.registerSwitch();b.registerAddInventoryField();b.registerEditInventoryField();b.registerInventoryFieldSequenceSaveClick();b.registerDeleteInventoryField();b.registerCopyClipboard(a)}});jQuery(document).ready(function(){var a=new Settings_LayoutEditor_Js();a.registerEvents()});Vtiger_WholeNumberGreaterThanZero_Validator_Js("Vtiger_FloatingDigits_Validator_Js",{invokeValidation:function(d,f,c,b){var e=new Vtiger_FloatingDigits_Validator_Js();e.setElement(d);var a=e.validate();if(a!=true){return e.getError()}}},{validate:function(){var b=this._super();if(b!=true){return b}else{var d=this.getFieldValue();if(d<2||d>5){var e=app.vtranslate("JS_PLEASE_ENTER_NUMBER_IN_RANGE_2TO5");this.setError(e);return false}var a=/^[+]/;if(a.test(d)){var c=app.vtranslate("JS_CONTAINS_ILLEGAL_CHARACTERS");this.setError(c);return false}return true}}});Vtiger_WholeNumberGreaterThanZero_Validator_Js("Vtiger_DecimalMaxLength_Validator_Js",{invokeValidation:function(d,f,c,b){var e=new Vtiger_DecimalMaxLength_Validator_Js();e.setElement(d);var a=e.validate();if(a!=true){return e.getError()}}},{validate:function(){var b=this._super();if(b!=true){return b}else{var e=this.getFieldValue();var d=jQuery("#createFieldForm").find('[name="decimal"]').val();var f=parseInt(64)-parseInt(d);if(e>f&&!(f<0)&&f>=59){var g=app.vtranslate("JS_LENGTH_SHOULD_BE_LESS_THAN_EQUAL_TO")+" "+f;this.setError(g);return false}var a=/^[+]/;if(a.test(e)){var c=app.vtranslate("JS_CONTAINS_ILLEGAL_CHARACTERS");this.setError(c);return false}return true}}});Vtiger_WholeNumberGreaterThanZero_Validator_Js("Vtiger_MaxLength_Validator_Js",{invokeValidation:function(d,f,c,b){var e=new Vtiger_DecimalMaxLength_Validator_Js();e.setElement(d);var a=e.validate();if(a!=true){return e.getError()}}},{validate:function(){var b=this._super();if(b!=true){return b}else{var d=this.getFieldValue();if(d>255){var e=app.vtranslate("JS_LENGTH_SHOULD_BE_LESS_THAN_EQUAL_TO")+" 255";this.setError(e);return false}var a=/^[+]/;if(a.test(d)){var c=app.vtranslate("JS_CONTAINS_ILLEGAL_CHARACTERS");this.setError(c);return false}return true}}});Vtiger_Base_Validator_Js("Vtiger_FieldLabel_Validator_Js",{invokeValidation:function(e,f,d,c){var a=new Vtiger_FieldLabel_Validator_Js();a.setElement(e);var b=a.validate();if(b!=true){return a.getError()}}},{validate:function(){var a=this.getFieldValue();return this.validateValue(a)},validateValue:function(b){var a=/[&\<\>\:\'\"\,]/;if(a.test(b)){var c=app.vtranslate("JS_SPECIAL_CHARACTERS")+" & < > ' \" : , "+app.vtranslate("JS_NOT_ALLOWED");this.setError(c);return false}return true}});Vtiger_Base_Validator_Js("Vtiger_PicklistFieldValues_Validator_Js",{invokeValidation:function(e,f,d,c){var a=new Vtiger_PicklistFieldValues_Validator_Js();a.setElement(e);var b=a.validate();if(b!=true){return a.getError()}}},{validate:function(){var a=this.getFieldValue();return this.validateValue(a)},validateValue:function(b){var a=/[<\>\"\,#]/;if(a.test(b)){var c=app.vtranslate("JS_SPECIAL_CHARACTERS")+" < >"+app.vtranslate("JS_NOT_ALLOWED");this.setError(c);return false}return true}});