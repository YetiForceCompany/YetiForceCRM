'use strict';

$.Class('Settings_LayoutEditor_Js',{},{updatedBlockSequence:{},reactiveFieldsList:[],inActiveFieldsList:!1,updatedBlockFieldsList:[],updatedBlocksList:[],blockNamesList:[],setInactiveFieldsList:function setInactiveFieldsList(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents'),json=contents.find('.inActiveFieldsArray');0<json.length&&(thisInstance.inActiveFieldsList=JSON.parse(json.val()));},makeBlocksListSortable:function makeBlocksListSortable(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents'),table=contents.find('.blockSortable');contents.sortable({containment:contents,items:table,revert:!0,tolerance:'pointer',cursor:'move',update:function update(){thisInstance.updateBlockSequence();}});},updateBlockSequence:function updateBlockSequence(){var thisInstance=this,progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),sequence=JSON.stringify(thisInstance.updateBlocksListByOrder()),params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Block',params.mode='updateSequenceNumber',params.sequence=sequence,AppConnector.request(params).done(function(){progressIndicatorElement.progressIndicator({mode:'hide'});var params={};params.text=app.vtranslate('JS_BLOCK_SEQUENCE_UPDATED'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'});});},updateBlocksListByOrder:function updateBlocksListByOrder(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents');return contents.find('.editFieldsTable.blockSortable').each(function(index,domElement){var blockTable=$(domElement),blockId=blockTable.data('blockId'),actualBlockSequence=blockTable.data('sequence'),expectedBlockSequence=index+1;expectedBlockSequence!=actualBlockSequence&&blockTable.data('sequence',expectedBlockSequence),thisInstance.updatedBlockSequence[blockId]=expectedBlockSequence;}),thisInstance.updatedBlockSequence},registerRelatedListEvents:function registerRelatedListEvents(){var thisInstance=this,relatedList=$('#relatedTabOrder');App.Fields.Picklist.showSelect2ElementView(relatedList.find('.relatedTabModulesList .select2_container'),{sortable:!0,sortableCb:function sortableCb(currentTarget){thisInstance.updateSelectedFields(currentTarget);}}),relatedList.on('click','.inActiveRelationModule',function(e){var currentTarget=$(e.currentTarget),relatedModule=currentTarget.closest('.relatedModule');relatedModule.find('.activeRelationModule').removeClass('d-none').show(),currentTarget.hide(),thisInstance.changeStatusRelatedModule(relatedModule.data('relation-id'),!1);}),relatedList.on('click','.activeRelationModule',function(e){var currentTarget=$(e.currentTarget),relatedModule=currentTarget.closest('.relatedModule');relatedModule.find('.inActiveRelationModule').removeClass('d-none').show(),currentTarget.hide(),thisInstance.changeStatusRelatedModule(relatedModule.data('relation-id'),!0);}),relatedList.on('click','.removeRelation',function(e){var currentTarget=$(e.currentTarget),relatedModule=currentTarget.closest('.relatedModule');thisInstance.removeRelation(relatedModule);}),relatedList.on('click','.addToFavorites',function(e){var currentTarget=$(e.currentTarget);thisInstance.changeStateFavorites(currentTarget);}),relatedList.on('change','.relatedViewType',function(){var currentTarget=$(this),value=currentTarget.val();return value?void(currentTarget.validationEngine('hide'),thisInstance.changeRelatedViewType(currentTarget)):(currentTarget.validationEngine('showPrompt',app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')),!1)}),relatedList.find('.js-related-column-list').on('change',function(e){thisInstance.updateSelectedFields($(e.currentTarget));}),relatedList.on('click','.addRelation',function(e){var currentTarget=$(e.currentTarget),container=currentTarget.closest('#relatedTabOrder'),contentsDiv=container.closest('.contentsDiv'),addRelationContainer=relatedList.find('.addRelationContainer').clone(!0,!0),callBackFunction=function(data){App.Fields.Picklist.showSelect2ElementView(data.find('select')),data.find('.relLabel').val(data.find('.target option:selected').val()),data.on('change','.target',function(e){var currentTarget=$(e.currentTarget);data.find('.relLabel').val(currentTarget.find('option:selected').val());}),data.find('[name="type"]').on('change',function(){'getAttachments'===$(this).val()?(data.find('[name="target"] option').not('[value="Documents"]').addClass('d-none'),App.Fields.Picklist.showSelect2ElementView(data.find('[name="target"]'))):(data.find('[name="target"] option').removeClass('d-none'),App.Fields.Picklist.showSelect2ElementView(data.find('[name="target"]')));}),data.on('click','.addButton',function(){var form=data.find('form').serializeFormData(),params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Relation',params.mode='addRelation',$.extend(params,form),AppConnector.request(params).done(function(){thisInstance.getRelModuleLayoutEditor(container.find('[name="layoutEditorRelModules"]').val()).done(function(data){contentsDiv.html(data),thisInstance.registerEvents();});});});};app.showModalWindow(addRelationContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);});});},getSelectedFields:function getSelectedFields(target){var selectedFields=[];return target.find(':selected').each(function(){selectedFields.push({id:$(this).val(),name:$(this).data('field-name')?$(this).data('field-name'):$(this).data('name')});}),selectedFields},makeRelatedModuleSortable:function makeRelatedModuleSortable(){var thisInstance=this,relatedModulesContainer=$('.relatedModulesList'),modulesList=relatedModulesContainer.find('.relatedModule');relatedModulesContainer.sortable({containment:relatedModulesContainer,items:modulesList,handle:'.mainBlockTableLabel',revert:!0,tolerance:'pointer',cursor:'move',update:function update(){thisInstance.updateSequenceRelatedModule();}});},changeRelatedViewType:function changeRelatedViewType(currentTarget){var relatedModule=currentTarget.closest('.relatedModule');AppConnector.request({module:app.getModuleName(),parent:app.getParentModuleName(),action:'Relation',mode:'updateRelatedViewType',relationId:relatedModule.data('relation-id'),types:currentTarget.val()}).done(function(data){data.success?Settings_Vtiger_Index_Js.showMessage({text:data.result.text}):Settings_Vtiger_Index_Js.showMessage({type:'error',text:data.error.message});}).fail(function(error){Settings_Vtiger_Index_Js.showMessage({text:error.message});});},changeStateFavorites:function changeStateFavorites(currentTarget){var relatedModule=currentTarget.closest('.relatedModule'),status=1==currentTarget.data('state')?0:1,params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Relation',params.mode='updateStateFavorites',params.relationId=relatedModule.data('relation-id'),params.status=status,AppConnector.request(params).done(function(){currentTarget.data('state',status),status?(currentTarget.find('.far').addClass('d-none'),currentTarget.find('.fas').removeClass('d-none')):(currentTarget.find('.fas').addClass('d-none'),currentTarget.find('.far').removeClass('d-none')),Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_SAVE_NOTIFY_OK')});}).fail(function(error){var params={};params.text=error,Settings_Vtiger_Index_Js.showMessage(params);});},changeStatusRelatedModule:function changeStatusRelatedModule(relationId,status){var params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Relation',params.mode='changeStatusRelation',params.relationId=relationId,params.status=status,AppConnector.request(params).done(function(){var params={};params.text=status?app.vtranslate('JS_SAVED_CHANGE_STATUS_1'):app.vtranslate('JS_SAVED_CHANGE_STATUS_0'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(error){var params={};params.text=error,params.type='error',Settings_Vtiger_Index_Js.showMessage(params);});},removeRelation:function removeRelation(relatedModule){var message=app.vtranslate('JS_DELETE_RELATION_CONFIRMATION');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){var params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Relation',params.mode='removeRelation',params.relationId=relatedModule.data('relation-id'),AppConnector.request(params).done(function(){var params={};params.text=app.vtranslate('JS_REMOVE_RELATION_OK'),relatedModule.remove(),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(){Settings_Vtiger_Index_Js.showMessage({text:message,type:'error'});});}).fail(function(){});},updateSequenceRelatedModule:function updateSequenceRelatedModule(){var modules=[],relatedModulesContainer=$('.relatedModulesList'),params={},progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}});relatedModulesContainer.find('.relatedModule').each(function(index,domElement){var relationId=$(domElement).data('relationId');modules.push({relationId:relationId,index:index});}),params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Relation',params.mode='updateSequenceRelatedModule',params.modules=modules,AppConnector.request(params).done(function(){progressIndicatorElement.progressIndicator({mode:'hide'});var params={};params.text=app.vtranslate('JS_UPDATE_SEQUENCE'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(error){progressIndicatorElement.progressIndicator({mode:'hide'});var params={};params.text=error,Settings_Vtiger_Index_Js.showMessage(params);});},updateSelectedFields:function updateSelectedFields(target){var thisInstance=this,params={},relatedModule=$(target).closest('.relatedModule'),progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),selectedFields=void 0;'inventory'==$(target).data('type')?(params.inventory=!0,selectedFields=$(target).val()):selectedFields=thisInstance.getSelectedFields($(target)),params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Relation',params.mode='updateSelectedFields',params.relationId=relatedModule.data('relation-id'),params.fields=selectedFields,AppConnector.request(params).done(function(){progressIndicatorElement.progressIndicator({mode:'hide'});var params={};params.text=app.vtranslate('JS_UPDATED_FIELD_LIST_MODULE_RELATED'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(error){progressIndicatorElement.progressIndicator({mode:'hide'});var params={};params.text=error,Settings_Vtiger_Index_Js.showMessage(params);});},makeFieldsListSortable:function makeFieldsListSortable(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents'),table=contents.find('.editFieldsTable');table.each(function(){var containment=$(this).closest('.moduleBlocks');$(this).find('ul[name=sortable1], ul[name=sortable2]').sortable({containment:containment,tolerance:'pointer',cursor:'move',connectWith:containment.find('.connectedSortable'),update:function update(e,ui){var currentField=ui.item;if(currentField.closest('.moduleBlocks').hasClass('inventoryBlock'))thisInstance.showSaveFieldSequenceButton(currentField.closest('.editFieldsTable'));else if(thisInstance.showSaveFieldSequenceButton(thisInstance.getDetailViewLayout()),thisInstance.createUpdatedBlocksList(currentField),ui.sender){var olderBlock=ui.sender.closest('.editFieldsTable');thisInstance.reArrangeBlockFields(olderBlock);}}});});},getDetailViewLayout:function getDetailViewLayout(){return $('#detailViewLayout')},getInventoryViewLayout:function getInventoryViewLayout(){return $('#inventoryViewLayout')},showSaveFieldSequenceButton:function showSaveFieldSequenceButton(layout){var thisInstance=this,saveButton=layout.find('.saveFieldSequence');if(app.isHidden(saveButton)||app.isInvisible(saveButton)){saveButton.hasClass('inventorySequence')||(thisInstance.updatedBlocksList=[],thisInstance.updatedBlockFieldsList=[]),saveButton.removeClass('d-none'),saveButton.removeClass('invisible');var params={};params.text=app.vtranslate('JS_SAVE_THE_CHANGES_TO_UPDATE_FIELD_SEQUENCE'),Settings_Vtiger_Index_Js.showMessage(params);}},hideSaveFieldSequenceButton:function hideSaveFieldSequenceButton(){var layout=$('#detailViewLayout'),saveButton=layout.find('.saveFieldSequence');saveButton.addClass('d-none');},createUpdatedBlocksList:function createUpdatedBlocksList(currentField){var thisInstance=this,block=currentField.closest('.editFieldsTable'),updatedBlockId=block.data('blockId');-1==$.inArray(updatedBlockId,thisInstance.updatedBlocksList)&&thisInstance.updatedBlocksList.push(updatedBlockId),thisInstance.reArrangeBlockFields(block);},reArrangeBlockFields:function reArrangeBlockFields(block){var leftSideContainer=block.find('ul[name=sortable1]'),rightSideContainer=block.find('ul[name=sortable2]');if(leftSideContainer.children().length<rightSideContainer.children().length){var lastElementInRightContainer=rightSideContainer.children(':last');leftSideContainer.append(lastElementInRightContainer);}else if(leftSideContainer.children().length>rightSideContainer.children().length+1){var lastElementInLeftContainer=leftSideContainer.children(':last');rightSideContainer.append(lastElementInLeftContainer);}},createUpdatedBlockFieldsList:function createUpdatedBlockFieldsList(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents');for(var index in thisInstance.updatedBlocksList){var updatedBlockId=thisInstance.updatedBlocksList[index],updatedBlock=contents.find('.block_'+updatedBlockId),firstBlockSortFields=updatedBlock.find('ul[name=sortable1]'),editFields=firstBlockSortFields.find('.editFields'),expectedFieldSequence=1;editFields.each(function(i,domElement){var fieldEle=$(domElement),fieldId=fieldEle.data('fieldId');thisInstance.updatedBlockFieldsList.push({fieldid:fieldId,sequence:expectedFieldSequence,block:updatedBlockId}),expectedFieldSequence+=2;});var secondBlockSortFields=updatedBlock.find('ul[name=sortable2]'),secondEditFields=secondBlockSortFields.find('.editFields'),sequenceValue=2;secondEditFields.each(function(i,domElement){var fieldEle=$(domElement),fieldId=fieldEle.data('fieldId');thisInstance.updatedBlockFieldsList.push({fieldid:fieldId,sequence:sequenceValue,block:updatedBlockId}),sequenceValue+=2;});}},registerFieldSequenceSaveClick:function registerFieldSequenceSaveClick(){var _this=this;$(document).on('click','.saveFieldSequence',function(){_this.hideSaveFieldSequenceButton(),_this.createUpdatedBlockFieldsList(),_this.updateFieldSequence();});},updateFieldSequence:function updateFieldSequence(){var thisInstance=this,progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Field',params.mode='move',params.updatedFields=thisInstance.updatedBlockFieldsList,AppConnector.request(params).done(function(){progressIndicatorElement.progressIndicator({mode:'hide'}),window.location.reload();var params={};params.text=app.vtranslate('JS_FIELD_SEQUENCE_UPDATED'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'});});},registerAddCustomFieldEvent:function registerAddCustomFieldEvent(){var thisInstance=this,container=$('#layoutEditorContainer'),contents=container.find('.contents');contents.find('.addCustomField').on('click',function(e){var blockId=$(e.currentTarget).closest('.editFieldsTable').data('blockId'),addFieldContainer=container.find('.createFieldModal').clone(!0,!0);addFieldContainer.removeClass('d-none').show();var callBackFunction=function(data){App.Fields.Picklist.showSelect2ElementView(data.find('select'),{width:'100%'});var form=data.find('.createCustomFieldForm');form.attr('id','createFieldForm'),App.Fields.Picklist.showSelect2ElementView(form.find('[name="pickListValues"]'),{tags:!0,tokenSeparators:[',']}),thisInstance.registerFieldTypeChangeEvent(form),thisInstance.registerTableTypeChangeEvent(form),thisInstance.registerMultiReferenceFieldsChangeEvent(form),thisInstance.registerMultiReferenceFilterFieldChangeEvent(form);var params=app.getvalidationEngineOptions(!0);params.onValidationComplete=function(form,valid){if(valid){var message,fieldTypeValue=$('[name="fieldType"]',form).val(),fieldNameValue=$('[name="fieldName"]',form).val();if('Picklist'==fieldTypeValue||'MultiSelectCombo'==fieldTypeValue){var i,select2Element,pickListValueElement=$('#pickListValues',form),pickListValuesArray=pickListValueElement.val(),pickListValuesArraySize=pickListValuesArray.length,specialChars=/["]/;if('status'===fieldNameValue.toLowerCase()||'picklist'===fieldNameValue.toLowerCase())return message=app.vtranslate('JS_RESERVED_PICKLIST_NAME'),$('[name="fieldName"]',form).validationEngine('showPrompt',message,'error','bottomLeft',!0),!1;for(i=0;i<pickListValuesArray.length;i++)if(specialChars.test(pickListValuesArray[i]))return select2Element=app.getSelect2ElementFromSelect(pickListValueElement),message=app.vtranslate('JS_SPECIAL_CHARACTERS')+' " '+app.vtranslate('JS_NOT_ALLOWED'),select2Element.validationEngine('showPrompt',message,'error','bottomLeft',!0),!1;var lowerCasedpickListValuesArray=$.map(pickListValuesArray,function(item){return item.toLowerCase()}),uniqueLowerCasedpickListValuesArray=$.uniqueSort(lowerCasedpickListValuesArray),uniqueLowerCasedpickListValuesArraySize=uniqueLowerCasedpickListValuesArray.length;if(0<pickListValuesArraySize-uniqueLowerCasedpickListValuesArraySize)return select2Element=app.getSelect2ElementFromSelect(pickListValueElement),message=app.vtranslate('JS_DUPLICATES_VALUES_FOUND'),select2Element.validationEngine('showPrompt',message,'error','bottomLeft',!0),!1}if('Tree'==fieldTypeValue||'CategoryMultipicklist'==fieldTypeValue){var treeListElement=form.find('select.TreeList');if('-'==treeListElement.val())return message=app.vtranslate('JS_FIELD_CAN_NOT_BE_EMPTY'),form.find('.TreeList').validationEngine('showPrompt',message,'error','bottomLeft',!0),!1}var saveButton=form.find(':submit');saveButton.attr('disabled','disabled'),thisInstance.addCustomField(blockId,form).done(function(data){var result=data.result,params={};data.success?(app.hideModalWindow(),params.text=app.vtranslate('JS_CUSTOM_FIELD_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(result)):(message=data.error.message,Vtiger_Helper_Js.showPnotify({title:513==data.error.code?form.find('.fieldLabelForm').text():form.find('.fieldNameForm').text(),type:'error',text:data.error.message}),saveButton.removeAttr('disabled'));});}return !1},form.validationEngine(params);};app.showModalWindow(addFieldContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);},{width:'1000px'});});},setBlocksListArray:function setBlocksListArray(form){var thisInstance=this;thisInstance.blockNamesList=[];var blocksListSelect=form.find('[name="beforeBlockId"]');blocksListSelect.find('option').each(function(index,ele){var option=$(ele),label=option.data('label');thisInstance.blockNamesList.push(label);});},addCustomField:function addCustomField(blockId,form){var modalHeader=form.closest('#'+Window.lastModalId).find('.modal-header h3'),aDeferred=$.Deferred();modalHeader.progressIndicator({smallLoadingImage:!0,imageContainerCss:{display:'inline',"margin-left":'18%',position:'absolute'}});var params=form.serializeFormData();return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Field',params.mode='add',params.blockid=blockId,params.sourceModule=$('#selectedModuleName').val(),AppConnector.request(params).done(function(data){modalHeader.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(error){modalHeader.progressIndicator({mode:'hide'}),aDeferred.reject(error);}),aDeferred.promise()},registerTableTypeChangeEvent:function registerTableTypeChangeEvent(form){form.find('[name="fieldTypeList"]').on('change',function(){form.find('[name="fieldName"]').closest('.form-group').toggleClass('d-none');});},registerFieldTypeChangeEvent:function registerFieldTypeChangeEvent(form){var thisInstance=this,lengthInput=form.find('[name="fieldLength"]'),lengthValidator=[{name:'DecimalMaxLength'}],maxLengthValidator=[{name:'MaxLength'}],decimalValidator=[{name:'FloatingDigits'}];lengthInput.data('validator',maxLengthValidator),form.find('[name="fieldType"]').on('change',function(e){var currentTarget=$(e.currentTarget),lengthInput=form.find('[name="fieldLength"]'),selectedOption=currentTarget.find('option:selected');if(form.find('.supportedType').addClass('d-none'),selectedOption.data('lengthsupported')&&(form.find('.lengthsupported').removeClass('d-none'),selectedOption.data('nolimitforlength')?lengthInput.data('validator',[{name:'WholeNumberGreaterThanZero'}]):lengthInput.data('validator',maxLengthValidator)),selectedOption.data('decimalsupported')){var decimalFieldUi=form.find('.decimalsupported');decimalFieldUi.removeClass('d-none');var decimalInput=decimalFieldUi.find('[name="decimal"]'),maxFloatingDigits=selectedOption.data('maxfloatingdigits');'undefined'!=typeof maxFloatingDigits&&(decimalInput.data('validator',decimalValidator),lengthInput.data('validator',lengthValidator)),selectedOption.data('decimalreadonly')?decimalInput.val(maxFloatingDigits).attr('readonly',!0):decimalInput.removeAttr('readonly').val('');}if(selectedOption.data('predefinedvalueexists')){var pickListUi=form.find('.preDefinedValueExists');pickListUi.removeClass('d-none');}if(selectedOption.data('picklistoption')){var pickListOption=form.find('.picklistOption');pickListOption.removeClass('d-none');}'Related1M'==selectedOption.val()&&form.find('.preDefinedModuleList').removeClass('d-none'),('Tree'==selectedOption.val()||'CategoryMultipicklist'==selectedOption.val())&&form.find('.preDefinedTreeList').removeClass('d-none'),'MultiReferenceValue'==selectedOption.val()&&(form.find('.preMultiReferenceValue').removeClass('d-none'),thisInstance.loadMultiReferenceFields(form));});},showCustomField:function showCustomField(result){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents'),relatedBlock=contents.find('.block_'+result.blockid),fieldCopy=contents.find('.newCustomFieldCopy').clone(!0,!0),fieldContainer=fieldCopy.find('div.marginLeftZero.border1px');fieldContainer.addClass('opacity editFields').attr('data-field-id',result.id).attr('data-block-id',result.blockid),fieldContainer.find('.deleteCustomField, .saveFieldDetails').attr('data-field-id',result.id),fieldContainer.find('.fieldLabel').html(result.label+' ['+result.name+']'),fieldContainer.find('#relatedFieldValue').val(result.name).prop('id','relatedFieldValue'+result.id),fieldContainer.find('.copyFieldLabel').attr('data-target','relatedFieldValue'+result.id),thisInstance.registerCopyClipboard(),result.customField||fieldContainer.find('.deleteCustomField').remove(),-1==$.inArray(result.type,['string','phone','currency','url','integer','double'])&&fieldContainer.find('.maskField').remove();var block=relatedBlock.find('.blockFieldsList'),sortable1=block.find('.js-sort-table1'),length1=sortable1.children().length,sortable2=block.find('.js-sort-table2'),length2=sortable2.children().length;length1>length2?sortable2.append(fieldCopy.removeClass('d-none newCustomFieldCopy')):sortable1.append(fieldCopy.removeClass('d-none newCustomFieldCopy')),thisInstance.makeFieldsListSortable();},registerAddCustomBlockEvent:function registerAddCustomBlockEvent(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents');contents.find('.addCustomBlock').on('click',function(e){var addBlockContainer=contents.find('.addBlockModal').clone(!0,!0),callBackFunction=function(data){data.find('.addBlockModal').removeClass('d-none').show(),App.Fields.Picklist.showSelect2ElementView(data.find('select'));var form=data.find('.addCustomBlockForm');thisInstance.setBlocksListArray(form);var fieldLabel=form.find('[name="label"]'),params=Object.create(app.validationEngineOptions);params.onValidationComplete=function(form,valid){if(valid){var formData=form.serializeFormData();if(-1==$.inArray(formData.label,thisInstance.blockNamesList))return thisInstance.saveBlockDetails(form).done(function(data){var params={};if(data.success){var result=data.result;thisInstance.displayNewCustomBlock(result),thisInstance.updateNewSequenceForBlocks(result.sequenceList),thisInstance.appendNewBlockToBlocksList(result,form),thisInstance.makeFieldsListSortable(),params.text=app.vtranslate('JS_CUSTOM_BLOCK_ADDED');}else params.text=data.error.message,params.type='error';Settings_Vtiger_Index_Js.showMessage(params);}),app.hideModalWindow(),valid;var result=app.vtranslate('JS_BLOCK_NAME_EXISTS');return fieldLabel.validationEngine('showPrompt',result,'error','topLeft',!0),void e.preventDefault()}},form.validationEngine(params),form.on('submit',function(e){e.preventDefault();});};app.showModalWindow(addBlockContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);},{width:'1000px'});});},saveBlockDetails:function saveBlockDetails(form){var aDeferred=$.Deferred(),progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params=form.serializeFormData();return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.sourceModule=$('#selectedModuleName').val(),params.action='Block',params.mode='save',AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(error){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject(error);}),aDeferred.promise()},displayNewCustomBlock:function displayNewCustomBlock(result){var contents=$('#layoutEditorContainer').find('.contents'),beforeBlockId=result.beforeBlockId,beforeBlock=contents.find('.block_'+beforeBlockId),newBlockCloneCopy=contents.find('.newCustomBlockCopy').clone(!0,!0);newBlockCloneCopy.data('blockId',result.id).find('.blockLabel').append($('<strong class="align-middle">'+result.label+'</strong>')),newBlockCloneCopy.find('.js-block-visibility').data('blockId',result.id),result.isAddCustomFieldEnabled&&newBlockCloneCopy.find('.addCustomField').removeClass('d-none'),beforeBlock.after(newBlockCloneCopy.removeClass('d-none newCustomBlockCopy').addClass('editFieldsTable block_'+result.id)),newBlockCloneCopy.find('.blockFieldsList').sortable({connectWith:'.blockFieldsList'});},updateNewSequenceForBlocks:function updateNewSequenceForBlocks(sequenceList){var contents=$('#layoutEditorContainer').find('.contents');$.each(sequenceList,function(blockId,sequence){contents.find('.block_'+blockId).data('sequence',sequence);});},appendNewBlockToBlocksList:function appendNewBlockToBlocksList(result){var contents=$('#layoutEditorContainer').find('.contents'),hiddenAddBlockModel=contents.find('.addBlockModal'),blocksListSelect=hiddenAddBlockModel.find('[name="beforeBlockId"]'),option=$('<option>',{value:result.id,text:result.label});blocksListSelect.append(option.attr('data-label',result.label));},removeBlockFromBlocksList:function removeBlockFromBlocksList(blockId){var contents=$('#layoutEditorContainer').find('.contents'),hiddenAddBlockModel=contents.find('.addBlockModal'),blocksListSelect=hiddenAddBlockModel.find('[name="beforeBlockId"]');blocksListSelect.find('option[value="'+blockId+'"]').remove();},registerBlockVisibilityEvent:function registerBlockVisibilityEvent(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents');contents.on('click','.js-block-visibility',function(e){var currentTarget=$(e.currentTarget);thisInstance.updateBlockStatus(currentTarget);});},updateBlockStatus:function updateBlockStatus(currentTarget){var blockStatus=currentTarget.data('visible'),progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.sourceModule=$('#selectedModuleName').val(),params.action='Block',params.mode='save',params.blockid=currentTarget.data('blockId'),params.display_status=blockStatus,AppConnector.request(params).done(function(){progressIndicatorElement.progressIndicator({mode:'hide'});var params={};params.text='1'==blockStatus?app.vtranslate('JS_BLOCK_VISIBILITY_SHOW'):'2'==blockStatus?app.vtranslate('JS_BLOCK_VISIBILITY_DYNAMIC'):app.vtranslate('JS_BLOCK_VISIBILITY_HIDE'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'});});},registerInactiveFieldsEvent:function registerInactiveFieldsEvent(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents');contents.on('click','.js-inactive-fields-btn',function(e){var currentTarget=$(e.currentTarget),currentBlock=currentTarget.closest('.editFieldsTable'),blockId=currentBlock.data('blockId');if($.isEmptyObject(thisInstance.inActiveFieldsList[blockId])){var params={};params.text=app.vtranslate('JS_NO_HIDDEN_FIELDS_EXISTS'),params.type='error',Settings_Vtiger_Index_Js.showMessage(params);}else{var inActiveFieldsContainer=contents.find('.inactiveFieldsModal').clone(!0,!0),callBackFunction=function(data){data.find('.inactiveFieldsModal').removeClass('d-none').show(),thisInstance.reactiveFieldsList=[];var form=data.find('.inactiveFieldsForm');thisInstance.showHiddenFields(blockId,form),form.on('submit',function(e){thisInstance.createReactivateFieldslist(blockId,form),thisInstance.reActivateHiddenFields(currentBlock),app.hideModalWindow(),e.preventDefault();});};app.showModalWindow(inActiveFieldsContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);},{width:'1000px'});}});},showHiddenFields:function showHiddenFields(blockId,form){var thisInstance=this;$.each(thisInstance.inActiveFieldsList[blockId],function(key,value){var inActiveField=$('<div class="col-md-4 marginLeftZero padding-bottom1per checkbox"><label class=""><input type="checkbox" class="inActiveField" value="'+key+'" />&nbsp;'+value+'</label></div>');form.find('.inActiveList').append(inActiveField);});},createReactivateFieldslist:function createReactivateFieldslist(blockId,form){var thisInstance=this;form.find('.inActiveField').each(function(index,domElement){var element=$(domElement),fieldId=element.val();element.is(':checked')&&(delete thisInstance.inActiveFieldsList[blockId][fieldId],thisInstance.reactiveFieldsList.push(fieldId));});},reActivateHiddenFields:function reActivateHiddenFields(currentBlock){var thisInstance=this,progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={module:app.getModuleName(),parent:app.getParentModuleName(),action:'Field',mode:'unHide',blockId:currentBlock.data('blockId'),fieldIdList:JSON.stringify(thisInstance.reactiveFieldsList)},messageParams={};'[]'===params.fieldIdList?(messageParams.text=app.vtranslate('JS_NO_ITEM_SELECTED'),messageParams.type='error',progressIndicatorElement.progressIndicator({mode:'hide'}),Settings_Vtiger_Index_Js.showMessage(messageParams)):AppConnector.request(params).done(function(data){for(var index in data.result)thisInstance.showCustomField(data.result[index]);progressIndicatorElement.progressIndicator({mode:'hide'}),messageParams.text=app.vtranslate('JS_SELECTED_FIELDS_REACTIVATED'),Settings_Vtiger_Index_Js.showMessage(messageParams);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'});});},registerDeleteCustomBlockEvent:function registerDeleteCustomBlockEvent(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents');contents.on('click','.js-delete-custom-block-btn',function(e){var currentTarget=$(e.currentTarget),table=currentTarget.closest('div.editFieldsTable'),blockId=table.data('blockId'),message=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){thisInstance.deleteCustomBlock(blockId);}).fail(function(){});});},deleteCustomBlock:function deleteCustomBlock(blockId){var thisInstance=this,progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Block',params.mode='delete',params.blockid=blockId,AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'});var params={};data.success?(thisInstance.removeDeletedBlock(blockId),thisInstance.removeBlockFromBlocksList(blockId),params.text=app.vtranslate('JS_CUSTOM_BLOCK_DELETED')):(params.text=data.error.message,params.type='error'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'});});},removeDeletedBlock:function removeDeletedBlock(blockId){var contents=$('#layoutEditorContainer').find('.contents'),deletedTable=contents.find('.block_'+blockId);deletedTable.fadeOut('slow').remove();},registerDeleteCustomFieldEvent:function registerDeleteCustomFieldEvent(contents){var thisInstance=this;'undefined'==typeof contents&&(contents=$('#layoutEditorContainer').find('.contents')),contents.find('.deleteCustomField').on('click',function(e){var currentTarget=$(e.currentTarget),fieldId=currentTarget.data('fieldId'),message=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){thisInstance.deleteCustomField(fieldId).done(function(){var field=currentTarget.closest('div.editFields'),blockId=field.data('blockId');field.parent().fadeOut('slow').remove();var block=$('#block_'+blockId);thisInstance.reArrangeBlockFields(block);var params={};params.text=app.vtranslate('JS_CUSTOM_FIELD_DELETED'),Settings_Vtiger_Index_Js.showMessage(params);}).fail(function(){});}).fail(function(){});});},deleteCustomField:function deleteCustomField(fieldId){var aDeferred=$.Deferred(),progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Field',params.mode='delete',params.fieldid=fieldId,AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject();}),aDeferred.promise()},registerFieldDetailsChange:function registerFieldDetailsChange(contents){contents.find('[name="mandatory"]').on('change',function(e){var currentTarget=$(e.currentTarget);if('readonly'!==currentTarget.attr('readonly')){var form=currentTarget.closest('.fieldDetailsForm'),quickcreateEle=form.find('[name="quickcreate"]').filter(':checkbox').not('.optionDisabled'),presenceEle=form.find('[name="presence"]').filter(':checkbox').not('.optionDisabled');currentTarget.is(':checked')?(quickcreateEle.attr('checked',!0).attr('readonly','readonly'),presenceEle.attr('checked',!0).attr('readonly','readonly')):(quickcreateEle.removeAttr('readonly'),presenceEle.removeAttr('readonly'));}}),contents.find('[name="defaultvalue"],[name="header_field"]').on('change',function(e){var currentTarget=$(e.currentTarget),defaultValueUi=currentTarget.closest('.checkbox').find('.js-toggle-hide');currentTarget.is(':checked')?defaultValueUi.removeClass('zeroOpacity'):defaultValueUi.addClass('zeroOpacity');});},relatedModulesTabClickEvent:function relatedModulesTabClickEvent(){var thisInstance=this,contents=$('#layoutEditorContainer').find('.contents'),relatedContainer=contents.find('#relatedTabOrder'),relatedTab=contents.find('.relatedListTab');relatedTab.on('click',function(){0<relatedContainer.find('.relatedTabModulesList').length||thisInstance.showRelatedTabModulesList(relatedContainer);});},showRelatedTabModulesList:function showRelatedTabModulesList(relatedContainer){var thisInstance=this,params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.sourceModule=$('#selectedModuleName').val(),params.view='Index',params.mode='showRelatedListLayout',AppConnector.request(params).done(function(data){relatedContainer.html(data),0<$(data).find('.relatedListContainer').length&&(thisInstance.makeRelatedModuleSortable(),thisInstance.registerRelatedListEvents());}).fail(function(){});},getModuleLayoutEditor:function getModuleLayoutEditor(selectedModule){var aDeferred=$.Deferred(),progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view='Index',params.sourceModule=selectedModule,AppConnector.requestPjax(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject();}),aDeferred.promise()},getRelModuleLayoutEditor:function getRelModuleLayoutEditor(selectedModule){var aDeferred=$.Deferred(),progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view='Index',params.mode='showRelatedListLayout',params.sourceModule=selectedModule,AppConnector.requestPjax(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject();}),aDeferred.promise()},registerModulesChangeEvent:function registerModulesChangeEvent(){var thisInstance=this,container=$('#layoutEditorContainer'),contentsDiv=container.closest('.contentsDiv');App.Fields.Picklist.showSelect2ElementView(container.find('[name="layoutEditorModules"]')),container.on('change','[name="layoutEditorModules"]',function(e){var currentTarget=$(e.currentTarget),selectedModule=currentTarget.val();thisInstance.getModuleLayoutEditor(selectedModule).done(function(data){contentsDiv.html(data),thisInstance.registerEvents();});});},registerRelModulesChangeEvent:function registerRelModulesChangeEvent(){var thisInstance=this,container=$('#layoutEditorContainer'),contentsDiv=container.closest('.contentsDiv');App.Fields.Picklist.showSelect2ElementView(container.find('[name="layoutEditorRelModules"]')),container.on('change','[name="layoutEditorRelModules"]',function(e){var currentTarget=$(e.currentTarget),selectedModule=currentTarget.val();thisInstance.getRelModuleLayoutEditor(selectedModule).done(function(data){contentsDiv.html(data),thisInstance.registerEvents();});});},lockCheckbox:function lockCheckbox(contents){contents.on('change',':checkbox',function(e){var currentTarget=$(e.currentTarget);if('readonly'===currentTarget.attr('readonly')){var status=$(e.currentTarget).is(':checked');status?$(e.currentTarget).prop('checked',!1):$(e.currentTarget).prop('checked',!0),e.preventDefault();}});},registerEditFieldDetailsClick:function registerEditFieldDetailsClick(contents){var thisInstance=this;'undefined'==typeof contents&&(contents=$('#layoutEditorContainer').find('.contents')),contents.find('.editFieldDetails').on('click',function(e){var currentTarget=$(e.currentTarget),fieldRow=currentTarget.closest('div.editFields'),fieldId=fieldRow.data('fieldId'),block=fieldRow.closest('.editFieldsTable'),blockId=block.data('blockId');app.showModalWindow({url:'index.php?parent=Settings&module=LayoutEditor&view=EditField&fieldId='+fieldRow.data('fieldId'),cb:function cb(modalContainer){thisInstance.registerFieldDetailsChange(modalContainer),thisInstance.lockCheckbox(modalContainer),thisInstance.registerVaribleToParsers(modalContainer),app.registerEventForClockPicker(modalContainer.find('.clockPicker')),modalContainer.find('[data-inputmask]').inputmask();},sendByAjaxCb:function sendByAjaxCb(formData,response){if(response.success){Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_FIELD_DETAILS_SAVED')});var result=response.result,fieldLabel=fieldRow.find('.fieldLabel');'1'===result.presence&&(fieldRow.parent().fadeOut('slow').remove(),$.isEmptyObject(thisInstance.inActiveFieldsList[blockId])?(0===thisInstance.inActiveFieldsList.length&&(thisInstance.inActiveFieldsList={}),thisInstance.inActiveFieldsList[blockId]={},thisInstance.inActiveFieldsList[blockId][fieldId]=result.label):thisInstance.inActiveFieldsList[blockId][fieldId]=result.label,thisInstance.reArrangeBlockFields(block)),result.mandatory?0===fieldLabel.find('.redColor').length&&fieldRow.find('.fieldLabel').append($('<span class="redColor">*</span>')):fieldRow.find('.fieldLabel').find('.redColor').remove();}}});});},registerVaribleToParsers:function registerVaribleToParsers(container){container.find('.configButton').on('click',function(){container.find('.js-toggle-hide .js-base-element').each(function(n,e){var currentElement=$(e);currentElement.hasClass('d-none')?currentElement.find('input,select').prop('disabled',!1):currentElement.find('input,select').prop('disabled',!0),currentElement.toggleClass('d-none');});}),container.find('.varibleToParsers').on('click',function(e){var element=$(e.currentTarget),container=element.closest('.js-base-element'),input=container.find('[name="'+container.data('name')+'"]'),fieldId=element.closest('form').find('[name="fieldid"]').val();app.showModalWindow({id:'varibleToParsersModal',url:'index.php?parent=Settings&module=LayoutEditor&view=VaribleToParsers&fieldId='+fieldId+'&defaultValue='+input.val(),cb:function cb(modalContainer){modalContainer.find('[name="saveButton"]').on('click',function(){input.val(modalContainer.find('select').val()),app.hideModalWindow(null,'varibleToParsersModal');});}});});},registerBlockEvents:function registerBlockEvents(){var thisInstance=this;thisInstance.makeBlocksListSortable(),thisInstance.registerAddCustomFieldEvent(),thisInstance.registerBlockVisibilityEvent(),thisInstance.registerInactiveFieldsEvent(),thisInstance.registerDeleteCustomBlockEvent();},registerFieldEvents:function registerFieldEvents(contents){var thisInstance=this;'undefined'==typeof contents&&(contents=$('#layoutEditorContainer').find('.contents')),App.Fields.Date.register(contents),App.Fields.Picklist.changeSelectElementView(contents),thisInstance.makeFieldsListSortable(),thisInstance.registerDeleteCustomFieldEvent(contents),thisInstance.registerEditFieldDetailsClick(contents),contents.find(':checkbox').on('change',function(e){var currentTarget=$(e.currentTarget);if('readonly'==currentTarget.attr('readonly')){var status=$(e.currentTarget).is(':checked');status?$(e.currentTarget).prop('checked',!1):$(e.currentTarget).prop('checked',!0),e.preventDefault();}});},registerSwitch:function registerSwitch(){var container=$('#layoutEditorContainer');container.find('.js-switch--inventory').on('change',function(event){var switchBtn=$(event.currentTarget),state=switchBtn.data('value'),message=app.vtranslate('JS_EXTENDED_MODULE');Vtiger_Helper_Js.showConfirmationBox({message:'<span class="message-medium">'+message+'</span>',className:'test'}).done(function(){$.progressIndicator({message:app.vtranslate('JS_SAVE_LOADER_INFO'),position:'html',blockInfo:{enabled:!0}});var params={};params.module=container.find('[name="layoutEditorModules"]').val(),params.status='basic'===state?0:1,app.saveAjax('setInventory',params).done(function(data){data.result&&window.location.reload();});});});},registerAddInventoryField:function registerAddInventoryField(){var thisInstance=this,container=thisInstance.getInventoryViewLayout();container.find('.addInventoryField').on('click',function(e){var currentTarget=$(e.currentTarget),selectedModule=$('#layoutEditorContainer').find('[name="layoutEditorModules"]').val(),blockId=currentTarget.closest('.inventoryBlock').data('block-id'),progress=$.progressIndicator();app.showModalWindow(null,'index.php?module=LayoutEditor&parent=Settings&view=CreateInventoryFields&mode=step1&sourceModule='+selectedModule+'&block='+blockId,function(modalContainer){app.showScrollBar(modalContainer.find('.well'),{height:'300px'}),thisInstance.registerStep1(modalContainer,blockId),progress.progressIndicator({mode:'hide'});});});},registerEditInventoryField:function registerEditInventoryField(){var thisInstance=this,container=thisInstance.getInventoryViewLayout();container.find('.editInventoryField').on('click',function(e){var currentTarget=$(e.currentTarget),selectedModule=$('#layoutEditorContainer').find('[name="layoutEditorModules"]').val(),blockId=currentTarget.closest('.inventoryBlock').data('block-id'),editField=currentTarget.closest('.editFields'),progress=$.progressIndicator();app.showModalWindow(null,'index.php?module=LayoutEditor&parent=Settings&view=CreateInventoryFields&mode=step2&sourceModule='+selectedModule+'&type='+editField.data('type')+'&fieldName='+editField.data('name'),function(container){app.showPopoverElementView(container.find('.js-help-info')),thisInstance.registerStep2(container,blockId),progress.progressIndicator({mode:'hide'});});});},registerStep1:function registerStep1(container,blockId){var thisInstance=this;container.find('.js-next-button').on('click',function(){var selectedModule=$('#layoutEditorContainer').find('[name="layoutEditorModules"]').val(),type=container.find('select.type').val();null===type?container.find('select.type').validationEngine('showPrompt',app.vtranslate('JS_REQUIRED_FIELD'),'error','topRight',!0):app.hideModalWindow(function(){var progress=$.progressIndicator({position:'html',blockInfo:{enabled:!0}});app.showModalWindow(null,'index.php?module=LayoutEditor&parent=Settings&view=CreateInventoryFields&mode=step2&sourceModule='+selectedModule+'&type='+type,function(modalContainer){thisInstance.registerStep2(modalContainer,blockId),progress.progressIndicator({mode:'hide'});});});});},registerStep2:function registerStep2(container,blockId){var thisInstance=this,containerInventory=thisInstance.getInventoryViewLayout(),form=container.find('form'),selectedModule=$('#layoutEditorContainer').find('[name="layoutEditorModules"]').val();form.validationEngine(app.validationEngineOptions),form.on('submit',function(){var formData=form.serializeFormData(),paramsName=container.find('#params');if(paramsName.length){paramsName=JSON.parse(paramsName.val());var params={};for(var i in formData)if(-1!=$.inArray(i,paramsName)){var value=formData[i];'modules'===i&&'string'==typeof value&&(value=[value]),params[i]=value,delete formData[i];}formData.params=JSON.stringify(params);}var errorExists=form.validationEngine('validate');!1!=errorExists&&(formData.block=blockId,formData.sourceModule=selectedModule,app.saveAjax('saveInventoryField',null,formData).done(function(data){var result=data.result,success=data.success;if(app.hideModalWindow(),success&&result&&result.edit){var liElement=containerInventory.find('[data-id="'+result.data.id+'"]');liElement.find('.fieldLabel').text(result.data.translate);}else if(success&&result){var newLiElement=containerInventory.find('.newLiElement').clone(!0,!0);newLiElement.removeClass('d-none newLiElement').find('.editFields').attr('data-id',result.data.id).attr('data-sequence',result.data.sequence).attr('data-name',result.data.columnName).attr('data-type',result.data.invtype).find('.fieldLabel').text(result.data.translate),containerInventory.find('[data-block-id="'+result.data.block+'"] .connectedSortable').append(newLiElement);}else Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_ERROR'));}));}),container.find('form').on('submit',function(event){event.preventDefault();});},registerInventoryFieldSequenceSaveClick:function registerInventoryFieldSequenceSaveClick(){var thisInstance=this,containerInventory=thisInstance.getInventoryViewLayout(),selectedModule=$('#layoutEditorContainer').find('[name="layoutEditorModules"]').val();containerInventory.on('click','.saveFieldSequence',function(e){var button=$(e.currentTarget),target=button.closest('.inventoryBlock'),fieldId=[];target.find('.editFields').each(function(){fieldId.push($(this).data('id'));}),app.saveAjax('saveSequence',null,{sourceModule:selectedModule,ids:fieldId}).done(function(){button.addClass('invisible');});});},registerDeleteInventoryField:function registerDeleteInventoryField(){var thisInstance=this,container=thisInstance.getInventoryViewLayout(),selectedModule=$('#layoutEditorContainer').find('[name="layoutEditorModules"]').val();container.find('.deleteInventoryField').on('click',function(e){var currentTarget=$(e.currentTarget),liElement=currentTarget.closest('li'),message=app.vtranslate('JS_DELETE_INVENTORY_CONFIRMATION');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){var progressIndicatorElement=$.progressIndicator({message:app.vtranslate('JS_SAVE_LOADER_INFO'),position:'html',blockInfo:{enabled:!0}}),editFields=liElement.find('.editFields');app.saveAjax('delete',null,{sourceModule:selectedModule,fieldName:editFields.data('name')}).done(function(response){var param={};response.result?(liElement.remove(),param={type:'success',text:app.vtranslate('JS_SAVE_CHANGES')}):param={type:'error',text:app.vtranslate('JS_ERROR')},Settings_Vtiger_Index_Js.showMessage(param),progressIndicatorElement.progressIndicator({mode:'hide'});});}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'});});});},loadMultiReferenceFields:function loadMultiReferenceFields(form){var thisInstance=this,module=form.find('[name="MRVModule"]').val();form.find('[name="MRVField"],[name="MRVFilterField"]').select2('destroy'),form.find('[name="MRVField"]').html(thisInstance.cacheMRVField.html()),form.find('[name="MRVField"] optgroup').each(function(){$(this).data('module')!=module&&$(this).remove();}),form.find('[name="MRVFilterField"]').html(thisInstance.cacheMRVFilter.html()),form.find('[name="MRVFilterField"] option').each(function(){$(this).data('module')!=module&&$(this).remove();}),App.Fields.Picklist.showSelect2ElementView(form.find('[name="MRVField"],[name="MRVFilterField"]'),{width:'100%'});},cacheMRVField:!1,cacheMRVFilter:!1,registerMultiReferenceFieldsChangeEvent:function registerMultiReferenceFieldsChangeEvent(form){var thisInstance=this;thisInstance.cacheMRVField=form.find('[name="MRVField"]').clone(!0,!0),thisInstance.cacheMRVFilter=form.find('[name="MRVFilterField"]').clone(!0,!0),form.find('[name="MRVModule"]').on('change',function(){thisInstance.loadMultiReferenceFields(form);});},registerMultiReferenceFilterFieldChangeEvent:function registerMultiReferenceFilterFieldChangeEvent(form){form.find('[name="MRVFilterField"]').on('change',function(){var params={};params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.action='Field',params.mode='getPicklist',params.rfield=form.find('[name="MRVFilterField"]').val(),params.rmodule=form.find('[name="MRVModule"]').val(),form.find('[name="MRVFilterValue"]').select2('destroy'),form.find('[name="MRVFilterValue"] option').remove(),AppConnector.request(params).done(function(data){$.each(data.result,function(index,value){form.find('[name="MRVFilterValue"]').append($('<option>').val(index).html(value));}),App.Fields.Picklist.showSelect2ElementView(form.find('[name="MRVFilterValue"]'),{width:'100%'});});});},registerCopyClipboard:function registerCopyClipboard(){new ClipboardJS('.copyFieldLabel',{text:function text(trigger){return Vtiger_Helper_Js.showPnotify({text:app.vtranslate('JS_NOTIFY_COPY_TEXT'),type:'success'}),$('#layoutEditorContainer').find('#'+trigger.getAttribute('data-target')).val()}});},registerContextHelp:function registerContextHelp(){$(document).on('click','.js-context-help',function(e){var customConfig={toolbar:'Min'},element=$(e.currentTarget);this.progressInstance=$.progressIndicator({blockInfo:{enabled:!0}}),AppConnector.request({module:app.getModuleName(),parent:app.getParentModuleName(),view:'HelpInfo',field:element.data('field-id')}).done(function(data){app.showModalWindow(data,function(modalContainer){new App.Fields.Text.Editor(modalContainer,customConfig),app.showPopoverElementView(modalContainer.find('.js-help-info')),modalContainer.find('.js-lang').on('change',function(e){var previous=modalContainer.find('.js-editor:not([disabled])');App.Fields.Text.destroyEditor(previous),previous.closest('.js-context-block').addClass('d-none'),previous.prop('disabled',!0);var element=$(e.currentTarget).val(),textArea=modalContainer.find('#'+element+'.js-context-area');textArea.prop('disabled',!1),textArea.closest('.js-context-block').removeClass('d-none'),App.Fields.Text.destroyEditor(textArea),modalContainer.find('.js-help-info').attr('data-content',textArea.val()),new App.Fields.Text.Editor(textArea,customConfig);}),modalContainer.find('form').on('submit',function(e){e.preventDefault();var form=$(e.currentTarget),params=form.serializeFormData();'undefined'==typeof params.views&&(params.views=form.find('[name="views"]').val()),app.saveAjax('contextHelp','',params).done(function(){Vtiger_Helper_Js.showPnotify({type:'success',text:app.vtranslate('JS_SAVE_CHANGES')});var prefix=form.find('.js-lang').val(),textArea=form.find('#'+prefix+'.js-context-area');form.find('.js-help-info').attr('data-content',textArea.val());});});});});});},registerEvents:function registerEvents(){var thisInstance=this;thisInstance.registerBlockEvents(),thisInstance.registerFieldEvents(),thisInstance.setInactiveFieldsList(),thisInstance.registerAddCustomBlockEvent(),thisInstance.relatedModulesTabClickEvent(),thisInstance.registerModulesChangeEvent(),thisInstance.registerRelModulesChangeEvent(),1===$('#relatedTabOrder').length&&(thisInstance.registerRelatedListEvents(),thisInstance.makeRelatedModuleSortable()),thisInstance.registerSwitch(),thisInstance.registerAddInventoryField(),thisInstance.registerEditInventoryField(),thisInstance.registerInventoryFieldSequenceSaveClick(),thisInstance.registerDeleteInventoryField();},registerBasicEvents:function registerBasicEvents(){var container=$('#layoutEditorContainer');this.registerEvents(),this.registerFieldSequenceSaveClick(),this.registerCopyClipboard(),this.registerContextHelp(container);}}),$(document).ready(function(){var instance=new Settings_LayoutEditor_Js;instance.registerBasicEvents();}),Vtiger_WholeNumberGreaterThanZero_Validator_Js('Vtiger_FloatingDigits_Validator_Js',{invokeValidation:function invokeValidation(field){var rangeInstance=new Vtiger_FloatingDigits_Validator_Js;rangeInstance.setElement(field);var response=rangeInstance.validate();if(!0!=response)return rangeInstance.getError()}},{validate:function validate(){var response=this._super();if(!0!=response)return response;var fieldValue=this.getFieldValue();if(2>fieldValue||5<fieldValue){var errorInfo=app.vtranslate('JS_PLEASE_ENTER_NUMBER_IN_RANGE_2TO5');return this.setError(errorInfo),!1}var specialChars=/^[+]/;if(specialChars.test(fieldValue)){var error=app.vtranslate('JS_CONTAINS_ILLEGAL_CHARACTERS');return this.setError(error),!1}return !0}}),Vtiger_WholeNumberGreaterThanZero_Validator_Js('Vtiger_DecimalMaxLength_Validator_Js',{invokeValidation:function invokeValidation(field){var rangeInstance=new Vtiger_DecimalMaxLength_Validator_Js;rangeInstance.setElement(field);var response=rangeInstance.validate();if(!0!=response)return rangeInstance.getError()}},{validate:function validate(){var response=this._super();if(!0!=response)return response;var fieldValue=this.getFieldValue(),decimalFieldValue=$('#createFieldForm').find('[name="decimal"]').val(),fieldLength=parseInt(64)-parseInt(decimalFieldValue);if(fieldValue>fieldLength&&!(0>fieldLength)&&59<=fieldLength){var errorInfo=app.vtranslate('JS_LENGTH_SHOULD_BE_LESS_THAN_EQUAL_TO')+' '+fieldLength;return this.setError(errorInfo),!1}var specialChars=/^[+]/;if(specialChars.test(fieldValue)){var error=app.vtranslate('JS_CONTAINS_ILLEGAL_CHARACTERS');return this.setError(error),!1}return !0}}),Vtiger_WholeNumberGreaterThanZero_Validator_Js('Vtiger_MaxLength_Validator_Js',{invokeValidation:function invokeValidation(field){var rangeInstance=new Vtiger_DecimalMaxLength_Validator_Js;rangeInstance.setElement(field);var response=rangeInstance.validate();if(!0!=response)return rangeInstance.getError()}},{validate:function validate(){var response=this._super();if(!0!=response)return response;var fieldValue=this.getFieldValue();if(255<fieldValue){var errorInfo=app.vtranslate('JS_LENGTH_SHOULD_BE_LESS_THAN_EQUAL_TO')+' 255';return this.setError(errorInfo),!1}var specialChars=/^[+]/;if(specialChars.test(fieldValue)){var error=app.vtranslate('JS_CONTAINS_ILLEGAL_CHARACTERS');return this.setError(error),!1}return !0}}),Vtiger_Base_Validator_Js('Vtiger_FieldLabel_Validator_Js',{invokeValidation:function invokeValidation(field){var instance=new Vtiger_FieldLabel_Validator_Js;instance.setElement(field);var response=instance.validate();if(!0!=response)return instance.getError()}},{validate:function validate(){var fieldValue=this.getFieldValue();return this.validateValue(fieldValue)},validateValue:function validateValue(fieldValue){var specialChars=/[&\<\>\:\'\"\,]/;if(specialChars.test(fieldValue)){var errorInfo=app.vtranslate('JS_SPECIAL_CHARACTERS')+' & < > \' " : , '+app.vtranslate('JS_NOT_ALLOWED');return this.setError(errorInfo),!1}return !0}}),Vtiger_Base_Validator_Js('Vtiger_PicklistFieldValues_Validator_Js',{invokeValidation:function invokeValidation(field){var instance=new Vtiger_PicklistFieldValues_Validator_Js;instance.setElement(field);var response=instance.validate();if(!0!=response)return instance.getError()}},{validate:function validate(){return this.validateValue(this.getElement().val())},validateValue:function validateValue(fieldValue){var _this2=this,specialChars=/[\<\>\"\,\#]/,r=!0;return $.each(fieldValue,function(i,val){specialChars.test(val)&&(_this2.setError(app.vtranslate('JS_SPECIAL_CHARACTERS')+' < > " , # '+app.vtranslate('JS_NOT_ALLOWED')),r=!1);}),r}});
//# sourceMappingURL=LayoutEditor.min.js.map
