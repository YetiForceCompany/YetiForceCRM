'use strict';

jQuery.Class('Settings_Menu_Index_Js',{},{treeInstance:!1,loadMenuTree:function c(){var a=this;if(!1==a.treeInstance){var b=JSON.parse($('#treeValues').val());0==b.length&&Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_NO_DATA')}),a.treeInstance=$('#treeContent'),a.treeInstance.jstree({core:{data:b,check_callback:!0},contextmenu:{items:{rename:{label:app.vtranslate('JS_EDIT'),action:function g(b){var c=$.jstree.reference(b.reference),d=c.get_selected(),e=c.get_node(d),f=jQuery.progressIndicator();app.showModalWindow(null,'index.php?module=Menu&parent=Settings&view=EditMenu&id='+d,function(b){a.registerEditMenu(b),f.progressIndicator({mode:'hide'});});}},remove:{label:app.vtranslate('JS_REMOVE'),action:function j(b){var c=$.jstree.reference(b.reference),d=c.get_selected(),e=!1;for(var f in d){var g=c.get_node(d[f]);if(0<g.children.length){e=!0;break}}if(e){var h=$('.modal.deleteAlert').clone(!0,!0),i=function(b){b.find('.deleteAlert').removeClass('d-none'),b.find('.btn-danger').on('click',function(){a.removeMenu(d,c);});};app.showModalWindow(h,function(a){'function'==typeof i&&i(a);});}else a.removeMenu(d,c);}}}},plugins:['contextmenu','dnd','search','state','types']});}return a.registerMenuChanges(),this.treeInstance},registerMenuChanges:function b(){var a=this;a.treeInstance.on('move_node.jstree',function(){var b=jQuery.progressIndicator(),c=a.treeInstance.jstree('get_json'),d=a.getChildrenMenu(c,0);a.save('updateSequence',JSON.stringify(d)).done(function(c){Settings_Vtiger_Index_Js.showMessage({type:'success',text:c.result.message}),a.loadContent(),b.progressIndicator({mode:'hide'});});});},getChildrenMenu:function f(a,b){var c=[],d=this,e=$('[name="roleMenu"]').val();return $.each(a,function(a,f){var g={i:f.id,s:a,p:b,r:e};0<f.children.length&&(g.c=d.getChildrenMenu(f.children,f.id)),c.push(g);}),c},registerChangeRoleMenu:function b(){var a=this;$('.menuConfigContainer').on('change','[name="roleMenu"]',function(){a.loadContent();});},getMenuData:function e(a){var c=jQuery.Deferred(),d={};return d.module=app.getModuleName(),d.parent=app.getParentModuleName(),d.view=app.getViewName(),d.roleid=a,AppConnector.requestPjax(d).done(function(a){c.resolve(a);}).fail(function(){c.reject();}),c.promise()},registerAddMenu:function b(){var a=this;$('.addMenu').on('click',function(){var b=jQuery.progressIndicator();app.showModalWindow(null,'index.php?module=Menu&parent=Settings&view=CreateMenu&mode=step1',function(c){a.registerStep1(c),b.progressIndicator({mode:'hide'});});});},loadContent:function d(){var a=jQuery.progressIndicator({position:'#treeContent',blockInfo:{enabled:!0}}),b=this,c=$('.contentsDiv');b.getMenuData($('[name="roleMenu"]').val()).done(function(d){c.html(d),App.Fields.Picklist.showSelect2ElementView(c.find('[name=\'roleMenu\']')),b.registerEvents(),a.progressIndicator({mode:'hide'});});},registerEditMenu:function c(a){var b=this;a.find('form').validationEngine(app.validationEngineOptions),b.registerHotkeys(a),b.registerHiddenInput(a),b.registerFilters(a),b.registerSelectIcons(a),a.find('.saveButton').on('click',function(){var c=a.find('form').serializeFormData(),d=a.find('form').validationEngine('validate');if(!1!=d){var e=jQuery.progressIndicator();b.save('updateMenu',c).done(function(a){Settings_Vtiger_Index_Js.showMessage({type:'success',text:a.result.message}),app.hideModalWindow(),b.loadContent(),e.progressIndicator({mode:'hide'});});}}),a.find('form').on('submit',function(a){a.preventDefault();});},registerStep1:function c(a){var b=this;a.find('.nextButton').on('click',function(){var c=jQuery.progressIndicator();app.showModalWindow(null,'index.php?module=Menu&parent=Settings&view=CreateMenu&mode=step2&mtype='+a.find('select.type').val(),function(a){b.registerStep2(a),c.progressIndicator({mode:'hide'});});});},registerSelectIcons:function d(a){var b=a.find('#selectIconButton'),c=a.find('[name="icon"]');b.on('click',function(){$.when(Settings_Vtiger_Index_Js.selectIcon()).done(function(a){c.val(a.name);});});},registerStep2:function c(a){var b=this;a.find('form').validationEngine(app.validationEngineOptions),b.registerHotkeys(a),b.registerHiddenInput(a),b.registerFilters(a),b.registerSelectIcons(a),app.showPopoverElementView(jQuery(a).find('.js-popover-tooltip')),a.find('.saveButton').on('click',function(){var c=a.find('form').serializeFormData();c.role=$('[name="roleMenu"]').val();var d=a.find('form').validationEngine('validate');if(!1!=d){var e=jQuery.progressIndicator();b.save('createMenu',c).done(function(a){Settings_Vtiger_Index_Js.showMessage({type:'success',text:a.result.message}),app.hideModalWindow(),b.loadContent(),e.progressIndicator({mode:'hide'});});}}),a.find('form').on('submit',function(a){a.preventDefault();});},save:function f(a,b){var d=jQuery.Deferred(),e={};return e.module=app.getModuleName(),e.parent=app.getParentModuleName(),e.action='SaveAjax',e.mode=a,e.mdata=b,AppConnector.request(e).done(function(a){d.resolve(a);}).fail(function(a,b){d.reject(a,b);}),d.promise()},removeMenu:function d(a,b){var c=this;c.save('removeMenu',a).done(function(d){Settings_Vtiger_Index_Js.showMessage({type:'success',text:d.result.message}),b.delete_node(a),c.loadContent();});},registerHotkeys:function b(a){a.find('.testBtn').on('click',function(){var b=$(this),c=a.find('[name="hotkey"]').val();b.addClass('active').removeClass('btn-default').addClass('btn-warning'),Mousetrap.bind(c,function(){Settings_Vtiger_Index_Js.showMessage({type:'success',text:app.vtranslate('JS_TEST_HOTKEY_OK')}),b.removeClass('btn-warning').addClass('btn-success').removeClass('active'),Mousetrap.unbind(c);});});},registerHiddenInput:function c(a){if('CustomFilter'==a.find('#menuType').val()){var b=a.find('select[name="dataurl"] option:selected').data('tabid');a.find('[name="module"]').val(b),a.on('change','select[name="dataurl"]',function(){var b=a.find('select[name="dataurl"] option:selected').data('tabid');a.find('[name="module"]').val(b);});}},cacheFilters:!1,registerFilters:function c(a){var b=this;'Module'==a.find('#menuType').val()&&(b.cacheFilters=a.find('[name="filters"]').clone(!0,!0),a.find('[name="module"]').on('change',function(){b.loadFilters(a,$(this));}),b.loadFilters(a,a.find('[name="module"]')));},loadFilters:function d(a,b){var c=this;a.find('[name="filters"]').html(c.cacheFilters.html()),a.find('[name="filters"] option').each(function(){$(this).data('tabid')!=b.val()&&$(this).remove();}),App.Fields.Picklist.showSelect2ElementView(a.find('[name="filters"]'),{width:'100%'});},registerModalButton:function c(){var a=this,b=jQuery('.menuConfigContainer');b.find('.copyMenu').on('click',function(){var c=b.find('.copyMenuModal').clone(!0,!0),d=function(b){var c=b.find('[name=\'roles\']');App.Fields.Picklist.showSelect2ElementView(c);var d=b.find('form');d.on('submit',function(b){var c=jQuery(b.currentTarget),d=c.find('#roleList');d.length&&d.val()&&a.copyMenu(d.val()),b.preventDefault();});};app.showModalWindow(c,function(a){'function'==typeof d&&d(a);});});},copyMenu:function g(a){var b=this,c=jQuery.Deferred(),d=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),e=$('[name="roleMenu"]').val(),f={};return f.module=app.getModuleName(),f.parent=app.getParentModuleName(),f.action='SaveAjax',f.mode='copyMenu',f.fromRole=a,f.toRole=e,AppConnector.request(f).done(function(a){app.hideModalWindow(),d.progressIndicator({mode:'hide'}),b.loadContent(),c.resolve(a);}).fail(function(a){d.progressIndicator({mode:'hide'}),c.reject(a);}),c.promise()},registerEvents:function b(){var a=this;a.treeInstance=!1,a.loadMenuTree(),a.registerChangeRoleMenu(),a.registerAddMenu(),a.registerModalButton();}});
