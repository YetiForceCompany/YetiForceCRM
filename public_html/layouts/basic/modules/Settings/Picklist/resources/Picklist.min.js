'use strict';

var Settings_Picklist_Js={registerModuleChangeEvent:function a(){jQuery('#pickListModules').on('change',function(a){var b=jQuery(a.currentTarget),c=jQuery(a.currentTarget).val();if(0>=c.length)return void Settings_Vtiger_Index_Js.showMessage({type:'error',text:app.vtranslate('JS_PLEASE_SELECT_MODULE')});var d={module:app.getModuleName(),parent:app.getParentModuleName(),source_module:c,view:'IndexAjax',mode:'getPickListDetailsForModule'},e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});AppConnector.request(d).done(function(a){jQuery('#modulePickListContainer').html(a),e.progressIndicator({mode:'hide'}),App.Fields.Picklist.changeSelectElementView(jQuery('#modulePickListContainer')),Settings_Picklist_Js.registerModulePickListChangeEvent(),jQuery('#modulePickList').trigger('change');});});},registerModulePickListChangeEvent:function a(){jQuery('#modulePickList').on('change',function(a){var b={module:app.getModuleName(),parent:app.getParentModuleName(),source_module:jQuery('#pickListModules').val(),view:'IndexAjax',mode:'getPickListValueForField',pickListFieldId:jQuery(a.currentTarget).val()},c=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});AppConnector.request(b).done(function(a){jQuery('#modulePickListValuesContainer').html(a),App.Fields.Picklist.showSelect2ElementView(jQuery('#rolesList')),Settings_Picklist_Js.registerItemActions(),c.progressIndicator({mode:'hide'});});});},registerAddItemEvent:function a(){jQuery('#addItem').on('click',function(){var a=jQuery('#createViewContents').find('.modal'),b=a.clone(!0,!0).removeClass('basicCreateView').addClass('createView');b.find('.rolesList').addClass('select2');var c=function(a){jQuery('[name="addItemForm"]',a).validationEngine(),Settings_Picklist_Js.registerAddItemSaveEvent(a),Settings_Picklist_Js.regiserSelectRolesEvent(a);};app.showModalWindow(b,function(a){'function'==typeof c&&c(a);});});},registerAssingValueToRuleEvent:function a(){jQuery('#assignValue').on('click',function(){var a=jQuery('#pickListValuesTable'),b=jQuery('.selectedListItem',a);if(0<b.length){var c=[];jQuery.each(b,function(a,b){c.push(jQuery(b).closest('tr').data('key'));});}var d={module:app.getModuleName(),parent:app.getParentModuleName(),source_module:jQuery('#pickListModules').val(),view:'IndexAjax',mode:'showAssignValueToRoleView',pickListFieldId:jQuery('#modulePickList').val()};AppConnector.request(d).done(function(a){app.showModalWindow(a),jQuery('[name="addItemForm"]',jQuery(a)).validationEngine(),Settings_Picklist_Js.registerAssignValueToRoleSaveEvent(jQuery(a)),0<b.length&&jQuery('[name="assign_values[]"]',jQuery('#assignValueToRoleForm')).select2('val',c);});});},registerAssignValueToRoleSaveEvent:function a(){jQuery('#assignValueToRoleForm').on('submit',function(a){var b=jQuery(a.currentTarget),c=jQuery('[name="assign_values[]"]',b),d=app.getSelect2ElementFromSelect(c),e=Vtiger_MultiSelect_Validator_Js.invokeValidation(c);!0==e?d.validationEngine('hide'):d.validationEngine('showPrompt',e,'error','topLeft',!0);var f=jQuery('[name="rolesSelected[]"]',b),g=app.getSelect2ElementFromSelect(f),h=Vtiger_MultiSelect_Validator_Js.invokeValidation(f);if(!0==h?g.validationEngine('hide'):g.validationEngine('showPrompt',h,'error','bottomLeft',!0),!0!=e||!0!=h)return void a.preventDefault();b.find('[name="saveButton"]').attr('disabled','disabled');var i=jQuery(a.currentTarget).serializeFormData();AppConnector.request(i).done(function(a){'undefined'!=typeof a.result&&(app.hideModalWindow(),Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_VALUE_ASSIGNED_SUCCESSFULLY'),type:'success'}));}),a.preventDefault();});},registerEnablePickListValueClickEvent:function a(){jQuery('#listViewContents').on('click','.assignToRolePickListValue',function(a){jQuery('#saveOrder').removeAttr('disabled');var b=jQuery(a.currentTarget);b.hasClass('selectedCell')?(b.removeClass('selectedCell').addClass('unselectedCell'),b.find('[data-fa-i2svg]').remove()):(b.removeClass('unselectedCell').addClass('selectedCell'),b.prepend('<i class="fas fa-check float-left"></span>'));});},registerenableOrDisableListSaveEvent:function a(){jQuery('#saveOrder').on('click',function(a){var b=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0,elementToBlock:jQuery('.tab-content')}}),c=jQuery('.assignToRolePickListValue'),d=[],e=[];jQuery.each(c,function(a,b){var c=jQuery(b);c.hasClass('selectedCell')?e.push(c.data('id')):d.push(c.data('id'));});var f={module:app.getModuleName(),parent:app.getParentModuleName(),action:'SaveAjax',mode:'enableOrDisable',enabled_values:e,disabled_values:d,picklistName:jQuery('[name="picklistName"]').val(),rolesSelected:jQuery('#rolesList').val()};AppConnector.request(f).done(function(c){'undefined'!=typeof c.result&&(jQuery(a.currentTarget).attr('disabled','disabled'),b.progressIndicator({mode:'hide'}),Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_LIST_UPDATED_SUCCESSFULLY'),type:'success'}));});});},regiserSelectRolesEvent:function b(a){a.find('[name="rolesSelected[]"]').on('change',function(b){var c=jQuery(b.currentTarget),d=c.val();-1==jQuery.inArray('all',d)?(c.find('option').removeAttr('disabled','disabled'),a.find('.modal-body').find('.alert').remove()):(c.select2('val',''),c.select2('val','all'),c.select2('close'),c.find('option').not(':first').attr('disabled','disabled'),a.find(jQuery('.modal-body')).append('<div class="alert alert-info textAlignCenter">'+app.vtranslate('JS_ALL_ROLES_SELECTED')+'</div>'));});},registerRenameItemEvent:function b(){var a=this;jQuery('#renameItem').on('click',function(){var b=jQuery('#pickListValuesTable'),c=jQuery('.selectedListItem',b),d=c.length;if(1<d){var e={title:app.vtranslate('JS_MESSAGE'),text:app.vtranslate('JS_MORE_THAN_ONE_ITEM_SELECTED'),type:'error'};return void Vtiger_Helper_Js.showPnotify(e)}var e={module:app.getModuleName(),parent:app.getParentModuleName(),source_module:jQuery('#pickListModules').val(),view:'IndexAjax',mode:'showEditView',pickListFieldId:jQuery('#modulePickList').val(),fieldValue:c.closest('tr').data('key')};AppConnector.request(e).done(function(b){app.showModalWindow(b);var c=jQuery('#renameItemForm');a.registerScrollForNonEditablePicklistValues(c),c.validationEngine(),Settings_Picklist_Js.registerRenameItemSaveEvent();});});},registerScrollForNonEditablePicklistValues:function b(a){jQuery(a).find('.nonEditablePicklistValues').slimScroll({height:'70px',size:'6px'});},registerDeleteItemEvent:function b(){var a=this;jQuery('#deleteItem').on('click',function(){var b=jQuery('#pickListValuesTable'),c=jQuery('.selectedListItem',b),d=[];jQuery.each(c,function(a,b){d.push(jQuery(b).closest('tr').data('key'));});var e=jQuery('.pickListValue',b);if(e.length==c.length)return void Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_YOU_CANNOT_DELETE_ALL_THE_VALUES'),type:'error'});var f={module:app.getModuleName(),parent:app.getParentModuleName(),source_module:jQuery('#pickListModules').val(),view:'IndexAjax',mode:'showDeleteView',pickListFieldId:jQuery('#modulePickList').val(),fieldValue:JSON.stringify(d)};a.showDeleteItemForm(f);});},registerDeleteOptionEvent:function b(){function a(a){var b=jQuery('#replaceValue');if('undefined'!=typeof a.added){var c=a.added.id;jQuery('#replaceValue option[value="'+c+'"]').remove(),b.trigger('chosen:updated');}else{var c=a.removed.id,d=a.removed.text;b.append('<option value="'+c+'">'+d+'</option>'),b.trigger('chosen:updated');}}jQuery('[name="delete_value[]"]').on('change',function(b){a({val:b.val,added:b.added,removed:b.removed});});},registerChangeRoleEvent:function a(){jQuery('#rolesList').on('change',function(a){var b=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0,elementToBlock:jQuery('.tab-content')}}),c=jQuery(a.currentTarget),d={module:app.getModuleName(),parent:app.getParentModuleName(),view:'IndexAjax',mode:'getPickListValueByRole',rolesSelected:c.val(),pickListFieldId:jQuery('#modulePickList').val(),sourceModule:jQuery('input[name="source_module"]').val()};AppConnector.request(d).done(function(a){jQuery('#pickListValeByRoleContainer').html(a),Settings_Picklist_Js.registerenableOrDisableListSaveEvent(),b.progressIndicator({mode:'hide'});});});},registerAddItemSaveEvent:function b(a){a.find('[name="addItemForm"]').on('submit',function(b){var c=jQuery(b.currentTarget),d=c.validationEngine('validate');if(!0==d){var e=c.data('jqv').InvalidFields;0==e.length&&c.find('[name="saveButton"]').attr('disabled','disabled');var f=jQuery(b.currentTarget).serializeFormData(),g=f.newValue;f.newValue=jQuery.trim(g),AppConnector.request(f).done(function(b){if(b=b.result,b){var d=jQuery.trim(jQuery('[name="newValue"]',a).val()),e=jQuery('#dragImagePath').val(),f=jQuery('<tr class="pickListValue u-cursor-pointer"><td class="u-text-ellipsis"><img class="alignMiddle" src="'+e+'" />&nbsp;&nbsp;'+d+'</td></tr>').appendTo(jQuery('#pickListValuesTable').find('tbody'));f.attr('data-key',d),f.attr('data-key-id',b.id),app.hideModalWindow();var g={title:app.vtranslate('JS_MESSAGE'),text:app.vtranslate('JS_ITEM_ADDED_SUCCESSFULLY'),type:'success'};Vtiger_Helper_Js.showPnotify(g);var h=jQuery('[name="pickListValues"]'),i=JSON.parse(h.val());i[b.id]=d,h.val(JSON.stringify(i));}else c.find('[name="saveButton"]').attr('disabled',!1);});}b.preventDefault();});},registerRenameItemSaveEvent:function a(){jQuery('#renameItemForm').on('submit',function(a){a.preventDefault();var b=jQuery(a.currentTarget),c=b.validationEngine('validate');if(!0==c){var d=jQuery('[name="oldValue"]',b),e=d.val(),f=d.find('option[value="'+e+'"]').data('id'),g=jQuery('[name="newValue"]',b),h=jQuery.trim(g.val()),i=jQuery(a.currentTarget).serializeFormData();i.newValue=h,i.id=f;var j=b.data('jqv').InvalidFields;0==j.length&&b.find('[name="saveButton"]').attr('disabled','disabled'),AppConnector.request(i).done(function(a){if('undefined'!=typeof a.result){app.hideModalWindow();var c=e.replace(/"/g,'\\"'),d=jQuery('#dragImagePath').val(),i='<tr class="pickListValue u-cursor-pointer"><td class="u-text-ellipsis"><img class="alignMiddle" src="'+d+'" />&nbsp;&nbsp;'+h+'</td></tr>',i=jQuery(i).attr('data-key',h).attr('data-key-id',f);jQuery('[data-key="'+c+'"]').replaceWith(i);var j={title:app.vtranslate('JS_MESSAGE'),text:app.vtranslate('JS_ITEM_RENAMED_SUCCESSFULLY'),type:'success'};Vtiger_Helper_Js.showPnotify(j);var k=jQuery('[name="pickListValues"]'),l=JSON.parse(k.val());l[f]=g.val(),k.val(JSON.stringify(l));}else b.find('[name="saveButton"]').attr('disabled',!1);});}});},showDeleteItemForm:function d(a){var b=this;AppConnector.request(a).done(function(a){app.showModalWindow(a,function(a){'function'==typeof c&&c(a);});});var c=function(a){var c=a.find('#deleteItemForm');b.registerScrollForNonEditablePicklistValues(c);var d=jQuery('#pickListValuesCount').val()-1;App.Fields.Picklist.changeSelectElementView(jQuery('[name="delete_value[]"]'),'select2',{maximumSelectionLength:d,dropdownCss:{"z-index":100001}}),Settings_Picklist_Js.registerDeleteOptionEvent();var e=app.getvalidationEngineOptions(!0);e.onValidationComplete=function(a,b){if(b){var c=jQuery('[name="delete_value[]"]'),d=app.getSelect2ElementFromSelect(c),e=Vtiger_MultiSelect_Validator_Js.invokeValidation(c);if(!0!=e)return void d.validationEngine('showPrompt',e,'error','topLeft',!0);d.validationEngine('hide'),a.find('[name="saveButton"]').attr('disabled','disabled');var f=jQuery('[name="delete_value[]"]').val(),g=a.serializeFormData();AppConnector.request(g).done(function(a){if('undefined'!=typeof a.result){app.hideModalWindow();var b=jQuery('[name="pickListValues"]'),c=JSON.parse(b.val());jQuery.each(f,function(a,b){var d=b.replace(/"/g,'\\"');jQuery('[data-key-id="'+d+'"]').remove(),delete c[b];}),b.val(JSON.stringify(c));var d={title:app.vtranslate('JS_MESSAGE'),text:app.vtranslate('JS_ITEMS_DELETED_SUCCESSFULLY'),type:'success'};Vtiger_Helper_Js.showPnotify(d);}});}return !1},c.validationEngine(e);};},registerSelectPickListValueEvent:function a(){jQuery('#pickListValuesTable').on('click','.pickListValue',function(a){var b=jQuery(a.currentTarget),c=b.find('td');a.preventDefault(),a.ctrlKey?c.toggleClass('selectedListItem'):(jQuery('.pickListValue').find('td').not(c).removeClass('selectedListItem'),c.toggleClass('selectedListItem'));});},registerPickListValuesSortableEvent:function b(){var a=jQuery('tbody',jQuery('#pickListValuesTable'));a.sortable({helper:function c(a,b){return b.children().each(function(a,b){b=jQuery(b),b.width(b.width());}),b},containment:a,revert:!0,update:function a(){jQuery('#saveSequence').removeAttr('disabled');}});},registerSaveSequenceClickEvent:function a(){jQuery('#saveSequence').on('click',function(){var a=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0,elementToBlock:jQuery('.tab-content')}}),b={},c=jQuery('#pickListValuesTable').find('.pickListValue');jQuery.each(c,function(a,c){b[jQuery(c).data('key-id')]=++a;});var d={module:app.getModuleName(),parent:app.getParentModuleName(),action:'SaveAjax',mode:'saveOrder',picklistValues:b,picklistName:jQuery('[name="picklistName"]').val()};AppConnector.request(d).done(function(b){'undefined'!=typeof b.result&&(jQuery('#saveSequence').attr('disabled','disabled'),a.progressIndicator({mode:'hide'}),Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_SEQUENCE_UPDATED_SUCCESSFULLY'),type:'success'}));});});},registerAssingValueToRoleTabClickEvent:function a(){jQuery('#assignedToRoleTab').on('click',function(){jQuery('#rolesList').trigger('change');});},registerItemActions:function a(){Settings_Picklist_Js.registerAddItemEvent(),Settings_Picklist_Js.registerRenameItemEvent(),Settings_Picklist_Js.registerDeleteItemEvent(),Settings_Picklist_Js.registerSelectPickListValueEvent(),Settings_Picklist_Js.registerAssingValueToRuleEvent(),Settings_Picklist_Js.registerChangeRoleEvent(),Settings_Picklist_Js.registerAssingValueToRoleTabClickEvent(),Settings_Picklist_Js.registerPickListValuesSortableEvent(),Settings_Picklist_Js.registerSaveSequenceClickEvent();},registerEvents:function a(){Settings_Picklist_Js.registerModuleChangeEvent(),Settings_Picklist_Js.registerModulePickListChangeEvent(),Settings_Picklist_Js.registerItemActions(),Settings_Picklist_Js.registerEnablePickListValueClickEvent();}};jQuery(document).ready(function(){Settings_Picklist_Js.registerEvents();}),Vtiger_Base_Validator_Js('Vtiger_FieldLabel_Validator_Js',{invokeValidation:function d(a){var b=new Vtiger_FieldLabel_Validator_Js;b.setElement(a);var c=b.validate();if(!0!=c)return b.getError()}},{validate:function b(){var a=this.getFieldValue();return this.validateValue(a)},validateValue:function c(a){var b=/[\<\>\"\,\#]/;return !b.test(a)||(this.setError(app.vtranslate('JS_SPECIAL_CHARACTERS')+' < > " , # '+app.vtranslate('JS_NOT_ALLOWED')),!1)}});
