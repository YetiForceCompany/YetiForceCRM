'use strict';

jQuery.Class('Settings_Inventory_Index_Js',{},{duplicateCheckCache:{},edit:function f(a,b){var c=jQuery.Deferred(),d=this,e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});return AppConnector.request(a).done(function(a){var c=function(){d.duplicateCheckCache={};var a=jQuery('#formInventory'),c=app.validationEngineOptions;c.onValidationComplete=function(a,c){if(c)return d.saveDetails(a,b),c},a.validationEngine(c),a.on('submit',function(a){a.preventDefault();});};e.progressIndicator({mode:'hide'}),app.showModalWindow(a,function(a){'function'==typeof c&&c(a);},{});}).fail(function(a){c.reject(a);}),c.promise()},saveDetails:function f(a,b){var c=this,d=a.serializeFormData(),e=a.find('[type="submit"]');e.prop('disabled',!0),'undefined'==typeof d&&(d={}),c.validateName(d).done(function(f){if('undefined'==typeof f)return e.prop('disabled',!1),!1;var g=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});d.module=app.getModuleName(),d.parent=app.getParentModuleName(),d.action='SaveAjax',d.view=app.getViewName(),AppConnector.request(d).done(function(d){g.progressIndicator({mode:'hide'}),app.hideModalWindow(),'string'==typeof d&&(d=JSON.parse(d)),'true'==a.find('.addView').val()?c.addDetails(d.result):c.updateDetails(d.result,b);var e={text:app.vtranslate('JS_SAVE_CHANGES')};Settings_Vtiger_Index_Js.showMessage(e);});}).fail(function(){return e.prop('disabled',!1),!1});},addDetails:function h(a){var b=jQuery('#inventory'),c=jQuery('#currency'),d='%';if(0<c.length){var c=JSON.parse(c.val());d=c.currency_symbol;}var e=$('.inventoryTable',b);if(1===a.default){var f=' checked';e.find('.default').prop('checked',!1);}var g=jQuery('<tr class="opacity" data-id="'+a.id+'">\n\t\t\t\t\t<td class="textAlignCenter '+a.row_type+'"><label class="name">'+a.name+'</label></td>\n\t\t\t\t\t<td class="textAlignCenter '+a.row_type+'"><span class="value">'+a.value+' '+d+'</span></td>\n\t\t\t\t\t<td class="textAlignCenter '+a.row_type+'"><input class="status js-update-field" checked type="checkbox"></td>\n\t\t\t\t\t<td class="textAlignCenter '+a.row_type+'"><input class="default js-update-field"'+f+' data-field-name="default" type="checkbox">\n\t\t\t\t\t\t<div class="float-right actions">\n\t\t\t\t\t\t\t<button class="btn btn-info btn-sm text-white editInventory u-cursor-pointer" data-url="'+a._editurl+'"><span title="Edycja" class="fas fa-edit alignBottom"></span></button>\n\t\t\t\t\t\t\t<button class="removeInventory u-cursor-pointer btn btn-danger btn-sm text-white" data-url="'+a._editurl+'"><span title="Usu\u0144" class="fas fa-trash-alt alignBottom"></span></button>&nbsp;\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</td></tr>');e.append(g);},updateDetails:function e(a,b){var c=jQuery('#currency'),d='%';if(0<c.length){var c=JSON.parse(c.val());d=c.currency_symbol;}if(b.find('.name').text(a.name),b.find('.value').text(a.value+' '+d),0===a.status?b.find('.status').prop('checked',!0):b.find('.status').prop('checked',!1),1===a['default']){var f=$('.inventoryTable');f.find('.default').prop('checked',!1),b.find('.default').prop('checked',!0);}else b.find('.default').prop('checked',!1);},validateName:function h(a){var b=this,c=jQuery.Deferred(),d=a.name,e=jQuery('#formInventory'),f=e.find('[name="name"]');if(!(d in b.duplicateCheckCache))b.checkDuplicateName(a).done(function(a){b.duplicateCheckCache[d]=a.success,a.success&&(b.duplicateCheckCache.message=a.message,f.validationEngine('showPrompt',a.message,'error','bottomLeft',!0),c.reject(a)),c.resolve(a);}).fail(function(a){c.reject(a);});else if(!0==b.duplicateCheckCache[d]){var g=b.duplicateCheckCache.message;f.validationEngine('showPrompt',g,'error','bottomLeft',!0),c.reject();}else c.resolve();return c.promise()},checkDuplicateName:function g(a){var b=jQuery.Deferred(),c=a.name,d=a.id,e=app.getModuleName(),f={module:e,parent:app.getParentModuleName(),action:'SaveAjax',mode:'checkDuplicateName',name:c,id:d,view:app.getViewName()};return AppConnector.request(f).done(function(a){'string'==typeof a&&(a=JSON.parse(a));var c=a.result,d=c.success;b.resolve(c);}).fail(function(a,c){b.reject(a,c);}),b.promise()},updateCheckbox:function h(a){var b=jQuery.Deferred(),c=a.closest('tr'),d=c.data('id'),e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),f=a.data('field-name'),g={module:app.getModuleName(),parent:app.getParentModuleName(),action:'SaveAjax',id:d,view:app.getViewName()};if('status'===f)g.status=a.is(':checked')?0:1;else if('default'===f){g.default=a.is(':checked')?1:0;var i=$('.inventoryTable');1===g.default&&i.find('.default').not(a).prop('checked',!1);}return AppConnector.request(g).done(function(a){e.progressIndicator({mode:'hide'}),b.resolve(a);}).fail(function(a){e.progressIndicator({mode:'hide'}),b.reject(a);}),b.promise()},removeInventory:function d(a){var c=app.vtranslate('JS_DELETE_INVENTORY_CONFIRMATION');Vtiger_Helper_Js.showConfirmationBox({message:c}).done(function(){var b={};b.view=app.getViewName(),b.id=a.data('id'),app.saveAjax('deleteInventory',b).done(function(b){Settings_Vtiger_Index_Js.showMessage({type:'success',text:b.result.message}),a.remove();});});},registerActions:function c(){var a=this,b=jQuery('#inventory');b.find('.addInventory').on('click',function(b){var c=jQuery(b.currentTarget),d=c.data('url');a.edit(d);}),b.on('click','.editInventory',function(b){var c=jQuery(b.currentTarget),d=c.closest('tr');a.edit(c.data('url'),d);}),b.on('click','.removeInventory',function(b){var c=jQuery(b.currentTarget),d=c.closest('tr');a.removeInventory(d);}),b.on('click','[type="checkbox"]',function(b){var c=jQuery(b.currentTarget);a.updateCheckbox(c).done(function(){var a={};a.text=app.vtranslate('JS_SAVE_CHANGES'),Settings_Vtiger_Index_Js.showMessage(a);});});},registerEvents:function a(){this.registerActions();}}),jQuery(document).ready(function(){var a=new Settings_Inventory_Index_Js;a.registerEvents();});
