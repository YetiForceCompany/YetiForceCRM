'use strict';

jQuery.Class('Settings_Vtiger_Tax_Js',{},{duplicateCheckCache:{},editTax:function f(a,b){var c=jQuery.Deferred(),d=this,e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});return AppConnector.request(a).done(function(a){var c=function(){d.duplicateCheckCache={};var a=jQuery('#editTax'),c=app.validationEngineOptions;c.onValidationComplete=function(a,c){if(c)return d.saveTaxDetails(a,b),c},a.validationEngine(c),a.on('submit',function(a){a.preventDefault();});};e.progressIndicator({mode:'hide'}),app.showModalWindow(a,function(a){'function'==typeof c&&c(a);},{width:'500px'});}).fail(function(a){c.reject(a);}),c.promise()},saveTaxDetails:function e(a,b){var c=this,d=a.serializeFormData();'undefined'==typeof d&&(d={}),c.validateTaxName(d).done(function(){var e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});d.module=app.getModuleName(),d.parent=app.getParentModuleName(),d.action='TaxAjax',AppConnector.request(d).done(function(d){e.progressIndicator({mode:'hide'}),app.hideModalWindow(),'true'==a.find('.addTaxView').val()?c.addTaxDetails(d.result):c.updateTaxDetails(d.result,b);var f={text:app.vtranslate('JS_TAX_SAVED_SUCCESSFULLY')};Settings_Vtiger_Index_Js.showMessage(f);});});},addTaxDetails:function e(a){var b=jQuery('#TaxCalculationsContainer');if('0'==a.type)var c=jQuery('.inventoryTaxTable',b);else var c=jQuery('.shippingTaxTable',b);var d=jQuery('<tr class="opacity" data-taxid="'+a.taxid+'" data-taxtype="'+a.type+'">\n\t\t\t\t\t<td style="border-left: none;" class="textAlignCenter '+a.row_type+'"><label class="taxLabel">'+a.taxlabel+'</label></td>\n\t\t\t\t\t<td style="border-left: none;" class="textAlignCenter '+a.row_type+'"><span class="taxPercentage">'+a.percentage+'%</span></td>\n\t\t\t\t\t<td style="border-left: none;" class="textAlignCenter '+a.row_type+'"><input class="editTaxStatus" type="checkbox" checked>\n\t\t\t\t\t\t<div class="pull-right actions">\n\t\t\t\t\t\t\t<a class="editTax u-cursor-pointer" data-url="'+a._editurl+'">\n\t\t\t\t\t\t\t\t<i class="fas fa-edit alignBottom" title="'+app.vtranslate('JS_EDIT')+'"></i>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</td></tr>');c.append(d);},updateTaxDetails:function c(a,b){b.find('.taxLabel').text(a.taxlabel),b.find('.taxPercentage').text(a.percentage+'%'),'0'==a.deleted?b.find('.editTaxStatus').attr('checked','true'):b.find('.editTaxStatus').removeAttr('checked');},validateTaxName:function h(a){var b=this,c=jQuery.Deferred(),d=a.taxlabel,e=jQuery('#editTax'),f=e.find('[name="taxlabel"]');if(!(d in b.duplicateCheckCache))b.checkDuplicateName(a).done(function(a){b.duplicateCheckCache[d]=a.success,c.resolve();}).fail(function(a){b.duplicateCheckCache[d]=a.success,b.duplicateCheckCache.message=a.message,f.validationEngine('showPrompt',a.message,'error','bottomLeft',!0),c.reject(a);});else if(!0==b.duplicateCheckCache[d]){var g=b.duplicateCheckCache.message;f.validationEngine('showPrompt',g,'error','bottomLeft',!0),c.reject();}else c.resolve();return c.promise()},checkDuplicateName:function g(a){var b=jQuery.Deferred(),c=a.taxlabel,d=a.taxid,e=app.getModuleName(),f={module:e,parent:app.getParentModuleName(),action:'TaxAjax',mode:'checkDuplicateName',taxlabel:c,taxid:d,type:a.type};return AppConnector.request(f).done(function(a){var c=a.result,d=c.success;!0==d?b.reject(c):b.resolve(c);}).fail(function(a,c){b.reject(a,c);}),b.promise()},updateTaxStatus:function i(a){var b=jQuery.Deferred(),c=a.closest('tr'),d=c.data('taxid'),e=c.data('taxtype'),f=a.is(':checked')?0:1,g=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),h={module:app.getModuleName(),parent:app.getParentModuleName(),action:'TaxAjax',taxid:d,type:e,deleted:f};return AppConnector.request(h).done(function(a){g.progressIndicator({mode:'hide'}),b.resolve(a);}).fail(function(a){g.progressIndicator({mode:'hide'}),b.reject(a);}),b.promise()},registerActions:function c(){var a=this,b=jQuery('#TaxCalculationsContainer');b.find('.addTax').on('click',function(b){var c=jQuery(b.currentTarget),d=c.data('url')+'&type='+c.data('type');a.editTax(d);}),b.on('click','.editTax',function(b){var c=jQuery(b.currentTarget),d=c.closest('tr');a.editTax(c.data('url'),d);}),b.on('click','.editTaxStatus',function(b){var c=jQuery(b.currentTarget);a.updateTaxStatus(c).done(function(){var a={};a.text=c.is(':checked')?app.vtranslate('JS_TAX_ENABLED'):app.vtranslate('JS_TAX_DISABLED'),Settings_Vtiger_Index_Js.showMessage(a);});});},registerEvents:function a(){this.registerActions();}}),jQuery(document).ready(function(){var a=new Settings_Vtiger_Tax_Js;a.registerEvents();});
