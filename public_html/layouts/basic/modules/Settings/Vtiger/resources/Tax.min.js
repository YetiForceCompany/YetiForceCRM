
jQuery.Class("Settings_Vtiger_Tax_Js",{},{duplicateCheckCache:{},editTax:function(c,a){var b=jQuery.Deferred();var d=this;var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(c).then(function(g){var f=function(i){d.duplicateCheckCache={};var h=jQuery("#editTax");var j=app.validationEngineOptions;j.onValidationComplete=function(l,k){if(k){d.saveTaxDetails(l,a);return k}};h.validationEngine(j);h.submit(function(k){k.preventDefault()})};e.progressIndicator({mode:"hide"});app.showModalWindow(g,function(h){if(typeof f=="function"){f(h)}},{width:"500px"})},function(f){b.reject(f)});return b.promise()},saveTaxDetails:function(c,a){var b=this;var d=c.serializeFormData();if(typeof d=="undefined"){d={}}b.validateTaxName(d).then(function(e){var f=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});d.module=app.getModuleName();d.parent=app.getParentModuleName();d.action="TaxAjax";AppConnector.request(d).then(function(g){f.progressIndicator({mode:"hide"});app.hideModalWindow();if(c.find(".addTaxView").val()=="true"){b.addTaxDetails(g.result)}else{b.updateTaxDetails(g.result,a)}var h={text:app.vtranslate("JS_TAX_SAVED_SUCCESSFULLY")};Settings_Vtiger_Index_Js.showMessage(h)})},function(f,e){})},addTaxDetails:function(c){var a=jQuery("#TaxCalculationsContainer");if(c.type=="0"){var b=jQuery(".inventoryTaxTable",a)}else{var b=jQuery(".shippingTaxTable",a)}var d=jQuery('<tr class="opacity" data-taxid="'+c.taxid+'" data-taxtype="'+c.type+'">\n					<td style="border-left: none;" class="textAlignCenter '+c.row_type+'"><label class="taxLabel">'+c.taxlabel+'</label></td>\n					<td style="border-left: none;" class="textAlignCenter '+c.row_type+'"><span class="taxPercentage">'+c.percentage+'%</span></td>\n					<td style="border-left: none;" class="textAlignCenter '+c.row_type+'"><input class="editTaxStatus" type="checkbox" checked>\n						<div class="pull-right actions">\n							<a class="editTax cursorPointer" data-url="'+c._editurl+'">\n								<i class="fas fa-edit alignBottom" title="'+app.vtranslate("JS_EDIT")+'"></i>\n							</a>\n						</div>\n					</td></tr>');b.append(d)},updateTaxDetails:function(b,a){a.find(".taxLabel").text(b.taxlabel);a.find(".taxPercentage").text(b.percentage+"%");if(b.deleted=="0"){a.find(".editTaxStatus").attr("checked","true")}else{a.find(".editTaxStatus").removeAttr("checked")}},validateTaxName:function(g){var e=this;var b=jQuery.Deferred();var f=g.taxlabel;var d=jQuery("#editTax");var c=d.find('[name="taxlabel"]');if(!(f in e.duplicateCheckCache)){e.checkDuplicateName(g).then(function(h){e.duplicateCheckCache[f]=h.success;b.resolve()},function(i,h){e.duplicateCheckCache[f]=i.success;e.duplicateCheckCache.message=i.message;c.validationEngine("showPrompt",i.message,"error","bottomLeft",true);b.reject(i)})}else{if(e.duplicateCheckCache[f]==true){var a=e.duplicateCheckCache.message;c.validationEngine("showPrompt",a,"error","bottomLeft",true);b.reject()}else{b.resolve()}}return b.promise()},checkDuplicateName:function(d){var a=jQuery.Deferred();var e=d.taxlabel;var c=d.taxid;var b=app.getModuleName();var f={module:b,parent:app.getParentModuleName(),action:"TaxAjax",mode:"checkDuplicateName",taxlabel:e,taxid:c,type:d.type};AppConnector.request(f).then(function(i){var h=i.result;var g=h.success;if(g==true){a.reject(h)}else{a.resolve(h)}},function(g,h){a.reject()});return a.promise()},updateTaxStatus:function(f){var c=jQuery.Deferred();var b=f.closest("tr");var d=b.data("taxid");var h=b.data("taxtype");var a=f.is(":checked")?0:1;var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var g={module:app.getModuleName(),parent:app.getParentModuleName(),action:"TaxAjax",taxid:d,type:h,deleted:a};AppConnector.request(g).then(function(i){e.progressIndicator({mode:"hide"});c.resolve(i)},function(i,j){e.progressIndicator({mode:"hide"});c.reject(i)});return c.promise()},registerActions:function(){var b=this;var a=jQuery("#TaxCalculationsContainer");a.find(".addTax").click(function(f){var c=jQuery(f.currentTarget);var d=c.data("url")+"&type="+c.data("type");b.editTax(d)});a.on("click",".editTax",function(f){var d=jQuery(f.currentTarget);var c=d.closest("tr");b.editTax(d.data("url"),c)});a.on("click",".editTaxStatus",function(d){var c=jQuery(d.currentTarget);b.updateTaxStatus(c).then(function(e){var f={};if(c.is(":checked")){f.text=app.vtranslate("JS_TAX_ENABLED")}else{f.text=app.vtranslate("JS_TAX_DISABLED")}Settings_Vtiger_Index_Js.showMessage(f)},function(e){})})},registerEvents:function(){this.registerActions()}});jQuery(document).ready(function(a){var b=new Settings_Vtiger_Tax_Js();b.registerEvents()});