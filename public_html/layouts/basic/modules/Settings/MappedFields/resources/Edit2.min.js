'use strict';

Settings_MappedFields_Edit_Js('Settings_MappedFields_Edit2_Js',{},{step2Container:!1,advanceFilterInstance:!1,restictName:['__vtrftk','mode','module','parent','record','view'],init:function a(){this.initialize();},getContainer:function a(){return this.step2Container},setContainer:function b(a){return this.step2Container=a,this},initialize:function b(a){'undefined'==typeof a&&(a=jQuery('#mf_step2')),a.is('#mf_step2')?this.setContainer(a):this.setContainer(jQuery('#mf_step2'));},submit:function e(){var a=jQuery.Deferred(),b=this.getContainer(),c=b.serializeFormData(),d=this.getData(c);return d.record=c.record,this.validationMappingFields().done(function(e){if(e){var f=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}});app.saveAjax('step2',d).done(function(d){if(!0==d.success){Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_MF_SAVED_SUCCESSFULLY')});var e=jQuery('[name="record"]',b);''===e.val()&&(e.val(d.result.id),c.record=d.result.id),c.record=d.result.id,AppConnector.request(c).done(function(c){b.hide(),f.progressIndicator({mode:'hide'}),a.resolve(c);}).fail(function(a,b){app.errorLog(a,b);});}});}else a.resolve(!1);}),a.promise()},getData:function f(a){var b=[],c=[];for(var d in a){var e=d.split('][');2==e.length?'default]'!=e[1]&&0!=a[d]?b[d]=a[d]:'default]'==e[1]&&(b[d]=jQuery.isArray(a[d])?a[d].join(','):a[d].trim()):2!=e.length&&-1==jQuery.inArray(d,this.restictName)&&(c[d]=a[d]);}return b=jQuery.extend({},b),c=jQuery.extend({},c),{mapping:b,otherConditions:JSON.stringify(c)}},registerCancelStepClickEvent:function b(a){jQuery('button.cancelLink',a).on('click',function(){window.history.back();});},registerEvents:function c(){var a=this.getContainer(),b=app.validationEngineOptions;b.onValidationComplete=function(a,b){return b},b.promptPosition='bottomRight',a.validationEngine(b),App.Fields.Picklist.showSelect2ElementView(a.find('.select2')),this.registerCancelStepClickEvent(a),this.registerEventsForEditView(),app.showPopoverElementView(a.find('.js-popover-tooltip'));},registerEventForAddingNewMapping:function b(){var a=this;jQuery('#addMapping').on('click',function(){var b=jQuery('#mappingToGenerate'),c=b.find('tr:not(.d-none)[sequence-number]').last(),d=a.getSequenceNumber(c)+1,e=jQuery('.newMapping').clone(!0,!0);e.attr('sequence-number',d),e.find('select.sourceFields.newSelect').attr('name','mapping['+d+'][source]'),e.find('select.targetFields.newSelect').attr('name','mapping['+d+'][target]'),e.find('input.mappingType').attr('name','mapping['+d+'][type]'),e.removeClass('d-none newMapping'),e.appendTo(b),e.find('.newSelect').removeClass('newSelect').addClass('select2');var f=e.find('.select2');App.Fields.Picklist.showSelect2ElementView(f),jQuery('select.targetFields',e).trigger('change',!1),a.loadDefaultValueWidgetForMappedFields(e.find('.select2'));});},getSequenceNumber:function c(a){if(a.length)var b=a.attr('sequence-number');else b=0;return parseInt(b)},registerOnChangeEventForSourceModule:function c(){var b=this.getContainer();b.on('change','.sourceFields',function(a){var c=jQuery(a.currentTarget),d=jQuery(c.closest('tr')),e=c.val(),f=c.find('option[value="'+e+'"]'),g=f.data('type'),h=f.data('mappingtype'),i=d.find('select.targetFields.select2'),j=b.find('.newMapping').find('.targetFields').children().clone(!0,!0),k=jQuery('<div></div>');d.find('.mappingType').val(h),j.each(function(a,b){var c=jQuery(b);c.is('option')&&(c.data('type')==g||'none'==c.data('type'))?k.append(c):c.is('optgroup')&&0<c.find('[data-type="'+g+'"]').length&&(c.children().each(function(a,b){var c=jQuery(b);c.data('type')!=g&&c.remove();}),k.append(c));}),j=!1,d.find('.selectedFieldDataType').html(f.data('type-name')?f.data('type-name'):''),i.html(k.children()),i.trigger('change',!1);});},registerEventToDeleteMapping:function b(){var a=this.getContainer();a.on('click','.deleteMapping',function(a){var b=jQuery(a.currentTarget),c=b.closest('tr');c.remove();});},loadDefaultValueWidget:function k(a){var b=this,c=a.val()+'_defaultvalue',d=jQuery('#defaultValuesElementsContainer').find('#'+c),e=a.closest('td').next(),f=e.find('input.default'),g='';f.length&&(g=f.val()),e.children().remove();var h=jQuery('#mappingToGenerate').find('#'+c);if(0!=d.length&&a.val()&&!(0<h.length)){var i=b.getSequenceNumber(a.closest('tr')),j=d.clone(!0,!0);j.prop('disabled',!1).attr('name','mapping['+i+'][default]'),j.is(':checkbox')&&g?j.prop('checked',!0):g&&(g='undefined'==typeof j.attr('multiple')?g:g.split(','),j.val(g)),j.appendTo(e),App.Fields.Picklist.showSelect2ElementView(e.find('select'));}},loadDefaultValueWidgetForMappedFields:function c(a){var b=this;a.each(function(){b.loadDefaultValueWidget(jQuery(this));}),a.on('change',function(a){var c=jQuery(a.currentTarget);b.loadDefaultValueWidget(c);});},registerEventsForEditView:function a(){this.registerEventForAddingNewMapping(),this.registerOnChangeEventForSourceModule(),this.registerEventToDeleteMapping(),this.loadDefaultValueWidgetForMappedFields(jQuery('select.targetFields:not(.newSelect)'));},validationMappingFields:function c(){var a=jQuery.Deferred(),b=jQuery('#mappingToGenerate tr:not(.d-none)');return b.each(function(){var c=!1,d=jQuery(this).find('.sourceFields :selected');if(1<b.find('.sourceFields option[value="'+d.val()+'"]:selected').length){var e=jQuery('.sourceModuleName').text();c=e+': '+d.text();}var f=jQuery(this).find('.targetFields :selected');if(1<b.find('.targetFields option[value="'+f.val()+'"]:selected').length){var e=jQuery('.targetModuleName').text();c=e+': '+f.text();}if(c){var g=c+' <br />'+app.vtranslate('JS_IS_ALREADY_BEEN_MAPPED');return Settings_Vtiger_Index_Js.showMessage({text:g,type:'error'}),a.resolve(!1),!1}}),a.resolve(!0),a.promise()}});
