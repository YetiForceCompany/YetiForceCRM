'use strict';

jQuery.Class('Settings_RecordAllocation_Index_Js',{},{container:!1,registerDataTables:function c(a){var b=this;$.extend($.fn.dataTable.defaults,{language:{sLengthMenu:app.vtranslate('JS_S_LENGTH_MENU'),sZeroRecords:app.vtranslate('JS_NO_RESULTS_FOUND'),sInfo:app.vtranslate('JS_S_INFO'),sInfoEmpty:app.vtranslate('JS_S_INFO_EMPTY'),sSearch:app.vtranslate('JS_SEARCH'),sEmptyTable:app.vtranslate('JS_NO_RESULTS_FOUND'),sInfoFiltered:app.vtranslate('JS_S_INFO_FILTERED'),sLoadingRecords:app.vtranslate('JS_LOADING_OF_RECORDS'),sProcessing:app.vtranslate('JS_LOADING_OF_RECORDS'),oAria:{sSortAscending:app.vtranslate('JS_S_SORT_ASCENDING'),sSortDescending:app.vtranslate('JS_S_SORT_DESCENDING')}}}),a==null&&(a=b.getContainer()),a.find('.js-data-table').dataTable({scrollY:200,deferRender:!0,scroller:!0,paging:!1,info:!1});},registerDragDropEvent:function e(a){var b=this;if(null!=a){var c=a.closest('.js-panel'),d=c.data('index');a.find('.js-drag-drop-'+d).draggable({appendTo:'body',helper:'clone',start:function d(a,b){var c=$(b.helper.context).width();$(b.helper).css('width',c).addClass('dataTableDragDrop bg-primary');},zIndex:9999999999}),a.find('.dataTables_scrollBody .js-data-table').droppable({activeClass:'ui-state-default',hoverClass:'ui-state-hover',accept:'.js-drag-drop-'+d,drop:function f(a,c){var d=$(c.draggable).closest('.js-data-table'),e=$(this);if(d.data('mode')!=e.data('mode')){d.DataTable().row(c.draggable).remove().draw(),e.DataTable().row.add(c.draggable[0]).draw();var e='active'==e.data('mode')?e:d;b.save(e.closest('.js-panel'));}}});}},save:function e(a){var b={module:a.data('modulename'),userid:a.find('.js-base-user').val(),type:app.getMainParams('fieldType')},c=[],d=a.find('.dataTables_scrollBody:first tbody tr');d.each(function(){var a=jQuery(this).data('id'),b=jQuery(this).data('type');a&&b&&(!c[b]&&(c[b]=[]),c[b].push(a));}),b.ids=jQuery.extend({},c),app.saveAjax('save',jQuery.extend({},b));},registerModalButton:function c(){var a=this,b=this.getContainer();b.find('button.js-add-panel').on('click',function(){var c=b.find('.js-modal-add-panel').clone(!0,!0),d=a.getModules();c.find('select option').each(function(){-1!=$.inArray($(this).val(),d)&&$(this).remove();}),app.showModalWindow(c,function(b){var c=b.find('select');App.Fields.Picklist.showSelect2ElementView(c);var d=b.find('form');d.on('submit',function(b){var c=$(b.currentTarget),d=c.find('.js-modules-list');d.length&&d.val()&&a.addPanel(d.val()),b.preventDefault();});});});},getModules:function b(){var a=[];return this.getContainer().find('.js-panel').each(function(){a.push(jQuery(this).data('modulename'));}),a},addPanel:function g(a){var b=this,c=jQuery.Deferred(),d=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),e=this.getContainer().find('.js-panel:last'),f={};return f.index=e.data('index'),f.module=app.getModuleName(),f.parent=app.getParentModuleName(),f.sourceModule=a,f.view='Index',f.mode='getPanel',f.type=app.getMainParams('fieldType'),AppConnector.request(f).done(function(a){var e=b.getContainer().find('.js-panels-container').append(a);App.Fields.Picklist.changeSelectElementView(e.find('.chzn-select')),app.hideModalWindow(),d.progressIndicator({mode:'hide'}),c.resolve(a);},function(a){d.progressIndicator({mode:'hide'}),c.reject(a);}),c.promise()},registerLoadData:function b(){var a=this;this.getContainer().on('change','.js-base-user',function(b){var c=jQuery(b.currentTarget),d=c.closest('.js-panel-item'),e=d.find('.js-module-allocation-data').val(),f=[];e&&'null'!=e&&(f=JSON.parse(e));var g=f[c.val()],h=d.find('.js-active-panel');h.length&&h.remove();var h=d.find('.js-clear-tables').clone(!0,!0);if(g!=null){var i=h.find('.js-data-table .dropContainer:first'),j=h.find('.js-data-table .dropContainer:last');j.find('tr').each(function(){var a=jQuery(this).data('type'),b=jQuery(this).data('id');-1!=jQuery.inArray(b.toString(),g[a])&&i.append(jQuery(this));});}d.find('.js-panel-body').removeClass('d-none').append(h.removeClass('js-clear-tables d-none').addClass('js-active-panel')),a.registerDataTables(h),a.registerDragDropEvent(h);});},registerHeaderElements:function a(){this.getContainer().on('click','.js-remove-panel',function(a){var b=jQuery(a.currentTarget),c=b.closest('.js-panel'),d={module:c.data('modulename'),type:app.getMainParams('fieldType')},e=app.vtranslate('JS_ARE_YOU_SURE_YOU_WANT_TO_DELETE_PANEL');Vtiger_Helper_Js.showConfirmationBox({message:e}).done(function(){app.saveAjax('removePanel',d).done(function(){c.fadeOut(300,function(){$(this).remove();});});});}),this.registerLoadData();},getContainer:function a(){return !1==this.container&&(this.container=jQuery('div.contentsDiv')),this.container},registerEvents:function a(){this.registerModalButton(),this.registerHeaderElements();}});
