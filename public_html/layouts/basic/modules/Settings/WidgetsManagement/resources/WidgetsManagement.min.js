
jQuery.Class("Settings_WidgetsManagement_Js", {}, {widgetWithFilterUsers:[], setWidgetWithFilterUsers:function(){var b = this; var a = jQuery('[name="filter_users"]').val(); if (a){b.widgetWithFilterUsers = JSON.parse(a)} else{b.widgetWithFilterUsers = []}}, widgetWithFilterDate:[], setWidgetWithFilterDate:function(){var b = this; var a = jQuery('[name="filter_date"]').val(); if (a){b.widgetWithFilterDate = JSON.parse(a)} else{b.widgetWithFilterDate = []}}, restrictFilter:[], setRestrictFilter:function(){var b = this; var a = jQuery('[name="filter_restrict"]').val(); if (a){b.restrictFilter = JSON.parse(a)} else{b.restrictFilter = []}}, getAuthorization:function(){var b = this; var a = []; continer = jQuery("#moduleBlocks"); continer.find(".editFieldsTable").each(function(){a.push(jQuery(this).data("code"))}); return a}, getAllFieldsInBlock:function(c){var b = this; var a = []; c.find(".blockFieldsList .editFieldsWidget").each(function(){a.push(jQuery(this).data("linkid").toString())}); return a}, getCurrentDashboardId:function(){return $(".selectDashboard li.active").data("id")}, registerAddedDashboard:function(){var a = this; $(".addDashboard").on("click", function(){var b = {url:"index.php?parent=Settings&module=" + app.getModuleName() + "&view=DashboardType", sendByAjaxCb:function(){var c = $(".contentsDiv"); a.getModuleLayoutEditor("Home").then(function(d){c.html(d); a.registerEvents()})}, }; app.showModalWindow(b)})}, registerSelectDashboard:function(){var a = this; $(".selectDashboard li").on("click", function(d){var c = $(d.currentTarget); var b = c.data("id"); var f = $(".contentsDiv"); a.getModuleLayoutEditor("Home", b).then(function(e){f.html(e); a.registerEvents()})})}, registerDashboardAction:function(){var a = this; $(".editDashboard").on("click", function(d){var c = $(d.currentTarget); d.stopPropagation(); var b = {url:"index.php?parent=Settings&module=" + app.getModuleName() + "&view=DashboardType&dashboardId=" + c.closest("li").data("id"), sendByAjaxCb:function(){var e = $(".contentsDiv"); a.getModuleLayoutEditor("Home", c.closest("li").data("id")).then(function(f){e.html(f); a.registerEvents()})}, }; app.showModalWindow(b)}); $(".deleteDashboard").on("click", function(c){var b = $(c.currentTarget); c.stopPropagation(); var d = {parent:"Settings", module:app.getModuleName(), action:"Dashboard", mode:"delete", dashboardId:b.closest("li").data("id")}; AppConnector.request(d).then(function(){var e = $(".contentsDiv"); a.getModuleLayoutEditor("Home", 1).then(function(f){e.html(f); a.registerEvents()})})})}, registerAddBlockDashBoard:function(){var b = this; var a = jQuery("#layoutDashBoards"); a.find(".addBlockDashBoard").click(function(g){var f = a.find(".addBlockDashBoardModal").clone(true, true); var d = b.getAuthorization(); f.find("select.authorized option").each(function(){if (jQuery.inArray(jQuery(this).val(), d) != - 1){jQuery(this).remove()}}); var c = function(h){app.changeSelectElementView(h.find("select")); var e = h.find(".addBlockDashBoardForm"); var j = app.validationEngineOptions; var i = e.find('[name="authorized"]'); e.validationEngine(j); e.submit(function(m){if (e.validationEngine("validate")){var k = e.serializeFormData(); k.action = "addBlock"; var l = []; l.authorized = i.val(); l.label = i.find(":selected").text(); b.save(k, "save").then(function(o){var p = {}; var n = o.result; if (n.success){l.id = n.id; b.displayNewCustomBlock(l); app.hideModalWindow(); p.text = app.vtranslate("JS_BLOCK_ADDED")} else{p.text = n.message; p.type = "error"}Settings_Vtiger_Index_Js.showMessage(p)})}m.preventDefault()})}; app.showModalWindow(f, function(e){if (typeof c == "function"){c(e)}}, {width:"1000px"})})}, save:function(c, f){var b = this; var a = jQuery.Deferred(); var d = jQuery.progressIndicator({position:"html", blockInfo:{enabled:true}}); var e = {}; e.form = c; e.module = app.getModuleName(); e.parent = app.getParentModuleName(); e.sourceModule = jQuery("#selectedModuleName").val(); e.action = "SaveAjax"; e.mode = f; AppConnector.request(e).then(function(g){d.progressIndicator({mode:"hide"}); a.resolve(g)}, function(g){d.progressIndicator({mode:"hide"}); a.reject(g)}); return a.promise()}, displayNewCustomBlock:function(a){var d = this; var c = jQuery("#layoutDashBoards"); var b = c.find(".newCustomBlockCopy").clone(true, true); b.data("block-id", a.id).find(".blockLabel span").append(jQuery("<strong>" + a.label + "</strong>")); b.find(".addCustomField").removeClass("hide").show(); b.find(".specialWidget").data("block-id", a.id); c.find("#moduleBlocks").append(b.removeClass("newCustomBlockCopy hide").addClass("editFieldsTable block_" + a.id).data("code", a.authorized))}, addClickOutSideEvent:function(b, a){b.one("clickoutside", a)}, registerAddCustomFieldEvent:function(){var b = this; var a = jQuery("#layoutDashBoards"); a.find(".addCustomField").click(function(k){var j = jQuery(k.currentTarget).closest(".editFieldsTable"); var f = j.data("block-id"); var m = a.find(".createFieldModal").clone(true, true); var c = b.getAllFieldsInBlock(j); var l = m.find("select.widgets"); l.find("option").each(function(){if (jQuery.inArray(jQuery(this).val(), c) != - 1){jQuery(this).remove()}}); var d = l.find(":first-child").data("name"); if (jQuery.inArray(d, b.widgetWithFilterUsers) != - 1){m.find(".widgetFilter").removeClass("hide").find("select").removeAttr("disabled").show(); var n = b.restrictFilter[d]; if (n){for (var h in n){m.find('.widgetFilter select option[value="' + n[h] + '"]').remove()}}}if (jQuery.inArray(d, b.widgetWithFilterDate) != - 1){m.find(".widgetFilterDate").removeClass("hide").find("select").removeAttr("disabled").show()}var g = function(o){app.showSelect2ElementView(o.find("select")); o.find("select.widgets").on("change", function(){o.find(".widgetFilter").remove(); o.find(".widgetFilterDate").remove(); var u = a.find(".createFieldModal .widgetFilter").clone(true, true); var r = a.find(".createFieldModal .widgetFilterDate").clone(true, true); o.find(".modal-body").append(u); o.find(".modal-body").append(r); var q = jQuery(this).find(":selected").data("name"); if (jQuery.inArray(q, b.widgetWithFilterUsers) != - 1){u.removeClass("hide").find("select").prop("disabled", false); var t = b.restrictFilter[q]; if (t){for (var s in t){m.find('.widgetFilter select option[value="' + t[s] + '"]').remove()}}app.showSelect2ElementView(u.find("select"))} else{u.addClass("hide").find("select").prop("disabled", true)}if (jQuery.inArray(q, b.widgetWithFilterDate) != - 1){r.removeClass("hide").find("select").prop("disabled", false); app.showSelect2ElementView(r.find("select"))} else{r.addClass("hide").find("select").prop("disabled", true)}}); var i = o.find(".createCustomFieldForm"); i.attr("id", "createFieldForm"); var e = i.find('[name="widgets"]'); var p = app.validationEngineOptions; p.onValidationComplete = function(s, r){if (r){if (e.val()){var t = s.find(":submit"); t.attr("disabled", "disabled"); var u = s.find('[name="widgets"]'); paramsForm = s.serializeFormData(); paramsForm.action = "addWidget"; paramsForm.blockid = f; paramsForm.linkid = u.val(); paramsForm.label = u.find(":selected").text(); paramsForm.name = u.find(":selected").data("name"); paramsForm.height = s.find('[name="height"]').val(); paramsForm.width = s.find('[name="width"]').val(); if (s.find('[name="isdefault"]').prop("checked")){paramsForm.isdefault = 1}if (s.find('[name="cache"]').prop("checked")){paramsForm.cache = 1}if (paramsForm.default_owner && typeof paramsForm.owners_all == "undefined"){var q = app.vtranslate("JS_FIELD_EMPTY"); s.find('select[name="owners_all"]').prev("div").validationEngine("showPrompt", q, "error", "bottomLeft", true); t.removeAttr("disabled"); k.preventDefault(); return false}b.save(paramsForm, "save").then(function(y){var v = y.result; var z = {}; if (y.success){app.hideModalWindow(); paramsForm.id = v.id; paramsForm.status = v.status; z.text = app.vtranslate("JS_WIDGET_ADDED"); Settings_Vtiger_Index_Js.showMessage(z); b.showCustomField(paramsForm)} else{var x = y.error["message"]; if (y.error["code"] != 513){var w = s.find('[name="fieldName"]')} else{var w = s.find('[name="fieldLabel"]')}w.validationEngine("showPrompt", x, "error", "topLeft", true); t.removeAttr("disabled")}})} else{var q = app.vtranslate("JS_FIELD_EMPTY"); e.prev("div").validationEngine("showPrompt", q, "error", "topLeft", true); k.preventDefault(); return}}return false}; i.validationEngine(p)}; app.showModalWindow(m, function(e){if (typeof g == "function"){g(e)}}, {width:"1000px"})})}, showCustomField:function(l){var j = this; var d = jQuery("#layoutDashBoards"); var i = d.find(".block_" + l.blockid); var k = d.find(".newCustomFieldCopy").clone(true, true); var h = k.find("div.marginLeftZero.border1px"); h.addClass("opacity editFieldsWidget").attr("data-field-id", l.id).attr("data-block-id", l.blockid).attr("data-linkid", l.linkid); h.find(".deleteCustomField, .saveFieldDetails").attr("data-field-id", l.id); if (l.title){h.find(".fieldLabel").html(l.title)} else{h.find(".fieldLabel").html(l.label)}if (!l.status){h.find('input[name="limit"]').closest("div.limit").remove()}if (typeof l.default_owner != "undefined"){h.find(".widgetFilterAll").removeClass("hide").show()}var f = i.find(".blockFieldsList"); var g = f.find("ul[name=sortable1]"); var c = g.children().length; var e = f.find("ul[name=sortable2]"); var b = e.children().length; if (c > b){e.append(k.removeClass("hide newCustomFieldCopy"))} else{g.append(k.removeClass("hide newCustomFieldCopy"))}var a = k.find("form.fieldDetailsForm"); j.setFieldDetails(l, a)}, setFieldDetails:function(a, e){var d = this; e.find(".modal-header").html(jQuery("<strong>" + a.label + '</strong><div class="pull-right"><a href="javascript:void(0)" class="cancel">X</a></div>')); if (a.isdefault){e.find('[name="isdefault"]').filter(":checkbox").attr("checked", true)}if (a.cache){e.find('[name="cache"]').filter(":checkbox").attr("checked", true)}if (a.width){e.find('select[name="width"]').find("option").removeAttr("selected"); e.find('select[name="width"]').find('option[value="' + a.width + '"]').attr("selected", "selected")}if (a.height){e.find('select[name="height"]').find("option").removeAttr("selected"); e.find('select[name="height"]').find('option[value="' + a.height + '"]').attr("selected", "selected")}if (a.default_owner){e.find('select[name="default_owner"]').find("option").removeAttr("selected"); e.find('select[name="default_owner"]').find('option[value="' + a.default_owner + '"]').attr("selected", "selected")}if (a.owners_all){e.find('select[name="owners_all"]').find("option").removeAttr("selected"); var f = a.owners_all; if (typeof (f) != "string"){for (var c = 0; c < f.length; c++){var b = f[c].replace(/"/g, '\\"'); e.find('select[name="owners_all"]').find('option[value="' + b + '"]').attr("selected", "selected")}} else{e.find('select[name="owners_all"]').find('option[value="' + f + '"]').attr("selected", "selected")}}}, registerEditFieldDetailsClick:function(){var a = this; contents = jQuery("#layoutDashBoards"); contents.find(".editFieldDetails").click(function(p){var f = jQuery(p.currentTarget); var g = f.closest("div.editFieldsWidget"); g.removeClass("opacity"); var l = g.find(".basicFieldOperations"); var s = f.closest(".btn-group"); s.find(".dropdown-menu").remove(); var j = l.clone().removeClass("basicFieldOperations hide").addClass("dropdown-menu"); s.append(j); var d = s.find(".dropdown-menu"); var i = app.getvalidationEngineOptions(true); i.binded = false; i.onValidationComplete = function(t, e){if (e){if (t == undefined){return true}var u = t.serializeFormData(); if (t.find('[name="isdefault"]').prop("checked")){u.isdefault = 1}if (t.find('[name="cache"]').prop("checked")){u.cache = 1}var w = t.find(".saveFieldDetails").data("field-id"); u.action = "saveDetails"; u.id = w; if (u.default_owner && typeof u.owners_all == "undefined"){var v = {}; v.type = "error"; v.text = app.vtranslate("JS_FILTERS_AVAILABLE") + ": " + app.vtranslate("JS_FIELD_EMPTY"); Settings_Vtiger_Index_Js.showMessage(v); p.preventDefault(); return false}a.save(u, "save"); a.registerSaveFieldDetailsEvent(t)}return false}; d.find("form").validationEngine(i); var o = l.find('select[name="owners_all"]'); if (o.length > 0){var c = d.find('select[name="owners_all"]'); app.showSelectizeElementView(c)}o = l.find('select[name="default_date"]'); if (o.length > 0){var c = d.find('select[name="default_date"]'); app.showSelect2ElementView(c)}a.avoidDropDownClick(s); d.on("change", ":checkbox", function(v){var u = jQuery(v.currentTarget); if (u.attr("readonly") == "readonly"){var t = jQuery(v.currentTarget).is(":checked"); if (!t){jQuery(v.currentTarget).attr("checked", "checked")} else{jQuery(v.currentTarget).removeAttr("checked")}v.preventDefault()}}); var k = f.offset(), r = f.outerHeight(), h = j.outerHeight(), n = $(window).scrollTop() + document.documentElement.clientHeight, b = k.top + r, q = b + h <= n; if (!q){j.addClass("bottom-up")} else{j.removeClass("bottom-up")}var m = function(){g.addClass("opacity"); j.remove()}; a.addClickOutSideEvent(j, m); jQuery(".cancel").click(function(){m()})})}, registerSaveFieldDetailsEvent:function(a){var i = this; var e = a.find(".saveFieldDetails"); var h = e.data("field-id"); var g = e.closest(".editFieldsTable"); var d = g.data("block-id"); e.closest(".btn-group").removeClass("open"); var c = e.closest(".editFieldsWidget"); c.addClass("opacity"); var b = a.closest(".dropdown-menu"); app.destroySelectizeElement(a); a.find("select").each(function(){var l = jQuery(this).val(); jQuery(this).find("option").removeAttr("selected"); if (typeof (jQuery(this).attr("multiple")) == "undefined"){var j = l.replace(/"/g, '\\"'); jQuery(this).find('[value="' + j + '"]').attr("selected", "selected")} else{for (var k = 0; k < l.length; k++){var j = l[k].replace(/"/g, '\\"'); jQuery(this).find('[value="' + j + '"]').attr("selected", "selected")}}}); var f = a.closest(".editFieldsWidget").find(".basicFieldOperations"); f.html(a); b.remove()}, avoidDropDownClick:function(a){a.find(".dropdown-menu").click(function(b){b.stopPropagation()})}, registerSpecialWidget:function(){var b = this; var a = jQuery("#layoutDashBoards"); a.find(".addNotebook").click(function(c){b.addNoteBookWidget(this, jQuery(this).data("url"))}); a.find(".addCharts").click(function(c){b.addChartWidget($(c.currentTarget))}); a.find(".addMiniList").click(function(c){b.addMiniListWidget(this, jQuery(this).data("url"))}); a.find(".addChartFilter").click(function(c){b.addChartFilterWidget(this, jQuery(this).data("url"))}); a.find(".addRss").click(function(c){b.addRssWidget($(c.currentTarget), jQuery(this).data("url"))})}, addRssWidget:function(c, b){var d = this; var a = {url:"index.php?module=" + app.getModuleName() + "&parent=" + app.getParentModuleName() + "&view=AddRss", cb:function(e){e.find(".removeChannel").on("click", function(i){var h = $(i.currentTarget); var j = h.closest(".form-group"); j.remove()}); e.find(".addChannel").on("click", function(j){var h = e.find(".newChannel").clone(); var i = e.find(".formContainer"); i.append(h); h.removeClass("hide"); h.removeClass("newChannel"); h.find("input").removeAttr("disabled"); h.find(".removeChannel").on("click", function(l){var k = $(l.currentTarget); var m = k.closest(".form-group"); m.remove()})}); e.find('[name="blockid"]').val(c.data("blockId")); e.find('[name="linkid"]').val(c.data("linkid")); var f = e.find("form"); var g = f.find('[type="submit"]'); g.on("click", function(j){var h = []; if (f.validationEngine("validate")){f.find(".channelRss:not(:disabled)").each(function(){h.push(jQuery(this).val())}); var i = f.serializeFormData(); i.data = JSON.stringify({channels:h}); d.save(i, "save").then(function(k){i.label = i.title; d.saveAfterInfo(k, i)})}j.preventDefault()})}, }; app.showModalWindow(a)}, saveAfterInfo:function(d, c){var b = this; var a = d.result; var e = {}; if (d.success){app.hideModalWindow(); c.id = a.id; c.status = a.status; e.text = app.vtranslate("JS_WIDGET_ADDED"); Settings_Vtiger_Index_Js.showMessage(e); b.showCustomField(c)}}, addChartFilterWidget:function(b){var c = this; b = jQuery(b); app.showModalWindow(null, "index.php?module=Home&view=ChartFilter&step=step1", function(j){var d = jQuery("form", j); var i = jQuery('select[name="chartType"]', j); var e = jQuery('select[name="module"]', j); var l = app.showSelect2ElementView(e, {placeholder:app.vtranslate("JS_SELECT_MODULE")}); var h = jQuery(".step1", j); var g = jQuery(".step2", j); var f = jQuery(".step3", j); var k = jQuery(".modal-footer", j); g.remove(); f.remove(); k.hide(); i.on("change", function(o){var n = $(o.currentTarget); var m = n.val(); if (m == "Barchat" || m == "Horizontal"){d.find(".isColorContainer").removeClass("hide")} else{d.find(".isColorContainer").addClass("hide")}if (j.find("#widgetStep").val() == 4){j.find(".step3 .groupField").trigger("change")}}); l.change(function(){if (!l.val()){return}k.hide(); j.find(".step2").remove(); j.find(".step3").remove(); AppConnector.request({module:"Home", view:"ChartFilter", step:"step2", selectedModule:l.val()}).then(function(p){h.after(p); j.find("#widgetStep").val(2); var n = j.find(".step2"); app.showSelect2ElementView(n.find("select")); k.hide(); var m = n.find(".filterId"); var o = n.find(".valueType"); n.find(".filterId, .valueType").change(function(){if (!m.val() || !o.val()){return}j.find(".step3").remove(); j.find(".step4").remove(); AppConnector.request({module:"Home", view:"ChartFilter", step:"step3", selectedModule:l.val(), filterid:m.val(), valueType:o.val()}).then(function(r){n.last().after(r); j.find("#widgetStep").val(3); var q = j.find(".step3"); app.showSelect2ElementView(q.find("select")); k.hide(); q.find(".groupField").change(function(){j.find(".step4").remove(); var s = $(this); if (!s.val()){return}k.show(); AppConnector.request({module:"Home", view:"ChartFilter", step:"step4", selectedModule:l.val(), filterid:m.val(), groupField:s.val(), chartType:i.val()}).then(function(t){q.last().after(t); j.find("#widgetStep").val(4); var u = j.find(".step4"); app.showSelect2ElementView(u.find("select"))})})})})})}); d.submit(function(q){q.preventDefault(); var m = l.val(); var t = l.find(":selected").text(); var r = d.find(".filterId").val(); var u = d.find(".filterId").find(":selected").text(); var p = d.find(".groupField").find(":selected").text(); var s = 0; var n = d.find(".isColor"); if (!n.hasClass("hide") && n.is(":checked")){s = 1}var o = {module:m, groupField:d.find(".groupField").val(), chartType:i.val(), color:s}; d.find(".saveParam").each(function(v, w){w = $(w); o[w.attr("name")] = w.val()}); a(t, r, u, p, o, d)})}); function a(f, d, h, e, j, g){var i = {}; i.data = JSON.stringify(j); i.action = "addWidget"; i.blockid = b.data("block-id"); i.linkid = b.data("linkid"); i.label = f + " - " + h + " - " + e; i.name = "ChartFilter"; i.filterid = d; i.title = g.find('[name="widgetTitle"]').val(); i.isdefault = 0; i.cache = 0; i.height = 4; i.width = 4; i.owners_all = ["mine", "all", "users", "groups"]; i.default_owner = "mine"; c.save(i, "save").then(function(n){var k = n.result; var o = {}; if (n.success){app.hideModalWindow(); i.id = k.id; i.status = k.status; o.text = app.vtranslate("JS_WIDGET_ADDED"); Settings_Vtiger_Index_Js.showMessage(o); c.showCustomField(i)} else{var m = n.error["message"]; if (n.error["code"] != 513){var l = g.find('[name="fieldName"]')} else{var l = g.find('[name="fieldLabel"]')}l.validationEngine("showPrompt", m, "error", "topLeft", true)}})}}, addChartWidget:function(a){app.showModalWindow(null, "index.php?parent=Settings&module=WidgetsManagement&view=AddChart", function(b){b.find('[name="blockid"]').val(a.data("block-id")); b.find('[name="linkId"]').val(a.data("linkid"))})}, addNoteBookWidget:function(b, a){var c = this; b = jQuery(b); app.showModalWindow(null, "index.php?module=Home&view=AddNotePad", function(e){var d = jQuery("form", e); var f = app.validationEngineOptions; f.onValidationComplete = function(k, j){if (j){jQuery("[name='saveButton']", e).attr("disabled", "disabled"); var h = k.find('[name="notePadName"]').val(); var n = k.find('[name="notePadContent"]').val(); var l = 0; var m = b.data("linkid"); var g = b.data("block-id"); var i = {module:jQuery("#selectedModuleName").val(), action:"NoteBook", mode:"noteBookCreate", notePadName:h, notePadContent:n, blockid:g, linkId:m, isdefault:l, width:4, height:3}; AppConnector.request(i).then(function(p){if (p.result.success){var o = p.result.widgetId; app.hideModalWindow(); i.id = o; i.label = h; f.text = app.vtranslate("JS_WIDGET_ADDED"); Settings_Vtiger_Index_Js.showMessage(f); c.showCustomField(i)}})}return false}; d.validationEngine(f)})}, addMiniListWidget:function(b, a){var c = this; b = jQuery(b); app.showModalWindow(null, "index.php?module=Home&view=MiniListWizard&step=step1", function(j){var e = jQuery("form", j); var g = jQuery('select[name="module"]', j); var h = jQuery('select[name="filterid"]', j); var n = jQuery('select[name="fields"]', j); var f = jQuery('select[name="filter_fields"]', j); var m = app.showSelect2ElementView(g, {placeholder:app.vtranslate("JS_SELECT_MODULE")}); var i = app.showSelect2ElementView(h, {placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")}); var l = app.showSelect2ElementView(n, {placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"), closeOnSelect:true, maximumSelectionLength:6}); var d = app.showSelect2ElementView(f, {placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")}); var k = jQuery(".modal-footer", j); h.closest("tr").hide(); n.closest("tr").hide(); f.closest("tr").hide(); k.hide(); m.change(function(){if (!m.val()){return}AppConnector.request({module:"Home", view:"MiniListWizard", step:"step2", selectedModule:m.val()}).then(function(o){h.empty().html(o).trigger("change"); i.closest("tr").show(); n.closest("tr").hide(); f.closest("tr").hide()})}); i.change(function(){if (!i.val()){return}k.hide(); n.closest("tr").hide(); f.closest("tr").hide(); AppConnector.request({module:"Home", view:"MiniListWizard", step:"step3", selectedModule:m.val(), filterid:i.val()}).then(function(o){var o = jQuery(o); n.empty().html(o.find('select[name="fields"]').html()).trigger("change"); f.empty().html(o.find('select[name="filter_fields"]').html()).trigger("change"); l.closest("tr").show(); d.closest("tr").show(); l.data("select2").$selection.find(".select2-search__field").parent().css("width", "100%"); d.data("select2").$selection.find(".select2-search__field").parent().css("width", "100%")})}); l.change(function(){if (!l.val()){k.hide()} else{k.show()}}); e.submit(function(v){v.preventDefault(); var r = m.val(); var q = m.find(":selected").text(); var s = i.val(); var p = i.find(":selected").text(); var o = []; l.select2("data").map(function(w){o.push(w.id)}); var u = {module:r}; if (typeof o != "object"){o = [o]}u.fields = o; u.filterFields = d.val(); var t = {data:JSON.stringify(u), action:"addWidget", blockid:b.data("block-id"), title:e.find('[name="widgetTitle"]').val(), linkid:b.data("linkid"), label:q + " - " + p, name:"Mini List", filterid:s, isdefault:0, cache:0, height:4, width:4, owners_all:["mine", "all", "users", "groups"], default_owner:"mine"}; c.save(t, "save").then(function(z){var w = z.result; var A = {}; if (z.success){app.hideModalWindow(); t.id = w.id; t.status = w.status; A.text = app.vtranslate("JS_WIDGET_ADDED"); Settings_Vtiger_Index_Js.showMessage(A); c.showCustomField(t)} else{var y = z.error["message"]; if (z.error["code"] != 513){var x = e.find('[name="fieldName"]')} else{var x = e.find('[name="fieldLabel"]')}x.validationEngine("showPrompt", y, "error", "topLeft", true)}})})})}, registerDeleteCustomFieldEvent:function(b){var a = this; if (typeof b == "undefined"){b = jQuery("#layoutDashBoards")}b.find("a.deleteCustomField").click(function(h){var g = jQuery(h.currentTarget); var c = g.data("field-id"); var f = {}; f.action = "removeWidget"; f.id = c; var d = app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE"); Vtiger_Helper_Js.showConfirmationBox({message:d}).then(function(i){a.save(f, "delete").then(function(j){var k = g.closest("div.editFieldsWidget"); var e = k.data("block-id"); k.parent().fadeOut("slow").remove(); var m = jQuery("#block_" + e); a.reArrangeBlockFields(m); var l = {}; l.text = app.vtranslate("JS_CUSTOM_FIELD_DELETED"); Settings_Vtiger_Index_Js.showMessage(l)}, function(e, j){})}, function(e, i){})})}, reArrangeBlockFields:function(e){var a = e.find("ul[name=sortable1]"); var c = e.find("ul[name=sortable2]"); if (a.children().length < c.children().length){var b = c.children(":last"); a.append(b)} else{if (a.children().length > c.children().length + 1){var d = a.children(":last"); c.append(d)}}}, registerDeleteCustomBlockEvent:function(){var c = this; var b = jQuery("#layoutDashBoards"); var a = b.find(".editFieldsTable"); b.on("click", ".deleteCustomBlock", function(j){var i = jQuery(j.currentTarget); var h = i.closest("div.editFieldsTable"); var f = h.data("block-id"); var d = {}; d.blockid = f; d.action = "removeBlock"; var g = app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE"); Vtiger_Helper_Js.showConfirmationBox({message:g}).then(function(k){c.save(d, "delete").then(function(e){c.removeDeletedBlock(f, "delete"); var l = {}; l.text = app.vtranslate("JS_CUSTOM_BLOCK_DELETED"); Settings_Vtiger_Index_Js.showMessage(l)}, function(e, l){})}, function(e, k){})})}, removeDeletedBlock:function(a){var b = jQuery("#layoutDashBoards"); var c = b.find(".block_" + a); c.fadeOut("slow").remove()}, registerModulesChangeEvent:function(){var b = this; var a = jQuery("#widgetsManagementEditorContainer"); var c = a.closest(".contentsDiv"); app.changeSelectElementView(a.find('[name="widgetsManagementEditorModules"]')); a.on("change", '[name="widgetsManagementEditorModules"]', function(g){var f = jQuery(g.currentTarget); var d = f.val(); b.getModuleLayoutEditor(d, b.getCurrentDashboardId()).then(function(e){c.html(e); b.registerEvents()})})}, getModuleLayoutEditor:function(b, e){var c = this; var a = jQuery.Deferred(); var d = jQuery.progressIndicator({position:"html", blockInfo:{enabled:true}}); var f = {}; f.module = app.getModuleName(); f.parent = app.getParentModuleName(); f.view = "Configuration"; f.sourceModule = b; f.dashboardId = e; AppConnector.requestPjax(f).then(function(g){d.progressIndicator({mode:"hide"}); a.resolve(g)}, function(g){d.progressIndicator({mode:"hide"}); a.reject()}); return a.promise()}, registerEvents:function(){var a = this; a.registerAddBlockDashBoard(); a.registerAddCustomFieldEvent(); a.registerEditFieldDetailsClick(); a.registerSpecialWidget(); a.registerDeleteCustomFieldEvent(); a.registerDeleteCustomBlockEvent(); a.registerModulesChangeEvent(); a.setWidgetWithFilterUsers(); a.setRestrictFilter(); a.setWidgetWithFilterDate(); a.registerAddedDashboard(); a.registerSelectDashboard(); a.registerDashboardAction()}}); jQuery(document).ready(function(){var a = new Settings_WidgetsManagement_Js(); a.registerEvents()});
