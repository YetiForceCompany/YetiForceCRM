'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

jQuery.Class('Settings_WidgetsManagement_Js',{},{widgetWithFilterUsers:[],setWidgetWithFilterUsers:function c(){var a=this,b=jQuery('[name="filter_users"]').val();a.widgetWithFilterUsers=b?JSON.parse(b):[];},widgetWithFilterDate:[],setWidgetWithFilterDate:function c(){var a=this,b=jQuery('[name="filter_date"]').val();a.widgetWithFilterDate=b?JSON.parse(b):[];},restrictFilter:[],setRestrictFilter:function c(){var a=this,b=jQuery('[name="filter_restrict"]').val();a.restrictFilter=b?JSON.parse(b):[];},getAuthorization:function c(){var b=[];return continer=jQuery('#moduleBlocks'),continer.find('.editFieldsTable').each(function(){b.push(jQuery(this).data('code'));}),b},getAllFieldsInBlock:function d(a){var c=[];return a.find('.blockFieldsList .editFieldsWidget').each(function(){c.push(jQuery(this).data('linkid').toString());}),c},getCurrentDashboardId:function a(){return $('.selectDashboard li.active').data('id')},registerAddedDashboard:function b(){var a=this;$('.addDashboard').on('click',function(){var b={url:'index.php?parent=Settings&module='+app.getModuleName()+'&view=DashboardType',sendByAjaxCb:function c(){var b=$('.contentsDiv');a.getModuleLayoutEditor('Home').done(function(c){b.html(c),a.registerEvents();});}};app.showModalWindow(b);});},registerSelectDashboard:function b(){var a=this;$('.selectDashboard li').on('click',function(b){var c=$(b.currentTarget),d=c.data('id'),e=$('.contentsDiv');a.getModuleLayoutEditor('Home',d).done(function(b){e.html(b),a.registerEvents();});});},registerDashboardAction:function b(){var a=this;$('.editDashboard').on('click',function(b){var c=$(b.currentTarget);b.stopPropagation();var d={url:'index.php?parent=Settings&module='+app.getModuleName()+'&view=DashboardType&dashboardId='+c.closest('li').data('id'),sendByAjaxCb:function d(){var b=$('.contentsDiv');a.getModuleLayoutEditor('Home',c.closest('li').data('id')).done(function(c){b.html(c),a.registerEvents();});}};app.showModalWindow(d);}),$('.deleteDashboard').on('click',function(b){var c=$(b.currentTarget);b.stopPropagation();var d={parent:'Settings',module:app.getModuleName(),action:'Dashboard',mode:'delete',dashboardId:c.closest('li').data('id')};AppConnector.request(d).done(function(){var b=$('.contentsDiv');a.getModuleLayoutEditor('Home',1).done(function(c){b.html(c),a.registerEvents();});});});},registerAddBlockDashBoard:function c(){var a=this,b=jQuery('#layoutDashBoards');b.find('.addBlockDashBoard').on('click',function(){var c=b.find('.addBlockDashBoardModal').clone(!0,!0),d=a.getAuthorization();c.find('select.authorized option').each(function(){-1!=jQuery.inArray(jQuery(this).val(),d)&&jQuery(this).remove();});var e=function(b){App.Fields.Picklist.changeSelectElementView(b.find('select'));var c=b.find('.addBlockDashBoardForm'),d=app.validationEngineOptions,e=c.find('[name="authorized"]');c.validationEngine(d),c.on('submit',function(b){if(c.validationEngine('validate')){var d=c.serializeFormData();d.action='addBlock';var f=[];f.authorized=e.val(),f.label=e.find(':selected').text(),a.save(d,'save').done(function(b){var c={},d=b.result;d.success?(f.id=d.id,a.displayNewCustomBlock(f),app.hideModalWindow(),c.text=app.vtranslate('JS_BLOCK_ADDED')):(c.text=d.message,c.type='error'),Settings_Vtiger_Index_Js.showMessage(c),window.location.reload();});}b.preventDefault();});};app.showModalWindow(c,function(a){'function'==typeof e&&e(a);},{width:'1000px'});});},save:function g(a,b){var d=jQuery.Deferred(),e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),f={};return f.form=a,f.module=app.getModuleName(),f.parent=app.getParentModuleName(),f.sourceModule=jQuery('#selectedModuleName').val(),f.action='SaveAjax',f.mode=b,AppConnector.request(f).done(function(a){e.progressIndicator({mode:'hide'}),d.resolve(a);}).fail(function(a){e.progressIndicator({mode:'hide'}),d.reject(a);}),d.promise()},displayNewCustomBlock:function e(a){var c=jQuery('#layoutDashBoards'),d=c.find('.newCustomBlockCopy').clone(!0,!0);d.data('block-id',a.id).find('.blockLabel span').append(jQuery('<strong>'+a.label+'</strong>')),d.find('.addCustomField').removeClass('d-none').show(),d.find('.specialWidget').data('block-id',a.id),c.find('#moduleBlocks').append(d.removeClass('newCustomBlockCopy d-none').addClass('editFieldsTable block_'+a.id).data('code',a.authorized));},addClickOutSideEvent:function c(a,b){a.one('clickoutside',b);},registerAddCustomFieldEvent:function c(){var a=this,b=jQuery('#layoutDashBoards');b.find('.addCustomField').on('click',function(c){var d=jQuery(c.currentTarget).closest('.editFieldsTable'),e=d.data('block-id'),f=b.find('.createFieldModal').clone(!0,!0),g=a.getAllFieldsInBlock(d),h=f.find('select.widgets');h.find('option').each(function(){-1!=jQuery.inArray(jQuery(this).val(),g)&&jQuery(this).remove();});var j=h.find(':first-child').data('name');if(-1!=jQuery.inArray(j,a.widgetWithFilterUsers)){f.find('.widgetFilter').removeClass('d-none').find('select').removeAttr('disabled').show();var k=a.restrictFilter[j];if(k)for(var l in k)f.find('.widgetFilter select option[value="'+k[l]+'"]').remove();}-1!=jQuery.inArray(j,a.widgetWithFilterDate)&&f.find('.widgetFilterDate').removeClass('d-none').find('select').removeAttr('disabled').show();var i=function(d){App.Fields.Picklist.showSelect2ElementView(d.find('select')),d.find('select.widgets').on('change',function(){d.find('.widgetFilter').remove(),d.find('.widgetFilterDate').remove();var c=b.find('.createFieldModal .widgetFilter').clone(!0,!0),e=b.find('.createFieldModal .widgetFilterDate').clone(!0,!0);d.find('.modal-body').append(c),d.find('.modal-body').append(e);var g=jQuery(this).find(':selected').data('name');if(-1!=jQuery.inArray(g,a.widgetWithFilterUsers)){c.removeClass('d-none').find('select').prop('disabled',!1);var h=a.restrictFilter[g];if(h)for(var j in h)f.find('.widgetFilter select option[value="'+h[j]+'"]').remove();App.Fields.Picklist.showSelect2ElementView(c.find('select'));}else c.addClass('d-none').find('select').prop('disabled',!0);-1==jQuery.inArray(g,a.widgetWithFilterDate)?e.addClass('d-none').find('select').prop('disabled',!0):(e.removeClass('d-none').find('select').prop('disabled',!1),App.Fields.Picklist.showSelect2ElementView(e.find('select')));});var g=d.find('.createCustomFieldForm');g.attr('id','createFieldForm');var h=g.find('[name="widgets"]'),i=app.validationEngineOptions;i.onValidationComplete=function(b,d){if(d)if(h.val()){var f=b.find(':submit');f.attr('disabled','disabled');var g=b.find('[name="widgets"]');if(paramsForm=b.serializeFormData(),paramsForm.action='addWidget',paramsForm.blockid=e,paramsForm.linkid=g.val(),paramsForm.label=g.find(':selected').text(),paramsForm.name=g.find(':selected').data('name'),paramsForm.height=b.find('[name="height"]').val(),paramsForm.width=b.find('[name="width"]').val(),b.find('[name="isdefault"]').prop('checked')&&(paramsForm.isdefault=1),b.find('[name="cache"]').prop('checked')&&(paramsForm.cache=1),paramsForm.default_owner&&'undefined'==typeof paramsForm.owners_all){var i=app.vtranslate('JS_FIELD_EMPTY');return b.find('select[name="owners_all"]').prev('div').validationEngine('showPrompt',i,'error','bottomLeft',!0),f.removeAttr('disabled'),c.preventDefault(),!1}a.save(paramsForm,'save').done(function(c){var d=c.result,e={};if(c.success)app.hideModalWindow(),paramsForm.id=d.id,paramsForm.status=d.status,e.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(e),a.showCustomField(paramsForm);else{var g=c.error.message;if(513!=c.error.code)var h=b.find('[name="fieldName"]');else var h=b.find('[name="fieldLabel"]');h.validationEngine('showPrompt',g,'error','topLeft',!0),f.removeAttr('disabled');}});}else{var i=app.vtranslate('JS_FIELD_EMPTY');return h.prev('div').validationEngine('showPrompt',i,'error','topLeft',!0),void c.preventDefault()}return !1},g.validationEngine(i);};app.showModalWindow(f,function(a){'function'==typeof i&&i(a);},{width:'1000px'});});},showCustomField:function m(a){var b=this,c=jQuery('#layoutDashBoards'),d=c.find('.block_'+a.blockid),e=c.find('.newCustomFieldCopy').clone(!0,!0),f=e.find('.js-custom-field');f.addClass('opacity editFieldsWidget').attr('data-field-id',a.id).attr('data-block-id',a.blockid).attr('data-linkid',a.linkid),f.find('.deleteCustomField, .saveFieldDetails').attr('data-field-id',a.id),a.title?f.find('.fieldLabel').html(a.title):f.find('.fieldLabel').html(a.label),a.status||f.find('input[name="limit"]').closest('div.limit').remove(),'undefined'!=typeof a.default_owner&&f.find('.widgetFilterAll').removeClass('d-none').show();var g=d.find('.blockFieldsList'),h=g.find('ul[name=sortable1]'),i=h.children().length,j=g.find('ul[name=sortable2]'),k=j.children().length;i>k?j.append(e.removeClass('d-none newCustomFieldCopy')):h.append(e.removeClass('d-none newCustomFieldCopy'));var l=e.find('form.fieldDetailsForm');b.setFieldDetails(a,l);},setFieldDetails:function f(a,b){if(b.find('.modal-header').html($('<h5 class="modal-title">'+a.label+'</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>')),a.isdefault&&b.find('[name="isdefault"]').filter(':checkbox').attr('checked',!0),a.cache&&b.find('[name="cache"]').filter(':checkbox').attr('checked',!0),a.width&&(b.find('select[name="width"]').find('option').removeAttr('selected'),b.find('select[name="width"]').find('option[value="'+a.width+'"]').attr('selected','selected')),a.height&&(b.find('select[name="height"]').find('option').removeAttr('selected'),b.find('select[name="height"]').find('option[value="'+a.height+'"]').attr('selected','selected')),a.default_owner&&(b.find('select[name="default_owner"]').find('option').removeAttr('selected'),b.find('select[name="default_owner"]').find('option[value="'+a.default_owner+'"]').attr('selected','selected')),a.owners_all){b.find('select[name="owners_all"]').find('option').removeAttr('selected');var c=a.owners_all;if('string'!=typeof c)for(var d,e=0;e<c.length;e++)d=c[e].replace(/"/g,'\\"'),b.find('select[name="owners_all"]').find('option[value="'+d+'"]').attr('selected','selected');else b.find('select[name="owners_all"]').find('option[value="'+c+'"]').attr('selected','selected');}},registerEditFieldDetailsClick:function c(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,b=this;a||(a=jQuery('#layoutDashBoards')),a.find('.editFieldDetails').on('click',function(a){var c=$(a.currentTarget),d=c.closest('div.editFieldsWidget');d.removeClass('opacity');var e=d.find('.basicFieldOperations'),f=c.closest('.btn-group');f.find('.dropdown-menu').remove();var g=e.clone().removeClass('basicFieldOperations d-none').addClass('dropdown-menu p-0');f.append(g);var h=f.find('.dropdown-menu');f.dropdown('dispose').dropdown('toggle');var i=app.getvalidationEngineOptions(!0);i.binded=!1,i.onValidationComplete=function(c,d){if(d){if(void 0===c)return !0;var e=c.serializeFormData();c.find('[name="isdefault"]').prop('checked')&&(e.isdefault=1),c.find('[name="cache"]').prop('checked')&&(e.cache=1);var f=c.find('.saveFieldDetails').data('field-id');if(e.action='saveDetails',e.id=f,e.default_owner&&'undefined'==typeof e.owners_all){var g={};return g.type='error',g.text=app.vtranslate('JS_FILTERS_AVAILABLE')+': '+app.vtranslate('JS_FIELD_EMPTY'),Settings_Vtiger_Index_Js.showMessage(g),a.preventDefault(),!1}b.save(e,'save'),b.registerSaveFieldDetailsEvent(c);}return !1},h.find('form').validationEngine(i);var j=e.find('select[name="owners_all"]');0<j.length&&App.Fields.Picklist.showSelectizeElementView(h.find('select[name="owners_all"]')),j=e.find('select[name="default_date"]'),0<j.length&&App.Fields.Picklist.showSelect2ElementView(h.find('select[name="default_date"]')),b.avoidDropDownClick(f),h.on('change',':checkbox',function(a){var b=jQuery(a.currentTarget);if('readonly'===b.attr('readonly')){var c=jQuery(a.currentTarget).is(':checked');c?$(a.currentTarget).removeAttr('checked'):$(a.currentTarget).attr('checked','checked'),a.preventDefault();}});var k=function(){d.addClass('opacity'),g.remove();};b.addClickOutSideEvent(g,k),$('.cancel,.close').on('click',k);});},registerSaveFieldDetailsEvent:function j(a){var c=a.find('.saveFieldDetails'),d=c.data('field-id'),e=c.closest('.editFieldsTable'),f=e.data('block-id');c.closest('.btn-group').removeClass('open');var g=c.closest('.editFieldsWidget');g.addClass('opacity');var h=a.closest('.dropdown-menu');App.Fields.Picklist.destroySelectizeElement(a),a.find('select').each(function(){var a=jQuery(this).val();if(jQuery(this).find('option').removeAttr('selected'),'undefined'==typeof jQuery(this).attr('multiple')){var b=a.replace(/"/g,'\\"');jQuery(this).find('[value="'+b+'"]').attr('selected','selected');}else for(var b,c=0;c<a.length;c++)b=a[c].replace(/"/g,'\\"'),jQuery(this).find('[value="'+b+'"]').attr('selected','selected');});var i=a.closest('.editFieldsWidget').find('.basicFieldOperations');i.html(a),h.remove();},avoidDropDownClick:function b(a){a.find('.dropdown-menu').on('click',function(a){a.stopPropagation();});},registerSpecialWidget:function c(){var a=this,b=jQuery('#layoutDashBoards');b.find('.addNotebook').on('click',function(){a.addNoteBookWidget(this,jQuery(this).data('url'));}),b.find('.addMiniList').on('click',function(){a.addMiniListWidget(this,jQuery(this).data('url'));}),b.find('.addChartFilter').on('click',function(){a.addChartFilterWidget(this,jQuery(this).data('url'));}),b.find('.addRss').on('click',function(b){a.addRssWidget($(b.currentTarget),jQuery(this).data('url'));});},addRssWidget:function d(a){var b=this,c={url:'index.php?module='+app.getModuleName()+'&parent='+app.getParentModuleName()+'&view=AddRss',cb:function f(c){c.find('.removeChannel').on('click',function(a){var b=$(a.currentTarget),c=b.closest('.form-group');c.remove();}),c.find('.addChannel').on('click',function(){var a=c.find('.newChannel').clone(),b=c.find('.formContainer');b.append(a),a.removeClass('d-none'),a.removeClass('newChannel'),a.find('input').removeAttr('disabled'),a.find('.removeChannel').on('click',function(a){var b=$(a.currentTarget),c=b.closest('.form-group');c.remove();});}),c.find('[name="blockid"]').val(a.data('blockId')),c.find('[name="linkid"]').val(a.data('linkid'));var d=c.find('form'),e=d.find('[type="submit"]');e.on('click',function(a){var c=[];if(d.validationEngine('validate')){d.find('.channelRss:not(:disabled)').each(function(){c.push(jQuery(this).val());});var e=d.serializeFormData();e.data=JSON.stringify({channels:c}),b.save(e,'save').done(function(a){e.label=e.title,b.saveAfterInfo(a,e);});}a.preventDefault();});}};app.showModalWindow(c);},saveAfterInfo:function f(a,b){var c=this,d=a.result,e={};a.success&&(app.hideModalWindow(),b.id=d.id,b.status=d.status,e.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(e),c.showCustomField(b));},addChartFilterWidget:function d(a){function b(b,d,e,f,g,h){var i={};i.data=JSON.stringify(g),i.action='addWidget',i.blockid=a.data('block-id'),i.linkid=a.data('linkid'),i.label=b,'undefined'!=typeof e&&null!==e&&''!==e&&(i.label+=' - '+e),'undefined'!=typeof f&&null!==f&&''!==f&&(i.label+=' - '+f),i.name='ChartFilter',i.filterid=d,i.title=h.find('[name="widgetTitle"]').val(),i.isdefault=0,i.cache=0,i.height=4,i.width=4,i.owners_all=['mine','all','users','groups'],i.default_owner='mine',c.save(i,'save').done(function(a){var b=a.result,d={};if(a.success)app.hideModalWindow(),i.id=b.id,i.status=b.status,d.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(d),c.showCustomField(i);else{var e=a.error.message;if(513!=a.error.code)var f=h.find('[name="fieldName"]');else var f=h.find('[name="fieldLabel"]');f.validationEngine('showPrompt',e,'error','topLeft',!0);}});}var c=this;a=jQuery(a),app.showModalWindow(null,'index.php?module=Home&view=ChartFilter&step=step1',function(a){var c=jQuery('form',a),d=jQuery('select[name="chartType"]',a),e=jQuery('select[name="module"]',a),f=App.Fields.Picklist.showSelect2ElementView(e,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),g=jQuery('.step1',a),h=jQuery('.step2',a),i=jQuery('.step3',a),j=jQuery('.modal-footer',a);h.remove(),i.remove(),j.hide(),d.on('change',function(b){var d=$(b.currentTarget),e=d.val();'Barchat'==e||'Horizontal'==e?c.find('.isColorContainer').removeClass('d-none'):c.find('.isColorContainer').addClass('d-none'),4==a.find('#widgetStep').val()&&a.find('.step3 .groupField').trigger('change');}),f.on('change',function(){f.val()&&(j.hide(),a.find('.step2').remove(),a.find('.step3').remove(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step2',chartType:d.val(),selectedModule:f.val()}).done(function(b){g.after(b),a.find('#widgetStep').val(2);var c=a.find('.step2');j.hide();var e=c.find('.filtersId'),h=c.find('.valueType');App.Fields.Picklist.showSelect2ElementView(e),App.Fields.Picklist.showSelect2ElementView(h),c.find('.filtersId, .valueType').on('change',function(){a.find('.step3').remove(),a.find('.step4').remove(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step3',selectedModule:f.val(),chartType:d.val(),filtersId:e.val(),valueType:h.val()}).done(function(b){c.last().after(b),a.find('#widgetStep').val(3);var g=a.find('.step3');App.Fields.Picklist.showSelect2ElementView(g.find('select')),j.hide(),g.find('.groupField').on('change',function(){a.find('.step4').remove();var b=$(this);b.val()&&(j.show(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step4',selectedModule:f.val(),filtersId:e.val(),groupField:b.val(),chartType:d.val()}).done(function(b){g.last().after(b),a.find('#widgetStep').val(4);var c=a.find('.step4');App.Fields.Picklist.showSelect2ElementView(c.find('select'));}));});});});}));}),c.on('submit',function(a){a.preventDefault();var e=f.val(),g=f.find(':selected').text(),h=c.find('.filtersId').val(),i=c.find('.groupField').find(':selected').text(),j={module:e,groupField:c.find('.groupField').val(),chartType:d.val()};c.find('.saveParam').each(function(a,b){b=$(b),b.is('input')&&'checkbox'===b.prop('type')&&!b.prop('checked')||(j[b.attr('name')]=b.val());}),b(g,h,null,i,j,c);});});},addNoteBookWidget:function c(a){var b=this;a=jQuery(a),app.showModalWindow(null,'index.php?module=Home&view=AddNotePad',function(c){var d=jQuery('form',c),e=app.validationEngineOptions;e.onValidationComplete=function(d,f){if(f){jQuery('[name=\'saveButton\']',c).attr('disabled','disabled');var g=d.find('[name="notePadName"]').val(),h=d.find('[name="notePadContent"]').val(),i=a.data('linkid'),j=a.data('block-id'),k={module:jQuery('#selectedModuleName').val(),action:'NoteBook',mode:'noteBookCreate',notePadName:g,notePadContent:h,blockid:j,linkId:i,isdefault:0,width:4,height:3};AppConnector.request(k).done(function(a){if(a.result.success){var c=a.result.widgetId;app.hideModalWindow(),k.id=c,k.label=g,e.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(e),b.showCustomField(k);}});}return !1},d.validationEngine(e);});},addMiniListWidget:function c(a){var b=this;a=jQuery(a),app.showModalWindow(null,'index.php?module=Home&view=MiniListWizard&step=step1',function(c){var d=jQuery('form',c),e=jQuery('select[name="module"]',c),f=jQuery('select[name="filterid"]',c),g=jQuery('select[name="fields"]',c),h=jQuery('select[name="filter_fields"]',c),i=App.Fields.Picklist.showSelect2ElementView(e,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),j=App.Fields.Picklist.showSelect2ElementView(f,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')}),k=App.Fields.Picklist.showSelect2ElementView(g,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION'),closeOnSelect:!0,maximumSelectionLength:6}),l=App.Fields.Picklist.showSelect2ElementView(h,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')}),m=jQuery('.modal-footer',c);f.closest('tr').hide(),g.closest('tr').hide(),h.closest('tr').hide(),m.hide(),i.on('change',function(){i.val()&&AppConnector.request({module:'Home',view:'MiniListWizard',step:'step2',selectedModule:i.val()}).done(function(a){f.empty().html(a).trigger('change'),j.closest('tr').show(),g.closest('tr').hide(),h.closest('tr').hide();});}),j.on('change',function(){j.val()&&(m.hide(),g.closest('tr').hide(),h.closest('tr').hide(),AppConnector.request({module:'Home',view:'MiniListWizard',step:'step3',selectedModule:i.val(),filterid:j.val()}).done(function(a){var a=jQuery(a);g.empty().html(a.find('select[name="fields"]').html()).trigger('change'),h.empty().html(a.find('select[name="filter_fields"]').html()).trigger('change'),k.closest('tr').show(),l.closest('tr').show(),k.data('select2').$selection.find('.select2-search__field').parent().css('width','100%'),l.data('select2').$selection.find('.select2-search__field').parent().css('width','100%');}));}),k.on('change',function(){k.val()?m.show():m.hide();}),d.on('submit',function(c){c.preventDefault();var e=i.val(),f=i.find(':selected').text(),g=j.val(),h=j.find(':selected').text(),m=[];k.select2('data').map(function(a){m.push(a.id);});var n={module:e};'object'!=('undefined'==typeof m?'undefined':_typeof(m))&&(m=[m]),n.fields=m,n.filterFields=l.val();var o={data:JSON.stringify(n),action:'addWidget',blockid:a.data('block-id'),title:d.find('[name="widgetTitle"]').val(),linkid:a.data('linkid'),label:f+' - '+h,name:'Mini List',filterid:g,isdefault:0,cache:0,height:4,width:4,owners_all:['mine','all','users','groups'],default_owner:'mine'};b.save(o,'save').done(function(a){var c=a.result,e={};if(a.success)app.hideModalWindow(),o.id=c.id,o.status=c.status,e.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(e),b.showCustomField(o);else{var f=a.error.message;if(513!=a.error.code)var g=d.find('[name="fieldName"]');else var g=d.find('[name="fieldLabel"]');g.validationEngine('showPrompt',f,'error','topLeft',!0);}});});});},registerDeleteCustomFieldEvent:function c(a){var b=this;'undefined'==typeof a&&(a=jQuery('#layoutDashBoards')),a.find('a.deleteCustomField').on('click',function(a){var c=jQuery(a.currentTarget),d=c.data('field-id'),e={};e.action='removeWidget',e.id=d;var f=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:f}).done(function(){b.save(e,'delete').done(function(){var a=c.closest('div.editFieldsWidget'),d=a.data('block-id');a.parent().fadeOut('slow').remove();var e=jQuery('#block_'+d);b.reArrangeBlockFields(e);var f={};f.text=app.vtranslate('JS_CUSTOM_FIELD_DELETED'),Settings_Vtiger_Index_Js.showMessage(f);});});});},reArrangeBlockFields:function f(a){var b=a.find('ul[name=sortable1]'),c=a.find('ul[name=sortable2]');if(b.children().length<c.children().length){var d=c.children(':last');b.append(d);}else if(b.children().length>c.children().length+1){var e=b.children(':last');c.append(e);}},registerDeleteCustomBlockEvent:function d(){var a=this,b=jQuery('#layoutDashBoards'),c=b.find('.editFieldsTable');b.on('click','.deleteCustomBlock',function(b){var c=jQuery(b.currentTarget),d=c.closest('div.editFieldsTable'),e=d.data('block-id'),f={};f.blockid=e,f.action='removeBlock';var g=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:g}).done(function(){a.save(f,'delete').done(function(){a.removeDeletedBlock(e,'delete');var b={};b.text=app.vtranslate('JS_CUSTOM_BLOCK_DELETED'),Settings_Vtiger_Index_Js.showMessage(b);});});});},removeDeletedBlock:function d(a){var b=jQuery('#layoutDashBoards'),c=b.find('.block_'+a);c.fadeOut('slow').remove();},registerModulesChangeEvent:function d(){var a=this,b=jQuery('#widgetsManagementEditorContainer'),c=b.closest('.contentsDiv');App.Fields.Picklist.changeSelectElementView(b.find('[name="widgetsManagementEditorModules"]')),b.on('change','[name="widgetsManagementEditorModules"]',function(b){var d=jQuery(b.currentTarget),e=d.val();a.getModuleLayoutEditor(e,a.getCurrentDashboardId()).done(function(b){c.html(b),a.registerEvents();});});},getModuleLayoutEditor:function g(a,b){var d=jQuery.Deferred(),e=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),f={};return f.module=app.getModuleName(),f.parent=app.getParentModuleName(),f.view='Configuration',f.sourceModule=a,f.dashboardId=b,AppConnector.requestPjax(f).done(function(a){e.progressIndicator({mode:'hide'}),d.resolve(a);}).fail(function(){e.progressIndicator({mode:'hide'}),d.reject();}),d.promise()},registerEvents:function b(){var a=this;a.registerAddBlockDashBoard(),a.registerAddCustomFieldEvent(),a.registerEditFieldDetailsClick(),a.registerSpecialWidget(),a.registerDeleteCustomFieldEvent(),a.registerDeleteCustomBlockEvent(),a.registerModulesChangeEvent(),a.setWidgetWithFilterUsers(),a.setRestrictFilter(),a.setWidgetWithFilterDate(),a.registerAddedDashboard(),a.registerSelectDashboard(),a.registerDashboardAction();}}),jQuery(document).ready(function(){var a=new Settings_WidgetsManagement_Js;a.registerEvents();});
