'use strict';

jQuery.Class('Settings_WidgetsManagement_Js',{},{widgetWithFilterUsers:[],setWidgetWithFilterUsers:function setWidgetWithFilterUsers(){var thisInstance=this,element=jQuery('[name="filter_users"]').val();thisInstance.widgetWithFilterUsers=element?JSON.parse(element):[];},widgetWithFilterDate:[],setWidgetWithFilterDate:function setWidgetWithFilterDate(){var thisInstance=this,element=jQuery('[name="filter_date"]').val();thisInstance.widgetWithFilterDate=element?JSON.parse(element):[];},restrictFilter:[],setRestrictFilter:function setRestrictFilter(){var thisInstance=this,element=jQuery('[name="filter_restrict"]').val();thisInstance.restrictFilter=element?JSON.parse(element):[];},getAuthorization:function getAuthorization(){var authorization=[],container=jQuery('#moduleBlocks');return container.find('.editFieldsTable').each(function(){authorization.push(jQuery(this).data('code'));}),authorization},getAllFieldsInBlock:function getAllFieldsInBlock(continer){var fields=[];return continer.find('.blockFieldsList .editFieldsWidget').each(function(){fields.push(jQuery(this).data('linkid').toString());}),fields},getCurrentDashboardId:function getCurrentDashboardId(){return $('.selectDashboard li a.active').parent().data('id')},registerAddedDashboard:function registerAddedDashboard(){var thisInstance=this;$('.addDashboard').on('click',function(){app.showModalWindow({url:'index.php?parent=Settings&module='+app.getModuleName()+'&view=DashboardType',sendByAjaxCb:function sendByAjaxCb(){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor('Home').done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});}});});},registerSelectDashboard:function registerSelectDashboard(){var thisInstance=this;$('.selectDashboard li').on('click',function(e){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor($('#selectedModuleName').val(),$(e.currentTarget).data('id')).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});},registerDashboardAction:function registerDashboardAction(){var thisInstance=this;$('.editDashboard').on('click',function(e){var currentTarget=$(e.currentTarget);e.stopPropagation(),app.showModalWindow({url:'index.php?parent=Settings&module='+app.getModuleName()+'&view=DashboardType&dashboardId='+currentTarget.closest('li').data('id'),sendByAjaxCb:function sendByAjaxCb(){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor('Home',currentTarget.closest('li').data('id')).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});}});}),$('.deleteDashboard').on('click',function(e){var currentTarget=$(e.currentTarget);e.stopPropagation(),AppConnector.request({parent:'Settings',module:app.getModuleName(),action:'Dashboard',mode:'delete',dashboardId:currentTarget.closest('li').data('id')}).done(function(){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor('Home',1).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});});},registerAddBlockDashBoard:function registerAddBlockDashBoard(){var thisInstance=this,contents=jQuery('#layoutDashBoards');contents.find('.addBlockDashBoard').on('click',function(){var addBlockContainer=contents.find('.addBlockDashBoardModal').clone(!0,!0),inUseAuthorization=thisInstance.getAuthorization();addBlockContainer.find('select.authorized option').each(function(){-1!=jQuery.inArray(jQuery(this).val(),inUseAuthorization)&&jQuery(this).remove();});var callBackFunction=function(data){App.Fields.Picklist.changeSelectElementView(data.find('select'));var form=data.find('.addBlockDashBoardForm'),block=form.find('[name="authorized"]');form.validationEngine(app.validationEngineOptions),form.on('submit',function(e){if(form.validationEngine('validate')){var paramsForm=form.serializeFormData();paramsForm.action='addBlock';var paramsBlock={authorized:block.val(),label:block.find(':selected').text()};thisInstance.save(paramsForm,'save').done(function(data){var params={},response=data.result;response.success?(paramsBlock.id=response.id,thisInstance.displayNewCustomBlock(paramsBlock),app.hideModalWindow(),params.text=app.vtranslate('JS_BLOCK_ADDED')):(params.text=response.message,params.type='error'),Settings_Vtiger_Index_Js.showMessage(params),window.location.reload();});}e.preventDefault();});};app.showModalWindow(addBlockContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);},{width:'1000px'});});},save:function save(form,mode){var aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};return params.form=form,params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.sourceModule=jQuery('#selectedModuleName').val(),params.action='SaveAjax',params.mode=mode,AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(error){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject(error);}),aDeferred.promise()},displayNewCustomBlock:function displayNewCustomBlock(result){var contents=jQuery('#layoutDashBoards'),newBlockCloneCopy=contents.find('.newCustomBlockCopy').clone(!0,!0);newBlockCloneCopy.data('block-id',result.id).find('.blockLabel span').append(jQuery('<strong>'+result.label+'</strong>')),newBlockCloneCopy.find('.addCustomField').removeClass('d-none').show(),newBlockCloneCopy.find('.specialWidget').data('block-id',result.id),contents.find('#moduleBlocks').append(newBlockCloneCopy.removeClass('newCustomBlockCopy d-none').addClass('editFieldsTable block_'+result.id).data('code',result.authorized));},addClickOutSideEvent:function addClickOutSideEvent(element,callbackFunction){element.one('clickoutside',callbackFunction);},registerAddCustomFieldEvent:function registerAddCustomFieldEvent(){var thisInstance=this,contents=jQuery('#layoutDashBoards');contents.find('.addCustomField').on('click',function(e){var continer=jQuery(e.currentTarget).closest('.editFieldsTable'),blockId=continer.data('block-id'),addFieldContainer=contents.find('.createFieldModal').clone(!0,!0),allFieldsInBlock=thisInstance.getAllFieldsInBlock(continer),selectWidgets=addFieldContainer.find('select.widgets');selectWidgets.find('option').each(function(){-1!=jQuery.inArray(jQuery(this).val(),allFieldsInBlock)&&jQuery(this).remove();});var name=selectWidgets.find(':first-child').data('name');if(-1!=jQuery.inArray(name,thisInstance.widgetWithFilterUsers)){addFieldContainer.find('.widgetFilter').removeClass('d-none').find('select').removeAttr('disabled').show();var restrictFilter=thisInstance.restrictFilter[name];if(restrictFilter)for(var i in restrictFilter)addFieldContainer.find('.widgetFilter select option[value="'+restrictFilter[i]+'"]').remove();}-1!=jQuery.inArray(name,thisInstance.widgetWithFilterDate)&&addFieldContainer.find('.widgetFilterDate').removeClass('d-none').find('select').removeAttr('disabled').show();var callBackFunction=function(data){App.Fields.Picklist.showSelect2ElementView(data.find('select')),data.find('select.widgets').on('change',function(){data.find('.widgetFilter').remove(),data.find('.widgetFilterDate').remove();var elementsToFilter=contents.find('.createFieldModal .widgetFilter').clone(!0,!0),elementsToFilterDate=contents.find('.createFieldModal .widgetFilterDate').clone(!0,!0);data.find('.modal-body').append(elementsToFilter),data.find('.modal-body').append(elementsToFilterDate);var name=jQuery(this).find(':selected').data('name');if(-1!=jQuery.inArray(name,thisInstance.widgetWithFilterUsers)){elementsToFilter.removeClass('d-none').find('select').prop('disabled',!1);var restrictFilter=thisInstance.restrictFilter[name];if(restrictFilter)for(var i in restrictFilter)addFieldContainer.find('.widgetFilter select option[value="'+restrictFilter[i]+'"]').remove();App.Fields.Picklist.showSelect2ElementView(elementsToFilter.find('select'));}else elementsToFilter.addClass('d-none').find('select').prop('disabled',!0);-1==jQuery.inArray(name,thisInstance.widgetWithFilterDate)?elementsToFilterDate.addClass('d-none').find('select').prop('disabled',!0):(elementsToFilterDate.removeClass('d-none').find('select').prop('disabled',!1),App.Fields.Picklist.showSelect2ElementView(elementsToFilterDate.find('select')));});var form=data.find('.createCustomFieldForm');form.attr('id','createFieldForm');var widgets=form.find('[name="widgets"]');form.validationEngine($.extend(!0,{onValidationComplete:function onValidationComplete(form,valid){if(valid)if(widgets.val()){var saveButton=form.find(':submit'),field=form.find('[name="widgets"]');saveButton.attr('disabled','disabled');var paramsForm=form.serializeFormData();if(paramsForm.action='addWidget',paramsForm.blockid=blockId,paramsForm.linkid=field.val(),paramsForm.label=field.find(':selected').text(),paramsForm.name=field.find(':selected').data('name'),paramsForm.height=form.find('[name="height"]').val(),paramsForm.width=form.find('[name="width"]').val(),form.find('[name="isdefault"]').prop('checked')&&(paramsForm.isdefault=1),form.find('[name="cache"]').prop('checked')&&(paramsForm.cache=1),paramsForm.default_owner&&'undefined'==typeof paramsForm.owners_all)return form.find('select[name="owners_all"]').prev('div').validationEngine('showPrompt',app.vtranslate('JS_FIELD_EMPTY'),'error','bottomLeft',!0),saveButton.removeAttr('disabled'),e.preventDefault(),!1;thisInstance.save(paramsForm,'save').done(function(data){var result=data.result,params={};if(data.success)app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(paramsForm);else{var errorField,message=data.error.message;errorField=513==data.error.code?form.find('[name="fieldLabel"]'):form.find('[name="fieldName"]'),errorField.validationEngine('showPrompt',message,'error','topLeft',!0),saveButton.removeAttr('disabled');}});}else return widgets.prev('div').validationEngine('showPrompt',app.vtranslate('JS_FIELD_EMPTY'),'error','topLeft',!0),void e.preventDefault();return !1}},app.validationEngineOptions));};app.showModalWindow(addFieldContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);},{width:'1000px'});});},showCustomField:function showCustomField(result){var thisInstance=this,contents=jQuery('#layoutDashBoards'),relatedBlock=contents.find('.block_'+result.blockid),fieldCopy=contents.find('.newCustomFieldCopy').clone(!0,!0),fieldContainer=fieldCopy.find('.js-custom-field');fieldContainer.addClass('opacity editFieldsWidget').attr('data-field-id',result.id).attr('data-block-id',result.blockid).attr('data-linkid',result.linkid),fieldContainer.find('.deleteCustomField, .saveFieldDetails').attr('data-field-id',result.id),result.title?fieldContainer.find('.fieldLabel').html(result.title):fieldContainer.find('.fieldLabel').html(result.label),result.status||fieldContainer.find('input[name="limit"]').closest('div.limit').remove(),'undefined'!=typeof result.default_owner&&fieldContainer.find('.widgetFilterAll').removeClass('d-none').show();var block=relatedBlock.find('.blockFieldsList'),sortable1=block.find('ul[name=sortable1]'),length1=sortable1.children().length,sortable2=block.find('ul[name=sortable2]'),length2=sortable2.children().length;length1>length2?sortable2.append(fieldCopy.removeClass('d-none newCustomFieldCopy')):sortable1.append(fieldCopy.removeClass('d-none newCustomFieldCopy'));var form=fieldCopy.find('form.fieldDetailsForm');thisInstance.setFieldDetails(result,form);},setFieldDetails:function setFieldDetails(result,form){if(form.find('.modal-header').html($('<h5 class="modal-title">'+result.label+'</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>')),result.isdefault&&form.find('[name="isdefault"]').filter(':checkbox').attr('checked',!0),result.cache&&form.find('[name="cache"]').filter(':checkbox').attr('checked',!0),result.width&&(form.find('select[name="width"]').find('option').removeAttr('selected'),form.find('select[name="width"]').find('option[value="'+result.width+'"]').attr('selected','selected')),result.height&&(form.find('select[name="height"]').find('option').removeAttr('selected'),form.find('select[name="height"]').find('option[value="'+result.height+'"]').attr('selected','selected')),result.default_owner&&(form.find('select[name="default_owner"]').find('option').removeAttr('selected'),form.find('select[name="default_owner"]').find('option[value="'+result.default_owner+'"]').attr('selected','selected')),result.owners_all){form.find('select[name="owners_all"]').find('option').removeAttr('selected');var selectedvalue=result.owners_all;if('string'!=typeof selectedvalue)for(var encodedSelectedValue,i=0;i<selectedvalue.length;i++)encodedSelectedValue=selectedvalue[i].replace(/"/g,'\\"'),form.find('select[name="owners_all"]').find('option[value="'+encodedSelectedValue+'"]').attr('selected','selected');else form.find('select[name="owners_all"]').find('option[value="'+selectedvalue+'"]').attr('selected','selected');}},registerEditFieldDetailsClick:function registerEditFieldDetailsClick(){var contents=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,thisInstance=this;contents||(contents=jQuery('#layoutDashBoards')),contents.find('.editFieldDetails').on('click',function(e){var currentTarget=$(e.currentTarget),fieldRow=currentTarget.closest('div.editFieldsWidget');fieldRow.removeClass('opacity');var basicDropDown=fieldRow.find('.basicFieldOperations'),dropDownContainer=currentTarget.closest('.btn-group');dropDownContainer.find('.dropdown-menu').remove();var dropDown=basicDropDown.clone().removeClass('basicFieldOperations d-none').addClass('dropdown-menu p-0');dropDownContainer.append(dropDown);var dropDownMenu=dropDownContainer.find('.dropdown-menu');dropDownContainer.dropdown('dispose').dropdown('toggle'),dropDownMenu.find('form').validationEngine($.extend(!0,{binded:!1,onValidationComplete:function onValidationComplete(form,valid){if(valid){if(void 0===form)return !0;var paramsForm=form.serializeFormData();form.find('[name="isdefault"]').prop('checked')&&(paramsForm.isdefault=1),form.find('[name="cache"]').prop('checked')&&(paramsForm.cache=1);var id=form.find('.saveFieldDetails').data('field-id');if(paramsForm.action='saveDetails',paramsForm.id=id,'undefined'==typeof paramsForm.customMultiFilter||$.isArray(paramsForm.customMultiFilter)||(paramsForm.customMultiFilter=[paramsForm.customMultiFilter]),paramsForm.default_owner&&'undefined'==typeof paramsForm.owners_all){var params={};return params.type='error',params.text=app.vtranslate('JS_FILTERS_AVAILABLE')+': '+app.vtranslate('JS_FIELD_EMPTY'),Settings_Vtiger_Index_Js.showMessage(params),e.preventDefault(),!1}thisInstance.save(paramsForm,'save'),thisInstance.registerSaveFieldDetailsEvent(form);}return !1}},app.getvalidationEngineOptions(!0)));var selectElements=basicDropDown.find('select[name="owners_all"]');0<selectElements.length&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="owners_all"]')),selectElements=basicDropDown.find('select[name="default_date"]'),0<selectElements.length&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="default_date"]')),selectElements=basicDropDown.find('select[name="customMultiFilter"]'),0<selectElements.length&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="customMultiFilter"]')),selectElements=basicDropDown.find('select[name="defaultFilter"]'),0<selectElements.length&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="defaultFilter"]')),thisInstance.avoidDropDownClick(dropDownContainer),dropDownMenu.on('change',':checkbox',function(e){var currentTarget=jQuery(e.currentTarget);if('readonly'===currentTarget.attr('readonly')){var status=jQuery(e.currentTarget).is(':checked');status?$(e.currentTarget).removeAttr('checked'):$(e.currentTarget).attr('checked','checked'),e.preventDefault();}});var callbackFunction=function(){fieldRow.addClass('opacity'),dropDown.remove();};thisInstance.addClickOutSideEvent(dropDown,callbackFunction),$('.cancel,.close').on('click',callbackFunction);});},registerSaveFieldDetailsEvent:function registerSaveFieldDetailsEvent(form){var submitButtton=form.find('.saveFieldDetails'),fieldRow=submitButtton.closest('.editFieldsWidget'),dropDownMenu=form.closest('.dropdown-menu');submitButtton.closest('.btn-group').removeClass('open'),fieldRow.addClass('opacity'),form.find('select').each(function(){var encodedSelectedValue,selectedValue=$(this).val();if($(this).find('option').removeAttr('selected'),'undefined'==typeof $(this).attr('multiple'))encodedSelectedValue=selectedValue.replace(/"/g,'\\"'),$(this).find('[value="'+encodedSelectedValue+'"]').attr('selected','selected');else for(var i=0;i<selectedValue.length;i++)encodedSelectedValue=selectedValue[i].replace(/"/g,'\\"'),$(this).find('[value="'+encodedSelectedValue+'"]').attr('selected','selected');}),form.closest('.editFieldsWidget').find('.basicFieldOperations').html(form),dropDownMenu.remove();},avoidDropDownClick:function avoidDropDownClick(dropDownContainer){dropDownContainer.find('.dropdown-menu').on('click',function(e){e.stopPropagation();});},registerSpecialWidget:function registerSpecialWidget(){var thisInstance=this,container=jQuery('#layoutDashBoards');container.find('.addNotebook').on('click',function(){thisInstance.addNoteBookWidget(this,jQuery(this).data('url'));}),container.find('.addMiniList').on('click',function(){thisInstance.addMiniListWidget(this,jQuery(this).data('url'));}),container.find('.addChartFilter').on('click',function(){thisInstance.addChartFilterWidget(this,jQuery(this).data('url'));}),container.find('.addRss').on('click',function(e){thisInstance.addRssWidget($(e.currentTarget),jQuery(this).data('url'));});},addRssWidget:function addRssWidget(element){var thisInstance=this,objectToShowModal={url:'index.php?module='+app.getModuleName()+'&parent='+app.getParentModuleName()+'&view=AddRss',cb:function cb(container){container.find('.removeChannel').on('click',function(e){var currentTarget=$(e.currentTarget),row=currentTarget.closest('.form-group');row.remove();}),container.find('.addChannel').on('click',function(){var newRow=container.find('.newChannel').clone(),formContainer=container.find('.formContainer');formContainer.append(newRow),newRow.removeClass('d-none'),newRow.removeClass('newChannel'),newRow.find('input').removeAttr('disabled'),newRow.find('.removeChannel').on('click',function(e){var currentTarget=$(e.currentTarget),row=currentTarget.closest('.form-group');row.remove();});}),container.find('[name="blockid"]').val(element.data('blockId')),container.find('[name="linkid"]').val(element.data('linkid'));var form=container.find('form'),submit=form.find('[type="submit"]');submit.on('click',function(e){var channels=[];if(form.validationEngine('validate')){form.find('.channelRss:not(:disabled)').each(function(){channels.push(jQuery(this).val());});var paramsForm=form.serializeFormData();paramsForm.data=JSON.stringify({channels:channels}),thisInstance.save(paramsForm,'save').done(function(data){paramsForm.label=paramsForm.title,thisInstance.saveAfterInfo(data,paramsForm);});}e.preventDefault();});}};app.showModalWindow(objectToShowModal);},saveAfterInfo:function saveAfterInfo(data,paramsForm){var thisInstance=this,result=data.result,params={};data.success&&(app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(paramsForm));},addChartFilterWidget:function addChartFilterWidget(element){function finializeAddChart(moduleNameLabel,filterid,filterLabel,fieldLabel,data,form){var paramsForm={};paramsForm.data=JSON.stringify(data),paramsForm.action='addWidget',paramsForm.blockid=element.data('block-id'),paramsForm.linkid=element.data('linkid'),paramsForm.label=moduleNameLabel,'undefined'!=typeof filterLabel&&null!==filterLabel&&''!==filterLabel&&(paramsForm.label+=' - '+filterLabel),'undefined'!=typeof fieldLabel&&null!==fieldLabel&&''!==fieldLabel&&(paramsForm.label+=' - '+fieldLabel),paramsForm.name='ChartFilter',paramsForm.filterid=filterid,paramsForm.title=form.find('[name="widgetTitle"]').val(),paramsForm.isdefault=0,paramsForm.cache=0,paramsForm.height=4,paramsForm.width=4,paramsForm.owners_all=['mine','all','users','groups'],paramsForm.default_owner='mine',thisInstance.save(paramsForm,'save').done(function(data){var result=data.result,params={};if(data.success)app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(paramsForm);else{var errorField,message=data.error.message;errorField=513==data.error.code?form.find('[name="fieldLabel"]'):form.find('[name="fieldName"]'),errorField.validationEngine('showPrompt',message,'error','topLeft',!0);}});}var thisInstance=this;element=jQuery(element),app.showModalWindow(null,'index.php?module=Home&view=ChartFilter&step=step1',function(wizardContainer){var form=jQuery('form',wizardContainer),chartType=jQuery('select[name="chartType"]',wizardContainer),moduleNameSelectDOM=jQuery('select[name="module"]',wizardContainer),moduleNameSelect2=App.Fields.Picklist.showSelect2ElementView(moduleNameSelectDOM,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),step1=jQuery('.step1',wizardContainer),step2=jQuery('.step2',wizardContainer),step3=jQuery('.step3',wizardContainer),footer=jQuery('.modal-footer',wizardContainer);step2.remove(),step3.remove(),footer.hide(),chartType.on('change',function(e){var currentTarget=$(e.currentTarget),value=currentTarget.val();'Barchat'==value||'Horizontal'==value?form.find('.isColorContainer').removeClass('d-none'):form.find('.isColorContainer').addClass('d-none'),4==wizardContainer.find('#widgetStep').val()&&wizardContainer.find('.step3 .groupField').trigger('change');}),moduleNameSelect2.on('change',function(){moduleNameSelect2.val()&&(footer.hide(),wizardContainer.find('.step2').remove(),wizardContainer.find('.step3').remove(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step2',chartType:chartType.val(),selectedModule:moduleNameSelect2.val()}).done(function(step2Response){step1.after(step2Response),wizardContainer.find('#widgetStep').val(2);var step2=wizardContainer.find('.step2');footer.hide();var filtersIdElement=step2.find('.filtersId'),valueTypeElement=step2.find('.valueType');App.Fields.Picklist.showSelect2ElementView(filtersIdElement),App.Fields.Picklist.showSelect2ElementView(valueTypeElement),step2.find('.filtersId, .valueType').on('change',function(){wizardContainer.find('.step3').remove(),wizardContainer.find('.step4').remove(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step3',selectedModule:moduleNameSelect2.val(),chartType:chartType.val(),filtersId:filtersIdElement.val(),valueType:valueTypeElement.val()}).done(function(step3Response){step2.last().after(step3Response),wizardContainer.find('#widgetStep').val(3);var step3=wizardContainer.find('.step3');App.Fields.Picklist.showSelect2ElementView(step3.find('select')),footer.hide(),step3.find('.groupField').on('change',function(){wizardContainer.find('.step4').remove();var groupField=$(this);groupField.val()&&(footer.show(),AppConnector.request({module:'Home',view:'ChartFilter',step:'step4',selectedModule:moduleNameSelect2.val(),filtersId:filtersIdElement.val(),groupField:groupField.val(),chartType:chartType.val()}).done(function(step4Response){step3.last().after(step4Response),wizardContainer.find('#widgetStep').val(4);var step4=wizardContainer.find('.step4');App.Fields.Picklist.showSelect2ElementView(step4.find('select'));}));});});});}));}),form.on('submit',function(e){e.preventDefault();var selectedModule=moduleNameSelect2.val(),selectedModuleLabel=moduleNameSelect2.find(':selected').text(),selectedFilterId=form.find('.filtersId').val(),selectedFieldLabel=form.find('.groupField').find(':selected').text(),data={module:selectedModule,groupField:form.find('.groupField').val(),chartType:chartType.val()};form.find('.saveParam').each(function(index,element){element=$(element),element.is('input')&&'checkbox'===element.prop('type')&&!element.prop('checked')||(data[element.attr('name')]=element.val());}),finializeAddChart(selectedModuleLabel,selectedFilterId,null,selectedFieldLabel,data,form);});});},addNoteBookWidget:function addNoteBookWidget(element){var thisInstance=this;element=jQuery(element),app.showModalWindow(null,'index.php?module=Home&view=AddNotePad',function(wizardContainer){var form=jQuery('form',wizardContainer);form.validationEngine($.extend(!0,{onValidationComplete:function onValidationComplete(form,valid){if(valid){jQuery('[name=\'saveButton\']',wizardContainer).attr('disabled','disabled');var notePadName=form.find('[name="notePadName"]').val(),notePadContent=form.find('[name="notePadContent"]').val(),linkId=element.data('linkid'),blockId=element.data('block-id'),noteBookParams={module:jQuery('#selectedModuleName').val(),action:'NoteBook',mode:'noteBookCreate',notePadName:notePadName,notePadContent:notePadContent,blockid:blockId,linkId:linkId,isdefault:0,width:4,height:3};AppConnector.request(noteBookParams).done(function(data){if(data.result.success){var widgetId=data.result.widgetId;app.hideModalWindow(),noteBookParams.id=widgetId,noteBookParams.label=notePadName,Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_WIDGET_ADDED')}),thisInstance.showCustomField(noteBookParams);}});}return !1}},app.validationEngineOptions));});},addMiniListWidget:function addMiniListWidget(element){var thisInstance=this;element=jQuery(element),app.showModalWindow(null,'index.php?module=Home&view=MiniListWizard&step=step1',function(wizardContainer){var form=jQuery('form',wizardContainer),moduleNameSelectDOM=jQuery('select[name="module"]',wizardContainer),filteridSelectDOM=jQuery('select[name="filterid"]',wizardContainer),fieldsSelectDOM=jQuery('select[name="fields"]',wizardContainer),filterFieldsSelectDOM=jQuery('select[name="filter_fields"]',wizardContainer),moduleNameSelect2=App.Fields.Picklist.showSelect2ElementView(moduleNameSelectDOM,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),filteridSelect2=App.Fields.Picklist.showSelect2ElementView(filteridSelectDOM,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')}),fieldsSelect2=App.Fields.Picklist.showSelect2ElementView(fieldsSelectDOM,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION'),closeOnSelect:!0,maximumSelectionLength:6}),filterFieldsSelect2=App.Fields.Picklist.showSelect2ElementView(filterFieldsSelectDOM,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')}),footer=jQuery('.modal-footer',wizardContainer);filteridSelectDOM.closest('tr').hide(),fieldsSelectDOM.closest('tr').hide(),filterFieldsSelectDOM.closest('tr').hide(),footer.hide(),moduleNameSelect2.on('change',function(){moduleNameSelect2.val()&&AppConnector.request({module:'Home',view:'MiniListWizard',step:'step2',selectedModule:moduleNameSelect2.val()}).done(function(res){filteridSelectDOM.empty().html(res).trigger('change'),filteridSelect2.closest('tr').show(),fieldsSelectDOM.closest('tr').hide(),filterFieldsSelectDOM.closest('tr').hide();});}),filteridSelect2.on('change',function(){filteridSelect2.val()&&(footer.hide(),fieldsSelectDOM.closest('tr').hide(),filterFieldsSelectDOM.closest('tr').hide(),AppConnector.request({module:'Home',view:'MiniListWizard',step:'step3',selectedModule:moduleNameSelect2.val(),filterid:filteridSelect2.val()}).done(function(res){res=$(res),fieldsSelectDOM.empty().html(res.find('select[name="fields"]').html()).trigger('change'),filterFieldsSelectDOM.empty().html(res.find('select[name="filter_fields"]').html()).trigger('change'),fieldsSelect2.closest('tr').show(),filterFieldsSelect2.closest('tr').show(),fieldsSelect2.data('select2').$selection.find('.select2-search__field').parent().css('width','100%'),filterFieldsSelect2.data('select2').$selection.find('.select2-search__field').parent().css('width','100%');}));}),fieldsSelect2.on('change',function(){fieldsSelect2.val()?footer.show():footer.hide();}),form.on('submit',function(e){e.preventDefault();var selectedFields=[];fieldsSelect2.select2('data').map(function(obj){selectedFields.push(obj.id);});var data={module:moduleNameSelect2.val(),fields:selectedFields,filterFields:filterFieldsSelect2.val()},paramsForm={data:JSON.stringify(data),action:'addWidget',blockid:element.data('block-id'),title:form.find('[name="widgetTitle"]').val(),linkid:element.data('linkid'),label:moduleNameSelect2.find(':selected').text()+' - '+filteridSelect2.find(':selected').text(),name:'Mini List',filterid:filteridSelect2.val(),isdefault:0,cache:0,height:4,width:4,owners_all:['mine','all','users','groups'],default_owner:'mine'};thisInstance.save(paramsForm,'save').done(function(data){var result=data.result,params={};if(data.success)app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(paramsForm);else{var errorField,message=data.error.message;errorField=513===data.error.code?form.find('[name="fieldLabel"]'):form.find('[name="fieldName"]'),errorField.validationEngine('showPrompt',message,'error','topLeft',!0);}});});});},registerDeleteCustomFieldEvent:function registerDeleteCustomFieldEvent(contents){var thisInstance=this;'undefined'==typeof contents&&(contents=jQuery('#layoutDashBoards')),contents.find('a.deleteCustomField').on('click',function(e){var currentTarget=jQuery(e.currentTarget),fieldId=currentTarget.data('field-id'),paramsForm={};paramsForm.action='removeWidget',paramsForm.id=fieldId;var message=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){thisInstance.save(paramsForm,'delete').done(function(){var field=currentTarget.closest('div.editFieldsWidget'),blockId=field.data('block-id');field.parent().fadeOut('slow').remove();var block=jQuery('#block_'+blockId);thisInstance.reArrangeBlockFields(block);var params={};params.text=app.vtranslate('JS_CUSTOM_FIELD_DELETED'),Settings_Vtiger_Index_Js.showMessage(params);});});});},reArrangeBlockFields:function reArrangeBlockFields(block){var leftSideContainer=block.find('ul[name=sortable1]'),rightSideContainer=block.find('ul[name=sortable2]');if(leftSideContainer.children().length<rightSideContainer.children().length){var lastElementInRightContainer=rightSideContainer.children(':last');leftSideContainer.append(lastElementInRightContainer);}else if(leftSideContainer.children().length>rightSideContainer.children().length+1){var lastElementInLeftContainer=leftSideContainer.children(':last');rightSideContainer.append(lastElementInLeftContainer);}},registerDeleteCustomBlockEvent:function registerDeleteCustomBlockEvent(){var thisInstance=this,contents=jQuery('#layoutDashBoards');contents.on('click','.js-delete-custom-block-btn',function(e){var currentTarget=jQuery(e.currentTarget),table=currentTarget.closest('div.editFieldsTable'),blockId=table.data('block-id'),paramsFrom={};paramsFrom.blockid=blockId,paramsFrom.action='removeBlock';var message=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){thisInstance.save(paramsFrom,'delete').done(function(){thisInstance.removeDeletedBlock(blockId,'delete');var params={};params.text=app.vtranslate('JS_CUSTOM_BLOCK_DELETED'),Settings_Vtiger_Index_Js.showMessage(params);});});});},removeDeletedBlock:function removeDeletedBlock(blockId){var contents=jQuery('#layoutDashBoards'),deletedTable=contents.find('.block_'+blockId);deletedTable.fadeOut('slow').remove();},registerModulesChangeEvent:function registerModulesChangeEvent(){var thisInstance=this,container=$('#widgetsManagementEditorContainer'),contentsDiv=container.closest('.contentsDiv');App.Fields.Picklist.changeSelectElementView(container.find('[name="widgetsManagementEditorModules"]')),container.on('change','[name="widgetsManagementEditorModules"]',function(e){thisInstance.getModuleLayoutEditor($(e.currentTarget).val(),thisInstance.getCurrentDashboardId()).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});},updateContentsDiv:function updateContentsDiv(contentsDiv,data){contentsDiv.html(data),App.Fields.Picklist.showSelect2ElementView(contentsDiv.find('.select2')),this.registerEvents();},getModuleLayoutEditor:function getModuleLayoutEditor(selectedModule,selectedDashboard){var aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view='Configuration',params.sourceModule=selectedModule,params.dashboardId=selectedDashboard,AppConnector.requestPjax(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject();}),aDeferred.promise()},registerEvents:function registerEvents(){var thisInstance=this;thisInstance.registerAddBlockDashBoard(),thisInstance.registerAddCustomFieldEvent(),thisInstance.registerEditFieldDetailsClick(),thisInstance.registerSpecialWidget(),thisInstance.registerDeleteCustomFieldEvent(),thisInstance.registerDeleteCustomBlockEvent(),thisInstance.registerModulesChangeEvent(),thisInstance.setWidgetWithFilterUsers(),thisInstance.setRestrictFilter(),thisInstance.setWidgetWithFilterDate(),thisInstance.registerAddedDashboard(),thisInstance.registerSelectDashboard(),thisInstance.registerDashboardAction();}}),jQuery(document).ready(function(){var instance=new Settings_WidgetsManagement_Js;instance.registerEvents();});
//# sourceMappingURL=WidgetsManagement.min.js.map
