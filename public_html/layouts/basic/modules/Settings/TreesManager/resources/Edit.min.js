'use strict';

jQuery.Class('Settings_TreesManager_Edit_Js',{},{jstreeInstance:!1,jstreeLastID:0,registerEvents:function d(){var a=this,b=$('#EditView'),c=a.createTree();b.validationEngine(),$('.addNewElementBtn').on('click',function(){var b=$('input.addNewElement'),d=c.jstree(!0);if(''===b.val()){var e=app.vtranslate('JS_FIELD_CAN_NOT_BE_EMPTY');return b.validationEngine('showPrompt',e,'error','bottomLeft',!0),!1}a.jstreeLastID+=1,d.create_node('#',{id:a.jstreeLastID,text:b.val(),icon:!1},'last'),b.val('');}),$('.saveTree').on('click',function(){c.jstree('deselect_all',!0);var a=c.jstree('get_json'),d=[];$.each(a,function(a,b){b.text==b.li_attr.text&&(b.text=b.li_attr.key),d[a]=b;}),$('#treeValues').val(JSON.stringify(d)),b.submit();}),$('.addNewElement').on('keydown',function(a){if(13==a.keyCode)return $('.addNewElementBtn').trigger('click'),a.preventDefault(),!1});},createTree:function d(){var a=this;if(!1==this.jstreeInstance){a.jstreeLastID=parseInt($('#treeLastID').val());var b=$('#treeValues').val(),c=JSON.parse(b);a.jstreeInstance=$('#treeContents'),a.jstreeInstance.jstree({core:{data:c,themes:{name:'proton',responsive:!0},check_callback:!0},contextmenu:{items:{create:{label:app.vtranslate('JS_JSTREE_CREATE'),action:function d(b){var c=$.jstree.reference(b.reference);obj=c.get_node(b.reference),++a.jstreeLastID,c.create_node(obj,{id:a.jstreeLastID,text:app.vtranslate('JS_NEW_ITEM')},'last',function(a){setTimeout(function(){c.edit(a);},0);});}},rename:{label:app.vtranslate('JS_JSTREE_RENAME'),action:function d(a){var b=$.jstree.reference(a.reference),c=b.get_node(a.reference);b.edit(c);}},changeIcon:{label:app.vtranslate('JS_JSTREE_CHANGE_ICON'),action:function e(b){var c=$.jstree.reference(b.reference),d=c.get_node(b.reference);Settings_Vtiger_Index_Js.selectIcon().done(function(b){'-'==b.name?a.jstreeInstance.jstree(!0).set_icon(d.id,!1):a.jstreeInstance.jstree(!0).set_icon(d.id,b.name);});}},remove:{label:app.vtranslate('JS_JSTREE_REMOVE'),action:function g(b){var c=$.jstree.reference(b.reference),d=c.get_node(b.reference),f=c.get_selected(),e=!0;$.each(f,function(a,b){var d=c.get_node(b);0<d.children.length&&(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_YOU_CANNOT_DELETE_PERENT_ITEM'),type:'error'}),e=!1);}),e&&a.deleteItemEvent(f,c).done(function(a){0<a.length&&$.each(f,function(a,b){c.delete_node(b);});});}},ccp:{label:app.vtranslate('JS_JSTREE_CCP'),submenu:{cut:{label:app.vtranslate('JS_JSTREE_CUT'),action:function d(a){var b=$.jstree.reference(a.reference),c=b.get_node(a.reference);b.is_selected(c)?b.cut(b.get_top_selected()):b.cut(c);}},paste:{label:app.vtranslate('JS_JSTREE_PASTE'),action:function d(a){var b=$.jstree.reference(a.reference),c=b.get_node(a.reference);b.paste(c);}}}}}},plugins:['contextmenu','dnd']});}return this.jstreeInstance},deleteItemEvent:function f(a,b){var c=this,d=jQuery.Deferred(),e=b.get_json();return ($.each(a,function(a,b){e=c.checkChildren(b,e);}),0==e.length)?(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_YOU_CANNOT_DELETE_ALL_THE_ITEMS'),type:'error'}),d.resolve(),d.promise()):(app.showModalWindow(null,'index.php?module=TreesManager&parent=Settings&view=ReplaceTreeItem',function(b){var c=jQuery('form',b);jstreeInstanceReplace=b.find('#treePopupContents'),jstreeInstanceReplace.jstree({core:{data:e,themes:{name:'proton',responsive:!0}}}).on('loaded.jstree',function(){$(this).jstree('open_all');}),c.on('submit',function(){var b=jstreeInstanceReplace.jstree('get_selected'),c=$('#replaceIds').val();if(''==c)var e=[];else var e=JSON.parse(c);if(!b.length){var f={};return f.type='error',f.text=app.vtranslate('JS_NO_ITEM_SELECTED'),Settings_Vtiger_Index_Js.showMessage(f),!1}if(1<b.length){var f={};return f.type='error',f.text=app.vtranslate('JS_ONLY_ONE_ITEM_SELECTED'),Settings_Vtiger_Index_Js.showMessage(f),!1}e=$.merge(e,[{old:a,new:b}]),$('#replaceIds').val(JSON.stringify(e)),app.hideModalWindow(),d.resolve(b);});}),d.promise())},checkChildren:function f(a,b){var c=this,d=[];for(var e in b)b[e].id!=a&&(b[e].children.length&&(b[e].children=c.checkChildren(a,b[e].children)),d.push(b[e]));return d}});
