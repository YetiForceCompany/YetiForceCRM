'use strict';

/* {[The file is published on the basis of YetiForce Public License 4.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */'use strict';/**
 *  Class representing a modal calendar.
 * @extends Calendar_CalendarExtended_Js
 */function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor);}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _get(target,property,receiver){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}},_get(target,property,receiver||target)}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&(object=_getPrototypeOf(object),null!==object););return object}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(self)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return !1;if(Reflect.construct.sham)return !1;if("function"==typeof Proxy)return !0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return !1}}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}window.Calendar_CalendarModal_Js=/*#__PURE__*/function(_Calendar_CalendarExt){function Calendar_CalendarModal_Js(container,readonly){var _this;return _classCallCheck(this,Calendar_CalendarModal_Js),_this=_super.call(this,container,readonly),_this.isSwitchAllDays=!1,_this.sidebarName="add",_this.eventCreate=!0,_this.module="Calendar",_this.renderCalendar(),_this.registerEvents(),_this}/**
	 * Render calendar
	 */_inherits(Calendar_CalendarModal_Js,_Calendar_CalendarExt);var _super=_createSuper(Calendar_CalendarModal_Js);return _createClass(Calendar_CalendarModal_Js,[{key:"renderCalendar",value:function renderCalendar(){var self=this,basicOptions=this.setCalendarOptions(),options={header:{left:"month,"+app.getMainParams("weekView")+","+app.getMainParams("dayView"),center:"prevYear,prev,title,next,nextYear",right:"today"},views:{basic:{eventLimit:!1},year:{eventLimit:10,eventLimitText:app.vtranslate("JS_COUNT_RECORDS"),titleFormat:"YYYY",select:function select(){},loadView:function loadView(){self.getCalendarView().fullCalendar("getCalendar").view.render();}},month:{titleFormat:this.parseDateFormat("month"),loadView:function loadView(){self.loadCalendarData();}},week:{titleFormat:this.parseDateFormat("week"),loadView:function loadView(){self.loadCalendarData();}},day:{titleFormat:this.parseDateFormat("day"),loadView:function loadView(){self.loadCalendarData();}},basicDay:{type:"agendaDay",loadView:function loadView(){self.loadCalendarData();}}},select:function select(start,end){self.selectDays(start,end),self.getCalendarView().fullCalendar("unselect");},eventRender:function eventRender(event,element){self.eventRenderer(event,element);},viewRender:function viewRender(view){"year"!==view.type&&self.loadCalendarData(view);},addCalendarEvent:function addCalendarEvent(calendarDetails){self.getCalendarView().fullCalendar("renderEvent",self.getEventData(calendarDetails));}};options=Object.assign(basicOptions,options),options.eventClick=function(calEvent,jsEvent){jsEvent.preventDefault();},this.calendar.fullCalendar(options);}},{key:"addCommonMethodsToYearView",value:function addCommonMethodsToYearView(){}/**
	 * Function sets calendar moduls's options
	 * Overwrites Calendar_Calendar_Js
	 */},{key:"setCalendarModuleOptions",value:function setCalendarModuleOptions(){var options=_get(_getPrototypeOf(Calendar_CalendarModal_Js.prototype),"setCalendarModuleOptions",this).call(this);return options.hiddenDays=app.getMainParams("hiddenDays",!0),options.header={left:"month,"+app.getMainParams("weekView")+","+app.getMainParams("dayView"),center:"prevYear,prev,title,next,nextYear",right:"today"},options.selectable=!0,options}/**
	 * Function registers calendar events
	 * Overwrites Calendar_CalendarExtended_Js
	 */},{key:"registerEvents",value:function registerEvents(){this.registerSwitchEvents(),this.registerUsersChange(),this.registerAutofillTime(),this.registerPopoverButtonsClickEvent();}/**
	 * Function registers calendar switch event
	 * Overwrites Calendar_CalendarExtended_Js
	 */},{key:"registerSwitchEvents",value:function registerSwitchEvents(){var _this2=this;if(!1!==app.getMainParams("hiddenDays",!0)){var calendarview=this.getCalendarView(),switchContainer=$("<div class=\"js-calendar-switch-container\"></div>").insertAfter(calendarview.find(".fc-center"));$(this.switchTpl(app.vtranslate("JS_WORK_DAYS"),app.vtranslate("JS_ALL"),this.isSwitchAllDays)).prependTo(switchContainer).on("change","input",function(e){var currentTarget=$(e.currentTarget),hiddenDays=[];"undefined"==typeof currentTarget.data("on-text")?_this2.isSwitchAllDays=!0:(hiddenDays=app.getMainParams("hiddenDays",!0),_this2.isSwitchAllDays=!1),_this2.getCalendarView().fullCalendar("option","hiddenDays",hiddenDays),"year"===_this2.getCalendarView().fullCalendar("getView").type&&_this2.registerViewRenderEvents(_this2.getCalendarView().fullCalendar("getView")),_this2.registerSwitchEvents();});}}/**
	 * Function registers select's user change event
	 * Overwrites Calendar_CalendarExtended_Js
	 */},{key:"registerUsersChange",value:function registerUsersChange(){var _this3=this;this.container.find(".assigned_user_id").on("change",function(){_this3.getCalendarView().fullCalendar("getCalendar").view.options.loadView();});}/**
	 * Function return user's id
	 * Overwrites Calendar_CalendarExtended_Js
	 * @returns {int}
	 */},{key:"getSelectedUsersCalendar",value:function getSelectedUsersCalendar(){return this.container.find(".assigned_user_id").val()}/**
	 * Function invokes by fullcalendar, sets selected days in form
	 * Overwrites Calendar_CalendarExtended_Js
	 * @param startDate
	 * @param endDate
	 */},{key:"selectDays",value:function selectDays(startDate,endDate){var _this4=this;if("status"===this.sidebarName)return this.sidebarName="add",void this.getCalendarCreateView().done(function(){_this4.selectDays(startDate,endDate);});var startHour=app.getMainParams("startHour"),endHour=app.getMainParams("endHour"),view=this.getCalendarView().fullCalendar("getView");if(!1==endDate.hasTime()&&endDate.add(-1,"days"),startDate=startDate.format(),endDate=endDate.format(),""==startHour&&(startHour="00"),""==endHour&&(endHour="00"),"agendaDay"!=view.name&&"agendaWeek"!=view.name&&(startDate=startDate+"T"+startHour+":00",endDate=endDate+"T"+endHour+":00",startDate==endDate)){var activityType=this.container.find("[name=\"activitytype\"]").val(),activityDurations=JSON.parse(this.container.find("[name=\"defaultOtherEventDuration\"]").val()),minutes=0;for(var i in activityDurations)if(activityDurations[i].activitytype===activityType){minutes=parseInt(activityDurations[i].duration);break}endDate=moment(endDate).add(minutes,"minutes").toISOString();}var dateFormat=this.container.find("[name=\"date_start\"]").data("dateFormat").toUpperCase(),timeFormat=this.container.find("[name=\"time_start\"]").data("format"),defaultTimeFormat="";if(defaultTimeFormat=24==timeFormat?"HH:mm":"hh:mm A",this.container.find("[name=\"date_start\"]").val(moment(startDate).format(dateFormat)),this.container.find("[name=\"due_date\"]").val(moment(endDate).format(dateFormat)),!0===this.container.find(".js-autofill").prop("checked")){var calendarEditInstance=new Calendar_Edit_Js;calendarEditInstance.getFreeTime(this.container);}else this.container.find("[name=\"time_start\"]").val(moment(startDate).format(defaultTimeFormat)),this.container.find("[name=\"time_end\"]").val(moment(endDate).format(defaultTimeFormat));}/** @inheritdoc */},{key:"registerEditForm",value:function registerEditForm(sideBar){var _this5=this,editViewInstance=Vtiger_Edit_Js.getInstanceByModuleName(sideBar.find("[name=\"module\"]").val()),rightFormCreate=sideBar.find("form.js-form");editViewInstance.registerBasicEvents(rightFormCreate),rightFormCreate.validationEngine(app.validationEngineOptions),App.Fields.Picklist.showSelect2ElementView(sideBar.find("select")),sideBar.find(".js-summary-close-edit").on("click",function(){_this5.getCalendarCreateView();}),App.Components.QuickCreate.registerPostLoadEvents(rightFormCreate,[]),App.Fields.Text.Editor.register(sideBar.find(".js-editor"),{height:"5em",toolbar:"Min"});}/** @inheritdoc */},{key:"updateSidebar",value:function updateSidebar(sidebar,data){var modalTitleContainer=$(".js-modal-title__container"),modalTitles=modalTitleContainer.find("[class*=\"js-modal-title\"]");if(data=$(data),modalTitles.addClass("d-none"),data.hasClass("js-edit-form")){var title=data.find(".js-sidebar-title ").data("title");modalTitles.filter(".js-modal-title--".concat(title)).removeClass("d-none"),this.sidebarName=title;}else data.hasClass("js-activity-state")&&(modalTitles.filter(".js-modal-title--status").removeClass("d-none"),this.sidebarName="status");sidebar.find(".js-qc-form").html(data);}}]),Calendar_CalendarModal_Js}(Calendar_CalendarExtended_Js),jQuery.Class("Calendar_QuickCreate_Js",{},{container:!1,getContainer:function getContainer(){return this.container},setContainer:function setContainer(container){this.container=container;},registerExtendCalendar:function registerExtendCalendar(){new Calendar_CalendarModal_Js($(".js-modal-container"),!0);var container=this.getContainer();container.find(".js-activity-buttons button").on("click",function(e){var form=container.find("form"),currentTarget=$(e.currentTarget);1===currentTarget.data("type")?(form.append("<input type=hidden name=\"activitystatus\" value=\""+currentTarget.data("state")+"\">"),form.submit()):(container.find(".js-activity-buttons").remove(),form.find("[name=\"record\"]").val(""),form.append("<input type=hidden name=\"postponed\" value=\"true\">"),form.append("<input type=hidden name=\"followup\" value=\""+currentTarget.data("id")+"\">"));});},registerStandardCalendar:function registerStandardCalendar(){var thisInstance=this,container=this.getContainer(),data=container.find("form"),user=data.find("[name=\"assigned_user_id\"]"),dateStartEl=data.find("[name=\"date_start\"]"),dateEnd=data.find("[name=\"due_date\"]");user.on("change",function(e){var element=$(e.currentTarget),data=element.closest("form");thisInstance.getNearCalendarEvent(data);}),dateStartEl.on("change",function(e){var element=$(e.currentTarget),data=element.closest("form");thisInstance.getNearCalendarEvent(data);}),data.find("ul li a").on("click",function(e){var element=$(e.currentTarget),data=element.closest("form");data.find(".addedNearCalendarEvent").remove(),thisInstance.getNearCalendarEvent(data);}),data.on("click",".nextDayBtn",function(){var dateStartEl=data.find("[name=\"date_start\"]"),startDay=dateStartEl.val(),dateStartFormat=dateStartEl.data("date-format");startDay=moment(Vtiger_Helper_Js.convertToDateString(startDay,dateStartFormat,"+7"," ")).format(dateStartFormat.toUpperCase()),dateStartEl.val(startDay),dateEnd.val(startDay),thisInstance.getNearCalendarEvent(data);}),data.on("click",".previousDayBtn",function(){var dateStartEl=data.find("[name=\"date_start\"]"),startDay=dateStartEl.val(),dateStartFormat=dateStartEl.data("date-format");startDay=moment(Vtiger_Helper_Js.convertToDateString(startDay,dateStartFormat,"-7"," ")).format(dateStartFormat.toUpperCase()),dateStartEl.val(startDay),dateEnd.val(startDay),thisInstance.getNearCalendarEvent(data);}),data.on("click",".dateBtn",function(e){var element=$(e.currentTarget);dateStartEl.val(element.data("date")),data.find("[name=\"due_date\"]").val(element.data("date")),data.find("[name=\"date_start\"]").trigger("change");}),thisInstance.getNearCalendarEvent(data);},getNearCalendarEvent:function getNearCalendarEvent(container){var dateStartVal=container.find("[name=\"date_start\"]").val();if("undefined"!=typeof dateStartVal&&""!==dateStartVal){var params={module:"Calendar",view:"QuickCreateEvents",currentDate:dateStartVal,user:container.find("[name=\"assigned_user_id\"]").val()},progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:container.find(".eventsTable")}});AppConnector.request(params).done(function(events){progressIndicatorElement.progressIndicator({mode:"hide"}),container.find(".eventsTable").remove(),container.append(events),app.showPopoverElementView(container.find(".js-help-info"));});}},registerEvents:function registerEvents(container){var calendarType=container.closest(".js-modal-container").find(".js-calendar-type").val();this.setContainer(container),"Extended"===calendarType?this.registerExtendCalendar():this.registerStandardCalendar();}});
//# sourceMappingURL=QuickCreate.min.js.map
