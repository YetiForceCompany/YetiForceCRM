'use strict';

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

var get = function get(object, property, receiver) {
  if (object === null) object = Function.prototype;
  var desc = Object.getOwnPropertyDescriptor(object, property);

  if (desc === undefined) {
    var parent = Object.getPrototypeOf(object);

    if (parent === null) {
      return undefined;
    } else {
      return get(parent, property, receiver);
    }
  } else if ("value" in desc) {
    return desc.value;
  } else {
    var getter = desc.get;

    if (getter === undefined) {
      return undefined;
    }

    return getter.call(receiver);
  }
};

var inherits = function (subClass, superClass) {
  if (typeof superClass !== "function" && superClass !== null) {
    throw new TypeError("Super expression must either be null or a function, not " + typeof superClass);
  }

  subClass.prototype = Object.create(superClass && superClass.prototype, {
    constructor: {
      value: subClass,
      enumerable: false,
      writable: true,
      configurable: true
    }
  });
  if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;
};

var possibleConstructorReturn = function (self, call) {
  if (!self) {
    throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
  }

  return call && (typeof call === "object" || typeof call === "function") ? call : self;
};

window.Calendar_Calendar_Js=function(_Calendar_Js){function _class(container,readonly){classCallCheck(this,_class);var _this=possibleConstructorReturn(this,(_class.__proto__||Object.getPrototypeOf(_class)).call(this,container,readonly));return _this.eventCreate=app.getMainParams("eventCreate"),_this}return inherits(_class,_Calendar_Js),createClass(_class,[{key:"setCalendarModuleOptions",value:function setCalendarModuleOptions(){var self=this,options={selectable:self.eventCreate,select:function select(start,end){self.selectDays(start,end),self.getCalendarView().fullCalendar("unselect");},eventClick:function eventClick(calEvent,jsEvent){jsEvent.preventDefault();var link=new URL($(this)[0].href),progressInstance=jQuery.progressIndicator({blockInfo:{enabled:!0}}),url="index.php?module=Calendar&view=ActivityStateModal&record="+link.searchParams.get("record");app.showModalWindow({url:url,cb:function callbackFunction(){progressInstance.progressIndicator({mode:"hide"});}});}};return options}},{key:"getValuesFromSelect2",value:function getValuesFromSelect2(element,data,text){if(element.hasClass("select2-hidden-accessible"))for(var types=element.select2("data"),i=0;i<types.length;i++)text?data.push(types[i].text):data.push(types[i].id);return data}},{key:"getDefaultParams",value:function getDefaultParams(){var parentParams=get(_class.prototype.__proto__||Object.getPrototypeOf(_class.prototype),"getDefaultParams",this).call(this),users=app.moduleCacheGet("calendar-groups")||[],filters=[];$(".calendarFilters .filterField").each(function(){var name,value,element=$(this);"checkbox"==element.attr("type")?(name=element.val(),value=element.prop("checked")?1:0):(name=element.attr("name"),value=element.val()),filters.push({name:name,value:value});});var params={time:app.getMainParams("showType"),filters:filters};return users.length&&(params.user=parentParams.user.concat(users),params.emptyFilters=!1),params=Object.assign(parentParams,params),params}},{key:"selectDays",value:function selectDays(startDate,endDate){var thisInstance=this,start_hour=app.getMainParams("startHour"),end_hour=app.getMainParams("endHour");!1==endDate.hasTime()&&endDate.add(-1,"days"),startDate=startDate.format(),endDate=endDate.format();var view=thisInstance.getCalendarView().fullCalendar("getView");""==start_hour&&(start_hour="00"),""==end_hour&&(end_hour="00"),this.getCalendarCreateView().done(function(data){if(!(0>=data.length)){if("agendaDay"!=view.name&&"agendaWeek"!=view.name&&(startDate=startDate+"T"+start_hour+":00",endDate=endDate+"T"+start_hour+":00",startDate==endDate)){var activityType=data.find("[name=\"activitytype\"]").val(),activityDurations=JSON.parse(data.find("[name=\"defaultOtherEventDuration\"]").val()),minutes=0;for(var i in activityDurations)if(activityDurations[i].activitytype===activityType){minutes=parseInt(activityDurations[i].duration);break}endDate=moment(endDate).add(minutes,"minutes").toISOString();}var dateFormat=data.find("[name=\"date_start\"]").data("dateFormat").toUpperCase(),timeFormat=data.find("[name=\"time_start\"]").data("format");if(24==timeFormat)var defaultTimeFormat="HH:mm";else defaultTimeFormat="hh:mm A";var startDateString=moment(startDate).format(dateFormat),startTimeString=moment(startDate).format(defaultTimeFormat),endDateString=moment(endDate).format(dateFormat),endTimeString=moment(endDate).format(defaultTimeFormat);data.find("[name=\"date_start\"]").val(startDateString),data.find("[name=\"due_date\"]").val(endDateString),data.find("[name=\"time_start\"]").val(startTimeString),data.find("[name=\"time_end\"]").val(endTimeString);var headerInstance=new Vtiger_Header_Js;headerInstance.handleQuickCreateData(data,{callbackFunction:function callbackFunction(data){thisInstance.addCalendarEvent(data.result);}});}});}},{key:"isNewEventToDisplay",value:function isNewEventToDisplay(eventObject){if(get(_class.prototype.__proto__||Object.getPrototypeOf(_class.prototype),"isNewEventToDisplay",this).call(this,eventObject)){var taskstatus=$.inArray(eventObject.activitystatus.value,["PLL_POSTPONED","PLL_CANCELLED","PLL_COMPLETED"]),state=$(".fc-toolbar .js-switch--label-on").last().hasClass("active");return !(!0===state&&0<=taskstatus||!0!=state&&-1==taskstatus)}return !1}},{key:"getCalendarCreateView",value:function getCalendarCreateView(){var thisInstance=this,aDeferred=jQuery.Deferred();if(!1!==this.calendarCreateView)return aDeferred.resolve(this.calendarCreateView.clone(!0,!0)),aDeferred.promise();var progressInstance=jQuery.progressIndicator({blockInfo:{enabled:!0}});return this.loadCalendarCreateView().done(function(data){progressInstance.progressIndicator({mode:"hide"}),thisInstance.calendarCreateView=data,aDeferred.resolve(data.clone(!0,!0));}).fail(function(error){progressInstance.progressIndicator({mode:"hide"}),console.error(error);}),aDeferred.promise()}},{key:"loadCalendarCreateView",value:function loadCalendarCreateView(){var aDeferred=jQuery.Deferred(),moduleName=app.getModuleName(),headerInstance=Vtiger_Header_Js.getInstance();return headerInstance.getQuickCreateForm("index.php?module="+moduleName+"&view=QuickCreateAjax",moduleName).done(function(data){aDeferred.resolve(jQuery(data));}).fail(function(){aDeferred.reject();}),aDeferred.promise()}},{key:"switchTpl",value:function switchTpl(on,off,state){return "<div class=\"btn-group btn-group-toggle js-switch c-calendar-switch\" data-toggle=\"buttons\">\n\t\t\t\t\t<label class=\"btn btn-outline-primary c-calendar-switch__button js-switch--label-on "+(state?"":"active")+"\">\n\t\t\t\t\t\t<input type=\"radio\" name=\"options\" data-on-text=\""+on+"\" autocomplete=\"off\" "+(state?"":"checked")+">\n\t\t\t\t\t\t"+on+"\n\t\t\t\t\t</label>\n\t\t\t\t\t<label class=\"btn btn-outline-primary c-calendar-switch__button "+(state?"active":"")+"\">\n\t\t\t\t\t\t<input type=\"radio\" name=\"options\" data-off-text=\""+off+"\" autocomplete=\"off\" "+(state?"checked":"")+">\n\t\t\t\t\t\t"+off+"\n\t\t\t\t\t</label>\n\t\t\t\t</div>"}},{key:"registerSwitchEvents",value:function registerSwitchEvents(){var _this2=this,calendarview=this.getCalendarView(),switchHistory=void 0,switchAllDays=void 0,switchContainer=$("<div class=\"js-calendar-switch-container\"></div>").insertAfter(calendarview.find(".fc-center"));switchHistory="current"!=app.getMainParams("showType")||"history"==app.moduleCacheGet("defaultShowType"),$(this.switchTpl(app.vtranslate("JS_TO_REALIZE"),app.vtranslate("JS_HISTORY"),switchHistory)).prependTo(switchContainer).on("change","input",function(e){var currentTarget=$(e.currentTarget);"undefined"==typeof currentTarget.data("on-text")?"undefined"!=typeof currentTarget.data("off-text")&&(app.setMainParams("showType","history"),app.moduleCacheSet("defaultShowType","history")):(app.setMainParams("showType","current"),app.moduleCacheSet("defaultShowType","current")),_this2.loadCalendarData();}),switchAllDays="workDays"!==app.getMainParams("switchingDays")||"all"===app.moduleCacheGet("defaultSwitchingDays"),!1!==app.getMainParams("hiddenDays",!0)&&$(this.switchTpl(app.vtranslate("JS_WORK_DAYS"),app.vtranslate("JS_ALL"),switchAllDays)).prependTo(switchContainer).on("change","input",function(e){var currentTarget=$(e.currentTarget),hiddenDays=[];"undefined"==typeof currentTarget.data("on-text")?"undefined"!=typeof currentTarget.data("off-text")&&(app.setMainParams("switchingDays","all"),app.moduleCacheSet("defaultSwitchingDays","all")):(app.setMainParams("switchingDays","workDays"),app.moduleCacheSet("defaultSwitchingDays","workDays"),hiddenDays=app.getMainParams("hiddenDays",!0)),calendarview.fullCalendar("option","hiddenDays",hiddenDays),_this2.registerSwitchEvents(),_this2.loadCalendarData();});}},{key:"registerCacheSettings",value:function registerCacheSettings(){var thisInstance=this,calendar=thisInstance.getCalendarView();"all"==app.moduleCacheGet("defaultSwitchingDays")?app.setMainParams("switchingDays","all"):app.setMainParams("switchingDays","workDays"),"history"==app.moduleCacheGet("defaultShowType")?app.setMainParams("showType","history"):app.setMainParams("showType","current"),$(".siteBarRight .filterField").each(function(){var name=$(this).attr("id"),value=app.moduleCacheGet(name),element=$("#"+name);0<element.length&&null!=value&&"checkbox"==element.attr("type")&&element.prop("checked",value);}),calendar.find(".fc-toolbar .fc-button").on("click",function(e){var view=void 0,element=$(e.currentTarget);view=calendar.fullCalendar("getView"),element.hasClass("fc-"+view.name+"-button")?app.moduleCacheSet("defaultView",view.name):(element.hasClass("fc-prev-button")||element.hasClass("fc-next-button")||element.hasClass("fc-today-button"))&&(app.moduleCacheSet("start",view.start.format()),app.moduleCacheSet("end",view.end.format()));});var keys=app.moduleCacheKeys();if(0<keys.length){var alert=$("#moduleCacheAlert");$(".bodyContents").on("Vtiger.Widget.Load.undefined",function(){alert.removeClass("d-none");}),alert.find(".cacheClear").on("click",function(){app.moduleCacheClear(),alert.addClass("d-none"),location.reload();});}}},{key:"registerEvents",value:function registerEvents(){get(_class.prototype.__proto__||Object.getPrototypeOf(_class.prototype),"registerEvents",this).call(this),this.registerCacheSettings(),this.registerSwitchEvents();}}]),_class}(Calendar_Js);
//# sourceMappingURL=CalendarView.min.js.map
