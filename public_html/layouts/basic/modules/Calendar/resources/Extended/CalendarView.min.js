'use strict';

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

var get = function get(object, property, receiver) {
  if (object === null) object = Function.prototype;
  var desc = Object.getOwnPropertyDescriptor(object, property);

  if (desc === undefined) {
    var parent = Object.getPrototypeOf(object);

    if (parent === null) {
      return undefined;
    } else {
      return get(parent, property, receiver);
    }
  } else if ("value" in desc) {
    return desc.value;
  } else {
    var getter = desc.get;

    if (getter === undefined) {
      return undefined;
    }

    return getter.call(receiver);
  }
};

var inherits = function (subClass, superClass) {
  if (typeof superClass !== "function" && superClass !== null) {
    throw new TypeError("Super expression must either be null or a function, not " + typeof superClass);
  }

  subClass.prototype = Object.create(superClass && superClass.prototype, {
    constructor: {
      value: subClass,
      enumerable: false,
      writable: true,
      configurable: true
    }
  });
  if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;
};

var possibleConstructorReturn = function (self, call) {
  if (!self) {
    throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
  }

  return call && (typeof call === "object" || typeof call === "function") ? call : self;
};

/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */
/**
 *  Class representing an extended calendar.
 * @extends Calendar_Calendar_Js
 */

window.calendarLoaded = false; //Global calendar flag needed for correct loading data from history browser in year view
window.Calendar_CalendarExtended_Js = function (_Calendar_Calendar_Js) {
	inherits(_class, _Calendar_Calendar_Js);

	function _class(container, readonly) {
		classCallCheck(this, _class);

		var _this = possibleConstructorReturn(this, (_class.__proto__ || Object.getPrototypeOf(_class)).call(this, container, readonly));

		_this.sidebarView = {
			length: 0
		};
		_this.calendarContainer = false;
		_this.addCommonMethodsToYearView();
		_this.calendar = _this.getCalendarView();
		return _this;
	}

	/**
  * Function extends FC.views.year with current class methods
  */


	createClass(_class, [{
		key: 'addCommonMethodsToYearView',
		value: function addCommonMethodsToYearView() {
			var self = this;
			FC.views.year = FC.views.year.extend({
				selectDays: self.selectDays,
				getCalendarCreateView: self.getCalendarCreateView,
				getSidebarView: self.getSidebarView,
				getCurrentCvId: self.getCurrentCvId,
				getCalendarView: self.getCalendarView,
				showRightPanelForm: self.showRightPanelForm,
				getSelectedUsersCalendar: self.getSelectedUsersCalendar,
				registerClearFilterButton: self.registerClearFilterButton,
				clearFilterButton: self.clearFilterButton,
				registerFilterTabChange: self.registerFilterTabChange,
				sidebarView: self.sidebarView,
				registerAfterSubmitForm: self.registerAfterSubmitForm,
				registerViewRenderEvents: self.registerViewRenderEvents,
				appendSubDateRow: self.appendSubDateRow,
				refreshDatesRowView: self.refreshDatesRowView,
				generateYearList: self.generateYearList,
				updateCountTaskCalendar: self.updateCountTaskCalendar,
				registerDatesChange: self.registerDatesChange,
				addHeaderButtons: self.addHeaderButtons,
				browserHistoryConfig: self.browserHistoryConfig,
				readonly: self.readonly,
				container: self.container,
				module: self.module,
				showChangeDateButtons: self.showChangeDateButtons,
				showTodayButtonCheckbox: self.showTodayButtonCheckbox
			});
		}

		/**
   * Render calendar
   */

	}, {
		key: 'renderCalendar',
		value: function renderCalendar() {
			var self = this,
			    basicOptions = this.setCalendarOptions(),
			    options = {
				header: {
					left: 'year,month,' + app.getMainParams('weekView') + ',' + app.getMainParams('dayView'),
					center: 'prevYear,prev,title,next,nextYear',
					right: 'today'
				},
				views: {
					basic: {
						eventLimit: false
					},
					year: {
						eventLimit: 10,
						eventLimitText: app.vtranslate('JS_COUNT_RECORDS'),
						titleFormat: 'YYYY',
						select: function select(start, end) {},
						loadView: function loadView() {
							self.getCalendarView().fullCalendar('getCalendar').view.render();
						}
					},
					month: {
						titleFormat: this.parseDateFormat('month'),
						loadView: function loadView() {
							self.loadCalendarData();
						}
					},
					week: {
						titleFormat: this.parseDateFormat('week'),
						loadView: function loadView() {
							self.loadCalendarData();
						}
					},
					day: {
						titleFormat: this.parseDateFormat('day'),
						loadView: function loadView() {
							self.loadCalendarData();
						}
					},
					basicDay: {
						type: 'agendaDay',
						loadView: function loadView() {
							self.loadCalendarData();
						}
					}
				},
				select: function select(start, end) {
					self.selectDays(start, end);
					self.getCalendarView().fullCalendar('unselect');
				},
				eventRender: function eventRender(event, element) {
					self.eventRenderer(event, element);
				},
				viewRender: function viewRender(view, element) {
					if (view.type !== 'year') {
						self.loadCalendarData(view);
					}
				},
				addCalendarEvent: function addCalendarEvent(calendarDetails) {
					self.getCalendarView().fullCalendar('renderEvent', self.getEventData(calendarDetails));
				}
			};
			options = Object.assign(basicOptions, options);
			if (!this.readonly && self.eventEdit) {
				options.eventClick = function (calEvent, jsEvent) {
					jsEvent.preventDefault();
					self.getCalendarSidebarData($(this).attr('href'));
				};
			} else {
				options.eventClick = function (calEvent, jsEvent) {
					jsEvent.preventDefault();
					var link = new URL($(this)[0].href);
					window.location.assign('index.php?module=' + this.module + '&view=Detail&record=' + link.searchParams.get('record'));
				};
			}
			this.calendar.fullCalendar(options);
		}
	}, {
		key: 'registerChangeView',
		value: function registerChangeView() {}
	}, {
		key: 'addHeaderButtons',
		value: function addHeaderButtons() {
			if (this.calendarContainer.find('.js-calendar__view-btn').length) {
				return;
			}
			var buttonsContainer = this.calendarContainer.prev('.js-calendar__header-buttons'),
			    viewBtn = buttonsContainer.find('.js-calendar__view-btn').clone(),
			    filters = buttonsContainer.find('.js-calendar__filter-container').clone();
			this.calendarContainer.find('.fc-left').prepend(viewBtn);
			this.calendarContainer.find('.fc-center').after(filters);
			this.registerClearFilterButton();
			this.registerFilterTabChange();
		}
	}, {
		key: 'registerSwitchEvents',
		value: function registerSwitchEvents() {
			var _this2 = this;

			var calendarView = this.getCalendarView();
			var isWorkDays = void 0,
			    switchShowTypeVal = void 0,
			    switchContainer = $('.js-calendar__tab--filters'),
			    switchShowType = switchContainer.find('.js-switch--showType'),
			    switchSwitchingDays = switchContainer.find('.js-switch--switchingDays');
			var historyParams = app.getMainParams('historyParams', true);
			if (historyParams === '') {
				isWorkDays = app.getMainParams('switchingDays') === 'workDays' && app.moduleCacheGet('defaultSwitchingDays') !== 'all', switchShowTypeVal = app.getMainParams('showType') === 'current' && app.moduleCacheGet('defaultShowType') !== 'history';
				if (!switchShowTypeVal) {
					switchShowType.find('.js-switch--label-off').button('toggle');
				}
			} else {
				app.setMainParams('showType', historyParams.time);
				app.setMainParams('switchingDays', historyParams.hiddenDays === '' ? 'all' : 'workDays');
			}
			switchShowType.on('change', 'input', function (e) {
				var currentTarget = $(e.currentTarget);
				if (typeof currentTarget.data('on-text') !== 'undefined') {
					app.setMainParams('showType', 'current');
					app.moduleCacheSet('defaultShowType', 'current');
				} else if (typeof currentTarget.data('off-text') !== 'undefined') {
					app.setMainParams('showType', 'history');
					app.moduleCacheSet('defaultShowType', 'history');
				}
				calendarView.fullCalendar('getCalendar').view.options.loadView();
			});
			$('label.active', switchShowType).find('input').filter(':first').change();
			if (switchSwitchingDays.length) {
				if (typeof isWorkDays !== 'undefined' && !isWorkDays) {
					switchSwitchingDays.find('.js-switch--label-off').button('toggle');
				}
				switchSwitchingDays.on('change', 'input', function (e) {
					var currentTarget = $(e.currentTarget);
					var hiddenDays = [];
					if (typeof currentTarget.data('on-text') !== 'undefined') {
						app.setMainParams('switchingDays', 'workDays');
						app.moduleCacheSet('defaultSwitchingDays', 'workDays');
						hiddenDays = app.getMainParams('hiddenDays', true);
					} else if (typeof currentTarget.data('off-text') !== 'undefined') {
						app.setMainParams('switchingDays', 'all');
						app.moduleCacheSet('defaultSwitchingDays', 'all');
					}
					calendarView.fullCalendar('option', 'hiddenDays', hiddenDays);
					calendarView.fullCalendar('option', 'height', _this2.setCalendarHeight());
					if (calendarView.fullCalendar('getView').type === 'year') {
						_this2.registerViewRenderEvents(calendarView.fullCalendar('getView'));
					}
				});
				$('label.active', switchSwitchingDays).find('input').filter(':first').change();
			}
		}

		/**
   * Appends subdate row to calendar header and register its scroll
   * @param toolbar
   */

	}, {
		key: 'appendSubDateRow',
		value: function appendSubDateRow(toolbar) {
			if (!this.calendarContainer.find('.js-dates-row').length) {
				this.subDateRow = $('\n\t\t\t\t\t\t\t\t<div class="js-scroll js-dates-row u-overflow-auto-lg-down order-4 flex-grow-1 position-relative my-1 w-100" data-js="perfectScrollbar | container">\n\t\t\t\t\t\t\t\t\t<div class="d-flex flex-nowrap w-100">\n\t\t\t\t\t\t\t\t\t\t<div class="js-sub-date-list w-100 sub-date-list row no-gutters flex-nowrap nav nav-tabs" data-js="data-type"></div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t');
				toolbar.append(this.subDateRow);
				if ($(window).width() > app.breakpoints.lg) {
					app.showNewScrollbar(this.subDateRow);
				}
			}
		}

		/**
   * Function toggles next year/month and general arrows on view render
   * @param view
   * @param element
   */

	}, {
		key: 'registerViewRenderEvents',
		value: function registerViewRenderEvents(view) {
			this.calendarContainer = this.getCalendarView();
			var toolbar = this.calendarContainer.find('.fc-toolbar.fc-header-toolbar');
			this.showChangeDateButtons(view, toolbar);
			this.appendSubDateRow(toolbar);
			this.refreshDatesRowView(view);
			this.addHeaderButtons();
			this.showTodayButtonCheckbox(toolbar);
		}

		/**
   * Function appends and shows today button's checkbox
   * @param {jQuery} toolbar
   */

	}, {
		key: 'showTodayButtonCheckbox',
		value: function showTodayButtonCheckbox(toolbar) {
			var todayButton = toolbar.find('.fc-today-button'),
			    todyButtonIcon = todayButton.hasClass('fc-state-disabled') ? 'fa-calendar-check' : 'fa-calendar',
			    popoverContent = app.vtranslate('JS_CURRENT') + ' ' + toolbar.find('.fc-state-active').text().toLowerCase();
			todayButton.removeClass('.fc-button');
			todayButton.html('<div class="js-popover-tooltip--day-btn" data-toggle="popover"><span class="far fa-lg ' + todyButtonIcon + '"></span></div>');
			app.showPopoverElementView(todayButton.find('.js-popover-tooltip--day-btn'), {
				content: popoverContent,
				container: '.fc-today-button .js-popover-tooltip--day-btn'
			});
		}

		/**
   * Function shows change date buttons in calendar's header for specific view
   * @param view
   * @param toolbar
   */

	}, {
		key: 'showChangeDateButtons',
		value: function showChangeDateButtons(view, toolbar) {
			var viewType = view.type.replace(/basic|agenda/g, '').toLowerCase(),
			    nextPrevButtons = toolbar.find('.fc-prev-button, .fc-next-button'),
			    yearButtons = toolbar.find('.fc-prevYear-button, .fc-nextYear-button');
			if (!window.calendarLoaded) {
				yearButtons.first().html('<span class="fas fa-xs fa-minus mr-1"></span>' + view.options.buttonText['year']);
				yearButtons.last().html(view.options.buttonText['year'] + '<span class="fas fa-xs fa-plus ml-1"></span>');
			}
			if (view.type !== 'year') {
				nextPrevButtons.first().html('<span class="fas fa-xs fa-minus mr-1"></span>' + view.options.buttonText[viewType]);
				nextPrevButtons.last().html(view.options.buttonText[viewType] + '<span class="fas fa-xs fa-plus ml-1"></span>');
			}
			if (view.type === 'year') {
				nextPrevButtons.hide();
				yearButtons.show();
			} else if (view.type === 'month') {
				nextPrevButtons.show();
				yearButtons.show();
			} else {
				nextPrevButtons.show();
				yearButtons.hide();
			}
		}

		/**
   * Date bar with counts
   * @param object calendarView
   */

	}, {
		key: 'refreshDatesRowView',
		value: function refreshDatesRowView(calendarView) {
			var self = this;
			switch (calendarView.type) {
				case 'year':
					self.generateYearList(calendarView.intervalStart, calendarView.intervalEnd);
					break;
				case 'month':
					self.generateSubMonthList(calendarView.intervalStart, calendarView.intervalEnd);
					break;
				case 'week':
				case 'agendaWeek':
					self.generateSubWeekList(calendarView.start, calendarView.end);
					break;
				default:
					self.generateSubDaysList(calendarView.start, calendarView.end);
			}
			self.updateCountTaskCalendar();
			self.registerDatesChange();
		}
	}, {
		key: 'registerDatesChange',
		value: function registerDatesChange() {
			var _this3 = this;

			this.container.find('.js-dates-row .js-sub-record').on('click', function (e) {
				var currentTarget = $(e.currentTarget);
				currentTarget.addClass('active');
				_this3.getCalendarView().fullCalendar('gotoDate', moment(currentTarget.data('date'), 'YYYY-MM-DD'));
			});
		}
	}, {
		key: 'getCurrentCvId',
		value: function getCurrentCvId() {
			return $('.js-calendar__extended-filter-tab .active').parent('.js-filter-tab').data('cvid');
		}
	}, {
		key: 'registerFilterTabChange',
		value: function registerFilterTabChange() {
			var thisInstance = this;
			this.getCalendarView().find('.js-calendar__extended-filter-tab').on('shown.bs.tab', function () {
				thisInstance.getCalendarView().fullCalendar('getCalendar').view.options.loadView();
			});
		}
	}, {
		key: 'getSelectedUsersCalendar',
		value: function getSelectedUsersCalendar() {
			var sidebar = this.getSidebarView();
			var selectedUsers = sidebar.find('.js-input-user-owner-id:checked'),
			    selectedUsersAjax = sidebar.find('.js-input-user-owner-id-ajax'),
			    selectedRolesAjax = sidebar.find('.js-input-role-owner-id-ajax'),
			    users = [];
			if (selectedUsers.length > 0) {
				selectedUsers.each(function () {
					users.push($(this).val());
				});
			} else if (selectedUsersAjax.length > 0) {
				users = selectedUsersAjax.val().concat(selectedRolesAjax.val());
			}
			return users;
		}
	}, {
		key: 'getSidebarView',
		value: function getSidebarView() {
			if (!this.sidebarView.length) {
				this.sidebarView = this.container.find('.js-calendar-right-panel');
			}
			return this.sidebarView;
		}
	}, {
		key: 'updateCountTaskCalendar',
		value: function updateCountTaskCalendar() {
			var datesView = this.container.find('.js-dates-row'),
			    subDatesElements = datesView.find('.js-sub-record'),
			    dateArray = {},
			    userDateFormat = CONFIG.dateFormat.toUpperCase(),
			    user = this.getSelectedUsersCalendar();
			if (user.length === 0) {
				user = app.getMainParams('usersId');
			}
			if (user === undefined) {
				user = [app.getMainParams('userId')];
			}
			subDatesElements.each(function (key, element) {
				var data = $(this).data('date'),
				    type = $(this).data('type');
				if (type === 'years') {
					dateArray[key] = [moment(data + '-01').format(userDateFormat) + ' 00:00:00', moment(data + '-01').endOf('year').format(userDateFormat) + ' 23:59:59'];
				} else if (type === 'months') {
					dateArray[key] = [moment(data).format(userDateFormat) + ' 00:00:00', moment(data).endOf('month').format(userDateFormat) + ' 23:59:59'];
				} else if (type === 'weeks') {
					dateArray[key] = [moment(data).format(userDateFormat) + ' 00:00:00', moment(data).add(6, 'day').format(userDateFormat) + ' 23:59:59'];
				} else if (type === 'days') {
					dateArray[key] = [moment(data).format(userDateFormat) + ' 00:00:00', moment(data).format(userDateFormat) + ' 23:59:59'];
				}
			});
			AppConnector.request({
				module: this.module,
				action: 'Calendar',
				mode: 'getCountEventsGroup',
				dates: dateArray,
				user: user,
				time: app.getMainParams('showType'),
				cvid: this.getCurrentCvId()
			}).done(function (events) {
				subDatesElements.each(function (key, element) {
					$(this).find('.js-count-events').removeClass('hide').html(events.result[key]);
				});
			});
		}

		/**
   * Register events to EditView
   * @param {jQuery} sideBar
   */

	}, {
		key: 'registerEditForm',
		value: function registerEditForm(sideBar) {
			var _this4 = this;

			var editViewInstance = Vtiger_Edit_Js.getInstanceByModuleName(sideBar.find('[name="module"]').val()),
			    headerInstance = new Vtiger_Header_Js(),
			    params = [];
			var rightFormCreate = sideBar.find('form[name="QuickCreate"]');
			editViewInstance.registerBasicEvents(rightFormCreate);
			rightFormCreate.validationEngine(app.validationEngineOptions);
			headerInstance.registerHelpInfo(rightFormCreate);
			App.Fields.Picklist.showSelect2ElementView(sideBar.find('select'));
			sideBar.find('.js-summary-close-edit').on('click', function () {
				_this4.getCalendarCreateView();
			});
			params.callbackFunction = this.registerAfterSubmitForm(this, rightFormCreate);
			headerInstance.registerQuickCreatePostLoadEvents(rightFormCreate, params);
			new App.Fields.Text.Editor(sideBar.find('.js-editor'), { height: '5em', toolbar: 'Min' });
		}

		/**
   * EditView
   * @param {Object}|{number} params
   */

	}, {
		key: 'getCalendarSidebarData',
		value: function getCalendarSidebarData(params) {
			var _this5 = this;

			var thisInstance = this,
			    aDeferred = $.Deferred();
			var progressInstance = $.progressIndicator({ blockInfo: { enabled: true } });
			if ($.isNumeric(params)) {
				params = {
					module: this.module,
					view: 'EventForm',
					record: params
				};
			}
			AppConnector.request(params).done(function (data) {
				thisInstance.openRightPanel();
				progressInstance.progressIndicator({ mode: 'hide' });
				var sidebar = thisInstance.getSidebarView();
				_this5.updateSidebar(sidebar, data);
				if (sidebar.find('form').length) {
					thisInstance.registerEditForm(sidebar);
				} else {
					app.showNewScrollbar(sidebar.find('.js-calendar__form__wrapper'), { suppressScrollX: true });
					sidebar.find('.js-activity-state .js-summary-close-edit').on('click', function () {
						thisInstance.getCalendarCreateView();
					});
					sidebar.find('.js-activity-state .editRecord').on('click', function () {
						thisInstance.getCalendarSidebarData($(this).data('id'));
					});
				}
				aDeferred.resolve(sidebar.find('.js-qc-form'));
			}).fail(function (error) {
				progressInstance.progressIndicator({ mode: 'hide' });
				app.errorLog(error);
			});
			return aDeferred.promise();
		}

		/**
   * Update sidebar
   * @param {jQuery} sidebar
   * @param {html} data
   */

	}, {
		key: 'updateSidebar',
		value: function updateSidebar(sidebar, data) {
			sidebar.find('.js-qc-form').html(data);
			this.showRightPanelForm();
		}
	}, {
		key: 'loadCalendarData',
		value: function loadCalendarData() {
			var view = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.getCalendarView().fullCalendar('getView');

			var self = this;
			var formatDate = CONFIG.dateFormat.toUpperCase(),
			    cvid = self.getCurrentCvId(),
			    calendarInstance = this.getCalendarView();
			calendarInstance.fullCalendar('removeEvents');
			var progressInstance = $.progressIndicator({ blockInfo: { enabled: true } }),
			    user = self.getSelectedUsersCalendar();
			if (0 === user.length) {
				user = app.getMainParams('usersId');
			}
			if (user === undefined) {
				user = [app.getMainParams('userId')];
			}
			self.clearFilterButton(user, cvid);
			if (view.type === 'agendaDay') {
				self.selectDays(view.start, view.end);
				view.end = view.end.add(1, 'day');
			}
			var options = {
				module: this.module,
				action: 'Calendar',
				mode: 'getEvents',
				start: view.start.format(formatDate),
				end: view.end.format(formatDate),
				user: user,
				time: app.getMainParams('showType'),
				cvid: cvid,
				historyUrl: 'index.php?module=' + this.module + '&view=CalendarExtended&history=true&viewType=' + view.type + '&start=' + view.start.format(formatDate) + '&end=' + view.end.format(formatDate) + '&user=' + user + '&time=' + app.getMainParams('showType') + '&cvid=' + cvid + '&hiddenDays=' + view.options.hiddenDays
			};
			var connectorMethod = window['AppConnector']['request'];
			if (this.browserHistory && window.calendarLoaded) {
				connectorMethod = window['AppConnector']['requestPjax'];
			}
			if (this.browserHistoryConfig && Object.keys(this.browserHistoryConfig).length && !window.calendarLoaded) {
				options = Object.assign(options, {
					start: this.browserHistoryConfig.start,
					end: this.browserHistoryConfig.end,
					user: this.browserHistoryConfig.user,
					time: this.browserHistoryConfig.time,
					cvid: this.browserHistoryConfig.cvid
				});
				connectorMethod = window['AppConnector']['request'];
				app.setMainParams('showType', this.browserHistoryConfig.time);
				app.setMainParams('usersId', this.browserHistoryConfig.user);
			}
			connectorMethod(options).done(function (events) {
				calendarInstance.fullCalendar('removeEvents');
				calendarInstance.fullCalendar('addEventSource', events.result);
				progressInstance.progressIndicator({ mode: 'hide' });
			});
			self.registerViewRenderEvents(view);
			window.calendarLoaded = true;
		}
	}, {
		key: 'clearFilterButton',
		value: function clearFilterButton(user, cvid) {
			var currentUser = parseInt(app.getMainParams('userId')),
			    time = app.getMainParams('showType'),
			    statement = (user.length === 0 || user.length === 1 && parseInt(user) === currentUser) && cvid === undefined && time === 'current';
			$('.js-calendar__clear-filters').toggleClass('d-none', statement);
		}
	}, {
		key: 'registerClearFilterButton',
		value: function registerClearFilterButton() {
			var sidebar = this.getSidebarView(),
			    calendarView = this.getCalendarView();
			var clearBtn = calendarView.find('.js-calendar__clear-filters');
			app.showPopoverElementView(clearBtn);
			clearBtn.on('click', function () {
				$('.js-calendar__extended-filter-tab a').removeClass('active');
				app.setMainParams('showType', 'current');
				app.moduleCacheSet('defaultShowType', 'current');
				sidebar.find('input:checkbox').prop('checked', false);
				sidebar.find('option:selected').prop('selected', false);
				var calendarSwitch = sidebar.find('.js-switch--showType [class*="js-switch--label"]'),
				    actualUserCheckbox = sidebar.find('.js-input-user-owner-id[value=' + app.getMainParams('userId') + ']');
				calendarSwitch.last().removeClass('active');
				calendarSwitch.first().addClass('active');
				if (actualUserCheckbox.length) {
					actualUserCheckbox.prop('checked', true);
				} else {
					app.setMainParams('usersId', undefined);
				}
				calendarView.fullCalendar('getCalendar').view.options.loadView();
			});
		}
	}, {
		key: 'generateYearList',
		value: function generateYearList(dateStart, dateEnd) {
			var datesView = this.container.find('.js-dates-row');
			var prevYear = moment(dateStart).subtract(1, 'year'),
			    actualYear = moment(dateStart),
			    nextYear = moment(dateStart).add(1, 'year'),
			    html = '',
			    active = '';
			while (prevYear <= nextYear) {
				if (prevYear.format('YYYY') === actualYear.format('YYYY')) {
					active = 'active';
				} else {
					active = '';
				}
				html += '<div class="js-sub-record sub-record col-4 nav-item" data-date="' + prevYear.format('YYYY') + '" data-type="years" data-js="click | class: active">\n\t\t\t\t\t<div class="sub-record-content nav-link ' + active + '">\n\t\t\t\t\t\t<div class="sub-date-name">\n\t\t\t\t\t\t\t' + prevYear.format('YYYY') + '\n\t\t\t\t\t\t\t<div class="js-count-events count badge c-badge--md ml-1" data-js="html">0</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>';
				prevYear = moment(prevYear).add(1, 'year');
			}
			datesView.find('.js-sub-date-list').html(html);
		}
	}, {
		key: 'generateSubMonthList',
		value: function generateSubMonthList(dateStart, dateEnd) {
			var datesView = this.container.find('.js-dates-row'),
			    activeMonth = parseInt(moment(dateStart).locale('en').format('M')) - 1,
			    html = '',
			    active = '';
			for (var month = 0; 12 > month; ++month) {
				if (month === activeMonth) {
					active = 'active';
				} else {
					active = '';
				}
				html += '<div class="js-sub-record sub-record nav-item col-1 px-0" data-type="months" data-date="' + moment(dateStart).month(month).format('YYYY-MM') + '" data-js="click | class: active">\n\t\t\t\t\t<div class="sub-record-content nav-link ' + active + '">\n\t\t\t\t\t\t<div class="sub-date-name">' + app.vtranslate('JS_' + moment().month(month).format('MMM').toUpperCase()).toUpperCase() + '\n\t\t\t\t\t\t\t<div class="js-count-events count badge c-badge--md ml-1" data-js="html">0</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>';
			}
			datesView.find('.js-sub-date-list').html(html);
		}
	}, {
		key: 'generateSubWeekList',
		value: function generateSubWeekList(dateStart, dateEnd) {
			var datesView = this.container.find('.js-dates-row'),
			    prevWeeks = moment(dateStart).subtract(5, 'weeks'),
			    actualWeek = moment(dateStart).format('WW'),
			    nextWeeks = moment(dateStart).add(6, 'weeks'),
			    html = '';
			while (prevWeeks <= nextWeeks) {
				var active = '';
				if (prevWeeks.format('WW') === actualWeek) {
					active = ' active';
				}
				html += '<div class="js-sub-record sub-record nav-item col-1 px-0" data-type="weeks" data-date="' + prevWeeks.format('YYYY-MM-DD') + '" data-js="click | class: active">' + '<div class="sub-record-content nav-link' + active + '">' + '<div class="sub-date-name">' + app.vtranslate('JS_WEEK_SHORT') + ' ' + prevWeeks.format('WW') + '<div class="js-count-events count badge c-badge--md ml-1" data-js="html">0</div>' + '</div>' + '</div>' + '</div>';
				prevWeeks = moment(prevWeeks).add(1, 'weeks');
			}
			datesView.find('.js-sub-date-list').html(html);
		}
	}, {
		key: 'generateSubDaysList',
		value: function generateSubDaysList(dateStart, dateEnd) {
			var datesView = this.container.find('.js-dates-row'),
			    prevDays = moment(dateStart).subtract(5, 'days'),
			    actualDay = moment(dateStart).format('DDD'),
			    nextDays = moment(dateStart).add(7, 'days'),
			    daysToShow = nextDays.diff(prevDays, 'days'),
			    html = '';
			for (var day = 0; day < daysToShow; ++day) {
				var active = '';
				if (app.getMainParams('switchingDays') === 'workDays' && app.moduleCacheGet('defaultSwitchingDays') !== 'all') {
					if ($.inArray(prevDays.day(), app.getMainParams('hiddenDays', true)) !== -1) {
						prevDays = moment(prevDays).add(1, 'days');
						daysToShow++;
						continue;
					}
				}
				if (prevDays.format('DDD') === actualDay) {
					active = ' active';
				}
				html += '<div class="js-sub-record sub-record nav-item col-1 px-0" data-type="days" data-date="' + prevDays.format('YYYY-MM-DD') + '" data-js="click | class: active">' + '<div class="sub-record-content nav-link' + active + '">' + '<div class="sub-date-name">' + app.vtranslate('JS_DAY_SHORT') + ' ' + prevDays.format('DD') + '<div class="js-count-events count badge c-badge--md ml-1" data-js="html">0</div>' + '</div>' + '</div>' + '</div>';
				prevDays = moment(prevDays).add(1, 'days');
			}
			datesView.find('.js-sub-date-list').html(html);
		}
	}, {
		key: 'selectDays',
		value: function selectDays(startDate, endDate) {
			this.container.find('.js-right-panel-event-link').tab('show');
			var start_hour = app.getMainParams('startHour'),
			    end_hour = app.getMainParams('endHour'),
			    view = this.getCalendarView().fullCalendar('getView');
			if (endDate.hasTime() == false) {
				endDate.add(-1, 'days');
			}
			startDate = startDate.format();
			endDate = endDate.format();
			if (start_hour == '') {
				start_hour = '00';
			}
			if (end_hour == '') {
				end_hour = '00';
			}
			this.getCalendarCreateView().done(function (data) {
				if (data.length <= 0) {
					return;
				}
				if (view.name != 'agendaDay' && view.name != 'agendaWeek') {
					startDate = startDate + 'T' + start_hour + ':00';
					endDate = endDate + 'T' + end_hour + ':00';
					if (startDate == endDate) {
						var activityType = data.find('[name="activitytype"]').val();
						var activityDurations = JSON.parse(data.find('[name="defaultOtherEventDuration"]').val());
						var minutes = 0;
						for (var i in activityDurations) {
							if (activityDurations[i].activitytype === activityType) {
								minutes = parseInt(activityDurations[i].duration);
								break;
							}
						}
						endDate = moment(endDate).add(minutes, 'minutes').toISOString();
					}
				}
				var dateFormat = data.find('[name="date_start"]').data('dateFormat').toUpperCase(),
				    timeFormat = data.find('[name="time_start"]').data('format'),
				    defaultTimeFormat = '';
				if (timeFormat == 24) {
					defaultTimeFormat = 'HH:mm';
				} else {
					defaultTimeFormat = 'hh:mm A';
				}
				data.find('[name="date_start"]').val(moment(startDate).format(dateFormat));
				data.find('[name="due_date"]').val(moment(endDate).format(dateFormat));
				if (data.find('.js-autofill').prop('checked') === true) {
					Calendar_Edit_Js.getInstance().getFreeTime(data);
				} else {
					data.find('[name="time_start"]').val(moment(startDate).format(defaultTimeFormat));
					data.find('[name="time_end"]').val(moment(endDate).format(defaultTimeFormat));
				}
			});
		}
	}, {
		key: 'registerUsersChange',
		value: function registerUsersChange(formContainer) {
			var _this6 = this;

			formContainer.find('.js-input-user-owner-id-ajax, .js-input-user-owner-id').on('change', function () {
				_this6.getCalendarView().fullCalendar('getCalendar').view.options.loadView();
			});
			this.registerPinUser();
		}

		/**
   * Register actions to do after save record
   * @param instance
   * @param data
   * @returns {function}
   */

	}, {
		key: 'registerAfterSubmitForm',
		value: function registerAfterSubmitForm(self, data) {
			var calendarView = this.getCalendarView();
			var returnFunction = function returnFunction(data) {
				if (data.success) {
					var recordActivityStatus = data.result.activitystatus.value,
					    historyStatus = app.getMainParams('activityStateLabels', true).history,
					    inHistoryStatus = $.inArray(recordActivityStatus, historyStatus),
					    showType = app.getMainParams('showType');
					if (-1 !== inHistoryStatus && 'history' === showType || -1 === inHistoryStatus && 'history' !== showType) {
						if (calendarView.fullCalendar('clientEvents', data.result._recordId)[0]) {
							self.updateCalendarEvent(data.result._recordId, data.result);
						} else {
							var calendarInstance = calendarView.fullCalendar('getCalendar');
							if (calendarInstance.view.type !== 'year') {
								calendarInstance.view.options.addCalendarEvent(data.result);
							} else {
								calendarInstance.view.render();
							}
							if (data.result.followup.value !== undefined) {
								calendarView.fullCalendar('removeEvents', data.result.followup.value);
							}
						}
					}
					self.refreshDatesRowView(calendarView.fullCalendar('getView'));
					self.getSidebarView().find('.js-qc-form').html('');
					self.getCalendarCreateView();
					window.popoverCache = {};
				}
			};
			return returnFunction;
		}
	}, {
		key: 'openRightPanel',
		value: function openRightPanel() {
			var calendarRightPanel = $('.js-calendar-right-panel');
			if (calendarRightPanel.hasClass('hideSiteBar')) {
				calendarRightPanel.find('.js-toggle-site-bar-right-button').trigger('click');
			}
		}
	}, {
		key: 'showRightPanelForm',
		value: function showRightPanelForm() {
			var calendarRightPanel = $('.js-calendar-right-panel');
			if (!calendarRightPanel.find('.js-right-panel-event').hasClass('active')) {
				calendarRightPanel.find('.js-right-panel-event-link').trigger('click');
			}
			app.showNewScrollbar(calendarRightPanel.find('.js-calendar__form__wrapper'), {
				suppressScrollX: true
			});
		}
	}, {
		key: 'registerSiteBarEvents',
		value: function registerSiteBarEvents() {
			var calendarRightPanel = $('.js-calendar-right-panel');
			calendarRightPanel.find('.js-show-sitebar').on('click', function () {
				if (calendarRightPanel.hasClass('hideSiteBar')) {
					calendarRightPanel.find('.js-toggle-site-bar-right-button').trigger('click');
				}
			});
		}

		/**
   * Parse calendar data
   * @param {Object} calendarDetails
   * @returns {{id: *, title: *, start: *, end: *, module: string, url: string, className: string[], start_display: *, end_display: *}}
   */

	}, {
		key: 'getEventData',
		value: function getEventData(calendarDetails) {
			var calendar = this.getCalendarView(),
			    startDate = calendar.fullCalendar('moment', calendarDetails.date_start.value + ' ' + calendarDetails.time_start.value),
			    endDate = calendar.fullCalendar('moment', calendarDetails.due_date.value + ' ' + calendarDetails.time_end.value),
			    eventObject = {
				id: calendarDetails._recordId,
				title: calendarDetails.subject.display_value,
				start: startDate.format(),
				end: endDate.format(),
				module: this.module,
				url: 'index.php?module=' + this.module + '&view=ActivityState&record=' + calendarDetails._recordId,
				className: ['ownerCBg_' + calendarDetails.assigned_user_id.value, ' picklistCBr_Calendar_activitytype_' + calendarDetails.activitytype.value, 'js-popover-tooltip--record'],
				start_display: calendarDetails.date_start.display_value,
				end_display: calendarDetails.due_date.display_value
			};
			if (calendarDetails.isEditable && app.getMainParams('showEditForm')) {
				eventObject.url = 'index.php?module=' + this.module + '&view=EventForm&record=' + eventObject.id;
			}
			return eventObject;
		}

		/**
   * Update Event
   * @param {Number} calendarEventId
   * @param {Object} calendarDetails
   */

	}, {
		key: 'updateCalendarEvent',
		value: function updateCalendarEvent(calendarEventId, calendarDetails) {
			var calendar = this.getCalendarView();
			var recordToUpdate = calendar.fullCalendar('clientEvents', calendarEventId)[0];
			$.extend(recordToUpdate, this.getEventData(calendarDetails));
			calendar.fullCalendar('updateEvent', recordToUpdate);
		}
	}, {
		key: 'getCalendarCreateView',
		value: function getCalendarCreateView() {
			var aDeferred = $.Deferred();
			if (this.eventCreate) {
				var thisInstance = this;
				var sideBar = thisInstance.getSidebarView(),
				    qcForm = sideBar.find('.js-qc-form');
				if (qcForm.find('form').length > 0 && qcForm.find('input[name=record]').length === 0) {
					aDeferred.resolve(qcForm);
				} else {
					var progressInstance = $.progressIndicator({ blockInfo: { enabled: true } });
					this.getCalendarSidebarData({ module: this.module, view: 'EventForm' }).done(function () {
						progressInstance.progressIndicator({ mode: 'hide' });
						thisInstance.registerAutofillTime();
						aDeferred.resolve(qcForm);
					}).fail(function (error) {
						progressInstance.progressIndicator({ mode: 'hide' });
						app.errorLog(error);
					});
				}
			} else {
				aDeferred.reject();
			}
			return aDeferred.promise();
		}

		/**
   * Autoselect date in create view in extended calendar
   */

	}, {
		key: 'registerAutofillTime',
		value: function registerAutofillTime() {
			if (app.getMainParams('autofillTime')) {
				this.container.find('.js-autofill').prop('checked', 'checked').trigger('change');
			}
		}
	}, {
		key: 'registerPinUser',
		value: function registerPinUser() {
			$('.js-pin-user').off('click').on('click', function () {
				var thisInstance = $(this);
				AppConnector.request({
					module: this.module,
					action: 'Calendar',
					mode: 'pinOrUnpinUser',
					element_id: thisInstance.data('elementid')
				}).done(function (data) {
					var response = data.result;
					if (response === 'unpin') {
						thisInstance.find('.js-pin-icon').removeClass('fas').addClass('far');
					} else if (response === 'pin') {
						thisInstance.find('.js-pin-icon').removeClass('far').addClass('fas');
					} else {
						Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_ERROR'));
					}
				});
			});
		}
	}, {
		key: 'registerAddForm',
		value: function registerAddForm() {
			var thisInstance = this;
			var sideBar = thisInstance.getSidebarView();
			thisInstance.getCalendarCreateView();
			var user = app.getMainParams('usersId');
			if (user === undefined) {
				user = [app.getMainParams('userId')];
			}
			AppConnector.request('index.php?module=' + this.module + '&view=RightPanelExtended&mode=getUsersList&user=' + user).done(function (data) {
				if (data) {
					var formContainer = sideBar.find('.js-users-form');
					formContainer.html(data);
					thisInstance.registerUsersChange(formContainer);
					App.Fields.Picklist.showSelect2ElementView(formContainer.find('select'));
					app.showNewScrollbar(formContainer, {
						suppressScrollX: true
					});
				}
			});
			AppConnector.request('index.php?module=' + this.module + '&view=RightPanelExtended&mode=getGroupsList&user=' + user).done(function (data) {
				if (data) {
					var formContainer = sideBar.find('.js-group-form');
					formContainer.html(data);
					thisInstance.registerUsersChange(formContainer);
					App.Fields.Picklist.showSelect2ElementView(formContainer.find('select'));
					formContainer.addClass('u-min-h-30per');
					app.showNewScrollbar(formContainer, {
						suppressScrollX: true
					});
				}
			});
		}

		/**
   * Find element on list (user, group)
   * @param {jQuery.Event} e
   */

	}, {
		key: 'findElementOnList',
		value: function findElementOnList(e) {
			var target = $(e.target),
			    value = target.val().toLowerCase(),
			    container = target.closest('.js-filter__container');
			container.find('.js-filter__item__value').filter(function () {
				var item = $(this).closest('.js-filter__item__container');
				if ($(this).text().trim().toLowerCase().indexOf(value) > -1) {
					item.removeClass('d-none');
				} else {
					item.addClass('d-none');
				}
			});
		}

		/**
   * Register filter for users and groups
   */

	}, {
		key: 'registerFilterForm',
		value: function registerFilterForm() {
			var self = this;
			this.getSidebarView().find('a[data-toggle="tab"]').one('shown.bs.tab', function (e) {
				$('.js-filter__search').on('keyup', self.findElementOnList.bind(self));
			});
		}

		/**
   * Register popover buttons' click
   */

	}, {
		key: 'registerPopoverButtonsClickEvent',
		value: function registerPopoverButtonsClickEvent() {
			$(document).on('click', '.js-calendar-popover__button', this.showCalendarPopoverLinkInSidebar.bind(this));
		}

		/**
   * Show popover link in sidebar
   *
   * @param   {Object}  e  click event
   */

	}, {
		key: 'showCalendarPopoverLinkInSidebar',
		value: function showCalendarPopoverLinkInSidebar(e) {
			var href = e.currentTarget.href;
			var hrefObject = app.convertUrlToObject(href);
			if (hrefObject.module !== 'Calendar' || hrefObject.view !== 'Edit' && hrefObject.view !== 'Detail') {
				return true;
			} else {
				e.preventDefault();
				var sidebarView = hrefObject.view === 'Edit' ? 'EventForm' : 'ActivityState';
				href = href.replace(hrefObject.view, sidebarView);
				this.getCalendarSidebarData(href);
			}
		}

		/**
   * Register events
   */

	}, {
		key: 'registerEvents',
		value: function registerEvents() {
			get(_class.prototype.__proto__ || Object.getPrototypeOf(_class.prototype), 'registerEvents', this).call(this);
			this.registerAddForm();
			this.registerSiteBarEvents();
			this.registerFilterForm();
			this.registerPopoverButtonsClickEvent();
			ElementQueries.listen();
		}
	}]);
	return _class;
}(Calendar_Calendar_Js);
//# sourceMappingURL=CalendarView.min.js.map
