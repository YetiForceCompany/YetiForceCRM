'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

jQuery.Class("Vtiger_Detail_Js",{detailInstance:!1,getInstance:function getInstance(){if(!1==Vtiger_Detail_Js.detailInstance){var instance,moduleClassName=app.getModuleName()+"_"+app.getViewName()+"_Js";instance="undefined"==typeof window[moduleClassName]?new Vtiger_Detail_Js:new window[moduleClassName],Vtiger_Detail_Js.detailInstance=instance;}return Vtiger_Detail_Js.detailInstance},triggerDetailViewAction:function triggerDetailViewAction(detailActionUrl,callBackFunction){var detailInstance=Vtiger_Detail_Js.getInstance(),selectedIds=[];selectedIds.push(detailInstance.getRecordId());var postData={selected_ids:JSON.stringify(selectedIds)};AppConnector.request({type:"POST",url:detailActionUrl,dataType:"html",data:postData}).done(function(data){data&&(app.showModalWindow(data,{"text-align":"left"}),"function"==typeof callBackFunction&&callBackFunction(data));}).fail(function(){});},triggerSendSms:function triggerSendSms(detailActionUrl){Vtiger_Detail_Js.triggerDetailViewAction(detailActionUrl);},triggerTransferOwnership:function triggerTransferOwnership(massActionUrl){var thisInstance=this;thisInstance.getRelatedModulesContainer=!1;AppConnector.request({type:"POST",url:massActionUrl,dataType:"html",data:{}}).done(function(data){if(data){var callback=function(){var params=app.validationEngineOptions;params.onValidationComplete=function(form,valid){return valid&&"changeOwner"==form.attr("name")&&thisInstance.transferOwnershipSave(form),!1},jQuery("#changeOwner").validationEngine(app.validationEngineOptions);};app.showModalWindow(data,function(data){var selectElement=thisInstance.getRelatedModuleContainer();App.Fields.Picklist.changeSelectElementView(selectElement,"select2"),"function"==typeof callback&&callback(data);});}});},transferOwnershipSave:function transferOwnershipSave(){var transferOwner=jQuery("#transferOwnerId").val(),relatedModules=jQuery("#related_modules").val(),recordId=jQuery("#recordId").val(),params={module:app.getModuleName(),action:"TransferOwnership",record:recordId,transferOwnerId:transferOwner,related_modules:relatedModules};AppConnector.request(params).done(function(data){if(data.success){app.hideModalWindow();var params={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_RECORDS_TRANSFERRED_SUCCESSFULLY"),type:"info"},oldvalue=jQuery(".assigned_user_id").val(),element=jQuery(".assigned_user_id ");element.find("option[value=\""+oldvalue+"\"]").removeAttr("selected"),element.find("option[value=\""+transferOwner+"\"]").attr("selected","selected"),element.trigger("liszt:updated");var Fieldname=element.find("option[value=\""+transferOwner+"\"]").data("picklistvalue");element.closest(".row-fluid").find(".value").html("<a href=\"index.php?module=Users&amp;parent=Settings&amp;view=Detail&amp;record="+transferOwner+"\">"+Fieldname+"</a>"),Vtiger_Helper_Js.showPnotify(params);}});},getRelatedModuleContainer:function getRelatedModuleContainer(){return !1==this.getRelatedModulesContainer&&(this.getRelatedModulesContainer=jQuery("#related_modules")),this.getRelatedModulesContainer},reloadRelatedList:function reloadRelatedList(){var detailInstance=Vtiger_Detail_Js.getInstance(),params={};0<jQuery("[name=\"currentPageNum\"]").length&&(params.page=jQuery("[name=\"currentPageNum\"]").val()),detailInstance.loadRelatedList(params);},showWorkflowTriggerView:function showWorkflowTriggerView(instance){$(instance).popover("hide");var detailInstance=Vtiger_Detail_Js.getInstance(),callback=function(data){data.find("[type=\"submit\"]").on("click",function(){var ids=[];data.find("input[type=\"checkbox\"]:checked").each(function(){ids.push($(this).val());}),0===ids.length?Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_INFORMATION"),text:app.vtranslate("JS_NOT_SELECTED_WORKFLOW_TRIGGER"),type:"error"}):(Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STARTED_PERFORM_WORKFLOW"),type:"info"}),AppConnector.request({module:app.getModuleName(),action:"Workflow",mode:"execute",user:data.find("[name=\"user\"]").val(),record:detailInstance.getRecordId(),ids:ids}).done(function(){Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_COMPLETED_PERFORM_WORKFLOW"),type:"success"}),app.hideModalWindow(),detailInstance.loadWidgets();}).fail(function(){Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_ERROR"),text:app.vtranslate("JS_ERROR_DURING_TRIGGER_OF_WORKFLOW"),type:"error"}),app.hideModalWindow();}));});};AppConnector.request({module:app.getModuleName(),view:"WorkflowTrigger",record:detailInstance.getRecordId()}).done(function(data){data&&app.showModalWindow(data,"",callback);});}},{targetPicklistChange:!1,targetPicklist:!1,detailViewContentHolder:!1,detailViewForm:!1,detailViewDetailsTabLabel:"LBL_RECORD_DETAILS",detailViewSummaryTabLabel:"LBL_RECORD_SUMMARY",detailViewRecentCommentsTabLabel:"ModComments",detailViewRecentActivitiesTabLabel:"Activities",detailViewRecentUpdatesTabLabel:"LBL_UPDATES",detailViewRecentDocumentsTabLabel:"Documents",fieldUpdatedEvent:"Vtiger.Field.Updated",updatedFields:["company","designation","title"],fieldPreSave:"Vtiger.Field.PreSave",tempData:[],referenceFieldNames:{Calendar:{Accounts:"link",Leads:"link",Vendors:"link",OSSEmployees:"link",Contacts:"linkextend",Campaigns:"process",HelpDesk:"process",Projects:"process",ServiceContracts:"process"},OutsourcedProducts:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},Assets:{Accounts:"parent_id",Contacts:"parent_id"},OSSOutsourcedServices:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},OSSSoldServices:{Accounts:"parent_id",Contacts:"parent_id"}},init:function init(){},loadWidgetsEvents:function loadWidgetsEvents(){var thisInstance=this;app.event.on("DetailView.Widget.AfterLoad",function(e,widgetContent,relatedModuleName){"Calendar"===relatedModuleName&&thisInstance.reloadWidgetActivitesStats(widgetContent.closest(".activityWidgetContainer")),"ModComments"===relatedModuleName&&thisInstance.registerCommentEventsInDetail(widgetContent.closest(".updatesWidgetContainer")),widgetContent.find("[name=\"relatedModule\"]").length&&thisInstance.registerShowSummary(widgetContent),"OSSMailView"===relatedModuleName&&(Vtiger_Index_Js.registerMailButtons(widgetContent),widgetContent.find(".showMailModal").on("click",function(e){var progressIndicatorElement=jQuery.progressIndicator();app.showModalWindow("",$(e.currentTarget).data("url")+"&noloadlibs=1",function(data){Vtiger_Index_Js.registerMailButtons(data),progressIndicatorElement.progressIndicator({mode:"hide"});});})),thisInstance.registerEmailEvents(widgetContent),"DetailView"===relatedModuleName&&thisInstance.registerBlockStatusCheckOnLoad();});},loadWidgets:function loadWidgets(){var thisInstance=this,widgetList=jQuery("[class^=\"widgetContainer_\"]");widgetList.each(function(index,widgetContainerELement){var widgetContainer=jQuery(widgetContainerELement);thisInstance.loadWidget(widgetContainer);}),thisInstance.registerRelatedModulesRecordCount();},loadWidget:function loadWidget(widgetContainer,params){var thisInstance=this,contentContainer=$(".js-detail-widget-content",widgetContainer),relatedModuleName=void 0;if(relatedModuleName=widgetContainer.find("[name=\"relatedModule\"]").length?widgetContainer.find("[name=\"relatedModule\"]").val():widgetContainer.data("name"),void 0===params){var urlParams=widgetContainer.data("url");if(null==urlParams)return;var index,queryParameters=urlParams.split("&"),keyValueMap={};for(index=0;index<queryParameters.length;index++){var queryParamComponents=queryParameters[index].split("=");keyValueMap[queryParamComponents[0]]=queryParamComponents[1];}params=keyValueMap;}var aDeferred=$.Deferred();return contentContainer.progressIndicator({}),AppConnector.request({type:"POST",async:!1,dataType:"html",data:params}).done(function(data){if(contentContainer.progressIndicator({mode:"hide"}),contentContainer.html(data),App.Fields.Picklist.showSelect2ElementView(widgetContainer.find(".select2")),app.registerModal(contentContainer),app.registerMoreContent(contentContainer.find("button.moreBtn")),relatedModuleName){var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),relatedModuleName);relatedController.setRelatedContainer(contentContainer),relatedController.registerRelatedEvents(),thisInstance.widgetRelatedRecordView(widgetContainer,!0);}app.event.trigger("DetailView.Widget.AfterLoad",contentContainer,relatedModuleName,thisInstance),aDeferred.resolve(params);}).fail(function(){contentContainer.progressIndicator({mode:"hide"}),aDeferred.reject();}),aDeferred.promise()},widgetRelatedRecordView:function widgetRelatedRecordView(container,load){var cacheKey=this.getRecordId()+"_"+container.data("id"),relatedRecordCacheID=app.moduleCacheGet(cacheKey);if(null!==relatedRecordCacheID){var newActive=container.find(".js-carousel-item[data-id = '"+relatedRecordCacheID+"']");newActive.length&&(container.find(".js-carousel-item.active").removeClass("active"),container.find(".js-carousel-item[data-id = '"+relatedRecordCacheID+"']").addClass("active"));}var controlBox=container.find(".control-widget"),prev=controlBox.find(".prev"),next=controlBox.find(".next"),active=container.find(".js-carousel-item.active");1>=container.find(".js-carousel-item").length||!active.next().length?next.addClass("disabled"):next.removeClass("disabled"),1>=container.find(".js-carousel-item").length||!active.prev().length?prev.addClass("disabled"):prev.removeClass("disabled"),load&&(next.on("click",function(){if(!$(this).hasClass("disabled")){var active=container.find(".js-carousel-item.active");active.removeClass("active");var nextElement=active.next();nextElement.addClass("active"),nextElement.next().length||next.addClass("disabled"),active.prev()&&prev.removeClass("disabled"),app.moduleCacheSet(cacheKey,nextElement.data("id"));}}),prev.on("click",function(){if(!$(this).hasClass("disabled")){var active=container.find(".js-carousel-item.active");active.removeClass("active");var prevElement=active.prev();prevElement.addClass("active"),prevElement.prev().length||prev.addClass("disabled"),active.next()&&next.removeClass("disabled"),app.moduleCacheSet(cacheKey,prevElement.data("id"));}}));},loadContents:function loadContents(url,data){var thisInstance=this,aDeferred=jQuery.Deferred(),detailContentsHolder=this.getContentHolder(),params=url;return "undefined"!=typeof data&&(params={},params.url=url,params.data=data),AppConnector.requestPjax(params).done(function(responseData){detailContentsHolder.html(responseData),responseData=detailContentsHolder.html(),thisInstance.registerBlockStatusCheckOnLoad(),App.Fields.Picklist.changeSelectElementView(detailContentsHolder),App.Fields.Date.register(detailContentsHolder),thisInstance.getForm().validationEngine(),app.event.trigger("DetailView.LoadContents.AfterLoad",responseData),aDeferred.resolve(responseData);}),aDeferred.promise()},getUpdatefFieldsArray:function getUpdatefFieldsArray(){return this.updatedFields},getTabByLabel:function getTabByLabel(tabLabel){var tabs=this.getTabs(),targetTab=!1;return tabs.each(function(index,element){var tab=jQuery(element),labelKey=tab.data("labelKey");if(labelKey==tabLabel)return targetTab=tab,!1}),targetTab},getTabByModule:function getTabByModule(moduleName){var tabs=this.getTabs(),targetTab=!1;return tabs.each(function(index,element){var tab=jQuery(element);if(tab.data("reference")==moduleName)return targetTab=tab,!1}),targetTab},selectModuleTab:function selectModuleTab(){var relatedTabContainer=this.getTabContainer(),moduleTab=relatedTabContainer.find("li.module-tab");this.deSelectAllrelatedTabs(),this.markTabAsSelected(moduleTab);},deSelectAllrelatedTabs:function deSelectAllrelatedTabs(){this.getTabs().removeClass("active");},markTabAsSelected:function markTabAsSelected(tabElement){tabElement.addClass("active"),jQuery(".related .dropdown [data-reference=\""+tabElement.data("reference")+"\"]").addClass("active");},reloadTabContent:function reloadTabContent(){this.getSelectedTab().trigger("click");},getSelectedTab:function getSelectedTab(){var tabContainer=this.getTabContainer();return tabContainer.find(".js-detail-tab.active:not(.d-none)")},getTabContainer:function getTabContainer(){return jQuery("div.related")},getTabs:function getTabs(){var topTabs=this.getTabContainer().find("li.baseLink:not(.d-none)"),dropdownMenuTabs=this.getTabContainer().find("li:not(.baseLink)");return dropdownMenuTabs.each(function(){var currentTarget=jQuery(this),iteration=currentTarget.data("iteration"),className=currentTarget.hasClass("mainNav")?"mainNav":"relatedNav";null!=iteration&&1>topTabs.filter("."+className+"[data-iteration=\""+iteration+"\"]").length&&topTabs.push(currentTarget.get(0));}),topTabs},getContentHolder:function getContentHolder(){return !1==this.detailViewContentHolder&&(this.detailViewContentHolder=jQuery("div.details div.contents")),this.detailViewContentHolder},getForm:function getForm(){return !1==this.detailViewForm&&(this.detailViewForm=jQuery("#detailView")),this.detailViewForm},getRecordId:function getRecordId(){return app.getRecordId()},getRelatedModuleName:function getRelatedModuleName(){if(1==jQuery(".relatedModuleName",this.getContentHolder()).length)return jQuery(".relatedModuleName",this.getContentHolder()).val()},saveFieldValues:function saveFieldValues(fieldDetailList){var aDeferred=jQuery.Deferred(),recordId=this.getRecordId(),data={};"undefined"!=typeof fieldDetailList&&(data=fieldDetailList),data.record=recordId,data.module=app.getModuleName(),data.action="SaveAjax";var params={};return params.data=data,params.async=!1,params.dataType="json",AppConnector.request(params).done(function(reponseData){aDeferred.resolve(reponseData);}),aDeferred.promise()},getRelatedListCurrentPageNum:function getRelatedListCurrentPageNum(){return jQuery("input[name=\"currentPageNum\"]",this.getContentHolder()).val()},removeCommentBlockIfExists:function removeCommentBlockIfExists(){$(".js-add-comment-block",$(".js-comments-body",this.getContentHolder())).remove();},getCommentThread:function getCommentThread(url){var aDeferred=jQuery.Deferred();return AppConnector.request(url).done(function(data){aDeferred.resolve(data);}).fail(function(){}),aDeferred.promise()},saveCommentAjax:function saveCommentAjax(element,commentMode,commentContentValue,editCommentReason,commentId,parentCommentId,aDeferred){var thisInstance=this,progressIndicatorElement=jQuery.progressIndicator({}),commentInfoBlock=element.closest(".js-comment-single"),relatedTo=commentInfoBlock.find(".related_to").val();relatedTo||(relatedTo=thisInstance.getRecordId());var postData={commentcontent:commentContentValue,related_to:relatedTo,module:"ModComments"};"edit"==commentMode?(postData.record=commentId,postData.reasontoedit=editCommentReason,postData.parent_comments=parentCommentId,postData.mode="edit",postData.action="Save"):"add"==commentMode&&(postData.parent_comments=commentId,postData.action="SaveAjax"),AppConnector.request(postData).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),"add"==commentMode&&thisInstance.addRelationBetweenRecords("ModComments",data.result.id,thisInstance.getTabByLabel(thisInstance.detailViewRecentCommentsTabLabel)),app.event.trigger("DetailView.SaveComment.AfterAjax",commentInfoBlock,postData,data),aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){progressIndicatorElement.progressIndicator({mode:"hide"}),element.removeAttr("disabled"),aDeferred.reject(textStatus,errorThrown);});},saveComment:function saveComment(e){var errorMsg,editCommentReason,aDeferred=jQuery.Deferred(),currentTarget=jQuery(e.currentTarget),commentMode=currentTarget.data("mode"),closestCommentBlock=currentTarget.closest(".js-add-comment-block"),commentContent=closestCommentBlock.find(".js-comment-content"),commentContentValue=commentContent.html();if(""===commentContentValue)return errorMsg=app.vtranslate("JS_LBL_COMMENT_VALUE_CANT_BE_EMPTY"),commentContent.validationEngine("showPrompt",errorMsg,"error","bottomLeft",!0),aDeferred.reject(errorMsg),aDeferred.promise();"edit"===commentMode&&(editCommentReason=closestCommentBlock.find("[name=\"reasonToEdit\"]").val());var element=jQuery(e.currentTarget),commentInfoHeader=closestCommentBlock.closest(".js-comment-details").find(".js-comment-info-header"),commentId=commentInfoHeader.data("commentid"),parentCommentId=commentInfoHeader.data("parentcommentid");return this.saveCommentAjax(element,commentMode,commentContentValue,editCommentReason,commentId,parentCommentId,aDeferred),aDeferred.promise()},getCommentUI:function getCommentUI(commentId){var aDeferred=jQuery.Deferred();return AppConnector.request({view:"DetailAjax",module:"ModComments",record:commentId}).done(function(data){aDeferred.resolve(data);}).fail(function(){}),aDeferred.promise()},getCommentBlock:function getCommentBlock(){var clonedCommentBlock=jQuery(".basicAddCommentBlock",this.getContentHolder()).clone(!0,!0).removeClass("basicAddCommentBlock d-none").addClass("js-add-comment-block");return clonedCommentBlock.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("js-comment-content"),clonedCommentBlock},getEditCommentBlock:function getEditCommentBlock(){var clonedCommentBlock=jQuery(".basicEditCommentBlock",this.getContentHolder()).clone(!0,!0).removeClass("basicEditCommentBlock d-none").addClass("js-add-comment-block");return clonedCommentBlock.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("js-comment-content"),new App.Fields.Text.Completions(clonedCommentBlock.find(".js-completions")),clonedCommentBlock},registerSendSmsSubmitEvent:function registerSendSmsSubmitEvent(){var thisInstance=this;jQuery("body").on("submit","#massSave",function(e){var form=jQuery(e.currentTarget),smsTextLength=form.find("#message").html().length;if(160<smsTextLength){var params={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("LBL_SMS_MAX_CHARACTERS_ALLOWED"),type:"error"};return Vtiger_Helper_Js.showPnotify(params),!1}var submitButton=form.find(":submit");submitButton.attr("disabled","disabled"),thisInstance.SendSmsSave(form),e.preventDefault();});},SendSmsSave:function SendSmsSave(form){var progressInstance=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),SendSmsUrl=form.serializeFormData();AppConnector.request(SendSmsUrl).done(function(){app.hideModalWindow(),progressInstance.progressIndicator({mode:"hide"});}).fail(function(){});},registerNameAjaxEditEvent:function registerNameAjaxEditEvent(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder();detailContentsHolder.on(thisInstance.fieldUpdatedEvent,".nameField",function(){var form=thisInstance.getForm(),nameFields=form.data("nameFields"),recordLabel="";for(var index in nameFields){0!=index&&(recordLabel+=" ");var nameFieldName=nameFields[index];recordLabel+=form.find("[name=\""+nameFieldName+"\"]").val();}var recordLabelElement=detailContentsHolder.closest(".contentsDiv").find(".recordLabel");recordLabelElement.text(recordLabel);});},updateHeaderNameFields:function updateHeaderNameFields(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder(),form=thisInstance.getForm(),nameFields=form.data("nameFields"),recordLabelElement=detailContentsHolder.closest(".contentsDiv").find(".recordLabel"),title="";for(var index in nameFields){var nameFieldName=nameFields[index],nameField=form.find("[name=\""+nameFieldName+"\"]");if(0<nameField.length){var recordLabel=nameField.val();title+=recordLabel+" ",recordLabelElement.find("[class=\""+nameFieldName+"\"]").text(recordLabel);}}var salutatioField=recordLabelElement.find(".salutation");if(0<salutatioField.length){var salutatioValue=salutatioField.text();title=salutatioValue+title;}recordLabelElement.attr("title",title);},registerAjaxEditEvent:function registerAjaxEditEvent(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder();detailContentsHolder.on(thisInstance.fieldUpdatedEvent,"input,select,textarea",function(e){thisInstance.updateHeaderValues(jQuery(e.currentTarget));});},updateHeaderValues:function updateHeaderValues(currentElement){var thisInstance=this;if(currentElement.hasClass("nameField"))return thisInstance.updateHeaderNameFields(),!0;var name=currentElement.attr("name"),updatedFields=this.getUpdatefFieldsArray(),detailContentsHolder=thisInstance.getContentHolder();if("-1"!=jQuery.inArray(name,updatedFields)){var recordLabel=currentElement.val(),recordLabelElement=detailContentsHolder.closest(".contentsDiv").find("."+name+"_label");recordLabelElement.text(recordLabel);}},registerEmailFieldClickEvent:function registerEmailFieldClickEvent(){var detailContentsHolder=this.getContentHolder();detailContentsHolder.on("click",".emailField",function(e){e.stopPropagation();});},registerPhoneFieldClickEvent:function registerPhoneFieldClickEvent(){var detailContentsHolder=this.getContentHolder();detailContentsHolder.on("click",".phoneField",function(e){e.stopPropagation();});},registerUrlFieldClickEvent:function registerUrlFieldClickEvent(){var detailContentsHolder=this.getContentHolder();detailContentsHolder.on("click",".urlField",function(e){e.stopPropagation();});},registerRelatedRowClickEvent:function registerRelatedRowClickEvent(){var detailContentsHolder=this.getContentHolder();detailContentsHolder.on("click",".listViewEntries",function(e){var targetElement=jQuery(e.target,jQuery(e.currentTarget));if(!(targetElement.is("td:first-child")&&0<targetElement.children("input[type=\"checkbox\"]").length)&&!jQuery(e.target).is("input[type=\"checkbox\"]")){var elem=jQuery(e.currentTarget),recordUrl=elem.data("recordurl");"undefined"!=typeof recordUrl&&(window.location.href=recordUrl);}});},loadRelatedList:function loadRelatedList(params){var aDeferred=jQuery.Deferred();null==params&&(params={});var relatedListInstance=Vtiger_RelatedList_Js.getInstance(this.getRecordId(),app.getModuleName(),this.getSelectedTab(),this.getRelatedModuleName());return relatedListInstance.loadRelatedList(params).done(function(data){aDeferred.resolve(data);},function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);}),aDeferred.promise()},registerEventForRelatedList:function registerEventForRelatedList(){var thisInstance=this,detailContentsHolder=this.getContentHolder(),relatedModuleName=thisInstance.getRelatedModuleName();if(relatedModuleName){var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),relatedModuleName);relatedController.setRelatedContainer(detailContentsHolder),relatedController.registerRelatedEvents();}detailContentsHolder.find(".detailViewBlockLink").each(function(n,block){block=$(block);var blockContent=block.find(".blockContent");blockContent.is(":visible")&&AppConnector.request({type:"GET",dataType:"html",data:block.data("url")}).done(function(response){blockContent.html(response);var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),block.data("reference"));relatedController.setRelatedContainer(blockContent),relatedController.registerRelatedEvents();});}),detailContentsHolder.find(".detailViewBlockLink .blockHeader").on("click",function(e){var target=$(e.target);if(target.is("input")||target.is("button")||target.parents().is("button")||target.hasClass("js-stop-propagation")||target.parents().hasClass("js-stop-propagation"))return !1;var block=$(this).closest(".js-toggle-panel"),blockContent=block.find(".blockContent"),isEmpty=blockContent.is(":empty");blockContent.is(":visible")||(blockContent.progressIndicator(),AppConnector.request({type:"GET",dataType:"html",data:block.data("url")}).done(function(response){blockContent.html(response);var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),thisInstance.getSelectedTab(),block.data("reference"));relatedController.setRelatedContainer(blockContent),isEmpty?relatedController.registerRelatedEvents():relatedController.registerPostLoadEvents();}));});},registerBlockAnimationEvent:function registerBlockAnimationEvent(){var thisInstance=this,detailContentsHolder=this.getContentHolder();detailContentsHolder.find(".blockHeader").on("click",function(e){var target=$(e.target);if(target.is("input")||target.is("button")||target.parents().is("button")||target.hasClass("js-stop-propagation")||target.parents().hasClass("js-stop-propagation"))return !1;var currentTarget=$(this).find(".js-block-toggle").not(".d-none"),blockId=currentTarget.data("id"),closestBlock=currentTarget.closest(".js-toggle-panel"),bodyContents=closestBlock.find(".blockContent"),data=currentTarget.data(),module=app.getModuleName();"show"===data.mode?(bodyContents.addClass("d-none"),app.cacheSet(module+"."+blockId,0),currentTarget.addClass("d-none"),closestBlock.find("[data-mode=\"hide\"]").removeClass("d-none")):(bodyContents.removeClass("d-none"),app.cacheSet(module+"."+blockId,1),currentTarget.addClass("d-none"),closestBlock.find("[data-mode=\"show\"]").removeClass("d-none")),app.event.trigger("DetailView.js-block-toggle.PostLoad",bodyContents,data,thisInstance);});},registerBlockStatusCheckOnLoad:function registerBlockStatusCheckOnLoad(){var blocks=this.getContentHolder().find(".js-toggle-panel"),module=app.getModuleName();blocks.each(function(index,block){var currentBlock=jQuery(block),dynamicAttr=currentBlock.attr("data-dynamic");if(("undefined"==typeof dynamicAttr?"undefined":_typeof(dynamicAttr))!=="undefined"&&!1!==dynamicAttr){var headerAnimationElement=currentBlock.find(".js-block-toggle").not(".d-none"),bodyContents=currentBlock.closest(".js-toggle-panel").find(".blockContent"),blockId=headerAnimationElement.data("id"),value=app.cacheGet(module+"."+blockId,null);null!=value&&(1==value?(headerAnimationElement.addClass("d-none"),currentBlock.find("[data-mode='show']").removeClass("d-none"),bodyContents.removeClass("d-none")):(headerAnimationElement.addClass("d-none"),currentBlock.find("[data-mode='hide']").removeClass("d-none"),bodyContents.addClass("d-none")));}});},ajaxEditHandling:function ajaxEditHandling(currentTdElement){var thisInstance=this,readRecord=jQuery(".setReadRecord");readRecord.prop("disabled",!0);var detailViewValue=jQuery(".value",currentTdElement),editElement=jQuery(".edit",currentTdElement),actionElement=jQuery(".js-detail-quick-edit",currentTdElement),fieldElement=jQuery(".fieldname",editElement);jQuery(fieldElement).each(function(index,element){var fieldName=jQuery(element).val(),elementTarget=jQuery(element),elementName=-1==jQuery.inArray(elementTarget.data("type"),["taxes","sharedOwner","multipicklist"])?fieldName:fieldName+"[]",fieldElement=jQuery("[name=\""+elementName+"\"]:not([type=\"hidden\"])",editElement);if("disabled"!=fieldElement.attr("disabled")&&!(0>=editElement.length)&&!editElement.is(":visible")){fieldElement.attr("data-inputmask")&&fieldElement.inputmask(),detailViewValue.addClass("d-none"),actionElement.addClass("d-none"),editElement.removeClass("d-none").children().filter("input[type!=\"hidden\"]input[type!=\"image\"],select").filter(":first").focus();var saveHandler=function(e){function toStr(v){return void 0===v||null===v?"":v+""}thisInstance.registerNameAjaxEditEvent();var element=jQuery(e.target);if(!(element.closest(".fieldValue").is(currentTdElement)||element.hasClass("select2-selection__choice__remove"))){currentTdElement.removeAttr("tabindex"),currentTdElement.removeClass("is-edit-active");var previousValue=elementTarget.data("prevValue"),formElement=thisInstance.getForm(),formData=formElement.serializeFormData(),ajaxEditNewValue=formData[fieldName]?formData[fieldName]:formData[elementName],fieldValue=ajaxEditNewValue,fieldInfo=Vtiger_Field_Js.getInstance(fieldElement.data("fieldinfo")),dateTimeField=[],dateTime=!1;if(2==editElement.find("[data-fieldinfo]").length&&editElement.find("[data-fieldinfo]").each(function(){var field={name:jQuery(this).attr("name"),type:jQuery(this).data("fieldinfo").type};"datetime"==field.type&&(dateTime=!0),dateTimeField.push(field);}),fieldElement.is("input:checkbox")&&(ajaxEditNewValue=fieldElement.is(":checked")?"1":"0",fieldElement=fieldElement.filter("[type=\"checkbox\"]")),fieldElement.validationEngine("validate"))return void(fieldElement.attr("data-inputmask")&&fieldElement.inputmask());if(fieldElement.validationEngine("hide"),toStr(previousValue)===toStr(ajaxEditNewValue))editElement.addClass("d-none"),detailViewValue.removeClass("d-none"),actionElement.removeClass("d-none"),readRecord.prop("disabled",!1),editElement.off("clickoutside");else{var preFieldSaveEvent=jQuery.Event(thisInstance.fieldPreSave);if(fieldElement.trigger(preFieldSaveEvent,{fieldValue:fieldValue,recordId:thisInstance.getRecordId()}),preFieldSaveEvent.isDefaultPrevented())return void readRecord.prop("disabled",!1);currentTdElement.progressIndicator(),editElement.addClass("d-none");var fieldNameValueMap={};fieldNameValueMap.value=fieldValue,fieldNameValueMap.field=fieldName,fieldNameValueMap=thisInstance.getCustomFieldNameValueMap(fieldNameValueMap),thisInstance.saveFieldValues(fieldNameValueMap).done(function(response){if(editElement.off("clickoutside"),readRecord.prop("disabled",!1),currentTdElement.progressIndicator({mode:"hide"}),detailViewValue.removeClass("d-none"),actionElement.removeClass("d-none"),!!response.success){var postSaveRecordDetails=response.result,displayValue=postSaveRecordDetails[fieldName].display_value,prevDisplayValue=postSaveRecordDetails[fieldName].prev_display_value;dateTimeField.length&&dateTime&&(displayValue=postSaveRecordDetails[dateTimeField[0].name].display_value+" "+postSaveRecordDetails[dateTimeField[1].name].display_value),detailViewValue.html(displayValue),Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_SAVE_NOTIFY_OK"),text:"<b>"+fieldInfo.data.label+"</b><br><b>"+app.vtranslate("JS_SAVED_FROM")+"</b>: "+prevDisplayValue+"<br> <b>"+app.vtranslate("JS_SAVED_TO")+"</b>: "+displayValue,type:"info",textTrusted:!0}),!1===postSaveRecordDetails.isEditable&&(jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),window===window.parent?window.location.reload():window.location.href=window.location.href.replace("view=Detail","view=DetailPreview")),fieldElement.trigger(thisInstance.fieldUpdatedEvent,{old:previousValue,new:fieldValue}),ajaxEditNewValue=void 0===ajaxEditNewValue?"":ajaxEditNewValue,elementTarget.data("prevValue",ajaxEditNewValue),fieldElement.data("selectedValue",ajaxEditNewValue),thisInstance.targetPicklistChange&&(0<jQuery(".js-widget-general-info",thisInstance.getForm()).length?thisInstance.targetPicklist.find(".js-detail-quick-edit").trigger("click"):thisInstance.targetPicklist.trigger("click"),thisInstance.targetPicklistChange=!1,thisInstance.targetPicklist=!1);var selectedTabElement=thisInstance.getSelectedTab();if(selectedTabElement.data("linkKey")==thisInstance.detailViewSummaryTabLabel){var detailContentsHolder=thisInstance.getContentHolder();thisInstance.reloadTabContent(),thisInstance.registerSummaryViewContainerEvents(detailContentsHolder),thisInstance.registerEventForPicklistDependencySetup(thisInstance.getForm()),thisInstance.registerEventForRelatedList();}else selectedTabElement.data("linkKey")==thisInstance.detailViewDetailsTabLabel&&thisInstance.registerEventForPicklistDependencySetup(thisInstance.getForm());thisInstance.updateRecordsPDFTemplateBtn(thisInstance.getForm());}}).fail(function(){editElement.addClass("d-none"),detailViewValue.removeClass("d-none"),actionElement.removeClass("d-none"),editElement.off("clickoutside"),readRecord.prop("disabled",!1),currentTdElement.progressIndicator({mode:"hide"});});}}};editElement.on("clickoutside",saveHandler);}});},triggerDisplayTypeEvent:function triggerDisplayTypeEvent(){var widthType=app.cacheGet("widthType","narrowWidthType");if(widthType){var elements=jQuery("#detailView").find("td");elements.addClass(widthType);}},addElementsToQuickCreateForCreatingRelation:function addElementsToQuickCreateForCreatingRelation(container,customParams){jQuery("<input type=\"hidden\" name=\"relationOperation\" value=\"true\" >").appendTo(container),jQuery.each(customParams,function(index,value){jQuery("<input type=\"hidden\" name=\""+index+"\" value=\""+value+"\" >").appendTo(container);});},registerEventForActivityWidget:function registerEventForActivityWidget(){var thisInstance=this;jQuery(".createActivity").on("click",function(e){var recordId=thisInstance.getRecordId(),module=app.getModuleName(),element=jQuery(e.currentTarget),customParams={};if(customParams.sourceModule=module,customParams.sourceRecord=recordId,""!=module&&!0&&"undefined"!=typeof thisInstance.referenceFieldNames.Calendar&&"undefined"!=typeof thisInstance.referenceFieldNames.Calendar[module]){var relField=thisInstance.referenceFieldNames.Calendar[module];customParams[relField]=recordId;}var fullFormUrl=element.data("url"),QuickCreateParams={};QuickCreateParams.callbackPostShown=function preQuickCreateSave(data){thisInstance.addElementsToQuickCreateForCreatingRelation(data,customParams);var taskGoToFullFormButton=data.find("[class^=\"CalendarQuikcCreateContents\"]").find(".js-full-editlink"),eventsGoToFullFormButton=data.find("[class^=\"EventsQuikcCreateContents\"]").find(".js-full-editlink"),taskFullFormUrl=taskGoToFullFormButton.data("url")+"&"+fullFormUrl,eventsFullFormUrl=eventsGoToFullFormButton.data("url")+"&"+fullFormUrl;taskGoToFullFormButton.data("url",taskFullFormUrl),eventsGoToFullFormButton.data("url",eventsFullFormUrl);},QuickCreateParams.callbackFunction=function callbackFunction(){var widgetContainer=element.closest(".js-detail-widget"),widgetContentBlock=widgetContainer.find(".widgetContentBlock"),urlParams=widgetContentBlock.data("url");AppConnector.request({type:"GET",dataType:"html",data:urlParams}).done(function(data){var activitiesWidget=widgetContainer.find(".js-detail-widget-content");activitiesWidget.html(data),App.Fields.Picklist.changeSelectElementView(activitiesWidget),thisInstance.loadWidget($(".widgetContentBlock[data-type=\"Updates\"]")),thisInstance.loadWidget($(".widgetContentBlock[data-name=\"Calendar\"]"));});},QuickCreateParams.data=Object.assign({},customParams),QuickCreateParams.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule("Calendar",QuickCreateParams);});},getEndDate:function getEndDate(startDate){var dateTab=startDate.split("-"),date=new Date(dateTab[0],dateTab[1],dateTab[2]),newDate=new Date;return newDate.setDate(date.getDate()+2),app.getStringDate(newDate)},getSingleEventType:function getSingleEventType(modDay,id,type){var dateStartEl=jQuery("[name=\"date_start\"]"),dateStartVal=jQuery(dateStartEl).val(),dateStartFormat=jQuery(dateStartEl).data("date-format"),validDateFromat=Vtiger_Helper_Js.convertToDateString(dateStartVal,dateStartFormat,modDay,type),map=jQuery.extend({},["#b6a996,black"]),params={module:"Calendar",action:"Feed",start:validDateFromat,end:this.getEndDate(validDateFromat),type:type,mapping:map};AppConnector.request(params).done(function(events){var testDate=Vtiger_Helper_Js.convertToDateString(dateStartVal,dateStartFormat,modDay);if(!jQuery.isEmptyObject(events))if("Task"===events[0].activitytype)for(var ev in events)-1<events[ev].start.indexOf(testDate)&&jQuery("#"+id+" .table").append("<tr><td><a target=\"_blank\" href=\""+events[ev].url+"\">"+events[ev].title+"</a></td></tr>");else for(var i=0;i<events[0].length;i++)-1<events[0][i].start.indexOf(testDate)&&jQuery("#"+id+" .table").append("<tr><td><a target=\"_blank\" href=\""+events[0][i].url+"\">"+events[0][i].title+"</a></td></tr>");});},registerFilterForAddingModuleRelatedRecordFromSummaryWidget:function registerFilterForAddingModuleRelatedRecordFromSummaryWidget(){var thisInstance=this;jQuery(".createRecordFromFilter").on("click",function(e){var currentElement=jQuery(e.currentTarget),summaryWidgetContainer=currentElement.closest(".js-detail-widget"),widgetDataContainer=summaryWidgetContainer.find(".js-detail-widget-content"),referenceModuleName=widgetDataContainer.find("[name=\"relatedModule\"]").val(),quickcreateUrl=currentElement.data("url"),parentId=thisInstance.getRecordId(),quickCreateParams={},relatedField=currentElement.data("prf"),autoCompleteFields=currentElement.data("acf"),moduleName=currentElement.closest(".js-detail-widget-header").find("[name=\"relatedModule\"]").val(),relatedParams={};"undefined"!=typeof relatedField&&(relatedParams[relatedField]=parentId),"undefined"!=typeof autoCompleteFields&&$.each(autoCompleteFields,function(index,value){relatedParams[index]=value;}),0<Object.keys(relatedParams).length&&(quickCreateParams.data=relatedParams),quickCreateParams.noCache=!0,quickCreateParams.callbackFunction=function postQuickCreateSave(data){thisInstance.postSummaryWidgetAddRecord(data,currentElement),"ProjectTask"==referenceModuleName&&thisInstance.loadModuleSummary();};var progress=jQuery.progressIndicator(),headerInstance=void 0;headerInstance=window===window.parent?Vtiger_Header_Js.getInstance():window.parent.Vtiger_Header_Js.getInstance(),headerInstance.getQuickCreateForm(quickcreateUrl,moduleName,quickCreateParams).done(function(data){headerInstance.handleQuickCreateData(data,quickCreateParams),progress.progressIndicator({mode:"hide"});});}),$(".js-detail-widget button.selectRelation").on("click",function(e){var summaryWidgetContainer=jQuery(e.currentTarget).closest(".js-detail-widget"),referenceModuleName=summaryWidgetContainer.find(".js-detail-widget-content [name=\"relatedModule\"]").val(),restrictionsField=$(this).data("rf"),params={module:referenceModuleName,src_module:app.getModuleName(),src_record:thisInstance.getRecordId(),multi_select:!0};restrictionsField&&0<Object.keys(restrictionsField).length&&(params.search_key=restrictionsField.key,params.search_value=restrictionsField.name),app.showRecordsList(params,function(modal,instance){instance.setSelectEvent(function(responseData){thisInstance.addRelationBetweenRecords(referenceModuleName,Object.keys(responseData)).done(function(){thisInstance.loadWidget(summaryWidgetContainer.find(".widgetContentBlock"));});});});});},registerAddingInventoryRecords:function registerAddingInventoryRecords(){jQuery(".createInventoryRecordFromFilter").on("click",function(e){var currentElement=jQuery(e.currentTarget),createUrl=currentElement.data("url"),autoCompleteFields=currentElement.data("acf"),addidtionalParams="";"undefined"!=typeof autoCompleteFields&&$.each(autoCompleteFields,function(index,value){addidtionalParams="&"+index+"="+value,createUrl=createUrl.concat(addidtionalParams);}),window.location.href=createUrl;});},registerEmailEvent:function registerEmailEvent(){this.getContentHolder().find(".resetRelationsEmail").on("click",function(){Vtiger_Helper_Js.showConfirmationBox({message:app.vtranslate("JS_EMAIL_RESET_RELATIONS_CONFIRMATION")}).done(function(){AppConnector.request({module:"OSSMailView",action:"Relation",moduleName:app.getModuleName(),record:app.getRecordId()}).done(function(d){Vtiger_Helper_Js.showMessage({text:d.result});});});});},getFiltersDataAndLoad:function getFiltersDataAndLoad(e,params){var data=this.getFiltersData(e,params);this.loadWidget(data.container,data.params);},getFiltersData:function getFiltersData(e,params){if(e.currentTarget)var currentElement=jQuery(e.currentTarget);else currentElement=e;var summaryWidgetContainer=currentElement.closest(".js-detail-widget"),widget=summaryWidgetContainer.find(".widgetContentBlock"),url="&"+widget.data("url"),urlParams={};url.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(m,key,value){urlParams[key]=value;});var urlNewParams=[];return summaryWidgetContainer.find(".js-detail-widget-header .js-switch, .js-detail-widget-header .js-filter_field").each(function(n,item){var value="",element=jQuery(item),name=element.data("urlparams");if("radio"==element.attr("type"))element.prop("checked")&&(value="undefined"==typeof element.data("on-val")?element.data("off-val"):element.data("on-val"));else{var selectedFilter=element.find("option:selected").val(),fieldlable=element.data("fieldlable"),filter=element.data("filter");if(selectedFilter!=fieldlable)value=[[filter,"e",selectedFilter]];else return}name&&value&&(name in urlNewParams?urlNewParams[name].push(value):urlNewParams[name]=[value]);}),null!=params&&$.extend(urlNewParams,params),{container:$(widget),params:$.extend(urlParams,urlNewParams)}},registerChangeFilterForWidget:function registerChangeFilterForWidget(){var thisInstance=this;jQuery(".js-switch").on("change",function(e){thisInstance.getFiltersDataAndLoad(e);}),jQuery(".js-filter_field").on("select2:select",function(e){thisInstance.getFiltersDataAndLoad(e);});},registerChangeSwitchForWidget:function registerChangeSwitchForWidget(summaryViewContainer){var thisInstance=this;summaryViewContainer.find(".activityWidgetContainer").on("change",".js-switch",function(e){var currentElement=jQuery(e.currentTarget),summaryWidgetContainer=currentElement.closest(".js-detail-widget"),widget=summaryWidgetContainer.find(".widgetContentBlock"),url=widget.data("url");url=url.replace("&type=current","").replace("&type=history",""),url+="&type=","undefined"==typeof currentElement.data("on-val")?"undefined"!=typeof currentElement.data("off-val")&&(summaryWidgetContainer.find(".ativitiesPagination").addClass("d-none"),url+="history",url=url.replace("&sortorder=ASC","&sortorder=DESC")):(summaryWidgetContainer.find(".ativitiesPagination").removeClass("d-none"),url+="current",url=url.replace("&sortorder=DESC","&sortorder=ASC")),widget.data("url",url),thisInstance.loadWidget($(widget));});},registerSummaryViewContainerEvents:function registerSummaryViewContainerEvents(summaryViewContainer){var thisInstance=this;this.registerEventForActivityWidget(),this.registerChangeFilterForWidget(),this.registerChangeSwitchForWidget(summaryViewContainer),this.registerFilterForAddingModuleRelatedRecordFromSummaryWidget(),this.registerAddingInventoryRecords(),this.registerEmailEvent(),summaryViewContainer.off("click").on("click",".row .js-detail-quick-edit",function(e){var currentTarget=jQuery(e.currentTarget);currentTarget.addClass("d-none");var currentTdElement=currentTarget.closest(".fieldValue");thisInstance.ajaxEditHandling(currentTdElement);}),summaryViewContainer.on(thisInstance.fieldUpdatedEvent,".js-widget-general-info",function(){var params,updatesWidget=summaryViewContainer.find("[data-type='Updates']");updatesWidget.length&&(params=thisInstance.getFiltersData(updatesWidget),updatesWidget.find(".btnChangesReviewedOn").parent().remove(),thisInstance.loadWidget(updatesWidget,params.params));}),summaryViewContainer.on("click",".editDefaultStatus",function(e){var currentTarget=jQuery(e.currentTarget);currentTarget.popover("hide");var url=currentTarget.data("url");if(url)if(currentTarget.hasClass("showEdit")){var headerInstance=Vtiger_Header_Js.getInstance();window!==window.parent&&(headerInstance=window.parent.Vtiger_Header_Js.getInstance()),headerInstance.getQuickCreateForm(url,"Calendar",{noCache:!0}).done(function(data){headerInstance.handleQuickCreateData(data,{callbackFunction:function callbackFunction(){var widget=currentTarget.closest(".widgetContentBlock");if(widget.length){thisInstance.loadWidget(widget);var updatesWidget=thisInstance.getContentHolder().find("[data-type='Updates']");0<updatesWidget.length&&thisInstance.loadWidget(updatesWidget);}else thisInstance.loadRelatedList();thisInstance.registerRelatedModulesRecordCount();}});});}else app.showModalWindow(null,url);}),summaryViewContainer.on("click",".editDescription",function(e){var currentTarget=jQuery(e.currentTarget),currentDiv=currentTarget.closest(".activityDescription"),editElement=currentDiv.find(".edit"),detailViewElement=currentDiv.find(".value"),descriptionText=currentDiv.find(".js-description-text"),descriptionEmpty=currentDiv.find(".js-no-description"),saveButton=currentDiv.find(".js-save-description"),closeButton=currentDiv.find(".js-close-description"),activityButtonContainer=currentDiv.find(".js-activity-buttons__container"),fieldnameElement=jQuery(".fieldname",editElement),fieldName=fieldnameElement.val(),fieldElement=jQuery("[name=\""+fieldName+"\"]",editElement),callbackFunction=function(){var previousValue=fieldnameElement.data("prevValue"),ajaxEditNewValue=fieldElement.val(),ajaxEditNewLable=fieldElement.val(),activityDiv=currentDiv.closest(".activityEntries"),activityId=activityDiv.find(".activityId").val(),moduleName=activityDiv.find(".activityModule").val(),activityType=activityDiv.find(".activityType").val();return previousValue==ajaxEditNewValue?void closeDescription():(currentDiv.progressIndicator(),editElement.add(activityButtonContainer).addClass("d-none"),new Promise(function(resolve){resolve(fieldElement.validationEngine("validate"));}).then(function(errorExists){return errorExists?void Vtiger_Helper_Js.addClickOutSideEvent(currentDiv,callbackFunction):void(ajaxEditNewValue=fieldElement.val(),AppConnector.request({action:"SaveAjax",record:activityId,field:fieldName,value:ajaxEditNewValue,module:moduleName,activitytype:activityType}).done(function(){currentDiv.progressIndicator({mode:"hide"}),detailViewElement.removeClass("d-none"),currentTarget.show(),descriptionText.html(ajaxEditNewLable),fieldnameElement.data("prevValue",ajaxEditNewValue),""===ajaxEditNewValue?descriptionEmpty.removeClass("d-none"):descriptionEmpty.addClass("d-none");}))}))},closeDescription=function(){fieldElement.val(fieldnameElement.data("prevValue")),editElement.add(activityButtonContainer).addClass("d-none"),detailViewElement.removeClass("d-none"),currentTarget.show();};currentTarget.hide(),detailViewElement.addClass("d-none"),activityButtonContainer.removeClass("d-none"),editElement.removeClass("d-none").show(),saveButton.off("click").one("click",callbackFunction),closeButton.off("click").one("click",closeDescription);}),jQuery(".changeDetailViewMode").on("click",function(){thisInstance.getTabs().filter("[data-link-key=\""+thisInstance.detailViewDetailsTabLabel+"\"]:not(.d-none)").trigger("click");}),jQuery(".createRecord").on("click",function(e){var currentElement=jQuery(e.currentTarget),summaryWidgetContainer=currentElement.closest(".js-detail-widget"),widgetHeaderContainer=summaryWidgetContainer.find(".js-detail-widget-header"),referenceModuleName=widgetHeaderContainer.find("[name=\"relatedModule\"]").val(),recordId=thisInstance.getRecordId(),module=app.getModuleName(),customParams={};if(customParams.sourceModule=module,customParams.sourceRecord=recordId,""!=module&&""!=referenceModuleName&&"undefined"!=typeof thisInstance.referenceFieldNames[referenceModuleName]&&"undefined"!=typeof thisInstance.referenceFieldNames[referenceModuleName][module]){var fieldName=thisInstance.referenceFieldNames[referenceModuleName][module];customParams[fieldName]=recordId;}var QuickCreateParams={};QuickCreateParams.callbackFunction=function postQuickCreateSave(data){thisInstance.postSummaryWidgetAddRecord(data,currentElement);},QuickCreateParams.goToFullFormcallback=function goToFullFormcallback(data){thisInstance.addElementsToQuickCreateForCreatingRelation(data,customParams);},QuickCreateParams.data=customParams,QuickCreateParams.noCache=!1,Vtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName,QuickCreateParams);}),this.registerFastEditingFiels();},addRelationBetweenRecords:function addRelationBetweenRecords(relatedModule,relatedModuleRecordId,selectedTabElement){var aDeferred=jQuery.Deferred(),thisInstance=this;null==selectedTabElement&&(selectedTabElement=thisInstance.getSelectedTab());var relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),selectedTabElement,relatedModule);return relatedController.addRelations(relatedModuleRecordId).done(function(data){var summaryViewContainer=thisInstance.getContentHolder(),updatesWidget=summaryViewContainer.find("[data-type='Updates']");if(0<updatesWidget.length){var params=thisInstance.getFiltersData(updatesWidget);updatesWidget.find(".btnChangesReviewedOn").parent().remove(),thisInstance.loadWidget(updatesWidget,params.params);}aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);}),aDeferred.promise()},postSummaryWidgetAddRecord:function postSummaryWidgetAddRecord(data,currentElement){var thisInstance=this,summaryWidgetContainer=currentElement.closest(".js-detail-widget"),widgetHeaderContainer=summaryWidgetContainer.find(".js-detail-widget-header"),referenceModuleName=widgetHeaderContainer.find("[name=\"relatedModule\"]").val(),idList=[];idList.push(data.result._recordId),this.addRelationBetweenRecords(referenceModuleName,idList).done(function(){thisInstance.loadWidget(summaryWidgetContainer.find("[class^=\"widgetContainer_\"]"));});},registerChangeEventForModulesList:function registerChangeEventForModulesList(){jQuery("#tagSearchModulesList").on("change",function(e){var modulesSelectElement=jQuery(e.currentTarget);if("all"==modulesSelectElement.val())jQuery("[name=\"tagSearchModuleResults\"]").removeClass("d-none");else{jQuery("[name=\"tagSearchModuleResults\"]").removeClass("d-none");var selectedOptionValue=modulesSelectElement.val();jQuery("[name=\"tagSearchModuleResults\"]").filter(":not(#"+selectedOptionValue+")").addClass("d-none");}});},registerEventForRelatedTabClick:function registerEventForRelatedTabClick(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder(),detailContainer=detailContentsHolder.closest("div.detailViewInfo");jQuery(".related",detailContainer).on("click","li:not(.spaceRelatedList)",function(e,urlAttributes){var tabElement=jQuery(e.currentTarget);if(!tabElement.hasClass("dropdown")){var element=jQuery("<div></div>");element.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:detailContainer}});var url=tabElement.data("url");if("undefined"!=typeof urlAttributes){var callBack=urlAttributes.callback;delete urlAttributes.callback;}thisInstance.loadContents(url,urlAttributes).done(function(data){thisInstance.deSelectAllrelatedTabs(),thisInstance.markTabAsSelected(tabElement),Vtiger_Helper_Js.showHorizontalTopScrollBar(),element.progressIndicator({mode:"hide"}),thisInstance.registerHelpInfo(),app.registerModal(detailContentsHolder),app.registerMoreContent(detailContentsHolder.find("button.moreBtn")),"function"==typeof callBack&&callBack(data),tabElement.data("linkKey")==thisInstance.detailViewSummaryTabLabel&&thisInstance.loadWidgets(),thisInstance.registerBasicEvents(),app.notifyPostAjaxReady(),app.event.trigger("DetailView.Tab.AfterLoad",data,thisInstance);}).fail(function(){element.progressIndicator({mode:"hide"});});}});},registerEventForPicklistDependencySetup:function registerEventForPicklistDependencySetup(container){var thisInstance=this,picklistDependcyElemnt=jQuery("[name=\"picklistDependency\"]",container);if(!(0>=picklistDependcyElemnt.length)){var picklistDependencyMapping=JSON.parse(picklistDependcyElemnt.val()),sourcePicklists=Object.keys(picklistDependencyMapping);if(!(0>=sourcePicklists.length)){for(var sourcePickListNames=[],i=0;i<sourcePicklists.length;i++)sourcePickListNames.push("[name=\""+sourcePicklists[i]+"\"]");sourcePickListNames=sourcePickListNames.join(",");var sourcePickListElements=container.find(sourcePickListNames);sourcePickListElements.on("change",function(e){var currentElement=jQuery(e.currentTarget),sourcePicklistname=currentElement.attr("name"),configuredDependencyObject=picklistDependencyMapping[sourcePicklistname],selectedValue=currentElement.val(),targetObjectForSelectedSourceValue=configuredDependencyObject[selectedValue],picklistmap=configuredDependencyObject.__DEFAULT__;"undefined"==typeof targetObjectForSelectedSourceValue&&(targetObjectForSelectedSourceValue=picklistmap),jQuery.each(picklistmap,function(targetPickListName,targetPickListValues){var targetPickListMap=targetObjectForSelectedSourceValue[targetPickListName];"undefined"==typeof targetPickListMap&&(targetPickListMap=targetPickListValues);var targetPickList=jQuery("[name=\""+targetPickListName+"\"]",container);if(!(0>=targetPickList.length)){var selectedValue=targetPickList.data("selectedValue");-1==jQuery.inArray(selectedValue,targetPickListMap)?(thisInstance.targetPicklistChange=!0,thisInstance.targetPicklist=targetPickList.closest("td")):(thisInstance.targetPicklistChange=!1,thisInstance.targetPicklist=!1);var listOfAvailableOptions=targetPickList.data("availableOptions");"undefined"==typeof listOfAvailableOptions&&(listOfAvailableOptions=jQuery("option",targetPickList),targetPickList.data("available-options",listOfAvailableOptions));var targetOptions=new jQuery,optionSelector=[];optionSelector.push("");for(var i=0;i<targetPickListMap.length;i++)optionSelector.push(targetPickListMap[i]);jQuery.each(listOfAvailableOptions,function(i,e){var picklistValue=jQuery(e).val();-1!=jQuery.inArray(picklistValue,optionSelector)&&(targetOptions=targetOptions.add(jQuery(e)));});var targetPickListSelectedValue="";targetPickListSelectedValue=targetOptions.filter("[selected]").val(),1==targetPickListMap.length&&(targetPickListSelectedValue=targetPickListMap[0]),targetPickList.html(targetOptions).val(targetPickListSelectedValue).trigger("change");}});}),sourcePickListElements.trigger("change");}}},getChildComments:function getChildComments(commentId){var aDeferred=jQuery.Deferred(),url="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showChildComments&commentid="+commentId,dataObj=this.getCommentThread(url);return dataObj.done(function(data){aDeferred.resolve(data);}),aDeferred.promise()},getParentComments:function getParentComments(commentId){var aDeferred=$.Deferred(),url="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showParentComments&commentid="+commentId;return this.getCommentThread(url).done(function(data){aDeferred.resolve(data);}),aDeferred.promise()},registerEventForTotalRecordsCount:function registerEventForTotalRecordsCount(){var thisInstance=this,detailContentsHolder=this.getContentHolder();detailContentsHolder.on("click",".totalNumberOfRecords",function(e){var element=jQuery(e.currentTarget),totalNumberOfRecords=jQuery("#totalCount").val();if(element.addClass("d-none"),element.parent().progressIndicator({}),""==totalNumberOfRecords){var selectedTabElement=thisInstance.getSelectedTab(),relatedModuleName=thisInstance.getRelatedModuleName(),relatedController=Vtiger_RelatedList_Js.getInstance(thisInstance.getRecordId(),app.getModuleName(),selectedTabElement,relatedModuleName);relatedController.getRelatedPageCount().done(function(){thisInstance.showPagingInfo();});}else thisInstance.showPagingInfo();element.parent().progressIndicator({mode:"hide"});});},showPagingInfo:function showPagingInfo(){var totalNumberOfRecords=jQuery("#totalCount").val(),pageNumberElement=jQuery(".pageNumbersText"),pageRange=pageNumberElement.text(),listViewEntriesCount=parseInt(jQuery("#noOfEntries").val());0==listViewEntriesCount?jQuery(".pageNumbersText").html(""):jQuery(".pageNumbersText").html(pageRange+" ("+totalNumberOfRecords+")");},getCustomFieldNameValueMap:function getCustomFieldNameValueMap(fieldNameValueMap){return fieldNameValueMap},registerSetReadRecord:function registerSetReadRecord(detailContentsHolder){var thisInstance=this;detailContentsHolder.on("click",".setReadRecord",function(e){var currentElement=jQuery(e.currentTarget);currentElement.closest(".btn-group").addClass("d-none"),jQuery("#Accounts_detailView_fieldValue_was_read").find(".value").text(app.vtranslate("LBL_YES"));var params={module:app.getModuleName(),action:"SaveAjax",record:thisInstance.getRecordId(),field:"was_read",value:"on"};AppConnector.request(params).done(function(){var params={text:app.vtranslate("JS_SET_READ_RECORD"),title:app.vtranslate("System"),type:"info"};Vtiger_Helper_Js.showPnotify(params);var relatedTabKey=jQuery(".related li.active");(relatedTabKey.data("linkKey")==thisInstance.detailViewSummaryTabLabel||relatedTabKey.data("linkKey")==thisInstance.detailViewDetailsTabLabel)&&thisInstance.reloadTabContent();});});},registerFastEditingFiels:function registerFastEditingFiels(){var thisInstance=this,fastEditingFiels=jQuery(".summaryWidgetFastEditing select");fastEditingFiels.on("change",function(e){var fieldElement=jQuery(e.currentTarget),fieldContainer=fieldElement.closest(".editField"),progressIndicatorElement=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"summaryWidgetFastEditing",blockInfo:{enabled:!0}}),fieldName=fieldContainer.data("fieldname");fieldName=fieldName.replace("q_","");var fieldValue=fieldElement.val(),errorExists=fieldElement.validationEngine("validate");if(errorExists)return void fieldContainer.progressIndicator({mode:"hide"});var preFieldSaveEvent=jQuery.Event(thisInstance.fieldPreSave);fieldElement.trigger(preFieldSaveEvent,{fieldValue:fieldValue,recordId:thisInstance.getRecordId()});var fieldNameValueMap={};fieldNameValueMap.value=fieldValue,fieldNameValueMap.field=fieldName,fieldNameValueMap=thisInstance.getCustomFieldNameValueMap(fieldNameValueMap),thisInstance.saveFieldValues(fieldNameValueMap),progressIndicatorElement.progressIndicator({mode:"hide"});var params={title:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success"};Vtiger_Helper_Js.showPnotify(params),thisInstance.reloadTabContent();});},registerHelpInfo:function registerHelpInfo(){var form=this.getForm();app.showPopoverElementView(form.find(".js-help-info"));},registerRelatedModulesRecordCount:function registerRelatedModulesRecordCount(tabContainer){var moreList=$(".related .nav .dropdown-menu"),relationContainer=tabContainer;relationContainer&&"undefined"!=typeof relationContainer.length||(relationContainer=$(".related .nav > .relatedNav, .related .nav > .mainNav, .detailViewBlockLink, .related .nav .dropdown-menu > .relatedNav")),relationContainer.each(function(n,item){item=$(item),1!==item.data("count")||Array.isArray(item.data("reference"))||AppConnector.request({module:app.getModuleName(),action:"RelationAjax",record:app.getRecordId(),relatedModule:item.data("reference"),mode:"getRelatedListPageCount",tab_label:item.data("label-key")}).done(function(response){response.success&&(0===response.result.numberOfRecords&&(response.result.numberOfRecords=""),item.find(".count").text(response.result.numberOfRecords),moreList.find("[data-reference=\""+item.data("reference")+"\"] .count").text(response.result.numberOfRecords));});});},addComment:function addComment(currentTarget,data){var self=this,mode=currentTarget.data("mode"),closestAddCommentBlock=currentTarget.closest(".js-add-comment-block"),commentTextAreaElement=closestAddCommentBlock.find(".js-comment-content"),commentInfoBlock=currentTarget.closest(".js-comment-single");if(commentTextAreaElement.val(""),"add"==mode){var commentId=data.result.id,commentHtml=self.getCommentUI(commentId);commentHtml.done(function(data){var commentBlock=closestAddCommentBlock.closest(".js-comment-details"),detailContentsHolder=self.getContentHolder(),noCommentsMsgContainer=$(".js-noCommentsMsgContainer",detailContentsHolder);if(noCommentsMsgContainer.remove(),0<commentBlock.length){closestAddCommentBlock.remove();var childComments=commentBlock.find("ul");if(0>=childComments.length){var currentChildCommentsCount=commentInfoBlock.find(".js-view-thread-block").data("data-child-comments-count");commentInfoBlock.find(".js-child-comments-count").text(currentChildCommentsCount+1);var parentCommentId=commentInfoBlock.find(".js-comment-info-header").data("commentid");self.getChildComments(parentCommentId).done(function(responsedata){$(responsedata).appendTo(commentBlock),commentInfoBlock.find(".js-view-thread-block").hide(),commentInfoBlock.find(".hideThreadBlock").show();});}else $("<ul class=\"liStyleNone\"><li class=\"js-comment-details commentDetails\">"+data+"</li></ul>").appendTo(commentBlock);}else $("<ul class=\"liStyleNone\"><li class=\"js-comment-details commentDetails\">"+data+"</li></ul>").prependTo(closestAddCommentBlock.closest(".contents").find(".commentsList"));commentInfoBlock.find(".js-comment-container").show(),app.event.trigger("DetailView.SaveComment.AfterLoad",commentInfoBlock,data);});}else if("edit"==mode){var modifiedTime=commentInfoBlock.find(".js-comment-modified-time"),commentInfoContent=commentInfoBlock.find(".js-comment-info"),commentEditStatus=commentInfoBlock.find(".js-edited-status"),commentReason=commentInfoBlock.find(".js-edit-reason-span");commentInfoContent.html(data.result.commentcontent),commentReason.html(data.result.reasontoedit),modifiedTime.html(data.result.modifiedtime),modifiedTime.attr("title",data.result.modifiedtimetitle),commentEditStatus.hasClass("d-none")&&commentEditStatus.removeClass("d-none"),""!=data.result.reasontoedit&&commentInfoBlock.find(".js-edit-reason").removeClass("d-none"),commentInfoContent.show(),commentInfoBlock.find(".js-comment-container").show(),closestAddCommentBlock.remove(),app.event.trigger("DetailView.SaveComment.AfterUpdate",commentInfoBlock,data);}},registerCommentEvents:function registerCommentEvents(detailContentsHolder){var self=this;detailContentsHolder.on("click",".js-close-comment-block",function(e){var commentInfoBlock=$(e.currentTarget.closest(".js-comment-single"));commentInfoBlock.find(".js-comment-container").show(),commentInfoBlock.find(".js-comment-info").show(),self.removeCommentBlockIfExists();}),detailContentsHolder.on("click",".js-reply-comment",function(e){self.removeCommentBlockIfExists();var commentInfoBlock=$(e.currentTarget).closest(".js-comment-single");commentInfoBlock.find(".js-comment-container").hide(),self.getCommentBlock().appendTo(commentInfoBlock).show();}),detailContentsHolder.on("click",".js-edit-comment",function(e){self.removeCommentBlockIfExists();var commentInfoBlock=$(e.currentTarget).closest(".js-comment-single"),commentInfoContent=commentInfoBlock.find(".js-comment-info"),editCommentBlock=self.getEditCommentBlock();editCommentBlock.find(".js-comment-content").html(commentInfoContent.html()),editCommentBlock.find(".js-reason-to-edit").html(commentInfoBlock.find(".js-edit-reason-span").text()),commentInfoContent.hide(),commentInfoBlock.find(".js-comment-container").hide(),editCommentBlock.appendTo(commentInfoBlock).show();}),detailContentsHolder.on("click",".js-detail-view-save-comment",function(e){var element=$(e.currentTarget);element.is(":disabled")||self.saveComment(e).done(function(){self.registerRelatedModulesRecordCount(),self.loadWidget(detailContentsHolder.find("[data-type='Comments']")).done(function(){element.removeAttr("disabled");});}).fail(function(error,err){element.removeAttr("disabled"),app.errorLog(error,err);});}),detailContentsHolder.on("click",".js-save-comment",function(e){var element=$(e.currentTarget);element.is(":disabled")||self.saveComment(e).done(function(data){self.registerRelatedModulesRecordCount(self.getTabByLabel(self.detailViewRecentCommentsTabLabel)),self.addComment(element,data),element.removeAttr("disabled");}).fail(function(error,err){element.removeAttr("disabled"),app.errorLog(error,err);});}),detailContentsHolder.on("click",".js-more-recent-comments ",function(){self.getTabByLabel(self.detailViewRecentCommentsTabLabel).trigger("click");}),detailContentsHolder.find(".js-detail-hierarchy-comments-btn").on("click",function(){if(!($(this).hasClass("active")&&2>detailContentsHolder.find(".js-detail-hierarchy-comments-btn.active").length)){var recentCommentsTab=self.getTabByLabel(self.detailViewRecentCommentsTabLabel),url=recentCommentsTab.data("url"),regex=/&hierarchy=+([\w,]+)/;url=url.replace(regex,"");var hierarchy=[];$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active"),detailContentsHolder.find(".js-detail-hierarchy-comments-btn.active").each(function(){hierarchy.push($(this).find(".js-detail-hierarchy-comments").val());}),0!==hierarchy.length&&(url+="&hierarchy="+hierarchy.join(",")),recentCommentsTab.data("url",url),recentCommentsTab.trigger("click");}}),detailContentsHolder.on("keypress",".js-comment-search",function(e){13===e.which&&self.submitSearchForm(detailContentsHolder);}),detailContentsHolder.on("click",".js-search-icon",function(){self.submitSearchForm(detailContentsHolder);});},submitSearchForm:function submitSearchForm(detailContentsHolder){var searchTextDom=detailContentsHolder.find(".js-comment-search"),widgetContainer=searchTextDom.closest("[data-name=\"ModComments\"]"),progressIndicatorElement=$.progressIndicator();if("widget"===searchTextDom.data("container")&&!searchTextDom.val()){var request=widgetContainer.data("url");AppConnector.request(request).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),detailContentsHolder.find(".js-comments-container").html(data);});}else{var hierarchy=[],limit="",isWidget=!1;"widget"===searchTextDom.data("container")?(limit=widgetContainer.data("limit"),isWidget=!0,widgetContainer.find(".js-hierarchy-comments:checked").each(function(){hierarchy.push($(this).val());})):detailContentsHolder.find(".js-detail-hierarchy-comments:checked").each(function(){hierarchy.push($(this).val());}),AppConnector.request({module:app.getModuleName(),view:"Detail",mode:"showSearchComments",hierarchy:hierarchy.join(","),limit:limit,record:app.getRecordId(),search_key:searchTextDom.val(),is_widget:isWidget}).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),searchTextDom.val()?detailContentsHolder.find(".js-comments-body").html(data):detailContentsHolder.html(data);});}},registerCommentEventsInDetail:function registerCommentEventsInDetail(widgetContainer){new App.Fields.Text.Completions,widgetContainer.on("change",".js-hierarchy-comments",function(){var hierarchy=[];widgetContainer.find(".js-hierarchy-comments").each(function(){$(this).is(":checked")&&hierarchy.push($(this).val());});var progressIndicatorElement=$.progressIndicator();AppConnector.request({module:app.getModuleName(),view:"Detail",mode:"showRecentComments",hierarchy:hierarchy.join(","),record:app.getRecordId(),limit:widgetContainer.find(".widgetContentBlock").data("limit")}).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"});var widgetDataContainer=widgetContainer.find(".js-detail-widget-content");widgetDataContainer.html(data),App.Fields.Picklist.showSelect2ElementView(widgetDataContainer.find(".select2"));});});},registerMailPreviewWidget:function registerMailPreviewWidget(container){var self=this;container.on("click",".showMailBody",function(e){var row=$(e.currentTarget).closest(".row"),mailBody=row.find(".mailBody"),mailTeaser=row.find(".mailTeaser");mailBody.toggleClass("d-none"),mailTeaser.toggleClass("d-none");}),container.find("[name=\"mail-type\"]").on("change",function(){self.loadMailPreviewWidget(container);}),container.find("[name=\"mailFilter\"]").on("change",function(){self.loadMailPreviewWidget(container);}),container.on("click",".showMailsModal",function(e){var url=$(e.currentTarget).data("url");url+="&type="+container.find("[name=\"mail-type\"]").val(),0<container.find("[name=\"mailFilter\"]").length&&(url+="&mailFilter="+container.find("[name=\"mailFilter\"]").val());var progressIndicatorElement=jQuery.progressIndicator();app.showModalWindow("",url,function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),self.registerMailPreviewWidget(data),Vtiger_Index_Js.registerMailButtons(data),data.find(".expandAllMails").click();});}),container.find(".expandAllMails").on("click",function(){container.find(".mailBody").removeClass("d-none"),container.find(".mailTeaser").addClass("d-none"),container.find(".showMailBody .js-toggle-icon").removeClass("fa-caret-down").addClass("fa-caret-up");}),container.find(".collapseAllMails").on("click",function(){container.find(".mailBody").addClass("d-none"),container.find(".mailTeaser").removeClass("d-none"),container.find(".showMailBody .js-toggle-icon").removeClass("fa-caret-up").addClass("fa-caret-down");});},loadMailPreviewWidget:function loadMailPreviewWidget(widgetContent){var thisInstance=this,widgetDataContainer=widgetContent.find(".js-detail-widget-content"),recordId=$("#recordId").val(),progress=widgetDataContainer.progressIndicator(),params={};params.module="OSSMailView",params.view="Widget",params.smodule=$("#module").val(),params.srecord=recordId,params.mode="showEmailsList",params.type=$("[name=\"mail-type\"]").val(),params.mailFilter=$("[name=\"mailFilter\"]").val(),AppConnector.request(params).done(function(data){widgetDataContainer.html(data),app.event.trigger("DetailView.Widget.AfterLoad",widgetDataContainer,params.module,thisInstance),progress.progressIndicator({mode:"hide"});});},registerEmailEvents:function registerEmailEvents(detailContentsHolder){Vtiger_Index_Js.registerMailButtons(detailContentsHolder);},registerMapsEvents:function registerMapsEvents(container){if(container.find("#coordinates").length){var mapView=new OpenStreetMap_Map_Js;mapView.registerDetailView(container);}},registerSocialMediaEvents:function registerSocialMediaEvents(container){var socialMediaContainer=container.find(".tpl-Detail-SocialMedia");socialMediaContainer.length;},registerShowSummary:function registerShowSummary(container){container.on("click",".showSummaryRelRecord",function(e){var currentTarget=$(e.currentTarget),id=currentTarget.data("id"),summaryView=container.find(".summaryRelRecordView"+id);container.find(".listViewEntriesTable").css("display","none"),summaryView.show();}),container.on("click",".hideSummaryRelRecordView",function(){var summaryView=container.find(".summaryRelRecordView");container.find(".listViewEntriesTable").css("display","table"),summaryView.hide();});},showProgressConfirmation:function showProgressConfirmation(element,picklistName){var self=this,picklistValue=$(element).data("picklistValue");Vtiger_Helper_Js.showConfirmationBox({title:$(element).data("picklistLabel"),message:app.vtranslate("JS_CHANGE_VALUE_CONFIRMATION")}).done(function(){var progressIndicatorElement=$.progressIndicator();self.saveFieldValues({value:picklistValue,field:picklistName}).done(function(){progressIndicatorElement.progressIndicator({mode:"hide"}),window.location.reload();}).fail(function(error,err){progressIndicatorElement.progressIndicator({mode:"hide"}),app.errorLog(error,err);});});},registerProgress:function registerProgress(){var self=this;$(".js-header-progress-bar").each(function(index,element){var picklistName=$(element).data("picklistName");$(element).find(".js-access").on("click",function(e){self.showProgressConfirmation(e.currentTarget,picklistName);});});},registerBasicEvents:function registerBasicEvents(){var thisInstance=this,detailContentsHolder=thisInstance.getContentHolder(),selectedTabElement=thisInstance.getSelectedTab();"undefined"!=typeof Chat_JS&&("LBL_CHAT"===this.getSelectedTab().data("labelKey")?Chat_JS.getInstance(detailContentsHolder,"detail").registerBaseEvents():Chat_JS.getInstance(detailContentsHolder,"detail").unregisterEvents()),"ModComments"===this.getSelectedTab().data("labelKey")&&new App.Fields.Text.Completions(detailContentsHolder.find(".js-completions")),thisInstance.registerSummaryViewContainerEvents(detailContentsHolder),thisInstance.registerCommentEvents(detailContentsHolder),thisInstance.registerEmailEvents(detailContentsHolder),thisInstance.registerMapsEvents(detailContentsHolder),thisInstance.registerSocialMediaEvents(detailContentsHolder),thisInstance.registerSubProducts(detailContentsHolder),App.Fields.Date.register(detailContentsHolder),App.Fields.DateTime.register(detailContentsHolder),App.Fields.MultiImage.register(detailContentsHolder),app.registerEventForClockPicker(),App.Fields.Picklist.showSelect2ElementView(detailContentsHolder.find("select.select2")),detailContentsHolder.on("click","#detailViewNextRecordButton",function(){var url=selectedTabElement.data("url"),currentPageNum=thisInstance.getRelatedListCurrentPageNum(),requestedPage=parseInt(currentPageNum)+1;thisInstance.loadContents(url+"&page="+requestedPage);}),detailContentsHolder.on("click","#detailViewPreviousRecordButton",function(){var url=selectedTabElement.data("url"),currentPageNum=thisInstance.getRelatedListCurrentPageNum(),requestedPage=parseInt(currentPageNum)-1;thisInstance.loadContents(url+"&page="+requestedPage);}),detailContentsHolder.on("click","div.detailViewTable div.fieldValue:not(.is-edit-active)",function(e){if(!jQuery(e.target).closest("a").hasClass("btnNoFastEdit")){var currentTdElement=jQuery(e.currentTarget);currentTdElement.addClass("is-edit-active"),thisInstance.ajaxEditHandling(currentTdElement);}}),detailContentsHolder.on("click","div.recordDetails span.squeezedWell",function(e){var currentElement=jQuery(e.currentTarget),relatedLabel=currentElement.data("reference");jQuery(".detailViewInfo .related .nav > li[data-reference=\""+relatedLabel+"\"]").trigger("click");}),detailContentsHolder.on("click",".relatedPopup",function(e){var editViewObj=new Vtiger_Edit_Js;return editViewObj.showRecordsList(e),!1}),detailContentsHolder.on("click",".viewThread",function(e){var currentTarget=jQuery(e.currentTarget),currentTargetParent=currentTarget.parent(),commentActionsBlock=currentTarget.closest(".commentActions"),currentCommentBlock=currentTarget.closest(".js-comment-details"),ulElements=currentCommentBlock.find("ul");if(0<ulElements.length)return ulElements.show(),commentActionsBlock.find(".hideThreadBlock").show(),void currentTargetParent.hide();var commentId=currentTarget.closest(".js-comment-div").find(".js-comment-info-header").data("commentid");thisInstance.getChildComments(commentId).done(function(data){jQuery(data).appendTo(jQuery(e.currentTarget).closest(".js-comment-details")),commentActionsBlock.find(".hideThreadBlock").show(),currentTargetParent.hide();});}),detailContentsHolder.on("click",".js-view-parent-thread",function(e){var currentTarget=jQuery(e.currentTarget),currentTargetParent=currentTarget.parent(),commentId=currentTarget.closest(".js-comment-div").find(".js-comment-info-header").data("commentid");thisInstance.getParentComments(commentId).done(function(data){$(e.currentTarget.closest(".js-comment-details")).html(data),currentTarget.closest(".commentActions").find(".hideThreadBlock").show(),currentTargetParent.hide();});}),detailContentsHolder.on("click",".hideThread",function(e){var currentTarget=jQuery(e.currentTarget),currentTargetParent=currentTarget.parent(),commentActionsBlock=currentTarget.closest(".commentActions"),currentCommentBlock=currentTarget.closest(".js-comment-details");currentCommentBlock.find("ul").hide(),currentTargetParent.hide(),commentActionsBlock.find(".js-view-thread-block").show();}),detailContentsHolder.on("click",".detailViewThread",function(e){var recentCommentsTab=thisInstance.getTabByLabel(thisInstance.detailViewRecentCommentsTabLabel),commentId=jQuery(e.currentTarget).closest(".js-comment-single").find(".js-comment-info-header").data("commentid");recentCommentsTab.trigger("click",{commentid:commentId,callback:function commentLoad(){window.location.href=window.location.href+"#"+commentId;}});}),detailContentsHolder.on("click",".moreRecentRecords",function(e){e.preventDefault();var recentCommentsTab=thisInstance.getTabByModule($(this).data("label-key"));recentCommentsTab.trigger("click");}),detailContentsHolder.on("change",".relatedHistoryTypes",function(e){var widgetContent=jQuery(this).closest(".widgetContentBlock").find(".widgetContent"),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:widgetContent}});AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:1,limit:widgetContent.find(".js-relatedHistoryPageLimit").val(),type:$(e.currentTarget).val()}).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),widgetContent.find("#relatedHistoryCurrentPage").remove(),widgetContent.find("#moreRelatedUpdates").remove(),widgetContent.html(data),Vtiger_Index_Js.registerMailButtons(widgetContent);});}),detailContentsHolder.on("click",".moreProductsService",function(){jQuery(".related .mainNav[data-reference=\"ProductsAndServices\"]:not(.d-none)").trigger("click");}),detailContentsHolder.on("click",".moreRelatedUpdates",function(){var widgetContainer=jQuery(this).closest(".widgetContentBlock"),widgetContent=widgetContainer.find(".widgetContent"),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:widgetContent}}),currentPage=widgetContent.find("#relatedHistoryCurrentPage").val(),nextPage=parseInt(currentPage)+1,types=widgetContainer.find(".relatedHistoryTypes").val(),pageLimit=widgetContent.find("#relatedHistoryPageLimit").val();AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:nextPage,limit:pageLimit,type:types}).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),widgetContent.find("#relatedHistoryCurrentPage").remove(),widgetContent.find("#moreRelatedUpdates").remove(),widgetContent.find("#relatedUpdates").append(data);});}),detailContentsHolder.on("click",".moreRecentUpdates",function(e){var container=$(e.currentTarget).closest(".recentActivitiesContainer"),newChange=container.find("#newChange").val(),nextPage=parseInt(container.find("#updatesCurrentPage").val())+1,url=void 0;if(container.closest(".js-detail-widget").length){var data=thisInstance.getFiltersData(e,{page:nextPage,tab_label:"LBL_UPDATES",newChange:newChange},container.find("#updates"));url=data.params;}else if(url=thisInstance.getTabByLabel(thisInstance.detailViewRecentUpdatesTabLabel).data("url"),url=url.replace("&page=1","&page="+nextPage)+"&skipHeader=true&newChange="+newChange,-1===url.indexOf("&whereCondition")){var switchBtn=jQuery(".active .js-switch--recentActivities");url+="&whereCondition="+("undefined"==typeof switchBtn.data("on-val")?switchBtn.data("off-val"):switchBtn.data("on-val"));}AppConnector.request(url).done(function(data){var dataContainer=jQuery(data);container.find("#newChange").val(dataContainer.find("#newChange").val()),container.find("#updatesCurrentPage").val(dataContainer.find("#updatesCurrentPage").val()),container.find(".js-more-link").html(dataContainer.find(".js-more-link").html()),container.find("#updates ul").append(dataContainer.find("#updates ul").html()),app.registerMoreContent(container.find("button.moreBtn")),app.event.trigger("DetailView.UpdatesWidget.AddMore",data,thisInstance);});}),detailContentsHolder.on("click",".btnChangesReviewedOn",function(e){var progressInstance=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),url="index.php?module=ModTracker&action=ChangesReviewedOn&record="+app.getRecordId();AppConnector.request(url).done(function(){if(progressInstance.progressIndicator({mode:"hide"}),jQuery(e.currentTarget).parent().remove(),thisInstance.getTabByLabel(thisInstance.detailViewRecentUpdatesTabLabel).find(".count.badge").text(""),selectedTabElement.data("labelKey")==thisInstance.detailViewRecentUpdatesTabLabel)thisInstance.reloadTabContent();else if(selectedTabElement.data("linkKey")==thisInstance.detailViewSummaryTabLabel){var updatesWidget=detailContentsHolder.find("[data-type='Updates']");if(0<updatesWidget.length){var params=thisInstance.getFiltersData(updatesWidget);thisInstance.loadWidget(updatesWidget,params.params);}}});}),detailContentsHolder.on("click",".moreRecentDocuments",function(){var recentDocumentsTab=thisInstance.getTabByLabel(thisInstance.detailViewRecentDocumentsTabLabel);recentDocumentsTab.trigger("click");}),detailContentsHolder.on("click",".moreRecentActivities",function(e){var currentTarget=$(e.currentTarget);currentTarget.prop("disabled",!0);var container=currentTarget.closest(".activityWidgetContainer"),page=container.find(".currentPage").val();page++;var url=container.find(".widgetContentBlock").data("url");url=url.replace("&page=1","&page="+page),url+="&totalCount="+container.find(".totaltActivities").val(),AppConnector.request(url).done(function(data){currentTarget.prop("disabled",!1),currentTarget.addClass("d-none");var currentPage=container.find(".currentPage").val();container.find(".currentPage").remove(),container.find(".countActivities").remove(),container.find(".js-detail-widget-content").append(data),container.find(".countActivities").val(parseInt(container.find(".countActivities").val())+currentPage*parseInt(container.find(".pageLimit").val())),thisInstance.reloadWidgetActivitesStats(container);});}),detailContentsHolder.on("click",".widgetFullscreen",function(e){var currentTarget=$(e.currentTarget),widgetContentBlock=currentTarget.closest(".widgetContentBlock"),url=widgetContentBlock.data("url");url=url.replace("&view=Detail&","&view=WidgetFullscreen&");var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});app.showModalWindow(null,"index.php?"+url,function(){progressIndicatorElement.progressIndicator({mode:"hide"});});}),thisInstance.registerEventForRelatedList(),thisInstance.registerBlockAnimationEvent(),thisInstance.registerMailPreviewWidget(detailContentsHolder.find(".widgetContentBlock[data-type=\"EmailList\"]")),thisInstance.registerMailPreviewWidget(detailContentsHolder.find(".widgetContentBlock[data-type=\"HistoryRelation\"]")),detailContentsHolder.find(".js-switch--recentActivities").off().on("change",function(e){var currentTarget=jQuery(e.currentTarget),tabElement=thisInstance.getTabByLabel(thisInstance.detailViewRecentUpdatesTabLabel),variableName=currentTarget.data("urlparams"),valueOn=$(this).data("on-val"),valueOff=$(this).data("off-val"),url=tabElement.data("url");url=url.replace("&"+variableName+"="+valueOn,"").replace("&"+variableName+"="+valueOff,""),"undefined"==typeof currentTarget.data("on-val")?"undefined"!=typeof currentTarget.data("off-val")&&(url+="&"+variableName+"="+valueOff):url+="&"+variableName+"="+valueOn,tabElement.data("url",url),tabElement.trigger("click");});},reloadWidgetActivitesStats:function reloadWidgetActivitesStats(container){var countElement=container.find(".countActivities"),totalElement=container.find(".totaltActivities");if(!countElement.length||!totalElement.length)return !1;var stats=" ("+countElement.val()+"/"+totalElement.val()+")",switchBtn=container.find(".active .js-switch"),switchBtnParent=switchBtn.parent(),text=switchBtn.data("basic-text")+stats;switchBtnParent.removeTextNode(),switchBtnParent.append(text);},refreshCommentContainer:function refreshCommentContainer(commentId){var thisInstance=this,commentContainer=$(".commentsBody"),params={module:app.getModuleName(),view:"Detail",record:thisInstance.getRecordId(),mode:"showThreadComments",commentid:commentId},progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0,elementToBlock:commentContainer}});AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),commentContainer.html(data);});},updateRecordsPDFTemplateBtn:function updateRecordsPDFTemplateBtn(){AppConnector.request({data:{module:app.getModuleName(),action:"PDF",mode:"hasValidTemplate",record:app.getRecordId(),view:app.getViewName()},dataType:"json"}).done(function(data){var btnToolbar=jQuery(".js-btn-toolbar .btn-toolbar:eq(1)"),btn=void 0;if(!1===data.result.valid)btn=btnToolbar.find(".showModal"),btn.length&&btn.remove();else{btn=btnToolbar.find(".showModal"),0===btn.length&&btnToolbar.append("<div class=\"c-btn-link btn-group  c-btn-link--responsive\"><button class=\"btn btn btn-outline-dark btn-sm showModal js-popover-tooltip\" data-js=\"click|popover\" data-placement=\"bottom\" data-content=\""+app.vtranslate("LBL_EXPORT_PDF")+"\" data-target=\"focus hover\" data-url=\"index.php?module="+app.getModuleName()+"&view=PDF&fromview=Detail&record="+app.getRecordId()+"\" data-original-title=\"\" title=\"\"><span class=\"fas fa-file-pdf icon-in-button\"></span></button></div>");}}).fail(function(data,err){app.errorLog(data,err);});},updateWindowHeight:function updateWindowHeight(currentHeight,frame){frame.height(currentHeight);},loadSubProducts:function loadSubProducts(parentRow){var thisInstance=this,recordId=parentRow.data("product-id");AppConnector.request({module:"Products",action:"SubProducts",record:recordId}).done(function(data){var responseData=data.result;thisInstance.addSubProducts(parentRow,responseData);});},addSubProducts:function addSubProducts(parentRow,responseData){var subProductsContainer=$(".js-subproducts-container ul",parentRow);for(var id in responseData){var productText=$("<li>").text(responseData[id]);subProductsContainer.append(productText);}},registerSubProducts:function registerSubProducts(container){var thisInstance=this;container.find(".inventoryItems .js-inventory-row").each(function(){thisInstance.loadSubProducts($(this),!1);});},registerEvents:function registerEvents(){this.registerHelpInfo(),this.registerSendSmsSubmitEvent(),this.registerAjaxEditEvent(),this.registerRelatedRowClickEvent(),this.registerBlockStatusCheckOnLoad(),this.registerEmailFieldClickEvent(),this.registerPhoneFieldClickEvent(),this.registerEventForRelatedTabClick(),Vtiger_Helper_Js.showHorizontalTopScrollBar(),this.registerUrlFieldClickEvent();var detailViewContainer=jQuery("div.detailViewContainer");0>=detailViewContainer.length||(this.registerSetReadRecord(detailViewContainer),this.registerEventForPicklistDependencySetup(this.getForm()),this.getForm().validationEngine(app.validationEngineOptionsForRecord),this.loadWidgetsEvents(),this.loadWidgets(),this.registerBasicEvents(),this.registerEventForTotalRecordsCount(),this.registerProgress());}});
//# sourceMappingURL=Detail.min.js.map
