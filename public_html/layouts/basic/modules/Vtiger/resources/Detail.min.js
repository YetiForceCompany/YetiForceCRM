
jQuery.Class("Vtiger_Detail_Js",{detailInstance:false,getInstance:function(){if(Vtiger_Detail_Js.detailInstance==false){var d=app.getModuleName();var b=app.getViewName();var c=d+"_"+b+"_Js";var e=Vtiger_Detail_Js;if(typeof window[c]!="undefined"){var a=new window[c]()}else{var a=new e()}Vtiger_Detail_Js.detailInstance=a}return Vtiger_Detail_Js.detailInstance},triggerDetailViewAction:function(f,c){var e=Vtiger_Detail_Js.getInstance();var b=[];b.push(e.getRecordId());var a={selected_ids:JSON.stringify(b)};var d={type:"POST",url:f,dataType:"html",data:a};AppConnector.request(d).then(function(g){if(g){app.showModalWindow(g,{"text-align":"left"});if(typeof c=="function"){c(g)}}},function(g,h){})},triggerSendSms:function(b,a){Vtiger_Detail_Js.triggerDetailViewAction(b)},triggerTransferOwnership:function(c){var b=this;b.getRelatedModulesContainer=false;var a={type:"POST",url:c,dataType:"html",data:{}};AppConnector.request(a).then(function(d){if(d){var e=function(f){var g=app.validationEngineOptions;g.onValidationComplete=function(i,h){if(h){if(i.attr("name")=="changeOwner"){b.transferOwnershipSave(i)}}return false};jQuery("#changeOwner").validationEngine(app.validationEngineOptions)};app.showModalWindow(d,function(g){var f=b.getRelatedModuleContainer();app.changeSelectElementView(f,"select2");if(typeof e=="function"){e(g)}})}})},transferOwnershipSave:function(c){var b=this;var f=jQuery("#transferOwnerId").val();var d=jQuery("#related_modules").val();var a=jQuery("#recordId").val();var e={module:app.getModuleName(),action:"TransferOwnership",record:a,transferOwnerId:f,related_modules:d};AppConnector.request(e).then(function(i){if(i.success){app.hideModalWindow();var k={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_RECORDS_TRANSFERRED_SUCCESSFULLY"),animation:"show",type:"info"};var j=jQuery(".assigned_user_id").val();var h=jQuery(".assigned_user_id ");h.find('option[value="'+j+'"]').removeAttr("selected");h.find('option[value="'+f+'"]').attr("selected","selected");h.trigger("liszt:updated");var g=h.find('option[value="'+f+'"]').data("picklistvalue");h.closest(".row-fluid").find(".value").html('<a href="index.php?module=Users&amp;parent=Settings&amp;view=Detail&amp;record='+f+'">'+g+"</a>");Vtiger_Helper_Js.showPnotify(k)}})},getRelatedModuleContainer:function(){if(this.getRelatedModulesContainer==false){this.getRelatedModulesContainer=jQuery("#related_modules")}return this.getRelatedModulesContainer},reloadRelatedList:function(){var a=Vtiger_Detail_Js.getInstance();var b={};if(jQuery('[name="currentPageNum"]').length>0){b.page=jQuery('[name="currentPageNum"]').val()}a.loadRelatedList(b)},showWorkflowTriggerView:function(a){$(a).popover("hide");var b=Vtiger_Detail_Js.getInstance();var c={module:app.getModuleName(),view:"WorkflowTrigger",record:b.getRecordId()};var d=function(e){e.find('[type="submit"]').click(function(h){var g=[];e.find('input[type="checkbox"]:checked').each(function(j){g.push($(this).val())});if(g.length==0){var i={title:app.vtranslate("JS_INFORMATION"),text:app.vtranslate("JS_NOT_SELECTED_WORKFLOW_TRIGGER"),type:"error",animation:"show"};Vtiger_Helper_Js.showPnotify(i)}else{var i={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STARTED_PERFORM_WORKFLOW"),type:"info",animation:"show"};Vtiger_Helper_Js.showPnotify(i);var f={module:app.getModuleName(),action:"Workflow",mode:"execute",user:e.find('[name="user"]').val(),record:b.getRecordId(),ids:g};AppConnector.request(f).then(function(j){var k={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_COMPLETED_PERFORM_WORKFLOW"),type:"success",animation:"show"};Vtiger_Helper_Js.showPnotify(k);app.hideModalWindow();b.loadWidgets()},function(j,k){var l={title:app.vtranslate("JS_ERROR"),text:app.vtranslate("JS_ERROR_DURING_TRIGGER_OF_WORKFLOW"),type:"error",animation:"show"};Vtiger_Helper_Js.showPnotify(l);app.hideModalWindow()})}})};AppConnector.request(c).then(function(e){if(e){app.showModalWindow(e,"",d)}},function(e,f){})}},{targetPicklistChange:false,targetPicklist:false,detailViewContentHolder:false,detailViewForm:false,detailViewDetailsTabLabel:"LBL_RECORD_DETAILS",detailViewSummaryTabLabel:"LBL_RECORD_SUMMARY",detailViewRecentCommentsTabLabel:"ModComments",detailViewRecentActivitiesTabLabel:"Activities",detailViewRecentUpdatesTabLabel:"LBL_UPDATES",detailViewRecentDocumentsTabLabel:"Documents",fieldUpdatedEvent:"Vtiger.Field.Updated",updatedFields:["company","designation","title"],fieldPreSave:"Vtiger.Field.PreSave",tempData:[],referenceFieldNames:{Calendar:{Accounts:"link",Leads:"link",Vendors:"link",OSSEmployees:"link",Contacts:"linkextend",Campaigns:"process",HelpDesk:"process",Projects:"process",ServiceContracts:"process",},OutsourcedProducts:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},Assets:{Accounts:"parent_id",Contacts:"parent_id"},OSSOutsourcedServices:{Leads:"parent_id",Accounts:"parent_id",Contacts:"parent_id"},OSSSoldServices:{Accounts:"parent_id",Contacts:"parent_id"},},init:function(){},loadWidgets:function(){var a=this;var b=jQuery('[class^="widgetContainer_"]');b.each(function(c,e){var d=jQuery(e);a.loadWidget(d)});a.registerRelatedModulesRecordCount()},loadWidget:function(a,d){var l=this;var g=jQuery(".widget_contents",a);if(a.find('[name="relatedModule"]').length){var h=a.find('[name="relatedModule"]').val()}else{var h=a.data("name")}if(d==undefined){var b=a.data("url");if(b==undefined){return}var c=b.split("&");var i={};for(var f=0;f<c.length;f++){var k=c[f];var j=k.split("=");i[j[0]]=j[1]}var d={type:"POST",dataType:"html",data:i}}var e=jQuery.Deferred();g.progressIndicator({});AppConnector.request(d).then(function(n){g.progressIndicator({mode:"hide"});g.html(n);app.showPopoverElementView(g.find(".popoverTooltip"));app.registerModal(g);app.registerMoreContent(g.find("button.moreBtn"));if(h){var m=Vtiger_RelatedList_Js.getInstance(l.getRecordId(),app.getModuleName(),l.getSelectedTab(),h);m.setRelatedContainer(g);m.registerRelatedEvents();l.widgetRelatedRecordView(a,true)}app.event.trigger("DetailView.Widget.AfterLoad",g,h,l);e.resolve(d)},function(m){g.progressIndicator({mode:"hide"});e.reject()});return e.promise()},widgetRelatedRecordView:function(a,i){var g=this.getRecordId()+"_"+a.data("id");var h=app.moduleCacheGet(g);if(h!==null){var d=a.find(".item[data-id = '"+h+"']");if(d.length){a.find(".item.active").removeClass("active");a.find(".item[data-id = '"+h+"']").addClass("active")}}var f=a.find(".control-widget");var c=f.find(".prev");var e=f.find(".next");var b=a.find(".item.active");if(a.find(".item").length<=1||!b.next().length){e.addClass("disabled")}else{e.removeClass("disabled")}if(a.find(".item").length<=1||!b.prev().length){c.addClass("disabled")}else{c.removeClass("disabled")}if(i){e.click(function(){if($(this).hasClass("disabled")){return}var k=a.find(".item.active");k.removeClass("active");var j=k.next();j.addClass("active");if(!j.next().length){e.addClass("disabled")}if(k.prev()){c.removeClass("disabled")}app.moduleCacheSet(g,j.data("id"))});c.click(function(){if($(this).hasClass("disabled")){return}var k=a.find(".item.active");k.removeClass("active");var j=k.prev();j.addClass("active");if(!j.prev().length){c.addClass("disabled")}if(k.next()){e.removeClass("disabled")}app.moduleCacheSet(g,j.data("id"))})}},loadCommentsWidget:function(){},loadContents:function(b,e){var d=this;var a=jQuery.Deferred();var c=this.getContentHolder();var f=b;if(typeof e!="undefined"){f={};f.url=b;f.data=e}AppConnector.requestPjax(f).then(function(g){c.html(g);g=c.html();d.registerBlockStatusCheckOnLoad();app.changeSelectElementView(c);app.registerEventForDatePickerFields(c);d.getForm().validationEngine();app.event.trigger("DetailView.LoadContents.AfterLoad",g);a.resolve(g)});return a.promise()},getUpdatefFieldsArray:function(){return this.updatedFields},getTabByLabel:function(a){var c=this.getTabs();var b=false;c.each(function(e,f){var g=jQuery(f);var d=g.data("labelKey");if(d==a){b=g;return false}});return b},getTabByModule:function(b){var c=this.getTabs();var a=false;c.each(function(d,e){var f=jQuery(e);if(f.data("reference")==b){a=f;return false}});return a},selectModuleTab:function(){var a=this.getTabContainer();var b=a.find("li.module-tab");this.deSelectAllrelatedTabs();this.markTabAsSelected(b)},deSelectAllrelatedTabs:function(){var a=this.getTabContainer();this.getTabs().removeClass("active")},markTabAsSelected:function(a){a.addClass("active");jQuery('.related .dropdown [data-reference="'+a.data("reference")+'"]').addClass("active")},reloadTabContent:function(){this.getSelectedTab().trigger("click")},getSelectedTab:function(){var a=this.getTabContainer();return a.find(".nav li.active:not(.hide)")},getTabContainer:function(){return jQuery("div.related")},getTabs:function(){var a=this.getTabContainer().find("li.baseLink:not(.hide)");var b=this.getTabContainer().find("li:not(.baseLink)");b.each(function(h,g){var f=jQuery(this);var d=f.data("iteration");var c=f.hasClass("mainNav")?"mainNav":"relatedNav";if(d!=undefined&&a.filter("."+c+'[data-iteration="'+d+'"]').length<1){a.push(f.get(0))}});return a},getContentHolder:function(){if(this.detailViewContentHolder==false){this.detailViewContentHolder=jQuery("div.details div.contents")}return this.detailViewContentHolder},getForm:function(){if(this.detailViewForm==false){this.detailViewForm=jQuery("#detailView")}return this.detailViewForm},getRecordId:function(){return app.getRecordId()},getRelatedModuleName:function(){if(jQuery(".relatedModuleName",this.getContentHolder()).length==1){return jQuery(".relatedModuleName",this.getContentHolder()).val()}},saveFieldValues:function(b){var a=jQuery.Deferred();var c=this.getRecordId();var d={};if(typeof b!="undefined"){d=b}d.record=c;d.module=app.getModuleName();d.action="SaveAjax";var e={};e.data=d;e.async=false;e.dataType="json";AppConnector.request(e).then(function(f){a.resolve(f)});return a.promise()},getRelatedListCurrentPageNum:function(){return jQuery('input[name="currentPageNum"]',this.getContentHolder()).val()},removeCommentBlockIfExists:function(){var a=this.getContentHolder();var b=jQuery(".commentsBody",a);jQuery(".addCommentBlock",b).remove()},getCommentThread:function(b){var a=jQuery.Deferred();AppConnector.request(b).then(function(c){a.resolve(c)},function(c,d){});return a.promise()},saveCommentAjax:function(d,e,i,j,f,b,g){var l=this;var c=jQuery.progressIndicator({});var k=d.closest(".singleComment");var h=k.find(".related_to").val();if(!h){h=l.getRecordId()}var a={commentcontent:i,related_to:h,module:"ModComments"};if(e=="edit"){a.record=f;a.reasontoedit=j;a.parent_comments=b;a.mode="edit";a.action="Save"}else{if(e=="add"){a.parent_comments=f;a.action="SaveAjax"}}AppConnector.request(a).then(function(m){c.progressIndicator({mode:"hide"});if(e=="add"){l.addRelationBetweenRecords("ModComments",m.result.id,l.getTabByLabel(l.detailViewRecentCommentsTabLabel))}app.event.trigger("DetailView.SaveComment.AfterAjax",k,a,m);g.resolve(m)},function(n,m){c.progressIndicator({mode:"hide"});d.removeAttr("disabled");g.reject(n,m)})},saveComment:function(i){var n=this;var h=jQuery.Deferred();var a=jQuery(i.currentTarget);var d=a.data("mode");var m=a.closest(".addCommentBlock");var o=m.find(".commentcontent");var j=o.val();var g;if(j==""){g=app.vtranslate("JS_LBL_COMMENT_VALUE_CANT_BE_EMPTY");o.validationEngine("showPrompt",g,"error","bottomLeft",true);h.reject(g);return h.promise()}if(d=="edit"){var l=m.find('[name="reasonToEdit"]').val()}var c=jQuery(i.currentTarget);var k=m.closest(".commentDetails").find(".commentInfoHeader");var f=k.data("commentid");var b=k.data("parentcommentid");n.saveCommentAjax(c,d,j,l,f,b,h);return h.promise()},getCommentUI:function(c){var b=jQuery.Deferred();var a={view:"DetailAjax",module:"ModComments",record:c};AppConnector.request(a).then(function(d){b.resolve(d)},function(d,e){});return b.promise()},getCommentBlock:function(){var b=this.getContentHolder();var a=jQuery(".basicAddCommentBlock",b).clone(true,true).removeClass("basicAddCommentBlock hide").addClass("addCommentBlock");a.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent");return a},getEditCommentBlock:function(){var b=this.getContentHolder();var a=jQuery(".basicEditCommentBlock",b).clone(true,true).removeClass("basicEditCommentBlock hide").addClass("addCommentBlock");a.find(".commentcontenthidden").removeClass("commentcontenthidden").addClass("commentcontent");return a},registerSendSmsSubmitEvent:function(){var a=this;jQuery("body").on("submit","#massSave",function(f){var d=jQuery(f.currentTarget);var b=d.find("#message").val().length;if(b>160){var g={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("LBL_SMS_MAX_CHARACTERS_ALLOWED"),animation:"show",type:"error"};Vtiger_Helper_Js.showPnotify(g);return false}var c=d.find(":submit");c.attr("disabled","disabled");a.SendSmsSave(d);f.preventDefault()})},SendSmsSave:function(b){var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var a=b.serializeFormData();AppConnector.request(a).then(function(d){app.hideModalWindow();c.progressIndicator({mode:"hide"})},function(d,e){})},registerNameAjaxEditEvent:function(){var b=this;var a=b.getContentHolder();a.on(b.fieldUpdatedEvent,".nameField",function(i,j){var h=b.getForm();var f=h.data("nameFields");var d="";for(var g in f){if(g!=0){d+=" "}var k=f[g];d+=h.find('[name="'+k+'"]').val()}var c=a.closest(".contentsDiv").find(".recordLabel");c.text(d)})},updateHeaderNameFields:function(){var k=this;var a=k.getContentHolder();var c=k.getForm();var b=c.data("nameFields");var l=a.closest(".contentsDiv").find(".recordLabel");var i="";for(var g in b){var f=b[g];var j=c.find('[name="'+f+'"]');if(j.length>0){var h=j.val();i+=h+" ";l.find('[class="'+f+'"]').text(h)}}var d=l.find(".salutation");if(d.length>0){var e=d.text();i=e+i}l.attr("title",i)},registerAjaxEditEvent:function(){var b=this;var a=b.getContentHolder();a.on(b.fieldUpdatedEvent,"input,select,textarea",function(c){b.updateHeaderValues(jQuery(c.currentTarget))})},updateHeaderValues:function(d){var f=this;if(d.hasClass("nameField")){f.updateHeaderNameFields();return true}var c=d.attr("name");var g=this.getUpdatefFieldsArray();var e=f.getContentHolder();if(jQuery.inArray(c,g)!="-1"){var b=d.val();var a=e.closest(".contentsDiv").find("."+c+"_label");a.text(b)}},registerEmailFieldClickEvent:function(){var a=this.getContentHolder();a.on("click",".emailField",function(b){b.stopPropagation()})},registerPhoneFieldClickEvent:function(){var a=this.getContentHolder();a.on("click",".phoneField",function(b){b.stopPropagation()})},registerUrlFieldClickEvent:function(){var a=this.getContentHolder();a.on("click",".urlField",function(b){b.stopPropagation()})},registerRelatedRowClickEvent:function(){var a=this.getContentHolder();a.on("click",".listViewEntries",function(d){var b=jQuery(d.target,jQuery(d.currentTarget));if(b.is("td:first-child")&&(b.children('input[type="checkbox"]').length>0)){return}if(jQuery(d.target).is('input[type="checkbox"]')){return}var c=jQuery(d.currentTarget);var f=c.data("recordurl");if(typeof f!="undefined"){window.location.href=f}})},loadRelatedList:function(c){var a=jQuery.Deferred();if(c==undefined){c={}}var b=Vtiger_RelatedList_Js.getInstance(this.getRecordId(),app.getModuleName(),this.getSelectedTab(),this.getRelatedModuleName());b.loadRelatedList(c).then(function(d){a.resolve(d)},function(e,d){a.reject(e,d)});return a.promise()},registerEventForRelatedList:function(){var b=this;var a=this.getContentHolder();var d=b.getRelatedModuleName();if(d){var c=Vtiger_RelatedList_Js.getInstance(b.getRecordId(),app.getModuleName(),b.getSelectedTab(),d);c.setRelatedContainer(a);c.registerRelatedEvents()}a.find(".detailViewBlockLink").each(function(g,f){f=$(f);var e=f.find(".blockContent");if(e.is(":visible")){AppConnector.request({type:"GET",dataType:"html",data:f.data("url")}).then(function(h){e.html(h);var i=Vtiger_RelatedList_Js.getInstance(b.getRecordId(),app.getModuleName(),b.getSelectedTab(),f.data("reference"));i.setRelatedContainer(e);i.registerRelatedEvents()})}});a.find(".detailViewBlockLink .blockHeader").click(function(){var g=$(this).closest(".panel");var e=g.find(".blockContent");var f=e.is(":empty");if(!e.is(":visible")){e.progressIndicator();AppConnector.request({type:"GET",dataType:"html",data:g.data("url")}).then(function(h){e.html(h);var i=Vtiger_RelatedList_Js.getInstance(b.getRecordId(),app.getModuleName(),b.getSelectedTab(),g.data("reference"));i.setRelatedContainer(e);if(f){i.registerRelatedEvents()}else{i.registerPostLoadEvents()}})}})},registerBlockAnimationEvent:function(){var b=this;var a=this.getContentHolder();a.find(".blockHeader").click(function(){var f=$(this).find(".blockToggle").not(".hide");var c=f.data("id");var h=f.closest(".panel");var g=h.find(".blockContent");var e=f.data();var d=app.getModuleName();if(e.mode==="show"){g.addClass("hide");app.cacheSet(d+"."+c,0);f.addClass("hide");h.find('[data-mode="hide"]').removeClass("hide")}else{g.removeClass("hide");app.cacheSet(d+"."+c,1);f.addClass("hide");h.find('[data-mode="show"]').removeClass("hide")}app.event.trigger("DetailView.BlockToggle.PostLoad",g,e,b)})},registerBlockStatusCheckOnLoad:function(){var b=this.getContentHolder().find(".blockHeader");var a=app.getModuleName();b.each(function(d,j){var g=jQuery(j);var f=g.find(".blockToggle").not(".hide");var i=g.closest(".panel").find(".blockContent");var c=f.data("id");var h=a+"."+c;var e=app.cacheGet(h,null);if(e!=null){if(e==1){f.addClass("hide");g.find("[data-mode='show']").removeClass("hide");i.removeClass("hide")}else{f.addClass("hide");g.find("[data-mode='hide']").removeClass("hide");i.addClass("hide")}}})},ajaxEditHandling:function(e){var d=this;var b=jQuery(".setReadRecord");b.prop("disabled",true);var c=jQuery(".value",e);var g=jQuery(".edit",e);var f=jQuery(".summaryViewEdit",e);var a=jQuery(".fieldname",g);jQuery(a).each(function(j,l){var o=jQuery(l).val();var i=jQuery(l);var h=jQuery.inArray(i.data("type"),["taxes","sharedOwner","multipicklist"])!=-1?o+"[]":o;var m=jQuery('[name="'+h+'"]',g);if(m.attr("disabled")=="disabled"){return}if(g.length<=0){return}if(g.is(":visible")){return}m.inputmask();var n=false;if(m.inputmask("hasMaskedValue")){n=true}c.addClass("hide");f.addClass("hide");g.removeClass("hide").children().filter('input[type!="hidden"]input[type!="image"],select').filter(":first").focus();var k=function(w){var v=jQuery(w.target);if((v.closest(".fieldValue").is(e))){return}e.removeAttr("tabindex");var t=i.data("prevValue");var z=d.getForm();var s=z.serializeFormData();var A=s[o]?s[o]:s[h];var r=A;var q=Vtiger_Field_Js.getInstance(m.data("fieldinfo"));var u=[];var C=false;if(g.find("[data-fieldinfo]").length==2){g.find("[data-fieldinfo]").each(function(){var D=[];D.name=jQuery(this).attr("name");D.type=jQuery(this).data("fieldinfo").type;if(D.type=="datetime"){C=true}u.push(D)})}if(m.is("input:checkbox")){if(m.is(":checked")){A="1"}else{A="0"}m=m.filter('[type="checkbox"]')}var x=m.validationEngine("validate");if(x){if(n){m.inputmask()}return}function y(D){return D===undefined||D===null?"":(D+"")}m.validationEngine("hide");if(y(t)===y(A)){g.addClass("hide");c.removeClass("hide");f.removeClass("hide");b.prop("disabled",false);g.off("clickoutside")}else{var p=jQuery.Event(d.fieldPreSave);m.trigger(p,{fieldValue:r,recordId:d.getRecordId()});if(p.isDefaultPrevented()){b.prop("disabled",false);return}e.progressIndicator();g.addClass("hide");var B={};B.value=r;B.field=o;B=d.getCustomFieldNameValueMap(B);d.saveFieldValues(B).then(function(D){b.prop("disabled",false);var H=D.result;e.progressIndicator({mode:"hide"});c.removeClass("hide");f.removeClass("hide");var G=H[o].display_value;if(u.length&&C){G=H[u[0].name].display_value+" "+H[u[1].name].display_value}c.html(G);if(H.isEditable==false){var I=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});window.location.reload()}m.trigger(d.fieldUpdatedEvent,{old:t,"new":r});i.data("prevValue",A);m.data("selectedValue",A);if(d.targetPicklistChange){if(jQuery(".summaryView",d.getForm()).length>0){d.targetPicklist.find(".summaryViewEdit").trigger("click")}else{d.targetPicklist.trigger("click")}d.targetPicklistChange=false;d.targetPicklist=false}var F=d.getSelectedTab();if(F.data("linkKey")==d.detailViewSummaryTabLabel){var E=d.getContentHolder();d.reloadTabContent();d.registerSummaryViewContainerEvents(E);d.registerEventForPicklistDependencySetup(d.getForm());d.registerEventForRelatedList()}else{if(F.data("linkKey")==d.detailViewDetailsTabLabel){d.registerEventForPicklistDependencySetup(d.getForm())}}d.updateRecordsPDFTemplateBtn(d.getForm())},function(D){g.addClass("hide");c.removeClass("hide");f.removeClass("hide");g.off("clickoutside");b.prop("disabled",false);e.progressIndicator({mode:"hide"})})}};g.on("clickoutside",k)})},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery("#detailView").find("td");b.addClass(a)}},addElementsToQuickCreateForCreatingRelation:function(a,b){jQuery('<input type="hidden" name="relationOperation" value="true" >').appendTo(a);jQuery.each(b,function(c,d){jQuery('<input type="hidden" name="'+c+'" value="'+d+'" >').appendTo(a)})},registerEventForActivityWidget:function(){var a=this;jQuery(".createActivity").on("click",function(j){var b="Calendar";var f=a.getRecordId();var c=app.getModuleName();var h=jQuery(j.currentTarget);var d={};d.sourceModule=c;d.sourceRecord=f;if(c!=""&&b!=""&&typeof a.referenceFieldNames[b]!="undefined"&&typeof a.referenceFieldNames[b][c]!="undefined"){var l=a.referenceFieldNames[b][c];d[l]=f}var k=h.data("url");var m=function(q){a.addElementsToQuickCreateForCreatingRelation(q,d);var o=q.find('[class^="CalendarQuikcCreateContents"]').find("#goToFullForm");var p=q.find('[class^="EventsQuikcCreateContents"]').find("#goToFullForm");var e=o.data("edit-view-url")+"&"+k;var n=p.data("edit-view-url")+"&"+k;o.data("editViewUrl",e);p.data("editViewUrl",n)};var i=function(){var o=h.closest(".summaryWidgetContainer");var e=o.find(".widgetContentBlock");var n=e.data("url");var p={type:"GET",dataType:"html",data:n};AppConnector.request(p).then(function(r){var q=o.find(".widget_contents");q.html(r);app.changeSelectElementView(q);a.registerEventForActivityWidget()});a.loadWidgets()};var g={};g.callbackPostShown=m;g.callbackFunction=i;g.data=d;g.noCache=false;Vtiger_Header_Js.getInstance().quickCreateModule(b,g)})},getEndDate:function(a){var d=a.split("-");var c=new Date(d[0],d[1],d[2]);var b=new Date();b.setDate(c.getDate()+2);return app.getStringDate(b)},getSingleEventType:function(e,b,g){var f=jQuery('[name="date_start"]');var c=jQuery(f).val();var h=jQuery(f).data("date-format");var j=Vtiger_Helper_Js.convertToDateString(c,h,e,g);var a=jQuery.extend({},["#b6a996,black"]);var i=this;var d={module:"Calendar",action:"Feed",start:j,end:this.getEndDate(j),type:g,mapping:a};AppConnector.request(d).then(function(m){var k=Vtiger_Helper_Js.convertToDateString(c,h,e);if(!jQuery.isEmptyObject(m)){if(m[0]["activitytype"]==="Task"){for(var n in m){if(m[n]["start"].indexOf(k)>-1){jQuery("#"+b+" .table").append('<tr><td><a target="_blank" href="'+m[n]["url"]+'">'+m[n]["title"]+"</a></td></tr>")}}}else{for(var l=0;l<m[0].length;l++){if(m[0][l]["start"].indexOf(k)>-1){jQuery("#"+b+" .table").append('<tr><td><a target="_blank" href="'+m[0][l]["url"]+'">'+m[0][l]["title"]+"</a></td></tr>")}}}}})},registerFilterForAddingModuleRelatedRecordFromSummaryWidget:function(){var a=this;jQuery(".createRecordFromFilter").on("click",function(o){var m=jQuery(o.currentTarget);var n=m.closest(".summaryWidgetContainer");var g=n.find(".widget_contents");var h=g.find('[name="relatedModule"]').val();var q=m.data("url");var k=a.getRecordId();var i={};var f=m.data("prf");var l=m.data("acf");var c=m.closest(".widget_header").find('[name="relatedModule"]').val();var j={};var d=function(e){a.postSummaryWidgetAddRecord(e,m);if(h=="ProjectTask"){a.loadModuleSummary()}};if(typeof f!="undefined"){j[f]=k}if(typeof l!="undefined"){$.each(l,function(e,r){j[e]=r})}if(Object.keys(j).length>0){i.data=j}i.noCache=true;i.callbackFunction=d;var b=jQuery.progressIndicator();var p=new Vtiger_Header_Js();p.getQuickCreateForm(q,c,i).then(function(e){p.handleQuickCreateData(e,i);b.progressIndicator({mode:"hide"})})});jQuery("button.selectRelation").on("click",function(g){var c=jQuery(g.currentTarget);var b=c.closest(".summaryWidgetContainer");var d=b.find('.widget_contents [name="relatedModule"]').val();var f=Vtiger_Popup_Js.getInstance();f.show({module:d,src_module:app.getModuleName(),src_record:a.getRecordId(),multi_select:true},function(h){var e=JSON.parse(h);a.addRelationBetweenRecords(d,Object.keys(e)).then(function(i){a.loadWidget(b.find(".widgetContentBlock"))})})})},registerEmailEvent:function(){var a=this;this.getContentHolder().find(".resetRelationsEmail").on("click",function(c){var b=jQuery(c.currentTarget);Vtiger_Helper_Js.showConfirmationBox({message:app.vtranslate("JS_EMAIL_RESET_RELATIONS_CONFIRMATION")}).then(function(d){AppConnector.request({module:"OSSMailView",action:"Relation",moduleName:app.getModuleName(),record:app.getRecordId()}).then(function(e){Vtiger_Helper_Js.showMessage({text:e.result})})})})},getFiltersDataAndLoad:function(b,c){var a=this.getFiltersData(b,c);this.loadWidget(a.container,a.params)},getFiltersData:function(i,c){if(i.currentTarget){var g=jQuery(i.currentTarget)}else{g=i}var h=g.closest(".summaryWidgetContainer");var f=h.find(".widgetContentBlock");var a="&"+f.data("url");var b={};var d=a.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,k,l){b[k]=l});var j=[];h.find(".widget_header .filterField").each(function(r,o){var q="";var k=jQuery(o);var e=k.data("urlparams");if(k.attr("type")=="checkbox"){if(k.prop("checked")){q=k.data("on-val")}else{q=k.data("off-val")}}else{if(k.attr("type")=="radio"){if(k.is(":checked")){j[k.attr("name")]=k.val()}}else{var m=k.find("option:selected").val();var p=k.data("fieldlable");var l=k.data("filter");q={};if(m!=p){q[l]=m}else{return}}}if(e){if(e in j){j[e].push(q)}else{j[e]=[q]}}});if(c!=undefined){$.extend(j,c)}return{container:$(f),params:$.extend(b,j)}},registerChangeFilterForWidget:function(){var a=this;jQuery(".widget_header .filterField").on("change",function(c,b){a.getFiltersDataAndLoad(c)}).on("switchChange.bootstrapSwitch",function(c,b){a.getFiltersDataAndLoad(c)})},registerChangeSwitchForWidget:function(b){var a=this;b.find(".activityWidgetContainer").on("switchChange.bootstrapSwitch",".switchBtn",function(i,h){var f=jQuery(i.currentTarget);var c=f.closest(".summaryWidgetContainer");var g=c.find(".widgetContentBlock");var d=g.data("url");d=d.replace("&type=current","").replace("&type=history","");d+="&type=";if(h){c.find(".ativitiesPagination").removeClass("hide");d+="current";d=d.replace("&sortorder=DESC","&sortorder=ASC")}else{c.find(".ativitiesPagination").addClass("hide");d+="history";d=d.replace("&sortorder=ASC","&sortorder=DESC")}g.data("url",d);a.loadWidget($(g))});$(".calculationsWidgetContainer .calculationsSwitch").on("switchChange.bootstrapSwitch",function(i,h){var f=jQuery(i.currentTarget);var c=f.closest(".summaryWidgetContainer");var g=c.find(".widgetContentBlock");var d=g.data("url");d=d.replace("&showtype=open","");d=d.replace("&showtype=archive","");d+="&showtype=";if(h){d+="open"}else{d+="archive"}g.data("url",d);a.loadWidget($(g))})},registerSummaryViewContainerEvents:function(c){var b=this;this.registerEventForActivityWidget();this.registerChangeFilterForWidget();this.registerChangeSwitchForWidget(c);this.registerFilterForAddingModuleRelatedRecordFromSummaryWidget();this.registerEmailEvent();var a=b.getForm();c.off("click").on("click",".row .summaryViewEdit",function(g){var f=jQuery(g.currentTarget);f.addClass("hide");var d=f.closest(".fieldValue");b.ajaxEditHandling(d)});c.on(b.fieldUpdatedEvent,".recordDetails",function(f,g){var d=c.find("[data-type='Updates']");if(d.length){var g=b.getFiltersData(d);d.find(".btnChangesReviewedOn").parent().remove();b.loadWidget(d,g.params)}});c.on("click",".editDefaultStatus",function(g){var f=jQuery(g.currentTarget);f.popover("hide");var d=f.data("url");if(d&&typeof d!="undefined"){app.showModalWindow(null,d)}});c.on("click",".editDescription",function(j){var l=this;var f=jQuery(j.currentTarget);var n=f.closest(".activityDescription");var h=n.find(".edit");var g=n.find(".value");f.hide();g.addClass("hide");h.removeClass("hide").show();var k=jQuery(".fieldname",h);var m=k.val();var d=jQuery('[name="'+m+'"]',h);var i=function(){var o=k.data("prevValue");var q=d.val();var t=d.val();var s=n.closest(".activityEntries");var p=s.find(".activityId").val();var r=s.find(".activityModule").val();var e=s.find(".activityType").val();if(o==q){h.addClass("hide");g.removeClass("hide");f.show()}else{var u=d.validationEngine("validate");if(u){Vtiger_Helper_Js.addClickOutSideEvent(n,i);return}n.progressIndicator();h.addClass("hide");AppConnector.request({action:"SaveAjax",record:p,field:m,value:q,module:r,activitytype:e}).then(function(v){n.progressIndicator({mode:"hide"});g.removeClass("hide");f.show();g.html(t);k.data("prevValue",q)})}};d.focus();n.one("focusout",i)});jQuery(".changeDetailViewMode").on("click",function(d){b.getTabs().filter('[data-link-key="'+b.detailViewDetailsTabLabel+'"]:not(.hide)').trigger("click")});jQuery(".createRecord").on("click",function(o){var m=jQuery(o.currentTarget);var n=m.closest(".summaryWidgetContainer");var k=n.find(".widget_header");var f=k.find('[name="relatedModule"]').val();var j=b.getRecordId();var g=app.getModuleName();var i={};i.sourceModule=g;i.sourceRecord=j;if(g!=""&&f!=""&&typeof b.referenceFieldNames[f]!="undefined"&&typeof b.referenceFieldNames[f][g]!="undefined"){var p=b.referenceFieldNames[f][g];i[p]=j}var d=function(e){b.postSummaryWidgetAddRecord(e,m)};var h=function(e){b.addElementsToQuickCreateForCreatingRelation(e,i)};var l={};l.callbackFunction=d;l.goToFullFormcallback=h;l.data=i;l.noCache=false;Vtiger_Header_Js.getInstance().quickCreateModule(f,l)});this.registerFastEditingFiels()},addRelationBetweenRecords:function(e,a,c){var b=jQuery.Deferred();var d=this;if(c==undefined){var c=d.getSelectedTab()}var f=Vtiger_RelatedList_Js.getInstance(d.getRecordId(),app.getModuleName(),c,e);f.addRelations(a).then(function(h){var j=d.getContentHolder();var g=j.find("[data-type='Updates']");if(g.length>0){var i=d.getFiltersData(g);g.find(".btnChangesReviewedOn").parent().remove();d.loadWidget(g,i.params)}b.resolve(h)},function(h,g){b.reject(h,g)});return b.promise()},postSummaryWidgetAddRecord:function(g,b){var f=this;var a=b.closest(".summaryWidgetContainer");var c=a.find(".widget_header");var e=c.find('[name="relatedModule"]').val();var d=[];d.push(g.result._recordId);this.addRelationBetweenRecords(e,d).then(function(h){f.loadWidget(a.find(".widgetContentBlock"))})},registerChangeEventForModulesList:function(){jQuery("#tagSearchModulesList").on("change",function(c){var a=jQuery(c.currentTarget);if(a.val()=="all"){jQuery('[name="tagSearchModuleResults"]').removeClass("hide")}else{jQuery('[name="tagSearchModuleResults"]').removeClass("hide");var b=a.val();jQuery('[name="tagSearchModuleResults"]').filter(":not(#"+b+")").addClass("hide")}})},registerEventForRelatedTabClick:function(){var c=this;var b=c.getContentHolder();var a=b.closest("div.detailViewInfo");jQuery(".related",a).on("click","li",function(j,i){var g=jQuery(j.currentTarget);if(!g.hasClass("dropdown")){var f=jQuery("<div></div>");f.progressIndicator({position:"html",blockInfo:{enabled:true,elementToBlock:a}});var d=g.data("url");if(typeof i!="undefined"){var h=i.callback;delete i.callback}c.loadContents(d,i).then(function(e){c.deSelectAllrelatedTabs();c.markTabAsSelected(g);app.showBtnSwitch(b.find(".switchBtn"));Vtiger_Helper_Js.showHorizontalTopScrollBar();f.progressIndicator({mode:"hide"});c.registerHelpInfo();app.registerModal(b);app.registerMoreContent(b.find("button.moreBtn"));if(typeof h=="function"){h(e)}if(g.data("linkKey")==c.detailViewSummaryTabLabel){c.loadWidgets()}c.registerBasicEvents();app.notifyPostAjaxReady();app.event.trigger("DetailView.Tab.AfterLoad",e,c)},function(){f.progressIndicator({mode:"hide"})})}})},registerEventForPicklistDependencySetup:function(a){var e=this;var c=jQuery('[name="picklistDependency"]',a);if(c.length<=0){return}var d=JSON.parse(c.val());var f=Object.keys(d);if(f.length<=0){return}var h=[];for(var b=0;b<f.length;b++){h.push('[name="'+f[b]+'"]')}h=h.join(",");var g=a.find(h);g.on("change",function(o){var m=jQuery(o.currentTarget);var l=m.attr("name");var k=d[l];var n=m.val();var j=k[n];var i=k.__DEFAULT__;if(typeof j=="undefined"){j=i}jQuery.each(i,function(w,y){var q=j[w];if(typeof q=="undefined"){q=y}var x=jQuery('[name="'+w+'"]',a);if(x.length<=0){return}var v=x.data("selectedValue");if(jQuery.inArray(v,q)==-1){e.targetPicklistChange=true;e.targetPicklist=x.closest("td")}else{e.targetPicklistChange=false;e.targetPicklist=false}var p=x.data("availableOptions");if(typeof p=="undefined"){p=jQuery("option",x);x.data("available-options",p)}var t=new jQuery();var r=[];r.push("");for(var u=0;u<q.length;u++){r.push(q[u])}jQuery.each(p,function(z,B){var A=jQuery(B).val();if(jQuery.inArray(A,r)!=-1){t=t.add(jQuery(B))}});var s="";s=t.filter("[selected]").val();if(q.length==1){s=q[0]}x.html(t).val(s).trigger("chosen:updated")})});g.trigger("change")},getChildComments:function(d){var b=jQuery.Deferred();var c="module="+app.getModuleName()+"&view=Detail&record="+this.getRecordId()+"&mode=showChildComments&commentid="+d;var a=this.getCommentThread(c);a.then(function(e){b.resolve(e)});return b.promise()},registerEventForTotalRecordsCount:function(){var b=this;var a=this.getContentHolder();a.on("click",".totalNumberOfRecords",function(g){var d=jQuery(g.currentTarget);var i=jQuery("#totalCount").val();d.addClass("hide");d.parent().progressIndicator({});if(i==""){var c=b.getSelectedTab();var h=b.getRelatedModuleName();var f=Vtiger_RelatedList_Js.getInstance(b.getRecordId(),app.getModuleName(),c,h);f.getRelatedPageCount().then(function(){b.showPagingInfo()})}else{b.showPagingInfo()}d.parent().progressIndicator({mode:"hide"})})},showPagingInfo:function(){var c=jQuery("#totalCount").val();var e=jQuery(".pageNumbersText");var d=e.text();var b=d+" ("+c+")";var a=parseInt(jQuery("#noOfEntries").val());if(a!=0){jQuery(".pageNumbersText").html(b)}else{jQuery(".pageNumbersText").html("")}},getCustomFieldNameValueMap:function(a){return a},registerSetReadRecord:function(a){var b=this;a.on("click",".setReadRecord",function(d){var c=jQuery(d.currentTarget);c.closest(".btn-group").addClass("hide");jQuery("#Accounts_detailView_fieldValue_was_read").find(".value").text(app.vtranslate("LBL_YES"));var f={module:app.getModuleName(),action:"SaveAjax",record:b.getRecordId(),field:"was_read",value:"on",};AppConnector.request(f).then(function(g){var h={text:app.vtranslate("JS_SET_READ_RECORD"),title:app.vtranslate("System"),type:"info",animation:"show"};Vtiger_Helper_Js.showPnotify(h);var e=jQuery(".related li.active");if(e.data("linkKey")==b.detailViewSummaryTabLabel||e.data("linkKey")==b.detailViewDetailsTabLabel){b.reloadTabContent()}})})},registerFastEditingFiels:function(){var a=this;var b=jQuery(".summaryWidgetFastEditing select");b.on("change",function(k){var f=jQuery(k.currentTarget);var i=f.closest(".editField");var h=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"summaryWidgetFastEditing",blockInfo:{enabled:true}});var n=i.data("fieldname");n=n.replace("q_","");var j=i.data("prevvalue");var d=f.val();var l=f.validationEngine("validate");if(l){i.progressIndicator({mode:"hide"});return}var c=jQuery.Event(a.fieldPreSave);f.trigger(c,{fieldValue:d,recordId:a.getRecordId()});var m={};m.value=d;m.field=n;m=a.getCustomFieldNameValueMap(m);a.saveFieldValues(m);h.progressIndicator({mode:"hide"});var g={title:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success",animation:"show"};Vtiger_Helper_Js.showPnotify(g);a.reloadTabContent()})},registerHelpInfo:function(){var a=this.getForm();app.showPopoverElementView(a.find(".HelpInfoPopover"))},registerRelatedModulesRecordCount:function(d){var e=this;if(!jQuery.isFunction(e.refreshRelatedList)){e=new Vtiger_Detail_Js()}var b=[];var a=$(".related .nav .dropdown-menu");var c=d;if(!c||(typeof c.length=="undefined")){c=$(".related .nav > .relatedNav, .related .nav > .mainNav, .detailViewBlockLink")}c.each(function(g,f){f=$(f);if(f.data("count")=="1"){AppConnector.request({module:app.getModuleName(),action:"RelationAjax",record:app.getRecordId(),relatedModule:f.data("reference"),mode:"getRelatedListPageCount",tab_label:f.data("label-key"),}).then(function(h){if(h.success){f.find(".count").text(h.result.numberOfRecords);a.find('[data-reference="'+f.data("reference")+'"] .count').text(h.result.numberOfRecords);e.refreshRelatedList()}})}})},addComment:function(c,g){var k=this;var h=c.data("mode");var d=c.closest(".addCommentBlock");var b=d.find(".commentcontent");var l=c.closest(".singleComment");b.val("");if(h=="add"){var i=g.result["id"];var f=k.getCommentUI(i);f.then(function(p){var s=d.closest(".commentDetails");var o=k.getContentHolder();var r=jQuery(".noCommentsMsgContainer",o);r.remove();if(s.length>0){d.remove();var n=s.find("ul");if(n.length<=0){var q=l.find(".viewThreadBlock").data("childCommentsCount");var u=q+1;l.find(".childCommentsCount").text(u);var t=l.find(".commentInfoHeader").data("commentid");k.getChildComments(t).then(function(v){jQuery(v).appendTo(s);l.find(".viewThreadBlock").hide();l.find(".hideThreadBlock").show()})}else{jQuery('<ul class="liStyleNone"><li class="commentDetails">'+p+"</li></ul>").appendTo(s)}}else{jQuery('<ul class="liStyleNone"><li class="commentDetails">'+p+"</li></ul>").prependTo(d.closest(".contents").find(".commentsList"))}l.find(".commentActionsContainer").show();app.event.trigger("DetailView.SaveComment.AfterLoad",l,p)})}else{if(h=="edit"){var e=l.find(".commentModifiedTime");var j=l.find(".commentInfoContent");var a=l.find('[name="editStatus"]');var m=l.find('[name="editReason"]');j.html(g.result.commentcontent);m.html(g.result.reasontoedit);e.text(g.result.modifiedtime);e.attr("title",g.result.modifiedtimetitle);if(a.hasClass("hide")){a.removeClass("hide")}if(g.result.reasontoedit!=""){l.find(".editReason").removeClass("hide")}j.show();l.find(".commentActionsContainer").show();d.remove();app.event.trigger("DetailView.SaveComment.AfterUpdate",l,g)}}},registerCommentEvents:function(a){var b=this;a.on("click",".addCommentBtn",function(d){b.removeCommentBlockIfExists();var c=b.getCommentBlock();c.appendTo(".commentBlock")});a.on("click",".closeCommentBlock",function(f){var d=jQuery(f.currentTarget);var c=d.closest(".singleComment");c.find(".commentActionsContainer").show();c.find(".commentInfoContent").show();b.removeCommentBlockIfExists()});a.on("click",".replyComment",function(g){b.removeCommentBlockIfExists();var f=jQuery(g.currentTarget);var d=f.closest(".singleComment");var c=b.getCommentBlock();d.find(".commentActionsContainer").hide();c.appendTo(d).show()});a.on("click",".editComment",function(i){b.removeCommentBlockIfExists();var h=jQuery(i.currentTarget);var d=h.closest(".singleComment");var g=d.find(".commentInfoContent");var f=d.find('[name="editReason"]');var c=b.getEditCommentBlock();c.find(".commentcontent").val(g.text());c.find('[name="reasonToEdit"]').val(f.text());g.hide();d.find(".commentActionsContainer").hide();c.appendTo(d).show()});a.on("click",".detailViewSaveComment",function(d){var c=jQuery(d.currentTarget);if(!c.is(":disabled")){b.saveComment(d).then(function(){b.registerRelatedModulesRecordCount();var e=a.find("[data-type='Comments']");b.loadWidget(e).then(function(){c.removeAttr("disabled")})},function(e,f){c.removeAttr("disabled");app.errorLog(e,f)})}});a.on("click",".saveComment",function(d){var c=jQuery(d.currentTarget);if(!c.is(":disabled")){b.saveComment(d).then(function(f){var e=b.getTabByLabel(b.detailViewRecentCommentsTabLabel);b.registerRelatedModulesRecordCount(e);b.addComment(c,f);c.removeAttr("disabled")},function(e,f){c.removeAttr("disabled");app.errorLog(e,f)})}});a.on("click",".moreRecentComments",function(){var c=b.getTabByLabel(b.detailViewRecentCommentsTabLabel);c.trigger("click")});a.find(".commentsHierarchy").change(function(g){var f=b.getTabByLabel(b.detailViewRecentCommentsTabLabel);var c=f.data("url");var d=/&hierarchy=+([\w,]+)/;c=c.replace(d,"");if($(this).val()){c+="&hierarchy="+$(this).val()}f.data("url",c);f.trigger("click")});a.find(".commentSearch").keyup(function(d){var f=$(this).val();if(f){a.find(".commentDetails").addClass("hide");var c=a.find(".commentRelatedTitle:contains("+f+")");c.each(function(g){$(this).closest(".commentDetails").removeClass("hide")});if(c.length==0){a.find(".noCommentsMsgContainer").removeClass("hide")}}else{a.find(".commentDetails").removeClass("hide");a.find(".noCommentsMsgContainer").addClass("hide")}})},registerMailPreviewWidget:function(a){var b=this;a.on("click",".showMailBody",function(g){var h=$(g.currentTarget).closest(".row");var d=h.find(".mailBody");var f=h.find(".mailTeaser");var c=$(g.currentTarget).find(".glyphicon");if(d.hasClass("hide")){d.removeClass("hide");f.addClass("hide");c.removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-top")}else{d.addClass("hide");f.removeClass("hide");c.removeClass("glyphicon-triangle-top").addClass("glyphicon-triangle-bottom")}});a.find('[name="mail-type"]').change(function(c){b.loadMailPreviewWidget(a)});a.find('[name="mailFilter"]').change(function(c){b.loadMailPreviewWidget(a)});a.on("click",".showMailsModal",function(f){var c=$(f.currentTarget).data("url");c+="&type="+a.find('[name="mail-type"]').val();if(a.find('[name="mailFilter"]').length>0){c+="&mailFilter="+a.find('[name="mailFilter"]').val()}var d=jQuery.progressIndicator();app.showModalWindow("",c,function(e){d.progressIndicator({mode:"hide"});b.registerMailPreviewWidget(e);Vtiger_Index_Js.registerMailButtons(e);e.find(".expandAllMails").click()})});a.find(".expandAllMails").click(function(c){a.find(".mailBody").removeClass("hide");a.find(".mailTeaser").addClass("hide");a.find(".showMailBody .glyphicon").removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-top")});a.find(".collapseAllMails").click(function(c){a.find(".mailBody").addClass("hide");a.find(".mailTeaser").removeClass("hide");a.find(".showMailBody .glyphicon").removeClass("glyphicon-triangle-top").addClass("glyphicon-triangle-bottom")})},loadMailPreviewWidget:function(a){var e=this;var b=a.find(".widget_contents");var d=$("#recordId").val();var c=b.progressIndicator();var f={};f.module="OSSMailView";f.view="widget";f.smodule=$("#module").val();f.srecord=d;f.mode="showEmailsList";f.type=$('[name="mail-type"]').val();f.mailFilter=$('[name="mailFilter"]').val();AppConnector.request(f).then(function(g){b.html(g);app.event.trigger("DetailView.Widget.AfterLoad",b,"Emails",e);c.progressIndicator({mode:"hide"})})},registerEmailEvents:function(a){Vtiger_Index_Js.registerMailButtons(a)},registerMapsEvents:function(a){var c=a.find("#coordinates").val();if(a.find("#coordinates").length){var b=new OpenStreetMap_Map_Js();b.registerDetailView(a)}},registerBasicEvents:function(){var c=this;var b=c.getContentHolder();var a=c.getSelectedTab();c.registerSummaryViewContainerEvents(b);c.registerCommentEvents(b);c.registerEmailEvents(b);c.registerMapsEvents(b);app.registerEventForDatePickerFields(b);app.registerEventForClockPicker();app.showSelect2ElementView(b.find("select.select2"));b.on("click","#detailViewNextRecordButton",function(g){var d=a.data("url");var f=c.getRelatedListCurrentPageNum();var i=parseInt(f)+1;var h=d+"&page="+i;c.loadContents(h)});b.on("click","#detailViewPreviousRecordButton",function(g){var d=a.data("url");var f=c.getRelatedListCurrentPageNum();var j=parseInt(f)-1;var i={};var h=d+"&page="+j;c.loadContents(h)});b.on("click","div.detailViewTable div.fieldValue",function(f){if(jQuery(f.target).closest("a").hasClass("btnNoFastEdit")){return}var d=jQuery(f.currentTarget);c.ajaxEditHandling(d)});b.on("click","div.recordDetails span.squeezedWell",function(g){var f=jQuery(g.currentTarget);var d=f.data("reference");jQuery('.detailViewInfo .related .nav > li[data-reference="'+d+'"]').trigger("click")});b.on("click",".relatedPopup",function(f){var d=new Vtiger_Edit_Js();d.openPopUp(f);return false});b.on("click",".viewThread",function(j){var i=jQuery(j.currentTarget);var h=i.parent();var d=i.closest(".commentActions");var f=i.closest(".commentDetails");var k=f.find("ul");if(k.length>0){k.show();d.find(".hideThreadBlock").show();h.hide();return}var g=i.closest(".commentDiv").find(".commentInfoHeader").data("commentid");c.getChildComments(g).then(function(e){jQuery(e).appendTo(jQuery(j.currentTarget).closest(".commentDetails"));d.find(".hideThreadBlock").show();h.hide()})});b.on("click",".hideThread",function(i){var h=jQuery(i.currentTarget);var g=h.parent();var d=h.closest(".commentActions");var f=h.closest(".commentDetails");f.find("ul").hide();g.hide();d.find(".viewThreadBlock").show()});b.on("click",".detailViewThread",function(h){var g=c.getTabByLabel(c.detailViewRecentCommentsTabLabel);var f=jQuery(h.currentTarget).closest(".singleComment").find(".commentInfoHeader").data("commentid");var d=function(e){window.location.href=window.location.href+"#"+f};g.trigger("click",{commentid:f,callback:d})});b.on("click",".moreRecentRecords",function(f){f.preventDefault();var d=c.getTabByModule($(this).data("label-key"));d.trigger("click")});b.on("change",".relatedHistoryTypes",function(h){var d=jQuery(this).closest(".widgetContentBlock").find(".widgetContent");var f=jQuery(h.currentTarget).val();var i=d.find("#relatedHistoryPageLimit").val();var g=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true,elementToBlock:d}});AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:1,limit:i,type:f,}).then(function(e){g.progressIndicator({mode:"hide"});d.find("#relatedHistoryCurrentPage").remove();d.find("#moreRelatedUpdates").remove();d.html(e);Vtiger_Index_Js.registerMailButtons(d)})});b.on("click",".moreProductsService",function(){jQuery('.related .mainNav[data-reference="ProductsAndServices"]:not(.hide)').trigger("click")});b.on("click",".moreRelatedUpdates",function(){var h=jQuery(this).closest(".widgetContentBlock");var e=h.find(".widgetContent");var i=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true,elementToBlock:e}});var g=e.find("#relatedHistoryCurrentPage").val();var d=parseInt(g)+1;var f=h.find(".relatedHistoryTypes").val();var j=e.find("#relatedHistoryPageLimit").val();AppConnector.request({module:app.getModuleName(),view:"Detail",record:app.getRecordId(),mode:"showRecentRelation",page:d,limit:j,type:f,}).then(function(k){i.progressIndicator({mode:"hide"});e.find("#relatedHistoryCurrentPage").remove();e.find("#moreRelatedUpdates").remove();e.find("#relatedUpdates").append(k)})});b.on("click",".moreRecentUpdates",function(k){var f=$(k.currentTarget).closest(".recentActivitiesContainer");var g=f.find("#newChange");var m=g.val();var j=f.find("#updatesCurrentPage").val();var l=parseInt(j)+1;if(f.closest(".summaryWidgetContainer").length){var i=c.getFiltersData(k,{page:l,tab_label:"LBL_UPDATES",newChange:m},f.find("#updates"));var d=i.params}else{var d=c.getTabByLabel(c.detailViewRecentUpdatesTabLabel).data("url");d=d.replace("&page=1","&page="+l)+"&skipHeader=true&newChange="+m;if(d.indexOf("&whereCondition")==-1){var h=jQuery(".recentActivitiesSwitch");d+="&whereCondition="+(h.prop("checked")?h.data("on-val"):h.data("off-val"))}}AppConnector.request(d).then(function(e){var n=jQuery(e);f.find("#newChange").val(n.find("#newChange").val());f.find("#updatesCurrentPage").val(n.find("#updatesCurrentPage").val());f.find("#moreLink").html(n.find("#moreLink").html());f.find("#updates ul").append(n.find("#updates ul").html());app.registerMoreContent(f.find("button.moreBtn"));app.event.trigger("DetailView.UpdatesWidget.AddMore",e,c)})});b.on("click",".btnChangesReviewedOn",function(g){var f=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d="index.php?module=ModTracker&action=ChangesReviewedOn&record="+app.getRecordId();AppConnector.request(d).then(function(h){f.progressIndicator({mode:"hide"});jQuery(g.currentTarget).parent().remove();c.getTabByLabel(c.detailViewRecentUpdatesTabLabel).find(".count.badge").text("");if(a.data("labelKey")==c.detailViewRecentUpdatesTabLabel){c.reloadTabContent()}else{if(a.data("linkKey")==c.detailViewSummaryTabLabel){var e=b.find("[data-type='Updates']");if(e.length>0){var i=c.getFiltersData(e);c.loadWidget(e,i.params)}}}})});b.on("click",".moreRecentDocuments",function(){var d=c.getTabByLabel(c.detailViewRecentDocumentsTabLabel);d.trigger("click")});app.event.on("DetailView.Widget.AfterLoad",function(h,g,i,d){if(i==="Calendar"){var f=g.closest(".activityWidgetContainer");c.reloadWidgetActivitesStats(f)}});b.on("click",".moreRecentActivities",function(i){var h=$(i.currentTarget);h.prop("disabled",true);var d=h.closest(".activityWidgetContainer");var g=d.find(".currentPage").val();g++;var f=d.find(".widgetContentBlock").data("url");f=f.replace("&page=1","&page="+g);f+="&totalCount="+d.find(".totaltActivities").val();AppConnector.request(f).then(function(j){h.prop("disabled",false);h.addClass("hide");var e=d.find(".currentPage").val();d.find(".currentPage").remove();d.find(".countActivities").remove();d.find(".widget_contents").append(j);d.find(".countActivities").val(parseInt(d.find(".countActivities").val())+e*parseInt(d.find(".pageLimit").val()));c.reloadWidgetActivitesStats(d);app.showPopoverElementView(d.find(".popoverTooltip"))})});b.on("click",".widgetFullscreen",function(i){var h=$(i.currentTarget);var d=h.closest(".widgetContentBlock");var f=d.data("url");f=f.replace("&view=Detail&","&view=WidgetFullscreen&");var g=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});app.showModalWindow(null,"index.php?"+f,function(e){g.progressIndicator({mode:"hide"})})});app.event.on("DetailView.Widget.AfterLoad",function(g,f,h,d){c.registerEmailEvents(f)});c.registerEventForRelatedList();c.registerBlockAnimationEvent();c.registerMailPreviewWidget(b.find('.widgetContentBlock[data-type="EmailList"]'));c.registerMailPreviewWidget(b.find('.widgetContentBlock[data-type="HistoryRelation"]'));app.event.on("DetailView.Widget.AfterLoad",function(h,f,i,d,g){if(i=="Emails"){Vtiger_Index_Js.registerMailButtons(f);f.find(".showMailModal").click(function(l){var k=jQuery.progressIndicator();var j=$(l.currentTarget).data("url")+"&noloadlibs=1";app.showModalWindow("",j,function(e){Vtiger_Index_Js.registerMailButtons(e);k.progressIndicator({mode:"hide"})})})}});b.on("switchChange.bootstrapSwitch",".recentActivitiesSwitch.switchBtn",function(l,i){var k=jQuery(l.currentTarget);var h=c.getTabByLabel(c.detailViewRecentUpdatesTabLabel);var g=h.data("url");var j=k.data("urlparams");var f=k.data("on-val");var d=k.data("off-val");g=g.replace("&"+j+"="+f,"").replace("&"+j+"="+d,"");if(i){g+="&"+j+"="+f}else{g+="&"+j+"="+d}h.data("url",g);h.trigger("click")})},reloadWidgetActivitesStats:function(c){var e=c.find(".countActivities");var b=c.find(".totaltActivities");if(!e.length||!b.length){return false}var d=" ("+e.val()+"/"+b.val()+")";var a=c.find(".switchBtn");if(a.prop("checked")){var f=a.data("basic-texton")+d;a.data("on-text",f)}else{var f=a.data("basic-textoff")+d;a.data("off-text",f)}a.bootstrapSwitch("destroy");a.bootstrapSwitch()},refreshRelatedList:function(){var a=jQuery(".related");var b=a.find(".dropdown");var i=a.find(".nav .dropdown-menu");var e=3;var h=15;var f=a.width();var g=0;var c=0;b.removeClass("hide");var d=b.width()+e;b.addClass("hide");c=f-d-h;a.find(".nav > .mainNav").each(function(j){jQuery(this).removeClass("hide");if(c>jQuery(this).width()){i.find('[data-reference="'+jQuery(this).data("reference")+'"]').addClass("hide");c-=Math.ceil(jQuery(this).width())+e}else{jQuery(this).addClass("hide");i.find('[data-reference="'+jQuery(this).data("reference")+'"]').removeClass("hide");c=0}});if(c===0){i.find(".relatedNav").removeClass("hide");a.find(".spaceRelatedList").addClass("hide");b.removeClass("hide")}else{c-=a.find(".spaceRelatedList").removeClass("hide").width()+e;a.find(".nav > .relatedNav").each(function(){jQuery(this).removeClass("hide");if(c>jQuery(this).width()){i.find('[data-reference="'+jQuery(this).data("reference")+'"]').addClass("hide");c-=Math.ceil(jQuery(this).width())+e}else{c=0;jQuery(this).addClass("hide");i.find('[data-reference="'+jQuery(this).data("reference")+'"]').removeClass("hide")}});if(c===0){b.removeClass("hide")}}},refreshCommentContainer:function(b){var c=this;var a=$(".commentsBody");var e={module:app.getModuleName(),view:"Detail",record:c.getRecordId(),mode:"showThreadComments",commentid:b};var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true,elementToBlock:a}});AppConnector.request(e).then(function(f){d.progressIndicator({mode:"hide"});a.html(f)})},updateRecordsPDFTemplateBtn:function(a){var b={};b.data={module:app.getModuleName(),action:"PDF",mode:"hasValidTemplate",record:app.getRecordId(),view:app.getViewName()};b.dataType="json";AppConnector.request(b).then(function(f){var c=f.result;var e=jQuery(".detailViewToolbar .btn-toolbar");if(c.valid==false){var d=e.find('.btn-group:eq(1) [href*="showPdfModal"]');if(d.length){d.remove()}}else{var g=e.find(".btn-group:eq(1)");var d=e.find('.btn-group:eq(1) [href*="showPdfModal"]');if(d.length==0){g.append('<a class="btn btn-default popoverTooltip" href=\'javascript:Vtiger_Header_Js.getInstance().showPdfModal("index.php?module='+app.getModuleName()+"&view=PDF&fromview=Detail&record="+app.getRecordId()+'");\' data-content="'+app.vtranslate("LBL_EXPORT_PDF")+'" data-original-title="" title=""><span class="glyphicon glyphicon-save-file icon-in-button"></span></a>')}}},function(d,c){app.errorLog(d,c)})},updateWindowHeight:function(b,a){a.height(b)},registerEvents:function(){var b=this;b.refreshRelatedList();this.registerHelpInfo();b.registerSendSmsSubmitEvent();b.registerAjaxEditEvent();this.registerRelatedRowClickEvent();this.registerBlockStatusCheckOnLoad();this.registerEmailFieldClickEvent();this.registerPhoneFieldClickEvent();this.registerEventForRelatedTabClick();Vtiger_Helper_Js.showHorizontalTopScrollBar();this.registerUrlFieldClickEvent();var a=jQuery("div.detailViewContainer");if(a.length<=0){return}this.registerBasicEvents();this.registerSetReadRecord(a);b.registerEventForPicklistDependencySetup(b.getForm());b.getForm().validationEngine(app.validationEngineOptionsForRecord);b.loadWidgets();this.registerEventForTotalRecordsCount()}});