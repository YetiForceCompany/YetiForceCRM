'use strict';

/*+***********************************************************************************
 * The contents of this file are subject to the vtiger CRM Public License Version 1.0
 * ("License"); You may not use this file except in compliance with the License
 * The Original Code is:  vtiger CRM Open Source
 * The Initial Developer of the Original Code is vtiger.
 * Portions created by vtiger are Copyright (C) vtiger.
 * All Rights Reserved.
 * Contributor(s): YetiForce S.A.
 *************************************************************************************/"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}jQuery.Class("Vtiger_Widget_Js",{widgetPostLoadEvent:"Vtiger.Dashboard.PostLoad",widgetPostRefereshEvent:"Vtiger.Dashboard.PostRefresh",getInstance:function(container,widgetClassName,moduleName){"undefined"==typeof moduleName&&(moduleName=app.getModuleName());var instance,moduleClass=window[moduleName+"_"+widgetClassName+"_Widget_Js"],fallbackClass=window["Vtiger_"+widgetClassName+"_Widget_Js"],yetiClass=window["YetiForce_"+widgetClassName+"_Widget_Js"],basicClass=YetiForce_Widget_Js;return instance="undefined"==typeof moduleClass?"undefined"==typeof fallbackClass?"undefined"==typeof yetiClass?new basicClass(container,!1,widgetClassName):new yetiClass(container,!1,widgetClassName):new fallbackClass(container,!1,widgetClassName):new moduleClass(container,!1,widgetClassName),instance}},{container:!1,plotContainer:!1,chartInstance:!1,chartData:[],paramCache:!1,init:function(container,reload){container=$(container),this.setContainer(container),this.registerWidgetPostLoadEvent(container),reload||this.registerWidgetPostRefreshEvent(container),this.registerCache(container);},areColorsFromDividingField:function areColorsFromDividingField(){return !!Number(this.getContainer().find("[name=\"colorsFromDividingField\"]").val())},getSourceChartType:function getSourceChartType(){return this.getContainer().find("[name=\"typeChart\"]").val()},isMultiFilter:function isMultiFilter(){return "undefined"!=typeof this.filterIds&&1<this.filterIds.length},/**
		 * Get widget data
		 * @returns {*}
		 */getWidgetData:function getWidgetData(){if("undefined"!=typeof this.widgetData)return this.widgetData;var widgetDataEl=this.getContainer().find(".widgetData");return !!widgetDataEl.length&&(this.widgetData=JSON.parse(widgetDataEl.val()))},/**
		 * Predefined functions that will replace options function type
		 * @type {Object}
		 */globalChartFunctions:{/**
			 * Functions for x or y axes scales xAxes:[{here}]
			 */scales:{formatAxesLabels:function(value){return 0<String(value).length&&!isNaN(Number(value))?App.Fields.Double.formatToDisplay(value):value}},/**
			 * Functions for datalabels
			 */datalabels:{display:function display(context){var meta=context.chart.getDatasetMeta(context.datasetIndex);return !0!==meta.hidden},formatter:function(value,context){return "undefined"!=typeof this.widgetData&&"undefined"!=typeof this.widgetData.valueType&&"count"===this.widgetData.valueType?App.Fields.Double.formatToDisplay(value,0):"undefined"!=typeof context.chart.data.datasets[context.datasetIndex].dataFormatted&&"undefined"!=typeof context.chart.data.datasets[context.datasetIndex].dataFormatted[context.dataIndex]?context.chart.data.datasets[context.datasetIndex].dataFormatted[context.dataIndex]:0<String(value).length&&isNaN(Number(value))?App.Fields.Double.formatToDisplay(value):value}},/**
			 * Tooltips functions
			 */tooltips:{label:function(tooltipItem,data){// get already formatted data if exists
return "undefined"!=typeof data.datasets[tooltipItem.datasetIndex].dataFormatted&&"undefined"!==data.datasets[tooltipItem.datasetIndex].dataFormatted[tooltipItem.index]?data.datasets[tooltipItem.datasetIndex].dataFormatted[tooltipItem.index]:0<String(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index]).length&&!isNaN(Number(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index]))?"undefined"!=typeof this.widgetData&&"undefined"!=typeof this.widgetData.valueType&&"count"===this.widgetData.valueType?App.Fields.Double.formatToDisplay(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index],0):App.Fields.Double.formatToDisplay(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index]):data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];// if there is no formatted data so try to format it
// return raw data at idex
},title:function(tooltipItems,data){var tooltipItem=tooltipItems[0];// get already formatted title if exists
return "undefined"!=typeof data.datasets[tooltipItem.datasetIndex].titlesFormatted&&"undefined"!==data.datasets[tooltipItem.datasetIndex].titlesFormatted[tooltipItem.index]?data.datasets[tooltipItem.datasetIndex].titlesFormatted[tooltipItem.index]:0<String(data.labels[tooltipItem.index]).length&&!isNaN(Number(data.labels[tooltipItem.index]))?"undefined"!=typeof this.widgetData&&"undefined"!=typeof this.widgetData.valueType&&"count"===this.widgetData.valueType?App.Fields.Double.formatToDisplay(data.labels[tooltipItem.index],0):App.Fields.Double.formatToDisplay(data.labels[tooltipItem.index]):data.labels[tooltipItem.index];// if there is no formatted title so try to format it
// return label at index
}},legend:{onClick:function onClick(e,legendItem){var type=this.chartInstance.config.type;return "undefined"==typeof Chart.defaults[type]?Chart.defaults.global.legend.onClick.apply(this.chartInstance,[e,legendItem]):Chart.defaults[type].legend.onClick.apply(this.chartInstance,[e,legendItem])},generateLabels:function generateLabels(chart){var labels,type=chart.config.type;return labels="undefined"==typeof Chart.defaults[type]?Chart.defaults.global.legend.labels.generateLabels(chart):Chart.defaults[type].legend.labels.generateLabels(chart),(this.areColorsFromDividingField()||this.isMultiFilter())&&(chart.config.options.legend.labels.boxWidth=12,labels.forEach(function(label){label.fillStyle="rgba(0,0,0,0)",label.strokeStyle="rgba(0,0,0,0.15)";})),labels},display:function display(){return !!(this.isMultiFilter()||this.areColorsFromDividingField())}},/**
			 * plugins
			 */plugins:{/**
				 * If datalabels doesn't fit - hide them individually
				 * @param  {Chart} chart chart instance
				 * @return {undefined}
				 */hideVerticalBarDatalabelsIfNeeded:function hideVerticalBarDatalabelsIfNeeded(chart){for(var getDatasetsMeta=function getDatasetsMeta(chart){var datasets=[],data=chart.data;if("undefined"!=typeof data&&"undefined"!=typeof data.datasets&&Array.isArray(data.datasets))for(var meta,i=0,len=data.datasets.length;i<len;i++)meta=chart.getDatasetMeta(i),"undefined"!=typeof meta.data&&Array.isArray(meta.data)&&datasets.push(meta);return datasets},datasetsMeta=getDatasetsMeta(chart),datasets=chart.data.datasets,i=0,len=datasets.length;i<len;i++){var dataset=datasets[i],meta=datasetsMeta[i];if(!meta.hidden){var metaData=meta.data;"undefined"==typeof dataset._models&&(dataset._models={}),"undefined"==typeof dataset.datalabels&&(dataset.datalabels={}),"undefined"==typeof dataset.datalabels.display&&(dataset.datalabels.display=!0);for(var dataItem,iItem=0,lenItem=metaData.length;iItem<lenItem;iItem++)if(dataItem=metaData[iItem],"undefined"!=typeof dataItem.$datalabels&&"undefined"!=typeof dataItem.$datalabels._model){var model=dataItem.$datalabels._model;if(null!==model&&"undefined"!=typeof model)dataset._models[iItem]=model;else if(null!==dataset._models[iItem]&&"undefined"!=typeof dataset._models[iItem])model=dataset._models[iItem];else return !1;var labelWidth=model.size.width+model.padding.width+2*model.borderWidth,labelHeight=model.size.height+model.padding.height+2*model.borderWidth,barHeight=dataItem.height(),threshold=10;"undefined"!=typeof chart.config.options.verticalBarLabelsThreshold&&(threshold=chart.config.options.verticalBarLabelsThreshold),dataItem._view.width+threshold<labelWidth||barHeight+threshold<labelHeight?dataItem.$datalabels._model.positioner=function(){return !1}:dataItem.$datalabels._model=model;}}}},/**
				 * If datalabels doesn't fit - hide them individually
				 * @param  {Chart} chart  Chart instance
				 * @return {undefined}
				 */hideHorizontalBarDatalabelsIfNeeded:function hideHorizontalBarDatalabelsIfNeeded(chart){for(var getDatasetsMeta=function getDatasetsMeta(chart){var datasets=[],data=chart.data;if("undefined"!=typeof data&&"undefined"!=typeof data.datasets&&Array.isArray(data.datasets))for(var meta,i=0,len=data.datasets.length;i<len;i++)meta=chart.getDatasetMeta(i),"undefined"!=typeof meta.data&&Array.isArray(meta.data)&&datasets.push(meta);return datasets},datasetsMeta=getDatasetsMeta(chart),datasets=chart.data.datasets,i=0,len=datasets.length;i<len;i++){var dataset=datasets[i],meta=datasetsMeta[i];if(!meta.hidden){var metaData=meta.data;"undefined"==typeof dataset._models&&(dataset._models={}),"undefined"==typeof dataset.datalabels&&(dataset.datalabels={}),"undefined"==typeof dataset.datalabels.display&&(dataset.datalabels.display=!0);for(var dataItem,iItem=0,lenItem=metaData.length;iItem<lenItem;iItem++)if(dataItem=metaData[iItem],"undefined"!=typeof dataItem.$datalabels&&"undefined"!=typeof dataItem.$datalabels._model){var model=dataItem.$datalabels._model;if(null!==model&&"undefined"!=typeof model)dataset._models[iItem]=model;else if(null!==dataset._models[iItem]&&"undefined"!=typeof dataset._models[iItem])model=dataset._models[iItem];else return !1;var labelWidth=model.size.width+model.padding.width+2*model.borderWidth,labelHeight=model.size.height+model.padding.height+2*model.borderWidth,barWidth=dataItem.width,threshold=10;"undefined"!=typeof chart.config.options.horizontalBarLabelsThreshold&&(threshold=chart.config.options.horizontalBarLabelsThreshold),dataItem._view.height+threshold<labelHeight||barWidth+threshold<labelWidth?dataItem.$datalabels._model.positioner=function(){return !1}:dataItem.$datalabels._model=model;}}}},/**
				 * Fix to long axis labels
				 * @param  {Chart}  chart    Chart instance
				 * @return {Boolean}       [description]
				 */fixXAxisLabels:function fixXAxisLabels(chart){var shortenXTicks=function shortenXTicks(data,options){return "undefined"==typeof options.scales&&(options.scales={}),"undefined"==typeof options.scales.xAxes&&(options.scales.xAxes=[{}]),options.scales.xAxes.forEach(function(axis){"undefined"==typeof axis.ticks&&(axis.ticks={}),axis.ticks.callback=function xAxisTickCallback(value,index,values){return 13<value.length?value.substr(0,10)+"...":value};}),options},rotateXLabels90=function rotateXLabels90(data,options){return "undefined"==typeof options.scales&&(options.scales={}),"undefined"==typeof options.scales.xAxes&&(options.scales.xAxes=[{}]),options.scales.xAxes.forEach(function(axis){"undefined"==typeof axis.ticks&&(axis.ticks={}),axis.ticks.minRotation=90;}),options};chart.data.datasets.forEach(function(dataset,index){if(dataset._updated)return !1;var _loop=function _loop(prop){if(dataset._meta.hasOwnProperty(prop)){for(var i=0,len=dataset._meta[prop].data.length;i<len;i++){var metaDataItem=dataset._meta[prop].data[i],label=metaDataItem._xScale.ticks[i],ctx=metaDataItem._xScale.ctx,categoryWidth=metaDataItem._xScale.width/dataset._meta[prop].data.length;"undefined"!=typeof metaDataItem._xScale.options.categoryPercentage&&(categoryWidth*=metaDataItem._xScale.options.categoryPercentage);var fullWidth=ctx.measureText(label).width;if(categoryWidth<fullWidth){var shortened=label.substr(0,10)+"...",shortenedWidth=ctx.measureText(shortened).width;if(categoryWidth<shortenedWidth?(chart.options=rotateXLabels90(chart.data,chart.options),chart.options=shortenXTicks(chart.data,chart.options)):chart.options=shortenXTicks(chart.data,chart.options),!dataset._updated){dataset._updated=!0,chart.update(),chart.data.datasets.forEach(function(dataset,index){dataset._meta[prop].data.forEach(function(metaDataItem,dataIndex){metaDataItem._view.x=metaDataItem._xScale.getPixelForValue(index,dataIndex),metaDataItem._view.base=metaDataItem._xScale.getBasePixel(),metaDataItem._view.width=metaDataItem._xScale.width/dataset._meta[prop].data.length*metaDataItem._xScale.options.categoryPercentage*metaDataItem._xScale.options.barPercentage;});});break}}}dataset._updated=!0;}};for(var prop in dataset._meta)_loop(prop);});},/**
				 * Fix too long axis labels  - try to shorten and rotate
				 * @param  {Chart}  chart    Chart instance
				 * @return {Boolean}
				 */fixYAxisLabels:function fixYAxisLabels(chart){var shortenYTicks=function shortenYTicks(data,options){return "undefined"==typeof options.scales&&(options.scales={}),"undefined"==typeof options.scales.yAxes&&(options.scales.yAxes=[{}]),options.scales.yAxes.forEach(function(axis){"undefined"==typeof axis.ticks&&(axis.ticks={}),axis.ticks.callback=function yAxisTickCallback(value,index,values){return 13<value.length?value.substr(0,10)+"...":value};}),options};chart.data.datasets.forEach(function(dataset,index){if(dataset._updated)return !1;var _loop2=function _loop2(prop){if(dataset._meta.hasOwnProperty(prop)){// we have meta
for(var i=0,len=dataset._meta[prop].data.length;i<len;i++){var metaDataItem=dataset._meta[prop].data[i],label=metaDataItem._view.label;if(13<label.length&&(chart.options=shortenYTicks(chart.data,chart.options),!dataset._updated)){dataset._updated=!0,chart.update(),chart.data.datasets.forEach(function(dataset,index){dataset._meta[prop].data.forEach(function(metaDataItem,dataIndex){"undefined"!=typeof metaDataItem._xScale&&(metaDataItem._view.x=metaDataItem._xScale.getPixelForValue(index,dataIndex),metaDataItem._view.base=metaDataItem._xScale.getBasePixel(),metaDataItem._view.width=metaDataItem._xScale.width/dataset._meta[prop].data.length*metaDataItem._xScale.options.categoryPercentage*metaDataItem._xScale.options.barPercentage);});});break}}dataset._updated=!0;}};for(var prop in dataset._meta)_loop2(prop);});}}},/**
		 * Get function from global functions from replacement string
		 * @param  {String} replacementStr replacement string from getFunctionReplacementString method
		 * @return {Function}
		 */getFunctionFromReplacementString:function getFunctionFromReplacementString(replacementStr){var assignResult=!1;"()"===replacementStr.substr(replacementStr.length-2)&&(replacementStr=replacementStr.substr(0,replacementStr.length-2),assignResult=!0);var splitted=replacementStr.split(":");2!==splitted.length&&app.errorLog(new Error("Function replacement string should look like 'function:path.to.fn' not like '"+replacementStr+"'"));var finalFunction=splitted[1].split(".").reduce(function(previous,current){return previous[current]},this.globalChartFunctions);return "function"!=typeof finalFunction&&app.errorLog(new Error("Global function does not exists: "+splitted[1])),assignResult?finalFunction.call(this):finalFunction.bind(this)},/**
		 * Should options property be replaced by function?
		 * @param  {String}  str
		 * @return {Boolean}
		 */isReplacementString:function isReplacementString(str){return !("string"!=typeof str)&&"function:"===str.substr(0,9)},/**
		 * Recursively parse options and replace function replacement strings to functions
		 * @param  {Object} options
		 * @param  {bool} afterInit are we parsing chart after it was mounted ?
		 * @return {Object} options with replaced string functions
		 */parseOptionsObject:function parseOptionsObject(options,original){var afterInit=!!(2<arguments.length&&arguments[2]!==void 0)&&arguments[2],result={};for(var propertyName in options){var _value=options[propertyName];result[propertyName]=afterInit?"_"===propertyName.substr(0,1)?_value:Array.isArray(_value)?this.parseOptionsArray(_value,original,afterInit):"object"===_typeof(_value)&&null!==_value?this.parseOptionsObject(_value,original,afterInit):_value:"_"===propertyName.substr(0,1)?_value:this.isReplacementString(_value)?this.getFunctionFromReplacementString(_value,afterInit,original):Array.isArray(_value)?this.parseOptionsArray(_value,original,afterInit):"object"===_typeof(_value)&&null!==_value?this.parseOptionsObject(_value,original,afterInit):_value;}return result},/**
		 * Recursively parse options in array form and replace function replacement string with functions
		 * @param  {Array} arr
		 * @param  {bool} afterInit are we after chart js was mounted?
		 * @return {Array}
		 */parseOptionsArray:function parseOptionsArray(arr,original){var _this=this,afterInit=!!(2<arguments.length&&arguments[2]!==void 0)&&arguments[2];return arr.map(function(item,index){if(_this.isReplacementString(item))return _this.getFunctionFromReplacementString(value);return Array.isArray(item)?_this.parseOptionsArray(item,original,afterInit):"object"===_typeof(item)&&null!==item?_this.parseOptionsObject(item,original,afterInit):item})},/**
		 * Recursively parse options object and replace function replacement strings with global functions
		 * @param  {Object} options
		 * @param  {bool} afterInit - is chartjs loaded ?
		 * @return {Object}
		 */parseOptions:function parseOptions(options,original){var afterInit=!!(2<arguments.length&&arguments[2]!==void 0)&&arguments[2];if(Array.isArray(options))return this.parseOptionsArray(options,original,afterInit);return "object"===_typeof(options)&&null!==options?this.parseOptionsObject(options,original,afterInit):void app.errorLog(new Error("Unknown options format ["+_typeof(options)+"] - should be object."))},/**
		 * Remove 'Divided' from chart sub type
		 * for example 'barDivided' => 'bar'
		 *
		 * @param {String} chartSubType
		 * @return {String}
		 */removeStackedFromName:function removeStackedFromName(chartSubType){var dividedPos=chartSubType.indexOf("Stacked");return 0<dividedPos?chartSubType.substr(0,dividedPos):chartSubType},/**
		 * Get global charts default configuration - may be loaded from database in the future
		 * We can modify something basing on chartData received from server (some custom options etc.)
		 *
		 * @param  {Object} chartData received from request ['labels':[],'datasets':['data':[]]] etc
		 * @param  {String} chartSubType 'bar','pie' etc..
		 * @return {Object}
		 */getGlobalDefaultChartsOptions:function getGlobalDefaultChartsOptions(chartSubType,chartData){var options={bar:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels"}}],yAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.2)",borderColor:"rgba(255,255,255,0.2)",borderWidth:2,borderRadius:2,anchor:"center",align:"center",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixXAxisLabels"},{beforeDraw:"function:plugins.hideVerticalBarDatalabelsIfNeeded"}]},barStacked:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{stacked:!0,ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels"}}],yAxes:[{stacked:!0,ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.2)",borderColor:"rgba(255,255,255,0.2)",borderWidth:2,borderRadius:2,anchor:"center",align:"center",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixXAxisLabels"},{beforeDraw:"function:plugins.hideVerticalBarDatalabelsIfNeeded"}]},horizontalBar:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels"}}],yAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.2)",borderColor:"rgba(255,255,255,0.2)",borderWidth:2,borderRadius:2,anchor:"center",align:"center",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixYAxisLabels"},{beforeDraw:"function:plugins.hideHorizontalBarDatalabelsIfNeeded"}]},horizontalBarStacked:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{stacked:!0,ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels"}}],yAxes:[{stacked:!0,ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.2)",borderColor:"rgba(255,255,255,0.2)",borderWidth:2,borderRadius:2,anchor:"center",align:"center",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixYAxisLabels"},{beforeDraw:"function:plugins.hideHorizontalBarDatalabelsIfNeeded"}]},line:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels",labelOffset:0}}],yAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{fill:!1,datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.5)",borderWidth:2,borderRadius:2,anchor:"bottom",align:"bottom",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixXAxisLabels"}]},lineStacked:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels",labelOffset:0}}],yAxes:[{stacked:!0,ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{fill:!1,datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.5)",borderWidth:2,borderRadius:2,anchor:"bottom",align:"bottom",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixXAxisLabels"}]},linePlain:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels",labelOffset:0}}],yAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{lineTension:0,fill:!1,datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.5)",borderWidth:2,borderRadius:2,anchor:"bottom",align:"bottom",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixXAxisLabels"}]},linePlainStacked:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:"function:legend.display()"},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{xAxes:[{ticks:{autoSkip:!1,beginAtZero:!0,maxRotation:90,callback:"function:scales.formatAxesLabels",labelOffset:0}}],yAxes:[{stacked:!0,ticks:{autoSkip:!1,beginAtZero:!0,callback:"function:scales.formatAxesLabels"}}]}},dataset:{fill:!1,lineTension:0,datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.5)",borderWidth:2,borderRadius:2,anchor:"bottom",align:"bottom",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[{beforeDraw:"function:plugins.fixXAxisLabels"}]},pie:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:!0,labels:{generateLabels:"function:legend.generateLabels"}},cutoutPercentage:0,layout:{padding:{bottom:12}},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{}},dataset:{datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.5)",borderWidth:2,borderRadius:4,anchor:"end",align:"center",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[]},doughnut:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:!0,onClick:"function:legend.onClick",labels:{generateLabels:"function:legend.generateLabels"}},cutoutPercentage:50,layout:{padding:{bottom:12}},tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{}},dataset:{datalabels:{font:{size:11},color:"white",backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.5)",borderWidth:2,borderRadius:4,anchor:"end",align:"center",formatter:"function:datalabels.formatter",display:"function:datalabels.display"}},plugins:[]},funnel:{basic:{maintainAspectRatio:!1,title:{display:!1},legend:{display:!1},sort:"desc",tooltips:{mode:"point",callbacks:{label:"function:tooltips.label",title:"function:tooltips.title"}},scales:{yAxes:[{display:!0,beginAtZero:!0,ticks:{callback:"function:scales.formatAxesLabels"}}]}},dataset:{datalabels:{display:!1}},plugins:[{beforeDraw:"function:plugins.fixYAxisLabels"}]}};if("undefined"!=typeof options[chartSubType])return options[chartSubType];// if divided and standard chart types are equal
var notStackedChartSubType=this.removeStackedFromName(chartSubType);return "undefined"==typeof options[notStackedChartSubType]?void app.errorLog(new Error(chartSubType+" chart does not exists!")):options[notStackedChartSubType]},/**
		 * Get default chart basic options for specified chart subtype
		 *
		 * @param  {String} chartSubType 'bar','pie'...
		 * @param  {Object} chartData received from request ['labels':[],'datasets':['data':[]]] etc
		 * @return {Object}
		 */getDefaultBasicOptions:function getDefaultBasicOptions(chartSubType,chartData){return this.getGlobalDefaultChartsOptions(chartSubType,chartData).basic},/**
		 * Get default dataset options for specified chart subtype
		 *
		 * @param  {String} chartSubType 'bar','pie'...
		 * @param  {Object} chartData received from request ['labels':[],'datasets':['data':[]]] etc
		 * @return {Object}
		 */getDefaultDatasetOptions:function getDefaultDatasetOptions(chartSubType,chartData){return this.getGlobalDefaultChartsOptions(chartSubType,chartData).dataset},/**
		 * Get default plugins for specified chart subtype
		 *
		 * @param  {String} chartSubType 'bar','pie'...
		 * @param  {Object} chartData received from request ['labels':[],'datasets':['data':[]]] etc
		 * @return {Object}
		 */getDefaultPlugins:function getDefaultPlugins(chartSubType,chartData){return this.getGlobalDefaultChartsOptions(chartSubType,chartData).plugins},getContainer:function getContainer(){return this.container},/**
		 * Get widget content
		 * @returns {jQuery}
		 */getContainerContent:function getContainer(){return this.getContainer().find(".dashboardWidgetContent")},setContainer:function setContainer(element){return this.container=element,this},isEmptyData:function isEmptyData(){return 0===this.getContainer().find(".widgetData").length||0<this.getContainer().find(".noDataMsg").length},getUserDateFormat:function getUserDateFormat(){return CONFIG.dateFormat},getChartContainer:function getChartContainer(useCache){return "undefined"==typeof useCache&&(useCache=!1),!1!==this.plotContainer&&useCache||(this.plotContainer=this.getContainer().find(".widgetChartContainer").find("canvas").get(0)),this.plotContainer},registerRecordsCount:function registerRecordsCount(){var thisInstance=this,recordsCountBtn=thisInstance.getContainer().find(".recordCount");recordsCountBtn.on("click",function(){var url=recordsCountBtn.data("url");AppConnector.request(url).done(function(response){recordsCountBtn.find(".count").html(response.result.totalCount),recordsCountBtn.find(".fas").addClass("d-none").attr("aria-hidden",!0),recordsCountBtn.find("a").removeClass("d-none").attr("aria-hidden",!1);});});},/**
		 * Load scrollbar
		 */loadScrollbar:function loadScrollbar(){var container=$(this.getChartContainer(!1));if(container.length||(container=this.getContainerContent()),!!container.length){var widget=container.closest(".dashboardWidget"),content=widget.find(".dashboardWidgetContent"),footer=widget.find(".dashboardWidgetFooter"),adjustedHeight=widget.innerHeight()-widget.find(".dashboardWidgetHeader").outerHeight();footer.length&&(adjustedHeight-=footer.outerHeight()),content.length&&(content.css("height",adjustedHeight+"px"),content.css("max-height",adjustedHeight+"px"),"undefined"==typeof this.scrollbar?this.scrollbar=app.showNewScrollbar(content,{wheelPropagation:!0}):this.scrollbar.update());}},restrictContentDrag:function restrictContentDrag(){this.getContainer().on("mousedown.draggable",function(e){var element=jQuery(e.target),isHeaderElement=!!(0<element.closest(".dashboardWidgetHeader").length);isHeaderElement||//Stop the event propagation so that drag will not start for contents
e.stopPropagation();});},/**
		 * Get data from JSON encoded input value
		 *
		 * @return {object} data from request
		 */generateData:function generateData(){var thisInstance=this,jData=thisInstance.getContainer().find(".widgetData").val();return "undefined"==typeof jData?thisInstance.chartData=jData:(thisInstance.chartData=JSON.parse(jData),thisInstance.chartData)},positionNoDataMsg:function positionNoDataMsg(){var container=this.getContainer(),widgetContentsContainer=container.find(".dashboardWidgetContent"),noDataMsgHolder=widgetContentsContainer.find(".noDataMsg");noDataMsgHolder.position({my:"center center",at:"center center",of:widgetContentsContainer});},/**
		 * Print html content as image
		 * @param {jQuery} element
		 */printHtml:function printHtml(element){var _this2=this,widget=element.closest(".dashboardWidget"),title=widget.find(".dashboardTitle").prop("title"),printContainer=widget.find(".js-print__container").get(0),imgEl=$("<img style=\"width:100%\">");imgEl.get(0).onload=function(){var width=$(printContainer).outerWidth(),height=$(printContainer).outerHeight();600>width&&(width=600),400>height&&(height=400),_this2.printImage(imgEl.get(0),title,width,height);},app.htmlToImage(printContainer,function(imageBase64){imgEl.get(0).src=imageBase64;});},/**
		 * Download html content as image
		 * @param {jQuery} element
		 */downloadHtmlAsImage:function downloadHtmlAsImage(element){var widget=element.closest(".dashboardWidget"),title=widget.find(".dashboardTitle").prop("title");app.htmlToImage(widget.find(".js-print__container").get(0),function(imageBase64){var anchor=document.createElement("a");anchor.setAttribute("href",imageBase64),anchor.setAttribute("download",title+".png"),anchor.click();});},//Place holdet can be extended by child classes and can use this to handle the post load
postLoadWidget:function postLoadWidget(){this.isEmptyData()?this.positionNoDataMsg():this.loadChart(this.options),this.registerSectionClick(),this.registerFilter(),this.registerFilterChangeEvent(),this.restrictContentDrag(),this.registerWidgetSwitch(),this.registerChangeSorting(),this.registerLoadMore(),this.registerHeaderButtons(),this.loadScrollbar();},postRefreshWidget:function postRefreshWidget(){this.loadScrollbar(),this.isEmptyData()?this.positionNoDataMsg():this.loadChart(this.options),this.registerSectionClick(),this.registerLoadMore();},setSortingButton:function setSortingButton(currentElement){if(currentElement.length){var container=this.getContainer(),drefresh=container.find(".js-widget-refresh"),url=drefresh.data("url");url=url.replace("&sortorder=desc",""),url=url.replace("&sortorder=asc",""),url+="&sortorder=";var sort=currentElement.data("sort"),sortorder="desc",icon="fa-sort-amount-down",iconBase="fa-sort-amount-up";"desc"==sort&&(sortorder="asc",icon="fa-sort-amount-up",iconBase="fa-sort-amount-down"),currentElement.data("sort",sortorder),currentElement.attr("title",currentElement.data(sortorder)),currentElement.attr("alt",currentElement.data(sortorder)),url+=sortorder,currentElement.find(".fas").removeClass(iconBase).addClass(icon),drefresh.data("url",url);}},getChartImage:function getChartImage(){var base64Image=this.chartInstance.toBase64Image(),image=new Image;return image.src=base64Image,image},printImage:function printImage(imgEl,title,width,height){var print=window.open("","PRINT","height="+height+",width="+width);// necessary for IE >= 10
// necessary for IE >= 10
print.document.write("<html><head><title>"+title+"</title>"),print.document.write("</head><body >"),print.document.write($("<div>").append(imgEl).html()),print.document.write("</body></html>"),print.document.close(),print.focus(),setTimeout(function(){print.print(),print.close();},1e3);},registerHeaderButtons:function registerHeaderButtons(){var _this3=this,container=this.getContainer(),header=container.find(".dashboardWidgetHeader"),downloadWidget=header.find(".downloadWidget"),printWidget=header.find(".printWidget");printWidget.on("click",function(e){var imgEl=_this3.getChartImage();_this3.printImage(imgEl,header.find(".dashboardTitle").text(),600,400);}),downloadWidget.on("click",function(e){var imgEl=$(_this3.getChartImage()),a=$("<a>").attr("href",imgEl.attr("src")).attr("download",header.find(".js-widget__header__title").text()+".png").appendTo(container);a[0].click(),a.remove();}),container.find(".js-widget-quick-create").on("click",function(e){App.Components.QuickCreate.createRecord($(this).data("module-name"));});},registerChangeSorting:function registerChangeSorting(){var thisInstance=this,container=this.getContainer();thisInstance.setSortingButton(container.find(".changeRecordSort")),container.find(".changeRecordSort").on("click",function(e){var drefresh=container.find(".js-widget-refresh");thisInstance.setSortingButton(jQuery(e.currentTarget)),drefresh.click();});},registerWidgetSwitch:function registerWidgetSwitch(){var thisInstance=this,switchButtons=this.getContainer().find(".dashboardWidgetHeader .js-switch--calculations");thisInstance.setUrlSwitch(switchButtons),switchButtons.on("change",function(e){var currentElement=$(e.currentTarget),dashboardWidgetHeader=currentElement.closest(".dashboardWidgetHeader"),drefresh=dashboardWidgetHeader.find(".js-widget-refresh");thisInstance.setUrlSwitch(currentElement).done(function(data){data&&drefresh.click();});});},setUrlSwitch:function setUrlSwitch(switchButtons){var aDeferred=jQuery.Deferred();return switchButtons.each(function(index,e){var currentElement=jQuery(e),dashboardWidgetHeader=currentElement.closest(".dashboardWidgetHeader"),drefresh=dashboardWidgetHeader.find(".js-widget-refresh"),url=drefresh.data("url"),urlparams=currentElement.data("urlparams");if(""!==urlparams){var switchUrl=currentElement.data("url-value");url=url.replace("&"+urlparams+"="+switchUrl,""),url+="&"+urlparams+"="+switchUrl,drefresh.data("url",url),aDeferred.resolve(!0);}else aDeferred.reject();}),aDeferred.promise()},getFilterData:function getFilterData(){return {}},/**
		 * Refresh widget
		 * @returns {undefined}
		 */refreshWidget:function refreshWidget(){var thisInstance=this,parent=this.getContainer(),element=parent.find(".js-widget-refresh"),url=element.data("url"),contentContainer=parent.find(".dashboardWidgetContent"),params=url,widgetFilters=parent.find(".widgetFilter");0<widgetFilters.length&&(params={},params.url=url,params.data={},widgetFilters.each(function(index,domElement){var widgetFilter=$(domElement),filterName=widgetFilter.attr("name");params.data[filterName]="checkbox"===widgetFilter.attr("type")?widgetFilter.is(":checked"):widgetFilter.val();}));var additionalWidgetFilters=parent.find(".js-chartFilter__additional-filter-field");0<additionalWidgetFilters.length&&(params={},params.url=url,params.data={},additionalWidgetFilters.each(function(index,domElement){var widgetFilter=jQuery(domElement),filterName=widgetFilter.attr("name"),arr=!1;"[]"===filterName.substr(-2)&&(arr=!0,filterName=filterName.substr(0,filterName.length-2),!Array.isArray(params.data[filterName])&&(params.data[filterName]=[])),"checkbox"===widgetFilter.attr("type")?arr?params.data[filterName].push(widgetFilter.is(":checked")):params.data[filterName]=widgetFilter.is(":checked"):arr?params.data[filterName].push(widgetFilter.val()):params.data[filterName]=widgetFilter.val();}));var refreshContainer=parent.find(".dashboardWidgetContent"),refreshContainerFooter=parent.find(".dashboardWidgetFooter");refreshContainer.html(""),refreshContainerFooter.html(""),refreshContainer.progressIndicator(),this.paramCache&&(additionalWidgetFilters.length||widgetFilters.length||parent.find(".listSearchContributor"))&&thisInstance.setFilterToCache(params.url?params.url:params,params.data?params.data:{}),AppConnector.request(params).done(function(data){data=$(data);var footer=data.filter(".widgetFooterContent");refreshContainer.progressIndicator({mode:"hide"}),footer.length&&(footer=footer.clone(!0,!0),refreshContainerFooter.html(footer),data.each(function(n,e){jQuery(this).hasClass("widgetFooterContent")&&data.splice(n,1);})),contentContainer.html(data).trigger(YetiForce_Widget_Js.widgetPostRefereshEvent);}).fail(function(){refreshContainer.progressIndicator({mode:"hide"});});},registerFilter:function registerFilter(){var container=this.getContainer(),search=container.find(".listSearchContributor"),refreshBtn=container.find(".js-widget-refresh"),originalUrl=refreshBtn.data("url"),selects=container.find(".select2noactive");search.css("width","100%"),search.parent().addClass("w-100"),search.each(function(index,element){var fieldInfo=$(element).data("fieldinfo");$(element).attr("placeholder",fieldInfo.label).data("placeholder",fieldInfo.label);}),App.Fields.Picklist.changeSelectElementView(selects,"select2",{containerCssClass:"form-control"}),App.Fields.Date.register(container),App.Fields.Date.registerRange(container),App.Fields.DateTime.register(container),search.on("change apply.daterangepicker",function(e){var searchParams=[];container.find(".listSearchContributor").each(function(index,domElement){var searchInfo=[],searchContributorElement=$(domElement),fieldInfo=searchContributorElement.data("fieldinfo"),fieldName=searchContributorElement.attr("name"),searchValue=searchContributorElement.val();if("object"===_typeof(searchValue)?null==searchValue?searchValue="":searchValue=searchValue.join("##"):0<=$.inArray(fieldInfo.type,["tree"])&&(searchValue=searchValue.replace(/,/g,"##")),searchValue=searchValue.trim(),0>=searchValue.length)//continue
return !0;var searchOperator="a";if(fieldInfo.hasOwnProperty("searchOperator")?searchOperator=fieldInfo.searchOperator:0<=jQuery.inArray(fieldInfo.type,["modules","time","userCreator","owner","picklist","tree","boolean","fileLocationType","userRole","multiReferenceValue","currencyList"])?searchOperator="e":"date"===fieldInfo.type||"datetime"===fieldInfo.type?searchOperator="bw":("multipicklist"===fieldInfo.type||"categoryMultipicklist"===fieldInfo.type)&&(searchOperator="c"),searchInfo.push(fieldName),searchInfo.push(searchOperator),searchInfo.push(searchValue),-1!=$.inArray(fieldInfo.type,["tree","categoryMultipicklist"])){var searchInSubcategories=$(".listViewHeaders .searchInSubcategories[data-columnname=\""+fieldName+"\"]").prop("checked");searchInSubcategories&&(searchOperator="ch");}searchParams.push(searchInfo);});var url=originalUrl+"&search_params="+JSON.stringify([searchParams]);refreshBtn.data("url",url),refreshBtn.trigger("click");});},registerFilterChangeEvent:function registerFilterChangeEvent(){var container=this.getContainer();container.on("change",".widgetFilter",function(e){container.find(".js-widget-refresh").trigger("click");}),container.find(".widgetFilterByField").length&&(App.Fields.Picklist.showSelect2ElementView(container.find(".select2noactive")),this.getContainer().on("change",".widgetFilterByField .form-control",function(e){container.find(".js-widget-refresh").trigger("click");}));},registerWidgetPostLoadEvent:function registerWidgetPostLoadEvent(container){var thisInstance=this;container.on(YetiForce_Widget_Js.widgetPostLoadEvent,function(e){thisInstance.postLoadWidget();});},registerWidgetPostRefreshEvent:function registerWidgetPostRefreshEvent(container){var thisInstance=this;container.off(YetiForce_Widget_Js.widgetPostRefereshEvent),container.on(YetiForce_Widget_Js.widgetPostRefereshEvent,function(e){thisInstance.postRefreshWidget();});},registerSectionClick:function registerSectionClick(){var thisInstance=this,pointer=!1;$(thisInstance.chartInstance.canvas).on("click",function(e){"undefined"!=typeof thisInstance.getDataFromEvent(e,["links"]).links&&(window.location.href=thisInstance.getDataFromEvent(e,["links"]).links);}).on("mousemove",function(e){"undefined"==typeof thisInstance.getDataFromEvent(e,["links"]).links?pointer&&($(this).css("cursor","auto"),pointer=!1):!pointer&&($(this).css("cursor","pointer"),pointer=!0);}).on("mouseout",function(){pointer&&($(this).css("cursor","auto"),pointer=!1);});},registerLoadMore:function registerLoadMore(){var thisInstance=this,parent=thisInstance.getContainer(),contentContainer=parent.find(".dashboardWidgetContent");contentContainer.off("click",".showMoreHistory"),contentContainer.on("click",".showMoreHistory",function(e){var element=jQuery(e.currentTarget);element.hide();var parent=jQuery(e.delegateTarget).closest(".dashboardWidget");jQuery(parent).find(".slimScrollDiv").css("overflow","visible");var url=element.data("url")+"&content=true",additionalFilter=parent.find(".widgetFilter");0<additionalFilter.length&&additionalFilter.each(function(){url+="&"+$(this).attr("name")+"="+$(this).val();}),0<parent.find(".changeRecordSort").length&&(url+="&sortorder="+parent.find(".changeRecordSort").data("sort")),contentContainer.progressIndicator(),AppConnector.request(url).done(function(data){contentContainer.progressIndicator({mode:"hide"}),jQuery(parent).find(".dashboardWidgetContent").append(data),element.parent().remove(),thisInstance.postRefreshWidget();});});},setFilterToCache:function setFilterToCache(url,data){var paramCache=url,container=this.getContainer();for(var i in paramCache=paramCache.replace("&content=","&notcontent="),data)"object"==_typeof(data[i])&&(data[i]=JSON.stringify(data[i])),paramCache+="&"+i+"="+data[i];var userId=CONFIG.userId,name=container.attr("id");app.cacheSet(name+"_"+userId,paramCache);},registerCache:function registerCache(container){1==container.data("cache")&&(this.paramCache=!0);},/**
		 * Load and display chart into the view
		 *
		 * @return {Chart} chartInstance
		 */loadChart:function loadChart(){var _this4=this;if("undefined"==typeof this.chartData||"undefined"==typeof this.getChartContainer())return !1;this.getWidgetData();// load widget data for label formatters
var type=this.getType(),data=this.generateData();data.datasets=this.loadDatasetOptions(data);var options=this.parseOptions(this.loadBasicOptions(data)),plugins=this.parseOptions(this.loadPlugins(data));data=this.parseOptions(data);var chart=this.chartInstance=new Chart(this.getChartContainer().getContext("2d"),{type:type,data:data,options:options,plugins:plugins});// parse chart one more time after it was mounted - some options need to have chart loaded
return data.datasets=data.datasets.map(function(dataset,index){return dataset.datasetIndex=index,_this4.parseOptions(dataset,dataset,!0)}),chart},/**
		 * Get data from event like mouse hover,click etc - get data which belongs to pointed element
		 *
		 * @param {Object} e
		 * @param {array} additionalFields if element from event have additional
		 * array in dataset like links for data then additionalFields will look like ['links']
		 * @returns {object} {label,value,...additionalFields}
		 */getDataFromEvent:function getDataFromEvent(e,additionalFields){var chart=this.chartInstance,elements=chart.getElementAtEvent(e);if(0===elements.length)return !1;var element=elements[0],dataIndex=element._index,datasetIndex=element._datasetIndex,eventData={label:chart.data.labels[dataIndex],value:chart.data.datasets[0].data[dataIndex]};return "undefined"!=typeof additionalFields&&Array.isArray(additionalFields)&&additionalFields.forEach(function(fieldName){"undefined"!=typeof chart.data.datasets[datasetIndex][fieldName]&&"undefined"!=typeof chart.data.datasets[datasetIndex][fieldName][dataIndex]&&(eventData[fieldName]=chart.data.datasets[datasetIndex][fieldName][dataIndex]);}),eventData},/**
		 * Get default chart options for current chart subtype
		 * basic and tooltip options share the same space
		 *
		 * @param  {Object} chartData
		 * @return {Object} merged options
		 */loadBasicOptions:function loadBasicOptions(chartData){return this.formatTooltipTitles(chartData),this.formatTooltipLabels(chartData),this.mergeOptions(this.getBasicOptions(chartData),this.getDefaultBasicOptions(this.getSubType(),chartData))},/**
		 * Apply default dataset options (usually datalabels configuration)
		 *
		 * @param {object} chartData from request
		 * @returns {object} chartData
		 */loadDatasetOptions:function loadDatasetOptions(chartData){var _this5=this;return chartData.datasets.map(function(dataset,index){var result=_this5.mergeOptions(dataset,_this5.getDatasetOptions(chartData),_this5.getDefaultDatasetOptions(_this5.getSubType(),chartData));return result})},/**
		 * Load plugins from configuration
		 * @param  {Object} chartData from the request
		 * @return {Object}
		 */loadPlugins:function loadPlugins(chartData){return this.mergeOptionsArray(this.getPlugins(chartData),this.getDefaultPlugins(this.getSubType(),chartData))},/**
		 * Format tooltip titles to user number format and push this modification to titlesFormatted
		 * it is better to parse tooltips at initialization phase than
		 * in tooltip callback which is called after hover
		 *
		 * @param {object} data - data from request
		 * @returns {undefined}
		 */formatTooltipTitles:function formatTooltipTitles(data){var _this6=this;data.datasets.forEach(function(dataset){"undefined"==typeof dataset.titlesFormatted&&(dataset.titlesFormatted=[],dataset.data.forEach(function(dataItem,index){var defaultLabel=data.labels[index];if(0<String(defaultLabel).length&&!isNaN(Number(defaultLabel))&&("undefined"!=typeof _this6.widgetData&&"undefined"!=typeof _this6.widgetData.valueType&&"count"===_this6.widgetData.valueType?defaultLabel=App.Fields.Double.formatToDisplay(defaultLabel,0):defaultLabel=App.Fields.Double.formatToDisplay(defaultLabel)),"undefined"!=typeof dataset.label){var label=dataset.label;0<String(label).length&&!isNaN(Number(label))&&("undefined"!=typeof _this6.widgetData&&"undefined"!=typeof _this6.widgetData.valueType&&"count"===_this6.widgetData.valueType?label=App.Fields.Double.formatToDisplay(label,0):label=App.Fields.Double.formatToDisplay(label)),defaultLabel+=" ("+label+")";}dataset.titlesFormatted.push(defaultLabel);}));});},/**
		 * Format tooltip titles to user number format and push this modification to titlesFormatted
		 * it is better to parse tooltips at initialization phase than
		 * in tooltip callback which is called after hover
		 *
		 * @param {object} data - data from request
		 * @returns {undefined}
		 */formatTooltipLabels:function formatTooltipTitles(data){var _this7=this;data.datasets.forEach(function(dataset){"undefined"==typeof dataset.dataFormatted&&(dataset.dataFormatted=[],dataset.data.forEach(function(dataItem,index){var dataFormatted=dataItem;0<String(dataItem).length&&!isNaN(Number(dataItem))&&("undefined"!=typeof _this7.widgetData&&"undefined"!=typeof _this7.widgetData.valueType&&"count"===_this7.widgetData.valueType?dataFormatted=App.Fields.Double.formatToDisplay(dataItem,0):dataFormatted=App.Fields.Double.formatToDisplay(dataItem)),dataset.dataFormatted.push(dataFormatted);}));});},/**
		 * Same as mergeOptionsObject but in array ;)
		 * @param  {Array} to
		 * @param  {Array} fromArray
		 * @return {Array}
		 */mergeOptionsArray:function mergeOptionsArray(to,fromArray){var _this8=this;if("undefined"!=typeof to)return to;to=[];var result=fromArray.map(function(from,index){return Array.isArray(from)&&!to.hasOwnProperty(key)?_this8.mergeOptionsArray(to[index],from):"object"===_typeof(from)&&null!==from&&("undefined"==typeof to[index]||"object"===_typeof(to[index])&&null!==to[index])?_this8.mergeOptionsObject(to[index],from):to[index]}).filter(function(item){return "undefined"!=typeof item});return result},/**
		 * Merge options object and do not override existing properties
		 * @param  {Object} to   object to extend
		 * @param  {Object} from copy properties from this object
		 * @return {Object}      mixed properties
		 */mergeOptionsObject:function mergeOptionsObject(to,from){for(var _key in "undefined"==typeof to&&(to={}),from)from.hasOwnProperty(_key)&&(Array.isArray(from[_key])?!to.hasOwnProperty(_key)&&(to[_key]=this.mergeOptionsArray(void 0,from[_key])):"object"!==_typeof(from[_key])||null===from[_key]||to.hasOwnProperty(_key)&&("object"!==_typeof(to[_key])||null===to[_key]||Array.isArray(to[_key]))?!to.hasOwnProperty(_key)&&(to[_key]=from[_key]):to[_key]=this.mergeOptionsObject(to[_key],from[_key]));return to},/**
		 * Merge two objects with options and do not override existing properties
		 *
		 * @param  {Object} to
		 * @param  {Array|arguments} fromArray
		 * @return {object}
		 */mergeOptions:function mergeOptions(){for(var to=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},_len=arguments.length,fromArray=new Array(1<_len?_len-1:0),_key2=1;_key2<_len;_key2++)fromArray[_key2-1]=arguments[_key2];for(var i=0,len=fromArray.length;i<len;i++)"object"!==_typeof(fromArray[i])||Array.isArray(fromArray[i])?app.errorLog(new Error("Options argument should be an object! Chart subType: "+this.getSubType()+" ["+fromArray[i].toString()+"]")):to=this.mergeOptionsObject(to,fromArray[i]);return to},/**
		 * Placeholder for individual chart type options
		 * If you want to customize default options this is the right place - override this method in your class
		 *
		 * @param {object} chartData
		 * @returns {object} chart options
		 */getBasicOptions:function getBasicOptions(chartData){return {responsive:!0,maintainAspectRatio:!1}},/**
		 * Placeholder for individual chart type dataset options
		 *
		 * @param  {object} chartData
		 * @return {Object} datalabels configurations
		 */getDatasetOptions:function getDatasetOptions(chartData){return {}},/**
		 * Placeholder for individual chart type plugins
		 * You can add custom plugins for individual charts by overriding this method
		 * see: http://www.chartjs.org/docs/latest/developers/plugins.html
		 *
		 * @param {object} chartData
		 * @returns {Array|undefined} plugins
		 */getPlugins:function getPlugins(chartData){// do not return anything - undefined
},/**
		 * Get chart type
		 * We don't wan't to override loadChart method (good practice)
		 * so we can extend some chart type and change its type only to show data in different manner.
		 * Get type is used to set up Chartjs chart type.
		 *
		 * @param {object} chartData
		 * @returns {string}
		 */getType:function getType(chartData){return "bar"},/**
		 * Get sub type of a chart.
		 * For example 'bar' is main type and barDivided is a subset of bar with little different options.
		 * By default we are using standard type.
		 * GetSubType is used to get properties - it does not set up Chartjs chart type per se (getType is used for this purpose)
		 *
		 * @param {object}  chartData
		 * @returns {string}
		 */getSubType:function getSubType(chartData){return this.getType()}}),Vtiger_Widget_Js("YetiForce_Widget_Js",{},{}),YetiForce_Widget_Js("YetiForce_Bar_Widget_Js",{},{getType:function getType(){return "bar"}}),YetiForce_Bar_Widget_Js("YetiForce_BarStacked_Widget_Js",{},{getSubType:function getSubType(){return "barStacked"}}),YetiForce_Bar_Widget_Js("YetiForce_Horizontal_Widget_Js",{},{getType:function getType(){return "horizontalBar"}}),YetiForce_Horizontal_Widget_Js("YetiForce_HorizontalStacked_Widget_Js",{},{getType:function getType(){return "horizontalBar"},getSubType:function getSubType(){return "horizontalBarStacked"}}),YetiForce_Widget_Js("YetiForce_Funnel_Widget_Js",{},{getType:function getType(){return "funnel"}}),YetiForce_Widget_Js("YetiForce_Pie_Widget_Js",{},{getType:function getType(){return "pie"}}),YetiForce_Pie_Widget_Js("YetiForce_PieDivided_Widget_Js",{},{getSubType:function getSubType(){return "pieDivided"}}),YetiForce_Pie_Widget_Js("YetiForce_Donut_Widget_Js",{},{getType:function getType(){return "doughnut"}}),YetiForce_Donut_Widget_Js("YetiForce_Axis_Widget_Js",{},{}),YetiForce_Widget_Js("YetiForce_BarDivided_Widget_Js",{},{getType:function getType(){return "bar"},getSubType:function getSubType(){return "barDivided"}}),YetiForce_Widget_Js("YetiForce_Line_Widget_Js",{},{getType:function getType(){return "line"}}),YetiForce_Line_Widget_Js("YetiForce_LineStacked_Widget_Js",{},{getType:function getType(){return "line"},getSubType:function getSubType(){return "lineStacked"}}),YetiForce_Line_Widget_Js("YetiForce_LinePlain_Widget_Js",{},{getSubType:function getSubType(){return "linePlain"}}),YetiForce_LineStacked_Widget_Js("YetiForce_LinePlainStacked_Widget_Js",{},{getSubType:function getSubType(){return "linePlainStacked"}}),YetiForce_Bar_Widget_Js("YetiForce_TicketsByStatus_Widget_Js",{},{getBasicOptions:function getBasicOptions(){return {legend:{display:!0},scales:{xAxes:[{stacked:!0}],yAxes:[{stacked:!0}]}}}}),YetiForce_Widget_Js("YetiForce_Calendar_Widget_Js",{},{calendarView:!1,calendarCreateView:!1,fullCalendar:!1,/**
		 * Register calendar
		 */registerCalendar:function registerCalendar(){var _this9=this,self=this,container=this.getContainer(),userTimeFormat=CONFIG.hourFormat;userTimeFormat=24==userTimeFormat?{hour:"2-digit",minute:"2-digit",hour12:!1,meridiem:!1}:{hour:"numeric",minute:"2-digit",meridiem:"short"};//Default first hour of the day
var defaultFirstHour=app.getMainParams("startHour"),explodedTime=defaultFirstHour.split(":");defaultFirstHour=explodedTime[0];var defaultDate=app.getMainParams("defaultDate");this.paramCache&&defaultDate!=moment().format("YYYY-MM-DD")&&(defaultDate=1==moment(defaultDate).format("D")?moment(defaultDate):moment(defaultDate).add(1,"M")),container.find(".js-widget-quick-create").on("click",function(e){App.Components.QuickCreate.createRecord($(this).data("module-name"));}),this.fullCalendar=new FullCalendar.Calendar(this.getCalendarView().get(0),{headerToolbar:{left:" ",center:"prev title next",right:" "},initialDate:defaultDate,eventTimeFormat:userTimeFormat,slotLabelFormat:userTimeFormat,scrollTime:defaultFirstHour,firstDay:CONFIG.firstDayOfWeekNo,initialView:"dayGridMonth",editable:!1,slotDuration:15,defaultTimedEventDuration:"01:00:00",dayMaxEventRows:!1,allDaySlot:!1,moreLinkContent:app.vtranslate("JS_MORE"),allDayText:app.vtranslate("JS_ALL_DAY"),noEventsText:app.vtranslate("JS_NO_RECORDS"),viewHint:"$0",contentHeight:"auto",buttonText:{today:"",year:app.vtranslate("JS_YEAR"),week:app.vtranslate("JS_WEEK"),month:app.vtranslate("JS_MONTH"),day:app.vtranslate("JS_DAY"),dayGridMonth:app.vtranslate("JS_MONTH"),dayGridWeek:app.vtranslate("JS_WEEK"),listWeek:app.vtranslate("JS_WEEK"),dayGridDay:app.vtranslate("JS_DAY"),timeGridDay:app.vtranslate("JS_DAY")},navLinkHint:function navLinkHint(_dateStr,zonedDate){return App.Fields.Date.dateToUserFormat(zonedDate)},dayHeaderContent:function dayHeaderContent(arg){return App.Fields.Date.daysTranslated[arg.date.getDay()]},titleFormat:function titleFormat(args){return Calendar_Js.monthFormat[CONFIG.dateFormat].replace("YYYY",args.date.year).replace("MMMM",App.Fields.Date.fullMonthsTranslated[args.date.month])},dateClick:function dateClick(args){var date=moment(args.date).format(CONFIG.dateFormat.toUpperCase());App.Components.QuickCreate.createRecord("Calendar",{noCache:!0,data:{date_start:date,due_date:date},callbackFunction:function callbackFunction(){self.getCalendarView().closest(".dashboardWidget").find(".js-widget-refresh").trigger("click");}});},eventClick:function eventClick(info){info.jsEvent.preventDefault();var url=$(info.el).attr("href");if(void 0!==url){var params=[];url+="&viewname="+container.find("select.widgetFilter.customFilter").val();var owner=container.find(".widgetFilter.owner option:selected");if("all"!=owner.val()&&params.push(["assigned_user_id","e",owner.val()]),0<container.find(".widgetFilterSwitch").length){var status=container.find(".widgetFilterSwitch").data();params.push(["activitystatus","e",status[container.find(".widgetFilterSwitch").val()]]);}var date=App.Fields.Date.dateToUserFormat(info.event.start);params.push(["activitytype","e",info.event.extendedProps.activityType],["date_start","bw",date+" 00:00:00,"+date+" 23:59:59"]),url+="&search_params="+encodeURIComponent(JSON.stringify([params])),window.location.href="".concat(url);}}}),this.fullCalendar.render(),this.getCalendarView().find("td.fc-day-top").on("mouseenter",function(){jQuery("<span class=\"plus pull-left fas fa-plus\"></span>").prependTo($(this));}).on("mouseleave",function(){$(this).find(".plus").remove();});var switchBtn=container.find(".js-switch--calendar");switchBtn.on("change",function(e){var currentTarget=$(e.currentTarget);"undefined"==typeof currentTarget.data("on-text")?"undefined"!=typeof currentTarget.data("off-text")&&container.find(".widgetFilterSwitch").val("history"):container.find(".widgetFilterSwitch").val("current"),_this9.refreshWidget();});},/**
		 * Load calendar data
		 */loadCalendarData:function loadCalendarData(){var _this10=this;this.fullCalendar.removeAllEvents();var start_date=App.Fields.Date.dateToUserFormat(this.fullCalendar.view.activeStart),end_date=App.Fields.Date.dateToUserFormat(this.fullCalendar.view.activeEnd),parent=this.getContainer(),user=parent.find(".owner").val();"all"==user&&(user="");var params={module:"Calendar",action:"Calendar",mode:"getEvents",start:start_date,end:end_date,user:user,widget:!0};0<parent.find(".customFilter").length&&(params.customFilter=parent.find(".customFilter").val());var widgetFilterSwitch=parent.find(".widgetFilterSwitch");if(0<widgetFilterSwitch.length){params.time=widgetFilterSwitch.val();var defaultFilter=widgetFilterSwitch.data("default-filter");defaultFilter!==void 0&&(params.customFilter=defaultFilter);}this.paramCache&&this.setFilterToCache(this.getContainer().find(".js-widget-refresh").data("url"),{owner:user,customFilter:params.customFilter,start:start_date}),AppConnector.request(params).done(function(events){_this10.fullCalendar.addEventSource(events.result);});},/**
		 * Get calendar view container
		 * @returns {jQuery}
		 */getCalendarView:function getCalendarView(){return !1===this.calendarView&&(this.calendarView=this.getContainer().find(".js-calendar__container")),this.calendarView},/**
		 * Update month name
		 */getMonthName:function getMonthName(){var month=this.getCalendarView().find(".fc-toolbar h2").text();month&&this.getContainer().find(".headerCalendar .month").html("<h3>"+month+"</h3>");},/**
		 * Register change view
		 */registerChangeView:function registerChangeView(){var thisInstance=this,container=this.getContainer();container.find(".fc-toolbar").addClass("d-none");var month=container.find(".fc-toolbar h2").text();if(month){container.find(".headerCalendar").removeClass("d-none").find(".month").append("<h3>"+month+"</h3>");var button=container.find(".headerCalendar button");button.each(function(){var tag=jQuery(this).data("type");jQuery(this).on("click",function(){thisInstance.getCalendarView().find(".fc-toolbar ."+tag).trigger("click"),thisInstance.loadCalendarData(),thisInstance.getMonthName();});});}},/** @inheritdoc */loadScrollbar:function loadScrollbar(){this.fullCalendar&&this.fullCalendar.updateSize(),this._super();},/** @inheritdoc */postLoadWidget:function postLoadWidget(){this.registerCalendar(),this.loadCalendarData(!0),this.registerChangeView(),this.registerFilterChangeEvent();},/** @inheritdoc */refreshWidget:function refreshWidget(){var thisInstance=this,refreshContainer=this.getContainer().find(".dashboardWidgetContent");refreshContainer.progressIndicator(),thisInstance.loadCalendarData(),refreshContainer.progressIndicator({mode:"hide"});}}),YetiForce_Widget_Js("YetiForce_CalendarActivities_Widget_Js",{},{modalView:!1,postLoadWidget:function postLoadWidget(){this._super(),this.registerActivityChange(),this.registerListViewButton();},postRefreshWidget:function postRefreshWidget(){this._super(),this.registerActivityChange();},registerActivityChange:function registerActivityChange(){var thisInstance=this,refreshContainer=this.getContainer().find(".dashboardWidgetContent");refreshContainer.find(".changeActivity").on("click",function(e){if(!(jQuery(e.target).is("a")||thisInstance.modalView)){var url=jQuery(this).data("url");if("undefined"!=typeof url){var callbackFunction=function callbackFunction(){thisInstance.modalView=!1;};thisInstance.modalView=!0,app.showModalWindow(null,url,callbackFunction);}}});},registerListViewButton:function registerListViewButton(){var thisInstance=this,container=thisInstance.getContainer();container.find(".goToListView").on("click",function(){var status,activitiesStatus=container.data("name");status="OverdueActivities"===activitiesStatus?"PLL_OVERDUE":"CalendarActivities"===activitiesStatus?"PLL_IN_REALIZATION##PLL_PLANNED":"PLL_IN_REALIZATION##PLL_PLANNED##PLL_OVERDUE";var url="index.php?module=Calendar&view=List&viewname=All";url+="&search_params=[[";var owner=container.find(".widgetFilter.owner option:selected");"all"!==owner.val()&&(url+="[\"assigned_user_id\",\"e\",\""+owner.val()+"\"],"),url+="[\"activitystatus\",\"e\",\""+encodeURIComponent(status)+"\"]]]",window.location.href=url;});}}),YetiForce_CalendarActivities_Widget_Js("YetiForce_CreatedNotMineActivities_Widget_Js",{},{}),YetiForce_CalendarActivities_Widget_Js("YetiForce_CreatedNotMineOverdueActivities_Widget_Js",{},{}),YetiForce_CalendarActivities_Widget_Js("YetiForce_OverDueActivities_Widget_Js",{},{}),YetiForce_CalendarActivities_Widget_Js("YetiForce_OverdueActivities_Widget_Js",{},{}),YetiForce_Widget_Js("YetiForce_ProductsSoldToRenew_Widget_Js",{},{modalView:!1,postLoadWidget:function postLoadWidget(){this._super(),this.registerAction(),this.registerListViewButton();},postRefreshWidget:function postRefreshWidget(){this._super(),this.registerAction();},registerAction:function registerAction(){var thisInstance=this,refreshContainer=this.getContainer().find(".dashboardWidgetContent");refreshContainer.find(".rowAction").on("click",function(e){if(!(jQuery(e.target).is("a")||thisInstance.modalView)){var url=jQuery(this).data("url");if("undefined"!=typeof url){var callbackFunction=function callbackFunction(){thisInstance.modalView=!1;};thisInstance.modalView=!0,app.showModalWindow(null,url,callbackFunction);}}});},registerListViewButton:function registerListViewButton(){var thisInstance=this,container=thisInstance.getContainer();container.on("click",".goToListView",function(){var url=jQuery(this).data("url"),orderBy=container.find(".orderby"),sortOrder=container.find(".changeRecordSort");orderBy.length&&(url+="&orderby="+orderBy.val()),sortOrder.length&&(url+="&sortorder="+sortOrder.data("sort").toUpperCase()),window.location.href=url;});}}),YetiForce_ProductsSoldToRenew_Widget_Js("YetiForce_ServicesSoldToRenew_Widget_Js",{},{}),YetiForce_Bar_Widget_Js("YetiForce_AllTimeControl_Widget_Js",{},{getBasicOptions:function getBasicOptions(){return {legend:{display:!0},scales:{yAxes:[{stacked:!0,ticks:{callback:function formatYAxisTick(value,index,values){return app.formatToHourText(value,"short",!1,!1)}}}],xAxes:[{stacked:!0,ticks:{minRotation:0}}]},tooltips:{callbacks:{label:function label(tooltipItem,data){return data.datasets[tooltipItem.datasetIndex].original_label+": "+data.datasets[tooltipItem.datasetIndex].dataFormatted[tooltipItem.index]},title:function title(tooltipItems,data){return data.fullLabels[tooltipItems[0].index]}}}}},getDatasetOptions:function getDatasetOptions(dataset,type,datasetIndex){return {datalabels:{formatter:function datalabelsFormatter(value,context){return context.dataset.dataFormatted[context.dataIndex]}}}}}),YetiForce_Bar_Widget_Js("YetiForce_LeadsBySource_Widget_Js",{},{}),YetiForce_Pie_Widget_Js("YetiForce_ClosedTicketsByPriority_Widget_Js",{},{}),YetiForce_Bar_Widget_Js("YetiForce_ClosedTicketsByUser_Widget_Js",{},{}),YetiForce_Bar_Widget_Js("YetiForce_OpenTickets_Widget_Js",{},{}),YetiForce_Bar_Widget_Js("YetiForce_AccountsByIndustry_Widget_Js",{},{}),YetiForce_Funnel_Widget_Js("YetiForce_EstimatedvalueByStatus_Widget_Js",{},{getBasicOptions:function getBasicOptions(){return {sort:"data-desc"}},getPlugins:function getPlugins(){return []}}),YetiForce_Bar_Widget_Js("YetiForce_NotificationsBySender_Widget_Js",{},{}),YetiForce_Bar_Widget_Js("YetiForce_NotificationsByRecipient_Widget_Js",{},{}),YetiForce_Bar_Widget_Js("YetiForce_TeamsEstimatedSales_Widget_Js",{},{generateChartData:function generateChartData(){var yMaxValue,index,parseData,thisInstance=this,container=this.getContainer(),jData=container.find(".widgetData").val(),data=JSON.parse(jData),chartData=[[],[],[],[]];if(data.hasOwnProperty("compare"))for(index in data)parseData=thisInstance.parseChartData(data[index],chartData),chartData[0].push(parseData[0]),chartData[3].push(parseData[3]),chartData=[chartData[0],parseData[1],parseData[2],chartData[3],["#CC6600","#208CB3"]];else parseData=thisInstance.parseChartData(data,chartData),chartData=[[parseData[0]],parseData[1],parseData[2],[parseData[3]],["#208CB3"]];return yMaxValue=chartData[1],yMaxValue=yMaxValue+2+25*(yMaxValue/100),{chartData:chartData[0],yMaxValue:yMaxValue,labels:chartData[2],data_labels:chartData[3],placement:"inside",location:"n",colors:chartData[4]}},parseChartData:function parseChartData(data,chartDataGlobal){var chartData=[],xLabels=[],sum=0;for(var index in data){var row=data[index];row[0]=parseInt(row[0]),sum+=row[0],xLabels.push(app.getDecodedValue(row[1])),chartData.push(row[0]),parseInt(row[0])>chartDataGlobal[1]&&(chartDataGlobal[1]=parseInt(row[0]));}return [chartData,chartDataGlobal[1],xLabels,"&nbsp; \u03A3 "+sum+"&nbsp;"]},registerSectionClick:function registerSectionClick(){var url,container=this.getContainer(),data=container.find(".widgetData").val(),dataInfo=JSON.parse(data),compare=dataInfo&&dataInfo.hasOwnProperty("compare");this.getContainer().off("jqplotDataClick").on("jqplotDataClick",function(ev,seriesIndex,pointIndex,args){url=seriesIndex?dataInfo.compare[pointIndex][2]:compare?dataInfo[0][pointIndex][2]:dataInfo[pointIndex][2],window.location.href=url;});}}),YetiForce_TeamsEstimatedSales_Widget_Js("YetiForce_ActualSalesOfTeam_Widget_Js",{},{}),YetiForce_Widget_Js("YetiForce_History_Widget_Js",{},{postLoadWidget:function postLoadWidget(){this._super(),this.registerLoadMore();},postRefreshWidget:function postRefreshWidget(){this._super(),this.registerLoadMore();},registerLoadMore:function registerLoadMore(){var thisInstance=this,parent=thisInstance.getContainer(),contentContainer=parent.find(".dashboardWidgetContent"),loadMoreHandler=contentContainer.find(".load-more");loadMoreHandler.on("click",function(){var parent=thisInstance.getContainer(),element=parent.find(".js-widget-refresh"),url=element.data("url"),params=url,widgetFilters=parent.find(".widgetFilter");0<widgetFilters.length&&(params={url:url,data:{}},widgetFilters.each(function(index,domElement){var widgetFilter=jQuery(domElement),filterName=widgetFilter.attr("name"),filterValue=widgetFilter.val();params.data[filterName]=filterValue;}));var filterData=thisInstance.getFilterData();jQuery.isEmptyObject(filterData)||("string"==typeof params&&(params={url:url,data:{}}),params.data=jQuery.extend(params.data,thisInstance.getFilterData())),params.data.page=loadMoreHandler.data("nextpage");var refreshContainer=parent.find(".dashboardWidgetContent");refreshContainer.progressIndicator(),AppConnector.request(params).done(function(data){refreshContainer.progressIndicator({mode:"hide"}),loadMoreHandler.replaceWith(data),thisInstance.registerLoadMore();}).fail(function(){refreshContainer.progressIndicator({mode:"hide"});});});}}),YetiForce_Widget_Js("YetiForce_MiniList_Widget_Js",{},{postLoadWidget:function postLoadWidget(){this.restrictContentDrag(),this.registerFilter(),this.registerFilterChangeEvent(),this.registerRecordsCount();},postRefreshWidget:function postRefreshWidget(){this.registerRecordsCount();}}),YetiForce_Widget_Js("YetiForce_UpcomingEvents_Widget_Js",{},{postLoadWidget:function postLoadWidget(){this.registerFilterChangeEvent();}}),YetiForce_Widget_Js("YetiForce_Notebook_Widget_Js",{},{// Override widget specific functions.
postLoadWidget:function postLoadWidget(){this.registerNotebookEvents();},registerNotebookEvents:function registerNotebookEvents(){var _this11=this;this.container.on("click",".dashboard_notebookWidget_edit",function(){_this11.editNotebookContent();}),this.container.on("click",".dashboard_notebookWidget_save",function(){_this11.saveNotebookContent();});},editNotebookContent:function editNotebookContent(){$(".dashboard_notebookWidget_view",this.container).hide();var editContainer=$(".dashboard_notebookWidget_text",this.container).show(),editTextArea=editContainer.find("textarea");editTextArea.css("height",this.container.innerHeight()-this.container.find(".dashboardWidgetHeader").innerHeight()-editTextArea.prev().innerHeight()-16);},saveNotebookContent:function saveNotebookContent(){var _this12=this,textarea=$(".dashboard_notebookWidget_textarea",this.container),url=this.container.data("url"),params=url+"&content=true&mode=save&contents="+encodeURIComponent(textarea.val()),refreshContainer=this.container.find(".dashboardWidgetContent");refreshContainer.progressIndicator(),AppConnector.request(params).done(function(data){refreshContainer.progressIndicator({mode:"hide"}),$(".dashboardWidgetContent",_this12.container).html(data);});}}),YetiForce_Widget_Js("YetiForce_KpiBar_Widget_Js",{},{generateChartData:function generateChartData(){var container=this.getContainer(),jData=container.find(".widgetData").val(),data=JSON.parse(jData),chartData=[],xLabels=[],yMaxValue=0;return {chartData:[[[data.result,data.all]]],yMaxValue:data.maxValue,labels:""}},loadChart:function loadChart(){var data=this.generateChartData();this.getChartContainer(!1).jqplot(data.chartData,{animate:!$.jqplot.use_excanvas,seriesDefaults:{renderer:jQuery.jqplot.BarRenderer,rendererOptions:{showDataLabels:!0,dataLabels:"value",barDirection:"horizontal"}},axes:{xaxis:{min:0,max:data.yMaxValue},yaxis:{renderer:jQuery.jqplot.CategoryAxisRenderer}}});}}),YetiForce_Widget_Js("YetiForce_ChartFilter_Widget_Js",{},{chartfilterInstance:!1,init:function init(container,reload,widgetClassName){this.setContainer(jQuery(container));var chartClassName=container.find("[name=\"typeChart\"]").val(),stacked=!!Number(container.find("[name=\"stacked\"]").val());if(stacked&&(chartClassName+="Stacked"),this.chartfilterInstance=YetiForce_Widget_Js.getInstance(container,chartClassName),this.chartfilterInstance){var filterIdsStr=container.find("[name=\"filterIds\"]").val();filterIdsStr&&(this.chartfilterInstance.filterIds=JSON.parse(filterIdsStr));}this.registerRecordsCount(),this.registerCache(container);}}),YetiForce_Widget_Js("YetiForce_Multifilter_Widget_Js",{},{multifilterControlsView:!1,multifilterContentView:!1,multifilterSettingsView:!1,registerSubmit:function registerSubmit(){var _this13=this;this.getContainer().find(".js-multifilter-save").on("click",function(e){var progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0}}),widgetId=_this13.getMultifilterControls().attr("data-widgetid"),actions=_this13.getContainer().find(".js-select").val();AppConnector.request({action:"Widget",mode:"updateWidgetConfig",module:app.getModuleName(),widgetid:widgetId,widgetData:{customMultiFilter:actions}}).done(function(_){progressIndicatorElement.progressIndicator({mode:"hide"}),_this13.refreshWidget();});});},loadData:function loadData(){var _this14=this,widgetId=this.getMultifilterControls().attr("data-widgetid"),multifilterIds=this.getMultifilterSettings().find(".js-select option:selected"),params=[];this.getMultifilterContent().html(""),$.each(multifilterIds,function(i,e){var element=$(e),existFilter=_this14.getMultifilterContent().find("[data-id=\""+element.val()+"\"]");return !!(0<existFilter.length)||void params.push({module:element.data("module"),modulename:element.data("module"),view:"ShowWidget",name:"Multifilter",content:!0,widget:!0,widgetid:widgetId,filterid:element.val()})}),this.loadListData(params);},loadListData:function loadListData(params){if(!params.length)return !1;var self=this,multiFilterContent=self.getMultifilterContent(),param=params.shift();AppConnector.request(param).done(function(data){self.getMultifilterSettings().find("option[value=\""+param.filterid+"\"]").is(":selected")&&!multiFilterContent.find(".detailViewTable[data-id=\""+param.filterid+"\"]").length&&(self.registerRecordsCount(multiFilterContent.append(data).children("div:last-child")),self.registerShowHideBlocks(),self.loadListData(params));}).fail(function(error){app.errorLog(error),self.loadListData(params);});},registerShowHideModuleSettings:function registerShowHideModuleSettings(){var _this15=this;this.getMultifilterControls().find(".js-widget-settings").on("click",function(){_this15.getMultifilterSettings().toggleClass("d-none");});},registerShowHideBlocks:function registerShowHideBlocks(){var detailContentsHolder=this.getMultifilterContent();detailContentsHolder.find(".blockHeader").off("click"),detailContentsHolder.find(".blockHeader").click(function(){var currentTarget=$(this).find(".js-block-toggle").not(".d-none"),closestBlock=currentTarget.closest(".js-toggle-panel"),bodyContents=closestBlock.find(".blockContent"),data=currentTarget.data(),hideHandler=function hideHandler(){bodyContents.addClass("d-none");},showHandler=function showHandler(){bodyContents.removeClass("d-none");};"show"==data.mode?(hideHandler(),currentTarget.addClass("d-none"),closestBlock.find("[data-mode=\"hide\"]").removeClass("d-none")):(showHandler(),currentTarget.addClass("d-none"),closestBlock.find("[data-mode='show']").removeClass("d-none"));});},registerRecordsCount:function registerRecordsCount(container){var url=container.data("url");AppConnector.request(url).done(function(data){container.find(".js-count").html(data.result.totalCount);});},getMultifilterControls:function getMultifilterControls(){return !1==this.multifilterControlsView&&(this.multifilterControlsView=this.getContainer().find(".js-multifilterControls")),this.multifilterControlsView},getMultifilterContent:function getMultifilterContent(){return !1==this.multifilterContentView&&(this.multifilterContentView=this.getContainer().find(".js-multifilterContent")),this.multifilterContentView},getMultifilterSettings:function getMultifilterSettings(){return !1==this.multifilterSettingsView&&(this.multifilterSettingsView=this.getContainer().find(".js-settings-widget")),this.multifilterSettingsView},postLoadWidget:function postLoadWidget(){this.loadData(),this.registerSubmit(),this.registerShowHideModuleSettings();},refreshWidget:function refreshWidget(){this.loadData();}}),YetiForce_Widget_Js("YetiForce_UpcomingProjectTasks_Widget_Js",{},{postLoadWidget:function postLoadWidget(){this._super(),this.registerListViewButton();},registerListViewButton:function registerListViewButton(){var container=this.getContainer();container.find(".goToListView").on("click",function(){var url="index.php?module=ProjectTask&view=List&viewname=All";url+="&search_params=[[";var owner=container.find(".widgetFilter.owner option:selected");"all"!==owner.val()&&(url+="[\"assigned_user_id\",\"e\",\""+owner.val()+"\"],"),url+="[\"projecttaskstatus\",\"e\",\""+encodeURIComponent(container.find("[name=\"status\"]").data("value"))+"\"]]]",app.openUrl(url);});}}),YetiForce_UpcomingProjectTasks_Widget_Js("YetiForce_CompletedProjectTasks_Widget_Js",{},{}),YetiForce_Widget_Js("YetiForce_Updates_Widget_Js",{},{postLoadWidget:function postLoadWidget(){this._super(),this.registerEvents(),this.registerLoadMore();},postRefreshWidget:function postRefreshWidget(){this._super(),this.registerContentEvents(this.getContainer()),app.registerPopoverEllipsisIcon(this.getContainer().find(".js-popover-tooltip--ellipsis-icon"));},registerEvents:function registerEvents(){var container=this.getContainer(),self=this,modalContainer=container.find(".js-update-widget-modal");app.registerPopoverEllipsisIcon(container.find(".js-popover-tooltip--ellipsis-icon")),container.find(".js-update-widget-button").on("click",function(){var modal=modalContainer.clone(!0),widgetData=JSON.parse(container.find(".js-widget-data").val());if(widgetData){for(var i in widgetData.actions)modal.find(".js-tracker-action[value=\""+widgetData.actions[i]+"\"]").prop("checked",!0);modal.find("[name=\"owner\"]").val(widgetData.owner),modal.find("[name=\"historyOwner\"]").val(widgetData.historyOwner);}App.Fields.Picklist.showSelect2ElementView(modal.find("select")),app.showModalWindow(modal,function(data){self.registerSubmit(data);});}),this.registerContentEvents(container);},registerSubmit:function registerSubmit(data){var _this16=this;data.find(".js-modal__save").on("click",function(e){var progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0}}),actions=[];$.each(data.find(".js-tracker-action:checked"),function(){actions.push($(this).val());}),AppConnector.request({action:"Widget",mode:"saveUpdatesWidgetConfig",module:"ModTracker",widgetId:_this16.getContainer().find(".js-widget-id").val(),trackerActions:actions,owner:data.find("[name=\"owner\"]").val(),historyOwner:data.find("[name=\"historyOwner\"]").val()}).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),_this16.refreshWidget(),app.hideModalWindow();});});},registerContentEvents:function registerContentEvents(){var _this17=this,container=this.getContainer();$(".js-history-detail",container).on("click",function(e){var actionId=e.currentTarget.dataset.action,widgetData=JSON.parse(container.find(".js-widget-data").val()),progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0}}),params={view:"UpdatesDetail",module:"ModTracker",widgetId:_this17.getContainer().find(".js-widget-id").val(),trackerAction:e.currentTarget.dataset.action,sourceModule:e.currentTarget.dataset.module,owner:widgetData.owner,historyOwner:widgetData.historyOwner,dateRange:container.find("[name=\"dateRange\"]").val(),page:1};AppConnector.request(params).done(function(modal){progressIndicatorElement.progressIndicator({mode:"hide"}),app.showModalWindow(modal,function(data){data.on("click",".showMoreHistory",function(e){AppConnector.request(e.currentTarget.dataset.url).done(function(result){$(e.target).parent().remove(),data.find(".modal-body").append($(result).filter(".modal-body").get(0).childNodes);});});});}).fail(function(error){progressIndicatorElement.progressIndicator({mode:"hide"}),app.errorLog(error);});});}}),YetiForce_Widget_Js("YetiForce_TimeCounter_Widget_Js",{},{/** @type {number} Hours of the timer */hr:0,/** @type {number} Timer minutes */min:0,/** @type {number} Seconds of the timer */sec:0,/** @type {boolean} Starting a timer */counter:!0,/** @type {(string|number)} Time to start work */timeStart:"",/** @type {(string|number)} End of work time */timeStop:"",/**
		 * Show quick create form
		 */postLoadWidget:function postLoadWidget(){this._super(),this.registerNavigatorButtons();},/**
		 * Register events on the navigation buttons.
		 */registerNavigatorButtons:function registerNavigatorButtons(){var _this18=this,container=this.getContainer(),btnStart=container.find(".js-time-counter-start"),btnStop=container.find(".js-time-counter-stop"),btnReset=container.find(".js-time-counter-reset"),navigatorButtons=container.find(".js-navigator-buttons"),btnMinutes=container.find(".js-time-counter-minute");btnStart.on("click",function(){navigatorButtons.addClass("active"),btnStart.addClass("d-none"),btnStop.removeClass("d-none"),btnReset.removeClass("d-none"),btnMinutes.attr("disabled",!0),btnMinutes.removeClass("btn-outline-success"),btnMinutes.addClass("btn-outline-danger"),_this18.startTimerCounter();}),btnStop.on("click",function(){_this18.stopTimerCounter(!1);}),btnReset.on("click",function(){navigatorButtons.removeClass("active"),btnReset.addClass("d-none"),btnStop.addClass("d-none"),btnStart.removeClass("d-none"),btnMinutes.attr("disabled",!1),btnMinutes.removeClass("btn-outline-danger"),btnMinutes.addClass("btn-outline-success"),_this18.resetTimerCounter();}),1<btnMinutes.length&&btnMinutes.on("click",function(e){_this18.counter=!1;var element=$(e.currentTarget);_this18.min=element.data("value");var dateEnd=new Date,hours=(10>dateEnd.getHours()?"0":"")+dateEnd.getHours(),minutes=(10>dateEnd.getMinutes()?"0":"")+dateEnd.getMinutes();_this18.timeStop=hours+":"+minutes,_this18.stopTimerCounter(!0);});},/**
		 * Time counting starts
		 */startTimerCounter:function startTimerCounter(){var dateStart=new Date,hours=(10>dateStart.getHours()?"0":"")+dateStart.getHours(),minutes=(10>dateStart.getMinutes()?"0":"")+dateStart.getMinutes();this.timeStart=hours+":"+minutes,!0===this.counter&&(this.counter=!1,this.timeCounter());},/**
		 * Time counting ends.
		 * @param {boolean} $afterTime
		 */stopTimerCounter:function stopTimerCounter($afterTime){if(!1===this.counter){this.counter=!0;var quickCreateParams={},customParams={};$afterTime?this.setStopAfterTime():this.setStopBeforeTime(),customParams.time_start=this.timeStart,customParams.time_end=this.timeStop,quickCreateParams.data=customParams,quickCreateParams.noCache=!0,App.Components.QuickCreate.createRecord("OSSTimeControl",quickCreateParams);}},/**
		 * Sets the end time before ending the call.
		 */setStopBeforeTime:function setStopBeforeTime(){(30<parseInt(this.sec)||0===parseInt(this.min))&&(this.min=parseInt(this.min)+1);var dateStart=new Date;dateStart.setHours(this.timeStart.split(":")[0]),dateStart.setMinutes(this.timeStart.split(":")[1]),dateStart.setHours(dateStart.getHours()+parseInt(this.hr)),dateStart.setMinutes(dateStart.getMinutes()+parseInt(this.min));var hours=(10>dateStart.getHours()?"0":"")+dateStart.getHours(),minutes=(10>dateStart.getMinutes()?"0":"")+dateStart.getMinutes();this.timeStop=hours+":"+minutes,this.sec=0,this.min=0,this.hr=0;},/**
		 * Sets the end time after ending the call.
		 */setStopAfterTime:function setStopAfterTime(){var dateEnd=new Date;dateEnd.setHours(this.timeStop.split(":")[0]),dateEnd.setMinutes(this.timeStop.split(":")[1]),dateEnd.setHours(dateEnd.getHours()-parseInt(this.hr)),dateEnd.setMinutes(dateEnd.getMinutes()-parseInt(this.min));var hours=(10>dateEnd.getHours()?"0":"")+dateEnd.getHours(),minutes=(10>dateEnd.getMinutes()?"0":"")+dateEnd.getMinutes();this.timeStart=hours+":"+minutes,this.sec=0,this.min=0,this.hr=0;},/**
		 * Resets the counting operation.
		 */resetTimerCounter:function resetTimerCounter(){!1===this.counter&&(this.counter=!0,this.sec=0,this.min=0,this.hr=0),this.getContainer().find(".js-time-counter").html("00:00:00");},/**
		 * Counting time from the moment of starting work.
		 */timeCounter:function timeCounter(){var _this19=this;!1===this.counter&&(this.sec=parseInt(this.sec),this.min=parseInt(this.min),this.hr=parseInt(this.hr),++this.sec,60===this.sec&&(++this.min,this.sec=0),60===this.min&&(++this.hr,this.min=0,this.sec=0),(10>this.sec||0===this.sec)&&(this.sec="0"+this.sec),(10>this.min||0===this.min)&&(this.min="0"+this.min),(10>this.hr||0===this.hr)&&(this.hr="0"+this.hr),this.getContainer().find(".js-time-counter").html(this.hr+":"+this.min+":"+this.sec),setTimeout(function(_){_this19.timeCounter();},1e3));}});
//# sourceMappingURL=Widget.min.js.map
