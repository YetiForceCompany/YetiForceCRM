'use strict';

$.Class('Base_RecordsList_JS',{},{selectEvent:!1,listSearchInstance:!1,moduleName:!1,container:!1,setSelectEvent:function b(a){this.selectEvent=a;},getParams:function c(){var a={module:this.moduleName,view:this.container.data('view'),src_module:this.container.find('.js-parent-module').val(),src_record:this.container.find('.js-source-record').val(),src_field:this.container.find('.js-source-field').val(),related_parent_module:this.container.find('.js-related-parent-module').val(),related_parent_id:this.container.find('.js-related-parent-id').val(),page:this.container.find('.js-page-number').val(),orderby:this.container.find('.js-order-by').val(),sortorder:this.container.find('.js-sort-order').val(),multi_select:this.container.find('.js-multi-select').val(),totalCount:this.container.find('.js-total-count').val(),noOfEntries:this.container.find('.js-no-entries').val(),filterFields:JSON.parse(this.container.find('.js-filter-fields').val()),onlyBody:!0},b=this.listSearchInstance.getAlphabetSearchValue();return a.search_params=JSON.stringify(this.listSearchInstance.getListSearchParams(!0)),'undefined'!=typeof b&&0<b.length&&(a.search_key=this.listSearchInstance.getAlphabetSearchField(),a.search_value=b,a.operator='s'),a},loadRecordList:function f(a){var b=this,c=this.container.find('.js-modal-body'),d=$.Deferred(),e=$.progressIndicator({blockInfo:{enabled:!0,elementToBlock:c}});return AppConnector.request($.extend(this.getParams(),a)).done(function(a){e.progressIndicator({mode:'hide'}),c.html($(a).html()),b.registerBasicEvents(),d.resolve(a);}).fail(function(a,b){d.reject(a,b),e.progressIndicator({mode:'hide'});}),d.promise()},registerHeadersClickEvent:function b(){var a=this;this.container.on('click','.js-change-order',function(b){b.preventDefault();var c=$(this);'undefined'==typeof c.data('nextOrder')||a.loadRecordList({orderby:c.data('name'),sortorder:c.data('nextOrder')});});},updatePagination:function d(a){var b=this,c=this.getParams();c.mode='getPagination',a&&(c.showTotalCount=!0),AppConnector.request(c).done(function(a){b.container.find('.js-pagination-container').html(a);var c=b.container.find('.js-pagination-list').data('totalCount');c&&b.container.find('.js-total-count').val(c),b.registerPaginationEvents();});},registerPaginationEvents:function b(){var a=this;this.container.find('.js-next-page').on('click',function(){if(!$(this).hasClass('disabled')&&a.container.find('.js-no-entries').val()==a.container.find('.js-page-limit').val()){var b=a.container.find('.js-page-number'),c=parseInt(parseFloat(b.val()))+1;b.val(c),a.loadRecordList().done(function(){a.updatePagination();});}}),this.container.find('.js-page--previous').on('click',function(){var b=a.container.find('.js-page-number');if(1<b.val()){var c=parseInt(parseFloat(b.val()))-1;b.val(c),a.loadRecordList().done(function(){a.updatePagination();});}}),this.container.find('.js-page--set').on('click',function(){$(this).hasClass('disabled')||(a.container.find('.js-page-number').val($(this).data('id')),a.loadRecordList().done(function(){a.updatePagination();}));}),this.container.find('.js-count-number-records').on('click',function(){app.hidePopover($(this)),Vtiger_Helper_Js.showMessage({title:app.vtranslate('JS_LBL_PERMISSION'),text:app.vtranslate('JS_GET_PAGINATION_INFO'),type:'info'}),a.updatePagination(!0);}),this.container.find('.js-page--jump-drop-down').on('click','li',function(a){a.stopImmediatePropagation();}).on('keypress','.js-page-jump',function(b){if(13==b.which){b.stopImmediatePropagation();var c=$(this),d=Vtiger_WholeNumberGreaterThanZero_Validator_Js.invokeValidation(c);if('undefined'!=typeof d)c.validationEngine('showPrompt',d,'','topLeft',!0);else{c.validationEngine('hideAll');var e=a.container.find('.js-page-number'),f=e.val(),g=parseInt($(this).val()),h=parseInt(a.container.find('.js-page--total').text());if(g>h){var i=app.vtranslate('JS_PAGE_NOT_EXIST');return void c.validationEngine('showPrompt',i,'','topLeft',!0)}if(g==f)return void Vtiger_Helper_Js.showMessage({text:app.vtranslate('JS_YOU_ARE_IN_PAGE_NUMBER')+' '+g,type:'info'});e.val(g),a.loadRecordList().done(function(){a.updatePagination();});}}});},registerListSearch:function a(){this.listSearchInstance=YetiForce_ListSearch_Js.getInstance(this.container,!1,this,this.moduleName),this.listSearchInstance.setViewName('RecordsList');},registerListEvents:function c(){var a=this,b=1==this.container.find('.js-additional-informations').val();a.container.on('click','.js-select-row',function(c){if($(c.target).hasClass('js-select-checkbox')||$(c.target).hasClass('u-cursor-auto'))return !0;var d=$(this).data();if('true'===a.container.find('.js-multi-select').val()){var e={};b?(e[d.id]=[],$(this).closest('tr').find('td[data-field]').each(function(a,b){b=$(b),e[d.id].push({value:b.text(),field:b.data('field'),type:b.data('type')});})):e[d.id]=d.name,a.selectEvent(e,c);}else a.selectEvent(d,c);app.hideModalWindow(!1,a.container.parent().attr('id'));}),a.container.on('click','.js-selected-rows',function(c){var d={};a.container.find('table .js-select-checkbox').each(function(a,c){if(c=$(c),!c.is(':checked'))return !0;var e=c.closest('tr').data();b?(d[e.id]=[],c.closest('tr').find('td[data-field]').each(function(a,b){b=$(b),d[e.id].push({value:b.text(),field:b.data('field'),type:b.data('type')});})):d[e.id]=e.name;}),0>=Object.keys(d).length?Vtiger_Helper_Js.showPnotify({text:app.vtranslate('JS_PLEASE_SELECT_ONE_RECORD')}):(a.selectEvent(d,c),app.hideModalWindow($(c.target).closest('.js-modal-container')));}),a.container.on('change','.js-hierarchy-records',function(){a.container.find('.js-related-parent-id').val(this.value),a.container.find('.js-total-count').val(''),a.container.find('.js-page-number').val(1),a.loadRecordList().done(function(){a.updatePagination();});}),a.container.on('click','.js-select-checkbox',function(){var a,b;a=b=$(this),'all'===b.data('type')&&(a=b.closest('table').find('.js-select-checkbox[data-type="row"]')),b.is(':checked')?a.prop('checked',!0).closest('tr').addClass('highlightBackgroundColor'):a.prop('checked',!1).closest('tr').removeClass('highlightBackgroundColor');});},registerBasicEvents:function a(){this.registerListSearch(),this.registerPaginationEvents();},registerEvents:function b(a){this.container=a,this.moduleName=this.container.data('module'),this.registerBasicEvents(),this.registerListEvents(),this.registerHeadersClickEvent();}});
