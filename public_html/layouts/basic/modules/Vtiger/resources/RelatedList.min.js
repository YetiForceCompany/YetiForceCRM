'use strict';

jQuery.Class("Vtiger_RelatedList_Js",{getInstance:function getInstance(parentId,parentModule,selectedRelatedTabElement,relatedModuleName){var instance,moduleClassName=app.getModuleName()+"_RelatedList_Js",fallbackClassName=Vtiger_RelatedList_Js;return instance="undefined"==typeof window[moduleClassName]?new fallbackClassName:new window[moduleClassName],instance.parentRecordId=parentId,instance.parentModuleName=parentModule,instance.selectedRelatedTabElement=selectedRelatedTabElement,instance.moduleName=relatedModuleName,instance.relatedTabsContainer=selectedRelatedTabElement.closest("div.related"),instance.content=$("div.contents",instance.relatedTabsContainer.closest("div.detailViewContainer")),instance.relatedView=instance.content.find("input.relatedView").val(),instance},triggerMassAction:function triggerMassAction(massActionUrl,type){var listInstance=Vtiger_List_Js.getInstance(),validationResult=listInstance.checkListRecordSelected();if(!0!=validationResult){var progressIndicatorElement=jQuery.progressIndicator(),selectedIds=listInstance.readSelectedIds(!0),excludedIds=listInstance.readExcludedIds(!0),cvId=listInstance.getCurrentCvId(),postData={viewname:cvId,selected_ids:selectedIds,excluded_ids:excludedIds},listViewInstance=Vtiger_List_Js.getInstance();if(listViewInstance.getListSearchInstance()){var searchValue=listViewInstance.getListSearchInstance().getAlphabetSearchValue();postData.search_params=JSON.stringify(listViewInstance.getListSearchInstance().getListSearchParams()),"undefined"!=typeof searchValue&&0<searchValue.length&&(postData.search_key=listViewInstance.getListSearchInstance().getAlphabetSearchField(),postData.search_value=searchValue,postData.operator="s");}if("sendByForm"===type){var form=$("<form method=\"POST\" action=\""+massActionUrl+"\">");"undefined"!=typeof csrfMagicName&&form.append($("<input />",{name:csrfMagicName,value:csrfMagicToken})),$.each(postData,function(k,v){form.append($("<input />",{name:k,value:v}));}),$("body").append(form),form.submit(),progressIndicatorElement.progressIndicator({mode:"hide"});}else AppConnector.request({type:"POST",url:massActionUrl,data:postData}).done(function(responseData){if(progressIndicatorElement.progressIndicator({mode:"hide"}),responseData&&null!==responseData.result&&(responseData.result.notify&&Vtiger_Helper_Js.showMessage(responseData.result.notify),responseData.result.reloadList&&Vtiger_Detail_Js.reloadRelatedList(),responseData.result.procesStop))return progressIndicatorElement.progressIndicator({mode:"hide"}),!1}).fail(function(){progressIndicatorElement.progressIndicator({mode:"hide"});});}else listInstance.noRecordSelectedAlert();}},{selectedRelatedTabElement:!1,parentRecordId:!1,parentModuleName:!1,moduleName:!1,relatedTabsContainer:!1,content:!1,listSearchInstance:!1,detailViewContentHolder:!1,relatedView:!1,frameProgress:!1,setSelectedTabElement:function setSelectedTabElement(tabElement){this.selectedRelatedTabElement=tabElement;},getSelectedTabElement:function getSelectedTabElement(){return this.selectedRelatedTabElement},getParentId:function getParentId(){return this.parentRecordId},getRelatedContainer:function getRelatedContainer(){return this.content},setRelatedContainer:function setRelatedContainer(container){this.content=container,this.relatedView=container.find("input.relatedView").val();},getContentHolder:function getContentHolder(){return !1==this.detailViewContentHolder&&(this.detailViewContentHolder=$("div.details div.contents")),this.detailViewContentHolder},getCurrentPageNum:function getCurrentPageNum(){return $("input[name=\"currentPageNum\"]",this.content).val()},setCurrentPageNumber:function setCurrentPageNumber(pageNumber){$("input[name=\"currentPageNum\"]",this.content).val(pageNumber);},getOrderBy:function getOrderBy(){return $("#orderBy",this.content).val()},getSortOrder:function getSortOrder(){return $("#sortOrder",this.content).val()},getCompleteParams:function getCompleteParams(){var container=this.getRelatedContainer(),params={view:"Detail",module:this.parentModuleName,record:this.getParentId(),relatedModule:this.moduleName,sortorder:this.getSortOrder(),orderby:this.getOrderBy(),page:this.getCurrentPageNum(),relatedView:this.relatedView,mode:"showRelatedList"};if(container.find(".pagination").length&&(params.totalCount=container.find(".pagination").data("totalCount")),container.find(".entityState").length&&(params.entityState=container.find(".entityState").val()),this.listSearchInstance){var searchValue=this.listSearchInstance.getAlphabetSearchValue();params.search_params=JSON.stringify(this.listSearchInstance.getListSearchParams());}if("undefined"!=typeof searchValue&&0<searchValue.length&&(params.search_key=this.listSearchInstance.getAlphabetSearchField(),params.search_value=searchValue,params.operator="s"),"Calendar"==this.moduleName){var switchBtn=container.find(".js-switch--calendar");switchBtn.length&&(params.time=switchBtn.first().prop("checked")?"current":"history");}return params},loadRelatedList:function loadRelatedList(params){var aDeferred=jQuery.Deferred(),thisInstance=this;if("undefined"==typeof thisInstance.moduleName||0>=thisInstance.moduleName.length){var currentInstance=Vtiger_Detail_Js.getInstance();return currentInstance.loadWidgets(),aDeferred.promise()}var progressInstance=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),completeParams=this.getCompleteParams(),activeTabsReference=thisInstance.relatedTabsContainer.find("li.active").data("reference");return AppConnector.request($.extend(completeParams,params)).done(function(responseData){var currentInstance=Vtiger_Detail_Js.getInstance();currentInstance.loadWidgets(),progressInstance.progressIndicator({mode:"hide"}),"ProductsAndServices"!==activeTabsReference&&(thisInstance.relatedTabsContainer.find("li").removeClass("active"),thisInstance.selectedRelatedTabElement.addClass("active"),thisInstance.content.html(responseData),$(".pageNumbers",thisInstance.content).tooltip(),thisInstance.registerPostLoadEvents(),thisInstance.registerListEvents()),aDeferred.resolve(responseData);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown),Vtiger_Helper_Js.showPnotify({text:app.vtranslate("JS_NOT_ALLOWED_VALUE"),type:"error"}),progressInstance.progressIndicator({mode:"hide"});}),aDeferred.promise()},triggerDisplayTypeEvent:function triggerDisplayTypeEvent(){var widthType=app.cacheGet("widthType","narrowWidthType");if(widthType){var elements=this.content.find(".listViewEntriesTable").find("td,th");elements.attr("class",widthType);}},showSelectRelation:function showSelectRelation(extendParams){var _this=this,params=$.extend(this.getRecordsListParams(),extendParams);app.showRecordsList(params,function(modal,instance){instance.setSelectEvent(function(responseData){_this.addRelations(Object.keys(responseData)).done(function(){app.event.trigger("RelatedListView.AfterSelectRelation",responseData,_this,instance,params);var detail=Vtiger_Detail_Js.getInstance();_this.loadRelatedList().done(function(){detail.registerRelatedModulesRecordCount();}),"LBL_RECORD_SUMMARY"===_this.getSelectedTabElement().data("link-key")&&(detail.loadWidgets(),detail.registerRelatedModulesRecordCount());});});});},getRecordsListParams:function getRecordsListParams(){return {module:this.moduleName,src_module:this.parentModuleName,src_record:this.parentRecordId,multi_select:!0}},addRelations:function addRelations(idList){var aDeferred=jQuery.Deferred();return AppConnector.request({module:this.parentModuleName,action:"RelationAjax",mode:"addRelation",related_module:this.moduleName,src_record:this.parentRecordId,related_record_list:$.isArray(idList)?JSON.stringify(idList):idList}).done(function(responseData){aDeferred.resolve(responseData);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);}),aDeferred.promise()},deleteRelation:function deleteRelation(target){var _this2=this,params={};if(target.data("url"))params=target.data("url");else{var id=target.data("id")?target.data("id"):element.closest("tr").data("id");params={module:this.parentModuleName,action:"RelationAjax",mode:"deleteRelation",related_module:this.moduleName,src_record:this.parentRecordId,related_record_list:JSON.stringify([id])};}var progressInstance=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});AppConnector.request(params).done(function(response){if(progressInstance.progressIndicator({mode:"hide"}),response.result){var widget=target.closest(".widgetContentBlock"),detail=Vtiger_Detail_Js.getInstance();if(widget.length){detail.loadWidget(widget);var updatesWidget=_this2.getContentHolder().find("[data-type='Updates']");0<updatesWidget.length&&detail.loadWidget(updatesWidget);}else _this2.loadRelatedList();detail.registerRelatedModulesRecordCount();}else Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_CANNOT_REMOVE_RELATION"));}).fail(function(){progressInstance.progressIndicator({mode:"hide"}),Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_CANNOT_REMOVE_RELATION"));});},sortHandler:function sortHandler(headerElement){var aDeferred=jQuery.Deferred(),sortOrderVal=headerElement.data("nextsortorderval");if("undefined"!=typeof sortOrderVal)return this.loadRelatedList({orderby:headerElement.data("fieldname"),sortorder:sortOrderVal}).done(function(data){aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);}),aDeferred.promise()},nextPageHandler:function nextPageHandler(){var aDeferred=jQuery.Deferred(),thisInstance=this,pageLimit=jQuery("#pageLimit",this.content).val(),noOfEntries=jQuery("#noOfEntries",this.content).val();if(noOfEntries==pageLimit){var pageNumber=this.getCurrentPageNum(),nextPage=parseInt(pageNumber)+1;this.loadRelatedList({page:nextPage}).done(function(data){thisInstance.setCurrentPageNumber(nextPage),aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);});}return aDeferred.promise()},previousPageHandler:function previousPageHandler(){var thisInstance=this,aDeferred=jQuery.Deferred(),pageNumber=this.getCurrentPageNum();if(1<pageNumber){var previousPage=parseInt(pageNumber)-1;this.loadRelatedList({page:previousPage}).done(function(data){thisInstance.setCurrentPageNumber(previousPage),aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);});}return aDeferred.promise()},selectPageHandler:function selectPageHandler(pageNumber){var thisInstance=this,aDeferred=jQuery.Deferred();return this.loadRelatedList({page:pageNumber}).done(function(data){thisInstance.setCurrentPageNumber(pageNumber),aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);}),aDeferred.promise()},pageJumpHandler:function pageJumpHandler(e){var aDeferred=jQuery.Deferred(),thisInstance=this;if(13==e.which){var element=jQuery(e.currentTarget),response=Vtiger_WholeNumberGreaterThanZero_Validator_Js.invokeValidation(element);if("undefined"!=typeof response)element.validationEngine("showPrompt",response,"","topLeft",!0),e.preventDefault();else{element.validationEngine("hideAll");var jumpToPage=parseInt(element.val()),totalPages=parseInt(jQuery("#totalPageCount",thisInstance.content).text());if(jumpToPage>totalPages){var error=app.vtranslate("JS_PAGE_NOT_EXIST");element.validationEngine("showPrompt",error,"","topLeft",!0);}var invalidFields=element.parent().find(".formError");if(1>invalidFields.length){var currentPage=jQuery("input[name=\"currentPageNum\"]",thisInstance.content).val();if(jumpToPage==currentPage){var message=app.vtranslate("JS_YOU_ARE_IN_PAGE_NUMBER")+" "+jumpToPage;return Vtiger_Helper_Js.showMessage({text:message,type:"info"}),e.preventDefault(),!1}this.loadRelatedList({page:jumpToPage}).done(function(data){thisInstance.setCurrentPageNumber(jumpToPage),aDeferred.resolve(data);}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);});}else e.preventDefault();}}return aDeferred.promise()},addRelatedRecord:function addRelatedRecord(element,callback){var aDeferred=jQuery.Deferred(),thisInstance=this,referenceModuleName=this.moduleName,parentId=this.getParentId(),parentModule=this.parentModuleName,quickCreateParams={},relatedParams={},relatedField=element.data("name"),fullFormUrl=element.data("url");relatedParams[relatedField]=parentId;var eliminatedKeys=new Array("view","module","mode","action"),preQuickCreateSave=function(data){var index,queryParam,queryParamComponents,queryParameters=[];if("undefined"!=typeof fullFormUrl&&-1!==fullFormUrl.indexOf("?")){var urlSplit=fullFormUrl.split("?"),queryString=urlSplit[1];for(queryParameters=queryString.split("&"),index=0;index<queryParameters.length;index++)queryParam=queryParameters[index],queryParamComponents=queryParam.split("="),"mode"==queryParamComponents[0]&&"Calendar"==queryParamComponents[1]&&data.find("a[data-tab-name=\"Task\"]").trigger("click");}if(jQuery("<input type=\"hidden\" name=\"sourceModule\" value=\""+parentModule+"\" />").appendTo(data),jQuery("<input type=\"hidden\" name=\"sourceRecord\" value=\""+parentId+"\" />").appendTo(data),jQuery("<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />").appendTo(data),"undefined"!=typeof relatedField){var field=data.find("[name=\""+relatedField+"\"]");0==field.length&&jQuery("<input type=\"hidden\" name=\""+relatedField+"\" value=\""+parentId+"\" />").appendTo(data);}for(index=0;index<queryParameters.length;index++)queryParam=queryParameters[index],queryParamComponents=queryParam.split("="),"-1"==jQuery.inArray(queryParamComponents[0],eliminatedKeys)&&0==data.find("[name=\""+queryParamComponents[0]+"\"]").length&&jQuery("<input type=\"hidden\" name=\""+queryParamComponents[0]+"\" value=\""+queryParamComponents[1]+"\" />").appendTo(data);"undefined"!=typeof callback&&callback();};if("undefined"!=typeof fullFormUrl&&-1!==fullFormUrl.indexOf("?"))for(var urlSplit=fullFormUrl.split("?"),queryString=urlSplit[1],queryParameters=queryString.split("&"),index=0;index<queryParameters.length;index++){var queryParam=queryParameters[index],queryParamComponents=queryParam.split("=");"-1"==jQuery.inArray(queryParamComponents[0],eliminatedKeys)&&(relatedParams[queryParamComponents[0]]=queryParamComponents[1]);}return quickCreateParams.data=relatedParams,quickCreateParams.callbackFunction=function postQuickCreateSave(){thisInstance.loadRelatedList().done(function(data){aDeferred.resolve(data);});},quickCreateParams.callbackPostShown=preQuickCreateSave,quickCreateParams.noCache=!0,Vtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName,quickCreateParams),aDeferred.promise()},getRelatedPageCount:function getRelatedPageCount(){var aDeferred=jQuery.Deferred(),element=this.content.find("#totalPageCount"),totalCountElem=this.content.find("#totalCount"),totalPageNumber=element.text();return ""==totalPageNumber?(element.progressIndicator({}),AppConnector.request({module:this.parentModuleName,action:"RelationAjax",mode:"getRelatedListPageCount",record:this.getParentId(),relatedModule:this.moduleName}).done(function(data){var pageCount=data.result.page,numberOfRecords=data.result.numberOfRecords;totalCountElem.val(numberOfRecords),element.text(pageCount),element.progressIndicator({mode:"hide"}),aDeferred.resolve();}).fail(function(){aDeferred.reject(!1);})):aDeferred.resolve(),aDeferred.promise()},favoritesRelation:function favoritesRelation(relcrmId,state){var aDeferred=jQuery.Deferred();return relcrmId?AppConnector.request({module:this.parentModuleName,action:"RelationAjax",mode:"updateFavoriteForRecord",record:this.getParentId(),relcrmid:relcrmId,relatedModule:this.moduleName,actionMode:state?"delete":"add"}).done(function(data){data.result&&aDeferred.resolve(!0);}).fail(function(){aDeferred.reject(!1);}):aDeferred.reject(!1),aDeferred.promise()},updatePreview:function updatePreview(url){var frame=this.content.find(".listPreviewframe");this.frameProgress=$.progressIndicator({position:"html",message:app.vtranslate("JS_FRAME_IN_PROGRESS"),blockInfo:{enabled:!0}});var defaultView="";app.getMainParams("defaultDetailViewName")&&(defaultView=defaultView+"&mode=showDetailViewByMode&requestMode="+app.getMainParams("defaultDetailViewName")),frame.attr("src",url.replace("view=Detail","view=DetailPreview")+defaultView);},registerUnreviewedCountEvent:function registerUnreviewedCountEvent(){var ids=[],relatedContent=this.content,isUnreviewedActive=relatedContent.find(".unreviewed").length;relatedContent.find("tr.listViewEntries").each(function(){var id=jQuery(this).data("id");id&&ids.push(id);});1>isUnreviewedActive||AppConnector.request({action:"ChangesReviewedOn",mode:"getUnreviewed",module:"ModTracker",sourceModule:this.moduleName,recordsId:ids}).done(function(appData){var data=appData.result;$.each(data,function(id,value){0<value.a&&relatedContent.find("tr[data-id=\""+id+"\"] .unreviewed .badge.all").text(value.a).parent().removeClass("d-none"),0<value.m&&relatedContent.find("tr[data-id=\""+id+"\"] .unreviewed .badge.mail").text(value.m).parent().removeClass("d-none");});});},registerChangeEntityStateEvent:function registerChangeEntityStateEvent(){var thisInstance=this,relatedContent=this.content;relatedContent.on("click",".dropdownEntityState a",function(){var element=$(this);relatedContent.find(".entityState").val(element.data("value")),relatedContent.find(".pagination").data("totalCount",0),relatedContent.find(".dropdownEntityState button").find("span").attr("class",element.find("span").attr("class")),thisInstance.loadRelatedList({page:1});});},registerRowsEvent:function registerRowsEvent(){var thisInstance=this;"List"===this.relatedView||"Detail"===this.relatedView?(this.content.find(".listViewEntries").on("click",function(e){$(e.target).is("td")&&("DetailPreview"==app.getViewName()?$(e.target).closest("tr").data("recordurl")&&(top.document.location.href=$(e.target).closest("tr").data("recordurl")):$(e.target).closest("tr").data("recordurl")&&(document.location.href=$(e.target).closest("tr").data("recordurl")));}),this.content.find(".showInventoryRow").on("click",function(){var target=$(this),row=target.closest("tr"),inventoryRow=row.next();inventoryRow.hasClass("listViewInventoryEntries")&&inventoryRow.toggleClass("d-none");})):"ListPreview"===this.relatedView&&this.content.find(".listViewEntries").on("click",function(e){var target=$(e.target);if(!target.closest("div").hasClass("actions")&&!(target.is("button")||target.parent().is("button"))&&!target.closest("a").hasClass("noLinkBtn")&&!$(e.target,$(e.currentTarget)).is("td:first-child")&&!target.is("input[type=\"checkbox\"]")&&!$.contains($(e.currentTarget).find("td:last-child").get(0),target[0])&&!$.contains($(e.currentTarget).find("td:first-child").get(0),target[0])){var recordUrl=$(this).data("recordurl");thisInstance.content.find(".listViewEntriesTable .listViewEntries").removeClass("active"),$(this).addClass("active"),thisInstance.updatePreview(recordUrl);}});},registerSummationEvent:function registerSummationEvent(){var thisInstance=this;this.content.on("click",".listViewSummation button",function(){var button=$(this),calculateValue=button.closest("td").find(".calculateValue"),params=thisInstance.getCompleteParams();params.action="RelationAjax",params.mode="calculate",params.fieldName=button.data("field"),params.calculateType=button.data("operator"),delete params.view;var progress=$.progressIndicator({message:app.vtranslate("JS_CALCULATING_IN_PROGRESS"),position:"html",blockInfo:{enabled:!0}});app.hidePopover(button),AppConnector.request(params).done(function(response){response.success?calculateValue.html(response.result):calculateValue.html(""),progress.progressIndicator({mode:"hide"});}),progress.progressIndicator({mode:"hide"});});},registerPreviewEvent:function registerPreviewEvent(){var thisInstance=this,contentHeight=this.content.find(".js-detail-preview,.js-list-preview");contentHeight.height(app.getScreenHeight()-(this.content.offset().top+$(".js-footer").height())),this.content.find(".listPreviewframe").on("load",function(){thisInstance.frameProgress&&thisInstance.frameProgress.progressIndicator({mode:"hide"}),contentHeight.height($(this).contents().find(".bodyContents").height()+2);}),this.content.find(".listViewEntriesTable .listViewEntries").first().trigger("click");},registerPaginationEvents:function registerPaginationEvents(){var thisInstance=this,relatedContent=this.content;this.content.on("click","#relatedViewNextPageButton",function(){$(this).hasClass("disabled")||thisInstance.nextPageHandler();}),this.content.on("click","#relatedViewPreviousPageButton",function(){thisInstance.previousPageHandler();}),this.content.on("click","#relatedListPageJump",function(){thisInstance.getRelatedPageCount();}),this.content.on("click","#relatedListPageJumpDropDown > li",function(e){e.stopImmediatePropagation();}).on("keypress","#pageToJump",function(e){thisInstance.pageJumpHandler(e);}),this.content.on("click",".pageNumber",function(){return !$(this).hasClass("disabled")&&void thisInstance.selectPageHandler($(this).data("id"))}),this.content.on("click","#totalCountBtn",function(){app.hidePopover($(this));var params={module:thisInstance.parentModuleName,view:"Pagination",mode:"getRelationPagination",record:thisInstance.getParentId(),relatedModule:thisInstance.moduleName,noOfEntries:$("#noOfEntries",relatedContent).val(),page:relatedContent.find("[name=\"currentPageNum\"]").val()};relatedContent.find(".entityState").length&&(params.entityState=relatedContent.find(".entityState").val()),AppConnector.request(params).done(function(response){relatedContent.find(".paginationDiv").html(response);});});},registerListEvents:function registerListEvents(){var relatedContent=this.content,thisInstance=this;this.content.on("click",".relatedListHeaderValues",function(){thisInstance.sortHandler($(this));}),this.content.find("a.favorites").on("click",function(){var progressInstance=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),element=$(this),row=element.closest("tr");thisInstance.favoritesRelation(row.data("id"),element.data("state")).done(function(response){if(response){var state=element.data("state")?0:1;element.data("state",state),state?(element.find(".far").addClass("d-none"),element.find(".fas").removeClass("d-none")):(element.find(".fas").addClass("d-none"),element.find(".far").removeClass("d-none")),progressInstance.progressIndicator({mode:"hide"});var text=app.vtranslate("JS_REMOVED_FROM_FAVORITES");state&&(text=app.vtranslate("JS_ADDED_TO_FAVORITES")),Vtiger_Helper_Js.showPnotify({text:text,type:"success"});}});}),this.content.find("[name=\"addButton\"]").on("click",function(){var element=$(this);return !0===element.hasClass("quickCreateSupported")?void thisInstance.addRelatedRecord(element):void app.openUrl(element.data("url"))}),this.content.find("button.selectRelation").on("click",function(){var restrictionsField=$(this).data("rf"),params={};restrictionsField&&0<Object.keys(restrictionsField).length&&(params={search_key:restrictionsField.key,search_value:restrictionsField.name}),thisInstance.showSelectRelation(params);}),this.content.find("button.relationDelete").on("click",function(e){e.stopImmediatePropagation();var target=$(e.currentTarget),params={};target.data("confirm")?(params.message=target.data("confirm"),params.title=target.html()+" "+target.data("content")):target.data("content")?params.message=target.data("content"):params.message=app.vtranslate("JS_DELETE_CONFIRMATION"),Vtiger_Helper_Js.showConfirmationBox(params).done(function(){thisInstance.deleteRelation(target);});}),this.content.find(".js-switch--calendar").on("change",function(){thisInstance.loadRelatedList();}),this.content.find(".relatedViewGroup a").on("click",function(){var element=$(this);thisInstance.relatedView=element.data("view"),relatedContent.find(".pagination").data("totalCount",0),thisInstance.loadRelatedList({page:1});});},registerPostLoadEvents:function registerPostLoadEvents(){var thisInstance=this;if(this.registerRowsEvent(),this.registerListScroll(),"ListPreview"===this.relatedView&&(this.registerPreviewEvent(),!this.content.find(".gutter").length)){if(!this.content.find(".js-list-preview").length)return;this.getDomParams(this.content),this.toggleSplit(this.content),this.registerListPreviewEvents(this.content);}this.listSearchInstance=YetiForce_ListSearch_Js.getInstance(this.content,!1,this),app.event.trigger("RelatedList.AfterLoad",thisInstance);},getSecondColMinWidth:function getSecondColMinWidth(container){var thisWidth,maxWidth=0;return container.find(".js-list__row").each(function(i){thisWidth=$(this).find(".js-list__field").first().width(),0===i?maxWidth=thisWidth:thisWidth>maxWidth?maxWidth=thisWidth:maxWidth;}),maxWidth},getDomParams:function getDomParams(container){this.listColumnFirstWidth=container.find(".listViewEntriesDiv .listViewHeaders th").first().width(),this.listColumnSecondWidth=this.getSecondColMinWidth(container),this.windowW=$(window).width(),this.mainBody=container.closest(".mainBody"),this.windowMinWidth=100*(15/this.windowW),this.windowMaxWidth=100-this.minWidth,this.sideBlocks=container.find(".js-side-block"),this.sideBlockLeft=this.sideBlocks.first(),this.sideBlockRight=this.sideBlocks.last(),this.list=container.find(".js-list-preview"),this.preview=container.find(".js-detail-preview"),this.rotatedText=container.find(".u-rotate-90"),this.footerH=$(".js-footer").outerHeight(),this.headerH=$(".js-header").outerHeight();},getDefaultSplitSizes:function getDefaultSplitSizes(){var thWidth=100*((this.listColumnFirstWidth+this.listColumnSecondWidth+82)/this.windowW);return [thWidth,100-thWidth]},getSplitSizes:function getSplitSizes(){var cachedParams=app.moduleCacheGet("userRelatedSplitSet");return void 0===cachedParams?this.getDefaultSplitSizes():cachedParams},registerListPreviewEvents:function registerListPreviewEvents(container){var _this3=this,listPreview=container.find(".js-detail-preview"),mainBody=container.closest(".mainBody");app.showNewScrollbarTopBottom(container.find(".js-list-preview--scroll")),app.showNewScrollbarLeft(this.list),mainBody.scrollTop(0);var listOffsetTop=this.list.offset().top-this.headerH,initialH=this.sideBlocks.height(),mainViewPortHeightCss={height:mainBody.height()},mainViewPortWidthCss={width:mainBody.height()};this.gutter.addClass("js-fixed-scroll");var fixedElements=container.find(".js-fixed-scroll");if(!mainBody.length){mainBody=$(top.document).find(".mainBody"),this.headerH=$(top.document).find(".js-header").outerHeight();var iframe=$(top.document).find(".js-detail-preview");listOffsetTop=this.list.offset().top+iframe.offset().top-this.headerH+1,mainViewPortHeightCss={height:mainBody.height()},mainViewPortWidthCss={width:mainBody.height()};}this.list.on("click",".listViewEntries",function(){if(10>_this3.split.getSizes()[1]){var defaultGutterPosition=_this3.getDefaultSplitSizes();_this3.split.setSizes(defaultGutterPosition),listPreview.show(),_this3.sideBlockRight.removeClass("d-block"),app.moduleCacheSet("userRelatedSplitSet",defaultGutterPosition);}});this.list.parents(".blockContent").length||mainBody.on("scroll",function(){mainBody.scrollTop()>=listOffsetTop?(fixedElements.css({top:mainBody.scrollTop()-listOffsetTop}),_this3.sideBlocks.css({top:mainBody.scrollTop()-listOffsetTop+56}),fixedElements.css(mainViewPortHeightCss),_this3.rotatedText.css(mainViewPortHeightCss),_this3.rotatedText.css(mainViewPortWidthCss)):(fixedElements.css({top:"initial"}),fixedElements.css({height:initialH+mainBody.scrollTop()}),_this3.rotatedText.css({width:initialH+mainBody.scrollTop(),height:initialH+mainBody.scrollTop()}));});},registerSplitEvents:function registerSplitEvents(container,split){var _this4=this,rightSplitMaxWidth=100*(400/this.windowW),minWindowWidth=100*(23/this.windowW),maxWindowWidth=100-minWindowWidth,listPreview=container.find(".js-detail-preview");this.gutter.on("dblclick",function(){var gutterRelatedMidPosition=app.moduleCacheGet("gutterRelatedMidPosition");isNaN(_this4.split.getSizes()[0])&&_this4.split.setSizes(gutterRelatedMidPosition),7>split.getSizes()[0]?(_this4.gutter.removeClass("js-gutter-corr-left"),_this4.sideBlockLeft.removeClass("d-block"),_this4.list.removeClass("u-hide-underneath"),11<gutterRelatedMidPosition[0]?split.setSizes(gutterRelatedMidPosition):split.setSizes(_this4.getDefaultSplitSizes())):20>split.getSizes()[1]?(gutterRelatedMidPosition[1]>rightSplitMaxWidth+1?split.setSizes(gutterRelatedMidPosition):split.setSizes(_this4.getDefaultSplitSizes()),_this4.gutter.removeClass("js-gutter-corr-right"),_this4.sideBlockRight.removeClass("d-block"),listPreview.show()):7<split.getSizes()[0]&&50>split.getSizes()[0]?(split.setSizes([minWindowWidth,maxWindowWidth]),_this4.gutter.addClass("js-gutter-corr-left"),_this4.sideBlockLeft.addClass("d-block"),_this4.list.addClass("u-hide-underneath")):10<split.getSizes()[1]&&50>split.getSizes()[1]&&(split.setSizes([maxWindowWidth,minWindowWidth]),_this4.gutter.addClass("js-gutter-corr-right"),_this4.sideBlockRight.addClass("d-block"),listPreview.hide()),app.moduleCacheSet("userRelatedSplitSet",split.getSizes());}),this.sideBlockLeft.on("click",function(){var gutterRelatedMidPosition=app.moduleCacheGet("gutterRelatedMidPosition");11<gutterRelatedMidPosition[0]?split.setSizes(gutterRelatedMidPosition):split.setSizes(_this4.getDefaultSplitSizes()),_this4.gutter.removeClass("js-gutter-corr-left"),_this4.sideBlockLeft.removeClass("d-block"),_this4.list.removeClass("u-hide-underneath"),app.moduleCacheSet("userRelatedSplitSet",split.getSizes());}),this.sideBlockRight.on("click",function(){var gutterRelatedMidPosition=app.moduleCacheGet("gutterRelatedMidPosition");gutterRelatedMidPosition[1]>rightSplitMaxWidth+1?split.setSizes(gutterRelatedMidPosition):split.setSizes(_this4.getDefaultSplitSizes()),_this4.gutter.removeClass("js-gutter-corr-right"),_this4.sideBlockRight.removeClass("d-block"),listPreview.show(),app.moduleCacheSet("userRelatedSplitSet",split.getSizes());});},registerSplit:function registerSplit(container){var _this5=this,rightSplitMaxWidth=100*(400/this.windowW),splitSizes=this.getSplitSizes();app.moduleCacheSet("gutterRelatedMidPosition",splitSizes);var split=Split([this.list[0],this.preview[0]],{sizes:splitSizes,minSize:10,gutterSize:24,snapOffset:100,onDrag:function onDrag(){split.getSizes()[1]<rightSplitMaxWidth&&split.collapse(1),7>split.getSizes()[0]?(_this5.sideBlockLeft.addClass("d-block"),_this5.list.addClass("u-hide-underneath")):(_this5.gutter.removeClass("js-gutter-corr-left"),_this5.sideBlockLeft.removeClass("d-block"),_this5.list.removeClass("u-hide-underneath")),10>split.getSizes()[1]?(_this5.sideBlockRight.addClass("d-block"),_this5.preview.hide(),_this5.list.width(_this5.list.width()-10)):(_this5.gutter.removeClass("js-gutter-corr-right"),_this5.sideBlockRight.removeClass("d-block"),_this5.preview.show()),10<split.getSizes()[0]&&split.getSizes()[1]>rightSplitMaxWidth&&app.moduleCacheSet("gutterRelatedMidPosition",split.getSizes()),app.moduleCacheSet("userRelatedSplitSet",split.getSizes());}});this.gutter=container.find(".gutter"),10>splitSizes[0]?(this.gutter.addClass("js-gutter-corr-left"),this.sideBlockLeft.addClass("d-block"),this.list.addClass("u-hide-underneath")):splitSizes[1]<rightSplitMaxWidth&&(this.gutter.addClass("js-gutter-corr-right"),this.sideBlockRight.addClass("d-block"),this.preview.hide());var mainWindowHeightCss={height:$(window).height()-this.list.offset().top-this.footerH};if(!container.closest(".mainBody").length){var mainBody=$(top.document).find(".mainBody").height(),iframe=$(top.document).find(".js-detail-preview");mainWindowHeightCss={height:mainBody-this.list.offset().top-iframe.offset().top+50};}return this.list.parents(".blockContent").length||(this.gutter.css(mainWindowHeightCss),this.list.css(mainWindowHeightCss),this.sideBlocks.css(mainWindowHeightCss),this.rotatedText.css({width:this.sideBlockLeft.height(),height:this.sideBlockLeft.height()})),this.registerSplitEvents(container,split),split},toggleSplit:function toggleSplit(container){var _this6=this,commactHeight=container.closest(".commonActionsContainer").height(),splitsArray=[];this.split=this.registerSplit(container),splitsArray.push(this.split),$(window).on("resize",function(){if(993>$(window).width())container.find(".gutter").length&&(splitsArray[splitsArray.length-1].destroy(),_this6.sideBlockRight.removeClass("d-block"),_this6.sideBlockLeft.removeClass("d-block"));else{if(1!==container.find(".gutter").length){_this6.split=_this6.registerSplit(container);var gutter=container.find(".gutter");_this6.mainBody.scrollTop()>=_this6.list.offset().top+commactHeight&&(gutter.addClass("gutterOnScroll"),gutter.css("left",_this6.preview.offset().left-8),gutter.on("mousedown",function(){$(this).on("mousemove",function(){$(this).css("left",this.preview.offset().left-8);});})),splitsArray.push(_this6.split);}var currentSplit=splitsArray[splitsArray.length-1],minWidth=100*(15/$(window).width()),maxWidth=100-minWidth;if("undefined"==typeof currentSplit)return;currentSplit.getSizes()[0]<minWidth+5?currentSplit.setSizes([minWidth,maxWidth]):currentSplit.getSizes()[1]<minWidth+5&&currentSplit.setSizes([maxWidth,minWidth]);}});},registerListScroll:function registerListScroll(){var container=$(".listViewEntriesDiv");"ListPreview"!==this.relatedView&&container.each(function(index,element){app.showNewScrollbarTopBottomRight($(element));});},registerRelatedEvents:function registerRelatedEvents(){this.registerUnreviewedCountEvent(),this.registerChangeEntityStateEvent(),this.registerPaginationEvents(),this.registerListEvents(),this.registerPostLoadEvents(),this.registerSummationEvent();}});
//# sourceMappingURL=RelatedList.min.js.map
