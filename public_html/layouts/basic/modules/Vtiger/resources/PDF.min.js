'use strict';

jQuery.Class('Vtiger_PDF_Js',{validateSubmit:function e(a){var b=[],c=0;if(a.find('[name="pdf_template[]"]').each(function(){jQuery(this).is(':checked')&&(b[c]=jQuery(this).val(),c++);}),0<b.length){a.find('#generate_pdf').attr('disabled',!1);var d=app.getUrlVar('view');1<b.length||d&&'List'===d.replace('#','')&&0<JSON.parse(a.find('[name="validRecords"]').val()).length?a.find('#single_pdf').show():a.find('#single_pdf').hide();}else a.find('#generate_pdf').attr('disabled',!0),a.find('#single_pdf').hide();},registerPreSubmitEvent:function b(a){a.find('#generate_pdf, #single_pdf, #email_pdf').on('click',function(){document.progressLoader=jQuery.progressIndicator({message:app.vtranslate('JS_PDF_GENERATING'),position:'html',blockInfo:{enabled:!0}});var b=[],c=0;a.find('[name="pdf_template[]"]').each(function(){jQuery(this).is(':checked')&&(b[c]=jQuery(this).val(),c++);});var d=app.getUrlVar('view');switch(d&&'List'===d.replace('#','')&&a.find('[name="record"]').val(a.find('[name="validRecords"]').val()),a.find('[name="template"]').val(b),jQuery(this).attr('id')){case'generate_pdf':break;case'single_pdf':a.find('[name="single_pdf"]').val(1),a.find('#pdfExportModal').submit();break;case'email_pdf':a.find('[name="email_pdf"]').val(1),a.find('#pdfExportModal').submit();}document.progressLoader.progressIndicator({mode:'hide'}),app.hideModalWindow();});},registerValidateSubmit:function c(a){var b=this;b.validateSubmit(a),a.find('[name="pdf_template[]"]').on('change',function(){b.validateSubmit(a);});},registerListViewCheckRecords:function c(a){var b=this;a.find('[name="pdf_template[]"]').on('change',function(){document.progressLoader=jQuery.progressIndicator({message:app.vtranslate('JS_PDF_RECALCULATING'),position:'html',blockInfo:{enabled:!0}});var c=a.find('[name="selectedRecords"]').val(),d=[];a.find('[name="pdf_template[]"]:checked').each(function(a){d[a]=jQuery(this).val();});var e={};e.data={module:app.getModuleName(),action:'PDF',mode:'validateRecords',records:c,view:app.getViewName(),templates:d},e.dataType='json',AppConnector.request(e).done(function(c){var d=c.result;c.success&&(a.find('[name="validRecords"]').val(JSON.stringify(d.valid_records)),a.find('#recordsInfo').text(d.message),setTimeout(function(){document.progressLoader.progressIndicator({mode:'hide'});},500),b.validateSubmit(a));}).fail(function(a,b){app.errorLog(a,b);});});},countSelectedRecords:function c(a){var b=JSON.parse(a.find('[name="selectedRecords"]').val());return b.length},registerEvents:function e(){var a=jQuery('div.modal-content');if(this.registerPreSubmitEvent(a),'Detail'===app.getViewName()&&this.registerValidateSubmit(a),'List'===app.getViewName()){this.validateSubmit(a),this.registerListViewCheckRecords(a);var b=JSON.parse(a.find('#all_records').val()),c=a.find('[name="selectedRecords"]'),d=a.find('[name="validRecords"]');a.find('div.modal-body').append('<p id="recordsInfo">'+app.vtranslate('JS_RECORD_INFO'),+'</p>'),c.val(JSON.stringify(b)),d.val(JSON.stringify(b)),jQuery('#recordsInfo').text(b.length+' from '+b.length+' are valid for chosen template.'),this.validateSubmit(a);}}}),jQuery(function(){var a=new Vtiger_PDF_Js;a.registerEvents();});
