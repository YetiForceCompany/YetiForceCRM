{"version":3,"file":"ConditionBuilder.min.js","sources":["ConditionBuilder.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nclass Vtiger_ConditionBuilder_Js {\n\t/**\n\t * Constructor\n\t * @param {jQuery} container\n\t */\n\tconstructor(container, sourceModuleName, onChange) {\n\t\tthis.container = container;\n\t\tthis.sourceModuleName = sourceModuleName;\n\t\tif (onChange) {\n\t\t\tthis.onChange = onChange;\n\t\t} else {\n\t\t\tthis.onChange = () => {};\n\t\t}\n\t}\n\n\t/**\n\t * Register change value event\n\t *\n\t * @param   {jQuery}  container\n\t */\n\tregisterChangeValueEvent(container) {\n\t\tcontainer.find('.js-condition-builder-value').on('change', e => {\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events when change conditions\n\t * @param {jQuery} container\n\t */\n\tregisterChangeConditions(container) {\n\t\tlet self = this;\n\t\tcontainer.find('.js-conditions-fields, .js-conditions-operator').on('change', function(e) {\n\t\t\tlet progress = $.progressIndicator({\n\t\t\t\tposition: 'html',\n\t\t\t\tblockInfo: {\n\t\t\t\t\tenabled: true\n\t\t\t\t}\n\t\t\t});\n\t\t\tlet currentTarget = $(e.currentTarget);\n\t\t\tlet requestParams = {};\n\t\t\tif (currentTarget.hasClass('js-conditions-fields')) {\n\t\t\t\trequestParams = {\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\t\tsourceModuleName: self.sourceModuleName,\n\t\t\t\t\tfieldname: currentTarget.val()\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\trequestParams = {\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\t\tsourceModuleName: self.sourceModuleName,\n\t\t\t\t\tfieldname: container.find('.js-conditions-fields').val(),\n\t\t\t\t\toperator: currentTarget.val()\n\t\t\t\t};\n\t\t\t}\n\t\t\tAppConnector.request(requestParams).done(function(data) {\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\tcontainer.html($(data).html());\n\t\t\t\tself.registerChangeConditions(container);\n\t\t\t\tself.registerField(container);\n\t\t\t\tself.registerChangeValueEvent(container);\n\t\t\t\tself.onChange(self);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * register field types related events\n\t * @param {jQuery} container\n\t */\n\tregisterField(container) {\n\t\tApp.Fields.Picklist.showSelect2ElementView(container.find('select.select2'));\n\t\tApp.Fields.Date.register(container, true, {}, 'js-date-field');\n\t\tApp.Fields.Date.registerRange(container.find('.js-date-range-field'), { ranges: false });\n\t\tApp.Fields.DateTime.register(container.find('.js-datetime-range-field'));\n\t\tapp.registerEventForClockPicker($(container.find('.clockPicker')));\n\t}\n\n\t/**\n\t * Register events to add condition\n\t */\n\tregisterAddCondition() {\n\t\tlet self = this;\n\t\tthis.container.on('click', '.js-condition-add', function(e) {\n\t\t\tlet progress = $.progressIndicator({\n\t\t\t\tposition: 'html',\n\t\t\t\tblockInfo: {\n\t\t\t\t\tenabled: true\n\t\t\t\t}\n\t\t\t});\n\t\t\tlet container = $(this)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.find('> .js-condition-builder-conditions-container');\n\t\t\tAppConnector.request({\n\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\tparent: app.getParentModuleName(),\n\t\t\t\tview: 'ConditionBuilder',\n\t\t\t\tsourceModuleName: self.sourceModuleName\n\t\t\t}).done(function(data) {\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\tdata = $(data);\n\t\t\t\tApp.Fields.Picklist.showSelect2ElementView(data.find('select.select2'));\n\t\t\t\tself.registerChangeConditions(data);\n\t\t\t\tself.registerChangeValueEvent(data);\n\t\t\t\tcontainer.append(data);\n\t\t\t\tself.onChange(self);\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Register events to add group\n\t */\n\tregisterAddGroup() {\n\t\tthis.container.on('click', '.js-group-add', e => {\n\t\t\tlet template = this.container.find('.js-condition-builder-group-template').clone();\n\t\t\ttemplate.removeClass('hide');\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.find('> .js-condition-builder-conditions-container')\n\t\t\t\t.append(template.html());\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events to remove group\n\t */\n\tregisterDeleteGroup() {\n\t\tthis.container.on('click', '.js-group-delete', e => {\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-group-container')\n\t\t\t\t.remove();\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Register events to remove condition\n\t */\n\tregisterDeleteCondition() {\n\t\tthis.container.on('click', '.js-condition-delete', e => {\n\t\t\t$(e.target)\n\t\t\t\t.closest('.js-condition-builder-conditions-row')\n\t\t\t\t.remove();\n\t\t\tthis.onChange(this);\n\t\t});\n\t}\n\n\t/**\n\t * Block submit on press enter key\n\t */\n\tregisterDisableSubmitOnEnter() {\n\t\tthis.container.find('.js-condition-builder-value').keydown(function(e) {\n\t\t\tif (e.keyCode === 13) {\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Read conditions in group\n\t * @param {jQuery} container\n\t * @returns {object}\n\t */\n\treadCondition(container) {\n\t\tlet self = this;\n\t\tlet condition = container.find('> .js-condition-switch .js-condition-switch-value').hasClass('active')\n\t\t\t? 'AND'\n\t\t\t: 'OR';\n\t\tlet arr = {};\n\t\tarr['condition'] = condition;\n\t\tlet rules = [];\n\t\tcontainer.find('> .js-condition-builder-conditions-container >').each(function() {\n\t\t\tlet element = $(this);\n\t\t\tif (element.hasClass('js-condition-builder-conditions-row')) {\n\t\t\t\trules.push({\n\t\t\t\t\tfieldname: element.find('.js-conditions-fields').val(),\n\t\t\t\t\toperator: element.find('.js-conditions-operator').val(),\n\t\t\t\t\tvalue: element.find('.js-condition-builder-value').val()\n\t\t\t\t});\n\t\t\t} else if (element.hasClass('js-condition-builder-group-container')) {\n\t\t\t\trules.push(self.readCondition(element));\n\t\t\t}\n\t\t});\n\t\tarr['rules'] = rules;\n\t\treturn arr;\n\t}\n\n\t/**\n\t * Returns conditions\n\t */\n\tgetConditions() {\n\t\treturn this.readCondition(this.container.find('> .js-condition-builder-group-container'));\n\t}\n\n\t/**\n\t * Main function to regsiter events\n\t */\n\tregisterEvents() {\n\t\tlet self = this;\n\t\tthis.registerAddCondition();\n\t\tthis.registerAddGroup();\n\t\tthis.registerDeleteGroup();\n\t\tthis.registerDeleteCondition();\n\t\tthis.registerDisableSubmitOnEnter();\n\t\tthis.container.find('.js-condition-builder-conditions-row').each(function() {\n\t\t\tself.registerChangeConditions($(this));\n\t\t\tself.registerField($(this));\n\t\t});\n\t}\n}\n"],"names":["container","sourceModuleName","onChange","find","on","e","$","progressIndicator","position","blockInfo","enabled","currentTarget","requestParams","hasClass","module","app","getModuleName","parent","getParentModuleName","view","self","fieldname","val","operator","AppConnector","request","done","data","progress","mode","html","registerChangeConditions","registerField","registerChangeValueEvent","App","Fields","Picklist","showSelect2ElementView","Date","register","registerRange","ranges","DateTime","registerEventForClockPicker","closest","append","clone","template","removeClass","target","remove","keydown","keyCode","preventDefault","condition","arr","each","element","rules","push","value","readCondition","registerAddCondition","registerAddGroup","registerDeleteGroup","registerDeleteCondition","registerDisableSubmitOnEnter"],"mappings":"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"}