class Gantt{constructor(container,projectData){this.container=$(container);this.projectData=projectData;this.statuses=this.projectData.statuses;this.filter={status:{Project:this.statuses.Project.filter(status=>{return!status.closing}).map(status=>Object.assign(status)),ProjectMilestone:this.statuses.ProjectMilestone.filter(status=>{return!status.closing}).map(status=>Object.assign(status)),ProjectTask:this.statuses.ProjectTask.filter(status=>{return!status.closing}).map(status=>Object.assign(status))}};this.registerLanguage();this.registerTemplates();this.loadProject()}registerLanguage(){GanttMaster.messages.GANTT_ERROR_LOADING_DATA_TASK_REMOVED=app.vtranslate("JS_GANTT_ERROR_LOADING_DATA_TASK_REMOVED","Project");GanttMaster.messages.INVALID_DATE_FORMAT=app.vtranslate("JS_INVALID_DATE_FORMAT","Project");GanttMaster.messages.GANTT_SEMESTER_SHORT=app.vtranslate("JS_GANTT_SEMESTER_SHORT","Project");GanttMaster.messages.GANTT_SEMESTER=app.vtranslate("JS_GANTT_SEMESTER","Project");GanttMaster.messages.GANTT_QUARTER_SHORT=app.vtranslate("JS_GANTT_QUARTER_SHORT","Project");GanttMaster.messages.GANTT_QUARTER=app.vtranslate("JS_GANTT_QUARTER","Project");GanttMaster.messages.GANTT_WEEK=app.vtranslate("JS_GANTT_WEEK","Project");GanttMaster.messages.GANTT_WEEK_SHORT=app.vtranslate("JS_GANTT_WEEK_SHORT","Project");Gantt_i18n.YES=app.vtranslate("JS_YES","Project");Gantt_i18n.NO=app.vtranslate("JS_NO","Project");Gantt_i18n.INVALID_DATA=app.vtranslate("JS_INVALID_DATA","Project");Gantt_i18n.ERROR_ON_FIELD=app.vtranslate("JS_ERROR_ON_FIELD","Project");Gantt_i18n.OUT_OF_BOUDARIES=app.vtranslate("JS_OUT_OF_BOUDARIES","Project");Gantt_i18n.ERR_FIELD_MAX_SIZE_EXCEEDED=app.vtranslate("JS_ERR_FIELD_MAX_SIZE_EXCEEDED","Project");Gantt_i18n.WEEK_SHORT=app.vtranslate("JS_WEEK_SHORT","Project");Gantt_i18n.PROCEED=app.vtranslate("JS_PROCEED","Project");Gantt_i18n.PREV=app.vtranslate("JS_PREV","Project");Gantt_i18n.NEXT=app.vtranslate("JS_NEXT","Project");Gantt_i18n.HINT_SKIP=app.vtranslate("JS_HINT_SKIP","Project");Date.monthNames=App.Fields.Date.fullMonthsTranslated.map(month=>month);Date.monthAbbreviations=App.Fields.Date.monthsTranslated.map(month=>month);Date.dayAbbreviations=App.Fields.Date.daysTranslated.map(day=>day);Date.dayNames=App.Fields.Date.fullDaysTranslated.map(day=>day);Date.firstDayOfWeek=CONFIG.firstDayOfWeekNo;Date.defaultFormat=CONFIG.dateFormat;Date.today=app.vtranslate("JS_TODAY");Number.decimalSeparator=CONFIG.currencyDecimalSeparator;Number.groupingSeparator=CONFIG.currencyGroupingSeparator;Number.currencyFormat="###,##0.00"}registerTemplates(){const self=this;this.ganttTemplateFunctions=[];this.ganttTemplateFunctions.push({type:"GANTBUTTONS",render(obj){return`<div class="ganttButtonBar noprint">\n\t\t\t\t<div class="buttons">\n\t\t\t\t\t<button class="js-gantt__expand-all-btn button textual icon " title="EXPAND_ALL"><span class="teamworkIcon">6</span></button>\n\t\t\t\t\t<button class="js-gantt__collapse-all-btn button textual icon " title="COLLAPSE_ALL"><span class="teamworkIcon">5</span></button>\n\t\t\t\t\t<span class="ganttButtonSeparator"></span>\n\t\t\t\t\t<button class="js-gantt__zoom-out-btn button textual icon " title="zoom out"><span class="teamworkIcon">)</span></button>\n\t\t\t\t\t<button class="js-gantt__zoom-in-btn button textual icon " title="zoom in"><span class="teamworkIcon">(</span></button>\n\t\t\t\t\t<span class="ganttButtonSeparator"></span>\n\t\t\t\t\t<button class="js-gantt__resize-0-btn button textual icon"><span class="teamworkIcon">F</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class="js-gantt__resize-50-btn button textual icon"><span class="teamworkIcon">O</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class="js-gantt__resize-100-btn button textual icon"><span class="teamworkIcon">R</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<span class="ganttButtonSeparator"></span>\n\t\t\t\t\t<button class="js-gantt__front-filter button textual icon"><span class="teamworkIcon">f</span></button>\n\t\t\t\t</div>\n\t\t\t</div>`}});this.ganttTemplateFunctions.push({type:"TASKSEDITHEAD",render(obj){return`<table class="gdfTable" cellspacing="0" cellpadding="0">\n\t\t\t\t<thead>\n\t\t\t\t<tr style="height:40px">\n      \t\t\t\t<th class="gdfColHeader gdfResizable" style="width:80px">${app.vtranslate("JS_NO.","Project")}</th>\n\t\t\t\t\t<th class="gdfColHeader gdfResizable" style="width:300px">${app.vtranslate("JS_NAME")}</th>\n\t\t\t\t\t<th class="gdfColHeader gdfResizable" style="width:60px">${app.vtranslate("JS_PRIORITY")}</th>\n\t\t\t\t\t<th class="gdfColHeader gdfResizable" style="width:100px">${app.vtranslate("JS_STATUS")}</th>\n\t\t\t\t\t<th class="gdfColHeader gdfResizable" style="width:70px">${app.vtranslate("JS_DURATION_SHORT","Project")}</th>\n\t\t\t\t\t<th class="gdfColHeader gdfResizable" style="width:50px">%</th>\n\t\t\t\t\t<th class="gdfColHeader gdfResizable" style="width:200px">${app.vtranslate("JS_ASSIGNED","Project")}</th>\n\t\t\t\t</tr>\n\t\t\t\t</thead>\n\t\t\t</table>`}});this.ganttTemplateFunctions.push({type:"TASKROW",render(obj){return`<tr id="tid_${obj.id}" taskId="${obj.id}" class="taskEditRow ${obj.isParent()?"isParent":""} ${obj.collapsed?"collapsed":""}" level="${obj.level}">\n\t   \t\t\t<td class="gdfCell text-center">${obj.no}</td>\n\t\t\t\t<td class="gdfCell indentCell" style="padding-left:${obj.level*10+18}px;" title="${obj.name}" data-toggle="tooltip">\n\t\t\t\t\t<div class="exp-controller" align="center"></div>\n\t\t\t\t\t${obj.type==="project"?'<span class="fas fa-briefcase"></span>':obj.type==="milestone"?'<i class="fas fa-folder"></i>':'<i class="fas fa-file"></i>'}\n\t\t\t\t\t<input type="text" name="name" value="${obj.name}" placeholder="name" ${obj.canWrite?"canWrite":"disabled"}>\n\t\t\t\t</td>\n\t\t\t\t<td class="gdfCell"><input type="text" name="priority" class="text-center" autocomplete="off" value="${obj.priority_label?obj.priority_label:""}"></td>\n\t\t\t\t<td class="gdfCell"><input type="text" name="status" class="text-center" autocomplete="off" value="${obj.status_label?obj.status_label:""}"></td>\n\t\t\t\t<td class="gdfCell"><input type="text" name="duration" class="text-center" autocomplete="off" value="${obj.duration}"></td>\n\t\t\t\t<td class="gdfCell"><input type="text" name="progress" class="validated text-center" entrytype="PERCENTILE" autocomplete="off" value="${obj.progress?obj.progress:""}" ${obj.progressByWorklog?"readOnly":""}></td>\n\t\t\t\t<td class="gdfCell"><input type="text" name="assigned" class="text-center" autocomplete="off" value="${obj.assigned_user_name}"></td>\n\t\t\t</tr>`}});this.ganttTemplateFunctions.push({type:"TASKEMPTYROW",render(obj){return`<tr class="taskEditRow emptyRow">\n\t\t\t\t<td class="gdfCell"></td>\n\t\t\t\t<td class="gdfCell"></td>\n\t\t\t\t<td class="gdfCell"></td>\n\t\t\t\t<td class="gdfCell"></td>\n\t\t\t\t<td class="gdfCell"></td>\n\t\t\t\t<td class="gdfCell"></td>\n\t\t\t\t<td class="gdfCell"></td>\n\t\t\t</tr>`}});this.ganttTemplateFunctions.push({type:"TASKBAR",render(obj){return`<div class="taskBox taskBoxDiv" taskId="${obj.id}">\n\t\t\t\t<div class="layout ${obj.hasExternalDep?"extDep":""}">\n\t\t\t\t\t<div class="taskProgress"\n\t\t\t\t\t\t style="width:${obj.progress>100?100:obj.progress}%; background-color:${obj.progress>100?"red":"rgb(153,255,51);"};"></div>\n\t\t\t\t\t<div class="milestone ${obj.startIsMilestone?"active":""}"></div>\n\t\t\t\t\t<div class="taskLabel"></div>\n\t\t\t\t\t<div class="milestone end ${obj.endIsMilestone?"active":""}"></div>\n\t\t\t\t</div>\n\t\t\t</div>`}});this.ganttTemplateFunctions.push({type:"CHANGE_STATUS",render(obj){return`<div class="taskStatusBox">\n\t\t\t\t<div class="taskStatus cvcColorSquare" status="STATUS_ACTIVE" title="Active"></div>\n\t\t\t\t<div class="taskStatus cvcColorSquare" status="STATUS_DONE" title="Completed"></div>\n\t\t\t\t<div class="taskStatus cvcColorSquare" status="STATUS_FAILED" title="Failed"></div>\n\t\t\t\t<div class="taskStatus cvcColorSquare" status="STATUS_SUSPENDED" title="Suspended"></div>\n\t\t\t\t<div class="taskStatus cvcColorSquare" status="STATUS_WAITING" title="Waiting" style="display: none;"></div>\n\t\t\t\t<div class="taskStatus cvcColorSquare" status="STATUS_UNDEFINED" title="Undefined"></div>\n\t\t\t</div>`}});this.ganttTemplateFunctions.push({type:"ASSIGNMENT_ROW",render(obj){return`<tr taskId="${obj.task.id}" assId="${obj.assig.id}" class="assigEditRow">\n\t\t\t\t<td><select name="resourceId" class="formElements" ${obj.assig.id.indexOf("tmp_")==0?"":"disabled"}></select></td>\n\t\t\t\t<td><select type="select" name="roleId" class="formElements"></select></td>\n\t\t\t\t<td><input type="text" name="effort" value="${getMillisInHoursMinutes(obj.assig.effort)}" size="5" class="formElements"></td>\n\t\t\t\t<td align="center"><span class="teamworkIcon delAssig del" style="cursor: pointer">d</span></td>\n\t\t\t</tr>`}});this.ganttTemplateFunctions.push({type:"RESOURCE_ROW",render(obj){return`<tr resId="${obj.id}" class="resRow">\n\t\t\t\t<td><input type="text" name="name" value="${obj.name}" style="width:100%;" class="formElements"></td>\n\t\t\t\t<td align="center"><span class="teamworkIcon delRes del" style="cursor: pointer">d</span></td>\n\t\t\t</tr>`}});this.ganttTemplateFunctions.push({type:"TASKEDITHEAD",render(obj){return""}});this.ganttTemplateFunctions.push({type:"TASK_EDITOR",render(obj){return""}});this.ganttTemplateFunctions.push({type:"RESOURCE_EDITOR",render(obj){return""}});this.ganttTemplateFunctions.push({type:"RESOURCE_EDITOR",render(obj){return""}})}makeTree(tasks,parent={id:0}){parent={...parent};if(typeof parent.children==="undefined"){parent.children=[]}for(let child of tasks){child={...child};if(typeof child.parent==="undefined"){child.parent=0}if(child.parent===parent.id){child=this.makeTree(tasks,child);parent.children.push(child)}}return parent}flattenTree(tree,flat=[]){for(let child of tree.children){flat.push(child);flat=this.flattenTree(child,flat)}return flat}getBranchesWithStatus(moduleName,statuses,current){current={...current};let children=[];current.children=current.children.map(task=>task);for(let task of current.children){if(task.module!==moduleName||statuses.map(status=>status.value).indexOf(task.normalized_status)>-1||statuses.length===0){children.push(this.getBranchesWithStatus(moduleName,statuses,task))}}current.children=children;return current}filterProjectData(projectData){let newProjectData=Object.assign({},projectData);let tree=this.makeTree(newProjectData.tasks);for(let moduleName in this.filter.status){if(this.filter.status.hasOwnProperty(moduleName)){tree=this.getBranchesWithStatus(moduleName,this.filter.status[moduleName],tree)}}newProjectData.tasks=this.flattenTree(tree);return newProjectData}loadProject(){this.gantt=new GanttMaster(this.ganttTemplateFunctions);this.gantt.resourceUrl="/libraries/jQueryGantt/res/";this.gantt.init(this.container);this.allTasks=this.projectData.tasks;if(this.allTasks.length>0){this.gantt.loadProject($.extend(true,{},this.filterProjectData(this.projectData)));this.registerEvents()}}reloadData(data){this.gantt.loadProject(data)}saveFilter(filterOptions){this.filter=filterOptions;this.reloadData(this.filterProjectData(this.projectData))}getStatusFromValue(value,moduleName){for(let status of this.statuses[moduleName]){if(status.value===value){return Object.assign({},status)}}app.errorLog(`Status not found [${value}]`)}showFiltersModal(){const self=this;const box=bootbox.dialog({show:"false",message:`<div class="js-gantt__filter-modal form" data-js="container">\n\t\t\t\t<div class="form-group">\n\t\t\t\t\t<label>${app.vtranslate("JS_PROJECT_STATUSES","Project")}:</label>\n\t\t\t\t\t<select class="select2 form-control" id="js-gantt__filter-project" multiple>\n\t\t\t\t\t\t${self.statuses.Project.map(status=>{return`<option value="${status.value}" ${this.filter.status.Project.map(status=>status.value).indexOf(status.value)>=0?"selected":""}>${status.label}</option>`})}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t\t<div class="form-group">\n\t\t\t\t<label>${app.vtranslate("JS_MILESTONE_STATUSES","Project")}:</label>\n\t\t\t\t\t<select class="select2 form-control" id="js-gantt__filter-milestone" multiple>\n\t\t\t\t\t\t${self.statuses.ProjectMilestone.map(status=>{return`<option value="${status.value}" ${this.filter.status.ProjectMilestone.map(status=>status.value).indexOf(status.value)>=0?"selected":""}>${status.label}</option>`})}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t\t<div class="form-group">\n\t\t\t\t<label>${app.vtranslate("JS_TASK_STATUSES","Project")}:</label>\n\t\t\t\t\t<select class="select2 form-control" id="js-gantt__filter-task" multiple>\n\t\t\t\t\t\t${self.statuses.ProjectTask.map(status=>{return`<option value="${status.value}" ${this.filter.status.ProjectTask.map(status=>status.value).indexOf(status.value)>=0?"selected":""}>${status.label}</option>`})}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</div>`,title:'<span class="fas fa-filter"></span> '+app.vtranslate("JS_FILTER_BY_STATUSES","Project"),buttons:{success:{label:'<span class="fas fa-check mr-1"></span>'+app.vtranslate("JS_UPDATE_GANTT","Project"),className:"btn-success",callback:function(){self.saveFilter({status:{Project:$("#js-gantt__filter-project",this).val().map(status=>{return self.getStatusFromValue(status,"Project")}),ProjectMilestone:$("#js-gantt__filter-milestone",this).val().map(status=>{return self.getStatusFromValue(status,"ProjectMilestone")}),ProjectTask:$("#js-gantt__filter-task",this).val().map(status=>{return self.getStatusFromValue(status,"ProjectTask")})}})}},danger:{label:'<span class="fas fa-times mr-1"></span>'+app.vtranslate("JS_CANCEL"),className:"btn-danger",callback:function(){}}}});App.Fields.Picklist.showSelect2ElementView($(box).find(".select2"));box.show()}registerEvents(){const container=this.container;const self=this;container.find(".js-gantt__expand-all-btn",container).on("click",function(e){e.preventDefault();container.trigger("expandAll.gantt")});container.find(".js-gantt__collapse-all-btn",container).on("click",function(e){e.preventDefault();container.trigger("collapseAll.gantt")});container.find(".js-gantt__zoom-in-btn",container).on("click",function(e){e.preventDefault();container.trigger("zoomPlus.gantt")});container.find(".js-gantt__zoom-out-btn").on("click",function(e){e.preventDefault();container.trigger("zoomMinus.gantt")});container.find(".js-gantt__print-btn").on("click",function(e){e.preventDefault();container.trigger("print.gantt")});container.find(".js-gantt__show-critical-path-btn").on("click",function(e){e.preventDefault();this.gantt.gantt.showCriticalPath=!gantt.gantt.showCriticalPath;this.gantt.redraw()}.bind(this));container.find(".js-gantt__resize-0-btn").on("click",function(e){e.preventDefault();this.gantt.splitter.resize(.1)}.bind(this));container.find(".js-gantt__resize-50-btn").on("click",function(e){e.preventDefault();this.gantt.splitter.resize(50)}.bind(this));container.find(".js-gantt__resize-100-btn").on("click",function(e){e.preventDefault();this.gantt.splitter.resize(100)}.bind(this));container.find(".js-gantt__fullscreen-btn").on("click",function(e){e.preventDefault();container.trigger("fullScreen.gantt")}.bind(this));container.find(".js-gantt__front-filter").on("click",function(e){e.preventDefault();self.showFiltersModal()});container.find('[data-toggle="tooltip"]').tooltip()}}