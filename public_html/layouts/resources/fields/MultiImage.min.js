'use strict';

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

var MultiImage=function(){function a(b){classCallCheck(this,a);var c=this;this.elements={},this.options={zoomTitleAnimation:{in:'fadeIn',out:'fadeOut'},showCarousel:!0},this.detailView=!1,this.elements.fileInput=$(b).find('.js-multi-image__file').eq(0),0===this.elements.fileInput.length&&(this.detailView=!0),this.elements.component=$(b).eq(0),this.elements.form=$(b).closest('form').eq(0),$(this.elements.form).on('submit',this.onFormSubmit),this.elements.addButton=this.elements.component.find('.js-multi-image__file-btn').eq(0),this.elements.values=this.elements.component.find('.js-multi-image__values').eq(0),this.elements.progressBar=this.elements.component.find('.js-multi-image__progress-bar').eq(0),this.elements.progress=this.elements.component.find('.js-multi-image__progress').eq(0),this.elements.result=this.elements.component.find('.js-multi-image__result').eq(0),this.fieldInfo=this.elements.values.data('fieldinfo'),this.options.formats=this.fieldInfo.formats,this.options.limit=this.fieldInfo.limit,this.files=this.detailView?this.elements.values.data('value'):JSON.parse(this.elements.values.val()),this.detailView||(this.elements.fileInput.detach(),this.elements.addButton.click(this.addButtonClick.bind(this)),this.elements.fileInput.fileupload({dataType:'json',replaceFileInput:!1,fileInput:this.fileInput,autoUpload:!1,submit:this.submit.bind(this),add:this.add.bind(this),progressall:this.progressAll.bind(this),change:this.change.bind(this),drop:this.change.bind(this),dragover:this.dragOver.bind(this),fail:this.uploadError.bind(this),done:this.uploadSuccess.bind(this)}),this.elements.component.on('dragleave',this.dragLeave.bind(this)),this.elements.component.on('dragend',this.dragLeave.bind(this)),this.elements.fileInput.fileupload('option','dropZone',$(this.elements.component)),this.enableDragNDrop()),this.elements.component.on('click','.js-multi-image__popover-img',function(){c.zoomPreview($(this).data('hash'));}),this.elements.component.on('click','.js-multi-image__popover-btn-zoom',function(a){a.preventDefault(),c.zoomPreview($(this).data('hash'));}),this.elements.component.on('click','.js-multi-image__popover-btn-download',function(a){a.preventDefault(),c.download($(this).data('hash'));}),this.detailView||this.elements.component.on('click','.js-multi-image__popover-btn-delete',function(a){a.preventDefault(),c.deleteFile($(this).data('hash'));}),this.loadExistingFiles(),'undefined'==typeof $.fn.animateCss&&$.fn.extend({animateCss:function d(a,b){var c=function(a){var b={animation:'animationend',OAnimation:'oAnimationEnd',MozAnimation:'mozAnimationEnd',WebkitAnimation:'webkitAnimationEnd'};for(var c in b)if(void 0!==a.style[c])return b[c]}(document.createElement('div'));return this.addClass('animated '+a).one(c,function(){$(this).removeClass('animated '+a),'function'==typeof b&&b();}),this}});}return createClass(a,[{key:'onFormSubmit',value:function b(a){return !App.Fields.MultiImage.currentFileUploads||(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),bootbox.alert(app.vtranslate('JS_WAIT_FOR_FILE_UPLOAD')),!1)}},{key:'addButtonClick',value:function b(a){a.preventDefault(),this.elements.fileInput.trigger('click');}},{key:'submit',value:function c(a,b){b.formData={hash:b.files[0].hash},App.Fields.MultiImage.currentFileUploads++;}},{key:'getFileInfo',value:function b(a){for(var c,d=0,e=this.files.length;d<e;d++)if(c=this.files[d],c.hash===a)return c;app.errorLog('File \''+a+'\' not found.'),Vtiger_Helper_Js.showPnotify({text:app.vtranslate('JS_INVALID_FILE_HASH')+(' ['+a+']')});}},{key:'addFileInfoProperty',value:function e(a,b,c){var d=this.getFileInfo(a);return d[b]=c,d}},{key:'uploadError',value:function g(a,b){var c=this;app.errorLog('File upload error.');var d=b.jqXHR,e=b.files;if('undefined'==typeof d.responseJSON||null===d.responseJSON)return App.Fields.MultiImage.currentFileUploads--,Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_FILE_UPLOAD_ERROR'));var f=d.responseJSON;return 'undefined'!=typeof f.result&&'undefined'!=typeof f.result.attach&&Array.isArray(f.result.attach)?(f.result.attach.forEach(function(a){App.Fields.MultiImage.currentFileUploads--,c.deleteFile(a.hash,!1),'string'==typeof a.error?Vtiger_Helper_Js.showPnotify(a.error+(' ['+a.name+']')):Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_FILE_UPLOAD_ERROR')+(' ['+a.name+']'));}),void this.updateFormValues()):void(e.forEach(function(a){App.Fields.MultiImage.currentFileUploads--,c.deleteFile(a.hash,!1),Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_FILE_UPLOAD_ERROR')+(' ['+a.name+']'));}),this.updateFormValues())}},{key:'uploadSuccess',value:function f(a,b){var c=this,d=b.result,e=d.result.attach;e.forEach(function(d){var e=d.hash;if(!e)return app.errorLog(new Error(app.vtranslate('JS_INVALID_FILE_HASH')+(' ['+e+']')));if('undefined'==typeof d.key)return c.uploadError(a,b);var f=c.getFileInfo(e);c.addFileInfoProperty(e,'key',d.key),c.addFileInfoProperty(e,'size',d.size),c.addFileInfoProperty(e,'name',d.name),c.removePreviewPopover(e),c.addPreviewPopover(f.file,f.previewElement,f.imageSrc),App.Fields.MultiImage.currentFileUploads--;}),this.updateFormValues();}},{key:'updateFormValues',value:function b(){var a=this.files.map(function(a){return {key:a.key,name:a.name,size:a.size}});this.elements.values.val(JSON.stringify(a));}},{key:'validateFile',value:function c(a){var b=!1;return this.options.formats.forEach(function(c){a.type==='image/'+c&&(b=!0);}),b||Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_INVALID_FILE_TYPE')+' ['+a.name+']\n'+app.vtranslate('JS_AVAILABLE_FILE_TYPES')+'  ['+this.options.formats.join(', ')+']'),b}},{key:'showLimitError',value:function a(){this.elements.fileInput.val(''),Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_FILE_LIMIT')+' ['+this.options.limit+']');}},{key:'filterValidFiles',value:function c(a){var b=this;return a.length+this.files.length>this.options.limit?(this.showLimitError(),[]):a.filter(function(a){return b.validateFile(a)})}},{key:'setFilesHash',value:function f(a){for(var b,c=[],d=0,e=a.length;d<e;d++)if(b=a[d],'undefined'==typeof b.hash)if(this.files.length<this.options.limit)b.hash=App.Fields.Text.generateRandomHash(CONFIG.userId),this.files.push({hash:b.hash,imageSrc:b.imageSrc,name:b.name,file:b}),c.push(b);else return this.showLimitError(),c;return c}},{key:'add',value:function c(a,b){0<b.files.length&&b.submit();}},{key:'progressAll',value:function e(a,b){var c=this,d=parseInt(100*(b.loaded/b.total),10);this.elements.progressBar.css({width:d+'%'}),100===d?setTimeout(function(){c.elements.progress.addClass('d-none'),c.elements.progressBar.css({width:'0%'});},1e3):this.elements.progress.removeClass('d-none');}},{key:'dragOver',value:function a(){this.elements.component.addClass('c-multi-image__drop-effect');}},{key:'dragLeave',value:function a(){this.elements.component.removeClass('c-multi-image__drop-effect');}},{key:'download',value:function c(a){var b=this.getFileInfo(a);return 'file.php'===b.imageSrc.substr(0,8).toLowerCase()?this.downloadFile(a):this.downloadBase64(a)}},{key:'downloadFile',value:function d(a){var b=this.getFileInfo(a),c=document.createElement('a');$(c).css('display','none'),'string'==typeof c.download?(document.body.appendChild(c),c.download=b.name,c.href=b.imageSrc,c.click(),document.body.removeChild(c)):location.replace(b.imageSrc);}},{key:'downloadBase64',value:function e(a){var b=this.getFileInfo(a),c='data:application/octet-stream;filename='+b.name+';base64,'+b.imageSrc.split(',')[1],d=document.createElement('a');$(d).css('display','none'),'string'==typeof d.download?(document.body.appendChild(d),d.download=b.name,d.href=c,d.click(),document.body.removeChild(d)):location.replace(c);}},{key:'zoomPreview',value:function g(a){var b=this,c=this,d=this.getFileInfo(a),e=function(){return '<i class="fa fa-image"></i> '+d.name},f={size:'large',backdrop:!0,onEscape:!0,title:'<span id="bootbox-title-'+a+'" class="animated '+this.options.zoomTitleAnimation.in+'">'+e()+'</span>',message:'<img src="'+d.imageSrc+'" class="w-100" />',buttons:{}};this.options.showCarousel&&(f.message=this.generateCarousel(a)),this.detailView||(f.buttons.Delete={label:'<i class="fa fa-trash-alt"></i> '+app.vtranslate('JS_DELETE'),className:'float-left btn btn-danger',callback:function a(){c.deleteFile(d.hash);}}),f.buttons.Download={label:'<i class="fa fa-download"></i> '+app.vtranslate('JS_DOWNLOAD'),className:'float-left btn btn-success',callback:function a(){c.download(d.hash);}},f.buttons.Close={label:'<i class="fa fa-times"></i> '+app.vtranslate('JS_CLOSE'),className:'btn btn-warning',callback:function a(){}},bootbox.dialog(f),this.options.showCarousel&&($('#bootbox-title-'+a).css({"animation-duration":'350ms'}),$('#carousel-'+a).on('slide.bs.carousel',function(c){d=b.getFileInfo($(c.relatedTarget).data('hash'));var f=b.options.zoomTitleAnimation.in,g=b.options.zoomTitleAnimation.out;$('#bootbox-title-'+a).animateCss(g,function(){$('#bootbox-title-'+a).html(e()).removeClass('animated '+g).animateCss(f);});}));}},{key:'deleteFileCallback',value:function c(a){var b=this.getFileInfo(a);b.previewElement.popover('dispose').remove(),this.files=this.files.filter(function(a){return a.hash!==b.hash}),this.updateFormValues();}},{key:'deleteFile',value:function d(a){var b=this,c=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(c){var e=this.getFileInfo(a);bootbox.confirm({title:'<i class="fa fa-trash-alt"></i> '+app.vtranslate('JS_DELETE_FILE'),message:app.vtranslate('JS_DELETE_FILE_CONFIRMATION')+' <span class="font-weight-bold">'+e.name+'</span>?',callback:function d(c){c&&b.deleteFileCallback(a);}});}else this.deleteFileCallback(a);}},{key:'change',value:function d(a,b){var c=this;b.files=this.filterValidFiles(b.files),b.files=this.setFilesHash(b.files),this.dragLeave(a),b.files.length&&this.generatePreviewElements(b.files,function(){c.redraw();});}},{key:'addPreviewPopover',value:function h(a,b,c){var d=this,e='',f=this.getFileInfo(a.hash);'undefined'!=typeof f.size&&(e='<div class="p-1 bg-white border rounded small position-absolute">'+f.size+'</div>');var g='';return this.detailView||(g='<button class="btn btn-sm btn-danger c-btn-collapsible js-multi-image__popover-btn-delete" type="button" data-hash="'+a.hash+'" data-js="click"><i class="fa fa-trash-alt"></i> <span>'+app.vtranslate('JS_DELETE')+'</span></button>'),$(b).popover({container:d.elements.component,title:'<div class="u-text-ellipsis"><i class="fa fa-image"></i> '+a.name+'</div>',html:!0,trigger:'focus',placement:'top',content:'<img src="'+c+'" class="w-100 js-multi-image__popover-img c-multi-image__popover-img" data-hash="'+a.hash+'" data-js="click"/>',template:'<div class="popover" role="tooltip">\n\t\t\t\t<div class="arrow"></div>\n\t\t\t\t<h3 class="popover-header"></h3>\n\t\t\t\t<div class="popover-body"></div>\n\t\t\t\t<div class="text-right popover-footer js-multi-image__popover-actions">\n\t\t\t\t\t'+e+'\n\t\t\t\t\t'+g+'\n\t\t\t\t\t<button class="btn btn-sm btn-success c-btn-collapsible js-multi-image__popover-btn-download" type="button" data-hash="'+a.hash+'" data-js="click"><i class="fa fa-download"></i> <span>'+app.vtranslate('JS_DOWNLOAD')+'</span></button>\n\t\t\t\t\t<button class="btn btn-sm btn-primary c-btn-collapsible js-multi-image__popover-btn-zoom" type="button" data-hash="'+a.hash+'" data-js="click"><i class="fa fa-search-plus"></i> <span>'+app.vtranslate('JS_ZOOM_IN')+'</span></button>\n\t\t\t\t</div>\n\t\t\t</div>'})}},{key:'removePreviewPopover',value:function c(a){var b=this.getFileInfo(a);'undefined'!=typeof b.previewElement&&b.previewElement.popover('dispose');}},{key:'sortOver',value:function a(){this.elements.result.find('.js-multi-image__preview').popover('hide');}},{key:'sortStop',value:function c(){var a=this,b=this.elements.result.find('.js-multi-image__preview').toArray();this.files=b.map(function(b){for(var c,d=0,e=a.files.length;d<e;d++)if(c=$(b).data('hash'),a.files[d].hash===c)return a.files[d]}),this.redraw();}},{key:'redraw',value:function b(){var a=this;this.files.forEach(function(b){a.elements.result.append(b.previewElement);}),this.updateFormValues();}},{key:'enableDragNDrop',value:function a(){this.elements.result.sortable({handle:'.js-multi-image__preview-img',items:'.js-multi-image__preview',over:this.sortOver.bind(this),stop:this.sortStop.bind(this)}).disableSelection().on('mousedown','.js-multi-image__preview-img',function(){this.focus();});}},{key:'generatePreviewElements',value:function d(a,b){var c=this;a.forEach(function(a){a instanceof File?c.generatePreviewFromFile(a,function(d,e){a.preview=c.addPreviewPopover(a,d,e),c.addFileInfoProperty(a.hash,'previewElement',a.preview),b(a.preview);}):c.generatePreviewFromValue(a,function(d,e){a.preview=c.addPreviewPopover(a,d,e),c.addFileInfoProperty(a.hash,'previewElement',a.preview),b(a.preview);});});}},{key:'generatePreviewFromFile',value:function e(a,b){var c=this,d=new FileReader;d.onload=function(){a.imageSrc=d.result,c.addFileInfoProperty(a.hash,'imageSrc',a.imageSrc),b('<div class="d-inline-block mr-1 js-multi-image__preview" id="js-multi-image__preview-hash-'+a.hash+'" data-hash="'+a.hash+'" data-js="container|click">\n\t\t\t\t\t<div class="img-thumbnail js-multi-image__preview-img c-multi-image__preview-img" data-hash="'+a.hash+'" data-js="drag" style="background-image:url('+d.result+')" tabindex="0" title="'+a.name+'"></div>\n\t\t\t</div>',d.result);},d.readAsDataURL(a);}},{key:'generatePreviewFromValue',value:function c(a,b){b('<div class="d-inline-block mr-1 js-multi-image__preview" id="js-multi-image__preview-hash-'+a.hash+'" data-hash="'+a.hash+'" data-js="container|click">\n\t\t\t\t<div class="img-thumbnail js-multi-image__preview-img c-multi-image__preview-img" data-hash="'+a.hash+'" data-js="drag" style="background-image:url('+a.imageSrc+')" tabindex="0" title="'+a.name+'"></div>\n\t\t</div>',a.imageSrc);}},{key:'loadExistingFiles',value:function b(){var a=this;this.files=this.files.map(function(a){return a.hash=App.Fields.Text.generateRandomHash(CONFIG.userId),a}).slice(0,this.options.limit),this.generatePreviewElements(this.files,function(b){a.elements.result.append(b);}),this.updateFormValues();}},{key:'generateCarousel',value:function c(a){if(1>=this.files.length){var d=this.getFileInfo(a);return '<img class="d-block w-100" src="'+d.imageSrc+'">'}var b='<div id="carousel-'+a+'" class="carousel slide c-carousel" data-ride="carousel" data-js="container">\n\t\t  <div class="carousel-inner">';return this.files.forEach(function(c){b+='<div class="carousel-item c-carousel__item',c.hash===a&&(b+=' active'),b+='" data-hash="'+c.hash+'">\n\t\t      <img class="d-block w-100 c-carousel__image" src="'+c.imageSrc+'">\n\t\t    </div>';}),b+='<a class="carousel-control-prev c-carousel__prevnext-btn c-carousel__prev-btn" href="#carousel-'+a+'" role="button" data-slide="prev" data-js="click">\n\t\t    <span class="fas fa-caret-left fa-2x c-carousel__prev-icon" data-fa-transform="left-1" aria-hidden="true"></span>\n\t\t  </a>\n\t\t  <a class="carousel-control-next c-carousel__prevnext-btn c-carousel__next-btn" href="#carousel-'+a+'" role="button" data-slide="next" data-js="click">\n\t\t    <span class="fas fa-caret-right fa-2x c-carousel__next-icon" data-fa-transform="right-1" aria-hidden="true"></span>\n\t\t  </a>\n\t\t</div>',b}}]),a}();
