
window.rcmail&&rcmail.addEventListener("init",function(a){var c=window.crm=getCrmWindow();var b=rcmail.env.site_URL+"index.php?";rcmail.env.compose_commands.push("yetiforce.addFilesToMail");rcmail.env.compose_commands.push("yetiforce.addFilesFromCRM");rcmail.register_command("yetiforce.addFilesToMail",function(f){var e=new Date().getTime(),d="rcmupload"+e,g=rcmail.async_upload_form_frame(d);f._uploadid=e;jQuery.ajax({url:"?_task=mail&_action=plugin.yetiforce.addFilesToMail&_id="+rcmail.env.compose_id,type:"POST",data:f,success:function(i){var j=g[0].contentWindow.document;var h=$("html",j);h.html(i)}})},true);rcmail.register_command("yetiforce.addFilesFromCRM",function(e){if(c!=false){var g={module:"Documents",src_module:"Documents",multi_select:true,url:b};var f=$(this);var d=jQuery.Event(c.Vtiger_Edit_Js.preReferencePopUpOpenEvent);f.trigger(d);var e={};show(g,function(j){var i=JSON.parse(j);var h=[];for(var k in i){h.push(k)}rcmail.command("yetiforce.addFilesToMail",{ids:h,_uploadid:new Date().getTime()})})}},true);$("#composeheaders #oss_btn_bar .oss_btn").click(function(){var e=$(this).attr("data-input");var d=$(this).attr("data-module");var f={module:d,src_module:"OSSMail",multi_select:true,url:b};show(f,function(i){var g=JSON.parse(i);var h=Object.keys(g).length;for(var j in g){getMailFromCRM(e,d,j,h)}})});jQuery.ajax({type:"Get",url:b+"module=OSSMailTemplates&action=GetTemplates",async:false,success:function(f){var d=[];var e=[];$.each(f.result,function(g,h){jQuery("#vtmodulemenulink").removeClass("disabled");jQuery("#tplmenulink").removeClass("disabled");e.push({name:h.module,label:h.moduleName});jQuery("#tplmenu #texttplsmenu").append('<li class="'+h.module+'"><a href="#" data-module="'+h.module+'" data-tplid="'+h.id+'" class="active">'+h.name+"</a></li>")});$.each(e,function(g,h){if(jQuery.inArray(h.name,d)==-1){jQuery("#vtmodulemenu .toolbarmenu").append('<li class="'+h.name+'"><a href="#" data-module="'+h.name+'" class="active">'+h.label+"</a></li>");d.push(h.name)}})}});jQuery("#vtmodulemenu li a").on("click",function(){var d=jQuery(this).data("module");if(d==undefined){jQuery("#tplmenu li").show()}else{jQuery("#tplmenu li."+d).show();jQuery("#tplmenu li").not("."+d).hide()}});if(rcmail.env.crmModule!=undefined){jQuery("#vtmodulemenu li."+rcmail.env.crmModule+" a").trigger("click")}jQuery("#tplmenu  li a").on("click",function(){var h=jQuery(this).data("tplid");var f=rcmail.env.crmRecord,e=rcmail.env.crmModule,d=rcmail.env.crmView;if(d=="List"){var g=jQuery(c.document).find(".listViewEntriesCheckBox")[0];f=jQuery(g).val()}jQuery.ajax({type:"Get",url:b+"module=OSSMailTemplates&action=GetTpl",data:{id:h,record_id:f,select_module:e},success:function(l){var j=jQuery('[name="_subject"]').val();var k=jQuery("<div/>").html(l.result.content).html();jQuery('[name="_subject"]').val(j+" "+l.result.subject);if(window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody))){var i=tinyMCE.activeEditor.getContent();tinymce.activeEditor.setContent(k+i)}else{var i=jQuery("#composebody").val();jQuery("#composebody").val(k+i)}if(l.result.hasOwnProperty("attachments")){rcmail.command("yetiforce.addFilesToMail",l.result.attachments)}}})})});function getCrmWindow(){if(opener!==null){return opener.parent}else{if(typeof parent.app=="object"){return parent}}return false}function getMailFromCRM(c,b,a,d){if(d>1){d=1}else{d=0}window.crm.Vtiger_Index_Js.getEmailFromRecord(a,b,d).then(function(f){if(f==""){var e={text:window.crm.app.vtranslate("NoFindEmailInRecord"),animation:"show"};window.crm.Vtiger_Helper_Js.showPnotify(e)}else{var g=$("#"+c).val();if(g!=""&&g.charAt(g.length-1)!=","){g=g+","}$("#"+c).val(g+f)}})}function show(c,d,i,f,b){var h=window.crm.Vtiger_Popup_Js.getInstance();if(typeof c=="undefined"){c={}}if(typeof c=="object"&&(typeof c.view=="undefined")){c.view="Popup"}if(typeof f=="undefined"){f="postSelection"+Math.floor(Math.random()*10000)}if(typeof i=="undefined"){i="test"}if(typeof c=="object"){c.triggerEventName=f}else{c+="&triggerEventName="+f}var e=(typeof c=="string")?c:window.crm.jQuery.param(c);var a=c.url+e;var g=window.crm.window.open(a,i,"width=800,height=650,resizable=0,scrollbars=1");if(typeof h.destroy=="function"){h.destroy()}window.crm.jQuery.initWindowMsg();if(typeof d!="undefined"){h.retrieveSelectedRecords(d,f)}if(typeof b=="function"){window.crm.jQuery.windowMsg("Vtiger.OnPopupWindowLoad.Event",function(j){b(j)})}return g};