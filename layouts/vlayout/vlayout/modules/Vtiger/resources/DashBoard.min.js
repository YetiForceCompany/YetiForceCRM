
jQuery.Class("Vtiger_DashBoard_Js",{gridster:false,currentInstance:false,addWidget:function(d,c){var d=jQuery(d);var g=d.data("linkid");var b=d.data("name");jQuery(d).parent().remove();if(jQuery("ul.widgetsList li").size()<1){jQuery("ul.widgetsList").prev("button").css("visibility","hidden")}var f=jQuery('<li class="new dashboardWidget" id="'+g+'" data-name="'+b+'" data-mode="open"></li>');f.data("url",c);var e=d.data("width");var a=d.data("height");Vtiger_DashBoard_Js.gridster.add_widget(f,e,a);Vtiger_DashBoard_Js.currentInstance.loadWidget(f)},restrictContentDrag:function(a){a.on("mousedown.draggable",function(d){var c=jQuery(d.target);var b=c.closest(".dashboardWidgetHeader").length>0?true:false;if(b){return}d.stopPropagation()})},},{container:false,instancesCache:{},init:function(){Vtiger_DashBoard_Js.currentInstance=this},getContainer:function(){if(this.container==false){this.container=jQuery(".gridster ul")}return this.container},getWidgetInstance:function(b){var c=b.attr("id");if(!(c in this.instancesCache)){var a=b.data("name");this.instancesCache[c]=Vtiger_Widget_Js.getInstance(b,a)}return this.instancesCache[c]},registerGridster:function(){var a=this;Vtiger_DashBoard_Js.gridster=this.getContainer().gridster({widget_margins:[7,7],widget_base_dimensions:[((a.getContainer().width()/12)-14),100],min_cols:6,min_rows:20,max_size_x:12,draggable:{stop:function(){a.savePositions(jQuery(".dashboardWidget"))}}}).data("gridster")},savePositions:function(d){var c={};for(var b=0,a=d.length;b<a;++b){var e=jQuery(d[b]);c[e.attr("id")]=JSON.stringify({row:e.attr("data-row"),col:e.attr("data-col")})}AppConnector.request({module:"Vtiger",action:"SaveWidgetPositions",positionsmap:c}).then(function(f){})},loadWidgets:function(){var a=this;var b=jQuery(".dashboardWidget");b.each(function(c,d){a.loadWidget(jQuery(d))})},loadWidget:function(c){var b=this;var a=c.data("url");var d=c.data("mode");c.progressIndicator();if(d=="open"){AppConnector.request(a).then(function(h){c.html(h);var f=c.find(".dashboardWidgetHeader").height()+15;var g=c.height()-f;app.showScrollBar(c.find(".dashboardWidgetContent"),{height:g});var e=b.getWidgetInstance(c);c.trigger(Vtiger_Widget_Js.widgetPostLoadEvent)},function(){})}else{}},gridsterStop:function(){var a=Vtiger_DashBoard_Js.gridster},registerRefreshWidget:function(){var a=this;this.getContainer().on("click",'a[name="drefresh"]',function(f){var c=$(f.currentTarget);var d=c.closest("li");var b=a.getWidgetInstance(d);b.refreshWidget();return})},removeWidget:function(){this.getContainer().on("click",'li a[name="dclose"]',function(g){var d=$(g.currentTarget);var a=jQuery(d).parents("li");var c=a.attr("data-sizex");var j=a.attr("data-sizey");var b=d.data("url");var i=d.closest(".dashboardWidgetHeader").parent();var f=i.data("name");var h=i.find(".dashboardTitle").attr("title");var k=app.vtranslate("JS_ARE_YOU_SURE_TO_DELETE_WIDGET")+"["+h+"]. "+app.vtranslate("JS_ARE_YOU_SURE_TO_DELETE_WIDGET_INFO");Vtiger_Helper_Js.showConfirmationBox({message:k}).then(function(l){AppConnector.request(b).then(function(m){if(m.success){var e=[];i.fadeOut("slow",function(){i.remove()});if(jQuery.inArray(f,e)==-1){Vtiger_DashBoard_Js.gridster.remove_widget(d.closest("li"));jQuery(".widgetsList").prev("button").css("visibility","visible");var o="<li><a onclick=\"Vtiger_DashBoard_Js.addWidget(this, '"+m.result.url+'\')" href="javascript:void(0);"';o+="data-width="+c+" data-height="+j+" data-linkid="+m.result.linkid+" data-name="+m.result.name+">"+m.result.title+"</a></li>";var n=jQuery(".widgetsList .divider");if(n.length){jQuery(o).insertBefore(n)}else{jQuery(".widgetsList").append(o)}}}})},function(e,l){})})},registerDatePickerHideInitiater:function(){var a=this.getContainer();a.on("click","input.dateRange",function(d){var c=jQuery(d.currentTarget).closest(".dashboardWidget");var f=jQuery(".dashboardWidgetHeader",c);var b=function(){jQuery(".dateRange").DatePickerHide()};Vtiger_Helper_Js.addClickOutSideEvent(f,b);return false})},registerShowMailBody:function(){var a=this.getContainer();a.on("click",".showMailBody",function(f){var d=jQuery(f.currentTarget).closest(".mailRow");var c=d.find(".mailBody");var b=jQuery(f.currentTarget).find(".body-icon");if(c.css("display")=="none"){c.show();b.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up")}else{c.hide();b.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down")}})},registerChangeMailUser:function(){var b=this;var a=this.getContainer();a.on("change","#mailUserList",function(h){var d=$(h.currentTarget);var g=d.closest("li");var f=g.find(".dashboardWidgetContent");var i=$("option:selected",this);var c=g.data("url")+"&user="+i.val();params={};params.url=c;params.data={};f.progressIndicator({});AppConnector.request(params).then(function(e){f.progressIndicator({mode:"hide"});g.html(e).trigger(Vtiger_Widget_Js.widgetPostRefereshEvent)},function(){f.progressIndicator({mode:"hide"})})})},registerMiniListWidget:function(){var a=this;$(".dashboardHeading").on("click",".addFilter",function(c){var b=$(c.currentTarget);app.showModalWindow(null,"index.php?module=Home&view=MiniListWizard&step=step1",function(h){var d=jQuery("form",h);var e=jQuery('select[name="module"]',h);var f=jQuery('select[name="filterid"]',h);var l=jQuery('select[name="fields"]',h);var k=app.showSelect2ElementView(e,{placeholder:app.vtranslate("JS_SELECT_MODULE")});var g=app.showSelect2ElementView(f,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")});var j=app.showSelect2ElementView(l,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),closeOnSelect:true,maximumSelectionLength:6});var i=jQuery(".modal-footer",h);f.closest("tr").hide();l.closest("tr").hide();i.hide();k.change(function(){if(!k.val()){return}AppConnector.request({module:"Home",view:"MiniListWizard",step:"step2",selectedModule:k.val()}).then(function(m){f.empty().html(m).trigger("change");g.closest("tr").show()})});g.change(function(){if(!g.val()){return}AppConnector.request({module:"Home",view:"MiniListWizard",step:"step3",selectedModule:k.val(),filterid:g.val()}).then(function(m){l.empty().html(m).trigger("change");j.closest("tr").show();j.data("select2").$selection.find(".select2-search__field").parent().css("width","100%")})});j.change(function(){if(!j.val()){i.hide()}else{i.show()}});d.submit(function(s){s.preventDefault();var p=k.val();var o=k.find(":selected").text();var q=g.val();var n=g.find(":selected").text();var m=[];j.select2("data").map(function(t){m.push(t.id)});var r={module:p};if(typeof m!="object"){m=[m]}r.fields=m;a.saveMiniListWidget(r,b,o,q,n,d)})})})},saveMiniListWidget:function(h,c,b,a,f,e){var d=this;var g={data:JSON.stringify(h),action:"addWidget",blockid:c.data("block-id"),linkid:c.data("linkid"),label:b+" - "+f,name:"Mini List",filterid:a,isdefault:0,height:3,width:4,owners_all:["mine","all","users","groups"],default_owner:"mine",};d.saveWidget(g,"save").then(function(m){var i=m.result;var n={};if(m.success){app.hideModalWindow();g.id=i.id;g.status=i.status;n.text=i.text;n.type="success";var k=c.clone();k.data("name","MiniList");Vtiger_DashBoard_Js.addWidget(k,"index.php?module=Home&view=ShowWidget&name=MiniList&linkid="+c.data("linkid")+"&widgetid="+i.wid+"&active=0");Vtiger_Helper_Js.showMessage(n)}else{var l=m.error["message"];if(m.error["code"]!=513){var j=e.find('[name="fieldName"]')}else{var j=e.find('[name="fieldLabel"]')}j.validationEngine("showPrompt",l,"error","topLeft",true)}})},saveWidget:function(b,e){var a=jQuery.Deferred();var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d={form:b,module:"WidgetsManagement",parent:"Settings",sourceModule:app.getModuleName(),action:"SaveAjax",mode:e,addToUser:true,};AppConnector.request(d).then(function(f){c.progressIndicator({mode:"hide"});a.resolve(f)},function(f){c.progressIndicator({mode:"hide"});a.reject(f)});return a.promise()},registerEvents:function(){this.registerGridster();this.loadWidgets();this.registerRefreshWidget();this.removeWidget();this.registerDatePickerHideInitiater();this.gridsterStop();this.registerShowMailBody();this.registerChangeMailUser();this.registerMiniListWidget()},});