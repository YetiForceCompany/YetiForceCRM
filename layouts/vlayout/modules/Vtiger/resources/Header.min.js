
if(/MSIE 6.0/.test(navigator.userAgent)||/MSIE 7.0/.test(navigator.userAgent)||/MSIE 8.0/.test(navigator.userAgent)||/MSIE 9.0/.test(navigator.userAgent)){if(app.getCookie("oldbrowser")!="true"){app.setCookie("oldbrowser",true,365);window.location.href="layouts/vlayout/modules/Vtiger/browsercompatibility/Browser_compatibility.html"}}jQuery.Class("Vtiger_Header_Js",{quickCreateModuleCache:{},self:false,getInstance:function(){if(this.self!=false){return this.self}this.self=new Vtiger_Header_Js();return this.self}},{menuContainer:false,contentContainer:false,quickCreateCallBacks:[],init:function(){this.setMenuContainer(".navbar-fixed-top").setContentsContainer(".mainContainer")},setMenuContainer:function(a){if(a instanceof jQuery){this.menuContainer=a}else{this.menuContainer=jQuery(a)}return this},getMenuContainer:function(){return this.menuContainer},setContentsContainer:function(a){if(a instanceof jQuery){this.contentContainer=a}else{this.contentContainer=jQuery(a)}return this},getContentsContainer:function(){return this.contentContainer},getQuickCreateForm:function(c,b,f){var d=this;var a=jQuery.Deferred();var e;if(typeof f=="undefined"){f={}}if((!f.noCache)||(typeof(f.noCache)=="undefined")){if(typeof Vtiger_Header_Js.quickCreateModuleCache[b]!="undefined"){a.resolve(Vtiger_Header_Js.quickCreateModuleCache[b]);return a.promise()}}e=c;if(typeof f.data!="undefined"){var e={};e.data=f.data;e.url=c}AppConnector.request(e).then(function(g){if((!f.noCache)||(typeof(f.noCache)=="undefined")){Vtiger_Header_Js.quickCreateModuleCache[b]=g}a.resolve(g)});return a.promise()},registerQuickCreateCallBack:function(a){if(typeof a!="function"){return false}this.quickCreateCallBacks.push(a);return true},alignContentsContainer:function(a,f,e){var c=jQuery("nav.navbar-fixed-top").outerHeight();if(!a){var d=jQuery("#announcement").outerHeight();c=(c-d)}var b=this.getContentsContainer();b.animate({"margin-top":c},f,e);return this},quickCreateSave:function(c){var a=jQuery.Deferred();var b=c.serializeFormData();AppConnector.request(b).then(function(d){a.resolve(d)},function(e,d){a.reject(e,d)});return a.promise()},quickCreateGoToFullForm:function(a,b){a.find('input[name="action"]').remove();a.append('<input type="hidden" name="view" value="Edit" />');$.each(a.find("[data-validation-engine]"),function(c,d){jQuery(d).removeAttr("data-validation-engine")});a.addClass("not_validation");a.submit()},setAnnouncement:function(){var a=app.cacheGet("announcement.turnoff",false);var c=jQuery("#announcementBtn");var b=this;if(a===true){jQuery("#announcement").hide();c.attr("src",app.vimage_path("btnAnnounceOff.png"));b.alignContentsContainer("69px",0,"linear")}else{jQuery("#announcement").show();c.attr("src",app.vimage_path("btnAnnounce.png"));b.alignContentsContainer("92px",0,"linear")}},registerAnnouncement:function(){var a=this;var b=jQuery("#announcementBtn");var c="announcement.turnoff";b.click(function(g,d){var f=jQuery("#announcement").css("display");if(f=="none"){jQuery("#announcement").show();a.alignContentsContainer(true,200,"linear");b.attr("src",app.vimage_path("btnAnnounce.png"));if(!d){app.cacheSet(c,false)}}else{a.alignContentsContainer(false,200,"linear");jQuery("#announcement").hide();b.attr("src",app.vimage_path("btnAnnounceOff.png"));if(!d){app.cacheSet(c,true)}}});if(app.cacheGet(c,false)){b.trigger("click",true)}},registerCalendarButtonClickEvent:function(){var c=jQuery("#calendarBtn");var a=c.data("dateFormat");var b=c.data("date");var d=app.convertToDatePickerFormat(a);c.on("click",function(g){g.stopImmediatePropagation();c.closest("div.nav").find("div.open").removeClass("open");var f=jQuery("#"+c.data("datepickerId"));if(jQuery(f).is(":visible")){c.DatePickerHide()}else{c.DatePickerShow()}});c.DatePicker({format:d,date:b,calendars:1,starts:1,className:"globalCalendar"})},registerHelpInfo:function(a){if(typeof a=="undefined"){a=jQuery('form[name="QuickCreate"]')}app.showPopoverElementView(a.find(".HelpInfoPopover"))},handleQuickCreateData:function(b,c){if(typeof c=="undefined"){c={}}var a=this;app.showModalWindow(b,function(k){var e=k.find('form[name="QuickCreate"]');a.registerHelpInfo(e);var h=e.find('[name="module"]').val();var g=Vtiger_Edit_Js.getInstanceByModuleName(h);g.registerBasicEvents(e);a.registerChangeNearCalendarEvent(e,h);e.validationEngine(app.validationEngineOptions);if(typeof c.callbackPostShown!="undefined"){c.callbackPostShown(e)}a.registerQuickCreatePostLoadEvents(e,c);a.toggleTimesInputs(e);app.registerEventForDatePickerFields(e);var j=e.find(".quickCreateContent");var f=j.height();var i=parseInt(f);if(i>300){app.showScrollBar(jQuery(".quickCreateContent"),{height:"300px"})}var d={};d.toolbar="Basic";d.height="5em";jQuery.each(k.find(".ckEditorSource"),function(m,l){var n=new Vtiger_CkEditor_Js();n.loadCkEditor(jQuery(l),d)})})},getNearCalendarEvent:function(f,b){var j=this;typeActive=f.find("ul li.active a").data("tab-name");var e=f.find('[name="assigned_user_id"]');var g=f.find('[name="date_start"]');var c=g.val();var h=g.data("date-format");if(typeof c=="undefined"){return}var l=Vtiger_Helper_Js.convertToDateString(c,h,"-1"," ");var a=Vtiger_Helper_Js.convertToDateString(c,h," "," ");var i=Vtiger_Helper_Js.convertToDateString(c,h,"+1"," ");var k=Vtiger_Helper_Js.convertToDateString(i,"yyyy-mm-dd","+1"," ");var d={module:"Calendar",action:"Calendar",mode:"getEvents",start:l,end:k,user:e.val()};AppConnector.request(d).then(function(n){if(typeof n.result!="undefined"&&n.result.length>0){n=n.result;f.find(".modal-body").css({"max-height":"500px","overflow-y":"auto"});for(var o in n){icon="glyphicon glyphicon-calendar";linkHtml="";hidden="";helpIcon="";if(n[o]["set"]=="Task"){icon="icon-tasks"}if(n[o]["linkl"]){linkHtml='<div class="cut-string"><i class="calIcon modIcon_'+n[o]["linkm"]+'"></i> '+n[o]["linkl"]+"</div>"}helpIcon="<div><label> "+app.vtranslate("JS_START_DATE")+": &nbsp</label>"+n[o]["start"]+" </div>\n								<div><label> "+app.vtranslate("JS_END_DATE")+": &nbsp</label>"+n[o]["end"]+" </div>\n								<div class=textOverflowEllipsis><label> "+app.vtranslate("JS_SUBJECT")+": &nbsp</label>"+n[o]["title"]+"</div>\n								<div><label> "+app.vtranslate("JS_STATE")+": &nbsp</label>"+n[o]["labels"]["state"]+" </div>\n								<div><label> "+app.vtranslate("JS_STATUS")+": &nbsp</label>"+n[o]["labels"]["sta"]+" </div>\n								<div><label> "+app.vtranslate("JS_PRIORITY")+": &nbsp</label>"+n[o]["labels"]["pri"]+" </div>";if(n[o]["start"].indexOf(l)>-1){f.find("#prev_events .table").append('<tr class="mode_'+n[o]["set"]+" "+hidden+' addedNearCalendarEvent" ><td><a target="_blank" href="'+n[o]["url"]+'"><div class="cut-string"><i class="'+icon+'" style="vertical-align:middle; margin-bottom:4px;"></i><span><strong> '+n[o]["start"]+"</strong></span><span> "+n[o]["title"].substring(0,22)+' </span><span style="margin-left: 5px;margin-top: 2px;"  class="HelpInfoPopover " title="" data-placement="top" data-content="'+helpIcon+'"><i class="glyphicon glyphicon-info-sign"></i></span</div></a>'+linkHtml+"</td></tr>")}else{if(n[o]["start"].indexOf(a)>-1){f.find("#cur_events .table").append('<tr class="mode_'+n[o]["set"]+" "+hidden+' addedNearCalendarEvent" ><td><a target="_blank" href="'+n[o]["url"]+'"><div class="cut-string"><i class="'+icon+'" style="vertical-align:middle; margin-bottom:4px;"></i><span><strong> '+n[o]["start"]+"</strong></span><span> "+n[o]["title"].substring(0,22)+' </span><span style="margin-left: 5px;margin-top: 2px;"  class="HelpInfoPopover " title="" data-placement="top" data-content="'+helpIcon+'"><i class="glyphicon glyphicon-info-sign"></i></span></div></a>'+linkHtml+"</td></tr>")}else{if(n[o]["start"].indexOf(i)>-1){f.find("#next_events .table").append('<tr class="mode_'+n[o]["set"]+" "+hidden+' addedNearCalendarEvent"><td><a target="_blank" href="'+n[o]["url"]+'"><div class="cut-string"><i class="'+icon+'" style="vertical-align:middle; margin-bottom:4px;"></i><span><strong> '+n[o]["start"]+"</strong></span><span> "+n[o]["title"].substring(0,22)+' </span><span style="margin-left: 5px;margin-top: 2px;"  class="HelpInfoPopover " title="" data-placement="top" data-content="'+helpIcon+'"><i class="glyphicon glyphicon-info-sign"></i></span</div></a>'+linkHtml+"</td></tr>")}}}}var m;j.registerHelpInfo(m)}else{f.find(".modal-body").css({"max-height":"","overflow-y":""})}})},registerChangeNearCalendarEvent:function(e,c){var d=this;if(!e||c!="Calendar"||typeof c=="undefined"){return}var b=e.find('[name="assigned_user_id"]');var a=e.find('[name="date_start"]');b.on("change",function(h){var f=jQuery(h.currentTarget);var g=f.closest("form");g.find(".addedNearCalendarEvent").remove();d.getNearCalendarEvent(g,c)});a.on("change",function(h){var f=jQuery(h.currentTarget);var g=f.closest("form");g.find(".addedNearCalendarEvent").remove();d.getNearCalendarEvent(g,c)});e.find("ul li a").on("click",function(h){var f=jQuery(h.currentTarget);var g=f.closest("form");g.find(".addedNearCalendarEvent").remove();d.getNearCalendarEvent(g,c)});d.getNearCalendarEvent(e,c)},toggleTimesInputs:function(a){a.find(":checkbox").change(function(){var b=$(this).attr("name");if("allday"==b){var c=$(this).is(":checked");if(c){a.find(".active .time").hide()}else{a.find(".active .time").show()}}})},registerQuickCreatePostLoadEvents:function(b,d){var a=this;var c=d.callbackFunction;var e=d.goToFullFormcallback;if(typeof c=="undefined"){c=function(){}}b.on("submit",function(k){var i=jQuery(k.currentTarget);if(i.hasClass("not_validation")){return true}var f=i.find('[name="module"]').val();if(typeof i.data("submit")!="undefined"){return false}else{var h=i.data("jqv").InvalidFields;jQuery('textarea[id$="_qc"]').each(function(){var m=jQuery(this).attr("id");var n=CKEDITOR.instances[m].getData();jQuery(this).val(n)});if(h.length>0){i.removeData("submit");i.closest("#globalmodal").find(".modal-header h3").progressIndicator({mode:"hide"});k.preventDefault();return}else{i.data("submit","true");i.closest("#globalmodal").find(".modal-header h3").progressIndicator({smallLoadingImage:true,imageContainerCss:{display:"inline","margin-left":"18%",position:"absolute"}})}var j=jQuery.Event(Vtiger_Edit_Js.recordPreSave);i.trigger(j,{value:"edit",module:f});if(!(j.isDefaultPrevented())){var g=a;var l=Vtiger_Edit_Js.getInstanceByModuleName(f);if(typeof(l.quickCreateSave)==="function"){g=l}g.quickCreateSave(i).then(function(r){app.hideModalWindow();var s=app.getModuleName();var m=app.getViewName();if((f==s)&&(m=="List")){var p=new Vtiger_List_Js();p.getListViewRecords()}c(r);var o=a.quickCreateCallBacks;for(var n=0;n<o.length;n++){var q=o[n];q({data:r,name:i.find('[name="module"]').val()})}jQuery("body").trigger(jQuery.Event("QuickCreateSave.PostLoad"),r)},function(m,n){})}else{i.removeData("submit");i.closest("#globalmodal").find(".modal-header h3").progressIndicator({mode:"hide"})}k.preventDefault()}});b.find("#goToFullForm").on("click",function(g){var f=jQuery(g.currentTarget).closest("form");var h=jQuery(g.currentTarget).data("editViewUrl");if(typeof e!="undefined"){e(f)}a.quickCreateGoToFullForm(f,h)});this.registerTabEventsInQuickCreate(b)},registerTabEventsInQuickCreate:function(d){var a=d.find(".nav.nav-pills , .nav.nav-tabs").find("a");var b=function(g){var f=jQuery(g);f.find("[name]").each(function(h,i){i=jQuery(i);i.attr("data-element-name",i.attr("name")).removeAttr("name")})};var e=function(g){var f=jQuery(g);f.find("[data-element-name]").each(function(h,i){i=jQuery(i);i.attr("name",i.attr("data-element-name")).removeAttr("data-element-name")})};a.on("click",function(f){b(a.not('[aria-expanded="false"]').attr("data-target"));e($(this).attr("data-target"));d.data("jqv").InvalidFields=[]});var c=a.closest("li");c.filter(":not(.active)").find("a").each(function(f){b(jQuery(this).attr("data-target"))})},basicSearch:function(){var a=this;jQuery("#globalSearchValue").keypress(function(c){var b=jQuery(c.currentTarget);if(c.which==13){a.labelSearch(b)}});if(jQuery("#gsAutocomplete").val()==1){$.widget("custom.gsAutocomplete",$.ui.autocomplete,{_create:function(){this._super();this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(d,c){var e=this,b="";$.each(c,function(g,h){var f;if(h.category!=b){d.append("<li class='ui-autocomplete-category'>"+h.category+"</li>");b=h.category}e._renderItemData(d,h)})},_renderItemData:function(b,c){return this._renderItem(b,c).data("ui-autocomplete-item",c)},_renderItem:function(b,c){return $("<li>").data("item.autocomplete",c).append($("<a></a>").html(c.label)).appendTo(b)},});jQuery("#globalSearchValue").gsAutocomplete({minLength:jQuery("#gsMinLength").val(),source:function(c,b){var d=new Vtiger_BasicSearch_Js();d.reduceNumberResults=jQuery("#gsAmountResponse").val();d.returnHtml=false;d.search(c.term).then(function(h){var h=jQuery.parseJSON(h);var g=h.result;var f=new Array();for(var i in g){var e=g[i];f.push(e)}b(f)})},select:function(d,e){var c=e.item;if(c.permitted){var b="index.php?module="+c.module+"&view=Detail&record="+c.id;window.location.href=b}},close:function(b,c){jQuery("#globalSearchValue").val("")}})}},labelSearch:function(c){var d=c.val();if(d==""){alert(app.vtranslate("JS_PLEASE_ENTER_SOME_VALUE"));c.focus();return false}var b=new Vtiger_BasicSearch_Js();var a=jQuery.progressIndicator();b.search(d).then(function(e){b.showSearchResults(e);a.progressIndicator({mode:"hide"})})},adjustContentHeight:function(){navTop=jQuery("nav.navbar-fixed-top").outerHeight();navBottom=jQuery("footer.navbar-fixed-bottom").outerHeight();if(app.getViewName()==="Detail"||app.getViewName()==="ExtensionImport"){if(jQuery("div.detailViewInfo > .related").outerHeight()>jQuery("div.detailViewInfo > div.details ").outerHeight()){jQuery("div.detailViewInfo > div.details").css("min-height",jQuery(".detailViewInfo > .related").outerHeight())}bodyHeight=jQuery("div.detailViewContainer").outerHeight();jQuery("div.detailViewContainer").css("height",jQuery("div.bodyContents").outerHeight())}else{if(app.getViewName()==="Edit"){bodyHeight=jQuery(".editViewContainer").outerHeight()}else{if(app.getViewName()==="List"){bodyHeight=jQuery(".remindersNoticeContainer").outerHeight()-5;jQuery(".bodyContents").css("min-height",bodyHeight)}else{if(app.getViewName()==="Calendar"){bodyHeight=jQuery(".calendarViewContainer").outerHeight()}else{if(app.getViewName()==="DashBoard"){bodyHeight=jQuery(".remindersNoticeContainer").outerHeight()-55;jQuery("div.gridster").css("min-height",jQuery(".contentsDiv").outerHeight()+24);jQuery("div.bodyContents").css("min-height",bodyHeight)}else{if(app.getViewName()==="Index"){bodyHeight=jQuery(".mainContainer > .col-md-2").outerHeight();jQuery(".mainContainer").css("min-height",bodyHeight)}else{bodyHeight=jQuery(".bodyContents").css("min-height")}}}}}}var a={"min-height":bodyHeight,"margin-bottom":navBottom+"px","margin-top":navTop+"px"};jQuery(".mainContainer").css(a);jQuery(".mainContainer > .col-md-2 ").css({"margin-bottom":navBottom+"px",});jQuery(".contentsDiv").css({"margin-bottom":navBottom+"px",});jQuery(".contentsDiv").css("min-height",bodyHeight);Vtiger_Helper_Js.showHorizontalTopScrollBar()},recentPageViews:function(){var m=20;var p="";var l="javascript:void();";var g=localStorage.history;if(g!=""&&g!=null){var a=g.toString().split(",");var o=a[a.length-1].toString().split("|");p=o[0];l=o[1]}var e='<ul class="dropdown-menu pull-right" role="menu">';var b=new Date().getTime();if(a!=null){for(var c=a.length-1;c>=0;c--){o=a[c].toString().split("|");var h=new Date();var n="";if(o[2]!=undefined){h.setTime(o[2]);n=app.formatDate(h)+" | "}var k=$("#userDateFormat").val()+""+$("#userDateFormat").val();e+='<li><a href="'+o[1]+'">'+n+o[0]+"</a></li>"}var f=this.getHistoryLabel();if(f.length>1&&document.URL!=l){a.push(this.getHistoryLabel()+"|"+document.URL+"|"+b)}if(a.length>=m){a.splice(0,1)}localStorage.history=a.toString()}else{var j=new Array();var f=this.getHistoryLabel();if(f.length>1){j.push(this.getHistoryLabel()+"|"+document.URL+"|"+b);localStorage.history=j.toString()}}e+='<li class="divider"></li><li><a class="clearHistory" href="#">'+app.vtranslate("JS_CLEAR_HISTORY")+"</a></li>";e+="</ul>";$(".showHistoryBtn").after(e);this.registerClearHistory()},getHistoryLabel:function(){var a="";$(".breadcrumbsLinks span").each(function(b){a+=$(this).text()});return a},registerClearHistory:function(){$(".historyBtn .clearHistory").click(function(){localStorage.history="";var a='<li class="divider"></li><li><a class="clearHistory" href="#">'+app.vtranslate("JS_CLEAR_HISTORY")+"</a></li>";$(".historyBtn .dropdown-menu").html(a)})},registerHotKeys:function(){$(".hotKey").each(function(b){var a=this;var c=$(a).data("hotkeys");if(c!=""){Mousetrap.bind(c,function(){a.click()})}})},quickCreateModule:function(c,e){var d=this;if(typeof e=="undefined"){e={}}if(typeof e.callbackFunction=="undefined"){e.callbackFunction=function(){}}var b="index.php?module="+c+"&view=QuickCreateAjax";if(app.getViewName()==="Detail"||app.getViewName()==="Edit"){b+="&sourceModule="+app.getModuleName();b+="&sourceRecord="+app.getRecordId()}var a=jQuery.progressIndicator();d.getQuickCreateForm(b,c,e).then(function(f){d.handleQuickCreateData(f,e);a.progressIndicator({mode:"hide"})})},registerReminderNotice:function(){$("#page").before('<div class="remindersNoticeContainer"></div>');var a=$(".remindersNoticeContainer");$(".remindersNotice").click(function(){a.toggleClass("toggled")});a.css("top",$(".commonActionsContainer").height()+3);a.height($(window).height()-$("footer.navbar-default").height()-$(".commonActionsContainer").height())},registerEvents:function(){var a=this;a.setContentsHeight();a.recentPageViews();jQuery(window).resize(function(){a.setContentsHeight()});jQuery("#globalSearch").click(function(){var b=new Vtiger_AdvanceSearch_Js();b.initiateSearch().then(function(){b.selectBasicSearchValue()})});jQuery("#searchIcon").on("click",function(d){var c=jQuery("#globalSearchValue");var b=jQuery.Event("keypress");b.which=13;c.trigger(b)});a.registerAnnouncement();this.setAnnouncement();a.registerHotKeys();jQuery("#moreMenu").click(function(d){var f=jQuery(d.currentTarget);var b=jQuery(".moreMenus",f);var c=jQuery(".modulesList > li",a.getMenuContainer()).length;if(c<5){b.css("left",0).addClass("leftAligned")}});jQuery("#basicSearchModulesList").change(function(){jQuery("#globalSearchValue").focus()});a.basicSearch();jQuery("#quickCreateModules,#compactquickCreate,#topMenus").on("click",".quickCreateModule",function(c,d){var b=jQuery(c.currentTarget).data("name");a.quickCreateModule(b)});if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){jQuery("#basicSearchModulesList_chosen").find(".chzn-results").css({"max-height":"350px","overflow-y":"scroll"})}else{app.showScrollBar(jQuery("#basicSearchModulesList_chosen").find(".chzn-results"),{height:"450px",railVisible:true,alwaysVisible:true,size:"6px"});if(window.outerWidth<=1024){$(".headerLinksContainer").css("margin-right","8px")}$(document).ajaxComplete(function(){Vtiger_Header_Js.getInstance().adjustContentHeight()});$(document).load(function(){Vtiger_Header_Js.getInstance().adjustContentHeight()});a.registerReminderNotice()}},showPdfModal:function(a){var c={};if(app.getViewName()=="List"){var b=Vtiger_List_Js.getSelectedRecordsParams(false);jQuery.extend(c,b)}a+="&"+jQuery.param(c);app.showModalWindow(null,a)},setContentsHeight:function(){var a=parseInt(jQuery(".mainContainer").css("margin-top"))+21;jQuery(".bodyContents").css("min-height",(jQuery(window).innerHeight()-a))},});jQuery(document).ready(function(){Vtiger_Header_Js.getInstance().registerEvents()});