
jQuery.Class("OSSTimeControl_Calendar_Js",{registerUserListWidget:function(){var b=new OSSTimeControl_Calendar_Js();var a=$(".widgetContainer");a.hover(function(){$(this).css("overflow","visible")},function(){$(this).css("overflow","hidden")});this.registerColorField(a.find("#calendarUserList"),"userCol");this.registerColorField(a.find("#timecontrolTypes"),"listCol");a.find(".select2").on("change",function(){$(this).closest(".siteBarContent").find(".refreshHeader").removeClass("hide")})},registerColorField:function(b,a){var c={};c.dropdownCss={"z-index":0};c.formatSelection=function(f,d){var e=f.id;var h=b.find('option[value="'+e+'"]');d.addClass(a+"_"+e);var g="<div>"+h.text()+"</div>";return g};app.changeSelectElementView(b,"select2",c)},},{calendarView:false,calendarCreateView:false,weekDaysArray:{Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6},registerCalendar:function(){var i=this;var j=jQuery("#eventLimit").val();if(j=="true"){j=true}else{if(j=="false"){j=false}else{j=parseInt(j)+1}}var b=jQuery("#weekView").val();var g=jQuery("#dayView").val();var a=jQuery("#activity_view").val();if(a=="Today"){a=g}else{if(a=="This Week"){a=b}else{a="month"}}var f=jQuery("#time_format").val();var c;if(f==24){f="H:mm";c="HH:mm"}else{f="h:mmt";c="hh:mm A"}var d=jQuery("#start_day").val();var h=i.weekDaysArray[d];var e=jQuery("#start_hour").val();var k=e.split(":");e=k["0"];i.getCalendarView().fullCalendar({header:{left:"month,"+b+","+g,center:"title today",right:"prev,next"},timeFormat:f,axisFormat:f,firstHour:e,firstDay:h,defaultView:a,editable:true,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:true,defaultTimedEventDuration:"01:00:00",eventLimit:j,allDaySlot:false,views:{basic:{eventLimit:false,}},dayClick:function(n,m,l){i.selectDay(n.format());i.getCalendarView().fullCalendar("unselect")},eventDrop:function(m,n,l){i.updateEvent(m,n,l)},eventResize:function(m,n,l){i.updateEvent(m,n,l)},eventRender:function(m,l){l.find(".fc-content").popover({title:m.title,placement:"auto right",html:true,trigger:"hover",delay:500,container:"body",content:'<i class="icon-time"></i> '+app.vtranslate("JS_START_DATE")+": "+m.start.format("YYYY-MM-DD "+c)+'<br /><i class="icon-time"></i> '+app.vtranslate("JS_END_DATE")+": "+m.end.format("YYYY-MM-DD "+c)})},monthNames:[app.vtranslate("JS_JANUARY"),app.vtranslate("JS_FEBRUARY"),app.vtranslate("JS_MARCH"),app.vtranslate("JS_APRIL"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUNE"),app.vtranslate("JS_JULY"),app.vtranslate("JS_AUGUST"),app.vtranslate("JS_SEPTEMBER"),app.vtranslate("JS_OCTOBER"),app.vtranslate("JS_NOVEMBER"),app.vtranslate("JS_DECEMBER")],monthNamesShort:[app.vtranslate("JS_JAN"),app.vtranslate("JS_FEB"),app.vtranslate("JS_MAR"),app.vtranslate("JS_APR"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUN"),app.vtranslate("JS_JUL"),app.vtranslate("JS_AUG"),app.vtranslate("JS_SEP"),app.vtranslate("JS_OCT"),app.vtranslate("JS_NOV"),app.vtranslate("JS_DEC")],dayNames:[app.vtranslate("JS_SUNDAY"),app.vtranslate("JS_MONDAY"),app.vtranslate("JS_TUESDAY"),app.vtranslate("JS_WEDNESDAY"),app.vtranslate("JS_THURSDAY"),app.vtranslate("JS_FRIDAY"),app.vtranslate("JS_SATURDAY")],dayNamesShort:[app.vtranslate("JS_SUN"),app.vtranslate("JS_MON"),app.vtranslate("JS_TUE"),app.vtranslate("JS_WED"),app.vtranslate("JS_THU"),app.vtranslate("JS_FRI"),app.vtranslate("JS_SAT")],buttonText:{today:app.vtranslate("JS_TODAY"),month:app.vtranslate("JS_MONTH"),week:app.vtranslate("JS_WEEK"),day:app.vtranslate("JS_DAY")},allDayText:app.vtranslate("JS_ALL_DAY"),eventLimitText:app.vtranslate("JS_MORE")})},registerRefreshEvent:function(){var a=this;$(".refreshCalendar").click(function(){$(this).closest(".refreshHeader").addClass("hide");a.loadCalendarData()})},registerButtonSelectAll:function(){var a=$(".selectAllBtn");a.click(function(d){var c=$(this).find(".selectAll");var b=$(this).find(".deselectAll");if(c.hasClass("hide")){c.removeClass("hide");b.addClass("hide");$(this).closest(".quickWidget").find("select option").prop("selected",false)}else{$(this).closest(".quickWidget").find("select option").prop("selected",true);b.removeClass("hide");c.addClass("hide")}$(this).closest(".quickWidget").find("select").trigger("change")})},loadCalendarData:function(c){var a=jQuery.progressIndicator();var i=this;i.getCalendarView().fullCalendar("removeEvents");var h=i.getCalendarView().fullCalendar("getView");var f=h.start.format();var b=h.end.format();var e;if(jQuery("#calendarUserList").length==0){e=jQuery("#current_user_id").val()}else{e=jQuery("#calendarUserList").val()}if(jQuery("#timecontrolTypes").length>0){var g=jQuery("#timecontrolTypes").val()}else{c=true}if(c==true||g!=null){var d={module:"OSSTimeControl",action:"Calendar",mode:"getEvent",start:f,end:b,user:e,types:g};AppConnector.request(d).then(function(j){i.getCalendarView().fullCalendar("addEventSource",j.result);a.hide()})}else{i.getCalendarView().fullCalendar("removeEvents");a.hide()}},updateEvent:function(c,g,b){var d=jQuery.progressIndicator();var f=c.start.format();var a=c.end.format();var e={module:"OSSTimeControl",action:"Calendar",mode:"updateEvent",id:c.id,start:f,delta:g._data};AppConnector.request(e).then(function(h){if(!h.result){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));b()}d.hide()},function(h){d.hide();Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));b()})},selectDay:function(a){var b=this;b.getCalendarCreateView().then(function(j){if(j.length<=0){return}var c=j.find('[name="date_start"]').data("dateFormat");var g=j.find('[name="time_start"]').data("format");if(g==24){var m="HH:mm"}else{m="hh:mm tt"}var o=Date.parse(a);var r=app.getDateInVtigerFormat(c,o);var e=o.toString(m);var f=Date.parse(a);var k=app.getDateInVtigerFormat(c,f);var p=b.getCalendarView().fullCalendar("getView");if("month"==p.name){var l=parseInt((f-o)/(1000*60*60*24));var q;if(l>1){var i=jQuery("#start_hour").val();var s=i.split(":");e=s["0"];var h=jQuery("#end_hour").val();s=h.split(":");q=s["0"]}else{var d=new Date();e=d.toString(m);d.setMinutes(d.getMinutes()+15);q=d.toString(m)}}else{f.setMinutes(f.getMinutes()+30);q=f.toString(m)}j.find('[name="date_start"]').val(r);j.find('[name="due_date"]').val(k);j.find('[name="time_start"]').val(e);j.find('[name="time_end"]').val(q);var n=new Vtiger_Header_Js();n.handleQuickCreateData(j,{callbackFunction:function(t){b.addCalendarEvent(t.result,c)}});jQuery(".modal-body").css({"max-height":app.getScreenHeight(70)+"px","overflow-y":"auto"})})},addCalendarEvent:function(e,b){e.date_start.display_value=app.getDateInDBInsertFormat(b,e.date_start.display_value);e.due_date.display_value=app.getDateInDBInsertFormat(b,e.due_date.display_value);var g=this.getCalendarView();var c={};c.id=e._recordId;c.title=e.name.display_value;var a=g.fullCalendar("moment",e.date_start.display_value+" "+e.time_start.display_value);c.start=a.toString();var f=g.fullCalendar("moment",e.due_date.display_value+" "+e.time_end.display_value);var d=e.assigned_user_id.value;c.end=f.toString();c.url="index.php?module=OSSTimeControl&view=Detail&record="+e._recordId;c.className="userCol_"+e.assigned_user_id.value+" calCol_"+e.timecontrol_type.value;this.getCalendarView().fullCalendar("renderEvent",c)},getCalendarCreateView:function(){var b=this;var a=jQuery.Deferred();if(this.calendarCreateView!==false){a.resolve(this.calendarCreateView.clone(true,true));return a.promise()}var c=jQuery.progressIndicator();this.loadCalendarCreateView().then(function(d){c.hide();b.calendarCreateView=d;a.resolve(d.clone(true,true))},function(){c.hide()});return a.promise()},loadCalendarCreateView:function(){var a=jQuery.Deferred();var d=app.getModuleName();var c="index.php?module="+d+"&view=QuickCreateAjax";var b=Vtiger_Header_Js.getInstance();b.getQuickCreateForm(c,d).then(function(e){a.resolve(jQuery(e))},function(){a.reject()});return a.promise()},getCalendarView:function(){if(this.calendarView==false){this.calendarView=jQuery("#calendarview")}return this.calendarView},registerChangeView:function(){var a=this;a.getCalendarView().find("button.fc-button:not(.dropdown-toggle)").click(function(){a.loadCalendarData()})},registerCalendarScroll:function(){var a=$(".bodyContents");app.showScrollBar(a,{railVisible:true,alwaysVisible:true,position:"left"})},registerEvents:function(){this.registerCalendar();this.loadCalendarData(true);this.registerChangeView();this.registerButtonSelectAll();this.registerRefreshEvent();this.registerCalendarScroll()}});