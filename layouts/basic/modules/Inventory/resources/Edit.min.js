
Vtiger_Edit_Js("Inventory_Edit_Js",{zeroDiscountType:"zero",percentageDiscountType:"percentage",directAmountDiscountType:"amount",individualTaxType:"individual",groupTaxType:"group"},{lineItemContentsContainer:false,lineItemResultContainer:false,editViewForm:false,rowSequenceHolder:false,basicRow:false,rowClass:"lineItemRow",prevSelectedCurrencyConversionRate:false,getLineItemContentsContainer:function(){if(this.lineItemContentsContainer==false){this.setLineItemContainer(jQuery("#lineItemTab"))}return this.lineItemContentsContainer},setLineItemContainer:function(a){this.lineItemContentsContainer=a;return this},getLineItemResultContainer:function(){if(this.lineItemResultContainer==false){this.setLinteItemResultContainer(jQuery("#lineItemResult"))}return this.lineItemResultContainer},setLinteItemResultContainer:function(a){this.lineItemResultContainer=a;return this},getClosestLineItemRow:function(a){return a.closest("tr."+this.rowClass)},getTaxTypeSelectElement:function(){return jQuery("#taxtype")},isIndividualTaxMode:function(){var a=this.getTaxTypeSelectElement();var b=a.find("option:selected");if(b.val()==Inventory_Edit_Js.individualTaxType){return true}return false},isGroupTaxMode:function(){var a=this.getTaxTypeSelectElement();var b=a.find("option:selected");if(b.val()==Inventory_Edit_Js.groupTaxType){return true}return false},getForm:function(){if(this.editViewForm==false){this.editViewForm=jQuery("#EditView")}return this.editViewForm},getQuantityValue:function(a){return parseFloat(jQuery(".qty",a).val())},getListPriceValue:function(a){return parseFloat(jQuery(".listPrice",a).val())},setListPriceValue:function(b,c){var d=parseInt(jQuery(".numberOfCurrencyDecimal").val());var a=parseFloat(c).toFixed(d);b.find(".listPrice").val(a);return this},setLineItemTotal:function(b,c){var d=parseInt(jQuery(".numberOfCurrencyDecimal").val());var a=parseFloat(c).toFixed(d);jQuery(".productTotal",b).text(a);return this},getLineItemTotal:function(a){return parseFloat(this.getLineItemTotalElement(a).text())},getLineItemTotalElement:function(a){return jQuery(".productTotal",a)},setDiscountTotal:function(a,c){var d=parseInt(jQuery(".numberOfCurrencyDecimal").val());var b=parseFloat(c).toFixed(d);jQuery(".discountTotal",a).text(b);return this},getDiscountTotal:function(a){return parseFloat(jQuery(".discountTotal",a).text())},setTotalAfterDiscount:function(a,b){jQuery(".totalAfterDiscount",a).text(b);return this},getTotalAfterDiscount:function(a){return parseFloat(jQuery(".totalAfterDiscount",a).text())},getPurchase:function(a){var b=this.getQuantityValue(a);return parseFloat(jQuery(".purchase",a).val())*b},setLineItemTaxTotal:function(b,a){var d=parseInt(jQuery(".numberOfCurrencyDecimal").val());var c=parseFloat(a).toFixed(d);jQuery(".productTaxTotal",b).text(c);return this},getLineItemTaxTotal:function(a){return parseFloat(jQuery(".productTaxTotal",a).text())},setLineItemNetPrice:function(c,b){jQuery(".netPrice",c).text(b);var d=parseInt(jQuery(".numberOfCurrencyDecimal").val());var a=parseFloat(b).toFixed(d);jQuery(".netPrice",c).text(a);return this},getLineItemNetPrice:function(a){return parseFloat(jQuery(".netPrice",a).text())},getLineItemNetPriceIncludeTaxType:function(a){var b=0;if(this.isIndividualTaxMode()){b=this.getTotalAfterDiscount(a)}else{b=jQuery(".netPrice",a).text()}return parseFloat(b)},setNetTotal:function(a){var c=parseInt(jQuery(".numberOfCurrencyDecimal").val());var b=parseFloat(a).toFixed(c);jQuery("#netTotal").text(b);return this},getNetTotalIncludeTaxType:function(){var e=parseInt(jQuery(".numberOfCurrencyDecimal").val());var c=this;var b=this.getLineItemContentsContainer();var a=0;b.find("tr."+this.rowClass).each(function(f,h){var g=jQuery(h);a+=c.getLineItemNetPrice(g)});var d=parseFloat(a).toFixed(e);return d},getNetTotal:function(){return parseFloat(jQuery("#netTotal").text())},setFinalDiscountTotal:function(a){jQuery("#discountTotal_final").text(a);return this},getFinalDiscountTotal:function(){return parseFloat(jQuery("#discountTotal_final").text())},setGroupTaxTotal:function(a){jQuery("#tax_final").text(a)},getGroupTaxTotal:function(){return parseFloat(jQuery("#tax_final").text())},setGrandTotal:function(a){jQuery("#grandTotal").text(a);return this},setTotalMargin:function(a){jQuery("#total_margin").text(a);return this},getGrandTotal:function(){return parseFloat(jQuery("#grandTotal").text())},getLineItemMargin:function(a){return parseFloat(jQuery(".margin",a).val())},loadRowSequenceNumber:function(){if(this.rowSequenceHolder==false){this.rowSequenceHolder=jQuery("."+this.rowClass,this.getLineItemContentsContainer()).length}return this},getNextLineItemRowNumber:function(){if(this.rowSequenceHolder==false){this.loadRowSequenceNumber()}return ++this.rowSequenceHolder},getBasicRow:function(){if(this.basicRow==false){var a=this.getLineItemContentsContainer();this.basicRow=jQuery(".lineItemCloneCopy",a)}var c=this.basicRow.clone(true,true);var b=this.isIndividualTaxMode();if(b){c.find(".individualTaxContainer").removeClass("hide")}return c.removeClass("hide lineItemCloneCopy noValidate")},registerAddingNewProductsAndServices:function(){var b=this;var a=this.getLineItemContentsContainer();jQuery("#addProduct").on("click",function(){var d=b.getBasicRow().addClass(b.rowClass);jQuery('.lineItemPopup[data-module-name="Services"]',d).closest("span.input-group-addon").remove();var c=b.getNextLineItemRowNumber();d=d.appendTo(a);b.checkLineItemRow();d.find("input.rowNumber").val(c);b.updateLineItemsElementWithSequenceNumber(d,c);d.find("input.productName").addClass("autoComplete");b.registerLineItemAutoComplete(d)});jQuery("#addService").on("click",function(){var d=b.getBasicRow().addClass(b.rowClass);jQuery('.lineItemPopup[data-module-name="Products"]',d).closest("span.input-group-addon").remove();var c=b.getNextLineItemRowNumber();d=d.appendTo(a);b.checkLineItemRow();d.find("input.rowNumber").val(c);b.updateLineItemsElementWithSequenceNumber(d,c);d.find("input.productName").addClass("autoComplete");b.registerLineItemAutoComplete(d)})},getTaxDiv:function(c,f){var b=jQuery("input.rowNumber",f).val();var g=1;var d='<div class="taxUI validCheck hide" id="tax_div'+b+'"><table width="100%" border="0" cellpadding="5" cellspacing="0" class="table table-nobordered popupTable" id="tax_table'+b+'"><tr><th colspan="2" id="tax_div_title'+b+'" align="left" ><strong>'+app.vtranslate("JS_SET_TAX_FOR")+'</strong></th><th colspan="2"><button aria-hidden="true" data-dismiss="modal" class="close closeDiv" type="button">x</button></th></tr>';if(!jQuery.isEmptyObject(c)){for(var e in c){var a=c[e];d+='<tr><td><div class="input-group input-group-sm"><span class="input-group-addon"><input type="radio" name="tax_option'+b+'" class="tax_option" value="'+e+'" ></span><input type="text" name="'+e+"_percentage"+b+'" data-validation-engine="validate[funcCall[Vtiger_PositiveNumber_Validator_Js.invokeValidation]]" id="'+e+"_percentage"+b+'" value="'+a.percentage+'" class="smallInputBox taxPercentage form-control input-sm"><span class="input-group-addon">%</span></div></td><td><div class="textOverflowEllipsis">'+a.label+'</div></td> <td><input type="text" name="popup_tax_row'+b+'" class="cursorPointer smallInputBox taxTotal form-control input-sm" value="0.0" readonly></td></tr>';g++}}else{d+="<tr><td>"+app.vtranslate("JS_LBL_NO_TAXES")+"</td></tr>"}d+='</table><div class="modal-footer lineItemPopupModalFooter modal-footer-padding backgroundColor"><div class=" pull-right cancelLinkContainer"><a class="cancelLink btn btn-warning" type="reset" data-dismiss="modal">'+app.vtranslate("JS_LBL_CANCEL")+'</a></div><button class="btn btn-success taxSave" type="button" name="lineItemActionSave"><strong>'+app.vtranslate("JS_LBL_SAVE")+"</strong></button></div></div>";return jQuery(d)},loadSubProducts:function(c){var b=jQuery("input.selectedModuleId",c).val();var d={module:"Products",action:"SubProducts",record:b};var a=jQuery.progressIndicator();AppConnector.request(d).then(function(g){var f=g.result;var j=jQuery(".subProductsContainer",c);var h=jQuery(".subProductIds",c);var e="";for(var i in f){e+="<em>-"+f[i]+"</em><br>"}h.val(Object.keys(f).join(":"));j.html(e);a.hide()},function(e,f){})},mapResultsToFields:function(m,i,e){var q=jQuery(i).closest("tr."+this.rowClass);var a=jQuery("input.productName",q);for(var c in e){var g=c;var b=e[c];var h=b.name;var l=b.listprice;var k=b.usageunit;var d=b.listpricevalues;var j=b.taxes;if(m=="Products"){q.data("quantity-in-stock",b.quantityInStock)}var o=b.description;jQuery("input.selectedModuleId",q).val(g);jQuery("input.lineItemType",q).val(m);a.val(h);a.attr("disabled","disabled");jQuery("input.listPrice",q).val(l);jQuery("span.usageUnit",q).text(k);var n=jQuery("#currency_id").val();var f=JSON.stringify(d);if(typeof d[n]!="undefined"){this.setListPriceValue(q,d[n]);this.lineItemRowCalculations(q)}jQuery("input.listPrice",q).attr("list-info",f);jQuery("textarea.lineItemCommentBox",q).val(o);var p=this.getTaxDiv(j,q);jQuery(".taxDivContainer",q).html(p);if(this.isIndividualTaxMode()){q.find(".productTaxTotal").removeClass("hide")}else{q.find(".productTaxTotal").addClass("hide")}}if(m=="Products"){this.loadSubProducts(q)}jQuery(".qty",q).trigger("focusout")},showPopup:function(c){var a=jQuery.Deferred();var b=Vtiger_Popup_Js.getInstance();b.show(c,function(d){a.resolve(d)});return a.promise()},lineItemPopupEventHandler:function(a){var b=jQuery.Deferred();var f=this;var e=a.data("moduleName");var d=app.getModuleName();var g={};g.view=a.data("popup");g.module=d;if(d=="Quotes"||d=="SalesOrder"||d=="Invoice"){var c=jQuery('input[name="potential_id"]').val();if(typeof c=="undefined"){c=jQuery('input[name="potentialid"]').val()}if(c){g.potentialid=c}}g.currency_id=jQuery("#currency_id option:selected").val();this.showPopup(g).then(function(n){var l=JSON.parse(n);var h=Object.keys(l).length;if(h>1){for(var k=0;k<h;k++){if(k==0){f.mapResultsToFields(e,a,l[k])}else{if(k>=1&&(e=="Products"||e=="Services")){if(e=="Products"){var p=jQuery("#addProduct").trigger("click")}else{if(e=="Services"){var m=jQuery("#addService").trigger("click")}}var j=jQuery("#lineItemTab > tbody > tr:last");var o=jQuery(".lineItemPopup",j);f.mapResultsToFields(e,o,l[k]);b.resolve()}}}}else{f.mapResultsToFields(e,a,l);b.resolve()}});return b.promise()},pricebooksPopupHandler:function(a){var d=this;var c=a.closest("tr."+this.rowClass);var b=c.find("input.productName").closest("td");var e={};e.module="PriceBooks";e.src_module=jQuery("img.lineItemPopup",b).data("moduleName");e.src_field=jQuery("img.lineItemPopup",b).data("fieldName");e.src_record=jQuery("input.selectedModuleId",b).val();e.get_url="getProductListPriceURL";e.currency_id=jQuery("#currency_id option:selected").val();this.showPopup(e).then(function(g){var f=JSON.parse(g);for(var h in f){d.setListPriceValue(c,f[h])}d.quantityChangeActions(c)})},calculateLineItemTotal:function(c){var d=this.getQuantityValue(c);var b=this.getListPriceValue(c);var a=parseFloat(d)*parseFloat(b);this.setLineItemTotal(c,a)},calculateDiscountForLineItem:function(f){var a=f.find("div.discountUI");var g=a.find("input.discounts").filter(":checked");var e=g.data("discountType");var c=g.closest("tr");jQuery("input.discount_type",a).val(e);var b=jQuery("input.discount_percentage",a).closest("div.input-group");var d=jQuery("input.discount_amount",a);b.addClass("hide");d.addClass("hide");var h=c.find(".discountVal").val();if(h==""){h=0}if(isNaN(h)||h<0){h=0}if(e==Inventory_Edit_Js.percentageDiscountType){b.removeClass("hide").focus();var i=this.getLineItemTotal(f);h=(i*h)/100}else{if(e==Inventory_Edit_Js.directAmountDiscountType){d.removeClass("hide").focus()}}this.setDiscountTotal(f,h).calculateTotalAfterDiscount(f)},calculateTotalAfterDiscount:function(b){var e=parseInt(jQuery(".numberOfCurrencyDecimal").val());var d=this.getLineItemTotal(b);var c=this.getDiscountTotal(b);var a=d-c;a=a.toFixed(e);this.setTotalAfterDiscount(b,a)},calculateTaxForLineItem:function(c){var e=parseInt(jQuery(".numberOfCurrencyDecimal").val());var b=this.getTotalAfterDiscount(c);var d=jQuery(".taxPercentage",c);var a=0;jQuery.each(d,function(g,j){var h=jQuery(j);var i=h.closest("tr");if(i.find(".tax_option").is(":checked")){var k=h.val();if(k==""){k="0"}if(isNaN(k)){var f="0"}else{var k=parseFloat(k);var f=Math.abs(k*b)/100;f=f.toFixed(e)}jQuery(".taxTotal",i).val(f);a+=parseFloat(f)}});a=parseFloat(a.toFixed(e));this.setLineItemTaxTotal(c,a)},calculateLineItemNetPrice:function(b){var e=parseInt(jQuery(".numberOfCurrencyDecimal").val());var a=this.getTotalAfterDiscount(b);var d=parseFloat(a);if(this.isIndividualTaxMode()){var c=this.getLineItemTaxTotal(b);d+=parseFloat(c)}d=d.toFixed(e);this.setLineItemNetPrice(b,d)},calculateNetTotal:function(){var c=this;var b=this.getLineItemContentsContainer();var a=0;b.find("tr."+this.rowClass).each(function(d,f){var e=jQuery(f);a+=c.getLineItemNetPriceIncludeTaxType(e)});this.setNetTotal(a)},calculateFinalDiscount:function(){var j=this;var i=jQuery("#finalDiscountUI");var f=i.find("input.finalDiscounts").filter(":checked");var e=f.data("discountType");var c=f.closest("tr");var a=parseInt(jQuery(".numberOfCurrencyDecimal").val());jQuery("#discount_type_final").val(e);var b=i.find("input.discount_percentage_final").closest("div.input-group");var d=i.find("input.discount_amount_final");b.addClass("hide");d.addClass("hide");var g=c.find(".discountVal").val();if(g==""){g=0}if(isNaN(g)||g<0){g=0}if(e==Inventory_Edit_Js.percentageDiscountType){b.removeClass("hide").focus();var k=this.getNetTotalIncludeTaxType();g=(k*g)/100}else{if(e==Inventory_Edit_Js.directAmountDiscountType){if(j.prevSelectedCurrencyConversionRate){var h=jQuery("#conversion_rate").val();h=h/j.prevSelectedCurrencyConversionRate;g=g*h;c.find(".discountVal").val(g)}d.removeClass("hide").focus()}}g=parseFloat(g).toFixed(a);this.setFinalDiscountTotal(g);this.calculatePreTaxTotal()},calculateGroupTax:function(){var f=parseInt(jQuery(".numberOfCurrencyDecimal").val());var e=this.getNetTotalIncludeTaxType();var d=this.getFinalDiscountTotal();var b=e-d;b=parseFloat(b).toFixed(f);var c=jQuery("#group_tax_div");var a=0;c.find(".groupTaxPercentage").each(function(g,k){var j=jQuery(k);var i=j.closest("tr");if(i.find(".group_tax_option").is(":checked")){if(isNaN(j.val())){var h="0"}else{var h=Math.abs(b*j.val())/100}h=parseFloat(h).toFixed(f);i.find(".groupTaxTotal").val(h);a+=parseFloat(h)}});this.setGroupTaxTotal(a)},calculateGrandTotal:function(){var d=parseInt(jQuery(".numberOfCurrencyDecimal").val());var c=this.getNetTotalIncludeTaxType();var a=this.getFinalDiscountTotal();var b=parseFloat(c)-parseFloat(a);if(this.isGroupTaxMode()){b+=this.getGroupTaxTotal()}b=b.toFixed(d);this.setGrandTotal(b)},calculateTotalMargin:function(){var e=parseInt(jQuery(".numberOfCurrencyDecimal").val());var d=this;var b=this.getLineItemContentsContainer();var c=0;b.find("tr."+this.rowClass).each(function(f,h){var g=jQuery(h);c+=d.getLineItemMargin(g)});var a=parseFloat(c).toFixed(e);this.setTotalMargin(a)},registerFinalDiscountShowEvent:function(){var a=this;jQuery("#finalDiscount").on("click",function(b){var c=jQuery("#finalDiscountUI");a.hideLineItemPopup();c.removeClass("hide")})},registerFinalDiscountChangeEvent:function(){var a=this.getLineItemResultContainer();var b=this;a.on("change",".finalDiscounts",function(c){b.finalDiscountChangeActions()})},registerFinalDiscountValueChangeEvent:function(){var a=this;jQuery(".finalDiscountSave").on("click",function(b){a.finalDiscountChangeActions()})},registerLineItemActionSaveEvent:function(){var a=this.getForm();var b=this;a.on("click",'button[name="lineItemActionSave"]',function(){var e=true;var d=jQuery("#EditView").data("jqv").InvalidFields;var c=jQuery('button[name="lineItemActionSave"]').closest(".validCheck").find("input[data-validation-engine]").not(".hide");jQuery(c).each(function(f,g){if(jQuery.inArray(g,d)!=-1){e=false}});if(!e){a.removeData("submit");return false}else{jQuery(".closeDiv").trigger("click")}b.calculateGroupTax();b.calculateGrandTotal()})},registerGroupTaxShowEvent:function(){var a=this;jQuery("#finalTax").on("click",function(c){var b=jQuery("#group_tax_row");a.hideLineItemPopup();b.find(".finalTaxUI").removeClass("hide")})},registerGroupTaxChangeEvent:function(){var b=this;var a=jQuery("#group_tax_row");a.on("focusout",".groupTaxPercentage",function(c){b.calculateGroupTax();b.calculateGrandTotal()})},registerRecalculateMargin:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("focusout",".listPrice",function(f){var c=jQuery(f.currentTarget);var d=c.closest("tr."+b.rowClass);b.recalculateMargin(d);b.recalculateAllMargin()});a.on("focusout",".purchase",function(f){var c=jQuery(f.currentTarget);var d=c.closest("tr."+b.rowClass);b.recalculateMargin(d);b.recalculateAllMargin()});a.on("focusout",".listPrice",function(c){b.recalculateAllMargin()});a.on("focusout",".qty",function(c){b.recalculateAllMargin()})},recalculateMargin:function(d){var g=parseInt(jQuery(".numberOfCurrencyDecimal").val());var c=this.getTotalAfterDiscount(d);var f=this.getQuantityValue(d);var b=this.getPurchase(d);var e=c-b;e=e.toFixed(g);var a="0";d.find(".margin").val(e);if(b!=0){a=(e/b)*100;a=a.toFixed(g)}d.find(".marginp").val(a)},recalculateAllMargin:function(){var g=parseInt(jQuery(".numberOfCurrencyDecimal").val());var e=this;var c=this.getLineItemContentsContainer();var d=0;var b=0;var f=0;var a=0;c.find("tr."+this.rowClass).each(function(h,j){var i=jQuery(j);var k=e.getQuantityValue(i);d+=e.getTotalAfterDiscount(i);b+=e.getPurchase(i)});f=d-b;if(b!=0){a=(f/b)*100}b=b.toFixed(g);f=f.toFixed(g);a=a.toFixed(g);jQuery(".total_purchase").text(b);jQuery(".total_margin").text(f);jQuery(".total_marginp").text(a)},registerLineItemsPopUpCancelClickEvent:function(){var a=this.getForm();a.on("click",".cancelLink",function(){jQuery(".closeDiv").trigger("click")})},lineItemResultActions:function(){var b=this;var a=this.getLineItemResultContainer();this.registerFinalDiscountShowEvent();this.registerFinalDiscountValueChangeEvent();this.registerFinalDiscountChangeEvent();this.registerLineItemActionSaveEvent();this.registerLineItemsPopUpCancelClickEvent();this.registerGroupTaxShowEvent();this.registerGroupTaxChangeEvent();a.on("click",".closeDiv",function(c){jQuery(c.target).closest("div").addClass("hide")})},lineItemRowCalculations:function(a){this.calculateLineItemTotal(a);this.calculateDiscountForLineItem(a);this.calculateTaxForLineItem(a);this.calculateLineItemNetPrice(a)},lineItemToTalResultCalculations:function(){this.calculateNetTotal();this.calculateFinalDiscount();if(this.isGroupTaxMode()){this.calculateGroupTax()}this.calculateGrandTotal();this.calculateTotalMargin()},quantityChangeActions:function(a){this.lineItemRowCalculations(a);this.lineItemToTalResultCalculations()},lineItemDiscountChangeActions:function(a){this.calculateDiscountForLineItem(a);this.calculateTaxForLineItem(a);this.calculateLineItemNetPrice(a);this.lineItemToTalResultCalculations();this.recalculateMargin(a);this.recalculateAllMargin()},taxPercentageChangeActions:function(a){this.calculateLineItemNetPrice(a);this.calculateNetTotal();this.calculateFinalDiscount();if(this.isGroupTaxMode()){this.calculateGroupTax()}this.calculateGrandTotal()},lineItemDeleteActions:function(){this.lineItemToTalResultCalculations()},finalDiscountChangeActions:function(){this.calculateFinalDiscount();if(this.isGroupTaxMode()){this.calculateGroupTax()}this.calculateGrandTotal()},registerDisountChangeEvent:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("change",".discounts",function(d){var c=jQuery(d.currentTarget).closest("tr."+b.rowClass);b.lineItemDiscountChangeActions(c)})},registerDisountValueChange:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("click",".discountSave",function(f){var c=jQuery(f.currentTarget);if(!app.isHidden(c)){var d=jQuery(f.currentTarget).closest("tr."+b.rowClass);b.lineItemDiscountChangeActions(d)}})},hideLineItemPopup:function(){var b=this.getForm();var a=jQuery(".popupTable",b).closest("div");if(a.length>0){a.addClass("hide")}},registerLineItemDiscountShowEvent:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("click",".individualDiscount",function(g){var f=jQuery(g.currentTarget);var d=b.isProductSelected(f);if(d==true){return}var c=jQuery(g.currentTarget).closest("td");b.hideLineItemPopup();c.find("div.discountUI").removeClass("hide")})},registerProductAndServicePopup:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("click","img.lineItemPopup",function(d){var c=jQuery(d.currentTarget);b.lineItemPopupEventHandler(c).then(function(g){var f=c.closest("tr");var e=f.find(".deletedItem");if(e.length>0){e.remove()}})})},registerPriceBookPopUp:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("click",".priceBookPopup",function(f){var d=jQuery(f.currentTarget);var c=b.isProductSelected(d);if(c==true){return}b.pricebooksPopupHandler(d)})},registerQuantityChangeEventHandler:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("focusout",".qty",function(g){var c=jQuery(g.currentTarget);var f=c.closest("tr."+b.rowClass);var d=f.data("quantityInStock");if(typeof d!="undefined"){if(parseFloat(c.val())>parseFloat(d)){f.find(".stockAlert").removeClass("hide").find(".maxQuantity").text(d)}else{f.find(".stockAlert").addClass("hide")}}b.quantityChangeActions(f)})},registerListPriceChangeEvent:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("focusout","input.listPrice",function(f){var c=jQuery(f.currentTarget);var d=b.getClosestLineItemRow(c);b.quantityChangeActions(d)})},registerTaxPercentageChange:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("focusout",".taxPercentage",function(f){var c=jQuery(f.currentTarget);var d=b.getClosestLineItemRow(c);b.calculateTaxForLineItem(d)});a.on("change",".tax_option",function(f){var c=jQuery(f.currentTarget);var d=b.getClosestLineItemRow(c);b.calculateTaxForLineItem(d)});a.on("click",".taxSave",function(f){var c=jQuery(f.currentTarget);var d=b.getClosestLineItemRow(c);b.taxPercentageChangeActions(d)})},isProductSelected:function(b){var c=b.closest("tr");var d=c.find(".productName");var a=d.validationEngine("validate");return a},registerLineItemTaxShowEvent:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("click",".individualTax",function(g){var f=jQuery(g.currentTarget);var d=b.isProductSelected(f);if(d==true){return}var c=jQuery(g.currentTarget).closest("td");b.hideLineItemPopup();c.find(".taxUI").removeClass("hide")})},registerDeleteLineItemEvent:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("click",".deleteRow",function(d){var c=jQuery(d.currentTarget);c.closest("tr."+b.rowClass).remove();b.checkLineItemRow();b.lineItemDeleteActions()})},registerTaxTypeChange:function(){var b=this;var a=this.getLineItemContentsContainer();this.getTaxTypeSelectElement().on("change",function(c){if(b.isIndividualTaxMode()){jQuery("#group_tax_row").addClass("hide");a.find("tr."+b.rowClass).each(function(d,f){var e=jQuery(f);e.find(".individualTaxContainer,.productTaxTotal").removeClass("hide");b.lineItemRowCalculations(e)})}else{jQuery("#group_tax_row").removeClass("hide");a.find("tr."+b.rowClass).each(function(d,f){var e=jQuery(f);e.find(".individualTaxContainer,.productTaxTotal").addClass("hide");b.calculateLineItemNetPrice(e)})}b.lineItemToTalResultCalculations()})},registerCurrencyChangeEvent:function(){var a=this;jQuery("#currency_id").change(function(j){var g=jQuery(j.currentTarget);var i=g.val();var h=jQuery("#conversion_rate");var c=h.val();a.prevSelectedCurrencyConversionRate=c;var f=g.find("option:selected");var d=f.data("conversionRate");h.val(d);d=parseFloat(d)/parseFloat(c);a.LineItemDirectDiscountCal(d);var b=a.getLineItemContentsContainer();b.find("tr."+a.rowClass).each(function(e,o){var l=jQuery(o);var p=jQuery(l).find("[name^=listPrice]");var n=JSON.parse(p.attr("list-info"));if(typeof n[i]!="undefined"){a.setListPriceValue(l,n[i]);a.lineItemRowCalculations(l)}else{var m=a.getListPriceValue(l);var k=m*d;a.setListPriceValue(l,k);a.lineItemRowCalculations(l)}});a.lineItemToTalResultCalculations();jQuery("#prev_selected_currency_id").val(f.val())})},LineItemDirectDiscountCal:function(b){var c=this;var a=jQuery(".lineItemRow");jQuery(a).each(function(d){var g=jQuery(a[d]);var i=g.find("div.discountUI");var f=i.find("input.discounts").filter(":checked");var e=f.closest("tr");var h=f.data("discountType");var j=e.find(".discountVal").val();if((h==Inventory_Edit_Js.directAmountDiscountType)){var k=b*j;e.find(".discountVal").val(k);jQuery(f).closest("tr").find(".discountVal").val(k);c.setDiscountTotal(g,k)}})},lineItemActions:function(){var a=this.getLineItemContentsContainer();this.registerDisountChangeEvent();this.registerDisountValueChange();this.registerLineItemDiscountShowEvent();this.registerLineItemAutoComplete();this.registerClearLineItemSelection();this.registerProductAndServicePopup();this.registerPriceBookPopUp();this.registerQuantityChangeEventHandler();this.registerListPriceChangeEvent();this.registerTaxPercentageChange();this.registerLineItemTaxShowEvent();this.registerDeleteLineItemEvent();this.registerTaxTypeChange();this.registerCurrencyChangeEvent();this.registerRecalculateMargin();a.on("click",".closeDiv",function(b){jQuery(b.currentTarget).closest("div").addClass("hide")});a.on("click",".clearComment",function(d){var c=jQuery(d.currentTarget);var b=c.closest("div");var f=jQuery(".lineItemCommentBox",b).val("")})},updateLineItemsElementWithSequenceNumber:function(g,m,h){if(typeof h=="undefined"){h=0}var a=new Array("productName","subproduct_ids","hdnProductId","comment","qty","listPrice","discount_type","discount_percentage","discount_amount","lineItemType","searchIcon","netPrice","subprod_names","productTotal","discountTotal","totalAfterDiscount","taxTotal","purchase");var b=new Array("discount");var n=new Array("taxPercentage");for(var p in n){var l=n[p];jQuery("."+l,g).each(function(s,t){var r=t.id;a.push(r.slice(0,(r.length-1)))})}var k="row"+m;for(var o in a){var f=a[o];var i=f+h;var d=f+m;g.find("#"+i).attr("id",d).filter('[name="'+i+'"]').attr("name",d)}for(var j in b){var q=b[j];var c=q+h;var e=q+m;g.find('[name="'+c+'"]').attr("name",e)}return g.attr("id",k)},updateLineItemElementByOrder:function(){var b=this.getLineItemContentsContainer();var a=this;jQuery("tr."+this.rowClass,b).each(function(e,i){var f=jQuery(i);var g=(e+1);var d="row"+g;var c=f.attr("id");if(d!=c){var h=c.split("row");a.updateLineItemsElementWithSequenceNumber(f,g,h[1])}})},saveProductCount:function(){jQuery("#totalProductCount").val(jQuery("tr."+this.rowClass,this.getLineItemContentsContainer()).length)},saveSubTotalValue:function(){jQuery("#subtotal").val(this.getNetTotal())},saveTotalValue:function(){jQuery("#total").val(this.getGrandTotal())},makeLineItemsSortable:function(){var b=this;var a=this.getLineItemContentsContainer();a.sortable({containment:a,handle:".dragHandle",items:"tr."+this.rowClass,revert:true,tolerance:"pointer",helper:function(d,c){c.children().each(function(e,f){f=jQuery(f);f.width(f.width())});return c},start:function(d,e){var f=e.item.find("textarea").attr("id");if(typeof f!="undefined"){var c=CKEDITOR.instances[f];c.destroy()}},stop:function(e,f){var c={};var d=f.item.find("textarea");if(typeof d.attr("id")!="undefined"){b.loadCkEditorElement(d)}}}).mousedown(function(c){b.getClosestLineItemRow(jQuery(c.target)).find("input:focus").trigger("focusout")})},registerSubmitEvent:function(){var a=this;var b=this.getForm();this._super();b.submit(function(d){a.updateLineItemElementByOrder();var c=a.getLineItemContentsContainer();jQuery(".discountSave",c).trigger("click");a.lineItemToTalResultCalculations();a.saveProductCount();a.saveSubTotalValue();a.saveTotalValue();a.savePreTaxTotalValue()})},registerLineItemAutoComplete:function(a){var b=this;if(typeof a=="undefined"){a=b.getLineItemContentsContainer()}a.find("input.autoComplete").autocomplete({delay:"600",minLength:"3",source:function(f,d){var h=jQuery(this.element[0]);var e=h.closest("td");var g=f.term;var i={};var c=e.find(".lineItemPopup").data("moduleName");i.search_module=c;i.search_value=g;b.searchModuleNames(i).then(function(m){var k=new Array();var l=m.result;if(l.length<=0){l=new Array({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results"})}for(var n in l){var j=l[n];k.push(j)}d(k)})},select:function(g,h){var c=h.item;if(typeof c.type!="undefined"&&c.type=="no results"){return false}var e=jQuery(this);e.attr("disabled","disabled");var f=e.closest("td");var d=f.find(".lineItemPopup").data("moduleName");var j=f.find(".lineItemPopup");var i="index.php?module=Inventory&action=GetTaxes&record="+c.id+"&currency_id="+jQuery("#currency_id option:selected").val();AppConnector.request(i).then(function(l){for(var m in l){if(typeof l[m]=="object"){var k=l[m];b.mapResultsToFields(d,j,k)}}},function(k,l){})},change:function(d,e){var c=jQuery(this);if(c.attr("disabled")==undefined){c.closest("td").find(".clearLineItem").trigger("click")}}})},registerClearLineItemSelection:function(){var b=this;var a=this.getLineItemContentsContainer();a.on("click",".clearLineItem",function(f){var d=jQuery(f.currentTarget);var c=d.closest("td");b.clearLineItemDetails(c);c.find("input.productName").removeAttr("disabled").val("");f.preventDefault()})},clearLineItemDetails:function(a){var c=this;var b=a.closest("tr."+c.rowClass);jQuery("input.selectedModuleId",b).val("");jQuery("input.listPrice",b).val("0");jQuery(".lineItemCommentBox",b).val("");jQuery(".usageUnit",b).text("");jQuery(".margin",b).val("0");c.quantityChangeActions(b)},checkLineItemRow:function(){var a=this.getLineItemContentsContainer();var b=a.find(".lineItemRow").length;if(b>1){this.showLineItemsDeleteIcon()}else{this.hideLineItemsDeleteIcon()}},showLineItemsDeleteIcon:function(){var a=this.getLineItemContentsContainer();a.find(".deleteRow").show()},hideLineItemsDeleteIcon:function(){var a=this.getLineItemContentsContainer();a.find(".deleteRow").hide()},swapObject:function(d){var a={};var e,c;for(var b in d){e=d[b];c=b;a[e]=c}return a},registerForRealtionOperation:function(){var b=this.getForm();var a=b.find('[name="relationOperation"]').val();if(a){jQuery(".qty").trigger("focusout")}},setPreTaxTotal:function(a){jQuery("#preTaxTotal").text(a);return this},getPreTaxTotal:function(){return parseFloat(jQuery("#preTaxTotal").text())},calculatePreTaxTotal:function(){var e=parseInt(jQuery(".numberOfCurrencyDecimal").val());var d=this.getNetTotalIncludeTaxType();var c=this.getFinalDiscountTotal();var b=d-c;var a=parseFloat(b).toFixed(e);this.setPreTaxTotal(a)},savePreTaxTotalValue:function(){jQuery("#pre_tax_total").val(this.getPreTaxTotal())},registerBasicEvents:function(a){this._super(a)},registerEvents:function(){this._super();this.registerAddingNewProductsAndServices();this.lineItemActions();this.lineItemResultActions();this.makeLineItemsSortable();this.checkLineItemRow();this.registerForRealtionOperation()}});