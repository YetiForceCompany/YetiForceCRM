
jQuery.Class("Vtiger_Inventory_Js",{},{inventoryContainer:false,inventoryHeadContainer:false,summaryTaxesContainer:false,summaryDiscountContainer:false,summaryCurrenciesContainer:false,rowClass:"tr.inventoryRow",discountModalFields:["aggregationType","globalDiscount","groupCheckbox","groupDiscount","individualDiscount","individualDiscountType"],taxModalFields:["aggregationType","globalTax","groupCheckbox","groupTax","individualTax"],getInventoryItemsContainer:function(){if(this.inventoryContainer===false){this.inventoryContainer=$(".inventoryItems")}return this.inventoryContainer},getInventoryHeadContainer:function(){if(this.inventoryHeadContainer===false){this.inventoryHeadContainer=$(".inventoryHeader")}return this.inventoryHeadContainer},getInventorySummaryDiscountContainer:function(){if(this.summaryDiscountContainer===false){this.summaryDiscountContainer=$(".inventorySummaryDiscounts")}return this.summaryDiscountContainer},getInventorySummaryTaxesContainer:function(){if(this.summaryTaxesContainer===false){this.summaryTaxesContainer=$(".inventorySummaryTaxes")}return this.summaryTaxesContainer},getInventorySummaryCurrenciesContainer:function(){if(this.summaryCurrenciesContainer===false){this.summaryCurrenciesContainer=$(".inventorySummaryCurrencies")}return this.summaryCurrenciesContainer},getNextLineItemRowNumber:function(){var a=$(this.rowClass,this.getInventoryItemsContainer()).length;$("#inventoryItemsNo").val(a+1);return ++a},getAccountId:function(){var a=$("#accountReferenceField").val();if(a!=""){return $('[name="'+a+'"]').val()}return""},checkDeleteIcon:function(){var a=this.getInventoryItemsContainer();if(a.find(this.rowClass).length>1){this.showLineItemsDeleteIcon()}else{this.hideLineItemsDeleteIcon()}},showLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").removeClass("hide")},hideLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").addClass("hide")},getClosestRow:function(a){return a.closest(this.rowClass)},getBasicRow:function(){var a=$("#blackIthemTable tbody").clone(true,true);return a},isRecordSelected:function(b){var c=b.closest("tr");var d=c.find(".recordLabel");var a=d.validationEngine("validate");return a},getTaxModeSelectElement:function(b){var a=this.getInventoryHeadContainer();if(a.find("thead .taxMode").length>0){return $(".taxMode")}return b.find(".taxMode")},isIndividualTaxMode:function(c){var a=this.getTaxModeSelectElement(c);var b=a.find("option:selected");if(b.val()=="1"){return true}return false},isGroupTaxMode:function(){var a=this.getTaxModeSelectElement();var b=a.find("option:selected");if(b.val()=="0"){return true}return false},showIndividualTax:function(e){var d=this;var c=d.getInventorySummaryTaxesContainer().find(".groupTax");var a=d.getInventoryItemsContainer();var b=$("#blackIthemTable tbody");if(d.isIndividualTaxMode()){c.addClass("hide");a.find(".changeTax").removeClass("hide");b.find(".changeTax").removeClass("hide")}else{c.removeClass("hide");a.find(".changeTax").addClass("hide");b.find(".changeTax").addClass("hide")}d.setTax(a,0);d.setTaxParam(a,[]);d.rowsCalculations()},getDiscountModeSelectElement:function(b){var a=this.getInventoryHeadContainer();if(a.find("thead .discountMode").length>0){return $(".discountMode")}return b.find(".discountMode")},isIndividualDiscountMode:function(c){var a=this.getDiscountModeSelectElement(c);var b=a.find("option:selected");if(b.val()=="1"){return true}return false},showIndividualDiscount:function(e){var d=this;var a=d.getInventorySummaryDiscountContainer().find(".groupDiscount");var b=d.getInventoryItemsContainer();var c=$("#blackIthemTable tbody");if(d.isIndividualDiscountMode()){a.addClass("hide");b.find(".changeDiscount").removeClass("hide");c.find(".changeDiscount").removeClass("hide")}else{a.removeClass("hide");b.find(".changeDiscount").addClass("hide");b.find(".changeDiscount").addClass("hide")}d.setDiscount(b,0);d.setDiscountParam(b,[]);d.rowsCalculations()},getCurrency:function(){var a=$('[name="currency"]',this.getInventoryHeadContainer());return a.find("option:selected").val()},getTax:function(a){return app.parseNumberToFloat($(".tax",a).val())},getQuantityValue:function(a){return app.parseNumberToFloat($(".qty",a).val())},getUnitPriceValue:function(a){return app.parseNumberToFloat($(".unitPrice",a).val())},getDiscount:function(a){var b=$(".discount",a).val();if(b==undefined){b=0}return app.parseNumberToFloat(b)},getNetPrice:function(a){return app.parseNumberToFloat($(".netPrice",a).val())},getTotalPrice:function(a){if($(".totalPrice",a).length!=0){return app.parseNumberToFloat($(".totalPrice",a).val())}else{return 0}},getGrossPrice:function(a){return app.parseNumberToFloat($(".grossPrice",a).val())},getPurchase:function(a){var b=this.getQuantityValue(a);return app.parseNumberToFloat($(".purchase",a).val())*b},getSummaryGrossPrice:function(){var b=this;var a=0;this.getInventoryItemsContainer().find(b.rowClass).each(function(c){a+=b.getGrossPrice($(this))});return app.parseNumberToFloat(a)},setUnitPrice:function(b,a){a=app.parseNumberToShow(a);b.find(".unitPrice").val(a).attr("title",a);return this},setNetPrice:function(b,a){a=app.parseNumberToShow(a);$(".netPriceText",b).text(a);$(".netPrice",b).val(a)},setGrossPrice:function(b,a){a=app.parseNumberToShow(a);$(".grossPriceText",b).text(a);$(".grossPrice",b).val(a)},setTotalPrice:function(b,a){a=app.parseNumberToShow(a);$(".totalPriceText",b).text(a);$(".totalPrice",b).val(a)},setMargin:function(b,a){a=app.parseNumberToShow(a);$(".margin",b).val(a)},setMarginP:function(b,a){a=app.parseNumberToShow(a);$(".marginp",b).val(a)},setDiscount:function(b,a){a=app.parseNumberToShow(a);$(".discount",b).val(a)},setDiscountParam:function(b,a){$(".discountParam",b).val(JSON.stringify(a))},setTax:function(b,a){a=app.parseNumberToShow(a);$(".tax",b).val(a)},setTaxParam:function(b,a){$(".taxParam",b).val(JSON.stringify(a))},quantityChangeActions:function(a){this.rowCalculations(a);this.summaryCalculations()},rowCalculations:function(a){this.calculateTotalPrice(a);this.calculateNetPrice(a);this.calculateGrossPrice(a);this.calculateMargin(a)},rowsCalculations:function(){var a=this;this.getInventoryItemsContainer().find(a.rowClass).each(function(b){a.quantityChangeActions($(this))})},summaryCalculations:function(){var a=this;a.getInventoryItemsContainer().find("tfoot .wisableTd").each(function(b){a.calculatSummary($(this),$(this).data("sumfield"))});a.calculatDiscountSummary();a.calculatTaxSummary();a.calculatCurrenciesSummary()},calculatSummary:function(a,d){var c=this;var b=0;this.getInventoryItemsContainer().find(c.rowClass).each(function(e){b+=app.parseNumberToFloat($(this).find("."+d).val())});a.text(app.parseNumberToShow(b))},calculatDiscountSummary:function(){var b=this;var c=b.getAllDiscount();var a=b.getInventorySummaryDiscountContainer();a.find("input").val(app.parseNumberToShow(c))},getAllDiscount:function(){var a=this;var b=0;this.getInventoryItemsContainer().find(a.rowClass).each(function(d){var e=$(this);var c=a.getDiscount(e);b+=c});return b},calculatCurrenciesSummary:function(){var g=this;var a=g.getInventorySummaryCurrenciesContainer();var f=$('[name="currency"] option:selected',g.getInventoryHeadContainer());var h=$('[name="currency"] option[data-base-currency="1"]',g.getInventoryHeadContainer());var b=f.data("conversionRate");var e=h.data("conversionRate");if(b==e){a.addClass("hide");return}b=parseFloat(e)/parseFloat(b);a.removeClass("hide");var c=g.getAllTaxs();var d=0;a.find(".panel-body").html("");$.each(c,function(i,j){if(j!=undefined){j=j*b;var k=a.find(".hide .form-group").clone();k.find(".percent").text(i+"%");k.find("input").val(app.parseNumberToShow(j));k.appendTo(a.find(".panel-body"));d+=j}});a.find(".panel-footer input").val(app.parseNumberToShow(d))},calculatTaxSummary:function(){var d=this;var b=d.getAllTaxs();var a=d.getInventorySummaryTaxesContainer();a.find(".panel-body").html("");var c=0;$.each(b,function(e,f){if(f!=undefined){var g=a.find(".hide .form-group").clone();g.find(".percent").text(e+"%");g.find("input").val(app.parseNumberToShow(f));g.appendTo(a.find(".panel-body"));c+=f}});a.find(".panel-footer input").val(app.parseNumberToShow(c))},getAllTaxs:function(){var b=this;var a=[];this.getInventoryItemsContainer().find(b.rowClass).each(function(c){var f=$(this);var g=b.getNetPrice(f);var e=f.find(".taxParam").val();if(e!=""&&e!="[]"&&e!=undefined){var d=$.parseJSON(e);if(typeof d.aggregationType=="string"){d.aggregationType=[d.aggregationType]}$.each(d.aggregationType,function(k,j){var j=j+"Tax";var i=d[j];var h=0;if(a[i]!=undefined){h=parseFloat(a[i])}a[i]=h+g*(i/100)})}});return a},calculateNetPrice:function(a){var b=this.getTotalPrice(a)-this.getDiscount(a);this.setNetPrice(a,b)},calculateGrossPrice:function(b){var c=this.getNetPrice(b);if(this.isIndividualTaxMode(b)){var a=this.getTax(b);c+=a}this.setGrossPrice(b,c)},calculateTotalPrice:function(b){var a=this.getQuantityValue(b)*this.getUnitPriceValue(b);this.setTotalPrice(b,a)},calculateMargin:function(d){var e=this.getNetPrice(d);var b=this.getPurchase(d);var c=e-b;this.setMargin(d,c);var a="0";if(b!==0){a=(c/b)*100}this.setMarginP(d,a)},calculateDiscount:function(j,h){var d=app.parseNumberToFloat(h.find(".valueTotalPrice").text()),b=d,k=0,e=0,f=0,a=0;var i=h.find(".discountsType").val();if(i=="0"||i=="1"){if(h.find(".activepanel .globalDiscount").length>0){var k=app.parseNumberToFloat(h.find(".activepanel .globalDiscount").val())}if(h.find(".activepanel .individualDiscountType").length>0){var c=h.find(".activepanel .individualDiscountType:checked").val();var g=h.find(".activepanel .individualDiscountValue").val();if(c=="percentage"){f=d*(g/100)}else{f=g}}if(h.find(".activepanel .groupCheckbox").length>0&&h.find(".activepanel .groupCheckbox").prop("checked")==true){var e=app.parseNumberToFloat(h.find(".groupValue").val());e=d*(e/100)}b=b*((100-k)/100);b=b-app.parseNumberToFloat(f);b=b-e}else{if(i=="2"){h.find(".activepanel").each(function(n){var m=$(this);if(m.find(".globalDiscount").length>0){var o=app.parseNumberToFloat(m.find(".globalDiscount").val());b=b*((100-o)/100)}else{if(m.find(".groupCheckbox").length>0&&m.find(".groupCheckbox").prop("checked")==true){var l=app.parseNumberToFloat(m.find(".groupValue").val());b=b*((100-l)/100)}else{if(m.find(".individualDiscountType").length>0){var p=app.parseNumberToFloat(m.find(".individualDiscountValue").val());if(m.find('.individualDiscountType[name="individual"]:checked').val()=="percentage"){b=b*((100-p)/100)}else{b=b-p}}}}})}}h.find(".valuePrices").text(app.parseNumberToShow(b));h.find(".valueDiscount").text(app.parseNumberToShow(d-b))},calculateTax:function(k,j){var g=app.parseNumberToFloat(j.find(".valueNetPrice").text()),b=g,c=0,f=0,a=0,h=0,e=0;var d=j.find(".taxsType").val();if(d=="0"||d=="1"){if(j.find(".activepanel .globalTax").length>0){var c=j.find(".activepanel .globalTax").val()}if(j.find(".activepanel .individualTaxValue").length>0){var i=app.parseNumberToFloat(j.find(".activepanel .individualTaxValue").val());h=(i/100)*b}if(j.find(".activepanel .groupTax").length>0){var f=app.parseNumberToFloat(j.find(".groupTax").val());f=g*(app.parseNumberToFloat(f)/100)}if(j.find(".activepanel .regionalTax").length>0){var a=app.parseNumberToFloat(j.find(".regionalTax").val());a=g*(app.parseNumberToFloat(a)/100)}b=b*((100+app.parseNumberToFloat(c))/100);b=b+app.parseNumberToFloat(h);b=b+app.parseNumberToFloat(f);b=b+app.parseNumberToFloat(a)}else{if(d=="2"){j.find(".activepanel").each(function(p){var l=$(this);if(l.find(".globalTax").length>0){var o=app.parseNumberToFloat(l.find(".globalTax").val());b=b*((100+o)/100)}else{if(l.find(".groupTax").length>0){var n=app.parseNumberToFloat(l.find(".groupTax").val());b=b*((100+n)/100)}else{if(l.find(".regionalTax").length>0){var m=app.parseNumberToFloat(l.find(".regionalTax").val());b=b*((100+m)/100)}else{if(l.find(".individualTaxValue").length>0){var q=app.parseNumberToFloat(l.find(".individualTaxValue").val());b=((q+100)/100)*b}}}}})}}j.find(".valuePrices").text(app.parseNumberToShow(b));j.find(".valueTax").text(app.parseNumberToShow(b-g))},updateRowSequence:function(){var a=this.getInventoryItemsContainer();a.find(this.rowClass).each(function(b){$(this).find(".sequence").val(b+1)})},registerInventorySaveData:function(a){var b=this;a.on(Vtiger_Edit_Js.recordPreSave,function(f,d){if(!b.checkLimits(a)){return false}var c=a.find("#blackIthemTable");c.find("[name]").removeAttr("name")})},pricebooksPopupHandler:function(a){var d=this;var c=a.closest(this.rowClass);var b=c.find(".rowName");var e={};e.module="PriceBooks";e.src_module=$('[name="popupReferenceModule"]',b).val();e.src_record=$(".sourceField",b).val();e.src_field=$('[name="popupReferenceModule"]',b).data("field");e.get_url="getProductUnitPriceURL";e.currency_id=d.getCurrency();this.showPopup(e).then(function(g){var f=JSON.parse(g);for(var h in f){d.setUnitPrice(c,f[h])}d.quantityChangeActions(d.getClosestRow(b))})},showPopup:function(c){var a=$.Deferred();var b=Vtiger_Popup_Js.getInstance();b.show(c,function(d){a.resolve(d)});return a.promise()},subProductsCashe:[],loadSubProducts:function(g,a){var d=this;var c=jQuery("input.sourceField",g).val();var e=g.find('.rowName input[name="popupReferenceModule"]').val();d.removeSubProducts(g);if(c=="0"||$.inArray(e,["Products","Services"])<0){return false}if(d.subProductsCashe[c]){d.addSubProducts(g,d.subProductsCashe[c]);return false}var f={module:"Products",action:"SubProducts",record:c};if(a){var b=jQuery.progressIndicator()}AppConnector.request(f).then(function(i){var h=i.result;d.subProductsCashe[c]=h;d.addSubProducts(g,h);if(b){b.hide()}},function(h,i){if(b){b.hide()}console.error(h,i)})},removeSubProducts:function(a){var b=$(".subProductsContainer ul",a);b.find("li").remove()},addSubProducts:function(c,b){var e=$(".subProductsContainer ul",c);for(var d in b){var a=$("<li>").text(b[d]);e.append(a)}},mapResultsToFields:function(g,l,c){var j=this;for(var b in c){var a=c[b];var k=a.description;var f=a.unitPriceValues;var d=JSON.stringify(f);for(var h in a.autoFields){l.find("input."+h).val(a.autoFields[h])}var i=j.getCurrency();if(typeof f[i]!=="undefined"){var e=f[i]}else{var e=a.price}j.setUnitPrice(l,app.parseNumberToFloat(e));$("input.unitPrice",l).attr("list-info",d);$("textarea.commentTextarea",l).val(k)}if(g==="Products"){j.loadSubProducts(l,true)}j.quantityChangeActions(l)},saveDiscountsParameters:function(d,b){var a=this;var c={};var e=["aggregationType","groupCheckbox","individualDiscountType"];$.each(a.discountModalFields,function(f,g){if($.inArray(g,e)>=0){if(b.find('[name="'+g+'"]:checked').length>1){c[g]=[];b.find('[name="'+g+'"]:checked').each(function(h){c[g].push($(this).val())})}else{c[g]=b.find('[name="'+g+'"]:checked').val()}}else{c[g]=b.find('[name="'+g+'"]').val()}});a.setDiscountParam(d,c)},saveTaxsParameters:function(d,b){var a=this;var c={};var e=["aggregationType","groupCheckbox","individualTaxType"];$.each(a.taxModalFields,function(f,g){if($.inArray(g,e)>=0){if(b.find('[name="'+g+'"]:checked').length>1){c[g]=[];b.find('[name="'+g+'"]:checked').each(function(h){c[g].push($(this).val())})}else{c[g]=b.find('[name="'+g+'"]:checked').val()}}else{c[g]=b.find('[name="'+g+'"]').val()}});a.setTaxParam(d,c)},showExpandedRow:function(f){var e=this;var a=e.getInventoryItemsContainer();var b=a.find('[numrowex="'+f.attr("numrow")+'"]');var c=f.find(".toggleVisibility");c.data("status","1");c.find(".glyphicon").removeClass("glyphicon-menu-down");c.find(".glyphicon").addClass("glyphicon-menu-up");b.removeClass("hide");var d=Vtiger_Edit_Js.getInstance();$.each(b.find(".ckEditorSource"),function(g,h){d.loadCkEditorElement(jQuery(h))})},hideExpandedRow:function(e){var d=this;var a=d.getInventoryItemsContainer();var b=a.find('[numrowex="'+e.attr("numrow")+'"]');var c=e.find(".toggleVisibility");c.data("status","0");c.find(".glyphicon").removeClass("glyphicon-menu-up");c.find(".glyphicon").addClass("glyphicon-menu-down");b.addClass("hide");$.each(b.find(".ckEditorSource"),function(g,h){var f=CKEDITOR.instances[jQuery(h).attr("id")];if(f){f.destroy()}})},initDiscountsParameters:function(d,c){var b=this;var a=d.find(".discountParam").val();if(a==""||a==undefined){return}var a=JSON.parse(a);$.each(b.discountModalFields,function(e,g){var i=a[g];var f=c.find('[name="'+g+'"]');if(f.attr("type")=="checkbox"||f.attr("type")=="radio"){var h=i;if(!$.isArray(h)){h=[h]}$.each(h,function(j,k){var l=f.filter('[value="'+k+'"]').prop("checked",true);if(g=="aggregationType"){l.closest(".panel").find(".panel-body").show();l.closest(".panel").addClass("activepanel")}})}else{if(f.prop("tagName")=="SELECT"){f.find('option[value="'+i+'"]').prop("selected","selected").change()}else{c.find('[name="'+g+'"]').val(i)}}});b.calculateDiscount(d,c)},initTaxParameters:function(d,c){var b=this;var a=d.find(".taxParam").val();if(a==""){return}var a=JSON.parse(a);$.each(b.taxModalFields,function(e,g){var i=a[g];var f=c.find('[name="'+g+'"]');if(f.attr("type")=="checkbox"||f.attr("type")=="radio"){var h=i;if(!$.isArray(h)){h=[h]}$.each(h,function(j,k){var l=f.filter('[value="'+k+'"]').prop("checked",true);if(g=="aggregationType"){l.closest(".panel").find(".panel-body").show();l.closest(".panel").addClass("activepanel")}})}else{if(f.prop("tagName")=="SELECT"){f.find('option[value="'+i+'"]').prop("selected","selected").change()}else{c.find('[name="'+g+'"]').val(i)}}});b.calculateTax(d,c)},limitEnableSave:false,checkLimits:function(){var c=this;var d=c.getAccountId();var a=true;if(d==""||$("#inventoryLimit").val()=="0"||c.limitEnableSave){return true}var e={};e.data={module:app.getModuleName(),action:"Inventory",mode:"checkLimits",record:d,currency:c.getCurrency(),price:c.getSummaryGrossPrice(),limitConfig:$("#inventoryLimit").val(),};e.async=false;e.dataType="json";var b=jQuery.progressIndicator();AppConnector.request(e).then(function(f){b.hide();var g=c.getForm();if(f.result.status==false){app.showModalWindow(f.result.html,function(h){h.find(".enableSave").on("click",function(j,i){c.limitEnableSave=true;g.submit();app.hideModalWindow()})});a=false}},function(f,g){b.hide();console.error(f,g)});return a},currencyChangeActions:function(a,b){var c=this;if(b.data("baseCurrency")==0){c.showCurrencyChangeModal(a,b)}else{c.currencyConvertValues(a,b);a.data("oldValue",a.val())}},showCurrencyChangeModal:function(a,b){var d=this;if(d.lockCurrencyChange==true){return}d.lockCurrencyChange=true;var e=a.closest("[colspan]");var c=e.find(".modelContainer").clone();app.showModalWindow(c,function(h){var g=$(h);var f=JSON.parse(e.find(".currencyparam").val());if(f!=false){g.find(".currencyName").text(b.text());g.find(".currencyRate").val(f[b.val()]["value"]);g.find(".currencyDate").text(f[b.val()]["date"])}g.on("click",'button[type="submit"]',function(l){var j=g.find(".currencyRate").val();var k=app.parseNumberToFloat(j);var i=1/app.parseNumberToFloat(j);b.data("conversionRate",i);f[b.val()]["value"]=k;f[b.val()]["conversion"]=i;e.find(".currencyparam").val(JSON.stringify(f));d.currencyConvertValues(a,b);a.data("oldValue",a.val());app.hideModalWindow();d.lockCurrencyChange=false});g.on("click",'button[type="reset"]',function(i){a.val(a.data("oldValue")).change();d.lockCurrencyChange=false})})},currencyConvertValues:function(a,d){var f=this;var e=a.find('option[value="'+a.data("oldValue")+'"]');var b=d.data("conversionRate");var c=e.data("conversionRate");b=parseFloat(b)/parseFloat(c);this.getInventoryItemsContainer().find(f.rowClass).each(function(g){var h=$(this);f.setUnitPrice(h,app.parseNumberToFloat(f.getUnitPriceValue(h)*b));f.setDiscount(h,app.parseNumberToFloat(f.getDiscount(h)*b));f.setTax(h,app.parseNumberToFloat(f.getTax(h)*b));f.quantityChangeActions(h)})},registerAddItem:function(a){var c=this;var b=this.getInventoryItemsContainer();a.find(".btn-toolbar .addButton").on("click",function(h,f){var l=a.find("#blackIthemTable");var m=c.getBasicRow();var i=c.getNextLineItemRowNumber();var d=$(h.currentTarget).data("module");var j=$(h.currentTarget).data("field");var g=$(h.currentTarget).data("wysiwyg");var k=m.html().replace(/_NUM_/g,i);m.html(k);m=m.find("tr").appendTo(b.find("tbody"));m.find('.rowName input[name="popupReferenceModule"]').val(d).data("field",j);c.initItem(m)})},registerSortableItems:function(){var b=this;var a=b.getInventoryItemsContainer();a.sortable({handle:".dragHandle",items:b.rowClass,revert:true,tolerance:"pointer",placeholder:"ui-state-highlight",helper:function(d,c){c.children().each(function(e,f){f=$(f);f.width(f.width())});return c},start:function(c,d){a.find(b.rowClass).each(function(e,f){var g=$(f);b.hideExpandedRow(g)});d.item.startPos=d.item.index()},stop:function(d,e){var c=$(e.item.context).attr("numrow");var f=a.find(".numRow"+c).remove().clone();a.find('[numrow="'+c+'"]').after(f);if(e.item.startPos<e.item.index()){var f=a.find(".numRow"+c).next().remove().clone();a.find('[numrow="'+c+'"]').before(f)}b.updateRowSequence()}});a.disableSelection()},registerShowHideExpanded:function(a){var b=this;a.on("click",".toggleVisibility",function(d){var c=$(d.currentTarget);var f=b.getClosestRow(c);if(c.data("status")=="0"){b.showExpandedRow(f)}else{b.hideExpandedRow(f)}})},registerPriceBookPopUp:function(a){var b=this;a.on("click",".priceBookPopup",function(f){var d=$(f.currentTarget);var c=b.isRecordSelected(d);if(c==true){return}b.pricebooksPopupHandler(d)})},registerRowChangeEvent:function(a){var c=this;a.on("focusout",".qty",function(f){var d=$(f.currentTarget);c.quantityChangeActions(c.getClosestRow(d))});a.on("focusout",".unitPrice",function(f){var d=$(f.currentTarget);c.quantityChangeActions(c.getClosestRow(d))});a.on("focusout",".purchase",function(f){var d=$(f.currentTarget);c.quantityChangeActions(c.getClosestRow(d))});var b=c.getInventoryHeadContainer();b.on("change",".taxMode",function(f){var d=$(f.currentTarget);c.showIndividualTax(c.getClosestRow(d));c.rowsCalculations()});b.on("change",".discountMode",function(f){var d=$(f.currentTarget);c.showIndividualDiscount(c.getClosestRow(d));c.rowsCalculations()})},registerSubProducts:function(a){var b=this;a.find(".inventoryItems "+b.rowClass).each(function(c){b.loadSubProducts($(this),false)})},registerClearReferenceSelection:function(a){var b=this;a.on("click",".clearReferenceSelection",function(d){var c=$(d.currentTarget);var f=b.getClosestRow(c);b.removeSubProducts(f);f.find(".unitPrice,.tax,.discount,.margin,.purchase").val("0");f.find("textarea").val("");b.quantityChangeActions(f)})},registerDeleteLineItemEvent:function(a){var b=this;a.on("click",".deleteRow",function(d){var c=$(d.currentTarget);b.getClosestRow(c).remove();b.checkDeleteIcon()})},registerChangeDiscount:function(a){var b=this;a.on("click",".changeDiscount",function(g){var d=$(g.currentTarget);var h={module:app.getModuleName(),view:"Inventory",mode:"showDiscounts",currency:b.getCurrency(),sourceModule:app.getModuleName(),sourceRecord:app.getRecordId(),};if(d.hasClass("groupDiscount")){var f=b.getInventoryItemsContainer();if(f.find("tfoot .colTotalPrice").length!=0){h.totalPrice=app.parseNumberToFloat(f.find("tfoot .colTotalPrice").text())}else{h.totalPrice=0}h.discountType=1}else{var f=d.closest(b.rowClass);h.totalPrice=b.getTotalPrice(f);h.discountType=0}var c=jQuery.progressIndicator();AppConnector.request(h).then(function(e){app.showModalWindow(e,function(i){b.initDiscountsParameters(f,$(i));b.registerChangeDiscountModal(i,f,h)});c.hide()},function(e,i){c.hide();console.error(e,i)})})},registerChangeDiscountModal:function(b,c,d){var a=this;b.on("change",".individualDiscountType",function(g){var f=$(g.currentTarget);b.find(".individualDiscountContainer .input-group-addon").text(f.data("symbol"))});b.on("change",'.activeCheckbox[name="aggregationType"]',function(g){var f=$(g.currentTarget);if(f.attr("type")=="checkbox"&&this.checked){f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{if(f.attr("type")=="radio"){b.find(".panel").removeClass("activepanel");b.find(".panel .panel-body").hide();f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{f.closest(".panel").find(".panel-body").hide();f.closest(".panel").removeClass("activepanel")}}});b.on("change",".activeCheckbox, .globalDiscount,.individualDiscountValue,.individualDiscountType,.groupCheckbox",function(g){var f=$(g.currentTarget);a.calculateDiscount(c,b)});b.on("click",".saveDiscount",function(g){a.saveDiscountsParameters(c,b);if(d.discountType==0){a.setDiscount(c,b.find(".valueDiscount").text());a.quantityChangeActions(c)}else{var f=app.parseNumberToFloat(b.find(".valueDiscount").text())/app.parseNumberToFloat(b.find(".valueTotalPrice").text());c.find(a.rowClass).each(function(e){a.setDiscount($(this),a.getTotalPrice($(this))*f);a.quantityChangeActions($(this))})}app.hideModalWindow()})},registerChangeTax:function(a){var b=this;a.on("click",".changeTax",function(h){var f=$(h.currentTarget);var i={module:app.getModuleName(),view:"Inventory",mode:"showTaxes",currency:b.getCurrency(),sourceRecord:app.getRecordId(),};if(f.hasClass("groupTax")){var g=b.getInventoryItemsContainer();var c=0;if(g.find("tfoot .colNetPrice").length>0){c=g.find("tfoot .colNetPrice").text()}else{if(g.find("tfoot .colTotalPrice ").length>0){c=g.find("tfoot .colTotalPrice ").text()}}i.totalPrice=app.parseNumberToFloat(c);i.taxType=1}else{var g=f.closest(b.rowClass);i.totalPrice=b.getNetPrice(g);i.taxType=0;i.record=g.find(".rowName .sourceField").val();i.recordModule=g.find('.rowName [name="popupReferenceModule"]').val()}var d=jQuery.progressIndicator();AppConnector.request(i).then(function(e){app.showModalWindow(e,function(j){b.initTaxParameters(g,$(j));b.registerChangeTaxModal(j,g,i)});d.hide()},function(e,j){d.hide();console.error(e,j)})})},lockCurrencyChange:false,registerChangeCurrency:function(a){var b=this;a.on("change",'[name="currency"]',function(f){var c=$(f.currentTarget);var d=c.find("option:selected").data("conversionSymbol");b.currencyChangeActions(c,c.find("option:selected"));a.find(".currencySymbol").text(d)})},registerChangeTaxModal:function(b,c,d){var a=this;b.on("change",".individualTaxType",function(g){var f=$(g.currentTarget);b.find(".individualTaxContainer .input-group-addon").text(f.data("symbol"))});b.on("change",'.activeCheckbox[name="aggregationType"]',function(g){var f=$(g.currentTarget);if(f.attr("type")=="checkbox"&&this.checked){f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{if(f.attr("type")=="radio"){b.find(".panel").removeClass("activepanel");b.find(".panel .panel-body").hide();f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{f.closest(".panel").find(".panel-body").hide();f.closest(".panel").removeClass("activepanel")}}});b.on("change",".activeCheckbox, .globalTax, .individualTaxValue, .groupTax, .regionalTax",function(g){var f=$(g.currentTarget);a.calculateTax(c,b)});b.on("click",".saveTaxs",function(g){a.saveTaxsParameters(c,b);if(d.taxType=="0"){a.setTax(c,b.find(".valueTax").text());a.quantityChangeActions(c)}else{var f=app.parseNumberToFloat(b.find(".valueTax").text())/app.parseNumberToFloat(b.find(".valueNetPrice").text());c.find(a.rowClass).each(function(h){if($(".netPrice",$(this)).length>0){var e=a.getNetPrice($(this))}else{if($(".totalPrice",$(this)).length>0){var e=a.getTotalPrice($(this))}}a.setTax($(this),e*f);a.quantityChangeActions($(this))})}app.hideModalWindow()})},registerRowAutoComplete:function(a){var b=this;var c=a.find(".rowName .sourceField");c.on(Vtiger_Edit_Js.postReferenceSelectionEvent,function(k,h){var g=$(k.currentTarget);var j=g.closest(b.rowClass);if(h.data.label){var d=h.data.id}else{for(var l in h.data){var d=l}}var f=j.find('.rowName [name="popupReferenceModule"]').val();var i="index.php?module="+app.getModuleName()+"&action=Inventory&mode=getDetails&record="+d+"&currency_id="+b.getCurrency();AppConnector.request(i).then(function(m){for(var n in m){if(typeof m[n]=="object"){var e=m[n];b.mapResultsToFields(f,j,e)}}},function(e,m){console.error(e,m)})})},initItem:function(a){var b=this;if(typeof a=="undefined"){a=b.getInventoryItemsContainer()}b.registerDeleteLineItemEvent(a);b.registerPriceBookPopUp(a);b.registerRowChangeEvent(a);b.registerRowAutoComplete(a);b.checkDeleteIcon();b.summaryCalculations()},registerEvents:function(a){this.registerInventorySaveData(a);this.registerAddItem(a);this.initItem();this.registerSortableItems();this.registerSubProducts(a);this.registerChangeDiscount(a);this.registerChangeTax(a);this.registerClearReferenceSelection(a);this.registerShowHideExpanded(a);this.registerChangeCurrency(a)},});jQuery(document).ready(function(){var a=app.getModuleName();var b=a+"_Inventory_Js";if(typeof window[b]=="undefined"){b="Vtiger_Inventory_Js"}if(typeof window[b]!="undefined"){var c=new window[b]();c.registerEvents(Vtiger_Edit_Js.getInstance().getForm())}});