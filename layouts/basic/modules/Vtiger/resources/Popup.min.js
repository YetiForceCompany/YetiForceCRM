
jQuery.Class("Vtiger_Popup_Js",{getInstance:function(){var c=app.getModuleName();var d=jQuery("#popUpClassName").val();if(typeof d!="undefined"){var b=d}else{var b=c+"_Popup_Js"}var e=Vtiger_Popup_Js;if(typeof window[b]!="undefined"){var a=new window[b]()}else{var a=new e()}return a}},{eventName:"",popupPageContentsContainer:false,sourceModule:false,sourceRecord:false,sourceField:false,multiSelect:false,relatedParentModule:false,getSourceModule:function(){if(this.sourceModule==false){this.sourceModule=jQuery("#parentModule").val()}return this.sourceModule},getSourceRecord:function(){if(this.sourceRecord==false){this.sourceRecord=jQuery("#sourceRecord").val()}return this.sourceRecord},getSourceField:function(){if(this.sourceField==false){this.sourceField=jQuery("#sourceField").val()}return this.sourceField},getRelatedParentModule:function(){if(this.relatedParentModule==false){this.relatedParentModule=jQuery("#relatedParentModule").val()}return this.relatedParentModule},getRelatedParentRecord:function(){return app.getMainParams("relatedParentId")},getSearchKey:function(){return jQuery("#searchableColumnsList").val()},getSearchValue:function(){return jQuery("#searchvalue").val()},getOrderBy:function(){return jQuery("#orderBy").val()},getSortOrder:function(){return jQuery("#sortOrder").val()},getPageNumber:function(){return jQuery("#pageNumber").val()},getPopupPageContainer:function(){if(this.popupPageContentsContainer==false){this.popupPageContentsContainer=jQuery("#popupPageContainer")}return this.popupPageContentsContainer},show:function(e,a,c,b,f){if(typeof e=="undefined"){e={}}if(typeof e=="object"&&(typeof e.view=="undefined")){e.view="Popup"}if(typeof b=="undefined"){b="postSelection"+Math.floor(Math.random()*10000)}if(typeof c=="undefined"){c="test"}if(typeof e=="object"){e.triggerEventName=b}else{e+="&triggerEventName="+b}var h=(typeof e=="string")?e:jQuery.param(e);var d="index.php?"+h;var g=window.open(d,c,"width=900,height=650,resizable=0,scrollbars=1");if(typeof this.destroy=="function"){this.destroy()}jQuery.initWindowMsg();if(typeof a!="undefined"){this.retrieveSelectedRecords(a,b)}if(typeof f=="function"){jQuery.windowMsg("Vtiger.OnPopupWindowLoad.Event",function(i){f(i)})}return g},retrieveSelectedRecords:function(a,b){if(typeof b=="undefined"){b="postSelection"}jQuery.windowMsg(b,function(c){a(c)})},destroy:function(){jQuery('form[name="windowComm"]').remove()},done:function(a,d,b){if(typeof d=="undefined"||d.length<=0){d="postSelection"}if(typeof b=="undefined"){b=self}b.close();var c=JSON.stringify(a);c=c.replace(/\$\$/g,"$ $");jQuery.triggerParentEvent(d,c)},getView:function(){var a=jQuery("#view").val();if(a==""){a="PopupAjax"}else{a=a+"Ajax"}return a},setEventName:function(a){this.eventName=a},getEventName:function(){return this.eventName},isMultiSelectMode:function(){if(this.multiSelect==false){this.multiSelect=jQuery("#multi_select")}var a=this.multiSelect.val();if(a){return a}return false},getListViewEntries:function(g){var c=this;var h=jQuery(g.currentTarget);var f=h.data("url");if(typeof f!="undefined"){f=f+"&currency_id="+jQuery("#currencyId").val();AppConnector.request(f).then(function(j){for(var k in j){if(typeof j[k]=="object"){var e=j[k]}}c.done(e,c.getEventName());g.preventDefault()},function(e,j){})}else{var i=h.data("id");var d=h.data("name");var b=h.data("info");var a={};a[i]={name:d,info:b};c.done(a,c.getEventName());g.preventDefault()}},registerSelectButton:function(){var b=this.getPopupPageContainer();var a=this;b.on("click","button.select",function(h){var f=b.find("table");var d={};var c=new Array();var g;jQuery("input.entryCheckBox",f).each(function(k,l){var e=jQuery(l);if(!e.is(":checked")){return true}var m=e.closest("tr");var n=m.data("id");c.push(n);var j=m.data("name");g=m.data("url");d[n]={name:j}});var i=JSON.stringify(c);if(Object.keys(d).length<=0){alert(app.vtranslate("JS_PLEASE_SELECT_ONE_RECORD"))}else{if(typeof g!="undefined"){g=g+"&idlist="+i+"&currency_id="+jQuery("#currencyId").val();AppConnector.request(g).then(function(k){for(var l in k){if(typeof k[l]=="object"){var e=k[l]}}var j=Object.keys(e).length;if(j==1){e=e[0]}a.done(e,a.getEventName());h.preventDefault()},function(e,j){})}else{a.done(d,a.getEventName())}}})},selectAllHandler:function(c){var a=jQuery(c.currentTarget);var b=a.is(":checked");var d=a.closest("table");if(b){jQuery("input.entryCheckBox",d).attr("checked","checked").closest("tr").addClass("highlightBackgroundColor")}else{jQuery("input.entryCheckBox",d).removeAttr("checked").closest("tr").removeClass("highlightBackgroundColor")}},registerEventForSelectAllInCurrentPage:function(){var b=this;var a=this.getPopupPageContainer();a.on("change","input.selectAllInCurrentPage",function(c){b.selectAllHandler(c)})},checkBoxChangeHandler:function(c){var b=jQuery(c.currentTarget);var a=b.closest("tr");if(b.is(":checked")){a.addClass("highlightBackgroundColor")}else{a.removeClass("highlightBackgroundColor")}},registerEventForCheckboxChange:function(){var b=this;var a=this.getPopupPageContainer();a.on("click","input.entryCheckBox",function(c){c.stopPropagation();b.checkBoxChangeHandler(c)})},getCompleteParams:function(){var a=this;var b={};b.module=app.getModuleName();b.view=this.getView();b.src_module=this.getSourceModule();b.src_record=this.getSourceRecord();b.src_field=this.getSourceField();b.search_key=this.getSearchKey();b.search_value=this.getSearchValue();b.orderby=this.getOrderBy();b.sortorder=this.getSortOrder();b.page=this.getPageNumber();b.related_parent_module=this.getRelatedParentModule();b.related_parent_id=this.getRelatedParentRecord();b.search_params=JSON.stringify(this.getListSearchParams());if(this.isMultiSelectMode()){b.multi_select=true}return b},getVarFromUrl:function(){var b={};var a=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(c,d,e){b[d]=e});return b},getPageRecords:function(d){var b=this;var a=jQuery.Deferred();var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});Vtiger_BaseList_Js.getPageRecords(d).then(function(e){jQuery("#popupContents").html(e);Vtiger_Helper_Js.showHorizontalTopScrollBar();c.progressIndicator({mode:"hide"});b.calculatePages().then(function(f){a.resolve(f)})},function(f,e){a.reject(f,e)});return a.promise()},calculatePages:function(){var b=jQuery.Deferred();var d=jQuery("#totalPageCount");var a=d.text();if(a==""){var e=jQuery("#totalCount").val();if(e!=""){var c=jQuery("#noOfEntries").val();if(c=="0"){c=1}pageCount=Math.ceil(e/c);if(pageCount==0){pageCount=1}d.text(pageCount);b.resolve();return b.promise()}this.getPageCount().then(function(g){var f=g.result["page"];if(f==0){f=1}d.text(f);b.resolve()})}else{b.resolve()}return b.promise()},searchHandler:function(){var a=jQuery.Deferred();var b=this.getCompleteParams();b.page=1;return this.getPageRecords(b).then(function(c){a.resolve(c)},function(d,c){a.reject(d,c)});return a.promise()},sortHandler:function(c){var b=jQuery.Deferred();if(c.hasClass("noSorting")){return}var f=c.data("columnname");var a=c.data("nextsortorderval");var e={orderby:f,sortorder:a};var d=this.getCompleteParams();jQuery.extend(d,e);return this.getPageRecords(d).then(function(g){b.resolve(g)},function(h,g){b.reject(h,g)});return b.promise()},registerEventForSort:function(){var b=this;var a=this.getPopupPageContainer();a.on("click",".listViewHeaderValues",function(d){var c=jQuery(d.currentTarget);b.sortHandler(c).then(function(e){b.updatePagination();b.registerListSearch()})})},nextPageHandler:function(){var b=jQuery.Deferred();var f=jQuery("#pageLimit").val();var g=jQuery("#noOfEntries").val();if(g==f){var a=jQuery("#pageNumber").val();var e=parseInt(a)+1;var d={page:e};var c=this.getCompleteParams();jQuery.extend(c,d);this.getPageRecords(c).then(function(h){jQuery("#pageNumber").val(e);jQuery("#pageToJump").val(e);b.resolve(h)},function(i,h){b.reject(i,h)})}return b.promise()},previousPageHandler:function(){var b=jQuery.Deferred();var a=jQuery("#pageNumber").val();var c=parseInt(a)-1;if(a>1){var e={page:c};var d=this.getCompleteParams();jQuery.extend(d,e);this.getPageRecords(d).then(function(f){jQuery("#pageNumber").val(c);jQuery("#pageToJump").val(c);b.resolve(f)},function(g,f){b.reject(g,f)})}return b.promise()},registerEventForPagination:function(){var a=this;jQuery("#listViewNextPageButton").on("click",function(){a.nextPageHandler().then(function(b){a.updatePagination();a.registerListSearch()})});jQuery("#listViewPreviousPageButton").on("click",function(){a.previousPageHandler().then(function(b){a.updatePagination();a.registerListSearch()})});jQuery("#listViewPageJump").on("click",function(h){jQuery("#pageToJump").validationEngine("hideAll");var d=jQuery("#totalPageCount");var b=d.text();if(b==""){var f=jQuery("#totalCount");var g=f.val();if(g!=""){var c=jQuery("#pageLimit").val();if(c=="0"){c=1}pageCount=Math.ceil(g/c);if(pageCount==0){pageCount=1}d.text(pageCount);return}d.progressIndicator({});a.getPageCount().then(function(i){var e=i.result["page"];d.text(e);f.val(i.result["numberOfRecords"]);d.progressIndicator({mode:"hide"})})}});jQuery("#listViewPageJumpDropDown").on("click","li",function(b){b.stopImmediatePropagation()}).on("keypress","#pageToJump",function(l){if(l.which==13){l.stopImmediatePropagation();var i=jQuery(l.currentTarget);var h=Vtiger_WholeNumberGreaterThanZero_Validator_Js.invokeValidation(i);if(typeof h!="undefined"){i.validationEngine("showPrompt",h,"","topLeft",true)}else{i.validationEngine("hideAll");var g=jQuery("#pageNumber");var c=g.val();var j=parseInt(i.val());var k=parseInt(jQuery("#totalPageCount").text());if(j>k){var m=app.vtranslate("JS_PAGE_NOT_EXIST");i.validationEngine("showPrompt",m,"","topLeft",true);return}if(j==c){var n=app.vtranslate("JS_YOU_ARE_IN_PAGE_NUMBER")+" "+j;var f={text:n,type:"info"};Vtiger_Helper_Js.showMessage(f);return}var b={page:j};var d=a.getCompleteParams();jQuery.extend(d,b);a.getPageRecords(d).then(function(e){g.val(j);a.updatePagination();a.registerListSearch();i.closest(".btn-group ").removeClass("open")},function(o,e){})}return false}})},registerEventForListViewEntries:function(){var b=this;var a=this.getPopupPageContainer();a.on("click",".listViewEntries",function(c){b.getListViewEntries(c)})},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery(".listViewEntriesTable").find("td,th");b.addClass(a)}},getPageCount:function(){var a=jQuery.Deferred();var b={mode:"getPageCount"};var c=this.getCompleteParams();jQuery.extend(c,b);AppConnector.request(c).then(function(e){var d;if(typeof e!="object"){d=JSON.parse(e)}else{d=e}a.resolve(d)},function(d,e){});return a.promise()},registerEventForTotalRecordsCount:function(){var a=this;jQuery(".totalNumberOfRecords").on("click",function(d){var b=jQuery(d.currentTarget);b.addClass("hide");b.parent().find(".pageNumbersText").progressIndicator({});var c=jQuery("#totalCount");var f=c.val();if(f==""){a.getPageCount().then(function(e){f=e.result["numberOfRecords"];var g=e.result["page"];c.val(f);jQuery("#totalPageCount").text(g);a.showPagingInfo()})}else{a.showPagingInfo()}b.parent().find(".pageNumbersText").progressIndicator({mode:"hide"})})},showPagingInfo:function(){var c=jQuery("#totalCount").val();var e=jQuery(".pageNumbersText");var d=e.text();var b=d+" ("+c+")";var a=parseInt(jQuery("#noOfEntries").val());if(a!=0){jQuery(".pageNumbersText").html(b)}else{jQuery(".pageNumbersText").html("")}},updatePagination:function(){var e=jQuery("#previousPageExist").val();var k=jQuery("#nextPageExist").val();var h=jQuery("#listViewPreviousPageButton");var f=jQuery("#listViewNextPageButton");var g=jQuery("#noOfEntries").val();var a=jQuery("#pageStartRange").val();var i=jQuery("#pageEndRange").val();var d=jQuery("#listViewPageJump");var c=jQuery("#totalPageCount").text();var b=jQuery(".totalNumberOfRecords");var j=jQuery(".pageNumbersText");if(c==1){d.attr("disabled","disabled")}if(c>1){d.removeAttr("disabled")}if(e!=""){h.removeAttr("disabled")}else{if(e==""){h.attr("disabled","disabled")}}if((k!="")&&(c>1)){f.removeAttr("disabled")}else{if((k=="")||(c==1)){f.attr("disabled","disabled")}}if(g!=0){var l=a+" ("+i+")";j.html(l);b.removeClass("hide")}else{j.html("<span>&nbsp;</span>");if(!b.hasClass("hide")){b.addClass("hide")}}},registerListSearch:function(){var b=this.getPopupPageContainer();var a=this;b.on("click",'[data-trigger="listSearch"]',function(c){jQuery("#totalPageCount").text("");a.searchHandler().then(function(d){jQuery("#pageNumber").val(1);jQuery("#pageToJump").val(1);a.updatePagination();a.registerListViewSelectSearch()})});b.on("keypress","input.listSearchContributor",function(c){if(c.keyCode==13){a.triggerListSearch()}});a.registerListViewSelectSearch();a.registerDateListSearch(b);a.registerTimeListSearch(b);if(app.getMainParams("autoRefreshListOnChange")=="1"){b.find(".listViewEntriesTable .dateField").on("DatePicker.onHide",function(d,g){var f=$(this).data("prevVal");var c=$(this).val();if(f!=c){a.triggerListSearch()}});b.find(".clockPicker").on("change",function(){a.triggerListSearch()})}},registerListViewSelectSearch:function(){var c=this;var b=c.getPopupPageContainer();var a=b.find(".listViewEntriesTable .select2noactive");var d={placeholder:app.vtranslate("JS_SELECT_AN_OPTION")};app.showSelect2ElementView(a,d);if(app.getMainParams("autoRefreshListOnChange")=="1"){a.off("change").on("change",function(f){c.triggerListSearch()})}},triggerListSearch:function(){var b=this;var a=b.getPopupPageContainer();a.find('button[data-trigger="listSearch"]').trigger("click")},registerTimeListSearch:function(a){app.registerEventForClockPicker()},registerDateListSearch:function(a){a.find(".dateField").each(function(b,c){var e=jQuery(c);var d={calendars:2,mode:"range",className:"rangeCalendar",onChange:function(f){e.val(f.join(","))}};app.registerEventForDatePickerFields(e,false,d)})},getListSearchParams:function(){var b=this.getPopupPageContainer();var a=b.find(".listViewEntriesTable");var c=new Array();a.find(".listSearchContributor").each(function(d,j){var g=new Array();var f=jQuery(j);var e=f.data("fieldinfo");var k=f.attr("name");var h=f.val();if(typeof h=="object"){if(h==null){h=""}else{h=h.join(",")}}h=h.trim();if(h.length<=0){return true}var i="a";if(e.hasOwnProperty("searchOperator")){i=e.searchOperator}else{if(jQuery.inArray(e.type,["userCreator","owner","picklist","tree","boolean","fileLocationType","userRole"])>=0){i="e"}else{if(e.type=="date"||e.type=="datetime"){i="bw"}else{if(e.type=="multipicklist"){i="c"}}}}g.push(k);g.push(i);g.push(h);c.push(g)});return new Array(c)},registerSwitchButton:function(){var b=this.getPopupPageContainer();var a=this;b.off("switchChange.bootstrapSwitch").on("switchChange.bootstrapSwitch",".switchPopup",function(c,d){var e=jQuery(c.currentTarget);if(d){app.setMainParams(e.data("field"),e.data("onVal"))}else{app.setMainParams(e.data("field"),e.data("offVal"))}a.triggerListSearch()})},registerEvents:function(){var a=jQuery("#pageNumber").val();if(a==1){jQuery("#listViewPreviousPageButton").attr("disabled","disabled")}this.setEventName(jQuery(".triggerEventName").val());var c=(jQuery(document).height())+"px";jQuery("#popupPageContainer").css("height",c);Vtiger_Helper_Js.showHorizontalTopScrollBar();this.registerEventForSelectAllInCurrentPage();this.registerSelectButton();this.registerSwitchButton();this.registerEventForCheckboxChange();this.registerEventForSort();this.registerEventForListViewEntries();this.registerListSearch();var b=jQuery("#popupPageContainer");if(b.length>0){this.registerEventForTotalRecordsCount();this.registerEventForPagination()}}});