
jQuery.Class("Vtiger_Edit_Js",{referenceSelectionEvent:"Vtiger.Reference.Selection",referenceDeSelectionEvent:"Vtiger.Reference.DeSelection",recordPreSave:"Vtiger.Record.PreSave",refrenceMultiSelectionEvent:"Vtiger.MultiReference.Selection",preReferencePopUpOpenEvent:"Vtiger.Referece.Popup.Pre",editInstance:false,SaveResultInstance:false,postReferenceSelectionEvent:"Vtiger.PostReference.Selection",getInstanceByModuleName:function(b){if(typeof b=="undefined"){b=app.getModuleName()}var e=app.getParentModuleName();if(e=="Settings"){var c=e+"_"+b+"_Edit_Js";if(typeof window[c]=="undefined"){c=b+"_Edit_Js"}var d=e+"_Vtiger_Edit_Js";if(typeof window[d]=="undefined"){d="Vtiger_Edit_Js"}}else{c=b+"_Edit_Js";d="Vtiger_Edit_Js"}if(typeof window[c]!="undefined"){var a=new window[c]()}else{var a=new window[d]()}a.moduleName=b;return a},getInstance:function(){if(Vtiger_Edit_Js.editInstance==false){var a=Vtiger_Edit_Js.getInstanceByModuleName();Vtiger_Edit_Js.editInstance=a;return a}return Vtiger_Edit_Js.editInstance}},{addressDataOG:[],addressDataGM:[],formElement:false,relationOperation:"",moduleName:app.getModuleName(),getForm:function(){if(this.formElement==false){this.setForm(jQuery("#EditView"))}return this.formElement},setForm:function(a){this.formElement=a;return this},getPopUpParams:function(b){var e={};var h=app.getModuleName();var j=jQuery('input[name="popupReferenceModule"]',b).val();var d=jQuery('input[class="sourceField"]',b);var m=d.attr("name");var c=jQuery('input[name="record"]');var a="";if(c.length>0){a=c.val()}var g=false;if(d.data("multiple")==true){g=true}var i={};var l=b.closest("form");var k=l.find('input[name="mappingRelatedField"]').val();var f=k?JSON.parse(k):[];if(f[m]!=undefined&&f[m][j]!=undefined){$.each(f[m][j],function(o,p){var n=l.find('[name="'+o+'"]');if(n.length&&n.val()!=""){i[o]=n.val()}})}var e={module:j,src_module:h,src_field:m,src_record:a,filterFields:i,};if(g){e.multi_select=true}return e},openPopUp:function(h){var c=this;var a=jQuery(h.target).closest(".fieldValue");if(a.length<=0){a=jQuery(h.target).closest("td")}var i=this.getPopUpParams(a);var f=false;if(i.multi_select){f=true}var g=jQuery('input[class="sourceField"]',a);var b=jQuery.Event(Vtiger_Edit_Js.preReferencePopUpOpenEvent);g.trigger(b);if(b.isDefaultPrevented()){return}var d=Vtiger_Popup_Js.getInstance();d.show(i,function(e){var k=JSON.parse(e);var j=new Array();for(var m in k){var l={name:k[m].name,id:m};j.push(l);if(!f){c.setReferenceFieldValue(a,l)}}if(f){g.trigger(Vtiger_Edit_Js.refrenceMultiSelectionEvent,{data:j})}g.trigger(Vtiger_Edit_Js.postReferenceSelectionEvent,{data:k})})},setReferenceFieldValue:function(a,e){var l=this;var d=a.find("input.sourceField");var k=d.attr("name");var c=a.find('input[name="'+k+'"]');var g=k+"_display";var m=a.find('input[name="'+g+'"]');var h=a.find('input[name="popupReferenceModule"]').val();var f=e.name;var b=e.id;c.val(b);m.val(f).attr("readonly",true);c.trigger(Vtiger_Edit_Js.referenceSelectionEvent,{source_module:h,record:b,selectedName:f});m.validationEngine("closePrompt",m);if(d.data("type")=="inventory"){return e}var j=a.closest("form");var i=this.getMappingRelatedField(k,h,j);if(typeof i!=undefined){var e={source_module:h,record:b};this.getRecordDetails(e).then(function(o){var n=e.data=o.result["data"];$.each(i,function(s,t){if(n[t[0]]!=0&&!l.getMappingValuesFromUrl(s)){var q=j.find('[name="'+s+'"]');if(q.is("select")){if(q.find('option[value="'+n[t[0]]+'"]').length){q.val(n[t[0]]).trigger("chosen:updated").change()}}else{if(q.length==0){$("<input type='hidden'/>").attr("name",s).attr("value",n[t[0]]).appendTo(j)}else{q.val(n[t[0]])}}var r=j.find('input[name="'+s+'_display"]');if(r.length>0){r.val(n[t[0]+"_label"]).attr("readonly",true);var p=j.find("#"+l.moduleName+"_editView_fieldName_"+s+"_dropDown");if(p.length>0&&t[1]){p.val(t[1]).change().trigger("chosen:updated")}l.setReferenceFieldValue(r.closest(".fieldValue"),{name:n[t[0]+"_label"],id:n[t[0]]})}}})})}},getRelationOperation:function(){if(this.relationOperation===""){var a=jQuery('[name="relationOperation"]');if(a.length){this.relationOperation=a.val()}else{this.relationOperation=false}}return this.relationOperation},getMappingValuesFromUrl:function(b){var a=this.getRelationOperation();if(a){return app.getUrlVar(b)}return false},proceedRegisterEvents:function(){if(jQuery(".recordEditView").length>0){return true}else{return false}},treePopupRegisterEvent:function(a){var b=this;a.on("click",".treePopup",function(c){b.openTreePopUp(c)})},registerClearTreeSelectionEvent:function(a){var b=this;a.find(".clearTreeSelection").on("click",function(c){b.clearFieldValue(jQuery(c.currentTarget));c.preventDefault()})},openTreePopUp:function(k){var l=this;var j=jQuery(k.target).closest(".fieldValue");var d=jQuery(k.target).closest("form");var g={};var b=jQuery('input[name="module"]',d).val();var f=jQuery('input[class="sourceField"]',j);var h=f.attr("name")+"_display";var m=jQuery('input[name="'+h+'"]',j);var c=jQuery('input[name="record"]');var a="";if(c.length>0){a=c.val()}urlOrParams="module="+b+"&view=TreePopup&template="+f.data("treetemplate")+"&src_field="+f.attr("name")+"&src_record="+a+"&multiple="+f.data("multiple");var i=Vtiger_Popup_Js.getInstance();i.show(urlOrParams,function(o){var n=JSON.parse(o);var e=n.id.split(",");$.each(e,function(p,q){e[p]="T"+q});e.join();f.val(e);m.val(n.name).attr("readonly",true)})},registerTreeAutoCompleteFields:function(a){var b=this;a.find("input.treeAutoComplete").autocomplete({delay:"600",minLength:"3",source:function(i,h){var m=jQuery(this.element[0]);var c=i.term;var j=m.closest(".fieldValue");var g=jQuery('input[class="sourceField"]',j);var f=g.data("allvalues");var n=new Array();for(var e in f){var d=f[e][0];if(d.toLowerCase().indexOf(c)>=0){var l=f[e][1];var k="";if(l!=""){var k="("+f[l][0]+") "}k=k+d;n.push({label:k,value:d,id:e})}}if(n.length<=0){jQuery(m).val("");n.push({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results"})}h(n)},select:function(i,j){var f=j.item;if(typeof f.type!="undefined"&&f.type=="no results"){return false}f.name=f.value;var g=jQuery(this);var c=g.closest(".fieldValue");var h=c.find('input[class="sourceField"]');var d=h.attr("name")+"_display";var e=jQuery('input[name="'+d+'"]',c);h.val(f.id);e.val(f.label).attr("readonly",true)},change:function(d,e){var c=jQuery(this)},open:function(c,d){jQuery(this).data("ui-autocomplete").menu.element.css("z-index","100001")}})},referenceModulePopupRegisterEvent:function(a){var b=this;a.on("click",".relatedPopup",function(c){b.openPopUp(c)});a.find(".referenceModulesList").chosen().change(function(h){var f=jQuery(h.currentTarget);var c=f.closest(".fieldValue");var i=f.val();var g=jQuery('input[name="popupReferenceModule"]',c);var d=g.val();g.val(i);if(d!=i){c.find(".clearReferenceSelection").trigger("click")}})},getReferencedModuleName:function(a){return jQuery('input[name="popupReferenceModule"]',a).val()},searchModuleNames:function(b){var a=jQuery.Deferred();if(typeof b.module=="undefined"){b.module=app.getModuleName()}if(typeof b.action=="undefined"){b.action="BasicAjax"}AppConnector.request(b).then(function(c){a.resolve(c)},function(c){a.reject()});return a.promise()},getReferenceSearchParams:function(b){var c=jQuery(b).closest(".fieldValue");var d={};var a=this.getReferencedModuleName(c);d.search_module=a;return d},registerAutoCompleteFields:function(a){var b=this;a.find("input.autoComplete").autocomplete({delay:"600",minLength:"3",source:function(d,c){var f=jQuery(this.element[0]);var e=d.term;var g=b.getReferenceSearchParams(f);g.search_value=e;b.searchModuleNames(g).then(function(k){var i=new Array();var j=k.result;if(j.length<=0){jQuery(f).val("");j=new Array({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results"})}for(var l in j){var h=j[l];i.push(h)}c(i)})},select:function(h,i){var c=i.item;if(typeof c.type!="undefined"&&c.type=="no results"){return false}c.name=c.value;var d=jQuery(this);var g=d.closest(".fieldValue");b.setReferenceFieldValue(g,c);var f=g.find('input[class="sourceField"]').attr("name");var e=g.find('input[name="'+f+'"]');e.trigger(Vtiger_Edit_Js.postReferenceSelectionEvent,{data:c})},change:function(d,e){var c=jQuery(this);if(c.attr("readonly")==undefined){c.closest(".fieldValue").find(".clearReferenceSelection").trigger("click")}},open:function(c,d){jQuery(this).data("ui-autocomplete").menu.element.css("z-index","100001")}})},registerClearReferenceSelectionEvent:function(a){var b=this;a.on("click",".clearReferenceSelection",function(d){var c=jQuery(d.currentTarget);b.clearFieldValue(c);c.closest(".fieldValue").find(".sourceField").trigger(Vtiger_Edit_Js.referenceDeSelectionEvent);d.preventDefault()})},clearFieldValue:function(c){var f=this;var a=c.closest(".fieldValue");var h=a.find(".sourceField");var g=h.attr("name");var e=a.find('input[name="popupReferenceModule"]').val();var d=a.closest("form");h.val("");a.find("#"+g+"_display").removeAttr("readonly").val("");var b=this.getMappingRelatedField(g,e,d);$.each(b,function(l,m){var j=d.find('[name="'+l+'"]');if(j.is("select")){j.val(j.find("option:first").val()).trigger("chosen:updated").change()}else{j.val("")}var k=d.find('input[name="'+l+'_display"]');if(k.length>0){k.val("").attr("readonly",false);var i=d.find("#"+f.moduleName+"_editView_fieldName_"+l+"_dropDown");if(i.length>0&&m[1]){i.val(i.find("option:first").val()).change().trigger("chosen:updated")}}})},registerPreventingEnterSubmitEvent:function(a){a.on("keypress",function(c){var b=jQuery(c.target);if(c.which==13&&(!b.is("textarea"))){c.preventDefault()}})},getRecordDetails:function(c){var a=jQuery.Deferred();var b="index.php?module="+app.getModuleName()+"&action=GetData&record="+c.record+"&source_module="+c.source_module;if(app.getParentModuleName()=="Settings"){b+="&parent=Settings"}AppConnector.request(b).then(function(d){if(d.success){a.resolve(d)}else{a.reject(d.message)}},function(d){a.reject()});return a.promise()},registerTimeFields:function(a){app.registerEventForClockPicker();app.registerEventForDatePickerFields(a)},referenceCreateHandler:function(a){var e=this;var h=function(i){var j={};j.name=i.result._recordLabel;j.id=i.result._recordId;e.setReferenceFieldValue(a,j)};var g={callbackFunction:h};if(app.getViewName()==="Edit"&&!app.getRecordId()){var c=this.getForm();var f=c.serializeFormData();for(var b in f){if(!f[b]||jQuery.inArray(b,["__vtrftk","action"])!=-1){delete f[b]}}g.data={};g.data.sourceRecordData=f}var d=this.getReferencedModuleName(a);Vtiger_Header_Js.getInstance().quickCreateModule(d,g)},registerReferenceCreate:function(a){var b=this;a.on("click",".createReferenceRecord",function(f){var d=jQuery(f.currentTarget);var c=d.closest(".fieldValue");b.referenceCreateHandler(c)})},addressFieldsMapping:["buildingnumber","localnumber","addresslevel1","addresslevel2","addresslevel3","addresslevel4","addresslevel5","addresslevel6","addresslevel7","addresslevel8","pobox"],addressFieldsMappingBlockID:{LBL_ADDRESS_INFORMATION:"a",LBL_ADDRESS_MAILING_INFORMATION:"b",LBL_ADDRESS_DELIVERY_INFORMATION:"c"},addressFieldsData:false,registerEventForCopyAddress:function(){var d=this;var c=this.getForm();var b=false;var e=false;var f=false;var a=false;jQuery("#EditView .blockContainer:not(.inventoryHeader):not(.inventoryItems) .fieldValue, #EditView .blockContainer:not(.inventoryHeader):not(.inventoryItems) .fieldLabel").each(function(h){var j=$(this);var g=false;var i=j.find('[name="popupReferenceModule"]').val();if(i=="Accounts"){b=j.find(".sourceField").attr("name")}if(i=="Contacts"){e=j.find(".sourceField").attr("name")}if(i=="Leads"){f=j.find(".sourceField").attr("name")}if(i=="Vendors"){a=j.find(".sourceField").attr("name")}g=j.find(".referenceModulesList");if(g.length>0){$.each(g.find("option"),function(k,l){if(l.value=="Accounts"){b=j.find(".sourceField").attr("name")}if(l.value=="Contacts"){e=j.find(".sourceField").attr("name")}if(l.value=="Leads"){f=j.find(".sourceField").attr("name")}if(l.value=="Vendors"){a=j.find(".sourceField").attr("name")}})}});if(b==false){jQuery(".copyAddressFromAccount").addClass("hide")}else{jQuery(".copyAddressFromAccount").on("click",function(j){var h=jQuery(this);var l=h.closest(".blockContainer");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+b+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_ACCOUNT_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+b+"_display").val();var i={record:k,selectedName:g,source_module:"Accounts"};d.copyAddressDetails(n,m,i,h.closest(".blockContainer"));h.attr("checked","checked")}})}if(e==false){jQuery(".copyAddressFromContact").addClass("hide")}else{jQuery(".copyAddressFromContact").on("click",function(j){var h=jQuery(this);var l=h.closest(".blockContainer");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+e+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_CONTACT_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+e+"_display").val();var i={record:k,selectedName:g,source_module:"Contacts"};d.copyAddressDetails(n,m,i,h.closest(".blockContainer"));h.attr("checked","checked")}})}if(f==false){jQuery(".copyAddressFromLead").addClass("hide")}else{jQuery(".copyAddressFromLead").on("click",function(j){var h=jQuery(this);var l=h.closest(".blockContainer");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+f+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_LEAD_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+f+"_display").val();var i={record:k,selectedName:g,source_module:"Leads"};d.copyAddressDetails(n,m,i,h.closest(".blockContainer"));h.attr("checked","checked")}})}if(a==false){jQuery(".copyAddressFromVendor").addClass("hide")}else{jQuery(".copyAddressFromVendor").on("click",function(j){var h=jQuery(this);var l=h.closest(".blockContainer");var n=h.data("label");var m=l.data("label");var k=jQuery('[name="'+a+'"]').val();if(k==""||k=="0"){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_PLEASE_SELECT_AN_VENDOR_TO_COPY_ADDRESS"))}else{var g=jQuery("#"+a+"_display").val();var i={record:k,selectedName:g,source_module:"Vendors"};d.copyAddressDetails(n,m,i,h.closest(".blockContainer"));h.attr("checked","checked")}})}$("#EditView .blockContainer").each(function(g){var h=true;$(this).find(".adressAction button").each(function(i){if($(this).hasClass("hide")==false){h=false}});if(h){$(this).find(".copyAddressLabel").addClass("hide")}});jQuery(".copyAddressFromMain").on("click",function(h){var g=jQuery(this);var i=g.closest(".blockContainer");var k=g.data("label");var j=i.data("label");d.copyAddress(k,j,false,false)});jQuery(".copyAddressFromMailing").on("click",function(h){var g=jQuery(this);var i=g.closest(".blockContainer");var k=g.data("label");var j=i.data("label");d.copyAddress(k,j,false,false)});jQuery(".copyAddressFromDelivery").on("click",function(h){var g=jQuery(this);var i=g.closest(".blockContainer");var k=g.data("label");var j=i.data("label");d.copyAddress(k,j,false,false)})},copyAddressDetails:function(h,g,f,b){var e=this;var a=f.source_module;var c=true;var d;e.getRecordDetails(f).then(function(j){var i=j.result;e.addressFieldsData=i.data;e.copyAddress(h,g,true,a)},function(i,j){})},copyAddress:function(p,f,o,e){var d=false;var i=this;var h=this.getForm();var a=this.addressFieldsMapping;var c=this.addressFieldsMappingBlockID;from=c[p];if(o===false||e===false){from=c[p]}to=c[f];for(var k in a){var l=a[k]+from;var n=a[k]+to;if(o){var g=i.addressFieldsData[l];var m=i.addressFieldsData[l+"_label"]}else{var g=h.find('[name="'+l+'"]').val();var m=h.find('[name="'+l+'_display"]').val()}var b=h.find('[name="'+n+'"]');var j=h.find('[name="'+n+'_display"]');if(g!=""&&g!="0"&&g!=undefined){if(j.length>0){j.attr("readonly",true)}d=true;b.val(g);j.val(m)}else{b.attr("readonly",false)}}if(d==false){if(e=="Accounts"){errorMsg="JS_SELECTED_ACCOUNT_DOES_NOT_HAVE_AN_ADDRESS"}else{if(e=="Contacts"){errorMsg="JS_SELECTED_CONTACT_DOES_NOT_HAVE_AN_ADDRESS"}else{errorMsg="JS_DOES_NOT_HAVE_AN_ADDRESS"}}Vtiger_Helper_Js.showPnotify(app.vtranslate(errorMsg))}},registerReferenceSelectionEvent:function(a){var c=this;var b=a.find("input[name*='addresslevel']");b.on(Vtiger_Edit_Js.referenceSelectionEvent,function(g,f){var d=jQuery(g.currentTarget).closest(".blockContainer");c.copyAddressDetailsRef(f,d)})},copyAddressDetailsRef:function(c,a){var b=this;b.getRecordDetails(c).then(function(e){var d=e.result;b.mapAddressDetails(d.data,a)},function(d,e){})},mapAddressDetails:function(a,b){for(var c in a){if(c.indexOf("addresslevel")!=-1){if(b.find('[name="'+c+'"]').length!=0){b.find('[name="'+c+'"]').val(a[c]);b.find('[name="'+c+'"]').attr("readonly",true);b.find('[name="'+c+'_display"]').val(a[c+"_label"]);b.find('[name="'+c+'_display"]').attr("readonly",true)}if(b.find('[name="'+c+'a"]').length!=0&&b.find('[name="'+c+'a"]').val()==0&&a[c]!=0){b.find('[name="'+c+'a"]').val(a[c]);b.find('[name="'+c+'a"]').attr("readonly",true);b.find('[name="'+c+'a_display"]').val(a[c+"_label"]);b.find('[name="'+c+'a_display"]').attr("readonly",true)}if(b.find('[name="'+c+'b"]').length!=0&&b.find('[name="'+c+'b"]').val()==0&&a[c]!=0){b.find('[name="'+c+'b"]').val(a[c]);b.find('[name="'+c+'b"]').attr("readonly",true);b.find('[name="'+c+'b_display"]').val(a[c+"_label"]);b.find('[name="'+c+'b_display"]').attr("readonly",true)}if(b.find('[name="'+c+'c"]').length!=0&&b.find('[name="'+c+'c"]').val()==0&&a[c]!=0){b.find('[name="'+c+'c"]').val(a[c]);b.find('[name="'+c+'c"]').attr("readonly",true);b.find('[name="'+c+'c_display"]').val(a[c+"_label"]);b.find('[name="'+c+'c_display"]').attr("readonly",true)}}}},registerMaskFields:function(a){var b=this;a.find(":input").inputmask()},registerEventForImageDelete:function(){var b=this.getForm();var a=b.find('input[name="record"]').val();b.find(".imageDelete").on("click",function(k){var i=jQuery(k.currentTarget);var l=i.closest(".fieldValue");var d=l.find('[name="imagename[]"]');var c=d.data("fieldinfo");var g=c.mandatory;var f=i.closest("div").find("img").data().imageId;i.closest("div").remove();var j=l.find('[name="existingImages"]');if(j.length<1&&g){b.validationEngine("detach");d.attr("data-validation-engine","validate[required,funcCall[Vtiger_Base_Validator_Js.invokeValidation]]");b.validationEngine("attach")}if(b.find("[name=imageid]").length!=0){var m=JSON.parse(b.find("[name=imageid]").val());m.push(f);b.find("[name=imageid]").val(JSON.stringify(m))}else{var h=[];h.push(f);b.append('<input type="hidden" name="imgDeleted" value="true" />');b.append('<input type="hidden" name="imageid" value="'+JSON.stringify(h)+'" />')}})},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery("#EditView").find(".fieldValue,.fieldLabel");b.addClass(a)}},registerSubmitEvent:function(){var a=this.getForm();a.submit(function(d){if(typeof a.data("submit")!="undefined"){return false}else{document.progressLoader=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:true}});var b=jQuery(d.currentTarget).find('[name="module"]').val();if(a.validationEngine("validate")){a.data("submit","true");var c=jQuery.Event(Vtiger_Edit_Js.recordPreSave);a.trigger(c,{value:"edit"});if(c.isDefaultPrevented()){document.progressLoader.progressIndicator({mode:"hide"});a.removeData("submit");d.preventDefault()}}else{document.progressLoader.progressIndicator({mode:"hide"});a.removeData("submit");app.formAlignmentAfterValidation(a)}}})},registerRecordPreSaveEventEvent:function(b){if(Vtiger_Edit_Js.SaveResultInstance==false){Vtiger_Edit_Js.SaveResultInstance=new SaveResult()}var a=this.getForm();var c=a.serializeFormData();if(Vtiger_Edit_Js.SaveResultInstance.recordValue==false){Vtiger_Edit_Js.SaveResultInstance.loadFormData(c)}b.on(Vtiger_Edit_Js.recordPreSave,function(f,d){if(Vtiger_Edit_Js.SaveResultInstance.checkData(b.serializeFormData(),b)==false){f.preventDefault()}})},registerEventForPicklistDependencySetup:function(a){var c=jQuery('[name="picklistDependency"]',a);if(c.length<=0){return}var d=JSON.parse(c.val());var e=Object.keys(d);if(e.length<=0){return}var g=[];for(var b=0;b<e.length;b++){g.push('[name="'+e[b]+'"]')}g=g.join(",");var f=a.find(g);f.on("change",function(n){var l=jQuery(n.currentTarget);var k=l.attr("name");var j=d[k];var m=l.val();var i=j[m];var h=j.__DEFAULT__;if(typeof i=="undefined"){i=h}jQuery.each(h,function(u,w){var p=i[u];if(typeof p=="undefined"){p=w}var v=jQuery('[name="'+u+'"]',a);if(v.length<=0){return}var o=v.data("availableOptions");if(typeof o=="undefined"){o=jQuery("option",v);v.data("available-options",o)}var s=new jQuery();var q=[];q.push("");for(var t=0;t<p.length;t++){q.push(p[t])}jQuery.each(o,function(x,z){var y=jQuery(z).val();if(jQuery.inArray(y,q)!=-1){s=s.add(jQuery(z))}});var r="";var r=s.filter("[selected]").val();v.html(s).val(r).trigger("chosen:updated")})});f.trigger("change")},registerLeavePageWithoutSubmit:function(a){InitialFormData=a.serialize();window.onbeforeunload=function(b){if(InitialFormData!=a.serialize()&&a.data("submit")!="true"){return app.vtranslate("JS_CHANGES_WILL_BE_LOST")}}},stretchCKEditor:function(){var a=jQuery(".ckEditorSource").parents(".fieldRow");var b=jQuery(".ckEditorSource").parent();jQuery(a).find(".fieldLabel").remove();jQuery(b).removeClass("col-md-10");jQuery(b).addClass("col-md-12")},registerEventForCkEditor:function(){var b=this.getForm();var a=this;$.each(b.find(".ckEditorSource"),function(c,d){a.loadCkEditorElement(jQuery(d))})},loadCkEditorElement:function(c){var a={};if(c.is(":visible")){if(c.hasClass("ckEditorBasic")){a.toolbar="Min"}if(c.hasClass("ckEditorSmall")){a.height="5em"}var b=new Vtiger_CkEditor_Js();b.loadCkEditor(c,a)}},registerHelpInfo:function(){var a=this.getForm();app.showPopoverElementView(a.find(".HelpInfoPopover"))},registerBlockAnimationEvent:function(){var b=this;var a=this.getForm();a.on("click",".blockHeader",function(i){if(jQuery(i.target).is("input")||jQuery(i.target).is("button")||jQuery(i.target).parents().is("button")){return false}var d=jQuery(i.currentTarget).find(".blockToggle").not(".hide");var g=d.data("id");var j=d.closest(".blockContainer");var c=j.find(".blockContent");var h=d.data();var f=app.getModuleName();var k=function(){c.addClass("hide");app.cacheSet(f+"."+g,0)};var l=function(){c.removeClass("hide");b.registerEventForCkEditor(c);app.cacheSet(f+"."+g,1)};if(h.mode=="show"){k();d.addClass("hide");j.find('[data-mode="hide"]').removeClass("hide")}else{l();d.addClass("hide");j.find("[data-mode='show']").removeClass("hide")}})},registerBlockStatusCheckOnLoad:function(){var b=this.getForm().find(".blockContainer");var a=app.getModuleName();b.each(function(d,j){var g=jQuery(j);var f=g.find(".blockToggle").not(".hide");var i=g.find(".blockContent");var c=f.data("id");var h=a+"."+c;var e=app.cacheGet(h,null);if(e!=null){if(e==1){f.addClass("hide");g.find("[data-mode='show']").removeClass("hide");i.removeClass("hide")}else{f.addClass("hide");g.find("[data-mode='hide']").removeClass("hide");i.addClass("hide")}}})},getDataFromOG:function(c,b){var a=this;if(b.opencage_data){return jQuery.ajax({url:b.opencage_data.geoCodeURL,data:{format:"json",q:c.term,pretty:"1",key:b.opencage_data.geoCodeKey},success:function(e,f,d){if(e.results.length){a.addressDataOG=jQuery.map(e.results,function(g){return{label:g.formatted,source:"opencage_geocoder",source_label:"OpenCage Geocoder",value:g.components.road,components:g.components}})}}})}return[]},getDataFromGM:function(c,b){var a=this;if(b.google_map_api){return jQuery.ajax({url:b.google_map_api.geoCodeURL,data:{address:c.term,key:b.google_map_api.geoCodeKey},success:function(e){if(0<e.results.length){var d=e.results[0].geometry.location;jQuery.ajax({url:b.google_map_api.geoCodeURL,data:{latlng:d.lat+","+d.lng,key:b.google_map_api.geoCodeKey},success:function(g,h,f){a.addressDataGM=jQuery.map(g.results,function(i){return{label:i.formatted_address,source:"google_geocoding",source_label:"Google Geocoding",value:i.formatted_address,components:a.mappingAddressDataFromGoogle(i.address_components)}})}})}}})}return[]},mappingAddressDataFromGoogle:function(b){var f={};for(var d in b){var c=b[d]["types"];if("route"===c[0]){f.road=b[d]["long_name"]}if("street_number"===c[0]){var a=b[d]["long_name"];if(a.indexOf("/">-1)){var e=a.split("/");f.house_number=e[0];f.local_number=e[1]}else{f.house_number=b[d]["long_name"]}}if("country"===c[0]&&"political"===c[1]){f.country=b[d]["long_name"]}if("administrative_area_level_1"===c[0]&&"political"===c[1]){f.state=b[d]["long_name"]}if("administrative_area_level_2"===c[0]&&"political"===c[1]){f.powiat=b[d]["long_name"]}if("sublocality_level_1"===c[0]&&"sublocality"===c[1]&&"political"===c[2]){f.region_city=b[d]["long_name"]}if("postal_code"===c[0]){f.postcode=b[d]["long_name"]}if("locality"===c[0]&&"political"===c[1]){f.city=b[d]["long_name"]}}return f},registerApiAddress:function(){var b=this;var c=jQuery('[name="apiAddress"]');var a=[];jQuery(c).each(function(e,f){var d=jQuery(f).data("api-name");var g={geoCodeURL:jQuery(f).data("url"),geoCodeKey:jQuery(f).val()};a[d]=g;a.minLookupLenght=jQuery(f).data("lenght");a.max_num=jQuery(f).data("max-num")});if(!a){return false}jQuery(".api_address_autocomplete").each(function(){jQuery(this).autocomplete({source:function(e,d){jQuery.when(b.getDataFromOG(e,a),b.getDataFromGM(e,a)).then(function(h,g){var f=b.addressDataOG.concat(b.addressDataGM);d(f.slice(0,a.max_num))}).fail(function(f){d([{label:app.vtranslate("An error has occurred. No results."),value:""}])})},minLength:a.minLookupLenght,select:function(f,g){for(var e in g.item.components){var d=b.addressFieldsMappingFromApi[e];jQuery(this).parents(".blockContainer").find('[name^="'+d+'"]').val(g.item.components[e])}}}).data("ui-autocomplete")._renderItem=function(d,e){return jQuery("<li>").data("item.autocomplete",e).append('<a><img style="width: 24px; height: 24px;" class="alignMiddle" src="layouts/basic/skins/images/'+e.source+'.png" title="'+e.source_label+'" alt="'+e.source_label+'">'+e.label+"</a>").appendTo(d)}})},addressFieldsMappingFromApi:{house_number:"buildingnumber",local_number:"localnumber",country:"addresslevel1",state:"addresslevel2",powiat:"addresslevel3",county:"addresslevel4",city:"addresslevel5",region_city:"addresslevel6",postcode:"addresslevel7",road:"addresslevel8",village:"addresslevel5"},setEnabledFields:function(a){var b=a.closest(".fieldValue");var e=b.find("input.sourceField").attr("name");var d=b.find("#"+e+"_display");b.find("button").removeAttr("disabled");if(d.val()==""){b.find("input").removeAttr("readonly")}b.find(".referenceModulesListGroup").removeClass("hide");var c=d.attr("placeholderDisabled");d.removeAttr("placeholderDisabled");d.attr("placeholder",c);b.find(".referenceModulesList").attr("required","required")},setDisabledFields:function(a){var b=a.closest(".fieldValue");var e=b.find("input.sourceField").attr("name");var d=b.find("#"+e+"_display");b.find("input").attr("readonly","readonly");b.find("button").attr("disabled","disabled");b.find(".referenceModulesListGroup").addClass("hide");var c=d.attr("placeholder");d.removeAttr("placeholder");d.attr("placeholderDisabled",c);b.find(".referenceModulesList").removeAttr("required")},getMappingRelatedField:function(e,a,b){var c=b.find('input[name="mappingRelatedField"]').val();var d=c?JSON.parse(c):[];if(typeof d[e]!="undefined"&&typeof d[e][a]!="undefined"){return d[e][a]}return[]},registerValidationsFields:function(a){var b=this;var c=app.validationEngineOptionsForRecord;a.validationEngine(c)},checkReferencesField:function(c,a){var d=this;var b=false,e=false;c.find('input[data-fieldtype="referenceLink"]').each(function(g,i){i=$(i);var h=true;if(i.closest(".tab-pane").length>0){h=false;if(i.closest(".tab-pane.active").length>0){h=true}}var f=i.val();if(h&&f!=""&&f!="0"){b=true}});c.find('input[data-fieldtype="referenceProcess"]').each(function(g,i){i=$(i);if(b){d.setEnabledFields(i)}else{if(a){d.clearFieldValue(i)}d.setDisabledFields(i)}var h=true;if(i.closest(".tab-pane").length>0){h=false;if(i.closest(".tab-pane.active").length>0){h=true}}var f=i.val();if(h&&f!=""&&f!="0"){e=true}});c.find('input[data-fieldtype="referenceSubProcess"]').each(function(g,h){h=$(h);var f=h.closest(".fieldValue");var i=f.find('.referenceModulesList option[disabled!="disabled"]').length;if(e&&i>0){d.setEnabledFields(h)}else{if(a){d.clearFieldValue(h)}d.setDisabledFields(h)}})},checkSubProcessModulesList:function(a){var b=a.find("option:selected");if(b.data("is-quickcreate")!=1){a.closest(".fieldValue").find(".createReferenceRecord").addClass("hide")}else{a.closest(".fieldValue").find(".createReferenceRecord").removeClass("hide")}},checkReferenceModulesList:function(a){var d=this;var b=a.find('input[data-fieldtype="referenceProcess"]').closest(".fieldValue");var c=b.find('input[name="popupReferenceModule"]').val();var e=a.find('input[data-fieldtype="referenceSubProcess"]').closest(".fieldValue");Vtiger_Helper_Js.hideOptions(e.find(".referenceModulesList"),"parent",c);var f=e.find(".referenceModulesList").val();e.find('[name="popupReferenceModule"]').val(f);d.checkSubProcessModulesList(e.find(".referenceModulesList"))},registerReferenceFields:function(a){var b=this;b.checkReferenceModulesList(a);b.checkReferencesField(a,false);a.find(".sourceField").on(Vtiger_Edit_Js.referenceSelectionEvent,function(d,c){b.checkReferencesField(a,true)});a.find(".sourceField").on(Vtiger_Edit_Js.referenceDeSelectionEvent,function(c){b.checkReferencesField(a,true)});a.find('input[data-fieldtype="referenceProcess"]').closest(".fieldValue").find(".referenceModulesList").on("change",function(){b.checkReferenceModulesList(a)});a.find('input[data-fieldtype="referenceSubProcess"]').closest(".fieldValue").find(".referenceModulesList").on("change",function(c){b.checkSubProcessModulesList($(c.currentTarget))})},registerFocusFirstField:function(a){var b=this;a.find(".fieldValue input.form-control:not([type=hidden],[type=checkbox])").each(function(g,f){var d=jQuery(f);if(!d.prop("readonly")&&!d.prop("disabled")){d=d.get(0);var c=d.value.length;d.selectionStart=c;d.selectionEnd=c;d.focus();return false}})},registerBasicEvents:function(a){this.treePopupRegisterEvent(a);this.registerClearTreeSelectionEvent(a);this.registerTreeAutoCompleteFields(a);this.referenceModulePopupRegisterEvent(a);this.registerAutoCompleteFields(a);this.registerClearReferenceSelectionEvent(a);this.registerPreventingEnterSubmitEvent(a);this.registerTimeFields(a);this.registerEventForPicklistDependencySetup(a);this.registerRecordPreSaveEventEvent(a);this.registerReferenceSelectionEvent(a);this.registerMaskFields(a);this.registerHelpInfo();this.registerReferenceFields(a);this.registerFocusFirstField(a)},registerEvents:function(){var b=this.getForm();var a=this.proceedRegisterEvents();if(!a){return}this.registerBlockAnimationEvent();this.registerBlockStatusCheckOnLoad();this.registerEventForCkEditor();this.stretchCKEditor();this.registerBasicEvents(b);this.registerEventForCopyAddress();this.registerEventForImageDelete();this.registerSubmitEvent();this.registerLeavePageWithoutSubmit(b);this.registerValidationsFields(b);this.registerReferenceCreate(b);this.registerApiAddress()}});