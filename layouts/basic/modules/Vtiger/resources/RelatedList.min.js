
jQuery.Class("Vtiger_RelatedList_Js",{},{selectedRelatedTabElement:false,parentRecordId:false,parentModuleName:false,relatedModulename:false,relatedTabsContainer:false,detailViewContainer:false,relatedContentContainer:false,listSearchInstance:false,setSelectedTabElement:function(a){this.selectedRelatedTabElement=a},getSelectedTabElement:function(){return this.selectedRelatedTabElement},getParentId:function(){return this.parentRecordId},getRelatedContainer:function(){return this.relatedContentContainer},loadRelatedList:function(f){var b=jQuery.Deferred();var c=this;if(typeof this.relatedModulename=="undefined"||this.relatedModulename.length<=0){return}var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d=this.getCompleteParams();var a=c.relatedTabsContainer.find("li.active").data("reference");jQuery.extend(d,f);AppConnector.request(d).then(function(g){e.progressIndicator({mode:"hide"});var h=Vtiger_Detail_Js.getInstance();h.loadWidgets();if(a!="ProductsAndServices"){c.relatedTabsContainer.find("li").removeClass("active");c.selectedRelatedTabElement.addClass("active");c.relatedContentContainer.html(g);g=c.relatedContentContainer.html();Vtiger_Helper_Js.showHorizontalTopScrollBar();jQuery(".pageNumbers",c.relatedContentContainer).tooltip();jQuery("body").trigger(jQuery.Event("LoadRelatedRecordList.PostLoad"),{response:g,params:d});app.showBtnSwitch(jQuery("body").find(".switchBtn"));c.registerUnreviewedCountEvent();if(c.listSearchInstance){c.listSearchInstance.registerBasicEvents()}}b.resolve(g)},function(h,g){b.reject(h,g)});return b.promise()},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery(".listViewEntriesTable").find("td,th");b.attr("class",a)}},showSelectRelationPopup:function(a){var b=jQuery.Deferred();var d=this;var e=Vtiger_Popup_Js.getInstance();var c=this.getPopupParams();$.extend(c,a);e.show(c,function(g){var f=JSON.parse(g);var h=Object.keys(f);d.addRelations(h).then(function(l){var j=d.getSelectedTabElement();if(j.data("link-key")=="LBL_RECORD_SUMMARY"){var k=Vtiger_Detail_Js.getInstance();k.loadWidgets()}else{var i=d.getCurrentPageNum();var m={page:i};d.loadRelatedList(m).then(function(n){b.resolve(n)})}})});return b.promise()},addRelations:function(c){var a=jQuery.Deferred();var d=this.parentRecordId;var b=this.parentModuleName;var f=this.relatedModulename;var e={};e.mode="addRelation";e.module=b;e.action="RelationAjax";e.related_module=f;e.src_record=d;e.related_record_list=JSON.stringify(c);AppConnector.request(e).then(function(h){var g=Vtiger_Detail_Js.getInstance();g.registerRelatedModulesRecordCount();a.resolve(h)},function(h,g){a.reject(h,g)});return a.promise()},getPopupParams:function(){var a={};var a={module:this.relatedModulename,src_module:this.parentModuleName,src_record:this.parentRecordId,multi_select:true};return a},deleteRelation:function(b){var a=jQuery.Deferred();var c={};c.mode="deleteRelation";c.module=this.parentModuleName;c.action="RelationAjax";c.related_module=this.relatedModulename;c.src_record=this.parentRecordId;c.related_record_list=JSON.stringify(b);AppConnector.request(c).then(function(e){var d=Vtiger_Detail_Js.getInstance();d.registerRelatedModulesRecordCount();a.resolve(e)},function(e,d){a.reject(e,d)});return a.promise()},getCurrentPageNum:function(){return jQuery('input[name="currentPageNum"]',this.relatedContentContainer).val()},setCurrentPageNumber:function(a){jQuery('input[name="currentPageNum"]').val(a)},getOrderBy:function(){return jQuery("#orderBy").val()},getSortOrder:function(){return jQuery("#sortOrder").val()},getCompleteParams:function(){var c={view:"Detail",module:this.parentModuleName,record:this.getParentId(),relatedModule:this.relatedModulename,sortorder:this.getSortOrder(),orderby:this.getOrderBy(),page:this.getCurrentPageNum(),mode:"showRelatedList"};if($(".pagination").length){c.totalCount=$(".pagination").data("totalCount")}if(this.relatedModulename=="Calendar"){if(this.relatedContentContainer.find(".switchBtn").is(":checked")){c.time="current"}else{c.time="history"}}if(this.listSearchInstance){var b=this.listSearchInstance.getAlphabetSearchValue();c.search_params=JSON.stringify(this.listSearchInstance.getListSearchParams())}if((typeof b!="undefined")&&(b.length>0)){c.search_key=this.listSearchInstance.getAlphabetSearchField();c.search_value=b;c.operator="s"}if(this.relatedModulename=="Calendar"){var a=this.getRelatedContainer().find(".switchBtn");if(a.length){c.time=a.prop("checked")?"current":"history"}}return c},sortHandler:function(c){var b=jQuery.Deferred();var e=c.data("fieldname");var a=c.data("nextsortorderval");var d={orderby:e,sortorder:a,tab_label:this.selectedRelatedTabElement.data("label-key")};this.loadRelatedList(d).then(function(f){b.resolve(f)},function(g,f){b.reject(g,f)});return b.promise()},nextPageHandler:function(){var d=jQuery.Deferred();var e=this;var f=jQuery("#pageLimit").val();var g=jQuery("#noOfEntries").val();if(g==f){var c=this.getCurrentPageNum();var b=parseInt(c)+1;var a={page:b};this.loadRelatedList(a).then(function(h){e.setCurrentPageNumber(b);d.resolve(h)},function(i,h){d.reject(i,h)})}return d.promise()},previousPageHandler:function(){var c=jQuery.Deferred();var d=this;var c=jQuery.Deferred();var a=this.getCurrentPageNum();if(a>1){var b=parseInt(a)-1;var e={page:b};this.loadRelatedList(e).then(function(f){d.setCurrentPageNumber(b);c.resolve(f)},function(g,f){c.reject(g,f)})}return c.promise()},selectPageHandler:function(a){var b=jQuery.Deferred();var d=this;var b=jQuery.Deferred();var c={page:a,};if(this.relatedModulename=="Calendar"){var e=jQuery(".switchBtn").is(":checked");if(e){c.time="current"}else{c.time="history"}}this.loadRelatedList(c).then(function(f){d.setCurrentPageNumber(a);b.resolve(f)},function(g,f){b.reject(g,f)});return b.promise()},pageJumpHandler:function(k){var j=jQuery.Deferred();var n=this;if(k.which==13){var f=jQuery(k.currentTarget);var c=Vtiger_WholeNumberGreaterThanZero_Validator_Js.invokeValidation(f);if(typeof c!="undefined"){f.validationEngine("showPrompt",c,"","topLeft",true);k.preventDefault()}else{f.validationEngine("hideAll");var d=parseInt(f.val());var i=parseInt(jQuery("#totalPageCount").text());if(d>i){var m=app.vtranslate("JS_PAGE_NOT_EXIST");f.validationEngine("showPrompt",m,"","topLeft",true)}var l=f.parent().find(".formError");if(l.length<1){var h=jQuery('input[name="currentPageNum"]').val();if(d==h){var o=app.vtranslate("JS_YOU_ARE_IN_PAGE_NUMBER")+" "+d;var b={text:o,type:"info"};Vtiger_Helper_Js.showMessage(b);k.preventDefault();return false}var g={page:d};if(this.relatedModulename=="Calendar"){var a=jQuery(".switchBtn").is(":checked");if(a){g.time="current"}else{g.time="history"}}this.loadRelatedList(g).then(function(e){n.setCurrentPageNumber(d);j.resolve(e)},function(p,e){j.reject(p,e)})}else{k.preventDefault()}}}return j.promise()},addRelatedRecord:function(d,i){var h=jQuery.Deferred();var l=this;var b=this.relatedModulename;var r=this.getParentId();var o=this.parentModuleName;var f={};var e={};var s=d.data("name");var m=d.data("url");e[s]=r;var k=new Array("view","module","mode","action");var n=function(y){var v,w,A;if(typeof m!="undefined"&&m.indexOf("?")!==-1){var x=m.split("?");var B=x[1];var u=B.split("&");for(v=0;v<u.length;v++){w=u[v];A=w.split("=");if(A[0]=="mode"&&A[1]=="Calendar"){y.find('a[data-tab-name="Task"]').trigger("click")}}}jQuery('<input type="hidden" name="sourceModule" value="'+o+'" />').appendTo(y);jQuery('<input type="hidden" name="sourceRecord" value="'+r+'" />').appendTo(y);jQuery('<input type="hidden" name="relationOperation" value="true" />').appendTo(y);if(typeof s!="undefined"){var z=y.find('[name="'+s+'"]');if(z.length==0){jQuery('<input type="hidden" name="'+s+'" value="'+r+'" />').appendTo(y)}}for(v=0;v<u.length;v++){w=u[v];A=w.split("=");if(jQuery.inArray(A[0],k)=="-1"&&y.find('[name="'+A[0]+'"]').length==0){jQuery('<input type="hidden" name="'+A[0]+'" value="'+A[1]+'" />').appendTo(y)}}if(typeof i!=="undefined"){i()}};var t=function(u){l.loadRelatedList().then(function(v){h.resolve(v)})};if(typeof m!="undefined"&&m.indexOf("?")!==-1){var q=m.split("?");var g=q[1];var p=g.split("&");for(var j=0;j<p.length;j++){var a=p[j];var c=a.split("=");if(jQuery.inArray(c[0],k)=="-1"){e[c[0]]=c[1]}}}f.data=e;f.callbackFunction=t;f.callbackPostShown=n;f.noCache=true;Vtiger_Header_Js.getInstance().quickCreateModule(b,f);return h.promise()},getRelatedPageCount:function(){var b=jQuery.Deferred();var e={};e.action="RelationAjax";e.module=this.parentModuleName;e.record=this.getParentId(),e.relatedModule=this.relatedModulename,e.tab_label=this.selectedRelatedTabElement.data("label-key");e.mode="getRelatedListPageCount";var c=jQuery("#totalPageCount");var d=jQuery("#totalCount");var a=c.text();if(a==""){c.progressIndicator({});AppConnector.request(e).then(function(h){var g=h.result["page"];var f=h.result["numberOfRecords"];d.val(f);c.text(g);c.progressIndicator({mode:"hide"});b.resolve()},function(f,g){})}else{b.resolve()}return b.promise()},addFollowupEvent:function(f){var d=jQuery(f.currentTarget);var b=d.closest("tr").data("id");var a="index.php?module=Calendar&view=QuickCreateFollowupAjax&record="+b;var c=jQuery.progressIndicator({});AppConnector.request(a).then(function(e){if(e){c.hide();app.showModalWindow(e,function(h){var g=h.find("form.followupCreateView");g.validationEngine(app.validationEngineOptions);app.registerEventForTimeFields(g);g.submit(function(i){var r=jQuery(this).find("button.btn-success");r.attr("disabled","disabled");c=jQuery.progressIndicator({});i.preventDefault();var t=g.validationEngine("validate");if(!t){r.removeAttr("disabled");c.hide();return false}var j=jQuery(this).find("[name='module']").val();var k=jQuery(this).find("[name='record']").val();var q=jQuery(this).find("[name='followup_date_start']").val();var p=jQuery(this).find("[name='followup_time_start']").val();var m=jQuery(this).find("[name='action']").val();var o=jQuery(this).find("[name='mode']").val();var s=jQuery(this).find("[name='defaultCallDuration']").val();var n=jQuery(this).find("[name='defaultOtherEventDuration']").val();var l={module:j,action:m,mode:o,record:k,followup_date_start:q,followup_time_start:p,defaultCallDuration:s,defaultOtherEventDuration:n};AppConnector.request(l).then(function(u){app.hideModalWindow();c.hide();if(u.result.created){Vtiger_Detail_Js.reloadRelatedList()}})})})}else{c.hide();Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION","Calendar"))}})},markAsCompleted:function(d){var c=jQuery(d.currentTarget);var a=c.closest("tr").data("id");var b=app.vtranslate("JS_CONFIRM_MARK_AS_HELD");Vtiger_Helper_Js.showConfirmationBox({message:b}).then(function(f){var g={module:"Calendar",action:"SaveFollowupAjax",mode:"markAsHeldCompleted",record:a};AppConnector.request(g).then(function(e){if(e.error){var h={text:app.vtranslate("JS_PERMISSION_DENIED")};Vtiger_Helper_Js.showPnotify(h)}else{if(e.result.valid&&e.result.markedascompleted){Vtiger_Detail_Js.reloadRelatedList();if(e.result.activitytype=="Task"){var h={text:app.vtranslate("JS_TODO_MARKED_AS_COMPLETED")}}else{var h={text:app.vtranslate("JS_EVENT_MARKED_AS_HELD")}}Vtiger_Helper_Js.showMessage(h)}else{var h={text:app.vtranslate("JS_FUTURE_EVENT_CANNOT_BE_MARKED_AS_HELD")};Vtiger_Helper_Js.showPnotify(h)}}})},function(e,f){return false})},favoritesRelation:function(c,b){var a=jQuery.Deferred();var d={};d.action="RelationAjax";d.module=this.parentModuleName;d.record=this.getParentId();d.relcrmid=c;d.relatedModule=this.relatedModulename;d.mode="updateFavoriteForRecord";d.actionMode=b?"delete":"add";if(c){AppConnector.request(d).then(function(e){if(e.result){a.resolve(true)}},function(e,f){})}else{a.reject(false)}return a.promise()},registerUnreviewedCountEvent:function(a){var f=this;var e=[];var d=a==undefined?this.relatedContentContainer:a;var c=d.find(".unreviewed").length;d.find("tr.listViewEntries").each(function(){var g=jQuery(this).data("id");if(g){e.push(g)}});if(!e||c<1){return}var b={action:"ChangesReviewedOn",mode:"getUnreviewed",module:"ModTracker",sourceModule:this.relatedModulename,recordsId:e};AppConnector.request(b).then(function(h){var j=h.result;for(var g in j){if(j[g]>0){d.find('tr[data-id="'+g+'"] .unreviewed .badge').text(j[g])}}})},init:function(d,b,a,c){this.selectedRelatedTabElement=a,this.parentRecordId=d;this.parentModuleName=b;this.relatedModulename=c;this.relatedTabsContainer=a.closest("div.related");this.detailViewContainer=this.relatedTabsContainer.closest("div.detailViewContainer");this.relatedContentContainer=jQuery("div.contents",this.detailViewContainer);Vtiger_Helper_Js.showHorizontalTopScrollBar();app.showPopoverElementView(this.relatedContentContainer.find(".popoverTooltip"));this.listSearchInstance=YetiForce_ListSearch_Js.getInstance(this.relatedContentContainer)}});