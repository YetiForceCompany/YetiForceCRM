
var Vtiger_Index_Js={showLocation:function(a){app.showModalWindow(null,"index.php?module=OpenStreetMap&view=MapModal",function(b){var c=new OpenStreetMap_Map_Js();c.registerModalView(b);b.find(".searchValue").val(a);b.find(".searchBtn").trigger("click")})},massAddDocuments:function(a){app.showModalWindow(null,a,function(b){var c=b.find("#filesToUpload");var d=b.find(".fileContainer");var f=b.find(".uploadFileContainer");var e=b.find("form");c.change(function(){f.find(".fileItem").remove();var h=c[0].files;for(var g=0;g<h.length;g++){f.append(d.html());f.find('[name="nameFile[]"]:last').val(h[g].name)}});e.submit(function(i){i.preventDefault();var h=new FormData(e[0]);if(h){a="index.php";if(app.getViewName()==="Detail"){h.append("createmode","link");h.append("return_module",app.getModuleName());h.append("return_id",app.getRecordId())}var j={url:a,type:"POST",data:h,processData:false,contentType:false};var g=jQuery.progressIndicator({blockInfo:{enabled:true}});AppConnector.request(j).then(function(m){g.progressIndicator({mode:"hide"});app.hideModalWindow();if(app.getViewName()==="Detail"){var l=Vtiger_Detail_Js.getInstance();if(l.getSelectedTab().data("reference")==="Documents"){l.reloadTabContent()}else{var k=l.getContentHolder().find("[data-type='RelatedModule'][data-name='Documents']");if(k.length>0){var n=l.getFiltersData(k);l.loadWidget(k,n.params)}}}else{Vtiger_List_Js.getInstance().getListViewRecords()}})}})})},getEmailFromRecord:function(a,c,d){var b=jQuery.Deferred();AppConnector.request({dataType:"html",data:{module:"OSSMail",action:"GetMail",sourceModule:c,sourceRecord:a,maxEmails:d,}}).then(function(e){if(e.substring(0,1)=="{"){e=$.parseJSON(e);e=e.result;b.resolve(e)}else{app.showModalWindow(e,function(f){f.find(".selectButton").click(function(h){var g=f.find("input:checked").val();app.hideModalWindow(f);b.resolve(g)})})}},function(e,f){b.reject(e)});return b.promise()},registerMailButtons:function(a){var b=this;a.find(".sendMailBtn:not(.mailBtnActive)").each(function(d){var c=jQuery(this);c.addClass("mailBtnActive");c.click(function(k){k.stopPropagation();var i=c.data("url");var j=c.data("module");var h=c.data("record");var g=c.data("popup");var f=c.data("to");if(f){i+="&to="+f}b.sendMailWindow(i,g)})})},sendMailWindow:function(b,c,f){if(c){var e=screen.width-15;var l=screen.height-150;var g=0;var k=30;var a="width="+e+", height="+l+", left="+g+", top="+k;if(f==undefined){window.open(b,"_blank",a+",resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,status=nomenubar=no");return}var d=$("<form/>",{action:"index.php"});var h=b.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(i,n,o){d.append($("<input>",{name:n,value:o}))});for(var j in f){d.append($("<input>",{name:j,value:JSON.stringify(f[j])}))}$("body").append(d);d.submit()}else{window.location.href=b}},registerWidgetsEvents:function(){var a=jQuery("div.widgetContainer");a.on("shown.bs.collapse",function(d){var c=jQuery(d.currentTarget);Vtiger_Index_Js.loadWidgets(c);var b=c.attr("id");app.cacheSet(b,1)});a.on("hidden.bs.collapse",function(g){var d=jQuery(g.currentTarget);var f=d.parent().find(".imageElement");var b=f.data("rightimage");f.attr("src",b);var c=d.attr("id");app.cacheSet(c,0)})},loadWidgets:function(e,c){var d=jQuery(".loadingWidgetMsg").html();if(e.find(".panel-body").html().trim()){var f=e.parent().find(".imageElement");var a=f.data("downimage");f.attr("src",a);e.css("height","auto");return}e.progressIndicator({message:d});var b=e.data("url");var g={type:"GET",url:"index.php",dataType:"html",data:b};AppConnector.request(g).then(function(k){if(typeof c=="undefined"){c=true}if(c){e.progressIndicator({mode:"hide"});var j=e.parent().find(".imageElement");var h=j.data("downimage");j.attr("src",h);e.css("height","auto")}e.html(k);if(k==""){e.closest(".quickWidget").addClass("hide")}else{var i=e.closest(".quickWidget").find(".quickWidgetHeader").data("label")}jQuery(".bodyContents").trigger("Vtiger.Widget.Load."+i,jQuery(e))})},loadWidgetsOnLoad:function(){var a=jQuery("div.widgetContainer");a.each(function(b,c){Vtiger_Index_Js.loadWidgets(jQuery(c))})},changeSkin:function(){jQuery(".themeElement").on("click",function(b){b.stopPropagation();var a=jQuery(b.currentTarget);a.closest("#themeContainer").hide();var d=jQuery("#progressDiv");d.progressIndicator();var c={module:"Users",action:"SaveAjax",record:jQuery("#current_user_id").val(),field:"theme",value:a.data("skinName")};AppConnector.request(c).then(function(e){if(e.success&&e.result){d.progressIndicator({mode:"hide"});jQuery(".settingIcons").removeClass("open");window.location.reload()}},function(e,f){})})},registerCheckNotifications:function(f){var e=this;var d=jQuery(".notificationsNotice.autoRefreshing");if(d.length<1){return false}var a=parseInt(app.getMainParams("intervalForNotificationNumberCheck"))*1000;var c=new Date().getTime();var b=app.cacheGet("NotificationsNextCheckTime",0);if((c-a)>b){Vtiger_Index_Js.requestNotification();var c=new Date().getTime();app.cacheSet("NotificationsNextCheckTime",(c+a))}else{e.setNotification(app.cacheGet("NotificationsData",0))}if(f!==false){setTimeout("Vtiger_Index_Js.registerCheckNotifications()",a)}},requestNotification:function(){var a=this;AppConnector.request({async:false,dataType:"json",data:{module:"Notification",action:"Notification",mode:"getNumberOfNotifications"}}).then(function(b){var c=b.result;app.cacheSet("NotificationsData",c);a.setNotification(c)})},setNotification:function(b){var a=$(".notificationsNotice .badge");a.text(b);a.removeClass("hide");if(b>0){$(".notificationsNotice .isBadge").effect("pulsate",1500)}else{a.addClass("hide")}},markNotifications:function(c){var a=this;var b={module:"Notification",action:"Notification",mode:"setMark",ids:c};AppConnector.request(b).then(function(d){var e=$('.notificationEntries .noticeRow[data-id="'+c+'"]');Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_MARKED_AS_READ"),type:"info"});if(d.result){e.fadeOut(300,function(){var f=e.closest(".notificationEntries");e.remove();f.each(function(g){var h=$(this);if(h.find(".noticeRow").length==0){h.closest(".panel").hide()}})})}app.cacheSet("NotificationsNextCheckTime",0);Vtiger_Index_Js.registerCheckNotifications(false)})},markAllNotifications:function(b){var c=[];var a=$(b).closest(".notificationContainer");a.find(".notificationEntries .noticeRow").each(function(e){c.push($(this).data("id"))});if(c.length==0){b.remove();return false}var d={module:"Notification",action:"Notification",mode:"setMark",ids:c};a.progressIndicator({position:"html"});AppConnector.request(d).then(function(e){a.progressIndicator({mode:"hide"});Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_MARKED_AS_READ"),type:"info"});app.cacheSet("NotificationsNextCheckTime",0);Vtiger_Index_Js.registerCheckNotifications(false)})},registerActivityReminder:function(){var a=(parseInt(app.getMainParams("activityReminder"))||0)*1000;if(a!=0&&jQuery(".remindersNotice.autoRefreshing").length){Vtiger_Index_Js.requestReminder();window.reminder=setInterval(function(){Vtiger_Index_Js.requestReminder()},a)}},requestReminder:function(){var c=this;var b=$(".remindersNoticeContainer");var a="index.php?module=Calendar&view=Reminders&type_remainder=true";AppConnector.request(a).then(function(d){b.html(d);c.refreshNumberNotifications(b);app.registerModal(b);b.find(".reminderPostpone").on("click",function(i){var h=jQuery(i.currentTarget);var g=h.closest(".panel").data("record");var f="index.php?module=Calendar&action=ActivityReminder&mode=postpone&record="+g+"&time="+h.data("time");AppConnector.request(f).then(function(e){h.closest(".panel").fadeOut(300,function(){$(this).remove();c.refreshNumberNotifications(b)})})})},function(e,d){clearInterval(window.reminder)})},refreshNumberNotifications:function(c){var d=$(".remindersNotice");var a=d.find(".badge");var b=c.find(".panel:visible").length;a.text(b);a.removeClass("hide");if(b>0&&d.hasClass("autoRefreshing")){$(".remindersNotice .isBadge").effect("pulsate",1500);if(app.cacheGet("countRemindersNotice")!=b){app.playSound("REMINDERS");app.cacheSet("countRemindersNotice",b)}}else{a.addClass("hide")}},registerResizeEvent:function(){$(window).resize(function(){if(this.resizeTO){clearTimeout(this.resizeTO)}this.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},600)});$(window).bind("resizeEnd",function(){Vtiger_Index_Js.adjustTopMenuBarItems()})},adjustTopMenuBarItems:function(){var g=125;var f=($(window).outerWidth()<1161)?jQuery("#mediumNav"):jQuery("#largeNav");var b=f.parent().outerWidth();var h=jQuery(".opttabs",f),d=h.length;var a=d;function e(){var j=(a>0)?h[a-1]:null;if(j){j=jQuery(j);j.hide();a--}return j}var c=false;do{if((b-f.outerWidth())<g){var i=e();if(i==null||(b-f.outerWidth())>g){if(i){i.hide()}c=true;break}}else{c=true;break}}while(!c);jQuery(window).load(function(){jQuery("#topMenus").css({overflow:"visible"})})},registerTooltipEvents:function(){var g=jQuery.merge(jQuery('[data-field-type="reference"] > a'),jQuery('[data-field-type="multireference"] > a'));var e=[];var i=true;function d(){b();var l=jQuery(this);var k=l.attr("href")?l.attr("href"):"";if(k==""){return}k=k.replace("view=","xview=")+"&view=TooltipAjax";var j=i?jQuery('[data-url-cached="'+k+'"]'):null;if(j&&j.length){f(l,j.html())}else{AppConnector.request(k).then(function(m){j=jQuery("<div>").css({display:"none"}).attr("data-url-cached",k);j.html(m);jQuery("body").append(j);f(l,m)})}}function h(l){var k=window.innerWidth;var j=jQuery(l).offset().left;if(k-j<400||a(l)){return"left"}return"right"}function a(l){var k=l.closest("tr");var j=k.find("td.listViewEntryValue:last a");if(l.attr("href")==j.attr("href")){return true}return false}function f(k,l){var j=h(k);k.popover({trigger:"manual",content:l,animation:false,html:true,placement:j,template:'<div class="popover popover-tooltip"><div class="arrow"></div><div class="popover-inner"><button name="vtTooltipClose" class="close" style="color:white;opacity:1;font-weight:lighter;position:relative;top:3px;right:3px;">x</button><h3 class="popover-title"></h3><div class="popover-content"><div></div></div></div></div>'});e.push(k.popover("show"));c()}function b(){var j=null;while(j=e.pop()){j.popover("hide")}}g.each(function(j,k){jQuery(k).hoverIntent({interval:100,sensitivity:7,timeout:10,over:d,out:b})});function c(){jQuery('button[name="vtTooltipClose"]').on("click",function(k){var j=e.pop();j.popover("hide");jQuery(".popover").css("display","none","important")})}},changeWatching:function(a){var g,d,f,e,c,b;if(a!=undefined){a=$(a);g=a.data("value");if(a.data("module")!=undefined){d=a.data("module")}else{d=app.getModuleName()}if(a.data("user")!=undefined){c=a.data("user")}if(a.data("record")!=undefined){b=a.data("record")}}bootbox.dialog({message:app.vtranslate("JS_WATCHING_MESSAGE"+g),title:app.vtranslate("JS_WATCHING_TITLE"),buttons:{success:{label:app.vtranslate("LBL_YES"),className:"btn-success",callback:function(){Vtiger_Index_Js.updateWatching(d,g,c,b).then(function(h){if(a!=undefined){f=h.result==1?0:1;a.data("value",f);if(f==1){a.toggleClass(a.data("off")+" "+a.data("on"));a.children().toggleClass(a.data("iconOff")+" "+a.data("iconOn"))}else{a.toggleClass(a.data("on")+" "+a.data("off"));a.children().toggleClass(a.data("iconOn")+" "+a.data("iconOff"))}}})}},danger:{label:app.vtranslate("LBL_NO"),className:"btn-warning",callback:function(){}}}})},updateWatching:function(d,e,c,a){var b=jQuery.Deferred();var f={module:d,action:"Watchdog",state:e};if(c!=undefined){f.user=c}if(a!=undefined&&a!=0){f.record=a}AppConnector.request(f).then(function(g){b.resolve(g)},function(h,g){b.reject(h,g);app.errorLog(h,g)});return b.promise()},assignToOwner:function(c,b){var a=jQuery.Deferred();c=jQuery(c);if(b==undefined){b=app.getMainParams("current_user_id")}var d={module:c.data("module"),record:c.data("record"),field:"assigned_user_id",value:b};app.saveAjax("",null,d).then(function(g){app.hideModalWindow();if(app.getViewName()==="List"){var f=new Vtiger_List_Js();f.getListViewRecords()}})},sendNotification:function(){Vtiger_Header_Js.getInstance().quickCreateModule("Notification")},loadPreSaveRecord:function(a){SaveResult=new SaveResult();return SaveResult.checkData(a)},registerEvents:function(){Vtiger_Index_Js.registerWidgetsEvents();Vtiger_Index_Js.loadWidgetsOnLoad();Vtiger_Index_Js.registerActivityReminder();Vtiger_Index_Js.registerCheckNotifications();Vtiger_Index_Js.adjustTopMenuBarItems();Vtiger_Index_Js.registerPostAjaxEvents();Vtiger_Index_Js.changeSkin();Vtiger_Index_Js.registerResizeEvent()},registerPostAjaxEvents:function(){Vtiger_Index_Js.registerTooltipEvents()}};jQuery(document).ready(function(){Vtiger_Index_Js.registerEvents();app.listenPostAjaxReady(function(){Vtiger_Index_Js.registerPostAjaxEvents()})});