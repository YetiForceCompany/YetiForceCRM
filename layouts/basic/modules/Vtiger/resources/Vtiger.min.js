
var Vtiger_Index_Js={showEmailPreview:function(a,d){var b=Vtiger_Popup_Js.getInstance();var c={};c.module="Emails";c.view="ComposeEmail";c.mode="emailPreview";c.record=a;c.parentId=d;c.relatedLoad=true;b.show(c)},getEmailFromRecord:function(a,c,d){var b=jQuery.Deferred();AppConnector.request({dataType:"html",data:{module:"OSSMail",action:"GetMail",sourceModule:c,sourceRecord:a,maxEmails:d,}}).then(function(e){if(e.substring(0,1)=="{"){e=$.parseJSON(e);e=e.result;b.resolve(e)}else{app.showModalWindow(e,function(f){f.find(".selectButton").click(function(h){var g=f.find("input:checked").val();app.hideModalWindow(f);b.resolve(g)})})}},function(e,f){b.reject(e)});return b.promise()},registerMailButtons:function(a){var b=this;a.find(".sendMailBtn").click(function(i){var g=jQuery(this);var f=g.data("url");var h=g.data("module");var d=g.data("record");var c=g.data("popup");if(h!=undefined&&d!=undefined){b.getEmailFromRecord(d,h).then(function(e){if(e!=""){f+="&to="+e}b.sendMailWindow(f,c)})}else{b.sendMailWindow(f,c)}})},sendMailWindow:function(url,popup,postData){if(popup){var width=screen.width-15;var height=screen.height-150;var left=0;var top=30;var popupParams="width="+width+", height="+height+", left="+left+", top="+top;if(postData==undefined){window.open(url,"_blank",popupParams+",resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,status=nomenubar=no");return}var actionParams={type:"POST",url:url,dataType:"html",data:postData};AppConnector.request(actionParams).then(function(appData){var win=window.open("about:blank","_blank",popupParams+",resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,status=nomenubar=no");with(win.document){open();write(appData);close()}})}else{window.location.href=url}},registerWidgetsEvents:function(){var a=jQuery("div.widgetContainer");a.on("shown.bs.collapse",function(d){var c=jQuery(d.currentTarget);Vtiger_Index_Js.loadWidgets(c);var b=c.attr("id");app.cacheSet(b,1)});a.on("hidden.bs.collapse",function(g){var d=jQuery(g.currentTarget);var f=d.parent().find(".imageElement");var b=f.data("rightimage");f.attr("src",b);var c=d.attr("id");app.cacheSet(c,0)})},loadWidgets:function(e,c){var d=jQuery(".loadingWidgetMsg").html();if(e.find(".panel-body").html()!=""){var f=e.parent().find(".imageElement");var a=f.data("downimage");f.attr("src",a);e.css("height","auto");return}e.progressIndicator({message:d});var b=e.data("url");var g={type:"GET",url:"index.php",dataType:"html",data:b};AppConnector.request(g).then(function(k){if(typeof c=="undefined"){c=true}if(c){e.progressIndicator({mode:"hide"});var j=e.parent().find(".imageElement");var h=j.data("downimage");j.attr("src",h);e.css("height","auto")}e.html(k);if(k==""){e.closest(".quickWidget").addClass("hide")}else{var i=e.closest(".quickWidget").find(".quickWidgetHeader").data("label")}jQuery(".bodyContents").trigger("Vtiger.Widget.Load."+i,jQuery(e))})},loadWidgetsOnLoad:function(){var a=jQuery("div.widgetContainer");a.each(function(b,c){Vtiger_Index_Js.loadWidgets(jQuery(c))})},changeSkin:function(){jQuery(".themeElement").on("click",function(b){b.stopPropagation();var a=jQuery(b.currentTarget);a.closest("#themeContainer").hide();var d=jQuery("#progressDiv");d.progressIndicator();var c={module:"Users",action:"SaveAjax",record:jQuery("#current_user_id").val(),field:"theme",value:a.data("skinName")};AppConnector.request(c).then(function(e){if(e.success&&e.result){d.progressIndicator({mode:"hide"});jQuery(".settingIcons").removeClass("open");window.location.reload()}},function(e,f){})})},showComposeEmailPopup:function(c,a){var b="Emails";Vtiger_Helper_Js.checkServerConfig(b).then(function(e){if(e==true){var d=jQuery.extend({"text-align":"left"},d);AppConnector.request(c).then(function(i){var m=[];if(i){i=jQuery(i);var h=i.find("#SendEmailFormStep1");var g=h.find(".emailField");var f=g.length;var l=new Emails_MassEdit_Js();if(f>1){app.showModalWindow(i,function(n){l.registerEmailFieldSelectionEvent();if(jQuery("#multiEmailContainer").height()>300){jQuery("#multiEmailContainer").slimScroll({height:"300px",railVisible:true,alwaysVisible:true,size:"6px"})}},d)}else{g.attr("checked","checked");var k=h.serializeFormData();var j=l.showComposeEmailForm(k);m.push(j)}}if(typeof a=="function"){a.apply(null,m)}},function(f,g){})}else{Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_EMAIL_SERVER_CONFIGURATION"))}})},registerNotifications:function(){$(".notificationsNotice .sendNotification").click(function(a){var b={url:"index.php?module=Home&view=CreateNotificationModal",id:"CreateNotificationModal",cb:function(c){var e,h,d,g;h=c.find("#notificationMessage");e=c.find("form");c.find("#notificationTitle").val(app.getPageTitle());d=$("<a/>",{name:"link",href:window.location.href,text:app.vtranslate("JS_NOTIFICATION_LINK")});g=$("<div>").append(d.clone()).html();h.val("<br/><hr/>"+g);var f=new Vtiger_CkEditor_Js();f.loadCkEditor(h);c.find(".externalMail").click(function(j){if(e.validationEngine("validate")){var i=CKEDITOR.instances.notificationMessage;var k=$("<div>"+i.getData()+"</div>");k.find("a[href]").each(function(n,o){var m=$(this);m.text(m.attr("href"))});var l=[];c.find("#notificationUsers option:selected").each(function(m){l.push($(this).data("mail"))});$(this).attr("href","mailto:"+l.join()+"?subject="+encodeURIComponent(c.find("#notificationTitle").val())+"&body="+encodeURIComponent(k.text()));app.hideModalWindow(c,"CreateNotificationModal")}else{j.preventDefault()}});c.find('[type="submit"]').click(function(j){var i=$(this);e.find('[name="mode"]').val(i.data("mode"))});e.submit(function(i){if(e.validationEngine("validate")){app.hideModalWindow(c,"CreateNotificationModal")}})},};app.showModalWindow(b)})},registerCheckNotifications:function(){var d=this;var a=parseInt(app.getMainParams("intervalForNotificationNumberCheck"))*1000;var c=new Date().getTime();var b=app.cacheGet("NotificationsNextCheckTime",0);if((c-a)>b){Vtiger_Index_Js.requestNotification();var c=new Date().getTime();app.cacheSet("NotificationsNextCheckTime",(c+a))}else{d.setNotification(app.cacheGet("NotificationsData",0))}setTimeout("Vtiger_Index_Js.registerCheckNotifications()",a)},requestNotification:function(){var a=this;AppConnector.request({async:false,dataType:"json",data:{module:"Home",action:"Notification",mode:"getNumberOfNotifications"}}).then(function(b){var c=b.result;app.cacheSet("NotificationsData",c);a.setNotification(c)})},setNotification:function(b){var a=$(".notificationsNotice .badge");a.text(b);a.removeClass("hide");if(b>0){$(".notificationsNotice .isBadge").effect("pulsate",1500)}else{a.addClass("hide")}},markNotifications:function(c){var a=this;var b={module:"Home",action:"Notification",mode:"setMark",id:c};AppConnector.request(b).then(function(f){var g=$('.notificationEntries .noticeRow[data-id="'+c+'"]');Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_MARKED_AS_READ"),type:"info"});if(f.result=="hide"){g.fadeOut(300,function(){var h=g.closest(".notificationEntries");g.remove();h.each(function(i){var j=$(this);if(j.find(".noticeRow").length==0){j.closest(".panel").hide()}})})}var d=$(".notificationsNotice .badge");var e=parseInt(d.text())-1;if(e>0){d.text(e)}else{d.text("")}})},registerActivityReminder:function(){var a=(parseInt(app.getMainParams("activityReminder"))||0)*1000;if(a!=0){Vtiger_Index_Js.requestReminder();window.reminder=setInterval(function(){Vtiger_Index_Js.requestReminder()},a)}},requestReminder:function(){var c=this;var b=$(".remindersNoticeContainer");var a="index.php?module=Calendar&view=Reminders&type_remainder=true";AppConnector.request(a).then(function(d){b.html(d);c.refreshNumberNotifications(b);app.registerModal(b);b.find(".reminderPostpone").on("click",function(i){var h=jQuery(i.currentTarget);var g=h.closest(".panel").data("record");var f="index.php?module=Calendar&action=ActivityReminder&mode=postpone&record="+g+"&time="+h.data("time");AppConnector.request(f).then(function(e){h.closest(".panel").fadeOut(300,function(){$(this).remove();c.refreshNumberNotifications(b)})})})},function(e,d){clearInterval(window.reminder)})},refreshNumberNotifications:function(c){var a=$(".remindersNotice .badge");var b=c.find(".panel:visible").length;a.text(b);a.removeClass("hide");if(b>0){$(".remindersNotice .isBadge").effect("pulsate",1500);if(app.cacheGet("countRemindersNotice")!=b){app.playSound("REMINDERS");app.cacheSet("countRemindersNotice",b)}}else{a.addClass("hide")}},registerResizeEvent:function(){$(window).resize(function(){if(this.resizeTO){clearTimeout(this.resizeTO)}this.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},600)});$(window).bind("resizeEnd",function(){Vtiger_Index_Js.adjustTopMenuBarItems()})},adjustTopMenuBarItems:function(){var g=125;var f=($(window).outerWidth()<1161)?jQuery("#mediumNav"):jQuery("#largeNav");var b=f.parent().outerWidth();var h=jQuery(".opttabs",f),d=h.length;var a=d;function e(){var j=(a>0)?h[a-1]:null;if(j){j=jQuery(j);j.hide();a--}return j}var c=false;do{if((b-f.outerWidth())<g){var i=e();if(i==null||(b-f.outerWidth())>g){if(i){i.hide()}c=true;break}}else{c=true;break}}while(!c);jQuery(window).load(function(){jQuery("#topMenus").css({overflow:"visible"})})},registerTooltipEvents:function(){var g=jQuery.merge(jQuery('[data-field-type="reference"] > a'),jQuery('[data-field-type="multireference"] > a'));var e=[];var i=true;function d(){b();var l=jQuery(this);var k=l.attr("href")?l.attr("href"):"";if(k==""){return}k=k.replace("view=","xview=")+"&view=TooltipAjax";var j=i?jQuery('[data-url-cached="'+k+'"]'):null;if(j&&j.length){f(l,j.html())}else{AppConnector.request(k).then(function(m){j=jQuery("<div>").css({display:"none"}).attr("data-url-cached",k);j.html(m);jQuery("body").append(j);f(l,m)})}}function h(l){var k=window.innerWidth;var j=jQuery(l).offset().left;if(k-j<400||a(l)){return"left"}return"right"}function a(l){var k=l.closest("tr");var j=k.find("td.listViewEntryValue:last a");if(l.attr("href")==j.attr("href")){return true}return false}function f(k,l){var j=h(k);k.popover({trigger:"manual",content:l,animation:false,html:true,placement:j,template:'<div class="popover popover-tooltip"><div class="arrow"></div><div class="popover-inner"><button name="vtTooltipClose" class="close" style="color:white;opacity:1;font-weight:lighter;position:relative;top:3px;right:3px;">x</button><h3 class="popover-title"></h3><div class="popover-content"><div></div></div></div></div>'});e.push(k.popover("show"));c()}function b(){var j=null;while(j=e.pop()){j.popover("hide")}}g.each(function(j,k){jQuery(k).hoverIntent({interval:100,sensitivity:7,timeout:10,over:d,out:b})});function c(){jQuery('button[name="vtTooltipClose"]').on("click",function(k){var j=e.pop();j.popover("hide");jQuery(".popover").css("display","none","important")})}},updateWatchingModule:function(b,c){var a=jQuery.Deferred();AppConnector.request({module:b,action:"Watchdog",mode:"updateModule",state:c}).then(function(d){a.resolve(d)},function(e,d){a.reject(e,d);app.errorLog(e,d)});return a.promise()},updateWatchingRecord:function(c,a,d){var b=jQuery.Deferred();AppConnector.request({module:c,action:"Watchdog",mode:"updateRecord",record:a,state:d}).then(function(e){b.resolve(e)},function(f,e){b.reject(f,e);app.errorLog(f,e)});return b.promise()},loadPreSaveRecord:function(a){SaveResult=new SaveResult();return SaveResult.checkData(a)},registerEvents:function(){Vtiger_Index_Js.registerWidgetsEvents();Vtiger_Index_Js.loadWidgetsOnLoad();Vtiger_Index_Js.registerActivityReminder();Vtiger_Index_Js.registerCheckNotifications();Vtiger_Index_Js.registerNotifications();Vtiger_Index_Js.adjustTopMenuBarItems();Vtiger_Index_Js.registerPostAjaxEvents();Vtiger_Index_Js.changeSkin();Vtiger_Index_Js.registerResizeEvent()},registerPostAjaxEvents:function(){Vtiger_Index_Js.registerTooltipEvents()}};jQuery(document).ready(function(){Vtiger_Index_Js.registerEvents();app.listenPostAjaxReady(function(){Vtiger_Index_Js.registerPostAjaxEvents()})});