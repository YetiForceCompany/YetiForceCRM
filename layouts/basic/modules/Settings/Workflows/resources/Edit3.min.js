
Settings_Workflows_Edit_Js("Settings_Workflows_Edit3_Js",{},{step3Container:false,advanceFilterInstance:false,ckEditorInstance:false,fieldValueMap:false,init:function(){this.initialize()},getContainer:function(){return this.step3Container},setContainer:function(a){this.step3Container=a;return this},initialize:function(a){if(typeof a=="undefined"){a=jQuery("#workflow_step3")}if(a.is("#workflow_step3")){this.setContainer(a)}else{this.setContainer(jQuery("#workflow_step3"))}},registerEditTaskEvent:function(){var b=this;var a=this.getContainer();app.registerCopyClipboard();a.on("click","[data-url]",function(f){var c=jQuery(f.currentTarget);var g=c.data("url");var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});app.showModalWindow(null,g,function(k){d.progressIndicator({mode:"hide"});b.registerVTCreateTodoTaskEvents();var e=jQuery("#taskType").val();var j="register"+e+"Events";if(typeof b[j]!="undefined"){b[j].apply(b)}b.registerSaveTaskSubmitEvent(e);jQuery("#saveTask").validationEngine(app.validationEngineOptions);b.registerFillTaskFieldsEvent();b.registerCheckSelectDateEvent();app.showBtnSwitch($(k).find(".switchBtn"));app.showPopoverElementView($(k).find(".popoverTooltip"));var i=parseInt(k.find(".modal-body").height());var h=app.getScreenHeight(80);if((i)>h){app.showScrollBar(k.find(".modal-body"),{height:h+"px"})}})})},registerCheckSelectDateEvent:function(){jQuery('[name="check_select_date"]').on("change",function(a){if(jQuery(a.currentTarget).is(":checked")){jQuery("#checkSelectDateContainer").removeClass("hide").addClass("show")}else{jQuery("#checkSelectDateContainer").removeClass("show").addClass("hide")}})},registerSaveTaskSubmitEvent:function(a){var b=this;jQuery("#saveTask").on("submit",function(i){var h=jQuery(i.currentTarget);var f=h.validationEngine("validate");if(f==true){var d=a+"CustomValidation";if(typeof b[d]!="undefined"){var c=b[d].apply(b);if(c!=true){var j={title:app.vtranslate("JS_MESSAGE"),text:c,animation:"show",type:"error"};Vtiger_Helper_Js.showPnotify(j);i.preventDefault();return}}var g="preSave"+a;if(typeof b[g]!="undefined"){b[g].apply(b,[a])}var j=h.serializeFormData();AppConnector.request(j).then(function(e){if(e.result){b.getTaskList();app.hideModalWindow()}})}i.preventDefault()})},VTUpdateFieldsTaskCustomValidation:function(){return this.checkDuplicateFieldsSelected()},VTCreateEntityTaskCustomValidation:function(){return this.checkDuplicateFieldsSelected()},checkDuplicateFieldsSelected:function(){var c=jQuery("#save_fieldvaluemapping").find(".conditionRow").find('[name="fieldname"]');var a=true;var b=app.vtranslate("JS_SAME_FIELDS_SELECTED_MORE_THAN_ONCE");jQuery.each(c,function(e,f){var g=jQuery(f).attr("value");var d=jQuery("[name="+g+"]").not(":hidden");if(d.length>1){a=b;return false}});return a},preSaveVTUpdateFieldsTask:function(b){var a=this.getValues(b);jQuery('[name="field_value_mapping"]').val(JSON.stringify(a))},preSaveVTCreateEntityTask:function(b){var a=this.getValues(b);jQuery('[name="field_value_mapping"]').val(JSON.stringify(a))},preSaveVTEmailTask:function(b){var a=jQuery("#content");a.val(CKEDITOR.instances.content.getData())},preSaveVTUpdateRelatedFieldTask:function(b){var a=this.getValues(b);jQuery('[name="field_value_mapping"]').val(JSON.stringify(a))},isEmptyFieldSelected:function(a){var b=a.find("option:selected");if(b.val()=="none"){return true}return false},getVTCreateEntityTaskFieldList:function(){return new Array("fieldname","value","valuetype","modulename")},getVTUpdateFieldsTaskFieldList:function(){return new Array("fieldname","value","valuetype")},getVTUpdateRelatedFieldTaskFieldList:function(){return new Array("fieldname","value","valuetype")},getValues:function(d){var e=this;var c=jQuery("#save_fieldvaluemapping");var g="get"+d+"FieldList";if(typeof e[g]!="undefined"){var b=e[g].apply()}var a=[];var f=jQuery(".conditionRow",c);f.each(function(n,q){var m=jQuery(q);var h=jQuery('[name="fieldname"]',m);var k=jQuery('[data-value="value"]',m);if(e.isEmptyFieldSelected(h)){return true}var l=h.find("option:selected").data("fieldinfo");var o=l.type;var x={};if(o=="owner"){for(var w in b){var s=b[w];if(s=="value"&&k.is("select")){x[s]=k.find("option:selected").val()}else{x[s]=jQuery('[name="'+s+'"]',m).val()}}}else{if(o=="picklist"||o=="multipicklist"){for(var w in b){var s=b[w];if(s=="value"&&k.is("input")){var v=k.val();var r=k.data("picklistvalues");var u=v.split(",");var p=[];for(n=0;n<u.length;n++){if(typeof r[u[n]]!="undefined"){p.push(r[u[n]])}else{p.push(u[n])}}var j=p.join(",");x[s]=j}else{if(s=="value"&&k.is("select")&&o=="picklist"){x[s]=k.val()}else{if(s=="value"&&k.is("select")&&o=="multipicklist"){var t=k.val();if(t==null){x[s]=t}else{x[s]=t.join(",")}}else{x[s]=jQuery('[name="'+s+'"]',m).val()}}}}}else{for(var w in b){var s=b[w];if(s=="value"){x[s]=k.val()}else{x[s]=jQuery('[name="'+s+'"]',m).val()}}}}if(jQuery('[name="valuetype"]',m).val()=="false"||(jQuery('[name="valuetype"]',m).length==0)){x.valuetype="rawtext"}a.push(x)});return a},getTaskList:function(){var a=this.getContainer();var c={module:app.getModuleName(),parent:app.getParentModuleName(),view:"TasksList",record:jQuery('[name="record"]',a).val()};var b=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(c).then(function(d){jQuery("#taskListContainer").html(d);b.progressIndicator({mode:"hide"})})},getckEditorInstance:function(){if(this.ckEditorInstance==false){this.ckEditorInstance=new Vtiger_CkEditor_Js()}return this.ckEditorInstance},registerTaskStatusChangeEvent:function(){var a=this.getContainer();a.on("change",".taskStatus",function(f){var c=jQuery(f.currentTarget);var b=c.data("statusurl");if(c.is(":checked")){b=b+"&status=true"}else{b=b+"&status=false"}var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(b).then(function(e){if(e.result=="ok"){var g={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STATUS_CHANGED_SUCCESSFULLY"),animation:"show",type:"success"};Vtiger_Helper_Js.showPnotify(g)}d.progressIndicator({mode:"hide"})});f.stopImmediatePropagation()})},registerTaskDeleteEvent:function(){var b=this;var a=this.getContainer();a.on("click",".deleteTask",function(d){var c=app.vtranslate("LBL_DELETE_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:c}).then(function(){var e=jQuery(d.currentTarget);var f=e.data("deleteurl");AppConnector.request(f).then(function(g){if(g.result=="ok"){b.getTaskList();var h={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_TASK_DELETED_SUCCESSFULLY"),animation:"show",type:"success"};Vtiger_Helper_Js.showPnotify(h)}})})})},registerFillTaskFromEmailFieldEvent:function(){jQuery("#saveTask").on("change","#fromEmailOption",function(c){var a=jQuery(c.currentTarget);var b=a.closest(".row").find(".fields");b.val(a.val())})},registerFillTaskFieldsEvent:function(){jQuery("#saveTask").on("change",".task-fields",function(f){var b=jQuery(f.currentTarget);var d=b.closest(".row").find(".fields");var a=d.val();var c=a+b.val();d.val(c)})},registerFillMailContentEvent:function(){jQuery("#task-fieldnames,#task_timefields,#task-templates").change(function(c){var a=CKEDITOR.instances.content;var b=jQuery(c.currentTarget).val();if(a!=undefined){a.insertHtml(b)}else{if(jQuery('textarea[name="content"]')){var d=jQuery('textarea[name="content"]');d.insertAtCaret(b)}}})},registerVTEmailTaskEvents:function(){var a=jQuery("#content");var b=this.getckEditorInstance();b.loadCkEditor(a);this.registerFillMailContentEvent();this.registerFillTaskFromEmailFieldEvent();this.registerCcAndBccEvents()},registerVTCreateTodoTaskEvents:function(){app.registerEventForClockPicker()},registerVTUpdateFieldsTaskEvents:function(){var b=this;this.registerAddFieldEvent();this.registerDeleteConditionEvent();this.registerFieldChange();this.fieldValueMap=false;if(jQuery("#fieldValueMapping").val()!=""){this.fieldValueReMapping()}var a=jQuery("#save_fieldvaluemapping").find('select[name="fieldname"]');jQuery.each(a,function(c,d){b.loadFieldSpecificUi(jQuery(d))});this.getPopUp(jQuery("#saveTask"))},registerVTUpdateRelatedFieldTaskEvents:function(){var b=this;this.registerAddFieldEvent();this.registerDeleteConditionEvent();this.registerFieldChange();this.fieldValueMap=false;if(jQuery("#fieldValueMapping").val()!=""){this.fieldValueReMapping()}var a=jQuery("#save_fieldvaluemapping").find('select[name="fieldname"]');jQuery.each(a,function(c,d){b.loadFieldSpecificUi(jQuery(d))});this.getPopUp(jQuery("#saveTask"))},registerAddFieldEvent:function(){jQuery("#addFieldBtn").on("click",function(b){var a=jQuery(".basicAddFieldContainer").clone(true,true).removeClass("basicAddFieldContainer hide").addClass("conditionRow");jQuery("select",a).addClass("select2");jQuery("#save_fieldvaluemapping").append(a);app.changeSelectElementView(a);app.showSelect2ElementView(a.find(".select2"))})},registerDeleteConditionEvent:function(){jQuery("#saveTask").on("click",".deleteCondition",function(a){jQuery(a.currentTarget).closest(".conditionRow").remove()})},registerFieldChange:function(){var a=this;jQuery("#saveTask").on("change",'select[name="fieldname"]',function(h){var j=jQuery(h.currentTarget);if(j.val()!="none"){var f=j.closest(".conditionRow");var g=f.find('[name="modulename"]');if(g.length>0){var i=j.find("option:selected").data("fieldinfo");var d=i.type;if(d=="picklist"||d=="multipicklist"){var c=jQuery("select.createEntityModule:not(:disabled)");var b=c.val();g.val(b).change().prop("disabled",true)}}a.loadFieldSpecificUi(j)}})},getModuleName:function(){return app.getModuleName()},getFieldValueMapping:function(){var a=this.fieldValueMap;if(a!=false){return a}else{return""}},fieldValueReMapping:function(){var a=JSON.parse(jQuery("#fieldValueMapping").val());var b={};jQuery.each(a,function(d,e){b[e.fieldname]={};var c={};jQuery.each(e,function(f,g){c[f]=g});b[e.fieldname]=c});this.fieldValueMap=b},loadFieldSpecificUi:function(b){var f=b.find("option:selected");var o=b.closest("div.conditionRow");var m=o.find(".fieldUiHolder");var a=f.data("fieldinfo");var j=this.getFieldValueMapping();if(j!=""&&typeof j[a.name]!="undefined"){a.value=j[a.name]["value"];a.workflow_valuetype=j[a.name]["valuetype"]}else{a.workflow_valuetype="rawtext"}var c=this.getModuleName();var i=Vtiger_Field_Js.getInstance(a,c);this.fieldModelInstance=i;var h=this.getFieldSpecificUi(b);var l=i.getName();if(i.getType()=="multipicklist"){l=l+"[]"}h.filter('[name="'+l+'"]').attr("data-value","value");h.find('[name="'+l+'"]').attr("data-value","value");h.filter('[name="valuetype"]').removeAttr("data-validation-engine");h.find('[name="valuetype"]').removeAttr("data-validation-engine");var k=h.filter('[name="valuetype"]').val();if(k!="rawtext"&&typeof k!="undefined"){h.filter('[name="'+l+'"]').removeAttr("data-validation-engine");h.find('[name="'+l+'"]').removeAttr("data-validation-engine")}m.html(h);if(h.is("input.select2")){var n=h.data("tags");var e={tags:n,tokenSeparators:[","]};app.showSelect2ElementView(h,e)}else{if(h.is("select")){if(h.hasClass("chzn-select")){app.changeSelectElementView(h)}else{app.showSelect2ElementView(h)}}else{if(h.is("input.dateField")){var g=h.data("calendarType");if(g=="range"){var d={calendars:3,mode:"range",className:"rangeCalendar",onChange:function(p){h.val(p.join(","))}};app.registerEventForDatePickerFields(h,false,d)}else{app.registerEventForDatePickerFields(h)}}}}return this},getFieldSpecificUi:function(a){var b=this.fieldModelInstance;return jQuery(b.getUiTypeSpecificHtml())},registerVTCreateEventTaskEvents:function(){app.registerEventForClockPicker()},registerVTCreateEntityTaskEvents:function(){this.registerChangeCreateEntityEvent();this.registerVTUpdateFieldsTaskEvents()},registerChangeCreateEntityEvent:function(){var a=this;jQuery('[name="mappingPanel"]').on("change",function(f){var d=jQuery(f.currentTarget);app.setMainParams("mappingPanel",d.val());jQuery("#addCreateEntityContainer").html("");var c=jQuery("."+d.data("hide"));var g=jQuery("."+d.data("show"));var b=app.getMainParams("taskFields",true);c.addClass("hide").find("input,select").each(function(j,k){var i=jQuery(this);var h=i.attr("name");if($.inArray(h,b)>=0){if(i.is("select")){i.val("").trigger("chosen:updated").change()}i.prop("disabled",true)}});g.removeClass("hide").find("input,select").each(function(j,k){var i=jQuery(this);var h=i.attr("name");if($.inArray(h,b)>=0){i.prop("disabled",false);if(i.is("select")){i.val("").trigger("chosen:updated").change()}}})});jQuery(".createEntityModule").on("change",function(c){var d={module:app.getModuleName(),parent:app.getParentModuleName(),view:"CreateEntity",relatedModule:jQuery(c.currentTarget).val(),for_workflow:jQuery('[name="for_workflow"]').val(),mappingPanel:app.getMainParams("mappingPanel")};var b=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(d).then(function(g){b.progressIndicator({mode:"hide"});var f=jQuery("#addCreateEntityContainer");f.html(g);app.changeSelectElementView(f);app.showSelect2ElementView(f.find(".select2"));a.registerAddFieldEvent();a.fieldValueMap=false;if(jQuery("#fieldValueMapping").val()!=""){this.fieldValueReMapping()}var e=jQuery("#save_fieldvaluemapping").find('select[name="fieldname"]');jQuery.each(e,function(h,j){a.loadFieldSpecificUi(jQuery(j))})})})},changeRecurringTypesUIStyles:function(b){var a=this;if(b=="Daily"||b=="Yearly"){jQuery("#repeatWeekUI").removeClass("show").addClass("hide");jQuery("#repeatMonthUI").removeClass("show").addClass("hide")}else{if(b=="Weekly"){jQuery("#repeatWeekUI").removeClass("hide").addClass("show");jQuery("#repeatMonthUI").removeClass("show").addClass("hide")}else{if(b=="Monthly"){jQuery("#repeatWeekUI").removeClass("show").addClass("hide");jQuery("#repeatMonthUI").removeClass("hide").addClass("show")}}}},checkHiddenStatusofCcandBcc:function(){var a=jQuery("#ccLink");var b=jQuery("#bccLink");if(a.hasClass("hide")&&b.hasClass("hide")){a.closest("div.row").addClass("hide")}},registerCcAndBccEvents:function(){var a=this;jQuery("#ccLink").on("click",function(d){var b=jQuery("#ccContainer");b.removeClass("hide");var c=b.find("select.task-fields");c.addClass("chzn-select");app.changeSelectElementView(c);jQuery(d.currentTarget).addClass("hide");a.checkHiddenStatusofCcandBcc()});jQuery("#bccLink").on("click",function(d){var b=jQuery("#bccContainer");b.removeClass("hide");var c=b.find("select.task-fields");c.addClass("chzn-select");app.changeSelectElementView(c);jQuery(d.currentTarget).addClass("hide");a.checkHiddenStatusofCcandBcc()})},registerEvents:function(){var a=this.getContainer();app.changeSelectElementView(a);this.registerEditTaskEvent();this.registerTaskStatusChangeEvent();this.registerTaskDeleteEvent()}});jQuery.fn.extend({insertAtCaret:function(a){return this.each(function(d){if(document.selection){this.focus();var e=document.selection.createRange();e.text=a;this.focus()}else{if(this.selectionStart||this.selectionStart=="0"){var c=this.selectionStart;var b=this.selectionEnd;var f=this.scrollTop;this.value=this.value.substring(0,c)+a+this.value.substring(b,this.value.length);this.focus();this.selectionStart=c+a.length;this.selectionEnd=c+a.length;this.scrollTop=f}else{this.value+=a;this.focus()}}})}});