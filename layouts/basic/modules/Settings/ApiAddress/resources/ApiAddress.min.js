
jQuery.Class("Settings_ApiAddress_Configuration_Js",{},{registerChangeApi:function(a){a.find("#change_api").on("change",function(){var b=$(this).val();a.find(".api_row").addClass("hide");if(b){a.find("."+b).removeClass("hide")}})},registerSave:function(b){var a=this;b.find(".saveGlobal").on("click",function(){var c={min_lenght:$('[name="min_lenght"]').val(),result_num:$('[name="result_num"]').val(),api_name:"global",};var d={};d.data={module:"ApiAddress",parent:"Settings",action:"SaveConfig",elements:c};d.async=false;d.dataType="json";AppConnector.request(d).then(function(g){var e=g.result;var f={text:e.message,type:"success"};Vtiger_Helper_Js.showPnotify(f)},function(g,f){var e={text:app.vtranslate("JS_ERROR"),type:"error"};Vtiger_Helper_Js.showPnotify(e)})});b.find(".save").on("click",function(){var c={};jQuery(this).closest(".apiContainer").find(".api").each(function(){var e=jQuery(this).attr("name");if(jQuery(this).attr("type")=="checkbox"){c[e]=jQuery(this).prop("checked")?1:0}else{c[e]=jQuery(this).val()}});c.api_name=jQuery(this).closest(".apiContainer").find(".apiAdrress").data("api-name");if(!a.registerValidate(c)){return false}c=jQuery.extend({},c);var d={};d.data={module:"ApiAddress",parent:"Settings",action:"SaveConfig",elements:c};d.async=false;d.dataType="json";AppConnector.request(d).then(function(g){var e=g.result;if(e.success){if(c.key){a.registerReload()}var f={text:e.message,type:"success"};Vtiger_Helper_Js.showPnotify(f)}else{var f={text:e.message,type:"error"};Vtiger_Helper_Js.showPnotify(f)}},function(g,e){var f={text:app.vtranslate("JS_ERROR"),type:"error"};Vtiger_Helper_Js.showPnotify(f)})})},registerRemoveConnection:function(b){var a=this;b.find(".delete").on("click",function(){var c={key:"0",nominatim:"0",api_name:jQuery(this).closest(".apiContainer").find(".apiAdrress").data("api-name")};var d={};d.data={module:"ApiAddress",parent:"Settings",action:"SaveConfig",elements:c};d.async=false;d.dataType="json";AppConnector.request(d).then(function(g){var e=g.result;if(e.success){a.registerReload();var f={text:e.message,type:"success"};Vtiger_Helper_Js.showPnotify(f)}else{var f={text:e.message,type:"error"};Vtiger_Helper_Js.showPnotify(f)}},function(g,e){var f={text:app.vtranslate("JS_ERROR"),type:"error"};Vtiger_Helper_Js.showPnotify(f)})})},registerReload:function(){var b=this;var a=jQuery.progressIndicator({message:app.vtranslate("JS_LOADING_PLEASE_WAIT"),position:".contentsDiv",blockInfo:{enabled:true}});jQuery.get("index.php?module=ApiAddress&parent=Settings&view=Configuration",function(c){jQuery(".contentsDiv").html(c);app.showSelect2ElementView(jQuery(".contentsDiv").find("select.select2"));a.progressIndicator({mode:"hide"});b.registerEvents()})},registerValidate:function(d){var c=this;var a=true;for(var b in d){if(b=="min_lenght"||b=="result_num"){if(!c.registerValidatemin_lenght(d[b])){return false}}if(b=="key"){if(!c.registerValidatekey(d.key,d.api_name)){return false}}}return a},registerValidatemin_lenght:function(c){var b=/^\d+$/;if(!b.test(c)||(1==c||0==c)){var a={text:app.vtranslate("JS_WRONG_NUMBER"),type:"error"};Vtiger_Helper_Js.showPnotify(a);return false}return true},registerValidatekey:function(c,b){var a=true;if("opencage_data"==b){var d="https://api.opencagedata.com/geocode/v1/json?query=test&pretty=1&key="+c;jQuery.ajax({url:d,async:false,complete:function(f){if(f.status==403){var e={text:app.vtranslate("Invalid API key"),type:"error"};Vtiger_Helper_Js.showPnotify(e);a=false}}})}else{return true}return a},registerEvents:function(){var b=this;var a=$(".contentsDiv");b.registerChangeApi(a);b.registerSave(a);b.registerRemoveConnection(a)}});