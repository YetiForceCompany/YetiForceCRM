
$("#roundcube_interface").load(function(){var b=$("#roundcube_interface").contents();var a=getAbsolutePath();load_all_widgets(b,a);load_ical_attachments(b,a)});function load_ical_attachments(b,a){$(b.find("#messagecontent .icalattachments a")).click(function(){var c={};c.data={module:"Calendar",action:"ImportICS",ics:$(this).attr("class")};c.async=true;c.dataType="json";$(this).closest(".icalattachments").remove();AppConnector.request(c).then(function(d){var e={text:d.result,type:"info",animation:"show"};Vtiger_Helper_Js.showPnotify(e)})})}function load_all_widgets(g,d){if(!g){var g=$("#roundcube_interface").contents()}if(!d){var d=getAbsolutePath()}var f={};var c={};if(!g.find(".oss-header").text()==""){var e="";var b=g.find(".from .rcmContactAddress").attr("href");if(!!b){var a=b.split(":");f.from_email=a[1]}f.from_name=g.find(".from .rcmContactAddress").text();f.title=g.find(".subject").text().replace("Subject: ","");f.body=g.find("#messagebody").text();c.uid=f.uid=g.find("#message-oss-parameters-uid").text();c.folder=f.folder=g.find("#message-oss-parameters-folder").text();c.username=f.username=g.find("#message-oss-parameters-username").text();load_connection(d,c,f,g,e)}$(g.find("#messagelist")).click(function(){$(g.find("#messagecontframe")).load(function(){var i=$(g.find("#messagecontframe")).contents();var j=i.find(".from .rcmContactAddress").attr("href");if(!!j){var h=j.split(":");f.from_email=h[1]}f.from_name=i.find(".from .rcmContactAddress").text();f.title=i.find(".subject").text().replace("Subject: ","");f.body=i.find("#messagebody").text();c.uid=f.uid=i.find("#message-oss-parameters-uid").text();c.folder=f.folder=i.find("#message-oss-parameters-folder").text();c.username=f.username=i.find("#message-oss-parameters-username").text();load_connection(d,c,f,i,e)})})}function load_connection(c,b,e,f,d){var a=jQuery.ajax({type:"GET",async:true,url:c+"index.php",data:{module:"OSSMail",action:"getConfig"}});jqxhr=get_crm_id(b);jqxhr.done(function(h){e.crmid=h.result;var g=find_crm_detail(c,"all",e);a.done(function(i){g.done(function(k){if(h.result!=="false"){var j=0;if(h.result.id!==undefined){j=h.result.id}if(h.result["0_created_Email"]!==undefined){j=h.result["0_created_Email"]["created_Email"]}if(j===0){load_oss_bar_no_mail(f,e)}else{e.crmid=j;load_oss_bar(f,e.crmid,i.result,k.result);load_action(f,e)}}})})})}function load_action(b,a){$(b.find("#message-oss-header a.link")).click(function(){var c=$(this).attr("href");window.location.href=c});$(b.find("#message-oss-header .oss-add-Vendors")).click(function(){loadQuickCreateForm("Vendors",a,b)});$(b.find("#message-oss-header .oss-add-Accounts")).click(function(){loadQuickCreateForm("Accounts",a,b)});$(b.find("#message-oss-header .oss-add-Contacts")).click(function(){loadQuickCreateForm("Contacts",a,b)});$(b.find("#message-oss-header .oss-add-Leads")).click(function(){loadQuickCreateForm("Leads",a,b)});$(b.find("#message-oss-header .oss-add-Project")).click(function(){loadQuickCreateForm("Project",a,b)});$(b.find("#message-oss-header .oss-add-ServiceContracts")).click(function(){loadQuickCreateForm("ServiceContracts",a,b)});$(b.find("#message-oss-header .oss-add-HelpDesk")).click(function(){if($(this).attr("data-module")&&$(this).attr("data-module")!="HelpDesk"){a.sourceModule=$(this).attr("data-module");a.crmid=$(this).attr("data-crmid")}loadQuickCreateForm("HelpDesk",a,b)});$(b.find("#message-oss-header .oss-remove-relation")).click(function(){var c={mailId:a.crmid,crmid:$(this).attr("data-crmid")};executeActions("removeRelated",c);load_all_widgets()});$(b.find("#message-oss-header .oss-Related")).click(function(){var f={mailId:a.crmid};if($(this).attr("data-crmid")){f.crmid=$(this).attr("data-crmid")}var c=$(this).attr("data-module");var d=jQuery('input[name="temp_field"]');var e={module:c,src_module:c,src_field:d.attr("name"),src_record:"",url:getAbsolutePath()+"/index.php?"};showPopup(e,d,f,b,true)});$(b.find("#message-oss-header .oss-add-modcomments")).click(function(){a.rcrmid=$(this).attr("data-crmid");a.no_rel=true;loadQuickCreateForm("ModComments",a,b)});$(b.find("#message-oss-header .oss-add-events")).click(function(){a.sourceModule=$(this).attr("data-module");a.crmid=$(this).attr("data-crmid");loadQuickCreateForm("Calendar",a,b)});$(b.find("#message-oss-header .oss-add-task")).click(function(){a.sourceModule=$(this).attr("data-module");a.crmid=$(this).attr("data-crmid");a.mode="task";loadQuickCreateForm("Calendar",a,b)});$(b.find("#message-oss-header .oss-add-products")).click(function(){var c="Products";var f={mailId:a.crmid,newModule:"Products",mod:$(this).attr("data-module"),crmid:$(this).attr("data-crmid"),};var d=jQuery('input[name="temp_field"]');var e={module:c,src_module:c,src_field:d.attr("name"),src_record:"",url:getAbsolutePath()+"/index.php?"};showPopup(e,d,f,b,true)});$(b.find("#message-oss-header .oss-add-services")).click(function(){var c="Services";var f={mailId:a.crmid,newModule:"Products",mod:$(this).attr("data-module"),crmid:$(this).attr("data-crmid"),};var d=jQuery('input[name="temp_field"]');var e={module:c,src_module:c,src_field:d.attr("name"),src_record:"",url:getAbsolutePath()+"/index.php?"};showPopup(e,d,f,b,true)});$(b.find("#moreheaderstoggle .oss-reload-bar")).click(function(){load_all_widgets()});$(b.find("#moreheaderstoggle .oss-close-bar")).click(function(){var e=b.find("#message-oss-header");var d=b.find("#messageheader");var c=d.height();if(e.data("show")==true){e.show().data("show",false);b.find("#messagecontent").css("top",(c+80)+"px");b.find("#moreheaderstoggle .oss-close-bar").html('<img src="'+window.images_path+'upArrowSmall.png">')}else{e.hide().data("show",true);b.find("#messagecontent").css("top",(c)+"px");b.find("#moreheaderstoggle .oss-close-bar").html('<img src="'+window.images_path+'downArrowSmall.png">')}});$(b.find("#moreheaderstoggle .oss-email-link")).click(function(){if(a.crmid){window.location.href=getAbsolutePath()+"index.php?module=OSSMailView&view=Detail&record="+a.crmid}else{alert(app.vtranslate("NoCrmRecord"))}})}function executeActions(a,c){var b={};var d={};d.data={module:"OSSMail",action:"executeActions",action_name:a,params:c};d.async=false;d.dataType="json";AppConnector.request(d).then(function(g){var e=g.result;if(e.success){var f={text:e.data,type:"info",animation:"show"}}else{var f={text:e.data,animation:"show"}}Vtiger_Helper_Js.showPnotify(f)})}function load_oss_bar_no_mail(b,a){b.find("#message-oss-header").html('<div class="no_records">'+app.vtranslate("JS_MAIL_NOT_FOUND_IN_DB")+' <a class="import_mail">'+app.vtranslate("JS_MANUAL_IMPORT")+"</a><div>");b.find("#messagecontent").css("top",(b.find(".oss-header").outerHeight()+b.find("#messageheader").outerHeight()+1)+"px");$(b.find("#message-oss-header .import_mail")).click(function(){Vtiger_Helper_Js.showPnotify({text:app.vtranslate("StartedDownloadingEmail"),type:"info"});import_mail(a).then(function(c){load_all_widgets(b);Vtiger_Helper_Js.showPnotify({text:app.vtranslate("AddFindEmailInRecord"),type:"success"})})})}function import_mail(c){var a=jQuery.Deferred();var b={};b.data={module:"OSSMailScanner",action:"ImportMail",params:c};AppConnector.request(b).then(function(d){a.resolve(d)},function(d){a.reject()});return a.promise()}function load_oss_bar(x,E,C,a){var s=getAbsolutePath();var c=x.find("#messageheader");var A={};var z=c.find(".from .rcmContactAddress").attr("href");if(!!z){var m=z.split(":");A.from_email=m[1]}A.from_name=c.find(".from .rcmContactAddress").text();A.title=c.find(".subject").text();A.body=x.find("#messagebody").text();A.uid=x.find("#message-oss-parameters-uid").text();A.folder=x.find("#message-oss-parameters-folder").text();A.username=x.find("#message-oss-parameters-username").text();var u=get_module_permissions(s);var G=false;var r=false;var n=false;var e=false;var D="";var p="";var o="";var B="";var f="";var y="";var q="";var F="";var b=s+"layouts/basic/skins/images/";window.images_path=b;var l="";var v="";var t={};var k="";var j="";var h="";var g="";if(a){if(a.Accounts){for(var w=0;w<a.Accounts["rows"].length;w++){var d={};d=a.Accounts["rows"][w];p+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+d.label+'" class="btn link">'+d.label+'</a><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Accounts")+'" class="oss-add-Accounts btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Accounts")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Related To Accounts")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Accounts")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Remove relation")+'" class="oss-remove-relation btn small-icon"><img src="'+b+'no.png" alt="'+app.vtranslate("Remove relation")+'"></a></span></div>';p+="<div>"+load_icons("Accounts",d.crmid,u,b)+"</div>"}}if(a.Contacts){for(var w=0;w<a.Contacts["rows"].length;w++){var d={};d=a.Contacts["rows"][w];p+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+d.label+'" class="btn link">'+d.label+'</a><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Contacts")+'" class="oss-add-Contacts btn  small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Contacts")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Related To Contacts")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Contacts")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Remove relation")+'" class="oss-remove-relation btn small-icon"><img src="'+b+'no.png" alt="'+app.vtranslate("Remove relation")+'"></a></span></div>';p+="<div>"+load_icons("Contacts",d.crmid,u,b)+"</div>"}}if(a.Leads){for(var w=0;w<a.Leads["rows"].length;w++){var d={};d=a.Leads["rows"][w];p+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+d.label+'" class="btn link">'+d.label+'</a><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Leads")+'" class="oss-add-Leads btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Leads")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Related To Leads")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Leads")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Remove relation")+'" class="oss-remove-relation btn small-icon"><img src="'+b+'no.png" alt="'+app.vtranslate("Remove relation")+'"></a></span></div>';p+="<div>"+load_icons("Leads",d.crmid,u,b)+"</div>"}}if(a.Vendors){for(var w=0;w<a.Vendors["rows"].length;w++){var d={};d=a.Vendors["rows"][w];p+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+d.label+'" class="btn link">'+d.label+'</a><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Vendors")+'" class="oss-add-Vendors btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Vendors")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Related To Vendors")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Vendors")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Remove relation")+'" class="oss-remove-relation btn small-icon"><img src="'+b+'no.png" alt="'+app.vtranslate("Remove relation")+'"></a></span></div>'}}if(p==""){G=true}if(a.Campaigns){for(var w=0;w<a.Campaigns["rows"].length;w++){var d={};d=a.Campaigns["rows"][w];o+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+app.vtranslate("Campaigns")+": "+d.label+'" class="btn link">'+d.label+"</a></div>"}}if(!a.Project){r=true}else{for(var w=0;w<a.Project["rows"].length;w++){var d={};d=a.Project["rows"][w];f+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+d.label+'" class="btn link">'+d.label+'</a><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Project")+'" class="oss-add-Project btn  small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Project")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Related To Project")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Project")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Remove relation")+'" class="oss-remove-relation btn small-icon"><img src="'+b+'no.png" alt="'+app.vtranslate("Remove relation")+'"></a></span></div>';f+="<div>"+load_icons("Project",d.crmid,u,b)+"</div>"}}if(!a.HelpDesk){n=true}else{for(var w=0;w<a.HelpDesk["rows"].length;w++){var d={};d=a.HelpDesk["rows"][w];q+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+d.label+'" class="btn link">'+d.label+'</a><span class="pull-right"><a href="#" title="'+app.vtranslate("Add HelpDesk")+'" class="oss-add-HelpDesk btn  small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add HelpDesk")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Related To HelpDesk")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To HelpDesk")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Remove relation")+'" class="oss-remove-relation btn small-icon"><img src="'+b+'no.png" alt="'+app.vtranslate("Remove relation")+'"></a></span></div>';q+="<div>"+load_icons("HelpDesk",d.crmid,u,b)+"</div>"}}if(a.ServiceContracts){for(var w=0;w<a.ServiceContracts["rows"].length;w++){d=a.ServiceContracts["rows"][w];q+='<div class="oss-border-top"><a href="'+s+"index.php?module="+d.module+"&view=Detail&record="+d.crmid+'" title="'+app.vtranslate("ServiceContracts")+": "+d.label+'" class="btn link">'+d.label+'</a><span class="pull-right"><a href="#" title="'+app.vtranslate("Add ServiceContracts")+'" class="oss-add-ServiceContracts btn  small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add ServiceContracts")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Related To ServiceContracts")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To ServiceContracts")+'"></a><a data-crmid="'+d.crmid+'" data-module="'+d.module+'" href="#" title="'+app.vtranslate("Remove relation")+'" class="oss-remove-relation btn small-icon"><img src="'+b+'no.png" alt="'+app.vtranslate("Remove relation")+'"></a></span></div>'}}else{e=true}}else{var G=true;var r=true;var n=true;var e=true}if(G){p+='<div><span class="vtop inline-block">'+app.vtranslate("Add or related to Leads")+'</span><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Leads")+'" class="oss-add-Leads btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Leads")+'"></a><a data-module="Leads" href="#" title="'+app.vtranslate("Related To Leads")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Leads")+'"></a></span></div>';p+='<div><span class="vtop inline-block">'+app.vtranslate("Add or related to Contacts")+'</span><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Contacts")+'" class="oss-add-Contacts btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Contacts")+'"></a><a data-module="Contacts" href="#" title="'+app.vtranslate("Related To Contacts")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Contacts")+'"></a></span></div>';p+='<div><span class="vtop inline-block">'+app.vtranslate("Add or related to Accounts")+'</span><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Accounts")+'" class="oss-add-Accounts btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Accounts")+'"></a><a data-module="Accounts" href="#" title="'+app.vtranslate("Related To Accounts")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Accounts")+'"></a></span></div>';p+='<div><span class="vtop inline-block">'+app.vtranslate("Add or related to Vendors")+'</span><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Vendors")+'" class="oss-add-Vendors btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Vendors")+'"></a><a data-module="Vendors" href="#" title="'+app.vtranslate("Related To Vendors")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Vendors")+'"></a></span></div>'}if(r){f+='<span class="vtop inline-block">'+app.vtranslate("Add or related to Project")+'</span><span class="pull-right"><a href="#" title="'+app.vtranslate("Add Project")+'" class="oss-add-Project btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add Project")+'"></a><a data-module="Project" href="#" title="'+app.vtranslate("Related To Project")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To Project")+'"></a></span>'}if(n){q+='<div><span class="vtop inline-block">'+app.vtranslate("Add or related to HelpDesk")+'</span><span class="pull-right"><a href="#" title="'+app.vtranslate("Add HelpDesk")+'" class="oss-add-HelpDesk btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add HelpDesk")+'"></a><a data-module="HelpDesk" href="#" title="'+app.vtranslate("Related To HelpDesk")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To HelpDesk")+'"></a></span></div>'}if(e){q+='<div><span class="vtop inline-block">'+app.vtranslate("Add or related to ServiceContracts")+'</span><span class="pull-right"><a href="#" title="'+app.vtranslate("Add ServiceContracts")+'" class="oss-add-ServiceContracts btn small-icon"><img src="'+b+'btnColorAdd.png" alt="'+app.vtranslate("Add ServiceContracts")+'"></a><a data-module="ServiceContracts" href="#" title="'+app.vtranslate("Related To ServiceContracts")+'" class="oss-Related btn small-icon"><img src="'+b+'search.png" alt="'+app.vtranslate("Related To ServiceContracts")+'"></a></span></div>'}if(u.Accounts||u.Contacts||u.Leads||u.Vendors){k+="<td>"+app.vtranslate("Marketing")+"</td>";j+='<td class="Marketing">'+p+"</td>"}if(u.Campaigns){k+="<td>"+app.vtranslate("MPotentials")+"</td>";j+='<td class="Potentials">'+o+"</td>"}if(u.Project){k+="<td>"+app.vtranslate("MProject")+"</td>";j+='<td class="Project">'+f+"</td>"}if(u.HelpDesk){k+="<td>"+app.vtranslate("MHelpDesk")+"</td>";j+='<td class="HelpDesk">'+q+"</td>"}x.find("#message-oss-header").html('<table class=""><thead><tr>'+k+'</tr></thead><tbody><tr class="text-body" >'+j+"</tr></tbody></table>");x.find("#moreheaderstoggle").html('<a title="'+app.vtranslate("Preview email in CRM")+'" href="#" class="oss-email-link btn small-icon"><img src="'+b+'Emails.png" ></a><a title="'+app.vtranslate("Reload action bar")+'" href="#" class="oss-reload-bar btn small-icon"><img src="'+s+'/layouts/basic/modules/OSSMail/icons/Reload.png" ></a><a title="X" href="#" class="oss-close-bar btn small-icon"><img src="'+b+'upArrowSmall.png"></a>');x.find("#messagecontent").css("top",(x.find(".oss-header").outerHeight()+x.find("#messageheader").outerHeight()+1)+"px")}function load_icons(a,e,c,b){var d="";if(c.Calendar){d+='<a data-crmid="'+e+'" data-module="'+a+'" href="#" title="'+app.vtranslate("Add Events")+'" class="oss-add-events btn"><img src="'+b+'Calendar.png" alt="'+app.vtranslate("Add Events")+'"></a><a  data-crmid="'+e+'" data-module="'+a+'" href="#" title="'+app.vtranslate("Add Task")+'" class="oss-add-task btn"><img src="'+b+'Tasks.png" alt="'+app.vtranslate("Add Task")+'"></a>'}if(c.ModComments){d+='<a data-crmid="'+e+'" data-module="'+a+'" href="#" title="'+app.vtranslate("Add ModComments")+'" class="oss-add-modcomments btn"><img src="'+b+'ModComments.png" alt="'+app.vtranslate("Add ModComments")+'"></a>'}if(a=="Accounts"||a=="Contacts"||a=="Leads"){if(c.Products){d+='<a data-crmid="'+e+'" data-module="'+a+'" href="#" title="'+app.vtranslate("Add Products")+'" class="oss-add-products btn"><img src="'+b+'Products.png" alt="'+app.vtranslate("Add Products")+'"></a>'}}if(a=="HelpDesk"||a=="Project"){if(c.HelpDesk){d+='<a data-crmid="'+e+'" data-module="'+a+'" href="#" title="'+app.vtranslate("Add HelpDesk")+'" class="oss-add-HelpDesk btn"><img src="'+b+'HelpDesk.png" alt="'+app.vtranslate("Add HelpDesk")+'"></a>'}}if(a=="Accounts"||a=="Contacts"||a=="Leads"||a=="HelpDesk"){if(c.Services){d+='<a data-crmid="'+e+'" data-module="'+a+'" href="#" title="'+app.vtranslate("Add Services")+'" class="oss-add-services btn"><img src="'+b+'Services.png" alt="'+app.vtranslate("Add Services")+'"></a>'}}return d}function get_module_permissions(a){var b;jQuery.ajax({type:"Post",async:false,dataType:"json",url:a+"index.php?module=OSSMail&action=GetPermissions",data:{View:"EditView"},success:function(c){b=c.result},failure:function(c){b=false}});return b}function getAbsolutePath(){return jQuery("#site_URL").val()}function oss_get_config(){var b={};var a={};b.data={module:"OSSMail",action:"getConfig"};b.async=false;b.dataType="json";AppConnector.request(b).then(function(c){a=c.result});return a}function find_crm_detail(c,a,b){var d=jQuery.ajax({type:"Post",async:true,dataType:"json",url:c+"index.php?module=OSSMail&action=findCrmDetail",data:{metod:a,params:b}});return d}function showPopup(g,e,f,h,a){var b=jQuery.Event(Vtiger_Edit_Js.preReferencePopUpOpenEvent);e.trigger(b);var d={};var c=Vtiger_Popup_Js.getInstance();show(g,function(j){var i=JSON.parse(j);for(var k in i){var j={name:i[k].name,id:k};e.val(j.id)}f.newModule=g.module;f.newCrmId=j.id;if(a){executeActions("addRelated",f);load_all_widgets()}})}function show(c,d,i,f,b){var h=Vtiger_Popup_Js.getInstance();if(typeof c=="undefined"){c={}}if(typeof c=="object"&&(typeof c.view=="undefined")){c.view="Popup"}if(typeof f=="undefined"){f="postSelection"+Math.floor(Math.random()*10000)}if(typeof i=="undefined"){i="test"}if(typeof c=="object"){c.triggerEventName=f}else{c+="&triggerEventName="+f}var e=(typeof c=="string")?c:jQuery.param(c);var a=c.url+e;var g=window.open(a,i,"width=800,height=650,resizable=0,scrollbars=1");if(typeof h.destroy=="function"){h.destroy()}jQuery.initWindowMsg();if(typeof d!="undefined"){h.retrieveSelectedRecords(d,f)}if(typeof b=="function"){jQuery.windowMsg("Vtiger.OnPopupWindowLoad.Event",function(j){b(j)})}return g}function get_crm_id(c){var a=getAbsolutePath();var b=jQuery.ajax({type:"GET",async:true,url:a+"index.php",data:{module:"OSSMail",action:"getCrmId",params:c}});return b}function loadQuickCreateForm(b,f,j){var e={};var g={};if(f.crmid){if(f.sourceModule){var h=f.sourceModule}else{var h="OSSMailView"}var m=function(p){var n,o,q;if(f.mode=="task"){p.find('a[data-tab-name="Task"]').trigger("click")}if(f.no_rel!="true"){jQuery('<input type="hidden" name="sourceModule" value="'+h+'" />').appendTo(p);jQuery('<input type="hidden" name="sourceRecord" value="'+f.crmid+'" />').appendTo(p);jQuery('<input type="hidden" name="relationOperation" value="true" />').appendTo(p)}};var l=["Leads","Contacts","Vendors","Accounts"];var d=["Campaigns","HelpDesk","Project","ServiceContracts"];if($.inArray(f.sourceModule,l)>=0){g.link=f.crmid}if($.inArray(f.sourceModule,d)>=0){g.process=f.crmid}}var c=function(n){load_all_widgets()};var k="index.php?module="+b+"&view=QuickCreateAjax";g.email=f.from_email;g.projectname=f.title;g.ticket_title=f.title;g.description=f.body;g.related_to=f.rcrmid;g.productname=f.title;g.servicename=f.title;e.callbackFunction=c;if(f.crmid){if(f.no_rel!="true"){g.sourceModule=h;g.sourceRecord=f.crmid;g.relationOperation=true;e.callbackPostShown=m}}e.data=g;e.noCache=true;var a=jQuery.progressIndicator();var i=new Vtiger_Header_Js();i.getQuickCreateForm(k,b,e).then(function(n){i.handleQuickCreateData(n,e);a.progressIndicator({mode:"hide"})})}function oss_add_task(a){Vtiger_Header_Js.getInstance().quickCreateModule("Calendar");$("#globalmodal").ready(function(){setTimeout(function(){jQuery('a[data-tab-name="Task"]').trigger("click");jQuery("#Calendar_editView_fieldName_subject").val(a.title);jQuery('<input type="hidden" name="parent_id" value="'+a.crmid+'">').appendTo("#quickCreate");jQuery('<input type="hidden" name="sourceModule" value="'+a.sourceModule+'" />').appendTo("#quickCreate");jQuery('<input type="hidden" name="sourceRecord" value="'+a.crmid+'" />').appendTo("#quickCreate");jQuery('<input type="hidden" name="relationOperation" value="true" />').appendTo("#quickCreate")},1000)})};